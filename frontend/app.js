// API ë² ì´ìŠ¤ URL - ë°±ì—”ë“œ í¬íŠ¸ë¡œ ë³€ê²½
// í”„ë¡ì‹œë¥¼ í†µí•´ ë°±ì—”ë“œì™€ í†µì‹ í•˜ë¯€ë¡œ API_BASE_URLì€ ë¹ˆ ë¬¸ìì—´
const API_BASE_URL = '';
window.API_BASE_URL = API_BASE_URL; // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ

// ==================== ë””ë²„ê·¸ ëª¨ë“œ ì„¤ì • ====================
const DEBUG_MODE = false; // í”„ë¡œë•ì…˜ì—ì„œëŠ” falseë¡œ ì„¤ì •
const debugLog = DEBUG_MODE ? console.log.bind(console) : () => {};

// ==================== ì•± ë²„ì „ ë° ê¸°ë³¸ê°’ ê´€ë¦¬ ====================
let APP_VERSION = 'loading...'; // ì•± ë²„ì „ (README.mdì—ì„œ ìë™ ë¡œë“œ)
const DEFAULT_SYSTEM_TITLE = 'êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ'; // ê¸°ë³¸ ì‹œìŠ¤í…œ ì œëª©
window.APP_VERSION = APP_VERSION;
window.DEFAULT_SYSTEM_TITLE = DEFAULT_SYSTEM_TITLE;

// ê¸°ë³¸ ì•„ë°”íƒ€ URL ìƒì„± í•¨ìˆ˜ (ì„±ë³„ì— ë”°ë¼ ë‹¤ë¥¸ ì•„ë°”íƒ€)
function getDefaultAvatarUrl(gender, seed = 'default') {
    const isFemale = gender === 'ì—¬' || gender === 'ì—¬ì' || gender === 'female' || gender === 'F';
    return isFemale
        ? `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}-female&backgroundColor=ffd5dc,ffdfbf&style=circle`
        : `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}-male&backgroundColor=b6e3f4,c0aede&style=circle`;
}
window.getDefaultAvatarUrl = getDefaultAvatarUrl;

// README.mdì—ì„œ ë²„ì „ ìë™ ë¡œë“œ
async function loadVersionFromReadme() {
    try {
        const response = await fetch('/api/version');
        const data = await response.json();
        APP_VERSION = data.version || 'unknown';
        window.APP_VERSION = APP_VERSION;

        // ë²„ì „ ë°°ì§€ ì—…ë°ì´íŠ¸
        const versionBadge = document.getElementById('version-badge');
        if (versionBadge) {
            versionBadge.textContent = 'v' + APP_VERSION;
        }

        // ìºì‹œ ë²„ì „ ì²´í¬
        checkAndClearCache();

        console.log(`ğŸ“¦ ë²„ì „ ë¡œë“œë¨: v${APP_VERSION}`);
    } catch (error) {
        console.error('ë²„ì „ ë¡œë“œ ì‹¤íŒ¨:', error);
        APP_VERSION = 'error';
    }
}

// ë²„ì „ ë¡œë“œ ì‹œ ìºì‹œ ì²´í¬
function checkAndClearCache() {
    const currentVersion = localStorage.getItem('cache_version');
    if (currentVersion !== APP_VERSION) {
        console.log(`ğŸ”„ ìºì‹œ ë²„ì „ ì—…ë°ì´íŠ¸: ${currentVersion} â†’ ${APP_VERSION}`);
        Object.keys(localStorage).forEach(k => {
            if (k.startsWith('cache_')) {
                localStorage.removeItem(k);
            }
        });
        localStorage.setItem('cache_version', APP_VERSION);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„ì „ ë¡œë“œ
loadVersionFromReadme();

// YouTube API cross-origin ì—ëŸ¬ ë¬´ì‹œ (sandbox í™˜ê²½)
window.addEventListener('error', function(event) {
    if (event.message && event.message.includes('www-widgetapi.js')) {
        event.preventDefault();
        return false;
    }
}, true);

// ==================== README ëª¨ë‹¬ ====================
async function showReadmeModal() {
    try {
        // README.md íŒŒì¼ ë¡œë“œ
        const response = await fetch('/README.md');
        if (!response.ok) throw new Error('README.mdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        const markdown = await response.text();

        // ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ -> HTML ë³€í™˜
        const html = convertMarkdownToHtml(markdown);

        const modalHtml = `
            <div id="readme-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" onclick="if(event.target.id==='readme-modal')closeReadmeModal()">
                <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 bg-gradient-to-r from-gray-800 to-gray-900 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fab fa-github text-2xl text-white"></i>
                            <div>
                                <h3 class="text-lg font-bold text-white">README.md</h3>
                                <p class="text-gray-300 text-sm">v${APP_VERSION}</p>
                            </div>
                        </div>
                        <button onclick="closeReadmeModal()" class="text-white hover:text-gray-300 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto flex-1 prose prose-sm max-w-none">
                        ${html}
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    } catch (error) {
        console.error('README ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('READMEë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    }
}

function closeReadmeModal() {
    const modal = document.getElementById('readme-modal');
    if (modal) modal.remove();
}

// ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ -> HTML ë³€í™˜
function convertMarkdownToHtml(md) {
    return md
        // ì½”ë“œ ë¸”ë¡ (```ë¡œ ê°ì‹¼ ë¶€ë¶„)
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-sm"><code>$2</code></pre>')
        // ì¸ë¼ì¸ ì½”ë“œ
        .replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded text-red-600 text-sm">$1</code>')
        // í—¤ë”
        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mt-6 mb-2 text-gray-800 border-b pb-1">$1</h3>')
        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-8 mb-3 text-gray-900 border-b-2 pb-2">$1</h2>')
        .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-6 mb-4 text-gray-900">$1</h1>')
        // ë³¼ë“œ/ì´íƒˆë¦­
        .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // ë§í¬
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 hover:underline">$1</a>')
        // ì´ë¯¸ì§€
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" class="max-w-full rounded-lg my-2">')
        // í…Œì´ë¸”
        .replace(/\|(.+)\|/g, (match) => {
            const cells = match.split('|').filter(c => c.trim());
            if (cells.every(c => /^[\s-:]+$/.test(c))) return ''; // êµ¬ë¶„ì„  ì œê±°
            const cellHtml = cells.map(c => `<td class="border px-3 py-2">${c.trim()}</td>`).join('');
            return `<tr>${cellHtml}</tr>`;
        })
        // ìˆ˜í‰ì„ 
        .replace(/^---$/gim, '<hr class="my-6 border-gray-300">')
        // ë¦¬ìŠ¤íŠ¸
        .replace(/^- (.*$)/gim, '<li class="ml-4 list-disc">$1</li>')
        .replace(/^\d+\. (.*$)/gim, '<li class="ml-4 list-decimal">$1</li>')
        // ì¸ìš©ë¬¸
        .replace(/^> (.*$)/gim, '<blockquote class="border-l-4 border-blue-500 pl-4 py-1 my-2 text-gray-600 bg-blue-50">$1</blockquote>')
        // ì¤„ë°”ê¿ˆ
        .replace(/\n\n/g, '</p><p class="my-3">')
        .replace(/\n/g, '<br>');
}

window.showReadmeModal = showReadmeModal;
window.closeReadmeModal = closeReadmeModal;

// ==================== ë¡œì»¬ ìºì‹± ìœ í‹¸ë¦¬í‹° ====================
const CACHE_DURATION = 5 * 60 * 1000; // 5ë¶„ ìºì‹œ
// ìºì‹œ ë²„ì „ ì²´í¬ëŠ” loadVersionFromReadme()ì—ì„œ ìˆ˜í–‰ë¨

window.getCachedData = async function(key, fetchFunction) {
    const cacheKey = `cache_${key}`;
    const timestampKey = `cache_${key}_timestamp`;
    
    const cached = localStorage.getItem(cacheKey);
    const timestamp = localStorage.getItem(timestampKey);
    
    // ìºì‹œê°€ ìœ íš¨í•œ ê²½ìš°
    if (cached && timestamp && (Date.now() - parseInt(timestamp)) < CACHE_DURATION) {
        console.log(`âœ… ìºì‹œ ì‚¬ìš©: ${key} (${((Date.now() - parseInt(timestamp)) / 1000).toFixed(1)}ì´ˆ ì „)`);
        
        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° ì—…ë°ì´íŠ¸
        fetchFunction().then(data => {
            localStorage.setItem(cacheKey, JSON.stringify(data));
            localStorage.setItem(timestampKey, Date.now().toString());
            console.log(`ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${key}`);
        }).catch(err => {
            console.error(`âŒ ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${key}`, err);
        });
        
        return JSON.parse(cached);
    }
    
    // ìºì‹œ ì—†ìŒ ë˜ëŠ” ë§Œë£Œë¨
    console.log(`ğŸ“¡ ìƒˆë¡œ ë¡œë“œ: ${key}`);
    const data = await fetchFunction();
    localStorage.setItem(cacheKey, JSON.stringify(data));
    localStorage.setItem(timestampKey, Date.now().toString());
    return data;
}

// ìºì‹œ ì´ˆê¸°í™” í•¨ìˆ˜
window.clearCache = function(key) {
    if (key) {
        localStorage.removeItem(`cache_${key}`);
        localStorage.removeItem(`cache_${key}_timestamp`);
        console.log(`ğŸ—‘ï¸ ìºì‹œ ì‚­ì œ: ${key}`);
    } else {
        // ì „ì²´ ìºì‹œ ì‚­ì œ
        Object.keys(localStorage).forEach(k => {
            if (k.startsWith('cache_')) {
                localStorage.removeItem(k);
            }
        });
        console.log('ğŸ—‘ï¸ ì „ì²´ ìºì‹œ ì‚­ì œ');
    }
}

// ==================== ë¡œê·¸ì¸ ì²´í¬ ====================
function checkLogin() {
    const loggedIn = sessionStorage.getItem('logged_in');
    const instructor = sessionStorage.getItem('instructor');
    
    // ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´
    if (!loggedIn || loggedIn !== 'true' || !instructor) {
        console.log('âŒ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
        // ëª¨ë“  ì„¸ì…˜ ë°ì´í„° í´ë¦¬ì–´
        clearAllSessions();
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
        window.location.replace('/login.html');
        return false;
    }
    
    // ê°•ì‚¬ ì •ë³´ ê²€ì¦
    try {
        const instructorData = JSON.parse(instructor);
        
        // í•„ìˆ˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
        if (!instructorData.code || !instructorData.name) {
            console.log('âŒ ê°•ì‚¬ ì •ë³´ ë¶ˆì™„ì „ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
            clearAllSessions();
            window.location.replace('/login.html');
            return false;
        }
        
        // ê°•ì‚¬ ì •ë³´ í‘œì‹œ
        const nameElement = document.getElementById('instructorName');
        const typeElement = document.getElementById('instructorType');
        if (nameElement) nameElement.textContent = instructorData.name || 'ê°•ì‚¬';
        if (typeElement) typeElement.textContent = instructorData.instructor_type_name || '';
        
        console.log('âœ… ë¡œê·¸ì¸ í™•ì¸:', instructorData.name);
    } catch (e) {
        console.error('âŒ ê°•ì‚¬ ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', e);
        clearAllSessions();
        window.location.replace('/login.html');
        return false;
    }
    
    return true;
}

// ì£¼ê°•ì‚¬ ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
function isMainInstructor() {
    try {
        const instructor = sessionStorage.getItem('instructor');
        if (!instructor) return false;
        const instructorData = JSON.parse(instructor);
        // ê´€ë¦¬ì(ROOT, ì½”ë“œ '0') ë˜ëŠ” ì£¼ê°•ì‚¬ ëª¨ë‘ í—ˆìš©
        return instructorData.instructor_type_type === '1. ì£¼ê°•ì‚¬'
            || instructorData.instructor_type_type === 'ê´€ë¦¬ì'
            || instructorData.code === 'ROOT';
    } catch (e) {
        return false;
    }
}

// ê³µí†µ ìŠ¤í¬ë¡¤ í•¨ìˆ˜
window.scrollToForm = function(formId) {
    const formDiv = document.getElementById(formId);
    if (formDiv) {
        formDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// íŒŒì¼ ê²€ì¦ í•¨ìˆ˜
window.validateFile = function(file) {
    const maxSize = 100 * 1024 * 1024; // 100MB (ì••ì¶• í›„ ì—…ë¡œë“œ)
    const allowedExtensions = [
        'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp',  // ì´ë¯¸ì§€
        'pdf',  // PDF
        'ppt', 'pptx',  // PowerPoint
        'xls', 'xlsx',  // Excel
        'doc', 'docx',  // Word
        'txt',  // í…ìŠ¤íŠ¸
        'hwp'  // í•œê¸€
    ];
    
    // íŒŒì¼ í¬ê¸° ê²€ì¦
    if (file.size > maxSize) {
        const sizeMB = (file.size / 1024 / 1024).toFixed(1);
        return {
            valid: false,
            message: `"${file.name}"ì˜ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (í˜„ì¬: ${sizeMB}MB)\n\nìµœëŒ€ ì—…ë¡œë“œ ê°€ëŠ¥ í¬ê¸°: 100MB\n\nğŸ’¡ ì´ë¯¸ì§€ íŒŒì¼ì€ ìë™ìœ¼ë¡œ ì••ì¶•ë˜ì–´ ì—…ë¡œë“œë©ë‹ˆë‹¤.`
        };
    }
    
    // íŒŒì¼ í™•ì¥ì ê²€ì¦
    const ext = file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(ext)) {
        return {
            valid: false,
            message: `"${file.name}"ì€(ëŠ”) ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n\nì§€ì› í˜•ì‹:\nâ€¢ ì´ë¯¸ì§€: JPG, PNG, GIF, BMP, WebP (ìë™ ì••ì¶•)\nâ€¢ ë¬¸ì„œ: PDF, TXT\nâ€¢ Office: PPT, PPTX, XLS, XLSX, DOC, DOCX\nâ€¢ í•œê¸€: HWP`
        };
    }
    
    // 20MB ì´ìƒ ì´ë¯¸ì§€ íŒŒì¼ ê²½ê³ 
    const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext);
    if (isImage && file.size > 20 * 1024 * 1024) {
        const sizeMB = (file.size / 1024 / 1024).toFixed(1);
        console.log(`âš ï¸ ëŒ€ìš©ëŸ‰ ì´ë¯¸ì§€ íŒŒì¼ (${sizeMB}MB) - ìë™ ì••ì¶• ì˜ˆì •`);
    }
    
    return { valid: true };
}

// ==================== ì˜ˆìœ ì•Œë¦¼ ëª¨ë‹¬ ====================
window.showAlert = function(message, type = 'info', options = {}) {
    return new Promise((resolve) => {
        const modal = document.getElementById('alert-modal');
        const header = document.getElementById('alert-header');
        const icon = document.getElementById('alert-icon');
        const title = document.getElementById('alert-title');
        const messageEl = document.getElementById('alert-message');
        const confirmBtn = document.getElementById('alert-confirm-btn');
        const cancelBtn = document.getElementById('alert-cancel-btn');
        
        // íƒ€ì…ë³„ ì„¤ì •
        const configs = {
            success: {
                headerClass: 'bg-gradient-to-r from-green-500 to-emerald-600',
                icon: 'âœ…',
                title: options.title || 'ì„±ê³µ',
                confirmBtnClass: 'bg-green-600 hover:bg-green-700'
            },
            error: {
                headerClass: 'bg-gradient-to-r from-red-500 to-rose-600',
                icon: 'âŒ',
                title: options.title || 'ì˜¤ë¥˜',
                confirmBtnClass: 'bg-red-600 hover:bg-red-700'
            },
            warning: {
                headerClass: 'bg-gradient-to-r from-yellow-500 to-orange-600',
                icon: 'âš ï¸',
                title: options.title || 'ê²½ê³ ',
                confirmBtnClass: 'bg-yellow-600 hover:bg-yellow-700'
            },
            info: {
                headerClass: 'bg-gradient-to-r from-blue-500 to-indigo-600',
                icon: 'â„¹ï¸',
                title: options.title || 'ì•Œë¦¼',
                confirmBtnClass: 'bg-blue-600 hover:bg-blue-700'
            },
            confirm: {
                headerClass: 'bg-gradient-to-r from-purple-500 to-indigo-600',
                icon: 'â“',
                title: options.title || 'í™•ì¸',
                confirmBtnClass: 'bg-purple-600 hover:bg-purple-700'
            }
        };
        
        const config = configs[type] || configs.info;
        
        // ìŠ¤íƒ€ì¼ ì ìš©
        header.className = `p-6 rounded-t-2xl ${config.headerClass}`;
        icon.textContent = config.icon;
        title.textContent = config.title;
        messageEl.textContent = message;
        confirmBtn.className = `px-6 py-2.5 text-white rounded-lg font-semibold transition-colors ${config.confirmBtnClass}`;
        
        // confirm íƒ€ì…ì´ë©´ ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
        if (type === 'confirm' || options.showCancel) {
            cancelBtn.classList.remove('hidden');
            confirmBtn.textContent = options.confirmText || 'í™•ì¸';
            cancelBtn.textContent = options.cancelText || 'ì·¨ì†Œ';
        } else {
            cancelBtn.classList.add('hidden');
            confirmBtn.textContent = options.confirmText || 'í™•ì¸';
        }
        
        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const handleConfirm = () => {
            modal.classList.add('hidden');
            resolve(true);
            cleanup();
        };
        
        const handleCancel = () => {
            modal.classList.add('hidden');
            resolve(false);
            cleanup();
        };
        
        const cleanup = () => {
            confirmBtn.removeEventListener('click', handleConfirm);
            cancelBtn.removeEventListener('click', handleCancel);
        };
        
        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
        
        // ESC í‚¤ë¡œ ë‹«ê¸°
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                handleCancel();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        // ëª¨ë‹¬ í‘œì‹œ
        modal.classList.remove('hidden');
    });
};

// ê°„í¸ í•¨ìˆ˜ë“¤
window.showSuccess = (message, title) => window.showAlert(message, 'success', { title });
window.showError = (message, title) => window.showAlert(message, 'error', { title });
window.showWarning = (message, title) => window.showAlert(message, 'warning', { title });
window.showInfo = (message, title) => window.showAlert(message, 'info', { title });
window.showConfirm = (message, title) => window.showAlert(message, 'confirm', { title });

// ==================== ë²”ìš© ëª¨ë‹¬ ====================
window.showModal = function(title, content) {
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('generic-modal');
    if (existingModal) existingModal.remove();

    const modal = document.createElement('div');
    modal.id = 'generic-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">${title}</h3>
                    <button onclick="window.closeModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                ${content}
            </div>
        </div>
    `;

    // ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
    modal.addEventListener('click', (e) => {
        if (e.target === modal) window.closeModal();
    });

    document.body.appendChild(modal);
}

window.closeModal = function() {
    const modal = document.getElementById('generic-modal');
    if (modal) modal.remove();
}

// ==================== í™•ì¸ ëª¨ë‹¬ (Confirm Dialog) ====================
window.showConfirmModal = function(title, message, options = {}) {
    return new Promise((resolve) => {
        const {
            confirmText = 'í™•ì¸',
            cancelText = 'ì·¨ì†Œ',
            confirmClass = 'bg-blue-600 hover:bg-blue-700',
            icon = 'fa-question-circle',
            iconColor = 'text-blue-500'
        } = options;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById('confirm-modal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'confirm-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all">
                <div class="p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fas ${icon} text-3xl ${iconColor}"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="flex gap-3 justify-center">
                        <button id="confirm-modal-cancel" class="px-6 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition-colors">
                            ${cancelText}
                        </button>
                        <button id="confirm-modal-confirm" class="px-6 py-2.5 ${confirmClass} text-white font-medium rounded-lg transition-colors">
                            ${confirmText}
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('confirm-modal-confirm').onclick = () => {
            modal.remove();
            resolve(true);
        };
        document.getElementById('confirm-modal-cancel').onclick = () => {
            modal.remove();
            resolve(false);
        };

        // ESC í‚¤ë¡œ ë‹«ê¸°
        const handleKeydown = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', handleKeydown);
                resolve(false);
            }
        };
        document.addEventListener('keydown', handleKeydown);
    });
}

// ==================== í•„í„° ë¹„í™œì„±í™”/í™œì„±í™” ìœ í‹¸ë¦¬í‹° ====================
window.disableFilters = function() {
    // ëª¨ë“  select, input í•„í„° ìš”ì†Œ ë¹„í™œì„±í™”
    const filters = document.querySelectorAll('select[id*="filter"], input[id*="filter"], select[id*="sort"], input[id*="search"]');
    filters.forEach(element => {
        element.disabled = true;
        element.style.opacity = '0.5';
        element.style.cursor = 'not-allowed';
    });
};

window.enableFilters = function() {
    // ëª¨ë“  select, input í•„í„° ìš”ì†Œ í™œì„±í™”
    const filters = document.querySelectorAll('select[id*="filter"], input[id*="filter"], select[id*="sort"], input[id*="search"]');
    filters.forEach(element => {
        element.disabled = false;
        element.style.opacity = '1';
        element.style.cursor = 'pointer';
    });
};

// ì´ë¯¸ì§€ ìë™ ì••ì¶• í•¨ìˆ˜
window.compressImage = function(file, maxWidth = 1920, quality = 0.85) {
    return new Promise((resolve, reject) => {
        // PDFë‚˜ ì´ë¯¸ì§€ê°€ ì•„ë‹Œ íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ë°˜í™˜
        if (file.type === 'application/pdf' || !file.type.startsWith('image/')) {
            resolve(file);
            return;
        }
        
        // íŒŒì¼ í¬ê¸°ì— ë”°ë¼ ì••ì¶• ê°•ë„ ì¡°ì •
        const fileSizeMB = file.size / (1024 * 1024);
        let targetMaxWidth = maxWidth;
        let targetQuality = quality;
        
        if (fileSizeMB > 20) {
            // 20MB ì´ìƒ: ê°•ë ¥í•œ ì••ì¶•
            targetMaxWidth = Math.min(maxWidth, 1280);
            targetQuality = 0.6;
            console.log(`ğŸ“¦ ëŒ€ìš©ëŸ‰ íŒŒì¼ ê°ì§€ (${fileSizeMB.toFixed(1)}MB) - ê°•ë ¥í•œ ì••ì¶• ì ìš©`);
        } else if (fileSizeMB > 10) {
            // 10-20MB: ì¤‘ê°„ ì••ì¶•
            targetMaxWidth = Math.min(maxWidth, 1600);
            targetQuality = 0.7;
            console.log(`ğŸ“¦ í° íŒŒì¼ ê°ì§€ (${fileSizeMB.toFixed(1)}MB) - ì¤‘ê°„ ì••ì¶• ì ìš©`);
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // ìµœëŒ€ ë„ˆë¹„ ì œí•œ
                if (width > targetMaxWidth) {
                    height = Math.round((height * targetMaxWidth) / width);
                    width = targetMaxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                canvas.toBlob(function(blob) {
                    if (blob) {
                        const originalSizeMB = file.size / (1024 * 1024);
                        const compressedSizeMB = blob.size / (1024 * 1024);
                        const reduction = ((1 - blob.size / file.size) * 100).toFixed(1);
                        
                        console.log(`âœ… ì••ì¶• ì™„ë£Œ: ${originalSizeMB.toFixed(1)}MB â†’ ${compressedSizeMB.toFixed(1)}MB (${reduction}% ê°ì†Œ)`);
                        
                        // ì••ì¶•ëœ íŒŒì¼ì´ ì›ë³¸ë³´ë‹¤ í¬ë©´ ì›ë³¸ ì‚¬ìš©
                        if (blob.size > file.size) {
                            resolve(file);
                        } else {
                            // Blobì„ File ê°ì²´ë¡œ ë³€í™˜
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            resolve(compressedFile);
                        }
                    } else {
                        resolve(file);
                    }
                }, 'image/jpeg', targetQuality);
            };
            img.onerror = function() {
                reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
            };
            img.src = e.target.result;
        };
        reader.onerror = function() {
            reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        };
        reader.readAsDataURL(file);
    });
}

// íŒŒì¼ íƒ€ì… í™•ì¸ í•¨ìˆ˜
window.getFileExtension = function(url) {
    if (!url) return '';
    const cleanUrl = url.split('#')[0].split('?')[0];
    const match = cleanUrl.match(/\.([^.]+)$/);
    return match ? match[1].toLowerCase() : '';
}

window.isPDF = function(url) {
    const ext = window.getFileExtension(url);
    return ext === 'pdf';
}

window.isPowerPoint = function(url) {
    const ext = window.getFileExtension(url);
    return ['ppt', 'pptx'].includes(ext);
}

window.isExcel = function(url) {
    const ext = window.getFileExtension(url);
    return ['xls', 'xlsx'].includes(ext);
}

window.isWord = function(url) {
    const ext = window.getFileExtension(url);
    return ['doc', 'docx'].includes(ext);
}

window.isText = function(url) {
    const ext = window.getFileExtension(url);
    return ext === 'txt';
}

window.isHWP = function(url) {
    const ext = window.getFileExtension(url);
    return ext === 'hwp';
}

window.isImage = function(url) {
    const ext = window.getFileExtension(url);
    return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext);
}

window.isViewableInBrowser = function(url) {
    // ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ë³¼ ìˆ˜ ìˆëŠ” íŒŒì¼ íƒ€ì…
    return window.isPDF(url) || window.isImage(url) || window.isText(url);
}

// URLì—ì„œ ì›ë³¸ íŒŒì¼ëª… ì œê±° (ì‹¤ì œ ë‹¤ìš´ë¡œë“œìš©)
window.getCleanUrl = function(url) {
    if (!url) return '';
    // URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹ì—ì„œ # ì´í›„ ì œê±°
    return url.split('#')[0];
}

// URLì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ í•¨ìˆ˜
window.getFilenameFromUrl = function(url) {
    if (!url) return 'unknown';
    try {
        // URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹ì—ì„œ ì›ë³¸ íŒŒì¼ëª… ì¶”ì¶œ
        if (url.includes('#')) {
            const parts = url.split('#');
            if (parts.length > 1 && parts[1]) {
                return decodeURIComponent(parts[1]);
            }
        }
        
        // FTP URLì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ
        const parts = url.split('/');
        let filename = parts[parts.length - 1];
        
        // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°
        if (filename.includes('?')) {
            filename = filename.split('?')[0];
        }
        
        // ë””ì½”ë”©
        filename = decodeURIComponent(filename);
        
        // íƒ€ì„ìŠ¤íƒ¬í”„_UUID_ íŒ¨í„´ ì œê±° (ì˜ˆ: 20251120_151105_d432baab_4.png â†’ 4.png)
        // íŒ¨í„´: YYYYMMDD_HHMMSS_8ìUUID_ì‹¤ì œíŒŒì¼ëª….í™•ì¥ì
        const timestampPattern = /^\d{8}_\d{6}_[a-f0-9]{8}_(.+)$/;
        const match = filename.match(timestampPattern);
        if (match && match[1]) {
            // ì‹¤ì œ íŒŒì¼ëª… ë¶€ë¶„ë§Œ ì¶”ì¶œ
            return match[1];
        }
        
        return filename;
    } catch (e) {
        return 'unknown';
    }
}

// ê³µí†µ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
window.createFilePreviewItem = function(url, index, removeCallback) {
    const cleanUrl = window.getCleanUrl(url);  // # ì œê±°í•œ ì‹¤ì œ URL
    const filename = window.getFilenameFromUrl(url);
    
    // íŒŒì¼ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ë° ìƒ‰ìƒ ê²°ì •
    let icon = 'fa-file';
    let bgColor = 'bg-gray-50';
    let borderColor = 'border-gray-200';
    let iconColor = 'text-gray-600';
    let previewAction = null;
    
    if (window.isPDF(url)) {
        // PDFë„ ì´ë¯¸ì§€ì²˜ëŸ¼ ì•„ì´ì½˜ ì—†ì´ ê°„ë‹¨í•˜ê²Œ í‘œì‹œ
        return `
            <div class="flex items-center gap-3 bg-white border rounded p-2 hover:bg-gray-50">
                <div class="flex-1 min-w-0">
                    <p class="text-gray-800 text-sm font-medium truncate mb-2" title="${filename}">
                        <i class="fas fa-file-pdf text-red-500 mr-2"></i>${filename}
                    </p>
                    <div class="flex gap-2">
                        <button type="button" onclick="window.openFileModal('${cleanUrl}', '${filename}')" 
                                class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-medium transition-colors">
                            <i class="fas fa-eye mr-1"></i>ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button type="button" onclick="window.downloadFile('${cleanUrl}', '${filename}')"
                                class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-medium transition-colors">
                            <i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
                <button type="button" onclick="${removeCallback}(${index})" 
                        class="text-red-500 hover:text-red-700 px-2 flex-shrink-0">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    } else if (window.isImage(url)) {
        // ì´ë¯¸ì§€ëŠ” ë³„ë„ ì²˜ë¦¬
        return `
            <div class="flex items-center gap-3 bg-white border rounded p-2 hover:bg-gray-50">
                <div class="flex-shrink-0 cursor-pointer" onclick="window.showFilePreview('${cleanUrl}', 'image')">
                    <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(cleanUrl)}" 
                         alt="íŒŒì¼ ${index + 1}"
                         class="w-16 h-16 object-cover rounded border hover:opacity-80"
                         onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2240%22%3EğŸ“·%3C/text%3E%3C/svg%3E';">
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-gray-800 text-sm font-medium truncate mb-2" title="${filename}">
                        ${filename}
                    </p>
                    <div class="flex gap-2">
                        <button type="button" onclick="window.openFileModal('${cleanUrl}', '${filename}')" 
                                class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-medium transition-colors">
                            <i class="fas fa-eye mr-1"></i>ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button type="button" onclick="window.downloadFile('${cleanUrl}', '${filename}')"
                                class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-medium transition-colors">
                            <i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
                <button type="button" onclick="${removeCallback}(${index})" 
                        class="text-red-500 hover:text-red-700 px-2 flex-shrink-0">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    } else if (window.isPowerPoint(url)) {
        icon = 'fa-file-powerpoint';
        bgColor = 'bg-orange-50';
        borderColor = 'border-orange-200';
        iconColor = 'text-orange-600';
        previewAction = `window.showFilePreview('${cleanUrl}', 'office')`;
    } else if (window.isExcel(url)) {
        icon = 'fa-file-excel';
        bgColor = 'bg-green-50';
        borderColor = 'border-green-200';
        iconColor = 'text-green-600';
        previewAction = `window.showFilePreview('${cleanUrl}', 'office')`;
    } else if (window.isWord(url)) {
        icon = 'fa-file-word';
        bgColor = 'bg-blue-50';
        borderColor = 'border-blue-200';
        iconColor = 'text-blue-600';
        previewAction = `window.showFilePreview('${cleanUrl}', 'office')`;
    } else if (window.isText(url)) {
        icon = 'fa-file-alt';
        bgColor = 'bg-gray-50';
        borderColor = 'border-gray-200';
        iconColor = 'text-gray-600';
        previewAction = `window.showFilePreview('${cleanUrl}', 'text')`;
    } else if (window.isHWP(url)) {
        icon = 'fa-file-alt';
        bgColor = 'bg-indigo-50';
        borderColor = 'border-indigo-200';
        iconColor = 'text-indigo-600';
        previewAction = `window.showFilePreview('${cleanUrl}', 'hwp')`;
    }
    
    // ê³µí†µ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° HTML
    return `
        <div class="flex items-center gap-3 bg-white border rounded p-2 hover:bg-gray-50">
            <div class="flex-shrink-0 w-16 h-16 ${bgColor} border ${borderColor} rounded flex items-center justify-center cursor-pointer hover:opacity-80"
                 ${previewAction ? `onclick="${previewAction}"` : ''}>
                <i class="fas ${icon} text-3xl ${iconColor}"></i>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-gray-800 text-sm font-medium truncate mb-2" title="${filename}">
                    ${filename}
                </p>
                <div class="flex gap-2">
                    ${previewAction ? `
                        <button type="button" onclick="window.openFileModal('${cleanUrl}', '${filename}')" 
                                class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-medium transition-colors">
                            <i class="fas fa-eye mr-1"></i>ë¯¸ë¦¬ë³´ê¸°
                        </button>
                    ` : ''}
                    <button type="button" onclick="window.downloadFile('${cleanUrl}', '${filename}')"
                            class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-medium transition-colors">
                        <i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>
            <button type="button" onclick="${removeCallback}(${index})" 
                    class="text-red-500 hover:text-red-700 px-2 flex-shrink-0">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
}

// PDF ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬
// í†µí•© íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
window.showFilePreview = function(url, type) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
    
    let title = 'íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°';
    let icon = 'fa-file';
    let iconColor = 'text-gray-600';
    let content = '';
    
    if (type === 'pdf') {
        title = 'PDF ë¯¸ë¦¬ë³´ê¸°';
        icon = 'fa-file-pdf';
        iconColor = 'text-red-600';
        content = `
            <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-bold">
                        <i class="fas ${icon} mr-2 ${iconColor}"></i>${title}
                    </h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="flex-1 p-4 overflow-hidden">
                    <iframe src="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                            class="w-full h-full border rounded"
                            frameborder="0">
                    </iframe>
                </div>
                <div class="p-4 border-t flex justify-end space-x-2">
                    <a href="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                       download 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                    </a>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        `;
    } else if (type === 'image') {
        title = 'ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°';
        icon = 'fa-image';
        iconColor = 'text-blue-600';
        content = `
            <div class="relative max-w-7xl max-h-screen w-full h-full flex flex-col p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-white">
                        <i class="fas ${icon} mr-2"></i>${title}
                    </h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-300">
                        <i class="fas fa-times text-3xl"></i>
                    </button>
                </div>
                <div class="flex-1 flex items-center justify-center overflow-auto">
                    <img src="${API_BASE_URL}/api/proxy-image?url=${encodeURIComponent(url)}" 
                         class="max-w-full max-h-full object-contain rounded shadow-2xl"
                         alt="ë¯¸ë¦¬ë³´ê¸°"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2240%22%3Eì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨%3C/text%3E%3C/svg%3E';">
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <a href="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                       download 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                    </a>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        `;
    } else if (type === 'text') {
        title = 'í…ìŠ¤íŠ¸ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°';
        icon = 'fa-file-alt';
        iconColor = 'text-gray-600';
        content = `
            <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-bold">
                        <i class="fas ${icon} mr-2 ${iconColor}"></i>${title}
                    </h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="flex-1 p-4 overflow-hidden">
                    <iframe src="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                            class="w-full h-full border rounded bg-white"
                            frameborder="0">
                    </iframe>
                </div>
                <div class="p-4 border-t flex justify-end space-x-2">
                    <a href="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                       download 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                    </a>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        `;
    } else if (type === 'office') {
        // Office íŒŒì¼ì€ Microsoft Office Online ë·°ì–´ ì‚¬ìš©
        const viewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(API_BASE_URL + '/api/download-image?url=' + encodeURIComponent(url))}`;
        title = 'Office ë¬¸ì„œ ë¯¸ë¦¬ë³´ê¸°';
        icon = 'fa-file-alt';
        iconColor = 'text-blue-600';
        content = `
            <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-bold">
                        <i class="fas ${icon} mr-2 ${iconColor}"></i>${title}
                    </h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="flex-1 p-4 overflow-hidden">
                    <iframe src="${viewerUrl}" 
                            class="w-full h-full border rounded"
                            frameborder="0">
                    </iframe>
                </div>
                <div class="p-4 border-t flex justify-end space-x-2">
                    <a href="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                       download 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                    </a>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        `;
    } else if (type === 'hwp') {
        title = 'í•œê¸€ ë¬¸ì„œ';
        icon = 'fa-file-alt';
        iconColor = 'text-indigo-600';
        content = `
            <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">
                        <i class="fas ${icon} mr-2 ${iconColor}"></i>${title}
                    </h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="text-center py-8">
                    <i class="fas fa-file-alt text-6xl text-indigo-600 mb-4"></i>
                    <p class="text-gray-700 mb-4">í•œê¸€(HWP) íŒŒì¼ì€ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                    <p class="text-gray-600 mb-6">íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ í•œê¸€ í”„ë¡œê·¸ë¨ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.</p>
                    <a href="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                       download 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded inline-block">
                        <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                    </a>
                </div>
            </div>
        `;
    }
    
    modal.innerHTML = content;
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (ì´ë¯¸ì§€ íƒ€ì…ë§Œ)
    if (type === 'image') {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }
    
    document.body.appendChild(modal);
}

// í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ë˜í¼ í•¨ìˆ˜ë“¤
window.showPDFPreview = function(url) {
    window.showFilePreview(url, 'pdf');
}

window.showImagePreview = function(url) {
    window.showFilePreview(url, 'image');
}

// ê³µí†µ íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜ (ì´ë¯¸ì§€ ìë™ ì••ì¶• + PDF ì§€ì›)
window.uploadFilesWithCompression = async function(files, category, progressBar) {
    const maxSize = 20 * 1024 * 1024; // 20MB
    const uploadedUrls = [];
    
    // íŒŒì¼ í¬ê¸° ì²´í¬
    for (let file of files) {
        if (file.size > maxSize) {
            throw new Error(`íŒŒì¼ "${file.name}"ì˜ í¬ê¸°ê°€ 20MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
        }
    }
    
    const totalFiles = files.length;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // ì´ë¯¸ì§€ ìë™ ì••ì¶• (PDFëŠ” ê·¸ëŒ€ë¡œ)
        let processedFile = file;
        if (file.type.startsWith('image/')) {
            try {
                processedFile = await window.compressImage(file);
                console.log(`ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
                processedFile = file;
            }
        }
        
        const formData = new FormData();
        formData.append('file', processedFile);
        
        // í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
        if (progressBar) {
            const progress = ((i + 0.5) / totalFiles) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        const response = await axios.post(
            `${API_BASE_URL}/api/upload-image?category=${category}`,
            formData,
            { headers: { 'Content-Type': 'multipart/form-data' } }
        );
        
        if (response.data.success) {
            uploadedUrls.push(response.data.url);
        }
        
        // ì™„ë£Œ í”„ë¡œê·¸ë ˆìŠ¤
        if (progressBar) {
            const completeProgress = ((i + 1) / totalFiles) * 100;
            progressBar.style.width = `${completeProgress}%`;
        }
    }
    
    return uploadedUrls;
}

// ëª¨ë“  ì„¸ì…˜ ë°ì´í„° í´ë¦¬ì–´ í•¨ìˆ˜
function clearAllSessions() {
    console.log('ğŸ§¹ ëª¨ë“  ì„¸ì…˜ ë°ì´í„° í´ë¦¬ì–´ ì¤‘...');

    // ìœ ì§€í•  ì„¤ì • ë°±ì—… (í…Œë§ˆ, ë¡œê³  ë“±)
    const preserveKeys = ['system_theme', 'logo_url', 'system_title', 'saved_name', 'remember_name'];
    const preserved = {};
    preserveKeys.forEach(key => {
        const value = localStorage.getItem(key);
        if (value) preserved[key] = value;
    });

    // localStorage í´ë¦¬ì–´
    localStorage.clear();

    // ë°±ì—…í•œ ì„¤ì • ë³µì›
    Object.keys(preserved).forEach(key => {
        localStorage.setItem(key, preserved[key]);
    });
    console.log('ğŸ’¾ ìœ ì§€ëœ ì„¤ì •:', Object.keys(preserved));

    // sessionStorageë„ í´ë¦¬ì–´
    sessionStorage.clear();
    
    // ì¿ í‚¤ í´ë¦¬ì–´ (ìˆë‹¤ë©´)
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    
    console.log('âœ… ì„¸ì…˜ ë°ì´í„° í´ë¦¬ì–´ ì™„ë£Œ');
}

// ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
function logout() {
    // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬
    const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
    const instructorName = instructor.name || 'ì‚¬ìš©ì';
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center">
            <div class="mb-6">
                <i class="fas fa-sign-out-alt text-6xl text-blue-600 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">ë¡œê·¸ì•„ì›ƒ</h3>
                <p class="text-gray-600 mb-1">${instructorName}ë‹˜,</p>
                <p class="text-gray-600">ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>
            <div class="flex gap-3">
                <button id="logout-cancel" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                    <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                </button>
                <button id="logout-confirm" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                    <i class="fas fa-check mr-2"></i>í™•ì¸
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('logout-cancel').onclick = () => modal.remove();
    document.getElementById('logout-confirm').onclick = () => {
        // ëª¨ë“  ì„¸ì…˜ ë°ì´í„° ì™„ì „ ì‚­ì œ
        clearAllSessions();
        
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™ (íˆìŠ¤í† ë¦¬ ë‚¨ê¸°ì§€ ì•ŠìŒ)
        window.location.replace('/login.html');
    };
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ì²´í¬ (ì œê±° - ì•„ë˜ 994ë²ˆì§¸ ì¤„ê³¼ í†µí•©)

// ì „ì—­ ìƒíƒœ
let currentTab = 'dashboard';
let students = [];
let subjects = [];
let instructors = [];
let instructorTypes = []; // ê°•ì‚¬êµ¬ë¶„ ëª©ë¡
let instructorSortKey = 'name'; // ê°•ì‚¬ ëª©ë¡ ì •ë ¬ í‚¤
let instructorSortAsc = true; // ê°•ì‚¬ ëª©ë¡ ì •ë ¬ ë°©í–¥
let studentSortKey = 'name'; let studentSortAsc = true;
let counselingSortKey = 'consultation_date'; let counselingSortAsc = false;
let timetableSortKey = 'class_date'; let timetableSortAsc = true;
let trainingLogSortKey = 'class_date'; let trainingLogSortAsc = true;
let classNoteSortKey = 'note_date'; let classNoteSortAsc = false;
let projectSortKey = 'name'; let projectSortAsc = true;
let teamLogSortKey = 'activity_date'; let teamLogSortAsc = false;

// ê³µí†µ ì •ë ¬ í—¤ë” ìƒì„± í—¬í¼
function sortableHeader(columns, currentKey, isAsc, onclickFn, thClass = 'px-3 py-2 text-left text-xs', iconActive = 'text-blue-600', iconInactive = 'text-gray-300') {
    return columns.map(col =>
        `<th class="${thClass} cursor-pointer select-none hover:bg-gray-200 transition-colors" onclick="${onclickFn}('${col.key}')">
            ${col.label}
            <i class="fas ${currentKey === col.key ? (isAsc ? 'fa-sort-up ' + iconActive : 'fa-sort-down ' + iconActive) : 'fa-sort ' + iconInactive} ml-1 text-xs"></i>
        </th>`
    ).join('');
}
function genericSort(arr, key, asc, customGetters = {}) {
    return [...arr].sort((a, b) => {
        let valA, valB;
        if (customGetters[key]) {
            valA = customGetters[key](a);
            valB = customGetters[key](b);
        } else {
            valA = a[key] || '';
            valB = b[key] || '';
        }
        const cmp = String(valA).localeCompare(String(valB), 'ko');
        return asc ? cmp : -cmp;
    });
}
function handleSortClick(sortKeyVar, sortAscVar, key, renderFn) {
    if (window[sortKeyVar] === key) {
        window[sortAscVar] = !window[sortAscVar];
    } else {
        window[sortKeyVar] = key;
        window[sortAscVar] = true;
    }
    renderFn();
}
window.sortableHeader = sortableHeader;
window.genericSort = genericSort;
window.sortStudentTable = function(key) {
    if (studentSortKey === key) { studentSortAsc = !studentSortAsc; } else { studentSortKey = key; studentSortAsc = true; }
    window.renderStudents();
};
window.sortCounselingTable = function(key) {
    if (counselingSortKey === key) { counselingSortAsc = !counselingSortAsc; } else { counselingSortKey = key; counselingSortAsc = true; }
    window.filterCounselings();
};
window.sortTimetableTable = function(key) {
    if (timetableSortKey === key) { timetableSortAsc = !timetableSortAsc; } else { timetableSortKey = key; timetableSortAsc = true; }
    window.renderTimetables();
};
window.sortTrainingLogTable = function(key) {
    if (trainingLogSortKey === key) { trainingLogSortAsc = !trainingLogSortAsc; } else { trainingLogSortKey = key; trainingLogSortAsc = true; }
    loadTrainingLogs();
};
window.sortClassNoteTable = function(key) {
    if (classNoteSortKey === key) { classNoteSortAsc = !classNoteSortAsc; } else { classNoteSortKey = key; classNoteSortAsc = true; }
    loadClassNotes();
};
window.sortProjectTable = function(key) {
    if (projectSortKey === key) { projectSortAsc = !projectSortAsc; } else { projectSortKey = key; projectSortAsc = true; }
    if (typeof window.renderProjectsList === 'function') window.renderProjectsList();
};
window.sortTeamLogTable = function(key) {
    if (teamLogSortKey === key) { teamLogSortAsc = !teamLogSortAsc; } else { teamLogSortKey = key; teamLogSortAsc = true; }
    if (typeof window.filterTeamActivityLogs === 'function') window.filterTeamActivityLogs();
};
let counselings = [];
let courses = [];

// ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸
let dashboardRefreshInterval = null;
let dashboardRefreshTime = null; // ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨ ì‹œê°„
let clockInterval = null; // ì‹œê³„ ì—…ë°ì´íŠ¸ ì¸í„°ë²Œ
let countdownInterval = null; // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¸í„°ë²Œ

// í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ
let pagination = {
    timetables: { currentPage: 1, itemsPerPage: 50, totalItems: 0 },
    trainingLogs: { currentPage: 1, itemsPerPage: 50, totalItems: 0 },
    students: { currentPage: 1, itemsPerPage: 50, totalItems: 0 },
    counselings: { currentPage: 1, itemsPerPage: 50, totalItems: 0 },
    instructors: { currentPage: 1, itemsPerPage: 50, totalItems: 0 }
};

// ==================== ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ ====================
// ì•Œë¦¼ íƒ€ì´ë¨¸ ì €ì¥
let alertTimer = null;

window.showAlert = function(message, type = 'success', title = null) {
    const alertModal = document.getElementById('custom-alert');
    const alertMessage = document.getElementById('alert-message');
    const alertTitle = document.getElementById('alert-title');
    const alertIcon = document.getElementById('alert-icon');
    const alertIconContainer = document.getElementById('alert-icon-container');
    
    if (!alertModal || !alertMessage) {
        console.error('Alert modal not found');
        return;
    }
    
    // ë©”ì‹œì§€ ì„¤ì •
    alertMessage.textContent = message;
    
    // ì•„ì´ì½˜ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
    alertIconContainer.classList.remove('bg-green-100', 'bg-red-100', 'bg-yellow-100', 'bg-blue-100');
    alertIcon.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600', 'text-blue-600');
    
    // íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ ì ìš©
    if (type === 'success') {
        if (!title) title = 'âœ… ì„±ê³µ';
        alertTitle.textContent = title;
        alertIconContainer.classList.add('bg-green-100');
        alertIcon.className = 'fas fa-check-circle text-4xl text-green-600';
    } else if (type === 'error') {
        if (!title) title = 'âŒ ì˜¤ë¥˜';
        alertTitle.textContent = title;
        alertIconContainer.classList.add('bg-red-100');
        alertIcon.className = 'fas fa-exclamation-circle text-4xl text-red-600';
    } else if (type === 'warning') {
        if (!title) title = 'âš ï¸ ê²½ê³ ';
        alertTitle.textContent = title;
        alertIconContainer.classList.add('bg-yellow-100');
        alertIcon.className = 'fas fa-exclamation-triangle text-4xl text-yellow-600';
    } else {
        if (!title) title = 'â„¹ï¸ ì•Œë¦¼';
        alertTitle.textContent = title;
        alertIconContainer.classList.add('bg-blue-100');
        alertIcon.className = 'fas fa-info-circle text-4xl text-blue-600';
    }
    
    alertModal.classList.remove('hidden');
    
    // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì·¨ì†Œ
    if (alertTimer) {
        clearTimeout(alertTimer);
    }
    
    // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ê²Œ
    alertTimer = setTimeout(() => {
        window.hideAlert();
    }, 3000);
};

window.hideAlert = function() {
    const alertModal = document.getElementById('custom-alert');
    if (alertModal) {
        alertModal.classList.add('hidden');
    }
    
    // íƒ€ì´ë¨¸ ì·¨ì†Œ
    if (alertTimer) {
        clearTimeout(alertTimer);
        alertTimer = null;
    }
};

// í™•ì¸ ëª¨ë‹¬ìš© ì½œë°± ì €ì¥
let confirmCallback = null;

window.showConfirm = function(message, title = 'ì‚­ì œ í™•ì¸', yesText = 'ì˜ˆ', noText = 'ì•„ë‹ˆì˜¤') {
    return new Promise((resolve) => {
        const confirmModal = document.getElementById('custom-confirm');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmTitle = document.getElementById('confirm-title');
        const yesButton = confirmModal?.querySelector('[onclick*="handleConfirm(true)"]');
        const noButton = confirmModal?.querySelector('[onclick*="handleConfirm(false)"]');
        
        if (!confirmModal || !confirmMessage) {
            // Fallback to native confirm if modal not found
            console.warn('Custom confirm modal not found, using native confirm');
            resolve(confirm(message));
            return;
        }
        
        if (confirmTitle) {
            confirmTitle.textContent = title;
        }
        confirmMessage.innerHTML = message; // HTML ë Œë”ë§ì„ ìœ„í•´ innerHTML ì‚¬ìš©
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        if (yesButton) {
            yesButton.innerHTML = `<i class="fas fa-check mr-2"></i>${yesText}`;
        }
        if (noButton) {
            noButton.innerHTML = `<i class="fas fa-times mr-2"></i>${noText}`;
        }
        
        confirmModal.classList.remove('hidden');
        confirmCallback = resolve;
    });
};

window.handleConfirm = function(result) {
    const confirmModal = document.getElementById('custom-confirm');
    confirmModal.classList.add('hidden');
    if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
    }
};

// ==================== ì»¤ìŠ¤í…€ ëª¨ë‹¬ Promise ë˜í¼ ====================
// showCustomConfirm: Promise ê¸°ë°˜ í™•ì¸ ëª¨ë‹¬ (showConfirmì˜ alias)
window.showCustomConfirm = function(message, title = 'í™•ì¸', yesText = 'ì˜ˆ', noText = 'ì•„ë‹ˆì˜¤') {
    return window.showConfirm(message, title, yesText, noText);
};

// showCustomAlert: Promise ê¸°ë°˜ ì•Œë¦¼ ëª¨ë‹¬ (ìë™ìœ¼ë¡œ ë‹«íˆëŠ” showAlertë¥¼ Promiseë¡œ ë˜í•‘)
window.showCustomAlert = function(message, type = 'success', title = null) {
    return new Promise((resolve) => {
        window.showAlert(message, type, title);
        // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ resolve
        setTimeout(() => {
            resolve();
        }, 3000);
    });
};

// ==================== í˜ì´ì§€ë„¤ì´ì…˜ í—¬í¼ ====================
function createPaginationHTML(page, itemsPerPage, totalItems, onPageChange, onItemsPerPageChange) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const startItem = (page - 1) * itemsPerPage + 1;
    const endItem = Math.min(page * itemsPerPage, totalItems);
    
    let paginationHTML = `
        <div class="flex justify-between items-center mt-4 pt-4 border-t">
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600">í˜ì´ì§€ë‹¹ í•­ëª©:</span>
                <select onchange="${onItemsPerPageChange}" class="border rounded px-2 py-1 text-sm">
                    <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25ê°œ</option>
                    <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50ê°œ</option>
                    <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100ê°œ</option>
                    <option value="200" ${itemsPerPage === 200 ? 'selected' : ''}>200ê°œ</option>
                </select>
                <span class="text-sm text-gray-600 ml-4">
                    ${startItem}-${endItem} / ì´ ${totalItems}ê°œ
                </span>
            </div>
            
            <div class="flex items-center space-x-1">
                <button onclick="${onPageChange}(1)" 
                        ${page === 1 ? 'disabled' : ''} 
                        class="px-2 py-1 border rounded text-sm ${page === 1 ? 'bg-gray-100 text-gray-400' : 'hover:bg-gray-100'}">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button onclick="${onPageChange}(${page - 1})" 
                        ${page === 1 ? 'disabled' : ''} 
                        class="px-2 py-1 border rounded text-sm ${page === 1 ? 'bg-gray-100 text-gray-400' : 'hover:bg-gray-100'}">
                    <i class="fas fa-angle-left"></i>
                </button>
                
                ${generatePageButtons(page, totalPages, onPageChange)}
                
                <button onclick="${onPageChange}(${page + 1})" 
                        ${page === totalPages ? 'disabled' : ''} 
                        class="px-2 py-1 border rounded text-sm ${page === totalPages ? 'bg-gray-100 text-gray-400' : 'hover:bg-gray-100'}">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button onclick="${onPageChange}(${totalPages})" 
                        ${page === totalPages ? 'disabled' : ''} 
                        class="px-2 py-1 border rounded text-sm ${page === totalPages ? 'bg-gray-100 text-gray-400' : 'hover:bg-gray-100'}">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
        </div>
    `;
    
    return paginationHTML;
}

// ==================== ì‚¬ì§„ ë·°ì–´ ====================
window.showPhotoViewer = function(photos, startIndex = 0) {
    // photosëŠ” URL ë°°ì—´ ë˜ëŠ” ë¬¸ìì—´ (JSON ë°°ì—´)
    let photoUrls = [];
    if (typeof photos === 'string') {
        try {
            photoUrls = JSON.parse(photos);
        } catch (e) {
            photoUrls = [photos];
        }
    } else if (Array.isArray(photos)) {
        photoUrls = photos;
    } else {
        photoUrls = [photos];
    }
    
    if (photoUrls.length === 0) return;
    
    // ì´ë¯¸ì§€ê°€ ì•„ë‹Œ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const hasNonImageFiles = photoUrls.some(url => !window.isImage(url));
    if (hasNonImageFiles) {
        window.showAlert('ì´ í•­ëª©ì—ëŠ” ì´ë¯¸ì§€ ì™¸ì˜ íŒŒì¼(PDF, Office ë¬¸ì„œ ë“±)ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\nìˆ˜ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìƒì„¸ë³´ê¸°ì—ì„œ ì¡°íšŒê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }
    
    let currentIndex = startIndex;
    
    const viewerHtml = `
        <div id="photo-viewer" class="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-[100]">
            <button onclick="window.closePhotoViewer()" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 z-10">
                <i class="fas fa-times"></i>
            </button>
            
            ${photoUrls.length > 1 ? `
                <button onclick="window.prevPhoto()" class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-5xl hover:text-gray-300 z-10">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="window.nextPhoto()" class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-5xl hover:text-gray-300 z-10">
                    <i class="fas fa-chevron-right"></i>
                </button>
            ` : ''}
            
            <div class="flex flex-col items-center justify-center w-full h-full px-16 py-8">
                <img id="viewer-image" src="${API_BASE_URL}/api/proxy-image?url=${encodeURIComponent(photoUrls[currentIndex])}" 
                     class="w-auto h-auto max-w-full max-h-full object-contain" 
                     style="max-width: 90vw; max-height: 85vh;"
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23ddd%22 width=%22400%22 height=%22300%22/%3E%3Ctext fill=%22%23666%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 font-size=%2220%22%3Eì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤%3C/text%3E%3C/svg%3E'"
                     alt="ì‚¬ì§„">
                ${photoUrls.length > 1 ? `
                    <div class="text-white mt-4 text-xl font-bold">
                        <span id="photo-counter">${currentIndex + 1}</span> / ${photoUrls.length}
                    </div>
                ` : ''}
                <div class="text-white mt-2 text-sm opacity-75" id="photo-url-info">
                    ì›ë³¸: ${photoUrls[currentIndex]}
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', viewerHtml);
    
    // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ì‚¬ì§„ ì •ë³´ ì €ì¥
    window.currentPhotoIndex = currentIndex;
    window.photoUrlsList = photoUrls;
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    window.photoViewerKeyHandler = function(e) {
        if (e.key === 'Escape') {
            window.closePhotoViewer();
        } else if (e.key === 'ArrowLeft') {
            window.prevPhoto();
        } else if (e.key === 'ArrowRight') {
            window.nextPhoto();
        }
    };
    document.addEventListener('keydown', window.photoViewerKeyHandler);
};

window.closePhotoViewer = function() {
    const viewer = document.getElementById('photo-viewer');
    if (viewer) viewer.remove();
    if (window.photoViewerKeyHandler) {
        document.removeEventListener('keydown', window.photoViewerKeyHandler);
    }
};

window.prevPhoto = function() {
    if (!window.photoUrlsList || window.photoUrlsList.length <= 1) return;
    window.currentPhotoIndex = (window.currentPhotoIndex - 1 + window.photoUrlsList.length) % window.photoUrlsList.length;
    const url = window.photoUrlsList[window.currentPhotoIndex];
    document.getElementById('viewer-image').src = `${API_BASE_URL}/api/proxy-image?url=${encodeURIComponent(url)}`;
    const counter = document.getElementById('photo-counter');
    if (counter) counter.textContent = window.currentPhotoIndex + 1;
    const urlInfo = document.getElementById('photo-url-info');
    if (urlInfo) urlInfo.textContent = 'ì›ë³¸: ' + url;
};

window.nextPhoto = function() {
    if (!window.photoUrlsList || window.photoUrlsList.length <= 1) return;
    window.currentPhotoIndex = (window.currentPhotoIndex + 1) % window.photoUrlsList.length;
    const url = window.photoUrlsList[window.currentPhotoIndex];
    document.getElementById('viewer-image').src = `${API_BASE_URL}/api/proxy-image?url=${encodeURIComponent(url)}`;
    const counter = document.getElementById('photo-counter');
    if (counter) counter.textContent = window.currentPhotoIndex + 1;
    const urlInfo = document.getElementById('photo-url-info');
    if (urlInfo) urlInfo.textContent = 'ì›ë³¸: ' + url;
};

function generatePageButtons(currentPage, totalPages, onPageChange) {
    let buttons = '';
    const maxButtons = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
    let endPage = Math.min(totalPages, startPage + maxButtons - 1);
    
    if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        buttons += `
            <button onclick="${onPageChange}(${i})" 
                    class="px-3 py-1 border rounded text-sm ${i === currentPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}">
                ${i}
            </button>
        `;
    }
    
    return buttons;
}

function paginateArray(array, page, itemsPerPage) {
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    return array.slice(startIndex, endIndex);
}

// ==================== Debounce í—¬í¼ ====================
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ë””ë°”ìš´ìŠ¤ëœ ìƒë‹´ í•„í„°ë§ (500ms ëŒ€ê¸°)
window.debouncedFilterCounselings = debounce(() => {
    window.filterCounselings();
}, 500);

// ==================== ë¡œë”© ì˜¤ë²„ë ˆì´ ====================
window.showLoading = function(message = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', isAI = false) {
    const overlay = document.getElementById('loading-overlay');
    const messageEl = document.getElementById('loading-message');
    const progressEl = document.getElementById('loading-progress');

    // AI ëª¨ë“œì¼ ë•Œ íŠ¹ë³„í•œ ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
    const iconContainer = overlay.querySelector('.text-center > .mb-4');
    const titleEl = overlay.querySelector('h3');
    const subtitleEl = overlay.querySelector('p.text-gray-600');

    if (isAI) {
        iconContainer.innerHTML = `
            <div class="relative inline-block">
                <i class="fas fa-robot text-5xl text-purple-600 animate-bounce"></i>
                <div class="absolute -top-1 -right-1">
                    <span class="flex h-4 w-4">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-4 w-4 bg-purple-500"></span>
                    </span>
                </div>
            </div>
        `;
        titleEl.innerHTML = '<i class="fas fa-brain text-purple-600 mr-2"></i>AIê°€ ì—´ì‹¬íˆ ìƒê°í•˜ëŠ” ì¤‘...';
        subtitleEl.innerHTML = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. AIê°€ ìµœì„ ì˜ ê²°ê³¼ë¥¼ ë§Œë“¤ê³  ìˆìŠµë‹ˆë‹¤.';
        overlay.dataset.isAI = 'true';
    } else {
        iconContainer.innerHTML = '<i class="fas fa-spinner fa-spin text-5xl text-blue-600"></i>';
        titleEl.textContent = 'ë°ì´í„° ë¡œë”© ì¤‘';
        subtitleEl.textContent = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
        overlay.dataset.isAI = 'false';
    }

    messageEl.textContent = message;
    progressEl.style.width = '0%';
    overlay.classList.remove('hidden');

    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * (isAI ? 5 : 15);  // AIëŠ” ë” ì²œì²œíˆ
        if (progress > 90) progress = 90;
        progressEl.style.width = progress + '%';

        // AI ëª¨ë“œ: ë©”ì‹œì§€ ë³€ê²½
        if (isAI && progress > 30 && progress < 60) {
            messageEl.textContent = 'ğŸ“ ë¬¸ì œë¥¼ êµ¬ì„±í•˜ëŠ” ì¤‘...';
        } else if (isAI && progress >= 60 && progress < 80) {
            messageEl.textContent = 'âœ¨ ìµœì¢… ê²€í†  ì¤‘...';
        } else if (isAI && progress >= 80) {
            messageEl.textContent = 'ğŸ¯ ê±°ì˜ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤...';
        }
    }, isAI ? 500 : 200);

    // interval ID ì €ì¥
    overlay.dataset.intervalId = interval;
};

window.hideLoading = function() {
    const overlay = document.getElementById('loading-overlay');
    const progressEl = document.getElementById('loading-progress');
    
    // interval ì •ë¦¬
    if (overlay.dataset.intervalId) {
        clearInterval(overlay.dataset.intervalId);
        delete overlay.dataset.intervalId;
    }
    
    // 100%ë¡œ ì™„ë£Œ í‘œì‹œ
    progressEl.style.width = '100%';
    
    // ì§§ì€ ë”œë ˆì´ í›„ ìˆ¨ê¹€
    setTimeout(() => {
        overlay.classList.add('hidden');
        progressEl.style.width = '0%';
    }, 300);
};

// ==================== ì‹œê³„ ë° ì¹´ìš´íŠ¸ë‹¤ìš´ ====================
function updateClock() {
    const now = new Date();
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const date = String(now.getDate()).padStart(2, '0');
    const dayOfWeek = days[now.getDay()];
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    const dateTimeStr = `${year}.${month}.${date} (${dayOfWeek}) ${hours}:${minutes}:${seconds}`;
    
    const clockElement = document.getElementById('currentDateTime');
    if (clockElement) {
        clockElement.innerHTML = `<i class="fas fa-calendar-day mr-1"></i>${dateTimeStr}`;
    }
}

function updateCountdown() {
    const countdownElement = document.getElementById('refreshCountdown');
    if (!countdownElement || !dashboardRefreshTime) {
        if (countdownElement) {
            countdownElement.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>--:--';
        }
        return;
    }
    
    const now = Date.now();
    const remaining = dashboardRefreshTime - now;
    
    if (remaining <= 0) {
        countdownElement.innerHTML = '<i class="fas fa-sync-alt mr-1 animate-spin"></i>ë¡œë”©...';
        return;
    }
    
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    
    countdownElement.innerHTML = `<i class="fas fa-sync-alt mr-1"></i>${minutes}:${String(seconds).padStart(2, '0')}`;
}

function startClock() {
    // ê¸°ì¡´ ì¸í„°ë²Œ ì œê±°
    if (clockInterval) clearInterval(clockInterval);
    if (countdownInterval) clearInterval(countdownInterval);
    
    // ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    updateClock();
    updateCountdown();
    
    // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    clockInterval = setInterval(updateClock, 1000);
    countdownInterval = setInterval(updateCountdown, 1000);
}

function stopClock() {
    if (clockInterval) {
        clearInterval(clockInterval);
        clockInterval = null;
    }
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
}

// ==================== í™”ë©´ë³´í˜¸ê¸° (ìë™ ìƒˆë¡œê³ ì¹¨ìš©) ====================
function showScreensaver() {
    const screensaver = document.getElementById('screensaver');
    if (screensaver) {
        screensaver.classList.remove('hidden');
        console.log('ğŸŒ™ í™”ë©´ë³´í˜¸ê¸° í‘œì‹œ');
        
        // 3D í™”ë©´ë³´í˜¸ê¸° ì´ˆê¸°í™”
        if (typeof window.init3DScreensaver === 'function') {
            setTimeout(() => {
                window.init3DScreensaver();
            }, 100);
        }
    }
}

function hideScreensaver() {
    const screensaver = document.getElementById('screensaver');
    if (screensaver) {
        screensaver.classList.add('hidden');
        console.log('â˜€ï¸ í™”ë©´ë³´í˜¸ê¸° ìˆ¨ê¹€');
        
        // 3D í™”ë©´ë³´í˜¸ê¸° ì •ì§€
        if (typeof window.stop3DScreensaver === 'function') {
            window.stop3DScreensaver();
        }
    }
}

// ==================== ëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨ ====================
function getRefreshInterval() {
    // localStorageì—ì„œ ì„¤ì •ëœ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’: 5ë¶„)
    const savedInterval = localStorage.getItem('dashboard_refresh_interval');
    return savedInterval ? parseInt(savedInterval) * 60000 : 300000; // ë¶„ â†’ ë°€ë¦¬ì´ˆ
}

function startDashboardAutoRefresh() {
    // ê¸°ì¡´ íƒ€ì´ë¨¸ ì œê±°
    if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
        dashboardRefreshInterval = null;
    }
    
    const intervalMs = getRefreshInterval();
    const intervalMin = Math.floor(intervalMs / 60000);
    
    // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘ (ë¡œê·¸ ì œê±°)
    
    // ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ ì„¤ì •
    dashboardRefreshTime = Date.now() + intervalMs;
    
    // ì„¤ì •ëœ ì‹œê°„ë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
    dashboardRefreshInterval = setInterval(async () => {
        if (currentTab === 'dashboard') {
            console.log('ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰...');
            showScreensaver();
            
            // 10ì´ˆ ë™ì•ˆ í™”ë©´ë³´í˜¸ê¸° í‘œì‹œ
            await new Promise(resolve => setTimeout(resolve, 10000));
            
            await loadDashboard();
            hideScreensaver();
            
            // ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ ì¬ì„¤ì •
            dashboardRefreshTime = Date.now() + intervalMs;
        }
    }, intervalMs);
}

function stopDashboardAutoRefresh() {
    if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
        dashboardRefreshInterval = null;
        dashboardRefreshTime = null;
        // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€ (ë¡œê·¸ ì œê±°)
    }
    // ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° ì¸í„°ë²Œë„ ì •ë¦¬
    if (window._dashboardServiceInterval) {
        clearInterval(window._dashboardServiceInterval);
        window._dashboardServiceInterval = null;
    }
}

// ëŒ€ì‹œë³´ë“œ ì‚¬ìš©ì í™œë™ ê°ì§€ ë³€ìˆ˜
let lastActivityTime = Date.now();
let activityCheckInterval = null;

// ëŒ€ì‹œë³´ë“œ íƒ€ì´ë¨¸ ë¦¬ì…‹ (ì‚¬ìš©ì í™œë™ ê°ì§€ ì‹œ)
function resetDashboardAutoRefresh(eventType = 'í™œë™') {
    if (currentTab === 'dashboard' && dashboardRefreshInterval) {
        lastActivityTime = Date.now();
        // ì‚¬ìš©ì í™œë™ ê°ì§€ (ë¡œê·¸ ì œê±°)
        stopDashboardAutoRefresh();
        startDashboardAutoRefresh();
    }
}

// í´ë¦­ í•¸ë“¤ëŸ¬
function handleDashboardClick() {
    resetDashboardAutoRefresh('í´ë¦­');
}

// í‚¤ë³´ë“œ í•¸ë“¤ëŸ¬
function handleDashboardKeydown() {
    resetDashboardAutoRefresh('í‚¤ë³´ë“œ');
}

// ë§ˆìš°ìŠ¤ ë¬´ë¸Œ í•¸ë“¤ëŸ¬ (ì“°ë¡œí‹€ë§ ì ìš© - 3ì´ˆë§ˆë‹¤ í•œ ë²ˆë§Œ)
let mouseMoveThrottle = null;
function handleDashboardMouseMove() {
    if (!mouseMoveThrottle) {
        resetDashboardAutoRefresh('ë§ˆìš°ìŠ¤');
        mouseMoveThrottle = setTimeout(() => {
            mouseMoveThrottle = null;
        }, 3000); // 3ì´ˆ ì“°ë¡œí‹€
    }
}

// ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸ (í—¤ë”ì— í‘œì‹œ)
function updateRefreshCountdown() {
    if (currentTab !== 'dashboard' || !dashboardRefreshTime) {
        return;
    }
    
    const now = Date.now();
    const remaining = dashboardRefreshTime - now;
    
    if (remaining > 0) {
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        // í—¤ë”ì˜ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        const countdownElement = document.getElementById('refresh-countdown');
        const containerElement = document.getElementById('refreshCountdownContainer');
        
        if (countdownElement) {
            countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // ì»¨í…Œì´ë„ˆ í‘œì‹œ
        if (containerElement) {
            containerElement.style.display = 'inline';
        }
    }
}

// ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
function startRefreshCountdown() {
    // ê¸°ì¡´ ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì§€
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    countdownInterval = setInterval(updateRefreshCountdown, 1000);
    updateRefreshCountdown(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
}

// ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì§€
function stopRefreshCountdown() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    
    // ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ ìˆ¨ê¹€
    const countdownElement = document.getElementById('refresh-countdown');
    const containerElement = document.getElementById('refreshCountdownContainer');
    
    if (countdownElement) {
        countdownElement.textContent = '--:--';
    }
    
    if (containerElement) {
        containerElement.style.display = 'none';
    }
}

// ëŒ€ì‹œë³´ë“œ í™œë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupDashboardActivityListeners() {
    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    document.removeEventListener('click', handleDashboardClick);
    document.removeEventListener('keydown', handleDashboardKeydown);
    document.removeEventListener('mousemove', handleDashboardMouseMove);
    
    // ìƒˆ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.addEventListener('click', handleDashboardClick);
    document.addEventListener('keydown', handleDashboardKeydown);
    document.addEventListener('mousemove', handleDashboardMouseMove);
    
    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
    startRefreshCountdown();
    
    console.log('ğŸ‘€ ëŒ€ì‹œë³´ë“œ í™œë™ ê°ì§€ ì‹œì‘ (í´ë¦­, í‚¤ë³´ë“œ, ë§ˆìš°ìŠ¤)');
}

// ëŒ€ì‹œë³´ë“œ í™œë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
function removeDashboardActivityListeners() {
    document.removeEventListener('click', handleDashboardClick);
    document.removeEventListener('keydown', handleDashboardKeydown);
    document.removeEventListener('mousemove', handleDashboardMouseMove);
    
    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì§€
    stopRefreshCountdown();
    
    // ì“°ë¡œí‹€ íƒ€ì´ë¨¸ ì •ë¦¬
    if (mouseMoveThrottle) {
        clearTimeout(mouseMoveThrottle);
        mouseMoveThrottle = null;
    }
    
    // ëŒ€ì‹œë³´ë“œ í™œë™ ê°ì§€ ì¤‘ì§€ (ë¡œê·¸ ì œê±°)
}

// ë©”ë‰´ ê¶Œí•œ ì²´í¬ í—¬í¼ í•¨ìˆ˜
function isMenuAllowed(menuId) {
    // allowedMenusê°€ nullì´ë©´ ê´€ë¦¬ì - ëª¨ë“  ë©”ë‰´ í—ˆìš©
    if (window.allowedMenus === null || window.allowedMenus === undefined) return true;
    return window.allowedMenus.includes(menuId);
}

// ==================== ëŒ€ì‹œë³´ë“œ ====================
async function loadDashboard() {
    window.showLoading('ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
    
    try {
        console.log('ğŸš€ ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹œì‘...');
        
        // ëª¨ë“  ë°ì´í„°ë¥¼ ìºì‹±ê³¼ í•¨ê»˜ ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
        const [
            studentsData,
            instructorsData,
            coursesData,
            counselingsData,
            timetablesData,
            projectsData,
            trainingLogsData,
            teamActivityLogsData,
            instructorCodesData
        ] = await Promise.all([
            window.getCachedData('students', () => axios.get(`${API_BASE_URL}/api/students`).then(r => r.data)),
            window.getCachedData('instructors', () => axios.get(`${API_BASE_URL}/api/instructors`).then(r => r.data)),
            window.getCachedData('courses', () => axios.get(`${API_BASE_URL}/api/courses`).then(r => r.data)),
            window.getCachedData('counselings', () => axios.get(`${API_BASE_URL}/api/counselings`).then(r => r.data)),
            window.getCachedData('timetables', () => axios.get(`${API_BASE_URL}/api/timetables`).then(r => r.data)),
            window.getCachedData('projects', () => axios.get(`${API_BASE_URL}/api/projects`).then(r => r.data)),
            window.getCachedData('training-logs', () => axios.get(`${API_BASE_URL}/api/training-logs`).then(r => r.data)),
            window.getCachedData('team-activity-logs', () => axios.get(`${API_BASE_URL}/api/team-activity-logs`).then(r => r.data)),
            window.getCachedData('instructor-codes', () => axios.get(`${API_BASE_URL}/api/instructor-codes`).then(r => r.data))
        ]);

        // ë¡œê·¸ì¸í•œ ê°•ì‚¬ì˜ ëŒ€ì‹œë³´ë“œ ê·¸ë˜í”„ í‘œì‹œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        const loggedInInstructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
        const myInstructorCode = instructorCodesData.find(ic => ic.code === loggedInInstructor.instructor_type);
        const dashboardCharts = myInstructorCode?.dashboard_charts || ['studentsByCourse', 'instructorType', 'counselingTrend', 'progress'];
        const isChartAllowed = (chartId) => dashboardCharts.includes(chartId);
        
        console.log('âœ… ë°ì´í„° ë¡œë”© ì™„ë£Œ:', {
            students: studentsData.length,
            instructors: instructorsData.length,
            courses: coursesData.length,
            counselings: counselingsData.length
        });
        
        // ê¸°ë³¸ ê³¼ì • (localStorageì—ì„œ ë§ˆì§€ë§‰ ì„ íƒ ë³µì› ë˜ëŠ” 'ì „ì²´', ì—†ìœ¼ë©´ C-001 ë˜ëŠ” ì²« ë²ˆì§¸ ê³¼ì •)
        const savedCourseCode = localStorage.getItem('dashboard_selected_course');
        let mainCourse;
        let isAllCourses = false;
        
        if (savedCourseCode === 'ALL') {
            isAllCourses = true;
            mainCourse = { code: 'ALL', name: 'ì „ì²´ ê³¼ì •' };
        } else {
            mainCourse = (savedCourseCode ? coursesData.find(c => c.code === savedCourseCode) : null) 
                        || coursesData.find(c => c.code === 'C-001') 
                        || coursesData[0];
        }
        
        // ì„ íƒëœ ê³¼ì •ì˜ í•™ìƒë“¤ (ì „ì²´ ê³¼ì •ì´ë©´ ëª¨ë“  í•™ìƒ)
        const courseStudents = isAllCourses ? studentsData : studentsData.filter(s => s.course_code === mainCourse.code);
        const courseStudentIds = courseStudents.map(s => s.id);
        
        // ì´ ìƒë‹´ (ì„ íƒëœ ê³¼ì • í•™ìƒë§Œ)
        const totalCourseCounselings = counselingsData
            .filter(c => courseStudentIds.includes(c.student_id));
        
        // ìµœê·¼ ìƒë‹´ (ì„ íƒëœ ê³¼ì • í•™ìƒë§Œ, ìµœê·¼ 5ê±´ - ëŒ€ì‹œë³´ë“œ í•˜ë‹¨ í‘œì‹œìš©)
        const recentCounselings = totalCourseCounselings
            .sort((a, b) => new Date(b.consultation_date) - new Date(a.consultation_date))
            .slice(0, 5);
        
        // ì˜¤ëŠ˜ ì‹œê°„í‘œ (ë¡œì»¬ ì‹œê°„ ê¸°ì¤€, ì „ì²´ ê³¼ì •ì´ë©´ ëª¨ë“  ì‹œê°„í‘œ)
        const now = new Date();
        const today = now.getFullYear() + '-' + 
                      String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                      String(now.getDate()).padStart(2, '0');
        const todayTimetables = timetablesData
            .filter(t => t.class_date === today && (isAllCourses || t.course_code === mainCourse.code))
            .map(t => {
                // í•´ë‹¹ ê³¼ì • ì°¾ê¸°
                const course = coursesData.find(c => c.code === t.course_code);
                
                // ê³¼ì • ì‹œì‘ì¼ë¶€í„° ì˜¤ëŠ˜ê¹Œì§€ ì¼ìˆ˜ ê³„ì‚°
                let daysFromStart = 0;
                if (course && course.start_date) {
                    const startDate = new Date(course.start_date);
                    const currentDate = new Date(today);
                    const diffTime = currentDate - startDate;
                    daysFromStart = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1ì€ ì‹œì‘ì¼ì„ 1ì¼ë¡œ ê³„ì‚°
                }
                
                // í•´ë‹¹ ê³¼ì •ì˜ ì‹œê°„í‘œ ì¤‘ ì˜¤ëŠ˜ê¹Œì§€ì˜ ì´ ì‹œìˆ˜ ê³„ì‚°
                const courseTimetables = timetablesData.filter(tt => 
                    tt.course_code === t.course_code && 
                    tt.class_date <= today
                );
                const totalHours = courseTimetables.length;
                
                // ì˜¤ëŠ˜ ëª‡ ë²ˆì§¸ ì‹œê°„ì¸ì§€ ê³„ì‚° (ê°™ì€ ë‚ ì§œ ë‚´ì—ì„œ)
                const todayCourseTimetables = timetablesData
                    .filter(tt => tt.course_code === t.course_code && tt.class_date === today)
                    .sort((a, b) => a.start_time.localeCompare(b.start_time));
                const todayHourIndex = todayCourseTimetables.findIndex(tt => tt.id === t.id) + 1;
                const todayTotalHours = todayCourseTimetables.length;
                
                return {
                    ...t,
                    daysFromStart,
                    totalHours,
                    todayHourIndex,
                    todayTotalHours
                };
            });
        
        // ìµœê·¼ 2ì¼ì¹˜ ì‹œê°„í‘œ (ì„ íƒëœ ê³¼ì •, ì˜¤ëŠ˜ í¬í•¨)
        const twoDaysAgo = new Date(today);
        twoDaysAgo.setDate(twoDaysAgo.getDate() - 1); // ì˜¤ëŠ˜ í¬í•¨ 2ì¼
        const twoDaysAgoStr = twoDaysAgo.getFullYear() + '-' + 
                                String(twoDaysAgo.getMonth() + 1).padStart(2, '0') + '-' + 
                                String(twoDaysAgo.getDate()).padStart(2, '0');
        
        // ìµœê·¼ 2ì¼ì¹˜ ì‹œê°„í‘œ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ ê³¼ì •ì´ë©´ ëª¨ë“  ê³¼ì •)
        const recent3DaysTimetables = timetablesData
            .filter(t => (isAllCourses || t.course_code === mainCourse.code) && t.class_date >= twoDaysAgoStr && t.class_date <= today)
            .sort((a, b) => {
                const dateCompare = b.class_date.localeCompare(a.class_date);
                if (dateCompare !== 0) return dateCompare;
                return b.start_time.localeCompare(a.start_time);
            });
        
        // ì‹œê°„í‘œë³„ í›ˆë ¨ì¼ì§€ ì‘ì„± ì—¬ë¶€ í™•ì¸
        const recentTrainingLogs = recent3DaysTimetables.map(tt => {
            const log = trainingLogsData.find(log => log.timetable_id === tt.id);
            return {
                ...tt,
                hasLog: !!log,
                logContent: log?.content || null,
                logId: log?.id || null
            };
        });
        
        // ì„ íƒëœ ê³¼ì •ì˜ í”„ë¡œì íŠ¸ë“¤ (ì „ì²´ ê³¼ì •ì´ë©´ ëª¨ë“  í”„ë¡œì íŠ¸)
        const courseProjects = isAllCourses ? projectsData : projectsData.filter(p => p.course_code === mainCourse.code);
        const courseProjectIds = courseProjects.map(p => p.id);
        
        // ìµœê·¼ íŒ€ í™œë™ì¼ì§€ (ì„ íƒëœ ê³¼ì • í”„ë¡œì íŠ¸ë§Œ, ìµœê·¼ 5ê±´)
        const recentTeamActivityLogs = teamActivityLogsData
            .filter(log => courseProjectIds.includes(log.project_id))
            .sort((a, b) => new Date(b.activity_date) - new Date(a.activity_date))
            .slice(0, 5)
            .map(log => {
                const project = projectsData.find(p => p.id === log.project_id);
                return {
                    ...log,
                    project_name: project?.name || 'í”„ë¡œì íŠ¸ëª… ì—†ìŒ',
                    project_code: project?.code || ''
                };
            });
        
        // ì¶”ê°€ í†µê³„ ê³„ì‚° - ë¡œì»¬ ì‹œê°„ ê¸°ì¤€
        const todayDate = today; // ìœ„ì—ì„œ ê³„ì‚°í•œ today ì‚¬ìš©
        const thisWeekStart = new Date();
        thisWeekStart.setDate(thisWeekStart.getDate() - thisWeekStart.getDay());
        const thisWeekStartStr = thisWeekStart.getFullYear() + '-' + 
                                 String(thisWeekStart.getMonth() + 1).padStart(2, '0') + '-' + 
                                 String(thisWeekStart.getDate()).padStart(2, '0');
        
        const todayCounselings = counselingsData.filter(c => {
            const consultDate = c.consultation_date ? c.consultation_date.split('T')[0].split(' ')[0] : '';
            return consultDate === todayDate && courseStudentIds.includes(c.student_id);
        }).length;
        const thisWeekCounselings = counselingsData.filter(c => {
            const consultDate = c.consultation_date ? c.consultation_date.split('T')[0].split(' ')[0] : '';
            return consultDate >= thisWeekStartStr && courseStudentIds.includes(c.student_id);
        }).length;
        const todayTrainingLogs = trainingLogsData.filter(t => {
            const logDate = (t['t.class_date'] || t.class_date || '').split('T')[0].split(' ')[0];
            const studentId = t.student_id || t['s.id'];
            return logDate === todayDate && courseStudentIds.includes(studentId);
        }).length;
        
        // ê³¼ì •ë³„ í•™ìƒ ìˆ˜ ê³„ì‚°
        const studentsByCourse = {};
        coursesData.forEach(c => {
            studentsByCourse[c.code] = studentsData.filter(s => s.course_code === c.code).length;
        });
        
        // ìµœê·¼ 7ì¼ ìƒë‹´ ì¶”ì´
        const last7Days = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.getFullYear() + '-' + 
                            String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(d.getDate()).padStart(2, '0');
            last7Days.push({
                date: dateStr,
                count: counselingsData.filter(c => {
                    // consultation_dateëŠ” "2025-11-17T00:00:00" í˜•ì‹ì´ë¯€ë¡œ ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                    const consultDate = c.consultation_date ? c.consultation_date.split('T')[0].split(' ')[0] : '';
                    return consultDate === dateStr && courseStudentIds.includes(c.student_id);
                }).length
            });
        }

        // ì „ì²´ ê³¼ì •ì¼ ë•Œ ê³¼ì •ë³„ 7ì¼ ìƒë‹´ ë°ì´í„°
        const last7DaysByCourse = {};
        if (isAllCourses) {
            coursesData.forEach(course => {
                const cStudentIds = studentsData.filter(s => s.course_code === course.code).map(s => s.id);
                last7DaysByCourse[course.code] = {
                    name: course.name,
                    data: last7Days.map(day => ({
                        date: day.date,
                        count: counselingsData.filter(c => {
                            const consultDate = c.consultation_date ? c.consultation_date.split('T')[0].split(' ')[0] : '';
                            return consultDate === day.date && cStudentIds.includes(c.student_id);
                        }).length
                    }))
                };
            });
        }

        // ì§„ë¡œ ê²°ì • í˜„í™© ê³„ì‚° (í•™ìƒë³„ ë§ˆì§€ë§‰ ìƒë‹´ì˜ career_decision ê¸°ë°˜)
        const careerCounts = { study: 0, employed: 0, startup: 0, undecided: 0, other: 0 };
        
        courseStudents.forEach(student => {
            // í•´ë‹¹ í•™ìƒì˜ ëª¨ë“  ìƒë‹´ ì°¾ê¸°
            const studentCounselings = counselingsData.filter(c => c.student_id === student.id);
            
            if (studentCounselings.length > 0) {
                // ë‚ ì§œìˆœ ì •ë ¬í•˜ì—¬ ë§ˆì§€ë§‰ ìƒë‹´ ì°¾ê¸°
                studentCounselings.sort((a, b) => new Date(b.consultation_date) - new Date(a.consultation_date));
                const lastCounseling = studentCounselings[0];
                
                // career_decisionì´ ìˆìœ¼ë©´ ì§‘ê³„
                if (lastCounseling.career_decision) {
                    if (lastCounseling.career_decision === '1. í•™ì—…') careerCounts.study++;
                    else if (lastCounseling.career_decision === '2. ì·¨ì—…') careerCounts.employed++;
                    else if (lastCounseling.career_decision === '3. ì°½ì—…') careerCounts.startup++;
                    else if (lastCounseling.career_decision === '4. ë¯¸ì •') careerCounts.undecided++;
                    else if (lastCounseling.career_decision === '5. ê¸°íƒ€') careerCounts.other++;
                } else {
                    // career_decisionì´ ì—†ìœ¼ë©´ ë¯¸ì •ìœ¼ë¡œ ì²˜ë¦¬
                    careerCounts.undecided++;
                }
            } else {
                // ìƒë‹´ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ë¯¸ì •ìœ¼ë¡œ ì²˜ë¦¬
                careerCounts.undecided++;
            }
        });
        
        const careerStudy = careerCounts.study;
        const careerEmployed = careerCounts.employed;
        const careerStartup = careerCounts.startup;
        const careerUndecided = careerCounts.undecided;
        const careerOther = careerCounts.other;
        
        // ê°•ì‚¬ ìœ í˜•ë³„ í†µê³„ (ê³¼ì • í•„í„° ì ìš© - ì „ì²´ ê³¼ì • ê°•ì‚¬ í¬í•¨)
        const instructorsByType = {};
        let filteredInstructors = instructorsData;
        if (!isAllCourses) {
            const courseInstructorCodes = new Set(
                timetablesData.filter(t => t.course_code === mainCourse.code && t.instructor_code)
                    .map(t => t.instructor_code)
            );
            filteredInstructors = instructorsData.filter(i =>
                courseInstructorCodes.has(i.code) ||
                (i.course_codes && i.course_codes.length === 0) ||
                (i.course_codes && i.course_codes.includes(mainCourse.code))
            );
        }
        filteredInstructors.forEach(i => {
            const typeName = i.instructor_type_name || 'ë¯¸ë¶„ë¥˜';
            instructorsByType[typeName] = (instructorsByType[typeName] || 0) + 1;
        });

        // ê°•ì‚¬ ì†Œì† êµ¬ë¶„ë³„ í†µê³„
        const instructorsBySource = { timetable: 0, allCourses: 0, courseAssigned: 0 };
        if (!isAllCourses) {
            const courseInstructorCodes = new Set(
                timetablesData.filter(t => t.course_code === mainCourse.code && t.instructor_code)
                    .map(t => t.instructor_code)
            );
            instructorsData.forEach(i => {
                if (courseInstructorCodes.has(i.code)) {
                    instructorsBySource.timetable++;
                } else if (i.course_codes && i.course_codes.length === 0) {
                    instructorsBySource.allCourses++;
                } else if (i.course_codes && i.course_codes.includes(mainCourse.code)) {
                    instructorsBySource.courseAssigned++;
                }
            });
        }

        // ì§„ë„ìœ¨ ê³„ì‚° í•¨ìˆ˜ (ê³¼ì •ë³„)
        window.calculateProgress = function(courseCode) {
            // ì „ì²´ ê³¼ì •ì¼ ê²½ìš° ëª¨ë“  ê³¼ì •ì˜ í•©ê³„ ê³„ì‚°
            if (courseCode === 'ALL') {
                let totalLectureHours = 0;
                let totalProjectHours = 0;
                let totalWorkshipHours = 0;
                let totalLectureCompleted = 0;
                let totalProjectCompleted = 0;
                let totalWorkshipCompleted = 0;
                let totalPastTimetables = 0;
                let totalTrainingLogCount = 0;
                
                // ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
                const calcHours = (tt) => {
                    if (!tt.start_time || !tt.end_time) return 0;
                    const startHour = parseInt(tt.start_time.split(':')[0]);
                    const startMinute = parseInt(tt.start_time.split(':')[1] || 0);
                    const endHour = parseInt(tt.end_time.split(':')[0]);
                    const endMinute = parseInt(tt.end_time.split(':')[1] || 0);
                    return (endHour * 60 + endMinute - startHour * 60 - startMinute) / 60;
                };
                
                // ëª¨ë“  ê³¼ì • ìˆœíšŒ
                coursesData.forEach(course => {
                    totalLectureHours += course.lecture_hours || 0;
                    totalProjectHours += course.project_hours || 0;
                    totalWorkshipHours += course.workship_hours || 0;
                    
                    // ì˜¤ëŠ˜ê¹Œì§€ì˜ ì‹œê°„í‘œ í•„í„°ë§
                    const completedTimetables = timetablesData.filter(tt => 
                        tt.course_code === course.code && 
                        tt.class_date <= todayDate
                    );
                    
                    // ìœ í˜•ë³„ ì‹œìˆ˜ ê³„ì‚°
                    completedTimetables.forEach(tt => {
                        const hours = calcHours(tt);
                        if (tt.type === 'lecture') totalLectureCompleted += hours;
                        else if (tt.type === 'project') totalProjectCompleted += hours;
                        else if (tt.type === 'practice') totalWorkshipCompleted += hours;
                    });
                    
                    // í›ˆë ¨ì¼ì§€ ì‘ì„±ë¥  ê³„ì‚° (ì˜¤ëŠ˜ ì´ì „ê¹Œì§€)
                    const pastTimetables = timetablesData.filter(tt => 
                        tt.course_code === course.code && 
                        tt.class_date < todayDate
                    );
                    totalPastTimetables += pastTimetables.length;
                    
                    const trainingLogCount = trainingLogsData.filter(log => {
                        const logTimetable = timetablesData.find(tt => tt.id === log.timetable_id);
                        return logTimetable && logTimetable.course_code === course.code && logTimetable.class_date < todayDate;
                    }).length;
                    totalTrainingLogCount += trainingLogCount;
                });
                
                const totalHours = totalLectureHours + totalProjectHours + totalWorkshipHours;
                const trainingLogRate = totalPastTimetables > 0 ? Math.round((totalTrainingLogCount / totalPastTimetables) * 100) : 0;
                
                return {
                    lecture: totalLectureHours > 0 ? Math.round((totalLectureCompleted / totalLectureHours) * 100) : 0,
                    project: totalProjectHours > 0 ? Math.round((totalProjectCompleted / totalProjectHours) * 100) : 0,
                    workship: totalWorkshipHours > 0 ? Math.round((totalWorkshipCompleted / totalWorkshipHours) * 100) : 0,
                    total: totalHours > 0 ? Math.round(((totalLectureCompleted + totalProjectCompleted + totalWorkshipCompleted) / totalHours) * 100) : 0,
                    lectureCompleted: Math.round(totalLectureCompleted),
                    projectCompleted: Math.round(totalProjectCompleted),
                    workshipCompleted: Math.round(totalWorkshipCompleted),
                    lectureTotal: totalLectureHours,
                    projectTotal: totalProjectHours,
                    workshipTotal: totalWorkshipHours,
                    trainingLogRate,
                    trainingLogCount: totalTrainingLogCount,
                    pastTimetablesCount: totalPastTimetables
                };
            }
            
            // ë‹¨ì¼ ê³¼ì • ì²˜ë¦¬
            const course = coursesData.find(c => c.code === courseCode);
            if (!course) return { lecture: 0, project: 0, workship: 0, total: 0, trainingLogRate: 0 };
            
            const lectureTotal = course.lecture_hours || 0;
            const projectTotal = course.project_hours || 0;
            const workshipTotal = course.workship_hours || 0;
            const totalHours = lectureTotal + projectTotal + workshipTotal;
            
            let lectureCompleted = 0;
            let projectCompleted = 0;
            let workshipCompleted = 0;
            
            // ì˜¤ëŠ˜ê¹Œì§€ì˜ ì‹œê°„í‘œ í•„í„°ë§
            const completedTimetables = timetablesData.filter(tt => 
                tt.course_code === courseCode && 
                tt.class_date <= todayDate
            );
            
            // ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
            const calcHours = (tt) => {
                if (!tt.start_time || !tt.end_time) return 0;
                const startHour = parseInt(tt.start_time.split(':')[0]);
                const startMinute = parseInt(tt.start_time.split(':')[1] || 0);
                const endHour = parseInt(tt.end_time.split(':')[0]);
                const endMinute = parseInt(tt.end_time.split(':')[1] || 0);
                return (endHour * 60 + endMinute - startHour * 60 - startMinute) / 60;
            };
            
            // ìœ í˜•ë³„ ì‹œìˆ˜ ê³„ì‚°
            completedTimetables.forEach(tt => {
                const hours = calcHours(tt);
                if (tt.type === 'lecture') lectureCompleted += hours;
                else if (tt.type === 'project') projectCompleted += hours;
                else if (tt.type === 'practice') workshipCompleted += hours;
            });
            
            // í›ˆë ¨ì¼ì§€ ì‘ì„±ë¥  ê³„ì‚° (ì˜¤ëŠ˜ ì´ì „ê¹Œì§€)
            const pastTimetables = timetablesData.filter(tt => 
                tt.course_code === courseCode && 
                tt.class_date < todayDate
            );
            const trainingLogCount = trainingLogsData.filter(log => {
                const logTimetable = timetablesData.find(tt => tt.id === log.timetable_id);
                return logTimetable && logTimetable.course_code === courseCode && logTimetable.class_date < todayDate;
            }).length;
            const trainingLogRate = pastTimetables.length > 0 ? Math.round((trainingLogCount / pastTimetables.length) * 100) : 0;
            
            return {
                lecture: lectureTotal > 0 ? Math.round((lectureCompleted / lectureTotal) * 100) : 0,
                project: projectTotal > 0 ? Math.round((projectCompleted / projectTotal) * 100) : 0,
                workship: workshipTotal > 0 ? Math.round((workshipCompleted / workshipTotal) * 100) : 0,
                total: totalHours > 0 ? Math.round(((lectureCompleted + projectCompleted + workshipCompleted) / totalHours) * 100) : 0,
                lectureCompleted: Math.round(lectureCompleted),
                projectCompleted: Math.round(projectCompleted),
                workshipCompleted: Math.round(workshipCompleted),
                lectureTotal,
                projectTotal,
                workshipTotal,
                trainingLogRate,
                trainingLogCount,
                pastTimetablesCount: pastTimetables.length
            };
        };
        
        // ì§„ë„ìœ¨ ê³„ì‚°
        const progress = window.calculateProgress(mainCourse.code);
        
        // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="p-3">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-tachometer-alt mr-2"></i>ëŒ€ì‹œë³´ë“œ
                    </h2>
                    <div class="flex items-center gap-2">
                        <!-- BGM ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ì–‡ê²Œ, í•œ ì¤„) -->
                        <div id="dashboard-bgm-panel" class="flex items-center gap-1.5 bg-pink-50 px-2 py-1 rounded border border-pink-200">
                            <select id="dashboard-bgm-genre" class="px-2 py-0.5 border rounded text-xs bg-white text-gray-700 focus:outline-none" onchange="window.changeBGMGenre(this.value)">
                                <option value="">ğŸµ BGM ë„ê¸°</option>
                                <option value="classical">ğŸ» í´ë˜ì‹</option>
                                <option value="piano">ğŸ¹ í”¼ì•„ë…¸</option>
                                <option value="meditation">ğŸ§˜ ëª…ìƒ</option>
                                <option value="oldpop">ğŸ¤ íŒì†¡</option>
                                <option value="custom">ğŸ” ì§ì ‘ ê²€ìƒ‰</option>
                            </select>
                            <input type="text" id="dashboard-bgm-search" placeholder="ê²€ìƒ‰..." 
                                   class="px-2 py-0.5 border rounded text-xs bg-white text-gray-700 w-20 hidden focus:outline-none"
                                   onkeypress="if(event.key==='Enter'){window.changeBGMGenre(this.value);}">
                            <button id="dashboard-bgm-play-btn" onclick="window.toggleBGM()" class="text-pink-600 hover:text-pink-800 transition">
                                <i class="fas fa-play text-xs"></i>
                            </button>
                            <input type="range" id="dashboard-bgm-volume" min="0" max="100" value="30" 
                                   class="w-16 h-1" oninput="window.changeBGMVolume(this.value)">
                            <span id="dashboard-volume-value" class="text-xs text-pink-600 min-w-[2rem]">30%</span>
                        </div>

                        <!-- íŒ¨ë„ ì„¤ì • ë²„íŠ¼ -->
                        <div class="relative">
                            <button onclick="window.togglePanelSettings()" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition" title="íŒ¨ë„ í‘œì‹œ ì„¤ì •">
                                <i class="fas fa-cog text-sm"></i>
                            </button>
                            <div id="panel-settings-dropdown" class="hidden absolute right-0 top-full mt-1 bg-white rounded-lg shadow-xl border border-gray-200 p-3 z-50 min-w-[180px]">
                                <p class="text-xs font-bold text-gray-700 mb-2 pb-1 border-b">íŒ¨ë„ í‘œì‹œ ì„¤ì •</p>
                                ${[
                                    { id: 'stats', name: 'í†µê³„ ì¹´ë“œ' },
                                    { id: 'charts', name: 'ì°¨íŠ¸' },
                                    { id: 'progress', name: 'ì§„ë„ìœ¨' },
                                    { id: 'schedule-counseling', name: 'ì‹œê°„í‘œ/ìƒë‹´' },
                                    { id: 'logs-team', name: 'í›ˆë ¨ì¼ì§€/íŒ€í™œë™' },
                                    { id: 'service-monitor', name: 'ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°' }
                                ].map(p => {
                                    const hidden = (JSON.parse(localStorage.getItem('dashboard_hidden_panels') || '[]')).includes(p.id);
                                    return `<label class="flex items-center gap-2 py-1 cursor-pointer hover:bg-gray-50 rounded px-1">
                                        <input type="checkbox" ${hidden ? '' : 'checked'} onchange="window.toggleDashboardPanel('${p.id}')" class="rounded text-blue-600 focus:ring-blue-500">
                                        <span class="text-xs text-gray-700">${p.name}</span>
                                    </label>`;
                                }).join('')}
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm font-semibold text-gray-700">
                                <i class="fas fa-filter mr-1 text-blue-600"></i>ê³¼ì • ì„ íƒ:
                            </label>
                            <select id="dashboard-course-filter" class="px-4 py-2 border-2 border-blue-500 rounded-lg text-base font-semibold bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 transition" onchange="window.filterDashboard(this.value)">
                                <option value="ALL" ${mainCourse.code === 'ALL' ? 'selected' : ''}>
                                    ğŸŒ ì „ì²´ ê³¼ì •
                                </option>
                                ${coursesData.map(c => `
                                    <option value="${c.code}" ${c.code === mainCourse.code ? 'selected' : ''}>
                                        ${c.name || c.code}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ìƒë‹¨ í†µê³„ ì¹´ë“œ (ê¶Œí•œì— ë”°ë¼ í‘œì‹œ) -->
                <div data-panel-id="stats">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 mb-3">
                    <!-- í•™ìƒ -->
                    ${isMenuAllowed('students') ? `
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow p-3 text-white cursor-pointer hover:shadow-lg transition" onclick="showTab('students')">
                        <div class="flex items-center justify-between mb-1">
                            <i class="fas fa-user-graduate text-xl"></i>
                            <p class="text-2xl font-bold">${courseStudents.length}</p>
                        </div>
                        <p class="text-xs text-blue-100">${isAllCourses ? 'ì „ì²´' : 'ê³¼ì •'} í•™ìƒ</p>
                    </div>
                    ` : ''}

                    <!-- ê°•ì‚¬ -->
                    ${isMenuAllowed('instructors') ? `
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow p-3 text-white cursor-pointer hover:shadow-lg transition" onclick="showTab('instructors')">
                        <div class="flex items-center justify-between mb-1">
                            <i class="fas fa-chalkboard-teacher text-xl"></i>
                            <p class="text-2xl font-bold">${instructorsData.length}</p>
                        </div>
                        <p class="text-xs text-green-100">ì „ì²´ ê°•ì‚¬</p>
                    </div>
                    ` : ''}

                    <!-- ê³¼ì • -->
                    ${isMenuAllowed('courses') ? `
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow p-3 text-white cursor-pointer hover:shadow-lg transition" onclick="showTab('courses')">
                        <div class="flex items-center justify-between mb-1">
                            <i class="fas fa-school text-xl"></i>
                            <p class="text-2xl font-bold">${coursesData.length}</p>
                        </div>
                        <p class="text-xs text-purple-100">ì´ ê³¼ì •</p>
                    </div>
                    ` : ''}

                    <!-- ì˜¤ëŠ˜ ìˆ˜ì—… -->
                    ${isMenuAllowed('timetables') ? `
                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg shadow p-3 text-white cursor-pointer hover:shadow-lg transition" onclick="showTab('timetables')">
                        <div class="flex items-center justify-between mb-1">
                            <i class="fas fa-calendar-day text-xl"></i>
                            <p class="text-2xl font-bold">${todayTimetables.length}</p>
                        </div>
                        <p class="text-xs text-indigo-100">ì˜¤ëŠ˜ ìˆ˜ì—…</p>
                    </div>
                    ` : ''}

                    <!-- ìƒë‹´ -->
                    ${isMenuAllowed('counselings') ? `
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow p-3 text-white cursor-pointer hover:shadow-lg transition" onclick="showTab('counselings')">
                        <div class="flex items-center justify-between mb-1">
                            <i class="fas fa-comments text-xl"></i>
                            <p class="text-2xl font-bold">${todayCounselings}</p>
                        </div>
                        <p class="text-xs text-orange-100">ì˜¤ëŠ˜ (ì´ ${totalCourseCounselings.length}ê±´)</p>
                    </div>
                    ` : ''}

                    <!-- íŒ€ êµ¬ì„±ì› ìˆ˜ -->
                    ${isMenuAllowed('projects') ? `
                    <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg shadow p-3 text-white cursor-pointer hover:shadow-lg transition" onclick="showTab('projects')">
                        <div class="flex items-center justify-between mb-1">
                            <i class="fas fa-users text-xl"></i>
                            <p class="text-2xl font-bold">${courseProjects.length}</p>
                        </div>
                        <p class="text-xs text-pink-100">ê³¼ì • íŒ€</p>
                    </div>
                    ` : ''}
                </div>
                </div>

                <!-- ì°¨íŠ¸ ì„¹ì…˜ (ê¶Œí•œì— ë”°ë¼ í‘œì‹œ) -->
                <div data-panel-id="charts">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <!-- ì „ì²´ ê³¼ì •: ê³¼ì •ë³„ í•™ìƒ í˜„í™© / íŠ¹ì • ê³¼ì •: ì§„ë¡œ ê²°ì • í˜„í™© -->
                    ${isAllCourses ? (isMenuAllowed('students') && isChartAllowed('studentsByCourse') ? `
                    <div class="bg-white rounded-lg shadow p-3">
                        <h3 class="text-sm font-bold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-users mr-2 text-blue-600"></i>ê³¼ì •ë³„ í•™ìƒ í˜„í™©
                        </h3>
                        <canvas id="studentsByCourseChart" class="w-full" style="max-height: 180px;"></canvas>
                    </div>
                    ` : '') : (isMenuAllowed('counselings') ? `
                    <div class="bg-white rounded-lg shadow p-3">
                        <h3 class="text-sm font-bold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-briefcase mr-2 text-purple-600"></i>ì§„ë¡œ ê²°ì • í˜„í™©
                        </h3>
                        <canvas id="careerChart" class="w-full" style="max-height: 180px;"></canvas>
                    </div>
                    ` : '')}

                    <!-- ê°•ì‚¬ ìœ í˜•ë³„ ë¶„í¬ (íŒŒì´ ì°¨íŠ¸) - ê°•ì‚¬ê´€ë¦¬ ê¶Œí•œ + ê·¸ë˜í”„ ì„¤ì • -->
                    ${isMenuAllowed('instructors') && isChartAllowed('instructorType') ? `
                    <div class="bg-white rounded-lg shadow p-3">
                        <h3 class="text-sm font-bold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-user-tie mr-2 text-green-600"></i>${isAllCourses ? 'ê°•ì‚¬ ìœ í˜•ë³„ ë¶„í¬' : 'ê°•ì‚¬ ì†Œì† êµ¬ë¶„'}
                        </h3>
                        <canvas id="instructorChart" class="w-full" style="max-height: 180px;"></canvas>
                    </div>
                    ` : ''}

                    <!-- ìµœê·¼ 7ì¼ ìƒë‹´ ì¶”ì´ (ë¼ì¸ ì°¨íŠ¸) - ìƒë‹´ê¶Œí•œ + ê·¸ë˜í”„ ì„¤ì • -->
                    ${isMenuAllowed('counselings') && isChartAllowed('counselingTrend') ? `
                    <div class="bg-white rounded-lg shadow p-3">
                        <h3 class="text-sm font-bold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-orange-600"></i>ìµœê·¼ 7ì¼ ìƒë‹´ ì¶”ì´ (${isAllCourses ? 'ê³¼ì •ë³„' : 'ì „ì²´ ê°•ì‚¬'})
                        </h3>
                        <canvas id="counselingTrendChart" class="w-full" style="max-height: 180px;"></canvas>
                    </div>
                    ` : ''}
                </div>
                </div>

                <!-- ì§„ë„ìœ¨ ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„ - ê·¸ë˜í”„ ì„¤ì • -->
                <div data-panel-id="progress">
                ${isChartAllowed('progress') ? `
                <div class="bg-white rounded-lg shadow p-3 mb-3">
                    <h3 class="text-sm font-bold text-gray-800 mb-3">
                        <i class="fas fa-chart-bar mr-2 text-blue-600"></i>${isAllCourses ? 'ì „ì²´ ê³¼ì • ì§„ë„ìœ¨' : mainCourse.name + ' ì§„ë„ìœ¨'}
                    </h3>

                    ${isAllCourses ? `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${coursesData.map(c => {
                            const p = window.calculateProgress(c.code);
                            return `
                            <div class="border rounded-lg p-3 bg-gray-50">
                                <h4 class="text-xs font-bold text-gray-800 mb-2 truncate" title="${c.name}">${c.name}</h4>
                                <div class="mb-2">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <span class="text-[10px] text-gray-600">ê°•ì˜</span>
                                        <span class="text-[10px] text-gray-500">${p.lectureCompleted}h/${p.lectureTotal}h</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-4 rounded-full flex items-center justify-end pr-1 transition-all duration-500" style="width: ${Math.max(p.lecture, 2)}%">
                                            <span class="text-[10px] font-bold text-white">${p.lecture}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <span class="text-[10px] text-gray-600">í”„ë¡œì íŠ¸</span>
                                        <span class="text-[10px] text-gray-500">${p.projectCompleted}h/${p.projectTotal}h</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                        <div class="bg-gradient-to-r from-green-500 to-green-600 h-4 rounded-full flex items-center justify-end pr-1 transition-all duration-500" style="width: ${Math.max(p.project, 2)}%">
                                            <span class="text-[10px] font-bold text-white">${p.project}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <span class="text-[10px] text-gray-600">í˜„ì¥ì‹¤ìŠµ</span>
                                        <span class="text-[10px] text-gray-500">${p.workshipCompleted}h/${p.workshipTotal}h</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-4 rounded-full flex items-center justify-end pr-1 transition-all duration-500" style="width: ${Math.max(p.workship, 2)}%">
                                            <span class="text-[10px] font-bold text-white">${p.workship}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-0.5">
                                        <span class="text-[10px] text-gray-600">í›ˆë ¨ì¼ì§€</span>
                                        <span class="text-[10px] text-gray-500">${p.trainingLogCount}/${p.pastTimetablesCount}ê°œ</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                        <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 h-4 rounded-full flex items-center justify-end pr-1 transition-all duration-500" style="width: ${Math.max(p.trainingLogRate, 2)}%">
                                            <span class="text-[10px] font-bold text-white">${p.trainingLogRate}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    ` : `
                    <!-- ê°•ì˜ ì§„ë„ìœ¨ -->
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-semibold text-gray-700">ê°•ì˜ (${mainCourse?.start_date?.substring(0, 10) || '-'} ~ ${mainCourse?.lecture_end_date?.substring(0, 10) || '-'})</span>
                            <span class="text-xs text-gray-600">${progress.lectureCompleted}h / ${progress.lectureTotal}h (${progress.lecture}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6 relative overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-6 rounded-full flex items-center justify-end pr-2 transition-all duration-500"
                                 style="width: ${progress.lecture}%">
                                <span class="text-xs font-bold text-white">${progress.lecture}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- í”„ë¡œì íŠ¸ ì§„ë„ìœ¨ -->
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-semibold text-gray-700">í”„ë¡œì íŠ¸ (${mainCourse?.lecture_end_date?.substring(0, 10) || '-'} ~ ${mainCourse?.project_end_date?.substring(0, 10) || '-'})</span>
                            <span class="text-xs text-gray-600">${progress.projectCompleted}h / ${progress.projectTotal}h (${progress.project}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6 relative overflow-hidden">
                            <div class="bg-gradient-to-r from-green-500 to-green-600 h-6 rounded-full flex items-center justify-end pr-2 transition-all duration-500"
                                 style="width: ${progress.project}%">
                                <span class="text-xs font-bold text-white">${progress.project}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- í˜„ì¥ì‹¤ìŠµ ì§„ë„ìœ¨ -->
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-semibold text-gray-700">í˜„ì¥ì‹¤ìŠµ (${mainCourse?.project_end_date?.substring(0, 10) || '-'} ~ ${mainCourse?.workship_end_date?.substring(0, 10) || '-'})</span>
                            <span class="text-xs text-gray-600">${progress.workshipCompleted}h / ${progress.workshipTotal}h (${progress.workship}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6 relative overflow-hidden">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-6 rounded-full flex items-center justify-end pr-2 transition-all duration-500"
                                 style="width: ${progress.workship}%">
                                <span class="text-xs font-bold text-white">${progress.workship}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- í›ˆë ¨ì¼ì§€ ì‘ì„±ë¥  -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-semibold text-gray-700">í›ˆë ¨ì¼ì§€ ì‘ì„±ë¥ </span>
                            <span class="text-xs text-gray-600">${progress.trainingLogCount}ê°œ / ${progress.pastTimetablesCount}ê°œ (${progress.trainingLogRate}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6 relative overflow-hidden">
                            <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 h-6 rounded-full flex items-center justify-end pr-2 transition-all duration-500"
                                 style="width: ${progress.trainingLogRate}%">
                                <span class="text-xs font-bold text-white">${progress.trainingLogRate}%</span>
                            </div>
                        </div>
                    </div>
                    `}
                </div>
                ` : ''}
                </div>

                <!-- 2ì—´ ê·¸ë¦¬ë“œ (ê¶Œí•œì— ë”°ë¼ í‘œì‹œ) -->
                <div data-panel-id="schedule-counseling">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mb-3">
                    <!-- ì˜¤ëŠ˜ì˜ ì‹œê°„í‘œ - ì‹œê°„í‘œ ê¶Œí•œ -->
                    ${isMenuAllowed('timetables') ? `
                    <div class="bg-white rounded-lg shadow p-3">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-bold text-gray-800">
                                <i class="fas fa-calendar-day mr-2 text-blue-600"></i>ì˜¤ëŠ˜ ì‹œê°„í‘œ
                            </h3>
                            <button onclick="showTab('timetables')" class="text-blue-600 hover:text-blue-700 text-xs font-semibold">
                                ì „ì²´ <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        <div class="space-y-1.5">
                            ${todayTimetables.length > 0 ? todayTimetables.slice(0, 5).map(t => `
                                <div class="border-l-3 ${
                                    t.type === 'lecture' ? 'border-blue-500' :
                                    t.type === 'project' ? 'border-green-500' :
                                    'border-purple-500'
                                } bg-gray-50 rounded p-2 hover:bg-gray-100 transition">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-1 mb-0.5">
                                                <h4 class="font-bold text-gray-800 text-xs truncate">${t.subject_name || 'ê³¼ëª©ëª… ì—†ìŒ'}</h4>
                                                <span class="text-xs px-1 py-0.5 rounded flex-shrink-0 ${
                                                    t.type === 'lecture' ? 'bg-blue-100 text-blue-700' :
                                                    t.type === 'project' ? 'bg-green-100 text-green-700' :
                                                    'bg-purple-100 text-purple-700'
                                                }">
                                                    ${t.type === 'lecture' ? 'ê°•ì˜' : t.type === 'project' ? 'í”„ë¡œì íŠ¸' : 'ì‹¤ìŠµ'}
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-600 truncate">
                                                <i class="fas fa-chalkboard-teacher mr-1"></i>${t.instructor_name || 'ë¯¸ì •'}
                                            </p>
                                        </div>
                                        <div class="text-right ml-2 flex-shrink-0">
                                            <p class="text-xs font-bold text-blue-600">${t.start_time.substring(0,5)}</p>
                                            <p class="text-xs text-gray-500">${t.end_time.substring(0,5)}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="text-center py-4 text-gray-400">
                                    <i class="fas fa-calendar-times text-2xl mb-1"></i>
                                    <p class="text-xs">ì˜¤ëŠ˜ ìˆ˜ì—… ì—†ìŒ</p>
                                </div>
                            `}
                        </div>
                    </div>
                    ` : ''}

                    <!-- ìµœê·¼ ìƒë‹´ - ìƒë‹´ ê¶Œí•œ -->
                    ${isMenuAllowed('counselings') ? `
                    <div class="bg-white rounded-lg shadow p-3">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-bold text-gray-800">
                                <i class="fas fa-comments mr-2 text-green-600"></i>ìµœê·¼ ìƒë‹´ (ì „ì²´ ê°•ì‚¬)
                            </h3>
                            <button onclick="showTab('counselings')" class="text-green-600 hover:text-green-700 text-xs font-semibold">
                                ì „ì²´ <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        <div class="space-y-1.5">
                            ${recentCounselings.length > 0 ? recentCounselings.slice(0, 2).map(c => `
                                <div class="flex items-start justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 transition">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-semibold text-xs text-gray-800 truncate">${c.student_name} (${c.student_code})</p>
                                        <p class="text-xs text-gray-600 truncate">
                                            <i class="fas fa-user-tie mr-1"></i>${c.instructor_name || 'ë¯¸ì •'}
                                        </p>
                                        <p class="text-xs text-gray-500 truncate mt-0.5">
                                            ${c.content ? (c.content.length > 30 ? c.content.substring(0, 30) + '...' : c.content) : 'ë‚´ìš© ì—†ìŒ'}
                                        </p>
                                    </div>
                                    <div class="text-right ml-2 flex-shrink-0">
                                        <p class="text-xs font-semibold text-gray-700">${new Date(c.consultation_date).getMonth()+1}/${new Date(c.consultation_date).getDate()}</p>
                                        <span class="text-xs px-1 py-0.5 rounded mt-1 inline-block ${
                                            c.consultation_type === 'ê¸´ê¸‰' ? 'bg-red-100 text-red-800' :
                                            c.consultation_type === 'ì •ê¸°' ? 'bg-blue-100 text-blue-800' :
                                            'bg-purple-100 text-purple-800'
                                        }">
                                            ${c.consultation_type || 'ì •ê¸°'}
                                        </span>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="text-center py-4 text-gray-400">
                                    <i class="fas fa-comment-slash text-2xl mb-1"></i>
                                    <p class="text-xs">ìƒë‹´ ê¸°ë¡ ì—†ìŒ</p>
                                </div>
                            `}
                        </div>
                    </div>
                    ` : ''}
                </div>
                </div>

                <!-- 3ì—´ ê·¸ë¦¬ë“œ (ê¶Œí•œì— ë”°ë¼ í‘œì‹œ) -->
                <div data-panel-id="logs-team">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                    <!-- ìµœê·¼ í›ˆë ¨ì¼ì§€ - í›ˆë ¨ì¼ì§€ ê¶Œí•œ -->
                    ${isMenuAllowed('training-logs') ? `
                    <div class="bg-white rounded-lg shadow p-3">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-bold text-gray-800">
                                <i class="fas fa-clipboard-list mr-2 text-indigo-600"></i>í›ˆë ¨ì¼ì§€ (ì „ì²´ ê°•ì‚¬)
                            </h3>
                            <button onclick="showTab('training-logs')" class="text-indigo-600 hover:text-indigo-700 text-xs font-semibold">
                                ì „ì²´ <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        <div class="space-y-1.5">
                            ${recentTrainingLogs.length > 0 ? recentTrainingLogs.map(t => {
                                const dateObj = new Date(t.class_date);
                                const isToday = t.class_date === today;
                                
                                // ì˜¤ëŠ˜ì€ 'ìˆ˜ì—…ì¤‘', ê·¸ ì™¸ ë‚ ì§œëŠ” ì‘ì„±/ë¯¸ì‘ì„± í‘œì‹œ
                                let statusBadge;
                                if (isToday) {
                                    statusBadge = '<span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">ìˆ˜ì—…ì¤‘</span>';
                                } else {
                                    statusBadge = t.hasLog 
                                        ? '<span class="px-1.5 py-0.5 bg-green-100 text-green-700 text-xs rounded">ì‘ì„±</span>'
                                        : '<span class="px-1.5 py-0.5 bg-red-100 text-red-700 text-xs rounded">ë¯¸ì‘ì„±</span>';
                                }
                                
                                return `
                                <div class="p-2 ${isToday ? 'bg-yellow-50' : 'bg-gray-50'} rounded hover:bg-gray-100 transition">
                                    <div class="flex items-start justify-between mb-0.5">
                                        <p class="text-xs font-semibold text-gray-800">${dateObj.getMonth()+1}/${dateObj.getDate()} ${isToday ? '(ì˜¤ëŠ˜)' : ''}</p>
                                        <div class="flex items-center gap-1">
                                            ${statusBadge}
                                            <span class="text-xs text-gray-500 truncate">${(t.subject_name || '').substring(0, 8)}</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-blue-600 truncate">
                                        <i class="fas fa-chalkboard-teacher mr-1"></i>${t.instructor_name || 'ë¯¸ì •'}
                                    </p>
                                    ${isToday ? `
                                        <p class="text-xs text-blue-500 truncate mt-0.5">
                                            <i class="fas fa-clock mr-1"></i>ìˆ˜ì—… ì§„í–‰ ì¤‘
                                        </p>
                                    ` : t.hasLog ? `
                                        <p class="text-xs text-gray-600 truncate mt-0.5">
                                            ${t.logContent ? (t.logContent.length > 35 ? t.logContent.substring(0, 35) + '...' : t.logContent) : 'ë‚´ìš© ì—†ìŒ'}
                                        </p>
                                    ` : `
                                        <p class="text-xs text-red-500 truncate mt-0.5">
                                            <i class="fas fa-exclamation-circle mr-1"></i>ì‘ì„± í•„ìš”
                                        </p>
                                    `}
                                </div>
                                `;
                            }).join('') : `
                                <div class="text-center py-4 text-gray-400">
                                    <p class="text-xs">ìµœê·¼ 2ì¼ ì‹œê°„í‘œ ì—†ìŒ</p>
                                </div>
                            `}
                        </div>
                    </div>
                    ` : ''}

                    <!-- ìµœê·¼ íŒ€ í™œë™ì¼ì§€ - íŒ€ê´€ë¦¬ ê¶Œí•œ -->
                    ${isMenuAllowed('projects') ? `
                    <div class="bg-white rounded-lg shadow p-3">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-bold text-gray-800">
                                <i class="fas fa-users mr-2 text-pink-600"></i>ìµœê·¼ íŒ€ í™œë™
                            </h3>
                            <button onclick="showTab('projects')" class="text-pink-600 hover:text-pink-700 text-xs font-semibold">
                                ì „ì²´ <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        <div class="space-y-1.5">
                            ${recentTeamActivityLogs.length > 0 ? recentTeamActivityLogs.slice(0, 4).map(log => `
                                <div class="p-2 bg-gray-50 rounded hover:bg-gray-100 transition">
                                    <div class="flex items-start justify-between mb-0.5">
                                        <p class="text-xs font-semibold text-gray-800 truncate flex-1">${log.project_name}</p>
                                        <p class="text-xs font-semibold text-gray-700 ml-2">${new Date(log.activity_date).getMonth()+1}/${new Date(log.activity_date).getDate()}</p>
                                    </div>
                                    <p class="text-xs text-pink-600 truncate">
                                        <i class="fas fa-tag mr-1"></i>${log.activity_type || 'íŒ€ í™œë™'}
                                    </p>
                                    <p class="text-xs text-gray-600 truncate mt-0.5">
                                        ${log.content ? (log.content.length > 35 ? log.content.substring(0, 35) + '...' : log.content) : 'ë‚´ìš© ì—†ìŒ'}
                                    </p>
                                </div>
                            `).join('') : `
                                <div class="text-center py-4 text-gray-400">
                                    <p class="text-xs">íŒ€ í™œë™ì¼ì§€ ì—†ìŒ</p>
                                </div>
                            `}
                        </div>
                    </div>
                    ` : ''}
                </div>
                </div>

                <!-- ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° & ì‹œìŠ¤í…œ ëª¨ë‹ˆí„° 2ì—´ -->
                <div data-panel-id="service-monitor">
                <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-2">
                    <!-- ì™¼ìª½: ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° -->
                    <div class="rounded-lg overflow-hidden shadow" style="background: linear-gradient(135deg, #1e293b 0%, #2d3a4d 100%);">
                        <div class="px-2.5 py-2">
                            <div class="flex items-center justify-between mb-1.5">
                                <h3 class="text-xs font-bold text-white flex items-center gap-1">
                                    <i class="fas fa-server text-emerald-400" style="font-size:10px"></i> <span style="font-size:11px">ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°</span>
                                </h3>
                                <div class="flex items-center gap-1">
                                    <span id="serviceMonitorLastUpdate" class="text-slate-500" style="font-size:9px"></span>
                                    <button onclick="window._refreshServiceMonitor && window._refreshServiceMonitor()" class="bg-slate-600 hover:bg-slate-500 text-white px-1.5 py-0.5 rounded transition" style="font-size:9px">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="serviceMonitorList" class="space-y-1" style="max-height:120px; overflow-y:auto;">
                                <div class="text-center py-2 text-slate-400">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p style="font-size:9px" class="mt-0.5">ë¡œë”© ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ì˜¤ë¥¸ìª½: ì‹œìŠ¤í…œ ëª¨ë‹ˆí„° -->
                    <div class="rounded-lg overflow-hidden shadow" style="background: linear-gradient(135deg, #1e293b 0%, #2d3a4d 100%);">
                        <div class="px-2.5 py-2">
                            <h3 class="text-xs font-bold text-white flex items-center gap-1 mb-1.5">
                                <i class="fas fa-microchip text-blue-400" style="font-size:10px"></i> <span style="font-size:11px">ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°</span>
                            </h3>
                            <div class="grid grid-cols-4 gap-1.5 mb-1.5">
                                <div class="bg-slate-800/60 rounded-lg p-1.5 border border-slate-600/30 text-center">
                                    <div class="relative inline-flex items-center justify-center w-8 h-8">
                                        <svg class="w-8 h-8 -rotate-90" viewBox="0 0 36 36">
                                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#334155" stroke-width="3.5"/>
                                            <path id="cpuGauge" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#3b82f6" stroke-width="3.5" stroke-dasharray="0, 100" stroke-linecap="round"/>
                                        </svg>
                                        <span class="absolute font-bold text-white" style="font-size:8px" id="cpuPercent">-</span>
                                    </div>
                                    <div class="font-semibold text-blue-400" style="font-size:9px">CPU</div>
                                </div>
                                <div class="bg-slate-800/60 rounded-lg p-1.5 border border-slate-600/30 text-center">
                                    <div class="relative inline-flex items-center justify-center w-8 h-8">
                                        <svg class="w-8 h-8 -rotate-90" viewBox="0 0 36 36">
                                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#334155" stroke-width="3.5"/>
                                            <path id="ramGauge" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#10b981" stroke-width="3.5" stroke-dasharray="0, 100" stroke-linecap="round"/>
                                        </svg>
                                        <span class="absolute font-bold text-white" style="font-size:8px" id="ramPercent">-</span>
                                    </div>
                                    <div class="font-semibold text-emerald-400" style="font-size:9px">RAM</div>
                                </div>
                                <div class="bg-slate-800/60 rounded-lg p-1.5 border border-slate-600/30 text-center">
                                    <div class="relative inline-flex items-center justify-center w-8 h-8">
                                        <svg class="w-8 h-8 -rotate-90" viewBox="0 0 36 36">
                                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#334155" stroke-width="3.5"/>
                                            <path id="diskGauge" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#f59e0b" stroke-width="3.5" stroke-dasharray="0, 100" stroke-linecap="round"/>
                                        </svg>
                                        <span class="absolute font-bold text-white" style="font-size:8px" id="diskPercent">-</span>
                                    </div>
                                    <div class="font-semibold text-amber-400" style="font-size:9px">DISK</div>
                                </div>
                                <div class="bg-slate-800/60 rounded-lg p-1.5 border border-slate-600/30 text-center">
                                    <div class="text-lg font-black text-white leading-tight" id="connTotal">-</div>
                                    <div class="text-slate-400" style="font-size:8px">ì ‘ì†</div>
                                    <div class="flex gap-0.5 justify-center">
                                        <span class="text-amber-400 font-bold" style="font-size:9px" id="connPort8000">-</span>
                                        <span class="text-slate-600" style="font-size:9px">/</span>
                                        <span class="text-cyan-400 font-bold" style="font-size:9px" id="connPort3000">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-slate-800/40 rounded p-1.5 border border-slate-700/30">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 rounded-full bg-blue-400 inline-block"></span>
                                        <span class="text-slate-400" style="font-size:8px">Load</span>
                                        <span class="text-white font-mono font-semibold" style="font-size:9px" id="loadAvgDisplay">-</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex items-center gap-1">
                                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 inline-block"></span>
                                            <span class="text-slate-400" style="font-size:8px">RAM</span>
                                            <span class="text-white font-mono" style="font-size:9px" id="ramUsageText">-</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="w-1.5 h-1.5 rounded-full bg-amber-400 inline-block"></span>
                                            <span class="text-slate-400" style="font-size:8px">Disk</span>
                                            <span class="text-white font-mono" style="font-size:9px" id="diskUsageText">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

            </div>
        `;

        // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        setTimeout(() => {
            console.log('ğŸ“Š ì°¨íŠ¸ ë Œë”ë§ ì‹œì‘...', { last7Days });
            
            // ê³¼ì •ë³„ í•™ìƒ í˜„í™© ë§‰ëŒ€ ì°¨íŠ¸
            const studentsByCourseCtx = document.getElementById('studentsByCourseChart');
            if (studentsByCourseCtx) {
                const filteredCourses = isAllCourses ? coursesData.slice(0, 5) : coursesData.filter(c => c.code === mainCourse.code);
                const courseNames = filteredCourses.map(c => c.name.length > 8 ? c.name.substring(0, 8) + '..' : c.name);
                const studentCounts = filteredCourses.map(c => studentsByCourse[c.code] || 0);
                const capacityCounts = filteredCourses.map(c => c.capacity || 0);
                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444'];

                new Chart(studentsByCourseCtx, {
                    type: 'bar',
                    data: {
                        labels: courseNames,
                        datasets: [{
                            label: 'ëª¨ì§‘ ì •ì›',
                            data: capacityCounts,
                            backgroundColor: colors.slice(0, courseNames.length).map(c => c + '25'),
                            borderColor: colors.slice(0, courseNames.length).map(c => c + '88'),
                            borderWidth: 1,
                            borderRadius: 5,
                            barPercentage: 0.85,
                            categoryPercentage: 0.8,
                            xAxisID: 'x',
                            order: 2
                        }, {
                            label: 'í˜„ì¬ í•™ìƒ',
                            data: studentCounts,
                            backgroundColor: colors.slice(0, courseNames.length).map(c => c + 'CC'),
                            borderWidth: 0,
                            borderRadius: 4,
                            barPercentage: 0.85,
                            categoryPercentage: 0.8,
                            xAxisID: 'x2',
                            order: 1
                        }]
                    },
                    plugins: [{
                        id: 'studentCourseLabels',
                        afterDatasetsDraw(chart) {
                            const { ctx } = chart;
                            const meta = chart.getDatasetMeta(1);
                            meta.data.forEach((bar, index) => {
                                const count = studentCounts[index];
                                const capacity = capacityCounts[index];
                                const label = capacity > 0 ? count + '/' + capacity + 'ëª…' : count + 'ëª…';
                                ctx.save();
                                ctx.font = 'bold 11px sans-serif';
                                ctx.fillStyle = '#1E3A5F';
                                ctx.textAlign = 'center';
                                ctx.fillText(label, bar.x, bar.y - 5);
                                ctx.restore();
                            });
                        }
                    }],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: { top: 20 }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const idx = context.dataIndex;
                                        if (context.datasetIndex === 0) return 'ì •ì›: ' + capacityCounts[idx] + 'ëª…';
                                        return 'í•™ìƒ: ' + studentCounts[idx] + '/' + capacityCounts[idx] + 'ëª…';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 5 }
                            },
                            x: {
                                ticks: { font: { size: 9 } }
                            },
                            x2: {
                                display: false,
                                offset: true
                            }
                        }
                    }
                });
            }
            
            // ê°•ì‚¬ ìœ í˜•ë³„ ë¶„í¬ / ì†Œì† êµ¬ë¶„ ì°¨íŠ¸
            const instructorCtx = document.getElementById('instructorChart');
            if (instructorCtx) {
                if (isAllCourses) {
                    // ì „ì²´ ê³¼ì •: ê¸°ì¡´ ìœ í˜•ë³„ bar ì°¨íŠ¸
                    const instructorTypes = Object.keys(instructorsByType);
                    const instructorCounts = Object.values(instructorsByType);
                    const colors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#6366F1'];

                    new Chart(instructorCtx, {
                        type: 'bar',
                        data: {
                            labels: instructorTypes,
                            datasets: [{
                                data: instructorCounts,
                                backgroundColor: colors.slice(0, instructorTypes.length),
                                borderWidth: 0,
                                borderRadius: 4
                            }]
                        },
                        plugins: [{
                            id: 'instructorBarLabels',
                            afterDatasetsDraw(chart) {
                                const { ctx } = chart;
                                const meta = chart.getDatasetMeta(0);
                                const total = instructorCounts.reduce((a, b) => a + b, 0);
                                meta.data.forEach((bar, index) => {
                                    const value = chart.data.datasets[0].data[index];
                                    if (value > 0) {
                                        const pct = ((value / total) * 100).toFixed(0);
                                        ctx.save();
                                        ctx.font = 'bold 11px sans-serif';
                                        ctx.fillStyle = '#1E3A5F';
                                        ctx.textAlign = 'center';
                                        ctx.fillText(value + 'ëª…(' + pct + '%)', bar.x, bar.y - 5);
                                        ctx.restore();
                                    }
                                });
                            }
                        }],
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: { top: 20 }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = instructorCounts.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                                            return context.label + ': ' + context.parsed.y + 'ëª… (' + percentage + '%)';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 }
                                },
                                x: {
                                    ticks: { font: { size: 9 } }
                                }
                            }
                        }
                    });
                } else {
                    // íŠ¹ì • ê³¼ì •: ì†Œì† êµ¬ë¶„ë³„ bar ì°¨íŠ¸
                    const sourceLabels = ['ì‹œê°„í‘œ ë“±ë¡', 'ì „ì²´ ê³¼ì •', 'ê³¼ì • ë°°ì •'];
                    const sourceCounts = [instructorsBySource.timetable, instructorsBySource.allCourses, instructorsBySource.courseAssigned];
                    const sourceColors = ['#3B82F6', '#10B981', '#F59E0B'];

                    new Chart(instructorCtx, {
                        type: 'bar',
                        data: {
                            labels: sourceLabels,
                            datasets: [{
                                data: sourceCounts,
                                backgroundColor: sourceColors,
                                borderWidth: 0,
                                borderRadius: 4
                            }]
                        },
                        plugins: [{
                            id: 'sourceBarLabels',
                            afterDatasetsDraw(chart) {
                                const { ctx } = chart;
                                const meta = chart.getDatasetMeta(0);
                                const total = sourceCounts.reduce((a, b) => a + b, 0);
                                meta.data.forEach((bar, index) => {
                                    const value = chart.data.datasets[0].data[index];
                                    if (value > 0) {
                                        const pct = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                                        ctx.save();
                                        ctx.font = 'bold 11px sans-serif';
                                        ctx.fillStyle = '#1E3A5F';
                                        ctx.textAlign = 'center';
                                        ctx.fillText(value + 'ëª…(' + pct + '%)', bar.x, bar.y - 5);
                                        ctx.restore();
                                    }
                                });
                            }
                        }],
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: { top: 20 }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = sourceCounts.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                                            return context.label + ': ' + context.parsed.y + 'ëª… (' + percentage + '%)';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 }
                                },
                                x: {
                                    ticks: { font: { size: 9 } }
                                }
                            }
                        }
                    });
                }
            }
            
            // ìµœê·¼ 7ì¼ ìƒë‹´ ì¶”ì´ ë¼ì¸ ì°¨íŠ¸
            const counselingTrendCtx = document.getElementById('counselingTrendChart');
            console.log('counselingTrendChart ìº”ë²„ìŠ¤:', counselingTrendCtx);
            console.log('last7Days ë°ì´í„°:', last7Days);
            if (counselingTrendCtx) {
                console.log('âœ… counselingTrendChart ë Œë”ë§ ì‹œì‘');

                if (isAllCourses) {
                    // ì „ì²´ ê³¼ì •: ê³¼ì •ë³„ ë©€í‹°ë¼ì¸ ì°¨íŠ¸
                    const courseColors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16'];
                    const courseKeys = Object.keys(last7DaysByCourse);
                    const multiDatasets = courseKeys.map((code, idx) => {
                        const color = courseColors[idx % courseColors.length];
                        return {
                            label: last7DaysByCourse[code].name,
                            data: last7DaysByCourse[code].data.map(d => d.count),
                            borderColor: color,
                            backgroundColor: color + '1A',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            pointBackgroundColor: color,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            borderWidth: 2
                        };
                    });

                    new Chart(counselingTrendCtx, {
                        type: 'line',
                        data: {
                            labels: last7Days.map(d => {
                                const date = new Date(d.date);
                                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                                const dayName = days[date.getDay()];
                                return (date.getMonth() + 1) + '/' + date.getDate() + ' (' + dayName + ')';
                            }),
                            datasets: multiDatasets
                        },
                        plugins: [{
                            id: 'multiLineLabels',
                            afterDatasetsDraw(chart) {
                                const { ctx } = chart;
                                for (let di = 0; di < chart.data.datasets.length; di++) {
                                    const meta = chart.getDatasetMeta(di);
                                    const color = chart.data.datasets[di].borderColor;
                                    meta.data.forEach((point, index) => {
                                        const value = chart.data.datasets[di].data[index];
                                        if (value > 0) {
                                            ctx.save();
                                            ctx.font = 'bold 9px sans-serif';
                                            ctx.fillStyle = color;
                                            ctx.textAlign = 'center';
                                            ctx.fillText(value + 'ê±´', point.x, point.y - 8);
                                            ctx.restore();
                                        }
                                    });
                                }
                            }
                        }],
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: { top: 15 }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        font: { size: 9 },
                                        boxWidth: 12,
                                        padding: 8
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y + 'ê±´';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        font: { size: 10 }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: { size: 10 }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                } else {
                    // íŠ¹ì • ê³¼ì •: ê¸°ì¡´ ë‹¨ì¼ ë¼ì¸ ì°¨íŠ¸
                    new Chart(counselingTrendCtx, {
                        type: 'line',
                        data: {
                            labels: last7Days.map(d => {
                                const date = new Date(d.date);
                                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                                const dayName = days[date.getDay()];
                                return (date.getMonth() + 1) + '/' + date.getDate() + ' (' + dayName + ')';
                            }),
                            datasets: [{
                                label: 'ìƒë‹´ ê±´ìˆ˜',
                                data: last7Days.map(d => d.count),
                                borderColor: '#F59E0B',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#F59E0B',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }]
                        },
                        plugins: [{
                            id: 'lineLabels',
                            afterDatasetsDraw(chart) {
                                const { ctx } = chart;
                                const meta = chart.getDatasetMeta(0);
                                meta.data.forEach((point, index) => {
                                    const value = chart.data.datasets[0].data[index];
                                    if (value > 0) {
                                        ctx.save();
                                        ctx.font = 'bold 10px sans-serif';
                                        ctx.fillStyle = '#D97706';
                                        ctx.textAlign = 'center';
                                        ctx.fillText(value + 'ê±´', point.x, point.y - 10);
                                        ctx.restore();
                                    }
                                });
                            }
                        }],
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: { top: 15 }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'ìƒë‹´: ' + context.parsed.y + 'ê±´';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        font: {
                                            size: 10
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: 10
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            }

            // ì§„ë¡œ ê²°ì • í˜„í™© ë„ë„› ì°¨íŠ¸ (íŠ¹ì • ê³¼ì • ì„ íƒ ì‹œ)
            const careerCtx = document.getElementById('careerChart');
            if (careerCtx && !isAllCourses) {
                const careerLabels = ['í•™ì—…', 'ì·¨ì—…', 'ì°½ì—…', 'ë¯¸ì •', 'ê¸°íƒ€'];
                const careerData = [careerStudy, careerEmployed, careerStartup, careerUndecided, careerOther];
                const careerColors = ['#3B82F6', '#10B981', '#F59E0B', '#9CA3AF', '#EC4899'];
                const careerTotal = careerData.reduce((a, b) => a + b, 0);

                new Chart(careerCtx, {
                    type: 'doughnut',
                    data: {
                        labels: careerLabels,
                        datasets: [{
                            data: careerData,
                            backgroundColor: careerColors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    plugins: [{
                        id: 'careerCenterText',
                        afterDraw(chart) {
                            const { ctx, width, height } = chart;
                            ctx.save();
                            ctx.font = 'bold 14px sans-serif';
                            ctx.fillStyle = '#1E3A5F';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText('ì´ ' + careerTotal + 'ëª…', width / 2, height / 2);
                            ctx.restore();
                        }
                    }],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: { size: 10 },
                                    padding: 8,
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const pct = careerTotal > 0 ? ((value / careerTotal) * 100).toFixed(0) : 0;
                                            return {
                                                text: label + ' ' + value + 'ëª…(' + pct + '%)',
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const pct = careerTotal > 0 ? ((value / careerTotal) * 100).toFixed(1) : 0;
                                        return context.label + ': ' + value + 'ëª… (' + pct + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }, 100);

        // ê³¼ì • í•„í„° í•¨ìˆ˜
        window.filterDashboard = function(courseCode) {
            // ì„ íƒëœ ê³¼ì • ì½”ë“œë¥¼ localStorageì— ì €ì¥
            localStorage.setItem('dashboard_selected_course', courseCode);

            window.showLoading();
            setTimeout(() => {
                loadDashboard();
            }, 100);
        };

        // íŒ¨ë„ ì„¤ì • ë“œë¡­ë‹¤ìš´ í† ê¸€
        window.togglePanelSettings = function() {
            const dropdown = document.getElementById('panel-settings-dropdown');
            if (dropdown) dropdown.classList.toggle('hidden');
        };

        // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('panel-settings-dropdown');
            if (!dropdown || dropdown.classList.contains('hidden')) return;
            if (!e.target.closest('#panel-settings-dropdown') && !e.target.closest('[onclick*="togglePanelSettings"]')) {
                dropdown.classList.add('hidden');
            }
        });

        // íŒ¨ë„ í† ê¸€ (ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ)
        window.toggleDashboardPanel = function(panelId) {
            const hidden = JSON.parse(localStorage.getItem('dashboard_hidden_panels') || '[]');
            const idx = hidden.indexOf(panelId);
            if (idx >= 0) {
                hidden.splice(idx, 1);
            } else {
                hidden.push(panelId);
            }
            localStorage.setItem('dashboard_hidden_panels', JSON.stringify(hidden));
            window.applyHiddenPanels();
        };

        // ìˆ¨ê¸´ íŒ¨ë„ ì ìš©
        window.applyHiddenPanels = function() {
            const hidden = JSON.parse(localStorage.getItem('dashboard_hidden_panels') || '[]');
            const allPanels = ['stats', 'charts', 'progress', 'schedule-counseling', 'logs-team', 'service-monitor'];
            allPanels.forEach(id => {
                const el = document.querySelector('[data-panel-id="' + id + '"]');
                if (el) {
                    el.style.display = hidden.includes(id) ? 'none' : '';
                }
            });
            // ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° ìˆ¨ê¸°ë©´ interval ì •ë¦¬
            if (hidden.includes('service-monitor')) {
                if (window._dashboardServiceInterval) {
                    clearInterval(window._dashboardServiceInterval);
                    window._dashboardServiceInterval = null;
                }
            }
        };

        window.hideLoading();
        console.log('âœ… ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ì™„ë£Œ');

        // ===== ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° & ì ‘ì†ì í˜„í™© ì´ˆê¸°í™” =====
        (function initServiceMonitor() {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            if (window._dashboardServiceInterval) {
                clearInterval(window._dashboardServiceInterval);
                window._dashboardServiceInterval = null;
            }

            function renderServices(services) {
                const container = document.getElementById('serviceMonitorList');
                if (!container) return;
                if (!services || services.length === 0) {
                    container.innerHTML = '<div class="text-center py-2 text-slate-400" style="font-size:10px">ì„œë¹„ìŠ¤ ì—†ìŒ</div>';
                    return;
                }
                container.innerHTML = services.map(svc => {
                    const isOnline = svc.status === 'online';
                    const dot = isOnline ? 'bg-emerald-400' : 'bg-red-400';
                    const statusTxt = isOnline
                        ? '<span class="text-emerald-400 font-bold" style="font-size:9px">online</span>'
                        : '<span class="text-red-400 font-bold" style="font-size:9px">stopped</span>';
                    const stopCls = svc.self ? 'opacity-30 cursor-not-allowed' : 'hover:bg-red-500/20 cursor-pointer hover:text-red-400';
                    return '<div class="bg-slate-800/50 rounded px-2 py-1 border border-slate-700/30 flex items-center justify-between gap-1">' +
                        '<div class="flex items-center gap-1.5 flex-1 min-w-0">' +
                            '<span class="w-1.5 h-1.5 rounded-full ' + dot + ' shrink-0 inline-block"></span>' +
                            '<span class="text-white font-semibold truncate" style="font-size:10px">' + svc.name + '</span>' +
                            (svc.self ? '<span class="text-slate-600" style="font-size:8px">(self)</span>' : '') +
                            statusTxt +
                            '<span class="text-slate-500" style="font-size:8px">' + svc.cpu + '%/' + svc.memory + 'MB</span>' +
                            '<span class="text-slate-500" style="font-size:8px">' + svc.uptime + '</span>' +
                        '</div>' +
                        '<div class="flex items-center gap-0.5 shrink-0">' +
                            '<button onclick="window._svcAction(' + svc.pm_id + ', \'restart\')" class="w-5 h-5 rounded bg-slate-700/50 hover:bg-blue-500/20 text-slate-400 hover:text-blue-400 transition flex items-center justify-center" title="ì¬ì‹œì‘"><i class="fas fa-redo" style="font-size:8px"></i></button>' +
                            '<button onclick="' + (svc.self ? '' : 'window._svcAction(' + svc.pm_id + ', \'stop\')') + '" class="w-5 h-5 rounded bg-slate-700/50 ' + stopCls + ' text-slate-400 transition flex items-center justify-center" title="' + (svc.self ? 'ë°±ì—”ë“œ ì •ì§€ ë¶ˆê°€' : 'ì •ì§€') + '" ' + (svc.self ? 'disabled' : '') + '><i class="fas fa-stop" style="font-size:8px"></i></button>' +
                        '</div>' +
                    '</div>';
                }).join('');
            }

            function renderConnections(data) {
                const total = document.getElementById('connTotal');
                const p8000 = document.getElementById('connPort8000');
                const p3000 = document.getElementById('connPort3000');
                if (total) total.textContent = data.total;
                if (p8000) p8000.textContent = data.port_8000;
                if (p3000) p3000.textContent = data.port_3000;
            }

            function setGauge(id, percent, color) {
                const el = document.getElementById(id);
                if (!el) return;
                const clamped = Math.min(100, Math.max(0, percent));
                el.setAttribute('stroke-dasharray', clamped + ', 100');
                // ìƒ‰ìƒ ë³€í™”: 80% ì´ìƒ ë¹¨ê°•, 60% ì´ìƒ ì£¼í™©
                if (clamped >= 80) el.setAttribute('stroke', '#ef4444');
                else if (clamped >= 60) el.setAttribute('stroke', '#f59e0b');
                else el.setAttribute('stroke', color);
            }

            function renderResources(data) {
                const cpu = data.cpu, ram = data.ram, disk = data.disk;
                // CPU gauge
                const cpuEl = document.getElementById('cpuPercent');
                if (cpuEl) cpuEl.textContent = cpu.percent + '%';
                setGauge('cpuGauge', cpu.percent, '#3b82f6');
                const loadEl = document.getElementById('cpuLoadAvg');
                if (loadEl && data.load_avg) loadEl.textContent = data.load_avg[0];
                // RAM gauge
                const ramEl = document.getElementById('ramPercent');
                if (ramEl) ramEl.textContent = ram.percent + '%';
                setGauge('ramGauge', ram.percent, '#10b981');
                const ramDet = document.getElementById('ramDetail');
                if (ramDet) {
                    const usedGB = (ram.used / 1024).toFixed(1);
                    const totalGB = (ram.total / 1024).toFixed(1);
                    ramDet.textContent = usedGB + '/' + totalGB + 'G';
                }
                // Disk gauge
                const diskEl = document.getElementById('diskPercent');
                if (diskEl) diskEl.textContent = disk.percent + '%';
                setGauge('diskGauge', disk.percent, '#f59e0b');
                const diskDet = document.getElementById('diskDetail');
                if (diskDet) diskDet.textContent = disk.used + '/' + disk.total + 'G';
                // Bottom status bar
                const loadDisp = document.getElementById('loadAvgDisplay');
                if (loadDisp && data.load_avg) loadDisp.textContent = data.load_avg.join(' / ');
                const ramTxt = document.getElementById('ramUsageText');
                if (ramTxt) ramTxt.textContent = (ram.used/1024).toFixed(1) + '/' + (ram.total/1024).toFixed(1) + 'GB';
                const diskTxt = document.getElementById('diskUsageText');
                if (diskTxt) diskTxt.textContent = disk.used + '/' + disk.total + 'GB';
            }

            async function fetchServiceData() {
                try {
                    const [svcRes, connRes, resRes] = await Promise.all([
                        axios.get(API_BASE_URL + '/api/server/services'),
                        axios.get(API_BASE_URL + '/api/server/connections'),
                        axios.get(API_BASE_URL + '/api/server/resources')
                    ]);
                    if (svcRes.data.success) renderServices(svcRes.data.services);
                    if (connRes.data.success) renderConnections(connRes.data);
                    if (resRes.data.success) renderResources(resRes.data);
                    const ts = document.getElementById('serviceMonitorLastUpdate');
                    if (ts) ts.textContent = new Date().toLocaleTimeString('ko-KR');
                } catch (err) {
                    console.error('ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
                }
            }

            window._svcAction = async function(pmId, action) {
                if (action === 'stop' && !confirm('ì´ ì„œë¹„ìŠ¤ë¥¼ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                if (action === 'restart' && !confirm('ì´ ì„œë¹„ìŠ¤ë¥¼ ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                try {
                    await axios.post(API_BASE_URL + '/api/server/services/' + pmId + '/' + action);
                    setTimeout(fetchServiceData, 1500);
                } catch (err) {
                    alert(err.response?.data?.detail || 'ì„œë¹„ìŠ¤ ì œì–´ ì‹¤íŒ¨');
                }
            };

            window._refreshServiceMonitor = fetchServiceData;

            // ì´ˆê¸° ë¡œë“œ + 5ì´ˆ ê°„ê²© ê°±ì‹ 
            fetchServiceData();
            window._dashboardServiceInterval = setInterval(fetchServiceData, 5000);
        })();
        // ===== ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° ë =====

        // BGM ì„¤ì • ë³µì›
        window.restoreBGMSettings();

        // ìˆ¨ê¸´ íŒ¨ë„ ì ìš©
        window.applyHiddenPanels();
    } catch (error) {
        window.hideLoading();
        console.error('âŒ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        console.error('ì—ëŸ¬ ìƒì„¸:', {
            message: error.message,
            stack: error.stack,
            response: error.response
        });
        
        // ìºì‹œ ì‚­ì œ í›„ ì¬ì‹œë„ ë²„íŠ¼ ì œê³µ
        document.getElementById('app').innerHTML = `
            <div class="p-6">
                <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-2xl mx-auto">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-3xl mr-3"></i>
                        <h3 class="text-xl font-bold text-red-800">ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</h3>
                    </div>
                    <p class="text-red-700 mb-4">
                        ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
                    </p>
                    <div class="space-x-2">
                        <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-sync mr-2"></i>ìƒˆë¡œê³ ì¹¨
                        </button>
                        <button onclick="window.clearCache(); location.reload();" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-trash mr-2"></i>ìºì‹œ ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
}

// ==================== í”Œë¡œíŒ… ì±—ë´‡ ê¸°ëŠ¥ ====================
window.toggleChatbot = function() {
    const widget = document.getElementById('chatbot-widget');
    const btn = document.getElementById('chatbot-toggle-btn');
    
    if (widget.style.display === 'none' || widget.style.display === '') {
        // ì±—ë´‡ ì—´ê¸°
        widget.style.display = 'flex';
        btn.style.transform = 'scale(0.9)';
        
        // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
        setTimeout(() => {
            document.getElementById('chatbot-input').focus();
        }, 100);
    } else {
        // ì±—ë´‡ ë‹«ê¸°
        widget.style.display = 'none';
        btn.style.transform = 'scale(1)';
    }
};

window.sendChatMessage = async function() {
    const input = document.getElementById('chatbot-input');
    const message = input.value.trim();
    const ragToggle = document.getElementById('rag-mode-toggle');
    const useRAG = ragToggle ? ragToggle.checked : false;
    
    if (!message) return;
    
    // ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    const documentContext = sessionStorage.getItem('chatbot-document-context');
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    appendChatMessage(message, 'user', useRAG);
    input.value = '';
    
    // ë¡œë”© í‘œì‹œ
    const loadingId = appendChatMessage('...', 'bot', false, true);
    
    try {
        if (useRAG) {
            // RAG ëª¨ë“œ: ë¬¸ì„œ ê¸°ë°˜ ë‹µë³€
            console.log('RAG ëª¨ë“œë¡œ ì§ˆë¬¸:', message);
            if (documentContext) {
                console.log('ğŸ“„ ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸:', documentContext);
            }
            
            const groqApiKey = localStorage.getItem('groq_api_key') || '';
            const ragTopK = parseInt(localStorage.getItem('rag_top_k') || '10');  // ê¸°ë³¸ê°’ 3â†’10
            
            const requestBody = {
                message: message,
                k: ragTopK
            };
            
            // ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì¶”ê°€
            if (documentContext) {
                requestBody.document_context = documentContext;
            }
            
            const response = await axios.post(`${API_BASE_URL}/api/rag/chat`, requestBody, {
                headers: {
                    'X-GROQ-API-Key': groqApiKey
                }
            });
            
            console.log('RAG ì‘ë‹µ:', response.data);
            
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            document.getElementById(loadingId).remove();
            
            // RAG ì‘ë‹µ ì¶”ê°€ (ì¶œì²˜ í¬í•¨)
            appendChatMessage(response.data.answer, 'bot', false, false, response.data.sources);
            
        } else {
            // ì¼ë°˜ ì±—ë´‡ ëª¨ë“œ
            const selectedModel = localStorage.getItem('ai_model') || 'groq';
            
            let currentCharacter = 'ì˜ˆì§„ì´';
            if (window.currentCharacterName) {
                currentCharacter = window.currentCharacterName;
            }
            
            const groqApiKey = localStorage.getItem('groq_api_key') || '';
            const geminiApiKey = localStorage.getItem('gemini_api_key') || '';
            
            console.log('í”Œë¡œíŒ… ì±—ë´‡ API í˜¸ì¶œ:', { 
                message, 
                character: currentCharacter, 
                model: selectedModel
            });
            
            const response = await axios.post(`${API_BASE_URL}/api/aesong-chat`, {
                message: message,
                character: currentCharacter,
                model: selectedModel
            }, {
                headers: {
                    'X-GROQ-API-Key': groqApiKey,
                    'X-Gemini-API-Key': geminiApiKey
                }
            });
            
            console.log('í”Œë¡œíŒ… ì±—ë´‡ API ì‘ë‹µ:', response.data);
            
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            document.getElementById(loadingId).remove();
            
            if (response.data.model === 'error') {
                const translatedError = translateApiError(response.data.error);
                appendChatMessage(`ì£„ì†¡í•©ë‹ˆë‹¤. AI ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${translatedError}`, 'bot');
            } else {
                appendChatMessage(response.data.response, 'bot');
            }
        }
        
    } catch (error) {
        console.error('ì±—ë´‡ ì˜¤ë¥˜:', error);
        document.getElementById(loadingId).remove();
        
        const translatedError = translateApiError(error.message || error.toString());
        appendChatMessage(`ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${translatedError}`, 'bot');
    }
};

function appendChatMessage(message, type, isRAG = false, isLoading = false, sources = null) {
    const messagesContainer = document.getElementById('chatbot-messages');
    const messageId = 'msg-' + Date.now();
    
    if (type === 'user') {
        // ì‚¬ìš©ì ë©”ì‹œì§€ (RAG í‘œì‹œ í¬í•¨)
        const ragBadge = isRAG ? '<span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px;">ğŸ“š ì§€ì‹ê²€ìƒ‰</span>' : '';
        const messageHTML = `
            <div class="chatbot-message user-message" style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: flex-end;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 80%;">
                    <div style="font-size: 14px; white-space: pre-wrap;">${message}${ragBadge}</div>
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
    } else {
        // ë´‡ ë©”ì‹œì§€ í¬ë§·íŒ…
        let formattedMessage = message;
        
        // ê°ê´€ì‹ ë¬¸ì œ í¬ë§·íŒ… (ì¤„ë°”ê¿ˆë§Œ ì ìš©, ì—¬ë°± ìµœì†Œí™”)
        formattedMessage = formattedMessage.replace(/([A-D]\)\s+[^\n]+)/g, '<span style="display: block; margin-left: 20px;">$1</span>');
        formattedMessage = formattedMessage.replace(/(ì •ë‹µ:\s*\n*[^\n]+)/g, '<strong style="color: #10b981; display: block; margin-top: 8px;">$1</strong>');
        formattedMessage = formattedMessage.replace(/(ì„¤ëª…:|í•´ì„¤:)([^\n]+)/g, '<em style="color: #6b7280; display: block; margin-bottom: 10px;">$1$2</em>');
        
        // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
        formattedMessage = formattedMessage.replace(/\n/g, '<br>');
        
        const loadingAnimation = isLoading ? 'style="animation: pulse 1.5s ease-in-out infinite;"' : '';
        
        // ì¶œì²˜ ì •ë³´ HTML ìƒì„±
        let sourcesHTML = '';
        if (sources && sources.length > 0) {
            sourcesHTML = `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                    <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 5px;">
                        <i class="fas fa-book" style="margin-right: 4px;"></i>ì°¸ê³  ë¬¸ì„œ
                    </div>
                    ${sources.map((src, idx) => `
                        <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">
                            ${idx + 1}. ${src.source || 'ì•Œ ìˆ˜ ì—†ìŒ'} 
                            <span style="color: #9ca3af;">(ìœ ì‚¬ë„: ${(src.similarity).toFixed(1)}%)</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        const messageHTML = `
            <div id="${messageId}" class="chatbot-message bot-message" style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">
                    ğŸ¶
                </div>
                <div ${loadingAnimation} style="background: white; padding: 12px 16px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 80%; line-height: 1.6;">
                    <div style="font-size: 14px; color: #374151;">${formattedMessage}</div>
                    ${sourcesHTML}
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
    }
    
    // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    console.log('=== KDT êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ ì´ˆê¸°í™” ===');
    
    // ë¡œê·¸ì¸ ì²´í¬ (í•„ìˆ˜)
    if (!checkLogin()) {
        console.log('âŒ ë¡œê·¸ì¸ ì²´í¬ ì‹¤íŒ¨ - ì•± ë¡œë“œ ì¤‘ë‹¨');
        return; // ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ì—¬ê¸°ì„œ ì™„ì „íˆ ì¤‘ë‹¨
    }
    
    console.log('âœ… ë¡œê·¸ì¸ í™•ì¸ ì™„ë£Œ - ì•± ë¡œë“œ ì‹œì‘');

    // ë²„ì „ ë°°ì§€ ì—…ë°ì´íŠ¸ (í´ë¦­í•˜ë©´ README í‘œì‹œ)
    const versionBadge = document.getElementById('version-badge');
    if (versionBadge) {
        versionBadge.textContent = 'v' + APP_VERSION;
        versionBadge.style.cursor = 'pointer';
        versionBadge.title = 'í´ë¦­í•˜ì—¬ ë²„ì „ ì •ë³´ ë³´ê¸°';
        versionBadge.onclick = showReadmeModal;
    }

    // ì‹œê³„ ì‹œì‘ (ë‚ ì§œ/ì‹œê°„ ë° ì¹´ìš´íŠ¸ë‹¤ìš´)
    startClock();
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ tab ê°’ ì½ê¸° (ì´ˆê¸° í™”ë©´ ì„¤ì •)
    const urlParams = new URLSearchParams(window.location.search);
    const initialTab = urlParams.get('tab') || 'dashboard';
    
    // ë¡œê·¸ì¸ ë˜ì–´ ìˆìœ¼ë©´ ì´ˆê¸° íƒ­ í‘œì‹œ
    showTab(initialTab);
    
    // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
    window.addEventListener('popstate', (event) => {
        // ë¡œê·¸ì¸ ì²´í¬ (ë’¤ë¡œê°€ê¸° ì‹œì—ë„)
        if (!checkLogin()) {
            return;
        }
        
        if (event.state && event.state.tab) {
            // íˆìŠ¤í† ë¦¬ì— ì €ì¥ëœ íƒ­ìœ¼ë¡œ ì´ë™ (íˆìŠ¤í† ë¦¬ ì¶”ê°€ ì•ˆ í•¨)
            showTab(event.state.tab, false);
        } else {
            // íˆìŠ¤í† ë¦¬ê°€ ì—†ìœ¼ë©´ ëŒ€ì‹œë³´ë“œë¡œ
            showTab('dashboard', false);
        }
    });
    
    // ì´ˆê¸° íˆìŠ¤í† ë¦¬ ìƒíƒœ ì„¤ì •
    history.replaceState({ tab: initialTab }, '', '');
    
    console.log('âœ… ì•± ì´ˆê¸°í™” ì™„ë£Œ');
});

// íƒ­ ì „í™˜
window.showTab = function(tab, addToHistory = true) {
    // íƒ­ ì „í™˜ (ë¡œê·¸ ì œê±°)
    currentTab = tab;
    
    // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€ (ë’¤ë¡œê°€ê¸° ì§€ì›)
    if (addToHistory && history.state?.tab !== tab) {
        history.pushState({ tab: tab }, '', '');
    }
    
    // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const isActive = btn.getAttribute('data-tab') === tab;
        if (isActive) {
            btn.className = 'tab-btn px-4 py-3 text-sm font-semibold text-blue-600 bg-blue-50 border-b-2 border-blue-600 rounded';
        } else {
            btn.className = 'tab-btn px-4 py-3 text-sm font-semibold text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded';
        }
    });
    
    // í•´ë‹¹ íƒ­ ì½˜í…ì¸  ë¡œë“œ
    switch(tab) {
        case 'dashboard':
            // ëŒ€ì‹œë³´ë“œëŠ” í•­ìƒ ìµœì‹  ë°ì´í„° ë¡œë“œ (ìºì‹œ ë¬´íš¨í™”)
            localStorage.removeItem('cache_students');
            localStorage.removeItem('cache_instructors');
            localStorage.removeItem('cache_courses');
            localStorage.removeItem('cache_counselings');
            localStorage.removeItem('cache_timetables');
            localStorage.removeItem('cache_projects');
            localStorage.removeItem('cache_training-logs');
            localStorage.removeItem('cache_team-activity-logs');
            loadDashboard();
            
            // ëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘ (5ë¶„ë§ˆë‹¤)
            startDashboardAutoRefresh();
            // í™œë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (í´ë¦­, í‚¤ë³´ë“œ, ë§ˆìš°ìŠ¤)
            setupDashboardActivityListeners();
            break;
        case 'instructor-codes':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadInstructorCodes();
            break;
        case 'instructors':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadInstructors();
            break;
        case 'subjects':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadSubjects();
            break;
        case 'holidays':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadHolidays();
            break;
        case 'courses':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadCourses();
            break;
        case 'students':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadStudents();
            break;
        case 'class-notes':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadClassNotes();
            break;
        case 'counselings':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadCounselings();
            break;
        case 'projects':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadProjects();
            break;
        case 'team-activity-logs':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadTeamActivityLogs();
            break;
        case 'timetables':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadTimetables();
            break;
        case 'training-logs':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadTrainingLogs();
            break;
        case 'ai-report':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            renderAIReport();
            break;
        case 'ai-timetable':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadAITimetable();
            break;
        case 'ai-training-log':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadAITrainingLog();
            break;
        case 'ai-counseling':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadAICounseling();
            break;
        case 'aesong-3d-chat':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            renderAesong3DChat();
            break;
        case 'system-settings':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadSystemSettings();
            break;
        case 'notices':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadNotices();
            break;
        case 'rag-documents':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            renderRAGDocuments();
            break;
        case 'exam-bank':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            showExamBank();
            break;
        case 'online-exam':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            showOnlineExam();
            break;
        case 'quick-quiz':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            showQuickQuiz();
            break;
        case 'assignments':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            showAssignments();
            break;
        case 'backup-manager':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadBackupManager();
            break;
        case 'system-check':
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            loadSystemCheck();
            break;
        default:
            // ëŒ€ì‹œë³´ë“œê°€ ì•„ë‹Œ ëª¨ë“  íƒ­ì—ì„œëŠ” ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
            stopDashboardAutoRefresh();
            removeDashboardActivityListeners();
            break;
    }
}

// ==================== í•™ìƒ ê´€ë¦¬ ====================
async function loadStudents() {
    try {
        window.showLoading('í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        console.log('Loading students...');
        const [studentsData, coursesData] = await Promise.all([
            window.getCachedData('students', () => axios.get(`${API_BASE_URL}/api/students`).then(r => r.data)),
            window.getCachedData('courses', () => axios.get(`${API_BASE_URL}/api/courses`).then(r => r.data))
        ]);
        students = studentsData;
        courses = coursesData;
        console.log('Students loaded:', students.length);
        renderStudents();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
    }
}

// í•™ìƒ ê²€ìƒ‰ ë””ë°”ìš´ìŠ¤ (íƒ€ì´í•‘ ì™„ë£Œ í›„ 300ms í›„ ê²€ìƒ‰)
let studentSearchTimer = null;
window.debounceStudentSearch = function() {
    if (studentSearchTimer) clearTimeout(studentSearchTimer);
    studentSearchTimer = setTimeout(() => {
        renderStudents();
    }, 300);
};

function renderStudents() {
    // í˜„ì¬ í•„í„° ìƒíƒœ ì €ì¥
    const previousCourseFilter = document.getElementById('student-course-filter')?.value || '';
    const previousSort = document.getElementById('student-sort')?.value || 'name';
    const previousSearch = document.getElementById('student-search')?.value || '';
    
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-user-graduate mr-2"></i>í•™ìƒ ëª©ë¡ (ì´ ${students.length}ëª…)
                </h2>
                <div class="space-x-2">
                    <button onclick="window.showStudentRegistrations()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-user-plus mr-2"></i>ì‹ ê·œê°€ì…ì ì²˜ë¦¬
                    </button>
                    <button onclick="window.showStudentForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>í•™ìƒ ì¶”ê°€
                    </button>
                    <button onclick="window.downloadTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-download mr-2"></i>Excel í…œí”Œë¦¿
                    </button>
                    <button onclick="window.showExportOptions()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-export mr-2"></i>Excel ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button onclick="window.showExcelUpload()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-excel mr-2"></i>Excel ì—…ë¡œë“œ
                    </button>
                </div>
            </div>
            
            <!-- í•„í„° ì˜ì—­ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 mb-2">ê³¼ì • í•„í„°</label>
                    <select id="student-course-filter" class="w-full border rounded px-3 py-2" onchange="window.renderStudents()">
                        <option value="">-- ì „ì²´ ê³¼ì • --</option>
                        ${courses.sort((a, b) => (a.name || a.code).localeCompare(b.name || b.code, 'ko')).map(c => `
                            <option value="${c.code}" ${previousCourseFilter === c.code ? 'selected' : ''}>${c.name || c.code}</option>
                        `).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê²€ìƒ‰ (ì´ë¦„, í•™ìƒì½”ë“œ)</label>
                    <input type="text" id="student-search" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." value="${previousSearch}" class="w-full border rounded px-3 py-2" oninput="window.debounceStudentSearch()">
                </div>
            </div>
            
            <div id="student-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg"></div>
            <div id="excel-upload" class="hidden mb-6 p-4 bg-purple-50 rounded-lg"></div>
            
            <div id="student-list-container" class="overflow-x-auto">
                ${(() => {
                    // í•„í„°ì™€ ì •ë ¬ ì ìš©
                    let filteredStudents = [...students];

                    // ê³¼ì • í•„í„°
                    const courseFilter = document.getElementById('student-course-filter')?.value;
                    if (courseFilter) {
                        filteredStudents = filteredStudents.filter(s => s.course_code === courseFilter);
                    }

                    // ê²€ìƒ‰ í•„í„°
                    const searchText = document.getElementById('student-search')?.value.toLowerCase();
                    if (searchText) {
                        filteredStudents = filteredStudents.filter(s =>
                            (s.name && s.name.toLowerCase().includes(searchText)) ||
                            (s.code && s.code.toLowerCase().includes(searchText))
                        );
                    }

                    // í—¤ë” ì •ë ¬ ì ìš©
                    filteredStudents = genericSort(filteredStudents, studentSortKey, studentSortAsc);

                    // í•™ìƒ í–‰ ë Œë”ë§ í•¨ìˆ˜
                    const renderStudentRow = (student, rowNum) => {
                        const shortInterest = student.interest_area || student.interests
                            ? ((student.interest_area || student.interests).length > 30
                                ? (student.interest_area || student.interests).substring(0, 30) + '...'
                                : (student.interest_area || student.interests))
                            : '-';

                        const educationText = student.education || student.final_school || '-';
                        const shortEducation = educationText.length > 15
                            ? educationText.substring(0, 15) + '...'
                            : educationText;

                        let shortGender = '-';
                        if (student.gender) {
                            if (student.gender.includes('ë‚¨') || student.gender === 'M' || student.gender === 'male') {
                                shortGender = 'ë‚¨';
                            } else if (student.gender.includes('ì—¬') || student.gender === 'F' || student.gender === 'female') {
                                shortGender = 'ì—¬';
                            } else {
                                shortGender = student.gender;
                            }
                        }

                        const formattedPhone = normalizePhone(student.phone) || '-';

                        return `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-2 py-2 text-center text-gray-500 text-sm font-medium">${rowNum}</td>
                                <td class="px-2 py-2 text-center">
                                    ${student.profile_photo ? `
                                        <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(student.profile_photo)}"
                                             alt="${student.name}"
                                             class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-300"
                                             onerror="this.src='${getDefaultAvatarUrl(student.gender, student.name)}'">
                                    ` : `
                                        <img src="${getDefaultAvatarUrl(student.gender, student.name)}"
                                             alt="${student.name}"
                                             class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-300">
                                    `}
                                </td>
                                <td class="px-4 py-2 font-mono">${student.code}</td>
                                <td class="px-4 py-2 font-semibold">${student.name}</td>
                                <td class="px-3 py-2">${student.birth_date ? formatDateWithDay(student.birth_date) : '-'}</td>
                                <td class="px-2 py-2 text-center">${shortGender}</td>
                                <td class="px-3 py-2 text-sm">${formattedPhone}</td>
                                <td class="px-2 py-2 text-sm" title="${educationText}">${shortEducation}</td>
                                <td class="px-4 py-2 text-sm text-gray-600">${shortInterest}</td>
                                <td class="px-2 py-2 whitespace-nowrap">
                                    <button onclick="window.viewStudent(${student.id})" class="text-blue-600 hover:text-blue-800 mr-1" title="ìƒì„¸ë³´ê¸°">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="window.editStudent(${student.id})" class="text-green-600 hover:text-green-800 mr-1" title="ìˆ˜ì •">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.deleteStudent(${student.id})" class="text-red-600 hover:text-red-800" title="ì‚­ì œ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    };

                    // í…Œì´ë¸” í—¤ë”
                    const tableHeader = `
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-2 text-center w-10">No</th>
                                <th class="px-2 py-2 text-center w-12">ì‚¬ì§„</th>
                                ${sortableHeader([
                                    { key: 'code', label: 'í•™ìƒì½”ë“œ' },
                                    { key: 'name', label: 'ì´ë¦„' },
                                    { key: 'birth_date', label: 'ìƒë…„ì›”ì¼' },
                                    { key: 'gender', label: 'ì„±ë³„' },
                                    { key: 'phone', label: 'ì—°ë½ì²˜' },
                                    { key: 'final_school', label: 'í•™ë ¥ì‚¬í•­' },
                                    { key: 'interest_area', label: 'ê´€ì‹¬ë¶„ì•¼' }
                                ], studentSortKey, studentSortAsc, 'window.sortStudentTable', 'px-4 py-2 text-left')}
                                <th class="px-4 py-2 text-left">ì‘ì—…</th>
                            </tr>
                        </thead>
                    `;

                    // ì „ì²´ ê³¼ì •ì¼ ë•Œ ê³¼ì •ë³„ë¡œ ê·¸ë£¹í™”
                    if (!courseFilter) {
                        // ê³¼ì •ë³„ë¡œ ê·¸ë£¹í™”
                        const groupedByCourse = {};
                        filteredStudents.forEach(s => {
                            const courseCode = s.course_code || 'ë¯¸ì§€ì •';
                            if (!groupedByCourse[courseCode]) {
                                groupedByCourse[courseCode] = [];
                            }
                            groupedByCourse[courseCode].push(s);
                        });

                        // ê³¼ì • ì½”ë“œ ì •ë ¬
                        const sortedCourses = Object.keys(groupedByCourse).sort();

                        let html = '';
                        sortedCourses.forEach(courseCode => {
                            const courseStudents = groupedByCourse[courseCode];
                            const courseName = courses.find(c => c.code === courseCode)?.name || courseCode;

                            html += `
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold text-gray-700 mb-2 bg-blue-50 p-3 rounded-lg">
                                        <i class="fas fa-folder-open mr-2 text-blue-600"></i>
                                        ${courseName}
                                        <span class="text-sm font-normal text-gray-500 ml-2">(${courseStudents.length}ëª…)</span>
                                    </h3>
                                    <table class="min-w-full bg-white border">
                                        ${tableHeader}
                                        <tbody>
                                            ${courseStudents.map((s, idx) => renderStudentRow(s, idx + 1)).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        });

                        return html || '<p class="text-gray-500 text-center py-8">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                        // ë‹¨ì¼ ê³¼ì • ì„ íƒ ì‹œ ê¸°ì¡´ ë°©ì‹ (ë„˜ë²„ë§ í¬í•¨)
                        return `
                            <table class="min-w-full bg-white">
                                ${tableHeader}
                                <tbody>
                                    ${filteredStudents.map((s, idx) => renderStudentRow(s, idx + 1)).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                })()}
            </div>
        </div>
    `;
}

window.downloadTemplate = async function() {
    window.open(`${API_BASE_URL}/api/template/students`, '_blank');
}

// Excel ë‚´ë³´ë‚´ê¸° ì˜µì…˜ ëª¨ë‹¬ í‘œì‹œ
window.showExportOptions = function() {
    const courseOptions = courses.map(c =>
        `<option value="${c.code}">${c.name}</option>`
    ).join('');

    window.showModal('Excel ë‚´ë³´ë‚´ê¸°', `
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2 font-medium">ë‚´ë³´ë‚¼ ê³¼ì • ì„ íƒ</label>
                <select id="export-course-select" class="w-full border rounded px-3 py-2">
                    <option value="">ì „ì²´ ê³¼ì •</option>
                    ${courseOptions}
                </select>
            </div>
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                ì„ íƒí•œ ê³¼ì •ì˜ í•™ìƒ ëª…ë‹¨ì„ Excel íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
            </p>
            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="window.closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                    ì·¨ì†Œ
                </button>
                <button onclick="window.exportStudentsToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i>ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </div>
    `);
}

// í•™ìƒ ëª©ë¡ Excel ë‚´ë³´ë‚´ê¸°
window.exportStudentsToExcel = async function() {
    const courseCode = document.getElementById('export-course-select')?.value;

    // ë‚´ë³´ë‚¼ í•™ìƒ í•„í„°ë§
    let exportStudents = [...students];
    let fileName = 'í•™ìƒëª…ë‹¨_ì „ì²´';

    if (courseCode) {
        exportStudents = students.filter(s => s.course_code === courseCode);
        const courseName = courses.find(c => c.code === courseCode)?.name || courseCode;
        fileName = `í•™ìƒëª…ë‹¨_${courseName}`;
    }

    if (exportStudents.length === 0) {
        window.showAlert('ë‚´ë³´ë‚¼ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    // ì´ë¦„ìˆœ ì •ë ¬
    exportStudents.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));

    // Excel ë°ì´í„° ìƒì„±
    const excelData = exportStudents.map((s, idx) => ({
        'No': idx + 1,
        'í•™ìƒì½”ë“œ': s.code || '',
        'ì´ë¦„': s.name || '',
        'ìƒë…„ì›”ì¼': s.birth_date || '',
        'ì„±ë³„': s.gender || '',
        'ì—°ë½ì²˜': s.phone || '',
        'ì´ë©”ì¼': s.email || '',
        'ê³¼ì •ì½”ë“œ': s.course_code || '',
        'ê³¼ì •ëª…': courses.find(c => c.code === s.course_code)?.name || '',
        'í•™ë ¥': s.education || s.final_school || '',
        'ì „ê³µ': s.major || '',
        'ê´€ì‹¬ë¶„ì•¼': s.interest_area || s.interests || '',
        'í¬ë§ì§€ì—­': s.campus || '',
        'ì£¼ì†Œ': s.address || '',
        'ë¹„ê³ ': s.note || ''
    }));

    // SheetJSë¡œ Excel ìƒì„±
    const ws = XLSX.utils.json_to_sheet(excelData);

    // ì—´ ë„ˆë¹„ ì„¤ì •
    ws['!cols'] = [
        { wch: 5 },   // No
        { wch: 12 },  // í•™ìƒì½”ë“œ
        { wch: 10 },  // ì´ë¦„
        { wch: 12 },  // ìƒë…„ì›”ì¼
        { wch: 6 },   // ì„±ë³„
        { wch: 15 },  // ì—°ë½ì²˜
        { wch: 25 },  // ì´ë©”ì¼
        { wch: 10 },  // ê³¼ì •ì½”ë“œ
        { wch: 30 },  // ê³¼ì •ëª…
        { wch: 20 },  // í•™ë ¥
        { wch: 15 },  // ì „ê³µ
        { wch: 25 },  // ê´€ì‹¬ë¶„ì•¼
        { wch: 10 },  // í¬ë§ì§€ì—­
        { wch: 40 },  // ì£¼ì†Œ
        { wch: 20 }   // ë¹„ê³ 
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'í•™ìƒëª…ë‹¨');

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(wb, `${fileName}_${today}.xlsx`);

    window.closeModal();
    window.showAlert(`${exportStudents.length}ëª…ì˜ í•™ìƒ ëª…ë‹¨ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
}

window.showExcelUpload = function() {
    const div = document.getElementById('excel-upload');
    div.innerHTML = `
        <h3 class="text-lg font-bold mb-4">Excel íŒŒì¼ ì¼ê´„ ì—…ë¡œë“œ</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2">Excel íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="excel-file" accept=".xlsx,.xls" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="space-x-2">
                <button onclick="window.uploadExcel()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-upload mr-2"></i>ì—…ë¡œë“œ
                </button>
                <button onclick="window.hideExcelUpload()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    `;
    div.classList.remove('hidden');
}

window.hideExcelUpload = function() {
    document.getElementById('excel-upload').classList.add('hidden');
}

window.uploadExcel = async function() {
    const fileInput = document.getElementById('excel-file');
    if (!fileInput.files[0]) {
        window.showAlert('âš ï¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    try {
        const response = await axios.post(`${API_BASE_URL}/api/students/upload-excel`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' }
        });
        
        window.showAlert('âœ… ' + response.data.message, 'success');
        if (response.data.duplicate_count > 0) {
            console.log('ì¤‘ë³µ í•™ìƒ:', response.data.duplicate_list);
        }
        window.hideExcelUpload();
        loadStudents();
    } catch (error) {
        console.error('Excel ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ Excel íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ==================== ì‹ ê·œê°€ì…ì ì²˜ë¦¬ ====================
window.showStudentRegistrations = async function() {
    const app = document.getElementById('app');

    try {
        window.showLoading('ì‹ ê·œê°€ì… ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

        const [registrationsRes, coursesRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/student-registrations`),
            axios.get(`${API_BASE_URL}/api/courses`)
        ]);

        const registrations = registrationsRes.data;
        const coursesData = coursesRes.data;
        courses = coursesData;

        // ê³¼ì • ì½”ë“œ -> ì´ë¦„ ë§¤í•‘
        const courseMap = {};
        coursesData.forEach(c => courseMap[c.code] = c.name);

        window.hideLoading();

        app.innerHTML = `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-user-plus mr-2 text-orange-500"></i>ì‹ ê·œê°€ì…ì ì²˜ë¦¬
                    </h2>
                    <div class="space-x-2">
                        <button onclick="loadStudents()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-arrow-left mr-2"></i>í•™ìƒ ëª©ë¡ìœ¼ë¡œ
                        </button>
                    </div>
                </div>

                <!-- í•„í„° -->
                <div class="mb-4">
                    <select id="reg-status-filter" onchange="window.filterRegistrations()" class="border rounded px-3 py-2">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="pending" selected>ëŒ€ê¸°ì¤‘</option>
                        <option value="approved">ìŠ¹ì¸ë¨</option>
                        <option value="rejected">ê±°ì ˆë¨</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white" id="registrations-table">
                        <thead class="bg-orange-50">
                            <tr>
                                <th class="px-4 py-2 text-center">ì‚¬ì§„</th>
                                <th class="px-4 py-2 text-left">ì‹ ì²­ì¼ì‹œ</th>
                                <th class="px-4 py-2 text-left">ì´ë¦„</th>
                                <th class="px-4 py-2 text-left">ì‹ ì²­ ê³¼ì •</th>
                                <th class="px-4 py-2 text-left">ì—°ë½ì²˜</th>
                                <th class="px-4 py-2 text-left">ì´ë©”ì¼</th>
                                <th class="px-4 py-2 text-left">ìƒíƒœ</th>
                                <th class="px-4 py-2 text-center">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="registrations-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        // ì „ì—­ì— ì €ì¥
        window._registrations = registrations;
        window._courseMap = courseMap;

        // í…Œì´ë¸” ë Œë”ë§
        window.filterRegistrations();

    } catch (error) {
        window.hideLoading();
        console.error('ì‹ ê·œê°€ì… ì‹ ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
        app.innerHTML = `<div class="text-red-600 p-4">ì‹ ê·œê°€ì… ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
    }
};

window.filterRegistrations = function() {
    const statusFilter = document.getElementById('reg-status-filter')?.value || 'pending';
    const registrations = window._registrations || [];
    const courseMap = window._courseMap || {};

    let filtered = registrations;
    if (statusFilter) {
        filtered = registrations.filter(r => r.status === statusFilter);
    }

    const tbody = document.getElementById('registrations-tbody');
    if (!tbody) return;

    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
    }

    tbody.innerHTML = filtered.map(reg => {
        const statusBadge = {
            'pending': '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm">ëŒ€ê¸°ì¤‘</span>',
            'approved': '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">ìŠ¹ì¸ë¨</span>',
            'rejected': '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">ê±°ì ˆë¨</span>'
        };

        const createdAt = reg.created_at ? new Date(reg.created_at).toLocaleString('ko-KR') : '-';
        const courseName = courseMap[reg.course_code] || reg.course_code || '-';

        // í”„ë¡œí•„ ì‚¬ì§„ í‘œì‹œ
        const profilePhoto = reg.profile_photo
            ? `<img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(reg.profile_photo)}" alt="í”„ë¡œí•„" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200" onerror="this.src='${getDefaultAvatarUrl(reg.gender, reg.name)}'">`
            : `<img src="${getDefaultAvatarUrl(reg.gender, reg.name)}" alt="í”„ë¡œí•„" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">`;

        const actionButtons = reg.status === 'pending' ? `
            <button onclick="window.viewRegistrationDetail(${reg.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm mr-1" title="ìƒì„¸ë³´ê¸°">
                <i class="fas fa-eye"></i>
            </button>
            <button onclick="window.approveRegistration(${reg.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-sm mr-1" title="ìŠ¹ì¸">
                <i class="fas fa-check"></i>
            </button>
            <button onclick="window.rejectRegistration(${reg.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm" title="ê±°ì ˆ">
                <i class="fas fa-times"></i>
            </button>
        ` : `
            <button onclick="window.viewRegistrationDetail(${reg.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm" title="ìƒì„¸ë³´ê¸°">
                <i class="fas fa-eye"></i>
            </button>
        `;

        return `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-2 text-center">${profilePhoto}</td>
                <td class="px-4 py-2 text-sm">${createdAt}</td>
                <td class="px-4 py-2 font-medium">${reg.name || '-'}</td>
                <td class="px-4 py-2">${courseName}</td>
                <td class="px-4 py-2">${reg.phone || '-'}</td>
                <td class="px-4 py-2">${reg.email || '-'}</td>
                <td class="px-4 py-2">${statusBadge[reg.status] || reg.status}</td>
                <td class="px-4 py-2 text-center">${actionButtons}</td>
            </tr>
        `;
    }).join('');
};

window.viewRegistrationDetail = function(regId) {
    const registrations = window._registrations || [];
    const reg = registrations.find(r => r.id === regId);
    if (!reg) return;

    const courseMap = window._courseMap || {};
    const courseName = courseMap[reg.course_code] || reg.course_code || '-';

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.id = 'reg-detail-modal';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-user-plus mr-2 text-orange-500"></i>ì‹ ê·œê°€ì… ìƒì„¸ì •ë³´
                </h3>
                <button onclick="document.getElementById('reg-detail-modal').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-3">
                <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
                <div class="flex justify-center mb-4">
                    ${reg.profile_photo
                        ? `<img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(reg.profile_photo)}" alt="í”„ë¡œí•„" class="w-24 h-24 rounded-full object-cover border-4 border-orange-200 shadow-lg" onerror="this.src='${getDefaultAvatarUrl(reg.gender, reg.name)}'">`
                        : `<img src="${getDefaultAvatarUrl(reg.gender, reg.name)}" alt="í”„ë¡œí•„" class="w-24 h-24 rounded-full object-cover border-4 border-orange-200 shadow-lg">`
                    }
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-500">ì´ë¦„</label>
                        <p class="font-medium">${reg.name || '-'}</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500">ì‹ ì²­ ê³¼ì •</label>
                        <p class="font-medium">${courseName}</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500">ìƒë…„ì›”ì¼</label>
                        <p class="font-medium">${reg.birth_date || '-'}</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500">ì„±ë³„</label>
                        <p class="font-medium">${reg.gender || '-'}</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500">ì—°ë½ì²˜</label>
                        <p class="font-medium">${reg.phone || '-'}</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500">ì´ë©”ì¼</label>
                        <p class="font-medium">${reg.email || '-'}</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm text-gray-500">ì£¼ì†Œ</label>
                    <p class="font-medium">${reg.address || '-'}</p>
                </div>

                <div>
                    <label class="block text-sm text-gray-500">í•™ë ¥</label>
                    <p class="font-medium">${reg.education || '-'}</p>
                </div>

                <div>
                    <label class="block text-sm text-gray-500">ê´€ì‹¬ë¶„ì•¼</label>
                    <p class="font-medium">${reg.interests || '-'}</p>
                </div>

                <div>
                    <label class="block text-sm text-gray-500">ìê¸°ì†Œê°œ</label>
                    <p class="font-medium whitespace-pre-wrap">${reg.introduction || '-'}</p>
                </div>

                <div class="grid grid-cols-2 gap-4 pt-3 border-t">
                    <div>
                        <label class="block text-sm text-gray-500">ì‹ ì²­ì¼ì‹œ</label>
                        <p class="font-medium text-sm">${reg.created_at ? new Date(reg.created_at).toLocaleString('ko-KR') : '-'}</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500">ìƒíƒœ</label>
                        <p class="font-medium">${reg.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : reg.status === 'approved' ? 'ìŠ¹ì¸ë¨' : 'ê±°ì ˆë¨'}</p>
                    </div>
                </div>
            </div>

            ${reg.status === 'pending' ? `
                <div class="flex gap-2 mt-6 pt-4 border-t">
                    <button onclick="document.getElementById('reg-detail-modal').remove(); window.approveRegistration(${reg.id})" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-medium">
                        <i class="fas fa-check mr-2"></i>ìŠ¹ì¸
                    </button>
                    <button onclick="document.getElementById('reg-detail-modal').remove(); window.rejectRegistration(${reg.id})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-medium">
                        <i class="fas fa-times mr-2"></i>ê±°ì ˆ
                    </button>
                </div>
            ` : ''}
        </div>
    `;

    document.body.appendChild(modal);
};

window.approveRegistration = async function(regId) {
    // ì‹ ì²­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const registrations = window._registrations || [];
    const reg = registrations.find(r => r.id === regId);
    if (!reg) {
        window.showAlert('âŒ ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }

    // ê³¼ì • ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    let courseList = [];
    try {
        const response = await axios.get(`${API_BASE_URL}/api/courses`);
        courseList = response.data || [];
    } catch (e) {
        console.error('ê³¼ì • ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
    }

    // ê³¼ì • ì„ íƒ ëª¨ë‹¬ ìƒì„±
    const result = await window.showApproveModal(reg, courseList);

    if (!result) return;

    try {
        window.showLoading('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...');

        const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');

        const response = await axios.put(`${API_BASE_URL}/api/student-registrations/${regId}/approve`, {
            processed_by: instructor.name || '',
            course_code: result.course_code
        });

        window.hideLoading();
        window.showAlert(`âœ… ${response.data.message} (í•™ìƒì½”ë“œ: ${response.data.student_code})`, 'success');

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        window.showStudentRegistrations();

        // í•™ìƒ ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨ (ìŠ¹ì¸ ì‹œ í•™ìƒì´ ì¶”ê°€ë¨)
        if (typeof loadStudents === 'function') {
            loadStudents();
        }
    } catch (error) {
        window.hideLoading();
        console.error('ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ìŠ¹ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message), 'error');
    }
};

// ìŠ¹ì¸ ëª¨ë‹¬ (ê³¼ì • ì„ íƒ í¬í•¨)
window.showApproveModal = function(reg, courseList) {
    return new Promise((resolve) => {
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById('approve-modal');
        if (existingModal) existingModal.remove();

        // ê³¼ì • ì˜µì…˜ ìƒì„±
        const courseOptions = courseList.map(c =>
            `<option value="${c.code}" ${c.code === reg.course_code ? 'selected' : ''}>${c.name}</option>`
        ).join('');

        const courseMap = window._courseMap || {};
        const currentCourseName = courseMap[reg.course_code] || reg.course_code || 'ë¯¸ì„ íƒ';

        const modal = document.createElement('div');
        modal.id = 'approve-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden transform transition-all">
                <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user-check text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">ì‹ ì²­ ìŠ¹ì¸</h3>
                            <p class="text-green-100 text-sm">í•™ìƒìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <!-- ì‹ ì²­ì ì •ë³´ -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex items-center mb-3">
                            ${reg.profile_photo
                                ? `<img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(reg.profile_photo)}" alt="í”„ë¡œí•„" class="w-12 h-12 rounded-full object-cover border-2 border-green-200 mr-3">`
                                : `<div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mr-3"><i class="fas fa-user text-green-500"></i></div>`
                            }
                            <div>
                                <p class="font-bold text-gray-800">${reg.name || '-'}</p>
                                <p class="text-sm text-gray-500">${reg.phone || '-'}</p>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p><i class="fas fa-calendar-alt mr-2 text-gray-400"></i>ìƒë…„ì›”ì¼: ${reg.birth_date || '-'}</p>
                            <p class="mt-1"><i class="fas fa-book mr-2 text-gray-400"></i>ì‹ ì²­ ê³¼ì •: ${currentCourseName}</p>
                        </div>
                    </div>

                    <!-- ê³¼ì • ì„ íƒ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-graduation-cap mr-1 text-green-500"></i>ë“±ë¡í•  ê³¼ì • ì„ íƒ
                        </label>
                        <select id="approve-course-select" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
                            ${courseOptions}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ê³¼ì •ì„ ë³€ê²½í•˜ê±°ë‚˜ ê·¸ëŒ€ë¡œ ìŠ¹ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>

                    <!-- ë²„íŠ¼ -->
                    <div class="flex gap-3">
                        <button id="approve-modal-cancel" class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition-colors">
                            ì·¨ì†Œ
                        </button>
                        <button id="approve-modal-confirm" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                            <i class="fas fa-check mr-2"></i>ìŠ¹ì¸
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('approve-modal-confirm').onclick = () => {
            const selectedCourse = document.getElementById('approve-course-select').value;
            modal.remove();
            resolve({ course_code: selectedCourse });
        };
        document.getElementById('approve-modal-cancel').onclick = () => {
            modal.remove();
            resolve(null);
        };

        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
                resolve(null);
            }
        });

        // ESC í‚¤ë¡œ ë‹«ê¸°
        const handleKeydown = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', handleKeydown);
                resolve(null);
            }
        };
        document.addEventListener('keydown', handleKeydown);
    });
};

window.rejectRegistration = async function(regId) {
    const confirmed = await window.showConfirmModal(
        'ì‹ ì²­ ê±°ì ˆ',
        'ì´ ì‹ ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        {
            confirmText: 'ê±°ì ˆ',
            cancelText: 'ì·¨ì†Œ',
            confirmClass: 'bg-red-600 hover:bg-red-700',
            icon: 'fa-user-times',
            iconColor: 'text-red-500'
        }
    );

    if (!confirmed) return;

    try {
        window.showLoading('ê±°ì ˆ ì²˜ë¦¬ ì¤‘...');

        const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');

        await axios.put(`${API_BASE_URL}/api/student-registrations/${regId}/reject`, {
            processed_by: instructor.name || ''
        });

        window.hideLoading();
        window.showAlert('âœ… ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        window.showStudentRegistrations();
    } catch (error) {
        window.hideLoading();
        console.error('ê±°ì ˆ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ê±°ì ˆ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message), 'error');
    }
};

window.showStudentForm = async function(studentId = null) {
    // courses ë°°ì—´ì´ ì—†ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
    if (!courses || courses.length === 0) {
        try {
            const response = await axios.get(`${API_BASE_URL}/api/courses`);
            courses = response.data;
        } catch (error) {
            console.error('ê³¼ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            courses = [];
        }
    }
    
    const student = studentId ? students.find(s => s.id === studentId) : null;
    
    // ìƒˆ í•™ìƒ ì¶”ê°€ ì‹œ: í•„í„°ì—ì„œ ì„ íƒëœ ê³¼ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
    let defaultCourseCode = '';
    if (!studentId) {
        const courseFilter = document.getElementById('student-course-filter');
        defaultCourseCode = courseFilter ? courseFilter.value : '';
    }
    
    const formDiv = document.getElementById('student-form');
    
    // í•™ìƒ ì½”ë“œ ìë™ ìƒì„± (S001, S002...)
    let autoCode = '';
    if (!studentId) {
        const maxCode = students.reduce((max, s) => {
            const match = s.code.match(/^S(\d+)$/);
            if (match) {
                const num = parseInt(match[1]);
                return num > max ? num : max;
            }
            return max;
        }, 0);
        autoCode = `S${String(maxCode + 1).padStart(3, '0')}`;
    }
    
    formDiv.innerHTML = `
        <h3 class="text-lg font-bold mb-4">${student ? 'í•™ìƒ ì •ë³´ ìˆ˜ì •' : 'ìƒˆ í•™ìƒ ì¶”ê°€'}</h3>
        <form id="student-save-form">
            <input type="hidden" id="student-id" value="${studentId || ''}">
            <div class="grid grid-cols-2 gap-4">
                ${!student ? `
                <div>
                    <label class="block text-gray-700 mb-2">í•™ìƒ ì½”ë“œ</label>
                    <input type="text" value="${autoCode}" readonly 
                           class="w-full px-3 py-2 border rounded-lg bg-gray-100 font-mono">
                    <input type="hidden" name="code" value="${autoCode}">
                </div>
                ` : ''}
                <div>
                    <label class="block text-gray-700 mb-2">ì´ë¦„</label>
                    <input type="text" name="name" value="${student?.name || ''}" required 
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ìƒë…„ì›”ì¼ (YY.MM.DD)</label>
                    <input type="text" name="birth_date" value="${student?.birth_date ? formatDateWithDay(student.birth_date) : ''}" 
                           placeholder="99.02.25"
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ì„±ë³„</label>
                    <select name="gender" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">ì„ íƒ</option>
                        <option value="ë‚¨ì" ${student?.gender === 'ë‚¨ì' ? 'selected' : ''}>ë‚¨ì</option>
                        <option value="ì—¬ì" ${student?.gender === 'ì—¬ì' ? 'selected' : ''}>ì—¬ì</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ì—°ë½ì²˜</label>
                    <input type="tel" name="phone" value="${student?.phone ? normalizePhone(student.phone) : ''}" required 
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-700 mb-2">ì´ë©”ì¼</label>
                    <input type="email" name="email" value="${student?.email || ''}" 
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-700 mb-2">ì£¼ì†Œ</label>
                    <input type="text" name="address" value="${student?.address || ''}" 
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê´€ì‹¬ë¶„ì•¼</label>
                    <input type="text" name="interests" value="${student?.interests || ''}" 
                           placeholder="ë¡œë´‡, AI"
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">í¬ë§ì§€ì—­</label>
                    <input type="text" name="campus" value="${student?.campus || ''}"
                           placeholder="ì˜ˆ: ì„œìš¸, ëŒ€ì „"
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê³¼ì • ì„ íƒ</label>
                    <select name="course_code" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">ì„ íƒ</option>
                        ${courses.sort((a, b) => (a.name || a.code).localeCompare(b.name || b.code, 'ko')).map(c => `
                            <option value="${c.code}" ${(student?.course_code === c.code || (!student && defaultCourseCode === c.code)) ? 'selected' : ''}>
                                ${c.code} - ${c.name || c.code}
                            </option>
                        `).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ì§„ë¡œ ë¶„ì•¼</label>
                    <select name="career_path" class="w-full px-3 py-2 border rounded-lg">
                        <option value="1. í•™ì—…" ${student?.career_path === '1. í•™ì—…' ? 'selected' : ''}>1. í•™ì—…</option>
                        <option value="2. ì·¨ì—…" ${student?.career_path === '2. ì·¨ì—…' ? 'selected' : ''}>2. ì·¨ì—…</option>
                        <option value="3. ì°½ì—…" ${student?.career_path === '3. ì°½ì—…' ? 'selected' : ''}>3. ì°½ì—…</option>
                        <option value="4. ë¯¸ì •" ${student?.career_path === '4. ë¯¸ì •' || !student?.career_path ? 'selected' : ''}>4. ë¯¸ì •</option>
                        <option value="5. ê¸°íƒ€" ${student?.career_path === '5. ê¸°íƒ€' ? 'selected' : ''}>5. ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-700 mb-2">í•™ë ¥</label>
                    <input type="text" name="education" value="${student?.education || ''}"
                           placeholder="í•™êµ/í•™ë…„/ì „ê³µ"
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-700 mb-2">ìê¸°ì†Œê°œ</label>
                    <textarea name="introduction" rows="3" class="w-full px-3 py-2 border rounded-lg">${student?.introduction || ''}</textarea>
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-700 mb-2">ë¹„ê³ </label>
                    <textarea name="notes" rows="2" class="w-full px-3 py-2 border rounded-lg">${student?.notes || ''}</textarea>
                </div>
                
                <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
                <div class="col-span-2 mt-4">
                    <label class="block text-gray-700 mb-2">
                        <i class="fas fa-user-circle mr-2"></i>í”„ë¡œí•„ ì‚¬ì§„
                    </label>
                    <div class="flex items-center gap-4">
                        <img id="student-profile-photo" 
                             src="${student && student.profile_photo ? API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(student.profile_photo) : 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect fill=%27%23e5e7eb%27 width=%27200%27 height=%27200%27/%3E%3Ctext fill=%27%239ca3af%27 font-family=%27Arial%27 font-size=%2714%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dominant-baseline=%27middle%27%3ENo Photo%3C/text%3E%3C/svg%3E'}" 
                             alt="í”„ë¡œí•„ ì‚¬ì§„" 
                             class="w-24 h-24 rounded-full object-cover border-2 border-gray-300">
                        <input type="hidden" id="student-profile-photo-url" value="${student && student.profile_photo ? student.profile_photo : ''}">
                        <div>
                            <button type="button" onclick="document.getElementById('student-profile-input').click()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-camera mr-2"></i>í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½
                            </button>
                            <input type="file" id="student-profile-input" accept="image/*" 
                                   onchange="window.handleStudentProfileUpload(event)" class="hidden">
                            <p class="text-xs text-gray-500 mt-2">í”„ë¡œí•„ ì „ìš© ì‚¬ì§„ (1ê°œ)</p>
                            <!-- í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
                            <div id="student-profile-upload-progress" class="hidden mt-2">
                                <div class="bg-green-50 border border-green-200 rounded p-2">
                                    <p class="text-xs text-green-800 mb-1">
                                        <i class="fas fa-cloud-upload-alt mr-1"></i>ì—…ë¡œë“œ ì¤‘...
                                    </p>
                                    <div class="w-full bg-green-200 rounded-full h-1.5">
                                        <div id="student-profile-progress-bar" class="bg-green-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì²¨ë¶€ íŒŒì¼ -->
                <div class="col-span-2 mt-4">
                    <label class="block text-gray-700 mb-2">
                        <i class="fas fa-paperclip mr-2"></i>ì²¨ë¶€ íŒŒì¼ (ì´ë ¥ì„œ, ì¦ëª…ì„œ, í¬íŠ¸í´ë¦¬ì˜¤ ë“± - ìµœëŒ€ 20ê°œ)
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" onclick="document.getElementById('student-file-input').click()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                            </button>
                        </div>
                        <input type="file" id="student-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                               onchange="window.handleStudentImageUpload(event)" class="hidden">
                        <div id="student-upload-progress" class="hidden mb-3">
                            <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                <p class="text-sm text-blue-800 mb-2">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>
                                    ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                                </p>
                                <div class="w-full bg-blue-200 rounded-full h-2">
                                    <div id="student-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div id="student-photos-preview" class="flex flex-col gap-2 mt-2"></div>
                        <input type="hidden" id="student-photo-urls" value='${student && student.attachments ? student.attachments : "[]"}'>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            í˜„ì¬ íŒŒì¼: <span id="student-file-count">${student && student.attachments ? JSON.parse(student.attachments).length : 0}</span>/20
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-4 space-x-2">
                <button type="button" onclick="window.saveStudent(${studentId})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>ì €ì¥
                </button>
                <button type="button" onclick="window.hideStudentForm()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                    ì·¨ì†Œ
                </button>
            </div>
        </form>
    `;
    
    formDiv.classList.remove('hidden');
    
    // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    formDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // ê¸°ì¡´ ì²¨ë¶€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    if (student?.attachments) {
        try {
            const attachments = typeof student.attachments === 'string' 
                ? JSON.parse(student.attachments) 
                : student.attachments;
            updateStudentPhotoPreview(attachments);
        } catch (e) {
            console.error('ì²¨ë¶€ íŒŒì¼ URL íŒŒì‹± ì˜¤ë¥˜:', e);
        }
    }
}

window.hideStudentForm = function() {
    document.getElementById('student-form').classList.add('hidden');
}

window.saveStudent = async function(studentId, autoSave = false) {
    const form = document.getElementById('student-save-form');
    const formData = new FormData(form);
    
    // Get profile photo URL
    const profilePhotoInput = document.getElementById('student-profile-photo-url');
    const profilePhoto = profilePhotoInput ? profilePhotoInput.value : '';
    
    // Get attachments
    const photoUrlsInput = document.getElementById('student-photo-urls');
    const attachments = photoUrlsInput ? JSON.parse(photoUrlsInput.value || '[]') : [];
    
    const data = {
        name: formData.get('name'),
        birth_date: normalizeBirthDate(formData.get('birth_date')),
        gender: formData.get('gender'),
        phone: normalizePhone(formData.get('phone')),
        email: formData.get('email'),
        address: formData.get('address'),
        interests: formData.get('interests'),
        education: formData.get('education'),
        introduction: formData.get('introduction'),
        campus: formData.get('campus'),
        course_code: formData.get('course_code'),
        notes: formData.get('notes'),
        profile_photo: profilePhoto,
        attachments: JSON.stringify(attachments),
        career_path: formData.get('career_path') || '4. ë¯¸ì •'
    };
    
    try {
        if (studentId) {
            await axios.put(`${API_BASE_URL}/api/students/${studentId}`, data);
            if (!autoSave) {
                window.showAlert('âœ… í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        } else {
            data.code = formData.get('code');
            await axios.post(`${API_BASE_URL}/api/students`, data);
            if (!autoSave) {
                window.showAlert('âœ… í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        }
        
        // ìºì‹œ ì‚­ì œ (í•™ìƒ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ)
        window.clearCache('students');
        
        if (!autoSave) {
            window.hideStudentForm();
            loadStudents();
        }
    } catch (error) {
        console.error('í•™ìƒ ì €ì¥ ì‹¤íŒ¨:', error);
        const errorMsg = error.response?.data?.detail || error.message;
        window.showAlert('âŒ í•™ìƒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMsg, 'error');
    }
}

// í•™ìƒ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
window.handleStudentProfileUpload = async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìš”ì†Œ
    const progressDiv = document.getElementById('student-profile-upload-progress');
    const progressBar = document.getElementById('student-profile-progress-bar');
    
    try {
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ
        if (progressDiv) {
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
        }
        
        // ì´ë¯¸ì§€ ì••ì¶•
        let processedFile = file;
        if (file.type.startsWith('image/')) {
            try {
                processedFile = await window.compressImage(file);
                console.log(`í”„ë¡œí•„ ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
                processedFile = file;
            }
        }
        
        const formData = new FormData();
        formData.append('file', processedFile);
        
        const response = await axios.post(
            `${API_BASE_URL}/api/upload-image?category=student`,
            formData,
            {
                headers: { 'Content-Type': 'multipart/form-data' },
                onUploadProgress: (progressEvent) => {
                    const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                    if (progressBar) {
                        progressBar.style.width = percentCompleted + '%';
                    }
                }
            }
        );
        
        if (response.data.success) {
            const profilePhotoUrl = response.data.url;
            document.getElementById('student-profile-photo').src = API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(profilePhotoUrl);
            document.getElementById('student-profile-photo-url').value = profilePhotoUrl;
            
            // ìë™ ì €ì¥
            const studentIdInput = document.getElementById('student-id');
            const studentId = studentIdInput ? studentIdInput.value : null;
            if (studentId) {
                await window.saveStudent(parseInt(studentId), true);
                window.showAlert('âœ… í”„ë¡œí•„ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else {
                window.showAlert('âœ… í”„ë¡œí•„ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) {
            setTimeout(() => {
                progressDiv.classList.add('hidden');
            }, 1000);
        }
    } catch (error) {
        console.error('í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) {
            progressDiv.classList.add('hidden');
        }
    }
    
    event.target.value = '';
};

// í•™ìƒ ì‚¬ì§„ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ì²¨ë¶€ íŒŒì¼)
window.handleStudentImageUpload = async function(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // íŒŒì¼ ê²€ì¦
    for (let file of files) {
        const validation = window.validateFile(file);
        if (!validation.valid) {
            window.showAlert(validation.message, 'warning');
            event.target.value = '';
            return;
        }
    }
    
    try {
        const photoUrlsInput = document.getElementById('student-photo-urls');
        const photoUrls = JSON.parse(photoUrlsInput.value || '[]');
        
        // 20-file limit check
        const remainingSlots = 20 - photoUrls.length;
        if (remainingSlots <= 0) {
            window.showAlert('âš ï¸ ì²¨ë¶€ íŒŒì¼ì€ ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
            event.target.value = '';
            return;
        }
        
        if (files.length > remainingSlots) {
            window.showAlert(`âš ï¸ ${remainingSlots}ê°œì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${photoUrls.length}/20)`, 'warning');
            event.target.value = '';
            return;
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” í‘œì‹œ
        const progressDiv = document.getElementById('student-upload-progress');
        const progressBar = document.getElementById('student-progress-bar');
        if (progressDiv) {
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
        }
        
        const totalFiles = files.length;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ì´ë¯¸ì§€ ìë™ ì••ì¶• (PDFëŠ” ê·¸ëŒ€ë¡œ)
            let processedFile = file;
            if (file.type.startsWith('image/')) {
                try {
                    processedFile = await window.compressImage(file);
                    console.log(`ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
                    processedFile = file;
                }
            }
            
            const formData = new FormData();
            formData.append('file', processedFile);
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
            const progress = ((i + 0.5) / totalFiles) * 100;
            if (progressBar) progressBar.style.width = `${progress}%`;
            
            const response = await axios.post(
                `${API_BASE_URL}/api/upload-image?category=student`,
                formData,
                { headers: { 'Content-Type': 'multipart/form-data' } }
            );
            
            if (response.data.success) {
                // URLê³¼ ì›ë³¸ íŒŒì¼ëª…ì„ í•¨ê»˜ ì €ì¥ (URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹)
                const urlWithOriginalName = response.data.original_filename 
                    ? `${response.data.url}#${encodeURIComponent(response.data.original_filename)}`
                    : response.data.url;
                photoUrls.push(urlWithOriginalName);
            }
            
            // ì™„ë£Œ í”„ë¡œê·¸ë ˆìŠ¤
            const completeProgress = ((i + 1) / totalFiles) * 100;
            if (progressBar) progressBar.style.width = `${completeProgress}%`;
        }
        
        photoUrlsInput.value = JSON.stringify(photoUrls);
        updateStudentPhotoPreview(photoUrls);
        
        // Update file count
        const fileCountSpan = document.getElementById('student-file-count');
        if (fileCountSpan) {
            fileCountSpan.textContent = photoUrls.length;
        }
        
        // ìë™ ì €ì¥ (í™”ë©´ ìœ ì§€)
        const studentIdInput = document.getElementById('student-id');
        const studentId = studentIdInput ? studentIdInput.value : null;
        if (studentId) {
            await window.saveStudent(parseInt(studentId), true);
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) {
            setTimeout(() => {
                progressDiv.classList.add('hidden');
            }, 1000);
        }
        
        // í•™ìƒ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const studentNameInput = document.querySelector('input[name="name"]');
        const studentName = studentNameInput ? studentNameInput.value : '';
        const contextMsg = studentName ? `${studentName} í•™ìƒì—ê²Œ ` : '';
        window.showAlert(`âœ… ${contextMsg}${files.length}ê°œ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! (${photoUrls.length}/20)`, 'success');
        
    } catch (error) {
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¸°ê¸°
        const progressDiv = document.getElementById('student-upload-progress');
        if (progressDiv) progressDiv.classList.add('hidden');
        
        console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
    
    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
    event.target.value = '';
}

// í•™ìƒ ì‚¬ì§„ ì‚­ì œ
window.removeStudentPhoto = async function(index) {
    // ì‚­ì œ í™•ì¸
    const confirmed = await window.showConfirm('âš ï¸ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ íŒŒì¼ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    const photoUrlsInput = document.getElementById('student-photo-urls');
    const photoUrls = JSON.parse(photoUrlsInput.value || '[]');
    
    photoUrls.splice(index, 1);
    photoUrlsInput.value = JSON.stringify(photoUrls);
    updateStudentPhotoPreview(photoUrls);
    
    // Update file count
    const fileCountSpan = document.getElementById('student-file-count');
    if (fileCountSpan) {
        fileCountSpan.textContent = photoUrls.length;
    }
    
    // ìë™ ì €ì¥
    const studentIdInput = document.getElementById('student-id');
    const studentId = studentIdInput ? studentIdInput.value : null;
    if (studentId) {
        await window.saveStudent(parseInt(studentId), true);
        
        // í•™ìƒ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const studentNameInput = document.querySelector('input[name="name"]');
        const studentName = studentNameInput ? studentNameInput.value : '';
        const contextMsg = studentName ? `${studentName} í•™ìƒì—ê²Œì„œ ` : '';
        window.showAlert(`âœ… ${contextMsg}íŒŒì¼ì´ ì‚­ì œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${photoUrls.length}/20)`, 'success');
    }
}

// í•™ìƒ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updateStudentPhotoPreview(photoUrls) {
    const previewDiv = document.getElementById('student-photos-preview');
    if (!previewDiv) return;
    
    if (!photoUrls || photoUrls.length === 0) {
        previewDiv.innerHTML = '<p class="text-gray-400 text-sm">ì²¨ë¶€ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    previewDiv.innerHTML = photoUrls.map((url, index) => 
        window.createFilePreviewItem(url, index, 'window.removeStudentPhoto')
    ).join('');
}

window.editStudent = function(id) {
    window.showStudentForm(id);
}

window.viewStudent = async function(id) {
    // ìƒˆë¡œìš´ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ í˜¸ì¶œ
    window.showStudentDetail(id);
}

window.deleteStudent = async function(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ì—¬ì£¼ê¸°
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const message = `âš ï¸ ì´ í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ë¦„: ${student.name}\ní•™ìƒì½”ë“œ: ${student.code}\nì—°ë½ì²˜: ${student.phone || 'ì—†ìŒ'}\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
    const confirmed = await window.showConfirm(message);
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/students/${id}`);
        window.clearCache('students');
        window.showAlert('âœ… í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        loadStudents();
    } catch (error) {
        window.showAlert('âŒ í•™ìƒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    }
}

// ==================== ê³¼ëª© ê´€ë¦¬ ====================
async function loadSubjects() {
    try {
        const [subjectsRes, instructorsRes, instructorTypesRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/subjects`),
            axios.get(`${API_BASE_URL}/api/instructors`),
            axios.get(`${API_BASE_URL}/api/instructor-codes`)
        ]);
        subjects = subjectsRes.data;
        instructors = instructorsRes.data;
        instructorTypes = instructorTypesRes.data;
        renderSubjects();
    } catch (error) {
        console.error('ê³¼ëª© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ê³¼ëª© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

// ìš”ì¼ ë³€í™˜ í—¬í¼ í•¨ìˆ˜
function getDayName(dayOfWeek) {
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    return days[dayOfWeek] || 'ë¯¸ì •';
}

// ê²©ì£¼ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
function getBiweeklyInfo(isBiweekly, weekOffset) {
    if (isBiweekly === 0) return 'ë§¤ì£¼';
    return weekOffset === 0 ? 'ê²©ì£¼(1ì£¼ì°¨)' : 'ê²©ì£¼(2ì£¼ì°¨)';
}

function renderSubjects() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-book mr-2"></i>ê³¼ëª© ëª©ë¡ (ì´ ${subjects.length}ê°œ)
                </h2>
                <button onclick="window.showSubjectForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>ê³¼ëª© ì¶”ê°€
                </button>
            </div>
            
            <div id="subject-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg"></div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${subjects.map(subject => `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-blue-600">${subject.name}</h3>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded">${subject.code}</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-1">
                            <i class="fas fa-user-tie mr-1"></i>${subject.instructor_name || 'ë¯¸ì •'}
                        </p>
                        <div class="text-sm text-gray-600 space-y-1 mt-2">
                            <p><i class="fas fa-calendar mr-2"></i>ê°•ì˜ìš”ì¼: ${getDayName(subject.day_of_week)}ìš”ì¼</p>
                            <p><i class="fas fa-repeat mr-2"></i>ë¹ˆë„: ${getBiweeklyInfo(subject.is_biweekly, subject.week_offset)}</p>
                            <p><i class="fas fa-clock mr-2"></i>ê°•ì˜ì‹œìˆ˜: ${subject.hours || 0}ì‹œê°„</p>
                        </div>
                        ${subject.description ? `<p class="text-sm text-gray-500 mt-2"><i class="fas fa-briefcase mr-1"></i>ì§ë¬´ë¶„ì•¼: ${subject.description}</p>` : ''}
                        ${(() => {
                            const subs = [1, 2, 3, 4, 5]
                                .filter(i => subject[`sub_subject_${i}`] && subject[`sub_subject_${i}`].trim())
                                .map(i => `${subject[`sub_subject_${i}`]} (${subject[`sub_hours_${i}`] || 0}h)`);
                            return subs.length > 0 ? `
                                <div class="mt-2 pt-2 border-t">
                                    <p class="text-xs font-semibold text-gray-700 mb-1">êµê³¼ëª© ì£¼ì œ:</p>
                                    <div class="text-xs text-gray-600 space-y-0.5">
                                        ${subs.map(s => `<p>â€¢ ${s}</p>`).join('')}
                                    </div>
                                </div>
                            ` : '';
                        })()}
                        <div class="mt-3 flex space-x-2">
                            <button onclick="window.editSubject('${subject.code}')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i> ìˆ˜ì •
                            </button>
                            <button onclick="window.deleteSubject('${subject.code}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i> ì‚­ì œ
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

window.showSubjectForm = function(subjectCode = null) {
    const formDiv = document.getElementById('subject-form');
    const existingSubject = subjectCode ? subjects.find(s => s.code === subjectCode) : null;
    
    // ê³¼ëª© ì½”ë“œ ìë™ ìƒì„± (G-001, G-002...)
    let autoCode = '';
    if (!subjectCode) {
        const maxCode = subjects.reduce((max, subj) => {
            const match = subj.code.match(/^G-(\d+)$/);
            if (match) {
                const num = parseInt(match[1]);
                return num > max ? num : max;
            }
            return max;
        }, 0);
        autoCode = `G-${String(maxCode + 1).padStart(3, '0')}`;
    }
    
    formDiv.innerHTML = `
        <h3 class="text-lg font-semibold mb-4">${subjectCode ? 'ê³¼ëª© ìˆ˜ì •' : 'ê³¼ëª© ì¶”ê°€'}</h3>
        <form id="subject-save-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 mb-2">ê³¼ëª© ì½”ë“œ *</label>
                    <input type="text" name="code" value="${existingSubject?.code || autoCode}" 
                           ${subjectCode ? 'readonly' : 'readonly'} required
                           placeholder="G-001"
                           class="w-full px-3 py-2 border rounded-lg bg-gray-100">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê³¼ëª©ëª… *</label>
                    <input type="text" name="name" value="${existingSubject?.name || ''}" required
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ë‹´ë‹¹ ê°•ì‚¬ (ì£¼ê°•ì‚¬ë§Œ)</label>
                    <select name="main_instructor" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">ì„ íƒ</option>
                        ${instructors.filter(inst => {
                            const typeInfo = instructorTypes.find(t => t.code === inst.instructor_type);
                            return typeInfo && typeInfo.type === '1. ì£¼ê°•ì‚¬';
                        }).sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'))
                        .map(inst => {
                            const typeInfo = instructorTypes.find(t => t.code === inst.instructor_type);
                            const typeName = typeInfo ? typeInfo.name : '';
                            const typeType = typeInfo ? typeInfo.type : '';
                            return `
                                <option value="${inst.code}" ${existingSubject?.main_instructor === inst.code ? 'selected' : ''}>
                                    ${inst.name} - ${inst.code} - ${typeName} - ${typeType}
                                </option>
                            `;
                        }).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê°•ì˜ ìš”ì¼ *</label>
                    <select name="day_of_week" class="w-full px-3 py-2 border rounded-lg" required>
                        <option value="">ì„ íƒ</option>
                        <option value="0" ${existingSubject?.day_of_week === 0 ? 'selected' : ''}>ì¼ìš”ì¼</option>
                        <option value="1" ${existingSubject?.day_of_week === 1 ? 'selected' : ''}>ì›”ìš”ì¼</option>
                        <option value="2" ${existingSubject?.day_of_week === 2 ? 'selected' : ''}>í™”ìš”ì¼</option>
                        <option value="3" ${existingSubject?.day_of_week === 3 ? 'selected' : ''}>ìˆ˜ìš”ì¼</option>
                        <option value="4" ${existingSubject?.day_of_week === 4 ? 'selected' : ''}>ëª©ìš”ì¼</option>
                        <option value="5" ${existingSubject?.day_of_week === 5 ? 'selected' : ''}>ê¸ˆìš”ì¼</option>
                        <option value="6" ${existingSubject?.day_of_week === 6 ? 'selected' : ''}>í† ìš”ì¼</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê²©ì£¼ ì—¬ë¶€</label>
                    <select name="is_biweekly" id="is-biweekly" class="w-full px-3 py-2 border rounded-lg" onchange="window.toggleWeekOffset()">
                        <option value="0" ${existingSubject?.is_biweekly === 0 ? 'selected' : ''}>ë§¤ì£¼</option>
                        <option value="1" ${existingSubject?.is_biweekly === 1 ? 'selected' : ''}>ê²©ì£¼</option>
                    </select>
                </div>
                <div id="week-offset-div" class="${existingSubject?.is_biweekly === 1 ? '' : 'hidden'}">
                    <label class="block text-gray-700 mb-2">ì£¼ì°¨ ì„ íƒ</label>
                    <select name="week_offset" class="w-full px-3 py-2 border rounded-lg">
                        <option value="0" ${existingSubject?.week_offset === 0 ? 'selected' : ''}>1ì£¼ì°¨</option>
                        <option value="1" ${existingSubject?.week_offset === 1 ? 'selected' : ''}>2ì£¼ì°¨</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê°•ì˜ ì‹œìˆ˜ (ì‹œê°„) *</label>
                    <input type="number" name="hours" value="${existingSubject?.hours || 0}" required
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <!-- êµê³¼ëª© ì£¼ì œ 5ê°œ -->
                <div class="col-span-2">
                    <label class="block text-gray-700 font-semibold mb-3">
                        <i class="fas fa-list mr-2"></i>êµê³¼ëª© ì£¼ì œ (ìµœëŒ€ 5ê°œ)
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 bg-blue-50 p-4 rounded-lg">
                        ${[1, 2, 3, 4, 5].map(i => `
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-semibold text-gray-600 w-12">${i}.</span>
                                <input type="text" name="sub_subject_${i}" 
                                       value="${existingSubject?.[`sub_subject_${i}`] || ''}"
                                       placeholder="êµê³¼ëª© ì£¼ì œ ${i}"
                                       class="flex-1 px-2 py-1 border rounded text-sm">
                                <input type="number" name="sub_hours_${i}" 
                                       value="${existingSubject?.[`sub_hours_${i}`] || 0}"
                                       placeholder="ì‹œìˆ˜"
                                       class="w-16 px-2 py-1 border rounded text-sm">
                                <span class="text-xs text-gray-500">h</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="col-span-2">
                    <label class="block text-gray-700 mb-2">ì§ë¬´ë¶„ì•¼</label>
                    <textarea name="description" rows="3" placeholder="ì˜ˆ: ì›¹ ê°œë°œ, ë°ì´í„° ë¶„ì„, AI ì—”ì§€ë‹ˆì–´ë§ ë“±" class="w-full px-3 py-2 border rounded-lg">${existingSubject?.description || ''}</textarea>
                </div>
            </div>
            <div class="mt-4 space-x-2">
                <button type="button" onclick="window.saveSubject('${subjectCode || ''}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>ì €ì¥
                </button>
                <button type="button" onclick="window.hideSubjectForm()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                    ì·¨ì†Œ
                </button>
            </div>
        </form>
    `;
    
    formDiv.classList.remove('hidden');
}

// ê²©ì£¼ ì„ íƒ ì‹œ ì£¼ì°¨ ì„ íƒ í‘œì‹œ/ìˆ¨ê¹€
window.toggleWeekOffset = function() {
    const isBiweekly = document.getElementById('is-biweekly').value;
    const weekOffsetDiv = document.getElementById('week-offset-div');
    if (isBiweekly === '1') {
        weekOffsetDiv.classList.remove('hidden');
    } else {
        weekOffsetDiv.classList.add('hidden');
    }
}

window.hideSubjectForm = function() {
    document.getElementById('subject-form').classList.add('hidden');
}

window.saveSubject = async function(subjectCode) {
    const form = document.getElementById('subject-save-form');
    const formData = new FormData(form);
    const data = {
        code: formData.get('code'),
        name: formData.get('name'),
        main_instructor: formData.get('main_instructor'),
        day_of_week: parseInt(formData.get('day_of_week')),
        is_biweekly: parseInt(formData.get('is_biweekly')),
        week_offset: parseInt(formData.get('week_offset')) || 0,
        hours: parseInt(formData.get('hours')) || 0,
        description: formData.get('description'),
        // ì„¸ë¶€ êµê³¼ëª© 5ê°œ
        sub_subject_1: formData.get('sub_subject_1') || '',
        sub_hours_1: parseInt(formData.get('sub_hours_1')) || 0,
        sub_subject_2: formData.get('sub_subject_2') || '',
        sub_hours_2: parseInt(formData.get('sub_hours_2')) || 0,
        sub_subject_3: formData.get('sub_subject_3') || '',
        sub_hours_3: parseInt(formData.get('sub_hours_3')) || 0,
        sub_subject_4: formData.get('sub_subject_4') || '',
        sub_hours_4: parseInt(formData.get('sub_hours_4')) || 0,
        sub_subject_5: formData.get('sub_subject_5') || '',
        sub_hours_5: parseInt(formData.get('sub_hours_5')) || 0
    };
    
    try {
        if (subjectCode) {
            await axios.put(`${API_BASE_URL}/api/subjects/${subjectCode}`, data);
            window.showAlert('ê³¼ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            await axios.post(`${API_BASE_URL}/api/subjects`, data);
            window.showAlert('ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        window.hideSubjectForm();
        loadSubjects();
    } catch (error) {
        console.error('ê³¼ëª© ì €ì¥ ì‹¤íŒ¨:', error);
        window.showAlert('ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

window.editSubject = function(subjectCode) {
    window.showSubjectForm(subjectCode);
}

window.deleteSubject = async function(subjectCode) {
    const subject = subjects.find(s => s.code === subjectCode);
    if (!subject) return;
    
    // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const message = `â— ê³¼ëª© ì‚­ì œ í™•ì¸\n\nê³¼ëª©ëª…: ${subject.name}\nê³¼ëª©ì½”ë“œ: ${subject.code}\në‹´ë‹¹ê°•ì‚¬: ${subject.instructor_name || 'ë¯¸ì •'}\n\nì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    const confirmed = await window.showConfirm(message);
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/subjects/${subjectCode}`);
        window.showAlert('âœ… ê³¼ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadSubjects();
    } catch (error) {
        console.error('ê³¼ëª© ì‚­ì œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

// ==================== SSIRNë©”ëª¨ì¥(ìˆ˜ì—…,ê¸°ì–µ,ì •ë³´,etc) ê´€ë¦¬ ====================
async function loadClassNotes() {
    try {
        window.showLoading('SSIRNë©”ëª¨ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        // ëª¨ë“  í•™ìƒê³¼ ê·¸ë“¤ì˜ SSIRNë©”ëª¨ì¥ ë¶ˆëŸ¬ì˜¤ê¸°
        const studentsData = await window.getCachedData('students', () => 
            axios.get(`${API_BASE_URL}/api/students`).then(r => r.data)
        );
        
        // ê° í•™ìƒì˜ SSIRNë©”ëª¨ì¥ ê°€ì ¸ì˜¤ê¸° (ë³‘ë ¬ ì²˜ë¦¬)
        const notesPromises = studentsData.map(student => 
            axios.get(`${API_BASE_URL}/api/class-notes?student_id=${student.id}`)
                .then(r => ({ student, notes: r.data || [] }))
                .catch(err => {
                    console.warn(`âš ï¸ í•™ìƒ ${student.name}(ID: ${student.id})ì˜ ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:`, err.message);
                    return { student, notes: [] };
                })
        );
        
        const studentNotes = await Promise.all(notesPromises);
        
        // ì¼ì§€ê°€ ìˆëŠ” í•™ìƒë§Œ í•„í„°ë§
        const studentsWithNotes = studentNotes.filter(sn => sn.notes.length > 0);
        
        renderClassNotes(studentsWithNotes, studentsData);
        window.hideLoading();
    } catch (error) {
        console.error('SSIRNë©”ëª¨ì¥ ë¡œë“œ ì‹¤íŒ¨:', error);
        window.hideLoading();
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">SSIRNë©”ëª¨ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
    }
}

function renderClassNotes(studentNotes, allStudents) {
    // ëª¨ë“  ë…¸íŠ¸ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í‰íƒ„í™”í•˜ê³  í•™ìƒ ì •ë³´ í¬í•¨
    const allNotes = [];
    studentNotes.forEach(sn => {
        sn.notes.forEach(note => {
            allNotes.push({
                ...note,
                student: sn.student
            });
        });
    });
    
    // í—¤ë” ì •ë ¬ ì ìš©
    allNotes.sort((a, b) => {
        let valA, valB;
        if (classNoteSortKey === 'student_name') {
            valA = a.student ? a.student.name : '';
            valB = b.student ? b.student.name : '';
        } else {
            valA = a[classNoteSortKey] || '';
            valB = b[classNoteSortKey] || '';
        }
        const cmp = String(valA).localeCompare(String(valB), 'ko');
        return classNoteSortAsc ? cmp : -cmp;
    });
    
    const html = `
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-book-open mr-3 text-blue-600"></i>í•™ìƒ SSIRNë©”ëª¨ì¥(ìˆ˜ì—…,ê¸°ì–µ,ì •ë³´,etc)
                    </h2>
                    <p class="text-gray-600 mt-1">ì´ ${studentNotes.length}ëª…ì˜ í•™ìƒ, ${allNotes.length}ê°œì˜ ì¼ì§€</p>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="search-filter" placeholder="ë‚´ìš© ê²€ìƒ‰..." class="px-4 py-2 border rounded-lg" oninput="filterClassNotes()">
                    <select id="student-filter" class="px-4 py-2 border rounded-lg" onchange="filterClassNotes()">
                        <option value="">ì „ì²´ í•™ìƒ</option>
                        ${allStudents.map(s => `<option value="${s.id}">${s.name} (${s.code})</option>`).join('')}
                    </select>
                    <input type="date" id="date-filter" class="px-4 py-2 border rounded-lg" onchange="filterClassNotes()">
                    <button onclick="clearClassNotesFilters()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            ${allNotes.length === 0 ? `
                <div class="text-center py-12">
                    <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">ì‘ì„±ëœ SSIRNë©”ëª¨ì¥ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            ` : `
                <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
                    <table class="min-w-full bg-white border border-gray-300">
                        <thead class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white sticky top-0 z-10">
                            <tr>
                                ${sortableHeader([
                                    { key: 'student_name', label: 'í•™ìƒëª…' },
                                    { key: 'note_date', label: 'ë‚ ì§œ' },
                                    { key: 'content', label: 'ë‚´ìš©' },
                                    { key: 'created_at', label: 'ìƒì„±ì‹œê°„' }
                                ], classNoteSortKey, classNoteSortAsc, 'window.sortClassNoteTable', 'px-6 py-3 text-left text-sm font-semibold', 'text-yellow-300', 'text-blue-200')}
                            </tr>
                        </thead>
                        <tbody id="notes-tbody">
                            ${allNotes.map((note, index) => `
                                <tr class="border-b hover:bg-blue-50 cursor-pointer transition-colors"
                                    onclick="showClassNoteDetail(${note.id}, '${note.student.name}')"
                                    data-student-id="${note.student.id}"
                                    data-note-date="${note.note_date}"
                                    data-content="${note.content.toLowerCase().replace(/"/g, '&quot;')}">
                                    <td class="px-6 py-4 text-sm">
                                        <div class="flex items-center">
                                            <i class="fas fa-user-circle mr-2 text-blue-500"></i>
                                            <span class="font-medium">${note.student.name}</span>
                                            <span class="ml-2 text-xs text-gray-500">(${note.student.code})</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-700">
                                        <i class="fas fa-calendar-day mr-2 text-blue-500"></i>
                                        ${new Date(note.note_date).toLocaleDateString('ko-KR')}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-700">
                                        <div class="truncate" style="max-width: 500px;">
                                            ${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        ${new Date(note.created_at).toLocaleString('ko-KR', { 
                                            month: '2-digit', 
                                            day: '2-digit', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        })}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `}
        </div>
    `;
    
    document.getElementById('app').innerHTML = html;
    
    // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (í•„í„°ë§ìš©)
    window.allClassNotes = allNotes;
    window.allClassStudents = allStudents;
}

function renderStudentNotesCard(student, notes) {
    // ìµœì‹ ìˆœ ì •ë ¬
    const sortedNotes = [...notes].sort((a, b) => new Date(b.note_date) - new Date(a.note_date));
    
    return `
        <div class="bg-white rounded-lg shadow-md overflow-hidden" data-student-id="${student.id}">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-500 p-4 text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg">${student.name} (${student.code})</h3>
                        <p class="text-blue-100 text-sm">${student.course_name || 'ê³¼ì • ë¯¸ì§€ì •'}</p>
                    </div>
                    <div class="text-right">
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                            ${notes.length}ê°œì˜ ì¼ì§€
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    ${sortedNotes.map(note => `
                        <div class="border rounded-lg p-3 hover:shadow-md transition-shadow cursor-pointer"
                             onclick="showClassNoteDetail(${note.id}, '${student.name}')"
                             data-note-date="${note.note_date}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-semibold text-gray-700">
                                    <i class="fas fa-calendar-day mr-1 text-blue-500"></i>
                                    ${new Date(note.note_date).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                            <p class="text-xs text-gray-600 line-clamp-2">
                                ${note.content.substring(0, 60)}${note.content.length > 60 ? '...' : ''}
                            </p>
                            <div class="mt-2 text-xs text-gray-400">
                                ${new Date(note.created_at).toLocaleString('ko-KR')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

window.showClassNoteDetail = async function(noteId, studentName) {
    try {
        // í•´ë‹¹ ì¼ì§€ì˜ ì „ì²´ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const allNotes = [];
        const studentsData = await window.getCachedData('students', () => 
            axios.get(`${API_BASE_URL}/api/students`).then(r => r.data)
        );
        
        for (const student of studentsData) {
            const response = await axios.get(`${API_BASE_URL}/api/class-notes/${student.id}`);
            allNotes.push(...(response.data || []));
        }
        
        const note = allNotes.find(n => n.id === noteId);
        if (!note) {
            window.showAlert('ì¼ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
        const rendered = marked.parse(note.content || '');
        const clean = DOMPurify.sanitize(rendered);
        
        const div = document.createElement('div');
        div.innerHTML = clean;
        div.querySelectorAll('a').forEach(link => {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
        });
        
        const dateStr = new Date(note.note_date).toLocaleDateString('ko-KR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'long'
        });
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white rounded-t-2xl">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-2xl font-bold mb-2">
                                <i class="fas fa-book-open mr-2"></i>
                                ${studentName}ë‹˜ì˜ SSIRNë©”ëª¨ì¥
                            </h3>
                            <p class="text-blue-100">${dateStr}</p>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="prose max-w-none">
                        ${div.innerHTML}
                    </div>
                    
                    <div class="mt-6 pt-4 border-t">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">
                            <i class="fas fa-times mr-2"></i>ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    } catch (error) {
        console.error('ì¼ì§€ ìƒì„¸ë³´ê¸° ì‹¤íŒ¨:', error);
        window.showAlert('ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    }
};

window.filterClassNotes = function() {
    if (!window.allClassNotes) return;
    
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    const studentFilter = document.getElementById('student-filter').value;
    const dateFilter = document.getElementById('date-filter').value;
    
    const filtered = window.allClassNotes.filter(note => {
        // ê²€ìƒ‰ í•„í„° (ë‚´ìš© ê²€ìƒ‰)
        if (searchFilter && !note.content.toLowerCase().includes(searchFilter)) {
            return false;
        }
        
        // í•™ìƒ í•„í„°
        if (studentFilter && note.student.id.toString() !== studentFilter) {
            return false;
        }
        
        // ë‚ ì§œ í•„í„°
        if (dateFilter && note.note_date !== dateFilter) {
            return false;
        }
        
        return true;
    });
    
    // í…Œì´ë¸” tbody ë‹¤ì‹œ ë Œë”ë§
    const tbody = document.getElementById('notes-tbody');
    if (!tbody) return;
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-12">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = filtered.map((note, index) => `
            <tr class="border-b hover:bg-blue-50 cursor-pointer transition-colors"
                onclick="showClassNoteDetail(${note.id}, '${note.student.name}')"
                data-student-id="${note.student.id}"
                data-note-date="${note.note_date}"
                data-content="${note.content.toLowerCase().replace(/"/g, '&quot;')}">
                <td class="px-6 py-4 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-user-circle mr-2 text-blue-500"></i>
                        <span class="font-medium">${note.student.name}</span>
                        <span class="ml-2 text-xs text-gray-500">(${note.student.code})</span>
                    </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">
                    <i class="fas fa-calendar-day mr-2 text-blue-500"></i>
                    ${new Date(note.note_date).toLocaleDateString('ko-KR')}
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">
                    <div class="truncate" style="max-width: 500px;">
                        ${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}
                    </div>
                </td>
                <td class="px-6 py-4 text-xs text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    ${new Date(note.created_at).toLocaleString('ko-KR', { 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })}
                </td>
            </tr>
        `).join('');
    }
};

window.clearClassNotesFilters = function() {
    document.getElementById('search-filter').value = '';
    document.getElementById('student-filter').value = '';
    document.getElementById('date-filter').value = '';
    filterClassNotes();
};

// ==================== ìƒë‹´ ê´€ë¦¬ ====================
async function loadCounselings() {
    try {
        window.showLoading('ìƒë‹´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const [counselingsData, studentsData, instructorsData, coursesData] = await Promise.all([
            window.getCachedData('counselings', () => axios.get(`${API_BASE_URL}/api/counselings`).then(r => r.data)),
            window.getCachedData('students', () => axios.get(`${API_BASE_URL}/api/students`).then(r => r.data)),
            window.getCachedData('instructors', () => axios.get(`${API_BASE_URL}/api/instructors`).then(r => r.data)),
            window.getCachedData('courses', () => axios.get(`${API_BASE_URL}/api/courses`).then(r => r.data))
        ]);
        counselings = counselingsData;
        students = studentsData;
        instructors = instructorsData;
        courses = coursesData;
        renderCounselings();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('ìƒë‹´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ìƒë‹´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderCounselings() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-comments mr-2"></i>ìƒë‹´ ê´€ë¦¬
            </h2>
            
            <!-- ê²€ìƒ‰ ë° í•„í„° -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">ê³¼ì • ì„ íƒ</label>
                        <select id="filter-course" class="w-full border rounded px-3 py-2" onchange="window.updateStudentsByCourse(); window.filterCounselings();">
                            <option value="">ì „ì²´ ê³¼ì •</option>
                            ${courses.sort((a, b) => (a.name || a.code).localeCompare(b.name || b.code, 'ko')).map(c => `<option value="${c.code}">${c.name || c.code}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">í•™ìƒ ì„ íƒ</label>
                        <select id="filter-student" class="w-full border rounded px-3 py-2" onchange="window.filterCounselings()">
                            <option value="">ì „ì²´ í•™ìƒ</option>
                            ${students.sort((a, b) => a.name.localeCompare(b.name, 'ko')).map(s => {
                                const counselingCount = counselings.filter(c => c.student_id === s.id).length;
                                return `<option value="${s.id}">${s.name} (${s.code}) - ${counselingCount}íšŒ</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">ìƒë‹´ ì„ ìƒë‹˜</label>
                        <select id="filter-instructor" class="w-full border rounded px-3 py-2" onchange="window.filterCounselings()">
                            <option value="">ì „ì²´</option>
                            ${instructors.sort((a, b) => a.name.localeCompare(b.name, 'ko')).map(i => `<option value="${i.code}">${i.name}-${i.instructor_type_name || 'ê°•ì‚¬'}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" id="filter-start-date" class="w-full border rounded px-3 py-2" onchange="window.filterCounselings()">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">ì¢…ë£Œ ë‚ ì§œ</label>
                        <input type="date" id="filter-end-date" class="w-full border rounded px-3 py-2" onchange="window.filterCounselings()">
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="filter-content" placeholder="ìƒë‹´ ë‚´ìš© ê²€ìƒ‰..." 
                           class="flex-1 border rounded px-3 py-2"
                           onkeyup="window.debouncedFilterCounselings()">
                    <button onclick="window.filterCounselings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                        <i class="fas fa-search mr-2"></i>ê²€ìƒ‰
                    </button>
                    <button onclick="window.resetCounselingFilters()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">
                        <i class="fas fa-redo mr-2"></i>ì´ˆê¸°í™”
                    </button>
                    <button onclick="window.showCounselingForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-plus mr-2"></i>ìƒë‹´ ì¶”ê°€
                    </button>
                    <button onclick="window.showCounselingExportOptions()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-file-export mr-2"></i>Excel ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button onclick="window.showCounselingExcelUpload()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-file-excel mr-2"></i>Excel ì—…ë¡œë“œ
                    </button>
                </div>
            </div>

            <div id="student-detail" class="hidden mb-6 p-4 bg-green-50 rounded-lg"></div>
            <div id="counseling-form" class="hidden mb-6 p-4 bg-blue-50 rounded-lg"></div>
            <div id="counseling-excel-upload" class="hidden mb-6 p-4 bg-purple-50 rounded-lg"></div>
            
            <!-- ìƒë‹´ ëª©ë¡ ê·¸ë¦¬ë“œ -->
            <div id="counseling-list">
                <p class="text-sm text-gray-600 mb-4">ì´ ${counselings.length}ê±´ì˜ ìƒë‹´</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-2 text-center text-xs w-12">ì‚¬ì§„</th>
                                ${sortableHeader([
                                    { key: 'consultation_date', label: 'ë‚ ì§œ' },
                                    { key: 'student_name', label: 'í•™ìƒ (ìƒë‹´íšŸìˆ˜)' },
                                    { key: 'instructor_name', label: 'ìƒë‹´ì„ ìƒë‹˜' },
                                    { key: 'consultation_type', label: 'ìœ í˜•' },
                                    { key: 'content', label: 'ìƒë‹´ë‚´ìš©' },
                                    { key: 'status', label: 'ìƒíƒœ' }
                                ], counselingSortKey, counselingSortAsc, 'window.sortCounselingTable')}
                                <th class="px-3 py-2 text-left text-xs">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${counselings.map(c => {
                                const studentCounselingCount = counselings.filter(item => item.student_id === c.student_id).length;
                                return `
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="px-2 py-2 text-center text-xs">
                                        ${c.photo_urls && JSON.parse(c.photo_urls || '[]').length > 0 ? `
                                            <button onclick='window.showPhotoViewer(${JSON.stringify(c.photo_urls)}, 0)' 
                                                    class="text-green-600 hover:text-green-700" 
                                                    title="${JSON.parse(c.photo_urls).length}ê°œ ì‚¬ì§„">
                                                <i class="fas fa-camera"></i>
                                            </button>
                                        ` : `
                                            <i class="fas fa-camera text-gray-300" title="ì‚¬ì§„ ì—†ìŒ"></i>
                                        `}
                                    </td>
                                    <td class="px-3 py-2 text-xs">${formatDateWithDay(c.consultation_date)}</td>
                                    <td class="px-3 py-2 text-xs">
                                        <button onclick="window.showStudentDetail(${c.student_id})" 
                                                class="text-blue-600 hover:underline">
                                            ${c.student_name} (${c.student_code})
                                        </button>
                                        <span class="ml-1 px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">
                                            ${studentCounselingCount}íšŒ
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-xs">${c.instructor_name || '-'}</td>
                                    <td class="px-3 py-2 text-xs">
                                        <span class="px-2 py-1 rounded text-xs ${
                                            c.consultation_type === 'ê¸´ê¸‰' ? 'bg-red-100 text-red-800' :
                                            c.consultation_type === 'ì •ê¸°' ? 'bg-blue-100 text-blue-800' :
                                            c.consultation_type === 'í•™ìƒìš”ì²­' ? 'bg-purple-100 text-purple-800' :
                                            'bg-gray-100 text-gray-800'
                                        }">
                                            ${c.consultation_type || 'ì •ê¸°'}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-xs max-w-xs truncate">${c.content || '-'}</td>
                                    <td class="px-3 py-2 text-xs">
                                        <span class="px-2 py-1 rounded text-xs ${
                                            c.status === 'ì™„ë£Œ' ? 'bg-green-100 text-green-800' :
                                            c.status === 'ì·¨ì†Œ' ? 'bg-gray-100 text-gray-800' :
                                            'bg-yellow-100 text-yellow-800'
                                        }">
                                            ${c.status || 'ì™„ë£Œ'}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-xs">
                                        <button onclick="window.editCounseling(${c.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="window.deleteCounseling(${c.id})" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

window.filterCounselings = async function() {
    // í•™ìƒ ìƒì„¸ì •ë³´ì™€ ìƒë‹´ ìˆ˜ì •ì°½ ë‹«ê¸°
    window.hideStudentDetail();
    window.hideCounselingForm();
    
    const courseCode = document.getElementById('filter-course').value;
    const studentId = document.getElementById('filter-student').value;
    const instructorCode = document.getElementById('filter-instructor').value;
    const startDate = document.getElementById('filter-start-date').value;
    const endDate = document.getElementById('filter-end-date').value;
    const contentSearch = document.getElementById('filter-content').value;
    
    try {
        let url = `${API_BASE_URL}/api/counselings?`;
        if (studentId) url += `student_id=${studentId}&`;
        if (courseCode) url += `course_code=${courseCode}&`;
        
        const response = await axios.get(url);
        let filtered = response.data;
        
        // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¶”ê°€ í•„í„°ë§
        if (instructorCode) {
            filtered = filtered.filter(c => c.instructor_code === instructorCode);
        }
        if (startDate) {
            filtered = filtered.filter(c => c.consultation_date >= startDate);
        }
        if (endDate) {
            filtered = filtered.filter(c => c.consultation_date <= endDate);
        }
        if (contentSearch) {
            const search = contentSearch.toLowerCase();
            filtered = filtered.filter(c => 
                (c.content && c.content.toLowerCase().includes(search)) ||
                (c.main_topic && c.main_topic.toLowerCase().includes(search))
            );
        }
        
        // í—¤ë” ì •ë ¬ ì ìš©
        filtered = genericSort(filtered, counselingSortKey, counselingSortAsc);
        
        counselings = filtered;
        
        // ëª©ë¡ë§Œ ë‹¤ì‹œ ë Œë”ë§
        const listDiv = document.getElementById('counseling-list');
        listDiv.innerHTML = `
            <p class="text-sm text-gray-600 mb-4">ì´ ${counselings.length}ê±´ì˜ ìƒë‹´</p>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-2 text-center text-xs w-12">ì‚¬ì§„</th>
                            ${sortableHeader([
                                { key: 'consultation_date', label: 'ë‚ ì§œ' },
                                { key: 'student_name', label: 'í•™ìƒ (ìƒë‹´íšŸìˆ˜)' },
                                { key: 'instructor_name', label: 'ìƒë‹´ì„ ìƒë‹˜' },
                                { key: 'consultation_type', label: 'ìœ í˜•' },
                                { key: 'content', label: 'ìƒë‹´ë‚´ìš©' },
                                { key: 'status', label: 'ìƒíƒœ' }
                            ], counselingSortKey, counselingSortAsc, 'window.sortCounselingTable')}
                            <th class="px-3 py-2 text-left text-xs">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${counselings.map(c => {
                            const studentCounselingCount = counselings.filter(item => item.student_id === c.student_id).length;
                            return `
                            <tr class="border-t hover:bg-gray-50">
                                <td class="px-2 py-2 text-center text-xs">
                                    ${c.photo_urls && JSON.parse(c.photo_urls || '[]').length > 0 ? `
                                        <i class="fas fa-camera text-green-600" title="${JSON.parse(c.photo_urls).length}ê°œ ì‚¬ì§„"></i>
                                    ` : `
                                        <i class="fas fa-camera text-gray-300" title="ì‚¬ì§„ ì—†ìŒ"></i>
                                    `}
                                </td>
                                <td class="px-3 py-2 text-xs">${formatDateWithDay(c.consultation_date)}</td>
                                <td class="px-3 py-2 text-xs">
                                    <button onclick="window.showStudentDetail(${c.student_id})" 
                                            class="text-blue-600 hover:underline">
                                        ${c.student_name} (${c.student_code})
                                    </button>
                                    <span class="ml-1 px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">
                                        ${studentCounselingCount}íšŒ
                                    </span>
                                </td>
                                <td class="px-3 py-2 text-xs">${c.instructor_name || '-'}</td>
                                <td class="px-3 py-2 text-xs">
                                    <span class="px-2 py-1 rounded text-xs ${
                                        c.consultation_type === 'ê¸´ê¸‰' ? 'bg-red-100 text-red-800' :
                                        c.consultation_type === 'ì •ê¸°' ? 'bg-blue-100 text-blue-800' :
                                        c.consultation_type === 'í•™ìƒìš”ì²­' ? 'bg-purple-100 text-purple-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">
                                        ${c.consultation_type || 'ì •ê¸°'}
                                    </span>
                                </td>
                                <td class="px-3 py-2 text-xs max-w-xs truncate">${c.content || '-'}</td>
                                <td class="px-3 py-2 text-xs">
                                    <span class="px-2 py-1 rounded text-xs ${
                                        c.status === 'ì™„ë£Œ' ? 'bg-green-100 text-green-800' :
                                        c.status === 'ì·¨ì†Œ' ? 'bg-gray-100 text-gray-800' :
                                        'bg-yellow-100 text-yellow-800'
                                    }">
                                        ${c.status || 'ì™„ë£Œ'}
                                    </span>
                                </td>
                                <td class="px-3 py-2 text-xs">
                                    <button onclick="window.editCounseling(${c.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.deleteCounseling(${c.id})" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('ìƒë‹´ í•„í„°ë§ ì‹¤íŒ¨:', error);
    }
}

window.resetCounselingFilters = function() {
    // í•™ìƒ ìƒì„¸ì •ë³´ì™€ ìƒë‹´ ìˆ˜ì •ì°½ ë‹«ê¸°
    window.hideStudentDetail();
    window.hideCounselingForm();
    
    document.getElementById('filter-course').value = '';
    document.getElementById('filter-student').value = '';
    document.getElementById('filter-instructor').value = '';
    document.getElementById('filter-start-date').value = '';
    document.getElementById('filter-end-date').value = '';
    document.getElementById('filter-content').value = '';
    window.updateStudentsByCourse();
    loadCounselings();
}

window.updateStudentsByCourse = function() {
    const courseCode = document.getElementById('filter-course').value;
    const studentSelect = document.getElementById('filter-student');
    
    // í•™ìƒ ëª©ë¡ í•„í„°ë§
    const filteredStudents = courseCode 
        ? students.filter(s => s.course_code === courseCode)
        : students;
    
    // í•™ìƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    studentSelect.innerHTML = `
        <option value="">ì „ì²´ í•™ìƒ</option>
        ${filteredStudents.map(s => `<option value="${s.id}">${s.name} (${s.code})</option>`).join('')}
    `;
}

window.showStudentDetail = async function(studentId) {
    try {
        // ìƒë‹´ ìˆ˜ì •ì°½ ë‹«ê¸°
        window.hideCounselingForm();
        
        // ê¸°ì¡´ ìƒì„¸ ì •ë³´ ì´ˆê¸°í™”
        const detailDiv = document.getElementById('student-detail');
        detailDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        detailDiv.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                <div class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-user-circle text-6xl text-blue-500 animate-pulse"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">í•™ìƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
                    <p class="text-gray-600 mb-4">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                    
                    <!-- í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2.5 rounded-full animate-progress"></div>
                    </div>
                    
                    <style>
                        @keyframes progress {
                            0% { width: 0%; }
                            50% { width: 70%; }
                            100% { width: 100%; }
                        }
                        .animate-progress {
                            animation: progress 2s ease-in-out infinite;
                        }
                    </style>
                </div>
            </div>
        `;
        detailDiv.classList.remove('hidden');
        
        // í•™ìƒ ì •ë³´ ì¡°íšŒ
        const studentRes = await axios.get(`${API_BASE_URL}/api/students/${studentId}`);
        const student = studentRes.data;
        
        // í•´ë‹¹ í•™ìƒì˜ ìƒë‹´ ì´ë ¥ ì¡°íšŒ
        const counselingRes = await axios.get(`${API_BASE_URL}/api/counselings?student_id=${studentId}`);
        const studentCounselings = counselingRes.data;
        
        // ê³¼ì • ì •ë³´ ì¡°íšŒ
        let courseInfo = '';
        if (student.course_code) {
            try {
                const courseRes = await axios.get(`${API_BASE_URL}/api/courses`);
                const course = courseRes.data.find(c => c.code === student.course_code);
                if (course) {
                    courseInfo = `${course.code} - ${course.name || course.code}`;
                } else {
                    courseInfo = student.course_code;
                }
            } catch (e) {
                courseInfo = student.course_code;
            }
        }
        
        // ì„±ë³„ì— ë”°ë¥¸ ê¸°ë³¸ í”„ë¡œí•„ ì´ë¯¸ì§€
        const getDefaultProfileImage = (gender) => {
            if (gender === 'ë‚¨' || gender === 'ë‚¨ì' || gender === 'M' || gender === 'male') {
                return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"%3E%3Cdefs%3E%3ClinearGradient id="grad1" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%234A90E2;stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:%2367B8E3;stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="200" height="200" fill="url(%23grad1)"/%3E%3Ccircle cx="100" cy="70" r="35" fill="white" opacity="0.9"/%3E%3Cpath d="M 100 110 Q 70 110 60 140 L 60 200 L 140 200 L 140 140 Q 130 110 100 110 Z" fill="white" opacity="0.9"/%3E%3C/svg%3E';
            } else if (gender === 'ì—¬' || gender === 'ì—¬ì' || gender === 'F' || gender === 'female') {
                return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"%3E%3Cdefs%3E%3ClinearGradient id="grad2" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23EC4899;stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:%23F472B6;stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="200" height="200" fill="url(%23grad2)"/%3E%3Ccircle cx="100" cy="70" r="35" fill="white" opacity="0.9"/%3E%3Cpath d="M 100 110 Q 70 110 60 140 L 60 200 L 140 200 L 140 140 Q 130 110 100 110 Z" fill="white" opacity="0.9"/%3E%3C/svg%3E';
            }
            return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"%3E%3Cdefs%3E%3ClinearGradient id="grad3" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%236B7280;stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:%239CA3AF;stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="200" height="200" fill="url(%23grad3)"/%3E%3Ccircle cx="100" cy="70" r="35" fill="white" opacity="0.9"/%3E%3Cpath d="M 100 110 Q 70 110 60 140 L 60 200 L 140 200 L 140 140 Q 130 110 100 110 Z" fill="white" opacity="0.9"/%3E%3C/svg%3E';
        };
        
        // detailDivëŠ” í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨
        detailDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        detailDiv.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-[95vh] overflow-y-auto">
                <!-- í—¤ë” -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-5 rounded-t-2xl flex justify-between items-center sticky top-0 z-10 shadow-lg">
                    <div class="flex items-center gap-4">
                        <i class="fas fa-id-card text-3xl"></i>
                        <div>
                            <h3 class="text-2xl font-bold">í•™ìƒ ìƒì„¸ë³´ê¸°</h3>
                            <p class="text-sm text-blue-100 mt-1">${student.name} (${student.code})</p>
                        </div>
                    </div>
                    <button onclick="window.hideStudentDetail()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-3 transition-all transform hover:scale-110">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="p-8">
                    <!-- ìµœìƒë‹¨: í”„ë¡œí•„ ì¹´ë“œ -->
                    <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 rounded-2xl p-8 mb-6 shadow-md border border-blue-100">
                        <div class="flex gap-8">
                            <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
                            <div class="flex-shrink-0">
                                <div class="relative">
                                    ${(() => {
                                        let photoUrl = getDefaultProfileImage(student.gender);
                                        if (student.profile_photo) {
                                            photoUrl = API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(student.profile_photo);
                                        }
                                        return `<img src="${photoUrl}" 
                                                     alt="${student.name}" 
                                                     class="w-48 h-48 object-cover rounded-2xl shadow-2xl border-4 border-white"
                                                     onerror="this.src='${getDefaultProfileImage(student.gender)}'">`;
                                    })()}
                                    <div class="absolute -bottom-3 -right-3 bg-white rounded-full p-3 shadow-lg">
                                        <i class="fas ${student.gender === 'ë‚¨' || student.gender === 'ë‚¨ì' ? 'fa-mars text-blue-500' : student.gender === 'ì—¬' || student.gender === 'ì—¬ì' ? 'fa-venus text-pink-500' : 'fa-user text-gray-500'} text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ê¸°ë³¸ ì •ë³´ -->
                            <div class="flex-1">
                                <div class="mb-6">
                                    <h4 class="text-3xl font-bold text-gray-800 mb-2">
                                        ${student.name}
                                        <span class="text-xl text-gray-500 font-normal ml-3">${student.code}</span>
                                    </h4>
                                    <div class="flex gap-3 mt-3">
                                        <span class="px-4 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
                                            <i class="fas fa-venus-mars mr-1"></i>${student.gender || 'ë¯¸ë“±ë¡'}
                                        </span>
                                        <span class="px-4 py-1.5 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">
                                            <i class="fas fa-university mr-1"></i>${student.campus || 'ë¯¸ì •'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                        <p class="text-xs text-gray-500 mb-1 flex items-center">
                                            <i class="fas fa-birthday-cake mr-2 text-blue-500"></i>ìƒë…„ì›”ì¼
                                        </p>
                                        <p class="font-bold text-gray-800 text-lg">${student.birth_date ? formatDateWithDay(student.birth_date) : '-'}</p>
                                    </div>
                                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                        <p class="text-xs text-gray-500 mb-1 flex items-center">
                                            <i class="fas fa-graduation-cap mr-2 text-green-500"></i>í•™ë ¥
                                        </p>
                                        <p class="font-bold text-gray-800 text-lg">${student.education || '-'}</p>
                                    </div>
                                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                        <p class="text-xs text-gray-500 mb-1 flex items-center">
                                            <i class="fas fa-calendar-check mr-2 text-orange-500"></i>ë“±ë¡ì¼
                                        </p>
                                        <p class="font-bold text-gray-800 text-lg">${student.registered_at ? formatDateWithDay(student.registered_at.split('T')[0]) : '-'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2ë‹¨: ê³¼ì • ì •ë³´ & ì—°ë½ì²˜ -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- ê³¼ì • ì •ë³´ -->
                        <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                            <h4 class="text-xl font-bold text-gray-800 mb-5 flex items-center border-b pb-3">
                                <div class="bg-blue-500 rounded-lg p-2 mr-3">
                                    <i class="fas fa-book-reader text-white"></i>
                                </div>
                                ê³¼ì • ì •ë³´
                            </h4>
                            <div class="space-y-4">
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border-l-4 border-blue-500">
                                    <p class="text-sm text-gray-600 mb-2 font-semibold">ìˆ˜ê°• ê³¼ì •</p>
                                    <p class="font-bold text-blue-700 text-xl">${courseInfo || '-'}</p>
                                </div>
                                <div class="bg-gray-50 p-5 rounded-xl">
                                    <p class="text-sm text-gray-600 mb-2 font-semibold flex items-center">
                                        <i class="fas fa-heart text-pink-500 mr-2"></i>ê´€ì‹¬ë¶„ì•¼
                                    </p>
                                    <p class="font-semibold text-gray-800 text-lg">${student.interests || '-'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì—°ë½ì²˜ ì •ë³´ -->
                        <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                            <h4 class="text-xl font-bold text-gray-800 mb-5 flex items-center border-b pb-3">
                                <div class="bg-green-500 rounded-lg p-2 mr-3">
                                    <i class="fas fa-address-book text-white"></i>
                                </div>
                                ì—°ë½ì²˜ ì •ë³´
                            </h4>
                            <div class="space-y-4">
                                <div class="bg-green-50 p-5 rounded-xl border-l-4 border-green-500">
                                    <p class="text-sm text-gray-600 mb-2 font-semibold flex items-center">
                                        <i class="fas fa-phone text-green-600 mr-2"></i>ì „í™”ë²ˆí˜¸
                                    </p>
                                    <p class="font-bold text-gray-800 text-xl">${student.phone ? normalizePhone(student.phone) : '-'}</p>
                                </div>
                                <div class="bg-blue-50 p-5 rounded-xl border-l-4 border-blue-500">
                                    <p class="text-sm text-gray-600 mb-2 font-semibold flex items-center">
                                        <i class="fas fa-envelope text-blue-600 mr-2"></i>ì´ë©”ì¼
                                    </p>
                                    <p class="font-semibold text-gray-800 text-lg break-all">${student.email || '-'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3ë‹¨: ì£¼ì†Œ -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6 border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-5 flex items-center border-b pb-3">
                            <div class="bg-orange-500 rounded-lg p-2 mr-3">
                                <i class="fas fa-map-marker-alt text-white"></i>
                            </div>
                            ì£¼ì†Œ
                        </h4>
                        <div class="bg-orange-50 p-5 rounded-xl border-l-4 border-orange-500 mb-4">
                            <p class="font-semibold text-gray-800 text-lg">${student.address || 'ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤'}</p>
                        </div>
                        ${student.address ? `
                            <!-- êµ¬ê¸€ ì§€ë„ -->
                            <div class="rounded-xl overflow-hidden shadow-md border-2 border-gray-200">
                                <iframe
                                    width="100%"
                                    height="300"
                                    style="border:0"
                                    loading="lazy"
                                    allowfullscreen
                                    referrerpolicy="no-referrer-when-downgrade"
                                    src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(student.address)}&zoom=15&language=ko">
                                </iframe>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- 4ë‹¨: ìê¸°ì†Œê°œ & ë¹„ê³  -->
                    <div class="grid grid-cols-1 ${student.introduction || student.self_introduction ? 'lg:grid-cols-2' : ''} gap-6">
                        ${student.introduction || student.self_introduction ? `
                            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                                <h4 class="text-xl font-bold text-gray-800 mb-5 flex items-center border-b pb-3">
                                    <div class="bg-purple-500 rounded-lg p-2 mr-3">
                                        <i class="fas fa-user-edit text-white"></i>
                                    </div>
                                    ìê¸°ì†Œê°œ
                                </h4>
                                <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl border-l-4 border-purple-500 min-h-[150px]">
                                    <p class="text-gray-700 whitespace-pre-wrap leading-relaxed text-base">${student.introduction || student.self_introduction}</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${student.notes ? `
                            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                                <h4 class="text-xl font-bold text-gray-800 mb-5 flex items-center border-b pb-3">
                                    <div class="bg-yellow-500 rounded-lg p-2 mr-3">
                                        <i class="fas fa-sticky-note text-white"></i>
                                    </div>
                                    ë¹„ê³  ë° íŠ¹ì´ì‚¬í•­
                                </h4>
                                <div class="bg-yellow-50 p-6 rounded-xl border-l-4 border-yellow-500 min-h-[150px]">
                                    <p class="text-gray-700 whitespace-pre-wrap leading-relaxed text-base">${student.notes}</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- ì²¨ë¶€ íŒŒì¼ ì„¹ì…˜ -->
                    ${(() => {
                        try {
                            const attachments = student.attachments ? (typeof student.attachments === 'string' ? JSON.parse(student.attachments) : student.attachments) : [];
                            if (attachments && attachments.length > 0) {
                                return `
                                    <div class="bg-white rounded-xl shadow-md p-6 mt-6 border border-gray-200">
                                        <h4 class="text-xl font-bold text-gray-800 mb-5 flex items-center border-b pb-3">
                                            <div class="bg-indigo-500 rounded-lg p-2 mr-3">
                                                <i class="fas fa-paperclip text-white"></i>
                                            </div>
                                            ì²¨ë¶€ íŒŒì¼ (${attachments.length}/20)
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            ${attachments.map((fileUrl, index) => {
                                                const urlParts = fileUrl.split('#');
                                                const cleanUrl = urlParts[0];
                                                const originalFilename = urlParts[1] ? decodeURIComponent(urlParts[1]) : cleanUrl.split('/').pop();
                                                const ext = cleanUrl.split('.').pop().toLowerCase().split('?')[0];
                                                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext);
                                                const isPDF = ext === 'pdf';
                                                
                                                return `
                                                    <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-all">
                                                        <div class="flex items-center gap-3 mb-3">
                                                            <div class="flex-shrink-0 w-12 h-12 rounded-lg bg-gradient-to-br ${isImage ? 'from-blue-500 to-indigo-600' : isPDF ? 'from-red-500 to-pink-600' : 'from-gray-500 to-gray-600'} flex items-center justify-center shadow-md">
                                                                <i class="fas ${isImage ? 'fa-image' : isPDF ? 'fa-file-pdf' : 'fa-file'} text-white text-xl"></i>
                                                            </div>
                                                            <div class="flex-1 min-w-0">
                                                                <p class="text-sm font-semibold text-gray-800 truncate" title="${originalFilename}">
                                                                    ${originalFilename}
                                                                </p>
                                                                <p class="text-xs text-gray-500 mt-1">
                                                                    ${isImage ? 'ì´ë¯¸ì§€' : isPDF ? 'PDF ë¬¸ì„œ' : 'ë¬¸ì„œ'} íŒŒì¼
                                                                </p>
                                                            </div>
                                                        </div>
                                                        ${isImage ? `
                                                            <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(cleanUrl)}" 
                                                                 alt="${originalFilename}"
                                                                 class="w-full h-32 object-cover rounded-lg mb-3 border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity"
                                                                 onclick="window.openFileModal('${cleanUrl}', '${originalFilename}')">
                                                        ` : ''}
                                                        <div class="flex gap-2">
                                                            ${isImage || isPDF ? `
                                                                <button onclick="window.openFileModal('${cleanUrl}', '${originalFilename}')" 
                                                                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                                                    <i class="fas fa-eye mr-1"></i>ë¯¸ë¦¬ë³´ê¸°
                                                                </button>
                                                            ` : ''}
                                                            <button onclick="window.downloadFile('${cleanUrl}', '${originalFilename}')" 
                                                                    class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                                                <i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ
                                                            </button>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                            return '';
                        } catch (e) {
                            console.error('ì²¨ë¶€ íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜:', e);
                            return '';
                        }
                    })()}
                </div>
            </div>
        `;
    } catch (error) {
        console.error('í•™ìƒ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
        const detailDiv = document.getElementById('student-detail');
        detailDiv.innerHTML = '<div class="p-4 text-center text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

window.hideStudentDetail = function() {
    document.getElementById('student-detail').classList.add('hidden');
}

// ìƒë‹´ Excel ë‚´ë³´ë‚´ê¸° ì˜µì…˜
window.showCounselingExportOptions = function() {
    const courseOptions = courses.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
    window.showModal('ìƒë‹´ Excel ë‚´ë³´ë‚´ê¸°', `
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2 font-medium">ë‚´ë³´ë‚¼ ê³¼ì • ì„ íƒ</label>
                <select id="export-counseling-course" class="w-full border rounded px-3 py-2">
                    <option value="">ì „ì²´ ê³¼ì •</option>
                    ${courseOptions}
                </select>
            </div>
            <p class="text-sm text-gray-500"><i class="fas fa-info-circle mr-1"></i>ì„ íƒí•œ ê³¼ì •ì˜ ìƒë‹´ ë‚´ì—­ì„ Excelë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="window.closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="window.exportCounselingsToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i>ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </div>
    `);
}

window.exportCounselingsToExcel = function() {
    const courseCode = document.getElementById('export-counseling-course')?.value;
    let exportData = [...counselings];
    let fileName = 'ìƒë‹´ë‚´ì—­_ì „ì²´';

    if (courseCode) {
        const courseStudentIds = students.filter(s => s.course_code === courseCode).map(s => s.id);
        exportData = counselings.filter(c => courseStudentIds.includes(c.student_id));
        const courseName = courses.find(c => c.code === courseCode)?.name || courseCode;
        fileName = `ìƒë‹´ë‚´ì—­_${courseName}`;
    }

    if (exportData.length === 0) {
        window.showAlert('ë‚´ë³´ë‚¼ ìƒë‹´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    exportData.sort((a, b) => (b.date || '').localeCompare(a.date || ''));

    const excelData = exportData.map((c, idx) => {
        const student = students.find(s => s.id === c.student_id);
        const instructor = instructors.find(i => i.code === c.instructor_code);
        return {
            'No': idx + 1,
            'ìƒë‹´ì¼ì': c.date || '',
            'í•™ìƒì½”ë“œ': student?.code || '',
            'í•™ìƒëª…': student?.name || '',
            'ê³¼ì •': courses.find(co => co.code === student?.course_code)?.name || '',
            'ìƒë‹´ì„ ìƒë‹˜': instructor?.name || '',
            'ìƒë‹´ìœ í˜•': c.type || '',
            'ìƒë‹´ë‚´ìš©': c.content || '',
            'ìƒíƒœ': c.status || '',
            'ë¹„ê³ ': c.note || ''
        };
    });

    const ws = XLSX.utils.json_to_sheet(excelData);
    ws['!cols'] = [{ wch: 5 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 50 }, { wch: 10 }, { wch: 20 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ìƒë‹´ë‚´ì—­');
    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(wb, `${fileName}_${today}.xlsx`);
    window.closeModal();
    window.showAlert(`${exportData.length}ê±´ì˜ ìƒë‹´ ë‚´ì—­ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
}

// ìƒë‹´ Excel ì—…ë¡œë“œ UI
window.showCounselingExcelUpload = function() {
    const div = document.getElementById('counseling-excel-upload');
    div.classList.remove('hidden');
    div.innerHTML = `
        <h3 class="text-lg font-bold mb-4">ìƒë‹´ Excel ì¼ê´„ ì—…ë¡œë“œ</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2">Excel íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="counseling-excel-file" accept=".xlsx,.xls" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                í•„ìˆ˜ ì»¬ëŸ¼: ìƒë‹´ì¼ì, í•™ìƒì½”ë“œ ë˜ëŠ” í•™ìƒëª… | ì„ íƒ: ìƒë‹´ì„ ìƒë‹˜, ìƒë‹´ìœ í˜•, ìƒë‹´ë‚´ìš©, ìƒíƒœ
            </p>
            <div class="space-x-2">
                <button onclick="window.uploadCounselingExcel()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-upload mr-2"></i>ì—…ë¡œë“œ
                </button>
                <button onclick="window.hideCounselingExcelUpload()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
            </div>
        </div>
    `;
}

window.hideCounselingExcelUpload = function() {
    document.getElementById('counseling-excel-upload').classList.add('hidden');
}

window.uploadCounselingExcel = async function() {
    const fileInput = document.getElementById('counseling-excel-file');
    const file = fileInput?.files[0];
    if (!file) { window.showAlert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning'); return; }

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (jsonData.length === 0) { window.showAlert('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning'); return; }

        let successCount = 0, failCount = 0;
        for (const row of jsonData) {
            const date = row['ìƒë‹´ì¼ì'] || row['date'] || '';
            const studentCode = row['í•™ìƒì½”ë“œ'] || row['student_code'] || '';
            const studentName = row['í•™ìƒëª…'] || row['student_name'] || '';
            const student = studentCode ? students.find(s => s.code === studentCode) : students.find(s => s.name === studentName);

            if (!student) { failCount++; continue; }

            const instructorName = row['ìƒë‹´ì„ ìƒë‹˜'] || row['instructor'] || '';
            const instructor = instructors.find(i => i.name === instructorName);

            const counselingData = {
                date: date,
                student_id: student.id,
                instructor_code: instructor?.code || '',
                type: row['ìƒë‹´ìœ í˜•'] || row['type'] || '',
                content: row['ìƒë‹´ë‚´ìš©'] || row['content'] || '',
                status: row['ìƒíƒœ'] || row['status'] || 'ì§„í–‰ì¤‘',
                note: row['ë¹„ê³ '] || row['note'] || ''
            };

            try {
                await axios.post(`${API_BASE_URL}/api/counselings`, counselingData);
                successCount++;
            } catch (e) { failCount++; }
        }

        await loadData();
        renderCounselings();
        window.hideCounselingExcelUpload();
        window.showAlert(`ì—…ë¡œë“œ ì™„ë£Œ! ì„±ê³µ: ${successCount}ê±´, ì‹¤íŒ¨: ${failCount}ê±´`, successCount > 0 ? 'success' : 'warning');
    } catch (error) {
        console.error('Excel íŒŒì‹± ì‹¤íŒ¨:', error);
        window.showAlert('Excel íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

window.showCounselingForm = function(counselingId = null) {
    const formDiv = document.getElementById('counseling-form');
    const existingCounseling = counselingId ? counselings.find(c => c.id === counselingId) : null;
    
    // ê¸°ì¡´ ë°ì´í„°ì— main_topicì´ ìˆìœ¼ë©´ contentì™€ í•©ì¹¨
    let mergedContent = existingCounseling?.content || '';
    if (existingCounseling?.main_topic && !mergedContent.includes(existingCounseling.main_topic)) {
        mergedContent = `[${existingCounseling.main_topic}]\n\n${mergedContent}`;
    }
    
    formDiv.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-semibold">${counselingId ? 'ìƒë‹´ ìˆ˜ì •' : 'ìƒë‹´ ì¶”ê°€'}</h3>
            <button onclick="window.hideCounselingForm()" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="counseling-save-form">
            <input type="hidden" id="counseling-id" value="${counselingId || ''}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 mb-2">í•™ìƒ ì„ íƒ *</label>
                    <select name="student_id" required class="w-full px-3 py-2 border rounded-lg">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        ${(() => {
                            // í˜„ì¬ ì„ íƒëœ ê³¼ì • í•„í„° ê°€ì ¸ì˜¤ê¸°
                            const courseFilter = document.getElementById('filter-course')?.value || '';
                            let filteredStudents = students;
                            
                            // ê³¼ì • í•„í„° ì ìš©
                            if (courseFilter) {
                                filteredStudents = students.filter(s => s.course_code === courseFilter);
                            }
                            
                            // ì´ë¦„ìˆœ ì •ë ¬
                            return filteredStudents.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko')).map(s => {
                                const course = courses.find(c => c.code === s.course_code);
                                const courseName = course ? course.name || course.code : '-';
                                return `
                                    <option value="${s.id}" ${existingCounseling?.student_id === s.id ? 'selected' : ''}>
                                        ${s.name}(${s.code}) - ${courseName} - ${s.birth_date ? s.birth_date.split('T')[0] : '-'} - ${s.final_school || '-'}
                                    </option>
                                `;
                            }).join('');
                        })()}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ìƒë‹´ ì„ ìƒë‹˜ *</label>
                    <select name="instructor_code" required class="w-full px-3 py-2 border rounded-lg">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        ${[...instructors].sort((a, b) => a.name.localeCompare(b.name, 'ko')).map(i => {
                            const loggedInInstructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
                            const isLoggedInInstructor = i.code === loggedInInstructor.code;
                            const isSelected = existingCounseling?.instructor_code === i.code || (!existingCounseling && isLoggedInInstructor);
                            return `
                            <option value="${i.code}" ${isSelected ? 'selected' : ''}>
                                ${i.name}-${i.instructor_type_name || 'ê°•ì‚¬'}${isLoggedInInstructor ? ' (ë‚˜)' : ''}
                            </option>
                        `}).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ìƒë‹´ ë‚ ì§œ *</label>
                    <input type="date" name="consultation_date" 
                           value="${existingCounseling?.consultation_date?.substring(0, 10) || new Date().toISOString().split('T')[0]}" 
                           placeholder="${new Date().toISOString().split('T')[0]}"
                           required class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ìƒë‹´ ìœ í˜•</label>
                    <select name="consultation_type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="ì •ê¸°" ${existingCounseling?.consultation_type === 'ì •ê¸°' ? 'selected' : ''}>ì •ê¸°</option>
                        <option value="ìˆ˜ì‹œ" ${existingCounseling?.consultation_type === 'ìˆ˜ì‹œ' ? 'selected' : ''}>ìˆ˜ì‹œ</option>
                        <option value="ê¸´ê¸‰" ${existingCounseling?.consultation_type === 'ê¸´ê¸‰' ? 'selected' : ''}>ê¸´ê¸‰</option>
                        <option value="í•™ë¶€ëª¨" ${existingCounseling?.consultation_type === 'í•™ë¶€ëª¨' ? 'selected' : ''}>í•™ë¶€ëª¨</option>
                        <option value="í•™ìƒìš”ì²­" ${existingCounseling?.consultation_type === 'í•™ìƒìš”ì²­' ? 'selected' : ''}>í•™ìƒìš”ì²­</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ìƒíƒœ</label>
                    <select name="status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="ì˜ˆì •" ${existingCounseling?.status === 'ì˜ˆì •' ? 'selected' : ''}>ì˜ˆì •</option>
                        <option value="ì™„ë£Œ" ${existingCounseling?.status === 'ì™„ë£Œ' ? 'selected' : ''}>ì™„ë£Œ</option>
                        <option value="ì·¨ì†Œ" ${existingCounseling?.status === 'ì·¨ì†Œ' ? 'selected' : ''}>ì·¨ì†Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ì§„ë¡œê²°ì •</label>
                    <select name="career_decision" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">-- ì„ íƒ ì•ˆ í•¨ --</option>
                        <option value="1. í•™ì—…" ${existingCounseling?.career_decision === '1. í•™ì—…' ? 'selected' : ''}>1. í•™ì—…</option>
                        <option value="2. ì·¨ì—…" ${existingCounseling?.career_decision === '2. ì·¨ì—…' ? 'selected' : ''}>2. ì·¨ì—…</option>
                        <option value="3. ì°½ì—…" ${existingCounseling?.career_decision === '3. ì°½ì—…' ? 'selected' : ''}>3. ì°½ì—…</option>
                        <option value="4. ë¯¸ì •" ${existingCounseling?.career_decision === '4. ë¯¸ì •' ? 'selected' : ''}>4. ë¯¸ì •</option>
                        <option value="5. ê¸°íƒ€" ${existingCounseling?.career_decision === '5. ê¸°íƒ€' ? 'selected' : ''}>5. ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-700 mb-2">ìƒë‹´ ë‚´ìš© *</label>
                    <textarea name="content" rows="6" required placeholder="ìƒë‹´ ë‚´ìš©ì„ ìƒì„¸íˆ ì‘ì„±í•˜ì„¸ìš”..." 
                              class="w-full px-3 py-2 border rounded-lg">${mergedContent}</textarea>
                </div>
                
                <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                <div class="col-span-2">
                    <label class="block text-gray-700 mb-2">
                        <i class="fas fa-paperclip mr-2"></i>ì‚¬ì§„ ë° íŒŒì¼ ì²¨ë¶€ (ê·¸ë¦¼íŒŒì¼, PDF, HWP, PPT, Excel, Word, TXT ë“±)
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" onclick="document.getElementById('counseling-file-input').click()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                            </button>
                            <button type="button" onclick="document.getElementById('counseling-camera-input').click()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                                <i class="fas fa-camera mr-2"></i>ì‚¬ì§„ ì´¬ì˜
                            </button>
                        </div>
                        <div id="counseling-upload-progress" class="hidden mb-3">
                            <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                <p class="text-sm text-blue-800 mb-2">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>
                                    ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                                </p>
                                <div class="w-full bg-blue-200 rounded-full h-2">
                                    <div id="counseling-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <input type="file" id="counseling-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                               onchange="window.handleCounselingImageUpload(event)" class="hidden">
                        <input type="file" id="counseling-camera-input" accept="image/*"  
                               onchange="window.handleCounselingImageUpload(event)" class="hidden">
                        <div id="counseling-photos-preview" class="flex flex-col gap-2 mt-2">
                            ${existingCounseling?.photo_urls ? JSON.parse(existingCounseling.photo_urls).map((url, idx) => `
                                <div class="relative group">
                                    <img src="${url}" class="w-full h-24 object-cover rounded border">
                                    <button type="button" onclick="window.removeCounselingPhoto(${idx})" 
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                        <i class="fas fa-times text-xs"></i>
                                    </button>
                                </div>
                            `).join('') : ''}
                        </div>
                        <input type="hidden" id="counseling-photo-urls" value='${existingCounseling?.photo_urls || "[]"}'>
                        <p class="text-sm text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ìµœëŒ€ 20MB, ì´ë¯¸ì§€/PDF í˜•ì‹ (ì´ë¯¸ì§€ëŠ” ìë™ ì••ì¶•)
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-4 space-x-2">
                <button type="button" onclick="window.saveCounseling(${counselingId || 'null'})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>ì €ì¥
                </button>
                <button type="button" onclick="window.hideCounselingForm()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                    ì·¨ì†Œ
                </button>
            </div>
        </form>
    `;
    
    formDiv.classList.remove('hidden');
    formDiv.scrollIntoView({ behavior: 'smooth' });
    window.disableFilters(); // í•„í„° ë¹„í™œì„±í™”
    
    // ê¸°ì¡´ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    if (existingCounseling && existingCounseling.photo_urls) {
        try {
            const photoUrls = typeof existingCounseling.photo_urls === 'string' 
                ? JSON.parse(existingCounseling.photo_urls) 
                : existingCounseling.photo_urls;
            updateCounselingPhotoPreview(photoUrls);
        } catch (e) {
            console.error('ì‚¬ì§„ URL íŒŒì‹± ì˜¤ë¥˜:', e);
        }
    }
}

window.hideCounselingForm = function() {
    const formDiv = document.getElementById('counseling-form');
    if (formDiv) {
        formDiv.classList.add('hidden');
    }
    window.enableFilters(); // í•„í„° í™œì„±í™”
}

window.saveCounseling = async function(counselingId, autoSave = false) {
    const form = document.getElementById('counseling-save-form');
    const formData = new FormData(form);
    const photoUrls = document.getElementById('counseling-photo-urls').value || '[]';
    
    const data = {
        student_id: parseInt(formData.get('student_id')),
        instructor_code: formData.get('instructor_code'),
        consultation_date: formData.get('consultation_date'),
        consultation_type: formData.get('consultation_type'),
        main_topic: '', // ì£¼ì œëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        content: formData.get('content'),
        status: formData.get('status'),
        photo_urls: photoUrls,  // ì‚¬ì§„ URL ì¶”ê°€
        career_decision: formData.get('career_decision') || null  // ì§„ë¡œê²°ì • ì¶”ê°€
    };
    
    // í•„ìˆ˜ ì…ë ¥ ê²€ì¦
    if (!data.student_id || isNaN(data.student_id)) {
        await window.showError('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('student_id').focus();
        return;
    }
    
    if (!data.consultation_date) {
        await window.showError('ìƒë‹´ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('consultation_date').focus();
        return;
    }
    
    if (!data.consultation_type) {
        await window.showError('ìƒë‹´ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('consultation_type').focus();
        return;
    }
    
    if (!data.content || data.content.trim() === '') {
        await window.showError('ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('content').focus();
        return;
    }
    
    try {
        if (counselingId) {
            await axios.put(`${API_BASE_URL}/api/counselings/${counselingId}`, data);
            if (!autoSave) {
                await window.showSuccess('ìƒë‹´ ë‚´ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì €ì¥ ì™„ë£Œ');
            }
        } else {
            await axios.post(`${API_BASE_URL}/api/counselings`, data);
            if (!autoSave) {
                await window.showSuccess('ìƒë‹´ ë‚´ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì €ì¥ ì™„ë£Œ');
            }
        }
        
        // ìºì‹œ ì‚­ì œ
        window.clearCache('counselings');
        
        if (!autoSave) {
            window.hideCounselingForm();
            loadCounselings();
        }
    } catch (error) {
        console.error('ìƒë‹´ ì €ì¥ ì‹¤íŒ¨:', error);
        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        await window.showError(`ìƒë‹´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${errorMsg}`, 'ì €ì¥ ì‹¤íŒ¨');
    }
}

// ìƒë‹´ì¼ì§€ ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬
window.handleCounselingImageUpload = async function(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // íŒŒì¼ ê²€ì¦
    for (let file of files) {
        const validation = window.validateFile(file);
        if (!validation.valid) {
            window.showAlert(validation.message);
            event.target.value = '';
            return;
        }
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” í‘œì‹œ
    const progressDiv = document.getElementById('counseling-upload-progress');
    const progressBar = document.getElementById('counseling-progress-bar');
    if (progressDiv) {
        progressDiv.classList.remove('hidden');
        progressBar.style.width = '0%';
    }
    
    try {
        const photoUrls = JSON.parse(document.getElementById('counseling-photo-urls').value || '[]');
        const totalFiles = files.length;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ì´ë¯¸ì§€ ìë™ ì••ì¶• (PDFëŠ” ê·¸ëŒ€ë¡œ)
            let processedFile = file;
            if (file.type.startsWith('image/')) {
                try {
                    processedFile = await window.compressImage(file);
                    console.log(`ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
                    processedFile = file;
                }
            }
            
            const formData = new FormData();
            formData.append('file', processedFile);
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
            const progress = ((i + 0.5) / totalFiles) * 100;
            if (progressBar) progressBar.style.width = `${progress}%`;
            
            const response = await axios.post(
                `${API_BASE_URL}/api/upload-image?category=guidance`,
                formData,
                {
                    headers: { 'Content-Type': 'multipart/form-data' }
                }
            );
            
            if (response.data.success) {
                // URLê³¼ ì›ë³¸ íŒŒì¼ëª…ì„ í•¨ê»˜ ì €ì¥ (URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹)
                const urlWithOriginalName = response.data.original_filename 
                    ? `${response.data.url}#${encodeURIComponent(response.data.original_filename)}`
                    : response.data.url;
                photoUrls.push(urlWithOriginalName);
            }
            
            // ì™„ë£Œ í”„ë¡œê·¸ë ˆìŠ¤
            const completeProgress = ((i + 1) / totalFiles) * 100;
            if (progressBar) progressBar.style.width = `${completeProgress}%`;
        }
        
        // hidden input ì—…ë°ì´íŠ¸
        document.getElementById('counseling-photo-urls').value = JSON.stringify(photoUrls);
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        updateCounselingPhotoPreview(photoUrls);
        
        // ìë™ ì €ì¥ (í™”ë©´ ìœ ì§€)
        const counselingIdInput = document.getElementById('counseling-id');
        const counselingId = counselingIdInput ? counselingIdInput.value : null;
        if (counselingId) {
            // ê¸°ì¡´ ìƒë‹´ì¼ì§€ ì—…ë°ì´íŠ¸
            await window.saveCounseling(parseInt(counselingId), true);
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) {
            setTimeout(() => {
                progressDiv.classList.add('hidden');
            }, 1000);
        }
        
        // í•™ìƒ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const studentSelect = document.querySelector('#counseling-save-form select[name="student_id"]');
        const studentName = studentSelect ? studentSelect.options[studentSelect.selectedIndex].text : '';
        const contextMsg = studentName ? `${studentName} í•™ìƒì˜ ìƒë‹´ì¼ì§€ì— ` : '';
        window.showAlert(`${contextMsg}${files.length}ê°œ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
    } catch (error) {
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) progressDiv.classList.add('hidden');
        
        console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
    
    // input ì´ˆê¸°í™”
    event.target.value = '';
}

window.removeCounselingPhoto = async function(index) {
    const photoUrls = JSON.parse(document.getElementById('counseling-photo-urls').value || '[]');
    photoUrls.splice(index, 1);
    document.getElementById('counseling-photo-urls').value = JSON.stringify(photoUrls);
    updateCounselingPhotoPreview(photoUrls);
    
    // ìë™ ì €ì¥ (í™”ë©´ ìœ ì§€)
    const counselingIdInput = document.getElementById('counseling-id');
    const counselingId = counselingIdInput ? counselingIdInput.value : null;
    if (counselingId) {
        await window.saveCounseling(parseInt(counselingId), true);
        
        // í•™ìƒ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const studentSelect = document.querySelector('#counseling-save-form select[name="student_id"]');
        const studentName = studentSelect ? studentSelect.options[studentSelect.selectedIndex].text : '';
        const contextMsg = studentName ? `${studentName} í•™ìƒì˜ ìƒë‹´ì¼ì§€ì—ì„œ ` : '';
        window.showAlert(`${contextMsg}ì‚¬ì§„ì´ ì‚­ì œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
}

function updateCounselingPhotoPreview(photoUrls) {
    const previewDiv = document.getElementById('counseling-photos-preview');
    if (!photoUrls || photoUrls.length === 0) {
        previewDiv.innerHTML = '<p class="text-gray-400 text-sm">ì²¨ë¶€ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    previewDiv.innerHTML = photoUrls.map((url, idx) => 
        window.createFilePreviewItem(url, idx, 'window.removeCounselingPhoto')
    ).join('');
}

window.editCounseling = function(counselingId) {
    window.showCounselingForm(counselingId);
}

window.deleteCounseling = async function(counselingId) {
    const counseling = counselings.find(c => c.id === counselingId);
    if (!counseling) return;
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const message = `â— ìƒë‹´ ê¸°ë¡ ì‚­ì œ í™•ì¸\n\ní•™ìƒ: ${counseling.student_name}\nìƒë‹´ì¼: ${counseling.counseling_date}\nìƒë‹´ì„ ìƒë‹˜: ${counseling.instructor_name || 'ë¯¸ì •'}\n\nì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    const confirmed = await window.showConfirm(message);
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/counselings/${counselingId}`);
        window.clearCache('counselings');
        window.showAlert('âœ… ìƒë‹´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadCounselings();
    } catch (error) {
        console.error('ìƒë‹´ ì‚­ì œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

// ==================== AI ìƒê¸°ë¶€ ====================
let selectedStudentForAI = null;
let studentCounselings = [];
let generatedReport = null;

function renderAIReport() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-robot mr-2"></i>AI ìƒí™œê¸°ë¡ë¶€ ì‘ì„±
            </h2>
            
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <p class="text-blue-700">
                    <i class="fas fa-info-circle mr-2"></i>
                    í•™ìƒì„ ì„ íƒí•˜ë©´ ëª¨ë“  ìƒë‹´ ê¸°ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ì¢…í•© ì˜ê²¬ì„ AIê°€ ìƒì„±í•©ë‹ˆë‹¤.
                </p>
            </div>
            
            <!-- í•™ìƒ ì„ íƒ ë° ìŠ¤íƒ€ì¼ ì˜µì…˜ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒ ì„ íƒ</label>
                    <select id="ai-student-select" onchange="window.loadStudentCounselings()" class="w-full border rounded px-3 py-2">
                        <option value="">-- í•™ìƒì„ ì„ íƒí•˜ì„¸ìš” --</option>
                        ${students.map(s => `
                            <option value="${s.id}">${s.name} (${s.code})</option>
                        `).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì‘ì„± ìŠ¤íƒ€ì¼</label>
                    <select id="ai-report-style" class="w-full border rounded px-3 py-2">
                        <option value="formal">ê³µì‹ì  (ì •ì‹ ìƒí™œê¸°ë¡ë¶€ ì–‘ì‹)</option>
                        <option value="friendly">ì¹œê·¼í•œ (ë”°ëœ»í•˜ê³  ê²©ë ¤ì ì¸ í†¤)</option>
                        <option value="detailed">ìƒì„¸ ë¶„ì„ (ì‹¬ì¸µ í‰ê°€ ë° ë¶„ì„)</option>
                    </select>
                </div>
            </div>
            
            <!-- ìƒë‹´ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ -->
            <div id="counseling-records-section" class="hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-list mr-2"></i>ìƒë‹´ ê¸°ë¡ (ì´ <span id="counseling-count">0</span>ê±´)
                </h3>
                <div id="counseling-records-list" class="space-y-3 mb-6">
                    <!-- ìƒë‹´ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <button onclick="window.generateAIReport()" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 rounded-lg shadow-lg transform transition hover:scale-105">
                    <i class="fas fa-magic mr-2"></i>AI ìƒê¸°ë¶€ ìƒì„±
                </button>
            </div>
            
            <!-- AI ìƒì„± ê²°ê³¼ -->
            <div id="ai-report-result" class="hidden mt-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-file-alt mr-2"></i>ìƒì„±ëœ AI ìƒí™œê¸°ë¡ë¶€
                </h3>
                <div id="ai-report-content" class="bg-gradient-to-br from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 whitespace-pre-wrap">
                    <!-- AI ìƒì„± ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="mt-4 space-x-2">
                    <button onclick="window.copyAIReport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-copy mr-2"></i>ë³µì‚¬
                    </button>
                    <button onclick="window.downloadAIReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>
            
            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
            <div id="ai-loading" class="hidden mt-6 text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
                <p class="text-gray-600">AIê°€ ìƒê¸°ë¶€ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 10-20ì´ˆ ì†Œìš”)</p>
            </div>
        </div>
    `;
}

window.loadStudentCounselings = async function() {
    const studentId = document.getElementById('ai-student-select').value;
    
    if (!studentId) {
        document.getElementById('counseling-records-section').classList.add('hidden');
        document.getElementById('ai-report-result').classList.add('hidden');
        return;
    }
    
    selectedStudentForAI = parseInt(studentId);
    
    try {
        // í•™ìƒì˜ ëª¨ë“  ìƒë‹´ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
        const response = await axios.get(`${API_BASE_URL}/api/counselings?student_id=${studentId}`);
        studentCounselings = response.data;
        
        // ìƒë‹´ ê¸°ë¡ í‘œì‹œ
        const recordsList = document.getElementById('counseling-records-list');
        const counselingCount = document.getElementById('counseling-count');
        
        counselingCount.textContent = studentCounselings.length;
        
        if (studentCounselings.length === 0) {
            recordsList.innerHTML = `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-500">
                    <i class="fas fa-inbox mr-2"></i>ìƒë‹´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
            document.getElementById('counseling-records-section').classList.remove('hidden');
            return;
        }
        
        recordsList.innerHTML = studentCounselings.map((c, index) => `
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition ${c.status === 'ì™„ë£Œ' ? 'bg-green-50 border-green-200' : ''}">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="bg-purple-100 text-purple-800 text-xs font-semibold px-2 py-1 rounded">
                            ${index + 1}íšŒì°¨
                        </span>
                        <span class="text-sm font-medium text-gray-700">
                            ${c.consultation_date ? new Date(c.consultation_date).toLocaleDateString('ko-KR') : '-'}
                        </span>
                        <span class="text-xs px-2 py-1 rounded ${
                            c.consultation_type === 'ì •ê¸°' ? 'bg-blue-100 text-blue-800' :
                            c.consultation_type === 'ìˆ˜ì‹œ' ? 'bg-green-100 text-green-800' :
                            c.consultation_type === 'ê¸´ê¸‰' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                        }">
                            ${c.consultation_type}
                        </span>
                        <span class="text-xs px-2 py-1 rounded ${
                            c.status === 'ì™„ë£Œ' ? 'bg-green-100 text-green-800' :
                            c.status === 'ì˜ˆì •' ? 'bg-gray-100 text-gray-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${c.status}
                        </span>
                    </div>
                </div>
                <div class="text-sm">
                    <p class="font-semibold text-gray-800 mb-1">
                        <i class="fas fa-comment-dots mr-2 text-purple-600"></i>${c.main_topic || '(ì£¼ì œ ì—†ìŒ)'}
                    </p>
                    <p class="text-gray-600 ml-6 whitespace-pre-wrap">${c.content || '(ë‚´ìš© ì—†ìŒ)'}</p>
                </div>
            </div>
        `).join('');
        
        document.getElementById('counseling-records-section').classList.remove('hidden');
        document.getElementById('ai-report-result').classList.add('hidden');
        generatedReport = null;
        
    } catch (error) {
        console.error('ìƒë‹´ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('ìƒë‹´ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

window.generateAIReport = async function() {
    if (!selectedStudentForAI) {
        window.showAlert('í•™ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    if (studentCounselings.length === 0) {
        window.showAlert('ìƒë‹´ ê¸°ë¡ì´ ì—†ì–´ ìƒê¸°ë¶€ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    // ë¡œë”© í‘œì‹œ
    document.getElementById('ai-loading').classList.remove('hidden');
    document.getElementById('ai-report-result').classList.add('hidden');
    
    try {
        const student = students.find(s => s.id === selectedStudentForAI);
        const style = document.getElementById('ai-report-style').value;
        
        const response = await axios.post(`${API_BASE_URL}/api/ai/generate-report`, {
            student_id: selectedStudentForAI,
            student_name: student ? student.name : 'ì•Œ ìˆ˜ ì—†ìŒ',
            student_code: student ? student.code : 'ì•Œ ìˆ˜ ì—†ìŒ',
            style: style
        });
        
        generatedReport = response.data.report;
        
        // ê²°ê³¼ í‘œì‹œ
        document.getElementById('ai-report-content').textContent = generatedReport;
        document.getElementById('ai-report-result').classList.remove('hidden');
        document.getElementById('ai-loading').classList.add('hidden');
        
        // ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
        document.getElementById('ai-report-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
        
    } catch (error) {
        console.error('AI ìƒê¸°ë¶€ ìƒì„± ì‹¤íŒ¨:', error);
        showAlert('AI ìƒê¸°ë¶€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message), 'error');
        document.getElementById('ai-loading').classList.add('hidden');
    }
}

window.copyAIReport = function() {
    if (!generatedReport) return;
    
    navigator.clipboard.writeText(generatedReport).then(() => {
        window.showAlert('AI ìƒê¸°ë¶€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        window.showAlert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    });
}

window.downloadAIReport = function() {
    if (!generatedReport) return;
    
    const student = students.find(s => s.id === selectedStudentForAI);
    const filename = `AIìƒê¸°ë¶€_${student ? student.name : 'student'}_${new Date().toISOString().split('T')[0]}.txt`;
    
    const blob = new Blob([generatedReport], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ==================== ê°•ì‚¬ì½”ë“œ/ê¶Œí•œ ê´€ë¦¬ ====================
let instructorCodes = [];

async function loadInstructorCodes() {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/instructor-codes`);
        instructorCodes = response.data;
        renderInstructorCodes();
    } catch (error) {
        console.error('ê°•ì‚¬ì½”ë“œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ê°•ì‚¬ì½”ë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderInstructorCodes() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-code mr-2"></i>ê°•ì‚¬ì½”ë“œ/ê¶Œí•œ ê´€ë¦¬ (ì´ ${instructorCodes.length}ê°œ)
                </h2>
                <button onclick="window.showInstructorCodeForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>ê°•ì‚¬ì½”ë“œ/ê¶Œí•œ ì¶”ê°€
                </button>
            </div>
            
            <div id="instructor-code-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg"></div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">ì½”ë“œ</th>
                            <th class="px-4 py-2 text-left">ê°•ì‚¬ì—­í• </th>
                            <th class="px-4 py-2 text-left">ê¶Œí•œíƒ€ì…</th>
                            <th class="px-4 py-2 text-left">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${instructorCodes.map(code => `
                            <tr class="border-t hover:bg-gray-50">
                                <td class="px-4 py-2">${code.code}</td>
                                <td class="px-4 py-2">${code.name}</td>
                                <td class="px-4 py-2">${code.type}</td>
                                <td class="px-4 py-2">
                                    <button onclick="window.editInstructorCode('${code.code}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.deleteInstructorCode('${code.code}')" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

window.showInstructorCodeForm = function(code = null) {
    const formDiv = document.getElementById('instructor-code-form');
    formDiv.classList.remove('hidden');
    
    const existingCode = code ? instructorCodes.find(c => c.code === code) : null;
    const existingPermissions = existingCode?.permissions || {};
    const existingMenuPermissions = existingCode?.menu_permissions || [];
    
    // ê°•ì‚¬ì½”ë“œ ìë™ ìƒì„± (IC-001, IC-002...)
    let autoCode = '';
    if (!code) {
        const maxCode = instructorCodes.reduce((max, ic) => {
            const match = ic.code.match(/^IC-(\d+)$/);
            if (match) {
                const num = parseInt(match[1]);
                return num > max ? num : max;
            }
            return max;
        }, 0);
        autoCode = `IC-${String(maxCode + 1).padStart(3, '0')}`;
    }
    
    // ë©”ë‰´ ëª©ë¡ ì •ì˜ (ê³„ì¸µ êµ¬ì¡°)
    const menuStructure = [
        { id: 'dashboard', name: 'ëŒ€ì‹œë³´ë“œ', icon: 'fa-tachometer-alt', children: [] },
        {
            id: 'system-menu', name: 'ì‹œìŠ¤í…œê´€ë¦¬', icon: 'fa-cogs',
            children: [
                { id: 'instructor-codes', name: 'ê°•ì‚¬ì½”ë“œ/ê¶Œí•œ', icon: 'fa-user-shield' },
                { id: 'instructors', name: 'ê°•ì‚¬ê´€ë¦¬', icon: 'fa-user-tie' },
                { id: 'system-settings', name: 'ì‹œìŠ¤í…œ ë“±ë¡', icon: 'fa-cog' },
                { id: 'backup-manager', name: 'DB ê´€ë¦¬', icon: 'fa-database' },
                { id: 'notices', name: 'ê³µì§€ì‚¬í•­', icon: 'fa-bullhorn' },
                { id: 'system-check', name: 'ì‹œìŠ¤í…œ ì ê²€', icon: 'fa-stethoscope' }
            ]
        },
        {
            id: 'course-menu', name: 'ê³¼ì •', icon: 'fa-graduation-cap',
            children: [
                { id: 'subjects', name: 'êµê³¼ëª©', icon: 'fa-book' },
                { id: 'holidays', name: 'ê³µíœ´ì¼', icon: 'fa-calendar-alt' },
                { id: 'courses', name: 'ê³¼ì •ê´€ë¦¬', icon: 'fa-school' }
            ]
        },
        {
            id: 'student-menu', name: 'í•™ìƒ', icon: 'fa-user-graduate',
            children: [
                { id: 'students', name: 'í•™ìƒê´€ë¦¬', icon: 'fa-users' },
                { id: 'counselings', name: 'ìƒë‹´ê´€ë¦¬', icon: 'fa-comments' }
            ]
        },
        {
            id: 'lecture-menu', name: 'ê°•ì˜', icon: 'fa-chalkboard',
            children: [
                { id: 'timetables', name: 'ì‹œê°„í‘œ', icon: 'fa-clock' },
                { id: 'training-logs', name: 'í›ˆë ¨ì¼ì§€ ê´€ë¦¬', icon: 'fa-clipboard-list' },
                { id: 'rag-documents', name: 'ë¬¸ì„œ ê´€ë¦¬ (RAG)', icon: 'fa-file-alt' },
                { id: 'exam-bank', name: 'ë¬¸ì œì€í–‰', icon: 'fa-clipboard-question' }
            ]
        },
        {
            id: 'grade-menu', name: 'ì„±ì ', icon: 'fa-chart-line',
            children: [
                { id: 'online-exam', name: 'ì˜¨ë¼ì¸ì‹œí—˜', icon: 'fa-laptop' },
                { id: 'quick-quiz', name: 'ì„ ì°©ìˆœ í€´ì¦ˆ', icon: 'fa-bolt' },
                { id: 'assignments', name: 'ê³¼ì œê´€ë¦¬', icon: 'fa-tasks' }
            ]
        },
        {
            id: 'ai-menu', name: 'AI', icon: 'fa-robot',
            children: [
                { id: 'class-notes', name: 'SSIRNë©”ëª¨ì¥', icon: 'fa-book-open' },
                { id: 'ai-report', name: 'AI ìƒê¸°ë¶€', icon: 'fa-file-alt' },
                { id: 'ai-timetable', name: 'AI ì‹œê°„í‘œ', icon: 'fa-calendar-alt' },
                { id: 'ai-training-log', name: 'AI í›ˆë ¨ì¼ì§€', icon: 'fa-brain' },
                { id: 'ai-counseling', name: 'AI ìƒë‹´ì¼ì§€', icon: 'fa-comments' },
                { id: 'aesong-3d-chat', name: 'ì˜ˆì§„ì´ ë§Œë‚˜ê¸°', icon: 'fa-dog' }
            ]
        },
        {
            id: 'team-menu', name: 'íŒ€', icon: 'fa-users',
            children: [
                { id: 'projects', name: 'íŒ€ ê´€ë¦¬', icon: 'fa-users' },
                { id: 'team-activity-logs', name: 'íŒ€ í™œë™ì¼ì§€', icon: 'fa-clipboard-list' }
            ]
        }
    ];

    // ëª¨ë“  ë©”ë‰´ ID ì¶”ì¶œ (ì €ì¥ìš©)
    const getAllMenuIds = () => {
        const ids = [];
        menuStructure.forEach(menu => {
            if (menu.children.length === 0) {
                ids.push(menu.id);
            } else {
                menu.children.forEach(child => ids.push(child.id));
            }
        });
        return ids;
    };
    
    formDiv.innerHTML = `
        <h3 class="text-lg font-semibold mb-4">${code ? 'ê°•ì‚¬ì½”ë“œ/ê¶Œí•œ ìˆ˜ì •' : 'ê°•ì‚¬ì½”ë“œ/ê¶Œí•œ ì¶”ê°€'}</h3>
        
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì½”ë“œ *</label>
                <input type="text" id="code" placeholder="ì½”ë“œ (ì˜ˆ: IC-001)" value="${existingCode ? existingCode.code : autoCode}" ${code ? 'readonly' : 'readonly'} class="w-full border rounded px-3 py-2 bg-gray-100">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ê°•ì‚¬ì—­í•  *</label>
                <input type="text" id="name" placeholder="ê°•ì‚¬ì—­í• " value="${existingCode ? existingCode.name : ''}" class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ê¶Œí•œíƒ€ì… *</label>
                <select id="type" class="w-full border rounded px-3 py-2">
                    <option value="">ê¶Œí•œíƒ€ì… ì„ íƒ</option>
                    <option value="0. ê´€ë¦¬ì" ${existingCode && existingCode.type === '0. ê´€ë¦¬ì' ? 'selected' : ''}>0. ê´€ë¦¬ì</option>
                    <option value="1. ì£¼ê°•ì‚¬" ${existingCode && existingCode.type === '1. ì£¼ê°•ì‚¬' ? 'selected' : ''}>1. ì£¼ê°•ì‚¬</option>
                    <option value="2. ë³´ì¡°ê°•ì‚¬" ${existingCode && existingCode.type === '2. ë³´ì¡°ê°•ì‚¬' ? 'selected' : ''}>2. ë³´ì¡°ê°•ì‚¬</option>
                    <option value="3. ë©˜í† " ${existingCode && existingCode.type === '3. ë©˜í† ' ? 'selected' : ''}>3. ë©˜í† </option>
                    <option value="4. í–‰ì •ì§€ì›" ${existingCode && existingCode.type === '4. í–‰ì •ì§€ì›' ? 'selected' : ''}>4. í–‰ì •ì§€ì›</option>
                    <option value="5. ê°€ë””ì–¸" ${existingCode && existingCode.type === '5. ê°€ë””ì–¸' ? 'selected' : ''}>5. ê°€ë””ì–¸</option>
                    <option value="6. PM" ${existingCode && existingCode.type === '6. PM' ? 'selected' : ''}>6. PM</option>
                </select>
            </div>
        </div>
        
        <!-- ê¶Œí•œ ì„¤ì • -->
        <div class="border-t pt-6">
            <div class="flex items-center justify-between mb-4">
                <h4 class="text-md font-semibold text-gray-800">
                    <i class="fas fa-shield-alt mr-2 text-blue-600"></i>ë©”ë‰´ ì ‘ê·¼ ê¶Œí•œ ë° ì´ˆê¸° í™”ë©´ ì„¤ì •
                </h4>
                <div class="flex gap-2">
                    <button type="button" onclick="window.selectAllPermissions(true)" class="text-sm bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded">
                        <i class="fas fa-check-square mr-1"></i>ì „ì²´ ì„ íƒ
                    </button>
                    <button type="button" onclick="window.selectAllPermissions(false)" class="text-sm bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded">
                        <i class="fas fa-square mr-1"></i>ì „ì²´ í•´ì œ
                    </button>
                </div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-600 mb-3">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                    ì´ ê°•ì‚¬ì½”ë“œ(íƒ€ì…)ì— í•´ë‹¹í•˜ëŠ” ê°•ì‚¬ë“¤ì´ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”.
                    <strong class="text-blue-600">ê´€ë¦¬ì(íƒ€ì… IC-999)</strong>ëŠ” ëª¨ë“  ë©”ë‰´ì— ìë™ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    <br>
                    <i class="fas fa-home mr-2 text-green-500"></i>
                    <strong class="text-green-600">ë¼ë””ì˜¤ë²„íŠ¼ìœ¼ë¡œ ì´ˆê¸° í™”ë©´</strong>ì„ ì„ íƒí•˜ë©´ ë¡œê·¸ì¸ ì‹œ í•´ë‹¹ ë©”ë‰´ë¡œ ìë™ ì´ë™í•©ë‹ˆë‹¤.
                    <br>
                    <i class="fas fa-folder mr-2 text-orange-500"></i>
                    <strong class="text-orange-600">ìƒìœ„ ë©”ë‰´</strong>ë¥¼ í•´ì œí•˜ë©´ í•˜ìœ„ ë©”ë‰´ë„ ìë™ í•´ì œë©ë‹ˆë‹¤.
                </p>
                <div class="space-y-3">
                    ${menuStructure.map(menu => {
                        if (menu.children.length === 0) {
                            // ë‹¨ì¼ ë©”ë‰´ (ëŒ€ì‹œë³´ë“œ)
                            return `
                                <div class="bg-white border rounded-lg p-3">
                                    <label class="flex items-center justify-between cursor-pointer">
                                        <div class="flex items-center space-x-2">
                                            <input type="checkbox"
                                                   class="permission-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                                                   data-menu-id="${menu.id}"
                                                   ${existingMenuPermissions.includes(menu.id) || existingPermissions[menu.id] ? 'checked' : ''}>
                                            <span class="font-semibold text-gray-800">
                                                <i class="fas ${menu.icon} mr-2 text-blue-600"></i>
                                                ${menu.name}
                                            </span>
                                        </div>
                                        <input type="radio"
                                               name="default-screen"
                                               class="default-screen-radio w-4 h-4 text-green-600 focus:ring-green-500 cursor-pointer"
                                               data-menu-id="${menu.id}"
                                               title="ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì„¤ì •"
                                               ${existingCode?.default_screen === menu.id ? 'checked' : ''}>
                                    </label>
                                </div>
                            `;
                        } else {
                            // ê³„ì¸µ ë©”ë‰´
                            const childIds = menu.children.map(c => c.id);
                            const allChecked = childIds.every(id => existingMenuPermissions.includes(id) || existingPermissions[id]);
                            const someChecked = childIds.some(id => existingMenuPermissions.includes(id) || existingPermissions[id]);

                            return `
                                <div class="bg-white border-2 border-blue-200 rounded-lg overflow-hidden shadow-sm" data-menu-group="${menu.id}">
                                    <!-- ìƒìœ„ ë©”ë‰´ í—¤ë” (í…Œë§ˆìƒ‰) -->
                                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-4 py-3">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox"
                                                   class="parent-checkbox w-5 h-5 bg-white/20 border-2 border-white rounded focus:ring-white"
                                                   data-parent-id="${menu.id}"
                                                   data-children="${childIds.join(',')}"
                                                   ${allChecked || someChecked ? 'checked' : ''}
                                                   onchange="window.toggleParentMenu(this)">
                                            <span class="font-semibold text-white">
                                                <i class="fas ${menu.icon} mr-2"></i>
                                                ${menu.name}
                                            </span>
                                            <span class="text-xs text-blue-200 ml-2">(${menu.children.length}ê°œ)</span>
                                        </label>
                                    </div>
                                    <!-- í•˜ìœ„ ë©”ë‰´ ëª©ë¡ -->
                                    <div class="p-3 grid grid-cols-2 md:grid-cols-3 gap-2 children-container" data-parent="${menu.id}" style="${allChecked || someChecked ? '' : 'display:none'}">
                                        ${menu.children.map(child => `
                                            <label class="flex items-center justify-between bg-gray-50 p-2 rounded border hover:bg-blue-50 transition-all cursor-pointer">
                                                <div class="flex items-center space-x-2">
                                                    <input type="checkbox"
                                                           class="permission-checkbox child-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                                                           data-menu-id="${child.id}"
                                                           data-parent="${menu.id}"
                                                           ${existingMenuPermissions.includes(child.id) || existingPermissions[child.id] ? 'checked' : ''}
                                                           onchange="window.updateParentCheckbox('${menu.id}')">
                                                    <span class="text-sm text-gray-700">
                                                        <i class="fas ${child.icon} mr-1 text-gray-500"></i>
                                                        ${child.name}
                                                    </span>
                                                </div>
                                                <input type="radio"
                                                       name="default-screen"
                                                       class="default-screen-radio w-4 h-4 text-green-600 focus:ring-green-500 cursor-pointer"
                                                       data-menu-id="${child.id}"
                                                       title="ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì„¤ì •"
                                                       ${existingCode?.default_screen === child.id ? 'checked' : ''}>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
            </div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ ê·¸ë˜í”„ í‘œì‹œ ì„¤ì • -->
        <div class="border-t pt-6 mt-6">
            <h4 class="text-md font-semibold text-gray-800 mb-4">
                <i class="fas fa-chart-bar mr-2 text-purple-600"></i>ëŒ€ì‹œë³´ë“œ ê·¸ë˜í”„ í‘œì‹œ ì„¤ì •
            </h4>
            <p class="text-sm text-gray-600 mb-3">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                ëŒ€ì‹œë³´ë“œì— í‘œì‹œí•  ê·¸ë˜í”„ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•˜ì§€ ì•Šì€ ê·¸ë˜í”„ëŠ” ëŒ€ì‹œë³´ë“œì—ì„œ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.
            </p>
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <label class="flex items-center bg-white p-3 rounded-lg border hover:bg-blue-50 cursor-pointer transition-all">
                        <input type="checkbox" class="dashboard-chart-checkbox w-4 h-4 text-purple-600 rounded mr-3"
                               data-chart="studentsByCourse"
                               ${!existingCode?.dashboard_charts || existingCode?.dashboard_charts?.includes('studentsByCourse') ? 'checked' : ''}>
                        <span class="text-sm"><i class="fas fa-users mr-1 text-blue-500"></i>ê³¼ì •ë³„ í•™ìƒ</span>
                    </label>
                    <label class="flex items-center bg-white p-3 rounded-lg border hover:bg-blue-50 cursor-pointer transition-all">
                        <input type="checkbox" class="dashboard-chart-checkbox w-4 h-4 text-purple-600 rounded mr-3"
                               data-chart="instructorType"
                               ${!existingCode?.dashboard_charts || existingCode?.dashboard_charts?.includes('instructorType') ? 'checked' : ''}>
                        <span class="text-sm"><i class="fas fa-user-tie mr-1 text-green-500"></i>ê°•ì‚¬ ìœ í˜•ë³„</span>
                    </label>
                    <label class="flex items-center bg-white p-3 rounded-lg border hover:bg-blue-50 cursor-pointer transition-all">
                        <input type="checkbox" class="dashboard-chart-checkbox w-4 h-4 text-purple-600 rounded mr-3"
                               data-chart="counselingTrend"
                               ${!existingCode?.dashboard_charts || existingCode?.dashboard_charts?.includes('counselingTrend') ? 'checked' : ''}>
                        <span class="text-sm"><i class="fas fa-chart-line mr-1 text-orange-500"></i>ìƒë‹´ ì¶”ì´</span>
                    </label>
                    <label class="flex items-center bg-white p-3 rounded-lg border hover:bg-blue-50 cursor-pointer transition-all">
                        <input type="checkbox" class="dashboard-chart-checkbox w-4 h-4 text-purple-600 rounded mr-3"
                               data-chart="progress"
                               ${!existingCode?.dashboard_charts || existingCode?.dashboard_charts?.includes('progress') ? 'checked' : ''}>
                        <span class="text-sm"><i class="fas fa-tasks mr-1 text-indigo-500"></i>ì§„ë„ìœ¨</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="mt-6 space-x-2">
            <button onclick="window.saveInstructorCode(${code ? `'${code}'` : 'null'})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                <i class="fas fa-save mr-2"></i>ì €ì¥
            </button>
            <button onclick="window.hideInstructorCodeForm()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
                ì·¨ì†Œ
            </button>
        </div>
    `;
}

// ê¶Œí•œ ì „ì²´ ì„ íƒ/í•´ì œ
window.selectAllPermissions = function(selectAll) {
    // ëª¨ë“  ê¶Œí•œ ì²´í¬ë°•ìŠ¤ ì„ íƒ/í•´ì œ
    const checkboxes = document.querySelectorAll('.permission-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = selectAll;
    });
    // ë¶€ëª¨ ì²´í¬ë°•ìŠ¤ë„ ì—…ë°ì´íŠ¸
    const parentCheckboxes = document.querySelectorAll('.parent-checkbox');
    parentCheckboxes.forEach(cb => {
        cb.checked = selectAll;
    });
    // í•˜ìœ„ ë©”ë‰´ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€
    const childrenContainers = document.querySelectorAll('.children-container');
    childrenContainers.forEach(container => {
        container.style.display = selectAll ? '' : 'none';
    });
};

// ìƒìœ„ ë©”ë‰´ ì²´í¬ë°•ìŠ¤ í† ê¸€ (ìì‹ë“¤ ì¼ê´„ ì²˜ë¦¬ + UI í‘œì‹œ/ìˆ¨ê¹€)
window.toggleParentMenu = function(parentCheckbox) {
    const isChecked = parentCheckbox.checked;
    const parentId = parentCheckbox.getAttribute('data-parent-id');
    const childIds = parentCheckbox.getAttribute('data-children').split(',');

    // ìì‹ ì²´í¬ë°•ìŠ¤ë“¤ ì¼ê´„ ì²˜ë¦¬
    childIds.forEach(childId => {
        const childCheckbox = document.querySelector(`.child-checkbox[data-menu-id="${childId}"]`);
        if (childCheckbox) {
            childCheckbox.checked = isChecked;
        }
    });

    // í•˜ìœ„ ë©”ë‰´ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€
    const childrenContainer = document.querySelector(`.children-container[data-parent="${parentId}"]`);
    if (childrenContainer) {
        childrenContainer.style.display = isChecked ? '' : 'none';
    }
};

// í•˜ìœ„ ë©”ë‰´ ë³€ê²½ ì‹œ ìƒìœ„ ë©”ë‰´ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
window.updateParentCheckbox = function(parentId) {
    const parentCheckbox = document.querySelector(`.parent-checkbox[data-parent-id="${parentId}"]`);
    if (!parentCheckbox) return;

    const childCheckboxes = document.querySelectorAll(`.child-checkbox[data-parent="${parentId}"]`);
    const allChecked = Array.from(childCheckboxes).every(cb => cb.checked);
    const someChecked = Array.from(childCheckboxes).some(cb => cb.checked);

    parentCheckbox.checked = allChecked;
    parentCheckbox.indeterminate = !allChecked && someChecked;
};

window.hideInstructorCodeForm = function() {
    document.getElementById('instructor-code-form').classList.add('hidden');
}

window.saveInstructorCode = async function(existingCode) {
    const code = document.getElementById('code').value;
    const name = document.getElementById('name').value;
    const type = document.getElementById('type').value;
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!code) {
        window.showAlert('ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    if (!name) {
        window.showAlert('ê°•ì‚¬ì—­í• ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    if (!type) {
        window.showAlert('íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // ê¶Œí•œ ë°ì´í„° ìˆ˜ì§‘ (ë°°ì—´ í˜•íƒœë¡œ)
    const menuPermissions = [];
    const checkboxes = document.querySelectorAll('.permission-checkbox');
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const menuId = checkbox.getAttribute('data-menu-id');
            menuPermissions.push(menuId);
        }
    });
    
    // ì´ˆê¸° í™”ë©´ ì„¤ì • ìˆ˜ì§‘
    const defaultScreenRadio = document.querySelector('.default-screen-radio:checked');
    const defaultScreen = defaultScreenRadio ? defaultScreenRadio.getAttribute('data-menu-id') : null;

    // ëŒ€ì‹œë³´ë“œ ê·¸ë˜í”„ í‘œì‹œ ì„¤ì • ìˆ˜ì§‘
    const dashboardCharts = [];
    const chartCheckboxes = document.querySelectorAll('.dashboard-chart-checkbox');
    chartCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            dashboardCharts.push(checkbox.getAttribute('data-chart'));
        }
    });

    const data = {
        code: code,
        name: name,
        type: type,
        permissions: {}, // í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
        menu_permissions: menuPermissions,
        default_screen: defaultScreen,
        dashboard_charts: dashboardCharts
    };
    
    try {
        if (existingCode && existingCode !== '' && existingCode !== '0') {
            // ê¸°ì¡´ ì½”ë“œ ìˆ˜ì •
            await axios.put(`${API_BASE_URL}/api/instructor-codes/${existingCode}`, data);
            window.showAlert('âœ… ê°•ì‚¬ì½”ë“œ ë° ê¶Œí•œì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            // ìƒˆ ì½”ë“œ ì¶”ê°€
            await axios.post(`${API_BASE_URL}/api/instructor-codes`, data);
            window.showAlert('âœ… ê°•ì‚¬ì½”ë“œ ë° ê¶Œí•œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
        window.hideInstructorCodeForm();
        loadInstructorCodes();
        window.clearCache(); // ê¶Œí•œ ë³€ê²½ ì‹œ ìºì‹œ í´ë¦¬ì–´
    } catch (error) {
        window.showAlert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

window.editInstructorCode = function(code) {
    window.showInstructorCodeForm(code);
}

window.deleteInstructorCode = async function(code) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    const confirmed = await window.showConfirm('ì´ ê°•ì‚¬ì½”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    try {
        window.showLoading('ê°•ì‚¬ì½”ë“œ ì‚­ì œ ì¤‘...');
        await axios.delete(`${API_BASE_URL}/api/instructor-codes/${code}`);
        window.hideLoading();
        window.showAlert('ê°•ì‚¬ì½”ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadInstructorCodes();
    } catch (error) {
        window.hideLoading();
        window.showAlert('ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

// ==================== ê°•ì‚¬ ê´€ë¦¬ (í™•ì¥) ====================
async function loadInstructors() {
    try {
        console.log('ğŸš€ ê°•ì‚¬ ë°ì´í„° ë¡œë”© ì‹œì‘...');
        window.showLoading('ê°•ì‚¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const [instructorsData, typesData, coursesData] = await Promise.all([
            window.getCachedData('instructors', () => axios.get(`${API_BASE_URL}/api/instructors`).then(r => r.data)),
            window.getCachedData('instructor-codes', () => axios.get(`${API_BASE_URL}/api/instructor-codes`).then(r => r.data)),
            window.getCachedData('courses', () => axios.get(`${API_BASE_URL}/api/courses`).then(r => r.data))
        ]);
        instructors = instructorsData;
        instructorTypes = typesData;
        courses = coursesData;
        console.log('âœ… ê°•ì‚¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', { instructors: instructors.length, types: instructorTypes.length });
        renderInstructors();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('âŒ ê°•ì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = `
            <div class="p-6">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-600 mb-3">ê°•ì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>
                    <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-sync mr-2"></i>ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
        `;
    }
}

function renderInstructors() {
    // ì •ë ¬ í‚¤ì— ë”°ë¼ ì •ë ¬
    const sortedInstructors = [...instructors].sort((a, b) => {
        let valA, valB;
        if (instructorSortKey === 'role') {
            const typeA = instructorTypes.find(t => t.code === a.instructor_type);
            const typeB = instructorTypes.find(t => t.code === b.instructor_type);
            valA = typeA ? typeA.name : '';
            valB = typeB ? typeB.name : '';
        } else {
            valA = a[instructorSortKey] || '';
            valB = b[instructorSortKey] || '';
        }
        const cmp = String(valA).localeCompare(String(valB), 'ko');
        return instructorSortAsc ? cmp : -cmp;
    });
    
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-chalkboard-teacher mr-2"></i>ê°•ì‚¬ ê´€ë¦¬ (ì´ ${instructors.length}ëª…)
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.showInstructorForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>ê°•ì‚¬ ì¶”ê°€
                    </button>
                    <button onclick="window.downloadInstructorTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-download mr-2"></i>Excel í…œí”Œë¦¿
                    </button>
                    <button onclick="window.showInstructorExportOptions()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-export mr-2"></i>Excel ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button onclick="window.showInstructorExcelUpload()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-excel mr-2"></i>Excel ì—…ë¡œë“œ
                    </button>
                </div>
            </div>
            
            <!-- í•„í„° ì˜ì—­ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 mb-2">ê°•ì‚¬êµ¬ë¶„ í•„í„°</label>
                    <select id="instructor-type-filter" class="w-full border rounded px-3 py-2" onchange="window.filterInstructors()">
                        <option value="" selected>-- ì „ì²´ ê°•ì‚¬êµ¬ë¶„ --</option>
                        ${instructorTypes
                            .sort((a, b) => a.name.localeCompare(b.name, 'ko'))
                            .map(type => `
                            <option value="${type.code}">${type.name}</option>
                        `).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê²€ìƒ‰ (ì´ë¦„, ì „ê³µ)</label>
                    <input type="text" id="instructor-search" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." class="w-full border rounded px-3 py-2" oninput="window.debounceInstructorSearch()" autocomplete="off" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
                </div>
            </div>
            
            <div id="instructor-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg"></div>
            <div id="instructor-excel-upload" class="hidden mb-6 p-4 bg-purple-50 rounded-lg"></div>

            <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ (ì£¼ê°•ì‚¬ ì „ìš©) -->
            ${isMainInstructor() ? `
                <div id="password-change-modal" class="hidden mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-key mr-2 text-blue-600"></i>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ì£¼ê°•ì‚¬ ì „ìš©)
                            </h3>
                            <button onclick="window.hidePasswordChangeModal()" class="text-gray-600 hover:text-gray-800">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="bg-white rounded p-4 mb-4">
                            <p class="text-sm text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>ëŒ€ìƒ ê°•ì‚¬:</strong> <span id="pwd-target-instructor" class="font-bold"></span>
                            </p>
                            <p class="text-xs text-gray-600">
                                ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ëŠ” <code class="bg-gray-100 px-2 py-0.5 rounded">kdt2025</code>ì…ë‹ˆë‹¤.
                            </p>
                        </div>
                        
                        <input type="hidden" id="pwd-instructor-code-modal">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ìƒˆ ë¹„ë°€ë²ˆí˜¸ *
                                </label>
                                <input type="password" id="pwd-new-password-modal" 
                                       placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" 
                                       class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-lock mr-1"></i>ì˜ë¬¸, ìˆ«ì ì¡°í•© 4ì ì´ìƒ
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *
                                </label>
                                <input type="password" id="pwd-confirm-password-modal" 
                                       placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" 
                                       class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div class="mt-4 flex space-x-2">
                            <button onclick="window.changePasswordFromModal()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                                <i class="fas fa-save mr-2"></i>ë³€ê²½
                            </button>
                            <button onclick="window.resetPasswordFromModal()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition">
                                <i class="fas fa-redo mr-2"></i>ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                            </button>
                            <button onclick="window.hidePasswordChangeModal()" 
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-2 text-center w-12">ì‚¬ì§„</th>
                            ${[
                                { key: 'code', label: 'ê°•ì‚¬ì½”ë“œ' },
                                { key: 'name', label: 'ì´ë¦„' },
                                { key: 'major', label: 'ì „ê³µ' },
                                { key: 'affiliation', label: 'ì†Œì†' },
                                { key: 'role', label: 'ê°•ì‚¬ì—­í• ' },
                                { key: 'phone', label: 'ì—°ë½ì²˜' }
                            ].map(col => `
                            <th class="px-4 py-2 text-left cursor-pointer select-none hover:bg-gray-200 transition-colors" onclick="window.sortInstructorTable('${col.key}')">
                                ${col.label}
                                <i class="fas ${instructorSortKey === col.key ? (instructorSortAsc ? 'fa-sort-up text-blue-600' : 'fa-sort-down text-blue-600') : 'fa-sort text-gray-300'} ml-1 text-xs"></i>
                            </th>`).join('')}
                            <th class="px-4 py-2 text-left">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="instructor-list">
                        ${sortedInstructors.map(inst => `
                            <tr class="border-t hover:bg-gray-50">
                                <td class="px-2 py-2 text-center">
                                    ${inst.profile_photo ? `
                                        <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(inst.profile_photo)}"
                                             alt="${inst.name}"
                                             class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-300"
                                             onerror="this.src='${getDefaultAvatarUrl(inst.gender, inst.name)}'">
                                    ` : `
                                        <img src="${getDefaultAvatarUrl(inst.gender, inst.name)}"
                                             alt="${inst.name}"
                                             class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-300">
                                    `}
                                </td>
                                <td class="px-4 py-2">${inst.code}</td>
                                <td class="px-4 py-2">${inst.name}</td>
                                <td class="px-4 py-2">${inst.major || 'ë°”ì´ì˜¤í—¬ìŠ¤ê´€ë ¨'}</td>
                                <td class="px-4 py-2">${inst.affiliation || ''}</td>
                                <td class="px-4 py-2">${(() => {
                                    const typeInfo = instructorTypes.find(t => t.code === inst.instructor_type);
                                    return typeInfo ? typeInfo.name : '';
                                })()}</td>
                                <td class="px-4 py-2">${inst.phone || ''}</td>
                                <td class="px-4 py-2">
                                    <button onclick="window.editInstructor('${inst.code}')" class="text-blue-600 hover:text-blue-800 mr-2" title="ìˆ˜ì •">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${isMainInstructor() ? `
                                        <button onclick="window.showPasswordChangeModal('${inst.code}', '${inst.name}')" class="text-green-600 hover:text-green-800 mr-2" title="ë¹„ë°€ë²ˆí˜¸ ë³€ê²½">
                                            <i class="fas fa-key"></i>
                                        </button>
                                    ` : ''}
                                    <button onclick="window.deleteInstructor('${inst.code}')" class="text-red-600 hover:text-red-800" title="ì‚­ì œ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    // ê²€ìƒ‰ í•„ë“œ ê°•ì œ ì´ˆê¸°í™” (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
    const clearSearchField = () => {
        const searchInput = document.getElementById('instructor-search');
        if (searchInput) {
            searchInput.value = '';
            searchInput.defaultValue = '';
            // ì…ë ¥ ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒí•˜ì—¬ ë¸Œë¼ìš°ì € ìºì‹œ ë¬´íš¨í™”
            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
    };
    
    // ì¦‰ì‹œ ì‹¤í–‰
    clearSearchField();
    // ì•½ê°„ì˜ ì§€ì—° í›„ ë‹¤ì‹œ ì‹¤í–‰
    setTimeout(clearSearchField, 0);
    setTimeout(clearSearchField, 50);
    setTimeout(clearSearchField, 100);
}

// ê°•ì‚¬ ëª©ë¡ í—¤ë” í´ë¦­ ì •ë ¬
window.sortInstructorTable = function(key) {
    if (instructorSortKey === key) {
        instructorSortAsc = !instructorSortAsc;
    } else {
        instructorSortKey = key;
        instructorSortAsc = true;
    }
    renderInstructors();
};

// ê°•ì‚¬ ê²€ìƒ‰ ë””ë°”ìš´ìŠ¤ (íƒ€ì´í•‘ ì™„ë£Œ í›„ 300ms í›„ ê²€ìƒ‰)
let instructorSearchTimer = null;
window.debounceInstructorSearch = function() {
    if (instructorSearchTimer) clearTimeout(instructorSearchTimer);
    instructorSearchTimer = setTimeout(() => {
        window.filterInstructors();
    }, 300);
};

window.filterInstructors = async function() {
    const search = document.getElementById('instructor-search').value.toLowerCase();
    const typeFilter = document.getElementById('instructor-type-filter').value;
    
    try {
        // ì„œë²„ì—ì„œ ì „ì²´ ê°•ì‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const response = await axios.get(`${API_BASE_URL}/api/instructors`);
        let filteredInstructors = response.data;
        
        // ê°•ì‚¬êµ¬ë¶„ í•„í„° ì ìš©
        if (typeFilter) {
            filteredInstructors = filteredInstructors.filter(inst => 
                inst.instructor_type === typeFilter
            );
        }
        
        // ê²€ìƒ‰ì–´ í•„í„° ì ìš© (ì´ë¦„, ì „ê³µ)
        if (search) {
            filteredInstructors = filteredInstructors.filter(inst => 
                (inst.name && inst.name.toLowerCase().includes(search)) ||
                (inst.major && inst.major.toLowerCase().includes(search))
            );
        }
        
        // í—¤ë” ì •ë ¬ ê¸°ì¤€ ì ìš©
        filteredInstructors.sort((a, b) => {
            let valA, valB;
            if (instructorSortKey === 'role') {
                const typeA = instructorTypes.find(t => t.code === a.instructor_type);
                const typeB = instructorTypes.find(t => t.code === b.instructor_type);
                valA = typeA ? typeA.name : '';
                valB = typeB ? typeB.name : '';
            } else {
                valA = a[instructorSortKey] || '';
                valB = b[instructorSortKey] || '';
            }
            const cmp = String(valA).localeCompare(String(valB), 'ko');
            return instructorSortAsc ? cmp : -cmp;
        });
        
        const tbody = document.getElementById('instructor-list');
        if (filteredInstructors.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-search mr-2"></i>
                        ì¡°ê±´ì— ë§ëŠ” ê°•ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = filteredInstructors.map(inst => `
            <tr class="border-t hover:bg-gray-50">
                <td class="px-2 py-2 text-center">
                    ${inst.profile_photo ? `
                        <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(inst.profile_photo)}"
                             alt="${inst.name}"
                             class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-300"
                             onerror="this.src='${getDefaultAvatarUrl(inst.gender, inst.name)}'">
                    ` : `
                        <img src="${getDefaultAvatarUrl(inst.gender, inst.name)}"
                             alt="${inst.name}"
                             class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-300">
                    `}
                </td>
                <td class="px-4 py-2">${inst.code}</td>
                <td class="px-4 py-2">${inst.name}</td>
                <td class="px-4 py-2">${inst.major || 'ë°”ì´ì˜¤í—¬ìŠ¤ê´€ë ¨'}</td>
                <td class="px-4 py-2">${inst.affiliation || ''}</td>
                <td class="px-4 py-2">${inst.instructor_type_name || inst.type_name || ''}</td>
                <td class="px-4 py-2">${inst.phone || ''}</td>
                <td class="px-4 py-2">
                    <button onclick="window.editInstructor('${inst.code}')" class="text-blue-600 hover:text-blue-800 mr-2" title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${isMainInstructor() ? `
                        <button onclick="window.showPasswordChangeModal('${inst.code}', '${inst.name}')" class="text-green-600 hover:text-green-800 mr-2" title="ë¹„ë°€ë²ˆí˜¸ ë³€ê²½">
                            <i class="fas fa-key"></i>
                        </button>
                    ` : ''}
                    <button onclick="window.deleteInstructor('${inst.code}')" class="text-red-600 hover:text-red-800" title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('í•„í„°ë§ ì‹¤íŒ¨:', error);
    }
}

// ê°•ì‚¬ Excel í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
window.downloadInstructorTemplate = function() {
    // í…œí”Œë¦¿ ë°ì´í„° ìƒì„±
    const templateData = [{
        'ê°•ì‚¬ì½”ë“œ': 'T-001 (ìë™ìƒì„±ë¨)',
        'ì´ë¦„': 'í™ê¸¸ë™',
        'ì—°ë½ì²˜': '010-1234-5678',
        'ì´ë©”ì¼': 'hong@example.com',
        'ì „ê³µ': 'ì»´í“¨í„°ê³µí•™',
        'ê°•ì‚¬êµ¬ë¶„': 'ë‚´ë¶€ê°•ì‚¬',
        'ì†Œì†': 'ìš°ì†¡ëŒ€í•™êµ',
        'ë¹„ê³ ': ''
    }];

    const ws = XLSX.utils.json_to_sheet(templateData);
    ws['!cols'] = [
        { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 25 },
        { wch: 15 }, { wch: 12 }, { wch: 20 }, { wch: 20 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ê°•ì‚¬í…œí”Œë¦¿');
    XLSX.writeFile(wb, 'ê°•ì‚¬_í…œí”Œë¦¿.xlsx');
}

// ê°•ì‚¬ Excel ë‚´ë³´ë‚´ê¸° ì˜µì…˜ ëª¨ë‹¬
window.showInstructorExportOptions = function() {
    const typeOptions = instructorTypes.map(t =>
        `<option value="${t.code}">${t.name}</option>`
    ).join('');

    window.showModal('ê°•ì‚¬ Excel ë‚´ë³´ë‚´ê¸°', `
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2 font-medium">ë‚´ë³´ë‚¼ ê°•ì‚¬êµ¬ë¶„ ì„ íƒ</label>
                <select id="export-instructor-type" class="w-full border rounded px-3 py-2">
                    <option value="">ì „ì²´ ê°•ì‚¬</option>
                    ${typeOptions}
                </select>
            </div>
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                ì„ íƒí•œ êµ¬ë¶„ì˜ ê°•ì‚¬ ëª…ë‹¨ì„ Excel íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
            </p>
            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="window.closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                    ì·¨ì†Œ
                </button>
                <button onclick="window.exportInstructorsToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i>ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </div>
    `);
}

// ê°•ì‚¬ ëª©ë¡ Excel ë‚´ë³´ë‚´ê¸°
window.exportInstructorsToExcel = function() {
    const typeCode = document.getElementById('export-instructor-type')?.value;

    let exportInstructors = [...instructors];
    let fileName = 'ê°•ì‚¬ëª…ë‹¨_ì „ì²´';

    if (typeCode) {
        exportInstructors = instructors.filter(i => i.instructor_type === typeCode);
        const typeName = instructorTypes.find(t => t.code === typeCode)?.name || typeCode;
        fileName = `ê°•ì‚¬ëª…ë‹¨_${typeName}`;
    }

    if (exportInstructors.length === 0) {
        window.showAlert('ë‚´ë³´ë‚¼ ê°•ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    exportInstructors.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));

    const excelData = exportInstructors.map((inst, idx) => ({
        'No': idx + 1,
        'ê°•ì‚¬ì½”ë“œ': inst.code || '',
        'ì´ë¦„': inst.name || '',
        'ì—°ë½ì²˜': inst.phone || '',
        'ì´ë©”ì¼': inst.email || '',
        'ì „ê³µ': inst.major || '',
        'ê°•ì‚¬êµ¬ë¶„': instructorTypes.find(t => t.code === inst.instructor_type)?.name || inst.instructor_type || '',
        'ì†Œì†': inst.affiliation || '',
        'ë¹„ê³ ': inst.note || ''
    }));

    const ws = XLSX.utils.json_to_sheet(excelData);
    ws['!cols'] = [
        { wch: 5 }, { wch: 12 }, { wch: 10 }, { wch: 15 },
        { wch: 25 }, { wch: 15 }, { wch: 12 }, { wch: 20 }, { wch: 20 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ê°•ì‚¬ëª…ë‹¨');

    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(wb, `${fileName}_${today}.xlsx`);

    window.closeModal();
    window.showAlert(`${exportInstructors.length}ëª…ì˜ ê°•ì‚¬ ëª…ë‹¨ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
}

// ê°•ì‚¬ Excel ì—…ë¡œë“œ UI í‘œì‹œ
window.showInstructorExcelUpload = function() {
    const div = document.getElementById('instructor-excel-upload');
    div.classList.remove('hidden');
    div.innerHTML = `
        <h3 class="text-lg font-bold mb-4">ê°•ì‚¬ Excel ì¼ê´„ ì—…ë¡œë“œ</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2">Excel íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="instructor-excel-file" accept=".xlsx,.xls" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                í•„ìˆ˜ ì»¬ëŸ¼: ì´ë¦„ | ì„ íƒ ì»¬ëŸ¼: ì—°ë½ì²˜, ì´ë©”ì¼, ì „ê³µ, ê°•ì‚¬êµ¬ë¶„, ì†Œì†, ë¹„ê³ 
            </p>
            <div class="space-x-2">
                <button onclick="window.uploadInstructorExcel()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-upload mr-2"></i>ì—…ë¡œë“œ
                </button>
                <button onclick="window.hideInstructorExcelUpload()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    `;
}

window.hideInstructorExcelUpload = function() {
    document.getElementById('instructor-excel-upload').classList.add('hidden');
}

// ê°•ì‚¬ Excel ì—…ë¡œë“œ ì²˜ë¦¬
window.uploadInstructorExcel = async function() {
    const fileInput = document.getElementById('instructor-excel-file');
    const file = fileInput?.files[0];

    if (!file) {
        window.showAlert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (jsonData.length === 0) {
            window.showAlert('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        let successCount = 0;
        let failCount = 0;

        for (const row of jsonData) {
            const name = row['ì´ë¦„'] || row['name'];
            if (!name) {
                failCount++;
                continue;
            }

            // ê°•ì‚¬ ì½”ë“œ ìë™ ìƒì„±
            const maxCode = instructors.reduce((max, inst) => {
                const match = inst.code?.match(/T-(\d+)/);
                return match ? Math.max(max, parseInt(match[1])) : max;
            }, 0);
            const newCode = 'T-' + String(maxCode + 1 + successCount).padStart(3, '0');

            // ê°•ì‚¬êµ¬ë¶„ ì½”ë“œ ì°¾ê¸°
            const typeName = row['ê°•ì‚¬êµ¬ë¶„'] || row['instructor_type'] || '';
            const typeCode = instructorTypes.find(t => t.name === typeName)?.code || '';

            const instructorData = {
                code: newCode,
                name: name,
                phone: row['ì—°ë½ì²˜'] || row['phone'] || '',
                email: row['ì´ë©”ì¼'] || row['email'] || '',
                major: row['ì „ê³µ'] || row['major'] || '',
                instructor_type: typeCode,
                affiliation: row['ì†Œì†'] || row['affiliation'] || '',
                note: row['ë¹„ê³ '] || row['note'] || ''
            };

            try {
                await axios.post(`${API_BASE_URL}/api/instructors`, instructorData);
                successCount++;
            } catch (e) {
                console.error('ê°•ì‚¬ ì¶”ê°€ ì‹¤íŒ¨:', e);
                failCount++;
            }
        }

        await loadData();
        renderInstructors();
        window.hideInstructorExcelUpload();

        window.showAlert(`ì—…ë¡œë“œ ì™„ë£Œ!\nì„±ê³µ: ${successCount}ëª…\nì‹¤íŒ¨: ${failCount}ëª…`, successCount > 0 ? 'success' : 'warning');
    } catch (error) {
        console.error('Excel íŒŒì‹± ì‹¤íŒ¨:', error);
        window.showAlert('Excel íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

window.showInstructorForm = function(code = null) {
    const formDiv = document.getElementById('instructor-form');
    formDiv.classList.remove('hidden');

    const existingInst = code ? instructors.find(i => i.code === code) : null;

    // ê°•ì‚¬ ì½”ë“œ ìë™ ìƒì„± (T-001, T-002...)
    let autoCode = '';
    if (!code) {
        const maxCode = instructors.reduce((max, inst) => {
            const match = inst.code.match(/^T-(\d+)$/);
            if (match) {
                const num = parseInt(match[1]);
                return num > max ? num : max;
            }
            return max;
        }, 0);
        autoCode = `T-${String(maxCode + 1).padStart(3, '0')}`;
    }

    // ê³¼ì • ë°°ì • ìƒíƒœ ê²°ì •: course_codesê°€ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ê³¼ì •
    const assignedCourses = existingInst ? (existingInst.course_codes || []) : [];
    const isAllCourses = assignedCourses.length === 0;

    formDiv.innerHTML = `
        <h3 class="text-xl font-bold mb-5 text-gray-800">
            <i class="fas fa-${code ? 'edit' : 'user-plus'} mr-2 text-blue-600"></i>${code ? 'ê°•ì‚¬ ìˆ˜ì •' : 'ê°•ì‚¬ ì¶”ê°€'}
        </h3>
        <input type="hidden" id="instructor-code" value="${code || ''}">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <!-- ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-3">
                    <h4 class="text-white font-semibold text-sm">
                        <i class="fas fa-id-card mr-2"></i>ê¸°ë³¸ ì •ë³´
                    </h4>
                </div>
                <div class="p-4 space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ê°•ì‚¬ì½”ë“œ *</label>
                            <input type="text" id="inst-code" placeholder="T-001" value="${existingInst ? existingInst.code : autoCode}" readonly class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ì´ë¦„ *</label>
                            <input type="text" id="inst-name" placeholder="í™ê¸¸ë™" value="${existingInst ? existingInst.name : ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ì „ê³µ</label>
                            <input type="text" id="inst-major" placeholder="ì»´í“¨í„°ê³µí•™" value="${existingInst ? existingInst.major || '' : ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ê°•ì‚¬êµ¬ë¶„</label>
                            <select id="inst-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                ${instructorTypes.map(type => `
                                    <option value="${type.code}" ${existingInst && existingInst.instructor_type === type.code ? 'selected' : ''}>
                                        ${type.name} (${type.code})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ì—°ë½ì²˜</label>
                            <input type="text" id="inst-phone" placeholder="010-1234-5678" value="${existingInst ? existingInst.phone || '' : ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ì´ë©”ì¼</label>
                            <input type="email" id="inst-email" placeholder="email@example.com" value="${existingInst ? existingInst.email || '' : ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1"><i class="fas fa-building mr-1 text-purple-500"></i>ì†Œì†</label>
                        <input type="text" id="inst-affiliation" placeholder="ì†Œì† ê¸°ê´€/íšŒì‚¬" value="${existingInst ? existingInst.affiliation || '' : ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1"><i class="fas fa-quote-left mr-1 text-blue-500"></i>ì¢Œìš°ëª…</label>
                        <input type="text" id="inst-motto" placeholder="ë‚˜ì˜ ì¢Œìš°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" value="${existingInst ? existingInst.motto || '' : ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì˜ì—­: ê³¼ì • ë°°ì • + í”„ë¡œí•„ -->
            <div class="space-y-5">
                <!-- ê³¼ì • ë°°ì • ì¹´ë“œ -->
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 px-4 py-3">
                        <h4 class="text-white font-semibold text-sm">
                            <i class="fas fa-graduation-cap mr-2"></i>ê³¼ì • ë°°ì •
                        </h4>
                    </div>
                    <div class="p-4">
                        <label class="flex items-center gap-2 mb-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 border border-gray-200">
                            <input type="checkbox" id="inst-all-courses" ${isAllCourses ? 'checked' : ''}
                                   onchange="window.toggleInstructorAllCourses(this.checked)"
                                   class="w-4 h-4 text-emerald-600 rounded focus:ring-emerald-500">
                            <span class="font-semibold text-sm text-gray-700">
                                <i class="fas fa-globe mr-1 text-emerald-500"></i>ì „ì²´ ê³¼ì •
                            </span>
                            <span class="text-xs text-gray-400 ml-auto">ëª¨ë“  ê³¼ì •ì— ë°°ì •</span>
                        </label>
                        <div id="inst-course-list" class="${isAllCourses ? 'opacity-50 pointer-events-none' : ''}">
                            <div class="grid grid-cols-1 gap-1.5 max-h-40 overflow-y-auto pr-1">
                                ${courses.map(c => `
                                    <label class="flex items-center gap-2 cursor-pointer p-1.5 rounded hover:bg-gray-50 text-sm">
                                        <input type="checkbox" name="inst-course" value="${c.code}"
                                               ${assignedCourses.includes(c.code) ? 'checked' : ''}
                                               class="w-3.5 h-3.5 text-emerald-600 rounded focus:ring-emerald-500">
                                        <span class="text-gray-700">${c.name}</span>
                                        <span class="text-xs text-gray-400">(${c.code})</span>
                                    </label>
                                `).join('')}
                                ${courses.length === 0 ? '<p class="text-xs text-gray-400 text-center py-2">ë“±ë¡ëœ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>' : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í”„ë¡œí•„ ì‚¬ì§„ ì¹´ë“œ -->
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <div class="bg-gradient-to-r from-violet-500 to-violet-600 px-4 py-3">
                        <h4 class="text-white font-semibold text-sm">
                            <i class="fas fa-user-circle mr-2"></i>í”„ë¡œí•„ ì‚¬ì§„
                        </h4>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center gap-4">
                            <img id="instructor-profile-photo"
                                 src="${existingInst && existingInst.profile_photo ? API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(existingInst.profile_photo) : 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect fill=%27%23e5e7eb%27 width=%27200%27 height=%27200%27/%3E%3Ctext fill=%27%239ca3af%27 font-family=%27Arial%27 font-size=%2714%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dominant-baseline=%27middle%27%3ENo Photo%3C/text%3E%3C/svg%3E'}"
                                 alt="í”„ë¡œí•„ ì‚¬ì§„"
                                 class="w-20 h-20 rounded-full object-cover border-2 border-gray-300 shadow-sm">
                            <input type="hidden" id="instructor-profile-photo-url" value="${existingInst && existingInst.profile_photo ? existingInst.profile_photo : ''}">
                            <div>
                                <button type="button" onclick="document.getElementById('instructor-profile-input').click()"
                                        class="bg-violet-500 hover:bg-violet-600 text-white px-3 py-1.5 rounded-lg text-sm transition">
                                    <i class="fas fa-camera mr-1"></i>ì‚¬ì§„ ë³€ê²½
                                </button>
                                <input type="file" id="instructor-profile-input" accept="image/*"
                                       onchange="window.handleInstructorProfileUpload(event)" class="hidden">
                                <p class="text-xs text-gray-400 mt-1.5">í”„ë¡œí•„ ì „ìš© (1ê°œ)</p>
                                <div id="instructor-profile-upload-progress" class="hidden mt-2">
                                    <div class="bg-green-50 border border-green-200 rounded p-2">
                                        <p class="text-xs text-green-800 mb-1">
                                            <i class="fas fa-cloud-upload-alt mr-1"></i>ì—…ë¡œë“œ ì¤‘...
                                        </p>
                                        <div class="w-full bg-green-200 rounded-full h-1.5">
                                            <div id="instructor-profile-progress-bar" class="bg-green-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì²¨ë¶€ íŒŒì¼ ì¹´ë“œ (ì „ì²´ ë„ˆë¹„) -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden mt-5">
            <div class="bg-gradient-to-r from-amber-500 to-amber-600 px-4 py-3">
                <h4 class="text-white font-semibold text-sm">
                    <i class="fas fa-paperclip mr-2"></i>ì²¨ë¶€ íŒŒì¼
                    <span class="text-amber-100 font-normal ml-1">(ì´ë ¥ì„œ, ì¦ëª…ì„œ, í¬íŠ¸í´ë¦¬ì˜¤ ë“± - ìµœëŒ€ 20ê°œ)</span>
                </h4>
            </div>
            <div class="p-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                    <div class="flex flex-wrap gap-2 mb-3">
                        <button type="button" onclick="document.getElementById('instructor-file-input').click()"
                                class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded-lg text-sm transition">
                            <i class="fas fa-folder-open mr-1"></i>íŒŒì¼ ì„ íƒ
                        </button>
                        <button type="button" onclick="document.getElementById('instructor-camera-input').click()"
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm transition">
                            <i class="fas fa-camera mr-1"></i>ì‚¬ì§„ ì´¬ì˜
                        </button>
                    </div>
                    <input type="file" id="instructor-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple
                           onchange="window.handleInstructorImageUpload(event)" class="hidden">
                    <input type="file" id="instructor-camera-input" accept="image/*"
                           onchange="window.handleInstructorImageUpload(event)" class="hidden">
                    <div id="instructor-upload-progress" class="hidden mb-3">
                        <div class="bg-blue-50 border border-blue-200 rounded p-3">
                            <p class="text-sm text-blue-800 mb-2">
                                <i class="fas fa-cloud-upload-alt mr-2"></i>
                                ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                            </p>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div id="instructor-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div id="instructor-photos-preview" class="flex flex-col gap-2 mt-2"></div>
                    <input type="hidden" id="instructor-photo-urls" value='${existingInst && existingInst.attachments ? existingInst.attachments : "[]"}'>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        í˜„ì¬ íŒŒì¼: <span id="instructor-file-count">${existingInst && existingInst.attachments ? (function() { try { return JSON.parse(existingInst.attachments).length; } catch(e) { return 0; }})() : 0}</span>/20
                    </p>
                </div>
            </div>
        </div>

        <div class="mt-5 flex gap-3">
            <button onclick="window.saveInstructor('${code || ''}')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition shadow-sm">
                <i class="fas fa-save mr-2"></i>ì €ì¥
            </button>
            <button onclick="window.hideInstructorForm()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2.5 rounded-lg font-medium transition">
                ì·¨ì†Œ
            </button>
        </div>
    `;

    // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    formDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // ê¸°ì¡´ ì²¨ë¶€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    if (existingInst?.attachments) {
        try {
            const attachments = typeof existingInst.attachments === 'string'
                ? JSON.parse(existingInst.attachments)
                : existingInst.attachments;
            updateInstructorPhotoPreview(attachments);
        } catch (e) {
            console.error('ì²¨ë¶€ íŒŒì¼ URL íŒŒì‹± ì˜¤ë¥˜:', e);
        }
    }
}

// ì „ì²´ ê³¼ì • ì²´í¬ë°•ìŠ¤ í† ê¸€
window.toggleInstructorAllCourses = function(checked) {
    const courseList = document.getElementById('inst-course-list');
    if (checked) {
        courseList.classList.add('opacity-50', 'pointer-events-none');
        document.querySelectorAll('input[name="inst-course"]').forEach(cb => cb.checked = false);
    } else {
        courseList.classList.remove('opacity-50', 'pointer-events-none');
    }
}

window.hideInstructorForm = function() {
    document.getElementById('instructor-form').classList.add('hidden');
}

window.saveInstructor = async function(existingCode, autoSave = false) {
    // í”„ë¡œí•„ ì‚¬ì§„ URL ê°€ì ¸ì˜¤ê¸°
    const profilePhotoInput = document.getElementById('instructor-profile-photo-url');
    const profilePhoto = profilePhotoInput ? profilePhotoInput.value : '';
    
    // ì²¨ë¶€ íŒŒì¼ URL ê°€ì ¸ì˜¤ê¸°
    const photoUrlsInput = document.getElementById('instructor-photo-urls');
    const attachments = photoUrlsInput ? JSON.parse(photoUrlsInput.value || '[]') : [];
    
    // ê³¼ì • ë°°ì • ì •ë³´ ìˆ˜ì§‘
    const allCoursesCheckbox = document.getElementById('inst-all-courses');
    let courseCodes = [];
    if (allCoursesCheckbox && !allCoursesCheckbox.checked) {
        document.querySelectorAll('input[name="inst-course"]:checked').forEach(cb => {
            courseCodes.push(cb.value);
        });
    }

    const data = {
        code: document.getElementById('inst-code').value,
        name: document.getElementById('inst-name').value,
        major: document.getElementById('inst-major').value,
        instructor_type: document.getElementById('inst-type').value,
        phone: document.getElementById('inst-phone').value,
        email: document.getElementById('inst-email').value,
        affiliation: document.getElementById('inst-affiliation')?.value || '',
        motto: document.getElementById('inst-motto')?.value || '',
        profile_photo: profilePhoto,
        attachments: JSON.stringify(attachments),
        course_codes: courseCodes
    };
    
    try {
        if (existingCode) {
            await axios.put(`${API_BASE_URL}/api/instructors/${existingCode}`, data);
            if (!autoSave) {
                window.showAlert('âœ… ê°•ì‚¬ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        } else {
            await axios.post(`${API_BASE_URL}/api/instructors`, data);
            if (!autoSave) {
                window.showAlert('âœ… ê°•ì‚¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        }
        if (!autoSave) {
            window.hideInstructorForm();
            loadInstructors();
        }
    } catch (error) {
        window.showAlert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

window.editInstructor = function(code) {
    window.showInstructorForm(code);
}

window.deleteInstructor = async function(code) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const confirmed = await window.showConfirm('âš ï¸ ì´ ê°•ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/instructors/${code}`);
        window.showAlert('âœ… ê°•ì‚¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        loadInstructors();
    } catch (error) {
        window.showAlert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ==================== ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ (ì£¼ê°•ì‚¬ ì „ìš©) ====================

window.showPasswordChangeModal = function(code, name) {
    const modal = document.getElementById('password-change-modal');
    if (!modal) return;
    
    document.getElementById('pwd-instructor-code-modal').value = code;
    document.getElementById('pwd-target-instructor').textContent = `${name} (${code})`;
    document.getElementById('pwd-new-password-modal').value = '';
    document.getElementById('pwd-confirm-password-modal').value = '';
    modal.classList.remove('hidden');
    
    // ìŠ¤í¬ë¡¤ì„ ëª¨ë‹¬ ìœ„ì¹˜ë¡œ ì´ë™
    modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

window.hidePasswordChangeModal = function() {
    const modal = document.getElementById('password-change-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

window.changePasswordFromModal = async function() {
    const instructorCode = document.getElementById('pwd-instructor-code-modal').value;
    const newPassword = document.getElementById('pwd-new-password-modal').value;
    const confirmPassword = document.getElementById('pwd-confirm-password-modal').value;
    
    if (!newPassword || !confirmPassword) {
        window.showAlert('âš ï¸ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        window.showAlert('âš ï¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warning');
        return;
    }
    
    if (newPassword.length < 4) {
        window.showAlert('âš ï¸ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
        return;
    }
    
    try {
        await axios.post(`${API_BASE_URL}/api/auth/change-password`, {
            instructor_code: instructorCode,
            new_password: newPassword
        });
        
        window.showAlert('âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        window.hidePasswordChangeModal();
    } catch (error) {
        window.showAlert('âŒ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

window.resetPasswordFromModal = async function() {
    const instructorCode = document.getElementById('pwd-instructor-code-modal').value;
    const targetName = document.getElementById('pwd-target-instructor').textContent;
    
    const confirmed = await window.showConfirm(`âš ï¸ ${targetName}ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê¸°ë³¸ê°’(kdt2025)ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if (!confirmed) return;
    
    try {
        await axios.post(`${API_BASE_URL}/api/auth/change-password`, {
            instructor_code: instructorCode,
            new_password: 'kdt2025'
        });
        
        window.showAlert('âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤! (ê¸°ë³¸ê°’: kdt2025)', 'success');
        window.hidePasswordChangeModal();
    } catch (error) {
        window.showAlert('âŒ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ê°•ì‚¬ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
window.handleInstructorProfileUpload = async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
    if (!file.type.startsWith('image/')) {
        window.showAlert('âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
        event.target.value = '';
        return;
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìš”ì†Œ
    const progressDiv = document.getElementById('instructor-profile-upload-progress');
    const progressBar = document.getElementById('instructor-profile-progress-bar');
    
    try {
        // íŒŒì¼ ì••ì¶• (Cafe24 1MB ì œí•œ ëŒ€ì‘)
        let uploadFile = file;
        const originalSize = file.size / 1024 / 1024; // MB
        
        if (file.size > 1 * 1024 * 1024) {  // 1MB ì´ìƒì´ë©´ ì••ì¶•
            window.showAlert('ğŸ“¦ ì´ë¯¸ì§€ë¥¼ ìµœì í™”í•˜ëŠ” ì¤‘...', 'info');
            uploadFile = await compressImage(file, 1);  // 1MB ì´í•˜ë¡œ ì••ì¶•
            const compressedSize = uploadFile.size / 1024 / 1024;
            console.log(`âœ… ì´ë¯¸ì§€ ì••ì¶•: ${originalSize.toFixed(2)}MB â†’ ${compressedSize.toFixed(2)}MB`);
        }
        
        // ìµœì¢… í¬ê¸° í™•ì¸
        if (uploadFile.size > 1 * 1024 * 1024) {
            window.showAlert('âš ï¸ íŒŒì¼ í¬ê¸°ëŠ” 1MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní˜„ì¬ í¬ê¸°: ' + (uploadFile.size / 1024 / 1024).toFixed(2) + 'MB', 'warning');
            event.target.value = '';
            return;
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ
        if (progressDiv) {
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
        }
        
        const formData = new FormData();
        formData.append('file', uploadFile);
        
        const response = await axios.post(
            `${API_BASE_URL}/api/upload-image?category=teacher`,
            formData,
            {
                headers: { 'Content-Type': 'multipart/form-data' },
                onUploadProgress: (progressEvent) => {
                    const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                    if (progressBar) {
                        progressBar.style.width = percentCompleted + '%';
                    }
                }
            }
        );
        
        if (response.data.success) {
            const profilePhotoUrl = response.data.url;
            // ê°•ë ¥í•œ ìºì‹œ ë²„ìŠ¤íŒ…
            const timestamp = new Date().getTime();
            const random = Math.random().toString(36).substring(7);
            document.getElementById('instructor-profile-photo').src = API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(profilePhotoUrl) + '&t=' + timestamp + '&r=' + random;
            document.getElementById('instructor-profile-photo-url').value = profilePhotoUrl;
            
            // ìë™ ì €ì¥
            const instructorCodeInput = document.getElementById('instructor-code');
            const existingCode = instructorCodeInput ? instructorCodeInput.value : null;
            if (existingCode) {
                await window.saveInstructor(existingCode, true);
                window.showAlert('âœ… í”„ë¡œí•„ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else {
                window.showAlert('âœ… í”„ë¡œí•„ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) {
            setTimeout(() => {
                progressDiv.classList.add('hidden');
            }, 1000);
        }
    } catch (error) {
        console.error('í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        
        // ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„ 
        let errorMsg = 'âŒ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
        if (error.response?.status === 413) {
            errorMsg = 'âŒ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤!\n\níŒŒì¼ í¬ê¸°ë¥¼ 5MB ì´í•˜ë¡œ ì¤„ì—¬ì£¼ì„¸ìš”.';
        } else if (error.response?.data?.detail) {
            errorMsg = 'âŒ ' + error.response.data.detail;
        } else if (error.message) {
            errorMsg += ': ' + error.message;
        }
        
        window.showAlert(errorMsg, 'error');
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) {
            progressDiv.classList.add('hidden');
        }
    }
    
    // íŒŒì¼ input ì´ˆê¸°í™”
    event.target.value = '';
};

// ê°•ì‚¬ ì²¨ë¶€ íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ìµœëŒ€ 20ê°œ)
window.handleInstructorImageUpload = async function(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // íŒŒì¼ ê²€ì¦
    for (let file of files) {
        const validation = window.validateFile(file);
        if (!validation.valid) {
            window.showAlert(validation.message, 'warning');
            event.target.value = '';
            return;
        }
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” í‘œì‹œ
    const progressDiv = document.getElementById('instructor-upload-progress');
    const progressBar = document.getElementById('instructor-progress-bar');
    if (progressDiv) {
        progressDiv.classList.remove('hidden');
        progressBar.style.width = '0%';
    }
    
    try {
        const photoUrlsInput = document.getElementById('instructor-photo-urls');
        const photoUrls = JSON.parse(photoUrlsInput.value || '[]');
        
        // 20ê°œ ì œí•œ ì²´í¬
        const remainingSlots = 20 - photoUrls.length;
        if (remainingSlots <= 0) {
            if (progressDiv) progressDiv.classList.add('hidden');
            window.showAlert('âš ï¸ ì²¨ë¶€ íŒŒì¼ì€ ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
            event.target.value = '';
            return;
        }
        
        if (files.length > remainingSlots) {
            if (progressDiv) progressDiv.classList.add('hidden');
            window.showAlert(`âš ï¸ ${remainingSlots}ê°œì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${photoUrls.length}/20)`, 'warning');
            event.target.value = '';
            return;
        }
        
        const totalFiles = files.length;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ì´ë¯¸ì§€ ìë™ ì••ì¶• (PDF ë“±ì€ ê·¸ëŒ€ë¡œ)
            let processedFile = file;
            if (file.type.startsWith('image/')) {
                try {
                    processedFile = await window.compressImage(file);
                    console.log(`ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
                    processedFile = file;
                }
            }
            
            const formData = new FormData();
            formData.append('file', processedFile);
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
            const progress = ((i + 0.5) / totalFiles) * 100;
            if (progressBar) progressBar.style.width = `${progress}%`;
            
            const response = await axios.post(
                `${API_BASE_URL}/api/upload-image?category=teacher`,
                formData,
                { headers: { 'Content-Type': 'multipart/form-data' } }
            );
            
            if (response.data.success) {
                // URLê³¼ ì›ë³¸ íŒŒì¼ëª…ì„ í•¨ê»˜ ì €ì¥ (URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹)
                const urlWithOriginalName = response.data.original_filename 
                    ? `${response.data.url}#${encodeURIComponent(response.data.original_filename)}`
                    : response.data.url;
                photoUrls.push(urlWithOriginalName);
            }
            
            // ì™„ë£Œ í”„ë¡œê·¸ë ˆìŠ¤
            const completeProgress = ((i + 1) / totalFiles) * 100;
            if (progressBar) progressBar.style.width = `${completeProgress}%`;
        }
        
        photoUrlsInput.value = JSON.stringify(photoUrls);
        updateInstructorPhotoPreview(photoUrls);
        
        // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        const fileCountSpan = document.getElementById('instructor-file-count');
        if (fileCountSpan) {
            fileCountSpan.textContent = photoUrls.length;
        }
        
        // ìë™ ì €ì¥ (í™”ë©´ ìœ ì§€)
        const instructorCodeInput = document.getElementById('instructor-code');
        const existingCode = instructorCodeInput ? instructorCodeInput.value : null;
        if (existingCode) {
            await window.saveInstructor(existingCode, true);
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) {
            setTimeout(() => {
                progressDiv.classList.add('hidden');
            }, 1000);
        }
        
        // ê°•ì‚¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const instructorNameInput = document.querySelector('input[name="name"]');
        const instructorName = instructorNameInput ? instructorNameInput.value : '';
        const contextMsg = instructorName ? `${instructorName} ê°•ì‚¬ì—ê²Œ ` : '';
        window.showAlert(`âœ… ${contextMsg}${files.length}ê°œ íŒŒì¼ì´ ì—…ë¡œë“œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (${photoUrls.length}/20)`, 'success');
        
    } catch (error) {
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) progressDiv.classList.add('hidden');
        
        console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
    
    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
    event.target.value = '';
}

// ê°•ì‚¬ ì‚¬ì§„ ì‚­ì œ
window.removeInstructorPhoto = async function(index) {
    // ì‚­ì œ í™•ì¸
    const confirmed = await window.showConfirm('âš ï¸ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ íŒŒì¼ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    const photoUrlsInput = document.getElementById('instructor-photo-urls');
    const photoUrls = JSON.parse(photoUrlsInput.value || '[]');
    
    photoUrls.splice(index, 1);
    photoUrlsInput.value = JSON.stringify(photoUrls);
    updateInstructorPhotoPreview(photoUrls);
    
    // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    const fileCountSpan = document.getElementById('instructor-file-count');
    if (fileCountSpan) {
        fileCountSpan.textContent = photoUrls.length;
    }
    
    // ìë™ ì €ì¥ (í™”ë©´ ìœ ì§€)
    const instructorCodeInput = document.getElementById('instructor-code');
    const existingCode = instructorCodeInput ? instructorCodeInput.value : null;
    if (existingCode) {
        await window.saveInstructor(existingCode, true);
        
        // ê°•ì‚¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const instructorNameInput = document.querySelector('input[name="name"]');
        const instructorName = instructorNameInput ? instructorNameInput.value : '';
        const contextMsg = instructorName ? `${instructorName} ê°•ì‚¬ì—ê²Œì„œ ` : '';
        window.showAlert(`âœ… ${contextMsg}íŒŒì¼ì´ ì‚­ì œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${photoUrls.length}/20)`, 'success');
    }
}

// ê°•ì‚¬ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updateInstructorPhotoPreview(photoUrls) {
    const previewDiv = document.getElementById('instructor-photos-preview');
    if (!previewDiv) return;
    
    if (!photoUrls || photoUrls.length === 0) {
        previewDiv.innerHTML = '<p class="text-gray-400 text-sm">ì²¨ë¶€ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    previewDiv.innerHTML = photoUrls.map((url, index) => 
        window.createFilePreviewItem(url, index, 'window.removeInstructorPhoto')
    ).join('');
}

// ==================== ê³µíœ´ì¼ ê´€ë¦¬ ====================
let holidays = [];

async function loadHolidays() {
    try {
        // year íŒŒë¼ë¯¸í„° ì œê±° - ëª¨ë“  ì—°ë„ì˜ ê³µíœ´ì¼ í‘œì‹œ
        const response = await axios.get(`${API_BASE_URL}/api/holidays`);
        holidays = response.data;
        console.log('âœ… ê³µíœ´ì¼ ë¡œë“œ ì™„ë£Œ:', holidays.length, 'ê°œ');
        renderHolidays();
    } catch (error) {
        console.error('âŒ ê³µíœ´ì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ê³µíœ´ì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderHolidays() {
    // í˜„ì¬ í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
    const filterYear = window.holidayFilterYear || 'all';
    const filterType = window.holidayFilterType || 'all';
    const searchText = window.holidaySearchText || '';
    
    // í•„í„°ë§ ì ìš©
    let filteredHolidays = holidays.filter(h => {
        // ì—°ë„ í•„í„°
        if (filterYear !== 'all') {
            const year = h.holiday_date.substring(0, 4);
            if (year !== filterYear) return false;
        }
        
        // êµ¬ë¶„ í•„í„° (ë²•ì •/ì¼ë°˜)
        if (filterType === 'legal' && !h.is_legal) return false;
        if (filterType === 'normal' && h.is_legal) return false;
        
        // ê²€ìƒ‰ì–´ í•„í„°
        if (searchText) {
            const searchLower = searchText.toLowerCase();
            return h.name.toLowerCase().includes(searchLower) || 
                   h.holiday_date.includes(searchText);
        }
        
        return true;
    });
    
    // ì—°ë„ ëª©ë¡ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
    const years = [...new Set(holidays.map(h => h.holiday_date.substring(0, 4)))].sort().reverse();
    
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-calendar-alt mr-2"></i>ê³µíœ´ì¼ ê´€ë¦¬
                </h2>
                <button onclick="window.showHolidayForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>ê³µíœ´ì¼ ì¶”ê°€
                </button>
            </div>
            
            <!-- í•„í„° ì„¹ì…˜ -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- ê²€ìƒ‰ -->
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">
                            <i class="fas fa-search mr-1"></i>ê²€ìƒ‰
                        </label>
                        <input type="text" id="holiday-search" 
                               value="${searchText}"
                               placeholder="ê³µíœ´ì¼ëª… ë˜ëŠ” ë‚ ì§œ" 
                               class="w-full px-3 py-2 border rounded text-sm"
                               oninput="window.filterHolidays()">
                    </div>
                    
                    <!-- ì—°ë„ í•„í„° -->
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">
                            <i class="fas fa-calendar mr-1"></i>ì—°ë„
                        </label>
                        <select id="holiday-year-filter" 
                                class="w-full px-3 py-2 border rounded text-sm"
                                onchange="window.filterHolidays()">
                            <option value="all" ${filterYear === 'all' ? 'selected' : ''}>ì „ì²´</option>
                            ${years.map(year => `
                                <option value="${year}" ${filterYear === year ? 'selected' : ''}>${year}ë…„</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <!-- êµ¬ë¶„ í•„í„° -->
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">
                            <i class="fas fa-filter mr-1"></i>êµ¬ë¶„
                        </label>
                        <select id="holiday-type-filter" 
                                class="w-full px-3 py-2 border rounded text-sm"
                                onchange="window.filterHolidays()">
                            <option value="all" ${filterType === 'all' ? 'selected' : ''}>ì „ì²´</option>
                            <option value="legal" ${filterType === 'legal' ? 'selected' : ''}>ë²•ì •ê³µíœ´ì¼</option>
                            <option value="normal" ${filterType === 'normal' ? 'selected' : ''}>ì¼ë°˜</option>
                        </select>
                    </div>
                    
                    <!-- í•„í„° ì´ˆê¸°í™” -->
                    <div class="flex items-end">
                        <button onclick="window.resetHolidayFilters()" 
                                class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded text-sm">
                            <i class="fas fa-redo mr-1"></i>í•„í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
                
                <!-- í•„í„° ê²°ê³¼ í‘œì‹œ -->
                <div class="mt-3 text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    ì „ì²´ ${holidays.length}ê°œ ì¤‘ ${filteredHolidays.length}ê°œ í‘œì‹œ
                </div>
            </div>
            
            <div id="holiday-form" class="hidden mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200"></div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">ë‚ ì§œ</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">ê³µíœ´ì¼ëª…</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">êµ¬ë¶„</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredHolidays.length > 0 ? filteredHolidays.map(h => `
                            <tr class="border-t hover:bg-gray-50">
                                <td class="px-4 py-2 text-sm">${h.holiday_date}</td>
                                <td class="px-4 py-2 text-sm font-semibold">${h.name}</td>
                                <td class="px-4 py-2 text-xs">
                                    <span class="${h.is_legal ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'} px-2 py-1 rounded text-xs">
                                        ${h.is_legal ? 'ë²•ì •ê³µíœ´ì¼' : 'ì¼ë°˜'}
                                    </span>
                                </td>
                                <td class="px-4 py-2 text-xs">
                                    <button onclick="window.editHoliday(${h.id})" 
                                            class="text-blue-600 hover:text-blue-800 mr-2"
                                            title="ìˆ˜ì •">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.deleteHoliday(${h.id})" 
                                            class="text-red-600 hover:text-red-800"
                                            title="ì‚­ì œ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('') : `
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                    <i class="fas fa-inbox text-3xl mb-2"></i>
                                    <p>í•„í„° ì¡°ê±´ì— ë§ëŠ” ê³µíœ´ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                </td>
                            </tr>
                        `}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

window.showHolidayForm = function(id = null) {
    const formDiv = document.getElementById('holiday-form');
    formDiv.classList.remove('hidden');
    
    const existingHoliday = id ? holidays.find(h => h.id === id) : null;
    
    // í˜„ì¬ ì—°ë„ë¶€í„° 5ë…„ í›„ê¹Œì§€ ìƒì„±
    const currentYear = new Date().getFullYear();
    const years = Array.from({length: 10}, (_, i) => currentYear + i);
    
    formDiv.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">${id ? 'ê³µíœ´ì¼ ìˆ˜ì •' : 'ê³µíœ´ì¼ ì¶”ê°€'}</h3>
            ${!id ? `
                <button onclick="window.showAutoHolidayModal()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                    <i class="fas fa-magic mr-2"></i>ë²•ì •ê³µíœ´ì¼ ìë™ ì¶”ê°€
                </button>
            ` : ''}
        </div>
        
        ${!id ? `
            <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded">
                <p class="text-sm text-green-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    <strong>ë²•ì •ê³µíœ´ì¼ ìë™ ì¶”ê°€</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì—°ë„ë³„ ë²•ì •ê³µíœ´ì¼ì„ í•œë²ˆì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
        ` : ''}
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-xs text-gray-600 mb-1">ë‚ ì§œ</label>
                <input type="date" id="holiday-date" 
                       value="${existingHoliday ? existingHoliday.holiday_date : ''}" 
                       class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block text-xs text-gray-600 mb-1">ê³µíœ´ì¼ëª…</label>
                <input type="text" id="holiday-name" 
                       placeholder="ê³µíœ´ì¼ëª…" 
                       value="${existingHoliday ? existingHoliday.name : ''}" 
                       class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block text-xs text-gray-600 mb-1">êµ¬ë¶„</label>
                <select id="holiday-legal" class="w-full border rounded px-3 py-2">
                    <option value="1" ${existingHoliday && existingHoliday.is_legal ? 'selected' : ''}>ë²•ì •ê³µíœ´ì¼</option>
                    <option value="0" ${existingHoliday && !existingHoliday.is_legal ? 'selected' : ''}>ì¼ë°˜</option>
                </select>
            </div>
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button onclick="window.hideHolidayForm()" 
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
                <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
            </button>
            <button onclick="window.saveHoliday(${id || 'null'})" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                <i class="fas fa-save mr-2"></i>ì €ì¥
            </button>
        </div>
    `;
}

window.hideHolidayForm = function() {
    document.getElementById('holiday-form').classList.add('hidden');
}

window.saveHoliday = async function(id) {
    const data = {
        holiday_date: document.getElementById('holiday-date').value,
        name: document.getElementById('holiday-name').value,
        is_legal: parseInt(document.getElementById('holiday-legal').value)
    };
    
    try {
        if (id) {
            await axios.put(`${API_BASE_URL}/api/holidays/${id}`, data);
            window.showAlert('âœ… ê³µíœ´ì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            const response = await axios.post(`${API_BASE_URL}/api/holidays`, data);
            // ì¤‘ë³µì¸ ê²½ìš°ì—ë„ ì—ëŸ¬ ì—†ì´ ì²˜ë¦¬
            if (response.data.message && response.data.message.includes('ì´ë¯¸ ë“±ë¡')) {
                console.log('â„¹ï¸ ì´ë¯¸ ë“±ë¡ëœ ê³µíœ´ì¼:', data.holiday_date, data.name);
                // ì—ëŸ¬ ë©”ì‹œì§€ ì—†ì´ ì¡°ìš©íˆ ì²˜ë¦¬
            } else {
                window.showAlert('âœ… ê³µíœ´ì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        }
        window.hideHolidayForm();
        loadHolidays();
    } catch (error) {
        window.showAlert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

window.editHoliday = function(id) {
    window.showHolidayForm(id);
}

window.deleteHoliday = async function(id) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const confirmed = await window.showConfirm('âš ï¸ ì´ ê³µíœ´ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/holidays/${id}`);
        window.showAlert('âœ… ê³µíœ´ì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        loadHolidays();
    } catch (error) {
        window.showAlert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ê³µíœ´ì¼ í•„í„° í•¨ìˆ˜
window.filterHolidays = function() {
    // í˜„ì¬ í•„í„° ê°’ ì €ì¥
    window.holidaySearchText = document.getElementById('holiday-search')?.value || '';
    window.holidayFilterYear = document.getElementById('holiday-year-filter')?.value || 'all';
    window.holidayFilterType = document.getElementById('holiday-type-filter')?.value || 'all';
    
    // ë‹¤ì‹œ ë Œë”ë§
    renderHolidays();
}

// ê³µíœ´ì¼ í•„í„° ì´ˆê¸°í™”
window.resetHolidayFilters = function() {
    window.holidaySearchText = '';
    window.holidayFilterYear = 'all';
    window.holidayFilterType = 'all';
    
    renderHolidays();
}

// ë²•ì •ê³µíœ´ì¼ ìë™ ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
window.showAutoHolidayModal = function() {
    const currentYear = new Date().getFullYear();
    const years = Array.from({length: 10}, (_, i) => currentYear + i);
    
    const modal = document.createElement('div');
    modal.id = 'auto-holiday-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-magic mr-2 text-green-600"></i>ë²•ì •ê³µíœ´ì¼ ìë™ ì¶”ê°€
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë„ ì„ íƒ</label>
                    <select id="auto-holiday-year" class="w-full border rounded px-3 py-2">
                        ${years.map(year => `<option value="${year}">${year}ë…„</option>`).join('')}
                    </select>
                </div>
                
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        ì„ íƒí•œ ì—°ë„ì˜ ë²•ì •ê³µíœ´ì¼ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.<br>
                        ì´ë¯¸ ë“±ë¡ëœ ê³µíœ´ì¼ì€ ì¤‘ë³µ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600">
                        ì¶”ê°€ë  ê³µíœ´ì¼:
                    </p>
                    <ul class="mt-2 text-sm text-gray-700 space-y-1">
                        <li>â€¢ ì‹ ì • (1ì›” 1ì¼)</li>
                        <li>â€¢ ì„¤ë‚  ì—°íœ´ (ìŒë ¥ 12ì›” 30ì¼ ~ 1ì›” 2ì¼)</li>
                        <li>â€¢ ì‚¼ì¼ì ˆ (3ì›” 1ì¼)</li>
                        <li>â€¢ ì–´ë¦°ì´ë‚  (5ì›” 5ì¼)</li>
                        <li>â€¢ ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚  (ìŒë ¥ 4ì›” 8ì¼)</li>
                        <li>â€¢ í˜„ì¶©ì¼ (6ì›” 6ì¼)</li>
                        <li>â€¢ ê´‘ë³µì ˆ (8ì›” 15ì¼)</li>
                        <li>â€¢ ì¶”ì„ ì—°íœ´ (ìŒë ¥ 8ì›” 14ì¼ ~ 16ì¼)</li>
                        <li>â€¢ ê°œì²œì ˆ (10ì›” 3ì¼)</li>
                        <li>â€¢ í•œê¸€ë‚  (10ì›” 9ì¼)</li>
                        <li>â€¢ ì„±íƒ„ì ˆ (12ì›” 25ì¼)</li>
                        <li>â€¢ ëŒ€ì²´ê³µíœ´ì¼ (í•´ë‹¹ ì‹œ)</li>
                    </ul>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button onclick="window.closeAutoHolidayModal()" 
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
                        <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                    </button>
                    <button onclick="window.autoAddHolidays()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-plus mr-2"></i>ìë™ ì¶”ê°€
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// ìë™ ì¶”ê°€ ëª¨ë‹¬ ë‹«ê¸°
window.closeAutoHolidayModal = function() {
    const modal = document.getElementById('auto-holiday-modal');
    if (modal) modal.remove();
}

// ë²•ì •ê³µíœ´ì¼ ìë™ ì¶”ê°€ ì‹¤í–‰
window.autoAddHolidays = async function() {
    const year = parseInt(document.getElementById('auto-holiday-year').value);
    
    try {
        window.showLoading('ë²•ì •ê³µíœ´ì¼ì„ ì¶”ê°€í•˜ëŠ” ì¤‘...');
        
        // ë°±ì—”ë“œ API í˜¸ì¶œ
        const response = await axios.post(`${API_BASE_URL}/api/holidays/auto-add/${year}`);
        
        window.hideLoading();
        window.closeAutoHolidayModal();
        window.hideHolidayForm();
        
        const result = response.data;
        window.showAlert(
            `âœ… ${year}ë…„ ë²•ì •ê³µíœ´ì¼ ìë™ ì¶”ê°€ ì™„ë£Œ!\n\n` +
            `ì¶”ê°€ëœ ê³µíœ´ì¼: ${result.added}ê°œ\n` +
            `ì´ë¯¸ ë“±ë¡ë¨: ${result.skipped}ê°œ\n` +
            `ì´ ì²˜ë¦¬: ${result.total}ê°œ`,
            'success'
        );
        
        await loadHolidays();
    } catch (error) {
        window.hideLoading();
        console.error('ìë™ ì¶”ê°€ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ìë™ ì¶”ê°€ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ==================== ê³¼ì • ê´€ë¦¬ ====================
let courseSubjects = {}; // ê³¼ì •ë³„ ì„ íƒëœ êµê³¼ëª© ì €ì¥

async function loadCourses() {
    try {
        window.showLoading('ê³¼ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const response = await axios.get(`${API_BASE_URL}/api/courses`);
        courses = response.data;
        
        // ê° ê³¼ì •ë³„ ì„ íƒëœ êµê³¼ëª©ì„ DBì—ì„œ ë¡œë“œ
        courses.forEach(course => {
            // DBì—ì„œ ê°€ì ¸ì˜¨ êµê³¼ëª© ëª©ë¡ ì‚¬ìš©
            courseSubjects[course.code] = course.subjects || [];
        });
        
        console.log('âœ… ê³¼ì • ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', courses.length, 'ê°œ');
        console.log('âœ… êµê³¼ëª© ì •ë³´:', courseSubjects);
        
        renderCourses();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('âŒ ê³¼ì • ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ê³¼ì • ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

// ê³¼ì • ê¸°ê°„ ë‚´ ê³µíœ´ì¼ ê°€ì ¸ì˜¤ê¸°
async function getCourseHolidays(startDate, endDate) {
    if (!startDate || !endDate) return [];
    
    try {
        const response = await axios.get(`${API_BASE_URL}/api/holidays`);
        const allHolidays = response.data;
        
        // ê³¼ì • ê¸°ê°„ ë‚´ ê³µíœ´ì¼ë§Œ í•„í„°ë§
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        const courseHolidays = allHolidays.filter(h => {
            const holidayDate = new Date(h.holiday_date);
            return holidayDate >= start && holidayDate <= end;
        });
        
        console.log('ê³¼ì • ê¸°ê°„ ë‚´ ê³µíœ´ì¼:', courseHolidays);
        return courseHolidays;
    } catch (error) {
        console.error('ê³µíœ´ì¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
        return [];
    }
}

function renderCourseDetail(course) {
    console.log(`ğŸ“ renderCourseDetail í˜¸ì¶œ - ê³¼ì •: ${course.code}, courseSubjects:`, courseSubjects);
    
    // ë‚ ì§œ í¬ë§· í—¬í¼ í•¨ìˆ˜ (YYYY-MM-DD -> Mì›” Dì¼)
    const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}ì›” ${day}ì¼`;
    };
    
    // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ì¼ìˆ˜)
    const calcDaysDiff = (startDate, endDate) => {
        if (!startDate || !endDate) return 0;
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diff = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end date
        return diff > 0 ? diff : 0;
    };
    
    // ì‹¤ì œ DB ë°ì´í„° ì‚¬ìš©
    const totalDays = course.total_days || 0;
    const lectureHours = course.lecture_hours || 0;
    const projectHours = course.project_hours || 0;
    const internHours = course.workship_hours || 0;
    const morningHours = course.morning_hours != null ? Number(course.morning_hours) : 4;
    const afternoonHours = course.afternoon_hours != null ? Number(course.afternoon_hours) : 4;
    const dailyHours = morningHours + afternoonHours;
    
    // ì¼ìˆ˜ ê³„ì‚° (ì‹¤ì œ ì¼ì¼ ìˆ˜ì—…ì‹œê°„ ê¸°ì¤€)
    const lectureDays = (lectureHours > 0 && dailyHours > 0) ? Math.ceil(lectureHours / dailyHours) : 0;
    const projectDays = (projectHours > 0 && dailyHours > 0) ? Math.ceil(projectHours / dailyHours) : 0;
    const internDays = (internHours > 0 && dailyHours > 0) ? Math.ceil(internHours / dailyHours) : 0;
    
    // í¼ì„¼íŠ¸ ê³„ì‚°
    const lecturePercent = totalDays > 0 ? Math.floor((lectureDays / totalDays) * 100) : 0;
    const projectPercent = totalDays > 0 ? Math.floor((projectDays / totalDays) * 100) : 0;
    const internPercent = totalDays > 0 ? Math.floor((internDays / totalDays) * 100) : 0;
    
    // DBì˜ ì‹¤ì œ ì¢…ë£Œì¼ ì‚¬ìš©
    const lectureEndDate = formatDate(course.lecture_end_date);
    const projectEndDate = formatDate(course.project_end_date);
    const internEndDate = formatDate(course.workship_end_date);
    
    // ê·¼ë¬´ì¼ í•©ê³„
    const workDays = lectureDays + projectDays + internDays;
    
    // ì œì™¸ì¼ ê³„ì‚°
    const excludedDays = totalDays > workDays ? totalDays - workDays : 0;
    const weekends = totalDays > 0 ? Math.floor(totalDays / 7) * 2 : 0;
    const holidays = excludedDays > weekends ? excludedDays - weekends : 0;
    
    return `
        <div class="p-6">
            <!-- ê³¼ì • ì‹œì‘ì¼ -->
            <div class="mb-6 bg-blue-50 border-l-4 border-blue-500 p-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt mr-2"></i>ê³¼ì • ì‹œì‘ì¼
                </label>
                <input type="date" id="course-start-date" value="${course.start_date || ''}" 
                       class="px-3 py-2 border rounded" onchange="window.updateCourseDate('${course.code}')">
            </div>
            
            <!-- ê³¼ì • ê°œìš” (ì´ ì‹œê°„ í‘œì‹œ) -->
            <div class="mb-6 bg-gray-50 p-4 rounded">
                <h3 class="font-bold text-lg mb-3">
                    <i class="fas fa-clock mr-2"></i>ê³¼ì • ê°œìš” (ì´ ${lectureHours + projectHours + internHours}ì‹œê°„)
                </h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-blue-100 p-3 rounded">
                        <label class="block text-xs text-gray-600 mb-2">ì´ë¡ </label>
                        <div class="flex items-center mb-2">
                            <input type="number" id="theory-hours" value="${lectureHours}" 
                                   class="w-20 px-2 py-1 border rounded text-sm" onchange="window.updateCourseHours('${course.code}')">
                            <span class="ml-2 text-sm font-semibold">h</span>
                        </div>
                        <div class="text-xs text-blue-700 font-semibold">
                            ì•½ ${lectureDays}ì¼ (${lecturePercent}%)
                        </div>
                        <div class="text-xs text-blue-600 mt-1">
                            ${course.start_date ? formatDate(course.start_date) : '-'} ~ ${lectureEndDate}
                        </div>
                    </div>
                    <div class="bg-green-100 p-3 rounded">
                        <label class="block text-xs text-gray-600 mb-2">í”„ë¡œì íŠ¸</label>
                        <div class="flex items-center mb-2">
                            <input type="number" id="project-hours" value="${projectHours}" 
                                   class="w-20 px-2 py-1 border rounded text-sm" onchange="window.updateCourseHours('${course.code}')">
                            <span class="ml-2 text-sm font-semibold">h</span>
                        </div>
                        <div class="text-xs text-green-700 font-semibold">
                            ì•½ ${projectDays}ì¼ (${projectPercent}%)
                        </div>
                        <div class="text-xs text-green-600 mt-1">
                            ${lectureEndDate} ~ ${projectEndDate}
                        </div>
                    </div>
                    <div class="bg-red-100 p-3 rounded">
                        <label class="block text-xs text-gray-600 mb-2">í˜„ì¥ì‹¤ìŠµ</label>
                        <div class="flex items-center mb-2">
                            <input type="number" id="intern-hours" value="${internHours}" 
                                   class="w-20 px-2 py-1 border rounded text-sm" onchange="window.updateCourseHours('${course.code}')">
                            <span class="ml-2 text-sm font-semibold">h</span>
                        </div>
                        <div class="text-xs text-red-700 font-semibold">
                            ì•½ ${internDays}ì¼ (${internPercent}%)
                        </div>
                        <div class="text-xs text-red-600 mt-1">
                            ${projectEndDate} ~ ${internEndDate}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- êµìœ¡ ì¼ì • ê³„ì‚° ê²°ê³¼ -->
            <div class="mb-6 bg-green-50 p-4 rounded">
                <h3 class="font-bold text-lg mb-3">
                    <i class="fas fa-calendar-check mr-2"></i>êµìœ¡ ì¼ì • ê³„ì‚° ê²°ê³¼
                </h3>
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">ì´ ê¸°ê°„</div>
                        <div class="text-2xl font-bold text-blue-600">${totalDays}ì¼</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">ê·¼ë¬´ì¼</div>
                        <div class="text-xl font-bold text-green-600">${workDays}ì¼</div>
                        <div class="text-xs text-gray-600 mt-1">= ì´ë¡ (${lectureDays}) + í”„ë¡œì íŠ¸(${projectDays}) + í˜„ì¥ì‹¤ìŠµ(${internDays})</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">ì œì™¸ì¼</div>
                        <div class="text-xl font-bold text-red-600">${excludedDays}ì¼</div>
                        <div class="text-xs text-gray-600 mt-1">= ì£¼ë§(${weekends}) + ê³µíœ´ì¼(${holidays})</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">ì¼ì¼ ìˆ˜ì—…</div>
                        <div class="text-xl font-bold text-purple-600">${dailyHours}ì‹œê°„</div>
                        <div class="text-xs text-gray-600 mt-1">ì˜¤ì „ ${morningHours}ì‹œê°„ + ì˜¤í›„ ${afternoonHours}ì‹œê°„</div>
                    </div>
                </div>
                <div class="bg-blue-50 p-3 rounded">
                    <div class="flex items-center justify-center text-sm">
                        <i class="fas fa-clock mr-2 text-blue-600"></i>
                        <span class="font-semibold">ìˆ˜ì—… ì‹œê°„:</span>
                        <span class="ml-2 text-blue-600">ì˜¤ì „ (${morningHours}ì‹œê°„) / ì˜¤í›„ (${afternoonHours}ì‹œê°„)</span>
                        <span class="ml-4 text-gray-600">|</span>
                        <span class="ml-4 font-semibold">ì£¼ê°„ ìˆ˜ì—…:</span>
                        <span class="ml-2 text-green-600">${dailyHours * 5}ì‹œê°„ (ì›”~ê¸ˆ, ì£¼ 5ì¼)</span>
                    </div>
                </div>
            </div>
            
            <!-- ê³¼ì • ê¸°ê°„ ë‚´ ê³µíœ´ì¼ -->
            <div class="mb-6 bg-red-50 p-4 rounded">
                <h3 class="font-bold text-lg mb-2">
                    <i class="fas fa-calendar-times mr-2 text-red-600"></i>ê³¼ì • ê¸°ê°„ ë‚´ ê³µíœ´ì¼
                </h3>
                <div id="course-holidays-${course.code}" class="text-sm text-red-600">
                    ê³µíœ´ì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
            
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="mb-6 bg-gray-50 p-4 rounded">
                <h3 class="font-bold text-lg mb-4">
                    <i class="fas fa-info-circle mr-2"></i>ê¸°ë³¸ ì •ë³´
                </h3>
                <div class="grid grid-cols-2 gap-4 auto-rows-auto">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">ì½”ë“œ:</label>
                        <input type="text" id="course-code" value="${course.code}" readonly
                               class="w-full px-3 py-2 border rounded bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">ì¸ì›ìˆ˜:</label>
                        <input type="number" id="course-capacity" value="${course.capacity || 24}" 
                               class="w-full px-3 py-2 border rounded" onchange="window.updateCourseInfo('${course.code}')">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-600 mb-1">ë°˜ëª…ì¹­:</label>
                        <input type="text" id="course-name" value="${course.name || ''}" 
                               class="w-full px-3 py-2 border rounded" onchange="window.updateCourseInfo('${course.code}')">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-600 mb-1">ê°•ì˜ì¥ì†Œ:</label>
                        <input type="text" id="course-location" value="${course.location || ''}" 
                               class="w-full px-3 py-2 border rounded" onchange="window.updateCourseInfo('${course.code}')">
                    </div>
                    <div class="flex flex-col min-h-[400px]">
                        <label class="block text-sm text-gray-600 mb-1">íŠ¹ì´ ì‚¬í•­:</label>
                        <textarea id="course-notes" class="w-full px-3 py-2 border rounded flex-1 resize-none" 
                                  onchange="window.updateCourseInfo('${course.code}')">${course.notes || ''}</textarea>
                    </div>
                    <div class="flex flex-col min-h-[400px]">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-book mr-1 text-green-600"></i>êµê³¼ëª©
                        </label>
                        <div class="bg-green-100 p-3 rounded flex-1 overflow-y-auto" id="subject-area-${course.code}">
                            <div class="text-center text-gray-500 text-sm">
                                <i class="fas fa-spinner fa-spin mr-2"></i>êµê³¼ëª© ë¡œë”© ì¤‘...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ë²„íŠ¼ -->
            <div class="flex space-x-2">
                <button onclick="window.editCourse('${course.code}')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
                    <i class="fas fa-edit mr-2"></i>ìˆ˜ì •
                </button>
                <button onclick="window.showCourseForm()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                    <i class="fas fa-plus mr-2"></i>ì¶”ê°€
                </button>
                <button onclick="window.deleteCourse('${course.code}')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded">
                    <i class="fas fa-trash mr-2"></i>ì‚­ì œ
                </button>
            </div>
            
            <!-- ê³¼ì • ëª©ë¡ í…Œì´ë¸” -->
            <div class="mt-8">
                <h3 class="font-bold text-lg mb-4">
                    <i class="fas fa-list mr-2"></i>ë“±ë¡ëœ ê³¼ì • ëª©ë¡
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs">ì½”ë“œ</th>
                                <th class="px-3 py-2 text-left text-xs">ë°˜ëª…ì¹­</th>
                                <th class="px-3 py-2 text-left text-xs">ì‹œì‘ì¼</th>
                                <th class="px-3 py-2 text-left text-xs">ê°•ì˜ì¢…ë£Œ</th>
                                <th class="px-3 py-2 text-left text-xs">í”„ë¡œì íŠ¸ì¢…ë£Œ</th>
                                <th class="px-3 py-2 text-left text-xs">í˜„ì¥ì‹¤ìŠµì¢…ë£Œ</th>
                                <th class="px-3 py-2 text-left text-xs">ì¢…ê¸°ê°„</th>
                                <th class="px-3 py-2 text-left text-xs">ì¸ì›</th>
                                <th class="px-3 py-2 text-left text-xs">ì¥ì†Œ</th>
                                <th class="px-3 py-2 text-left text-xs">ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${courses.map((c, idx) => `
                                <tr onclick="window.selectCourse('${c.code}')" 
                                    class="border-t hover:bg-blue-50 cursor-pointer ${c.code === selectedCourseCode ? 'bg-blue-100' : (idx % 2 === 0 ? 'bg-white' : 'bg-gray-50')}">
                                    <td class="px-3 py-2 text-xs font-semibold">${c.code}</td>
                                    <td class="px-3 py-2 text-xs">${c.name || '-'}</td>
                                    <td class="px-3 py-2 text-xs">${c.start_date ? formatDateWithDay(c.start_date) : '-'}</td>
                                    <td class="px-3 py-2 text-xs">${c.lecture_end_date ? formatDateWithDay(c.lecture_end_date) : '-'}</td>
                                    <td class="px-3 py-2 text-xs">${c.project_end_date ? formatDateWithDay(c.project_end_date) : '-'}</td>
                                    <td class="px-3 py-2 text-xs">${c.workship_end_date ? formatDateWithDay(c.workship_end_date) : '-'}</td>
                                    <td class="px-3 py-2 text-xs">${c.total_days || 113}ì¼</td>
                                    <td class="px-3 py-2 text-xs">${c.capacity || 24}</td>
                                    <td class="px-3 py-2 text-xs">${c.location || '-'}</td>
                                    <td class="px-3 py-2 text-xs">${(c.notes || '').substring(0, 20)}${c.notes && c.notes.length > 20 ? '...' : ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // updateSubjectAreaì™€ ê³µíœ´ì¼ ë¡œë“œëŠ” renderCoursesì—ì„œ í˜¸ì¶œë¨
}

// ê³¼ì • ê³µíœ´ì¼ ë¡œë“œ í•¨ìˆ˜
async function loadCourseHolidays(course) {
    console.log('ğŸ”” ê³µíœ´ì¼ ë¡œë“œ ì‹œì‘:', course.start_date, '~', course.final_end_date);
    
    const holidays = await getCourseHolidays(course.start_date, course.final_end_date);
    console.log('ğŸ”” ì¡°íšŒëœ ê³µíœ´ì¼:', holidays);
    
    const holidayElement = document.getElementById(`course-holidays-${course.code}`);
    console.log('ğŸ”” holidayElement:', holidayElement);
    
    if (holidayElement) {
        if (holidays.length === 0) {
            holidayElement.innerHTML = '<span class="text-gray-500">ë“±ë¡ëœ ê³µíœ´ì¼ì´ ì—†ìŠµë‹ˆë‹¤</span>';
        } else {
            // MM-DD(ê³µíœ´ì¼ëª…) í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
            const holidayTexts = holidays.map(h => {
                const date = new Date(h.holiday_date);
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${month}-${day}(${h.name})`;
            });
            holidayElement.textContent = holidayTexts.join(', ');
            console.log('âœ… ê³µíœ´ì¼ í‘œì‹œ ì™„ë£Œ:', holidayTexts.join(', '));
        }
    } else {
        console.error('âŒ holidayElementë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', `course-holidays-${course.code}`);
    }
}

// ê³¼ëª© ì˜ì—­ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
async function updateSubjectArea(courseCode, updatedSubjectsInfo = null) {
    console.log(`ğŸ“š updateSubjectArea ì‹œì‘ - ê³¼ì •: ${courseCode}`);
    
    const subjectArea = document.getElementById(`subject-area-${courseCode}`);
    if (!subjectArea) {
        console.log(`âš ï¸ subject-area-${courseCode} ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
        return;
    }
    
    const selectedSubjects = courseSubjects[courseCode] || [];
    console.log(`ğŸ“š ê³¼ì • ${courseCode}ì˜ êµê³¼ëª©:`, selectedSubjects);
    const hasSubjects = selectedSubjects.length > 0;
    
    if (hasSubjects) {
        // êµê³¼ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        try {
            console.log(`ğŸ” êµê³¼ëª© ìƒì„¸ ì •ë³´ ì¡°íšŒ ì¤‘...`);
            const response = await axios.get(`${API_BASE_URL}/api/subjects?_t=${Date.now()}`);
            const allSubjects = response.data;
            
            // ì—…ë°ì´íŠ¸ëœ ì •ë³´ê°€ ìˆìœ¼ë©´ ë³‘í•© (ìµœì‹  ì •ë³´ ìš°ì„  ë°˜ì˜)
            if (updatedSubjectsInfo) {
                console.log('ğŸ“ ì—…ë°ì´íŠ¸ëœ êµê³¼ëª© ì •ë³´ ë³‘í•©:', updatedSubjectsInfo);
                updatedSubjectsInfo.forEach(updated => {
                    const subject = allSubjects.find(s => s.code === updated.subject_code);
                    if (subject) {
                        subject.day_of_week = updated.day_of_week;
                        subject.is_biweekly = updated.is_biweekly;
                        subject.main_instructor = updated.main_instructor;
                        subject.instructor_name = updated.instructor_name;
                    }
                });
            }
            
            console.log(`âœ… êµê³¼ëª© ìƒì„¸ ì •ë³´ ë¡œë“œ ì™„ë£Œ:`, allSubjects.length, 'ê°œ');
            
            // ì„ íƒëœ ê³¼ëª©ì´ ìˆëŠ” ê²½ìš°
            subjectArea.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm font-semibold text-green-800">
                        <i class="fas fa-check-circle mr-1"></i>ì„ íƒëœ ê³¼ëª©: 
                        <span class="text-green-700 font-bold">${selectedSubjects.length}ê°œ</span>
                    </div>
                    <button onclick="window.showSubjectSelector('${courseCode}')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow-sm">
                        <i class="fas fa-edit mr-1"></i>êµê³¼ëª© ìˆ˜ì •
                    </button>
                </div>
                <div class="bg-white rounded border border-green-200 overflow-hidden">
                    <!-- í—¤ë” -->
                    <div class="bg-gray-50 px-3 py-2 border-b border-gray-200">
                        <div class="flex items-center text-xs font-semibold text-gray-600">
                            <div class="w-7 mr-3"></div>
                            <div class="flex-1 grid grid-cols-12 gap-2">
                                <div class="col-span-2">ì½”ë“œ</div>
                                <div class="col-span-5">êµê³¼ëª©</div>
                                <div class="col-span-3">ê°•ì‚¬</div>
                                <div class="col-span-2 text-right">ìš”ì¼</div>
                            </div>
                        </div>
                    </div>
                    <!-- ëª©ë¡ -->
                    <ul class="p-3 space-y-2" id="selected-subjects-${courseCode}">
                        ${selectedSubjects.map((code, index) => {
                            const subject = allSubjects.find(s => s.code === code);
                            const name = subject ? subject.name : '(êµê³¼ëª©ëª… ì—†ìŒ)';
                            const instructorName = subject?.instructor_name || '(ë¯¸ì§€ì •)';
                            const dayOfWeek = subject?.day_of_week;
                            // 1=ì›”ìš”ì¼, 2=í™”ìš”ì¼, 3=ìˆ˜ìš”ì¼, 4=ëª©ìš”ì¼, 5=ê¸ˆìš”ì¼, 6=í† ìš”ì¼, 0=ì¼ìš”ì¼
                            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                            const dayName = (dayOfWeek !== null && dayOfWeek !== undefined) ? dayNames[dayOfWeek] : '(ë¯¸ì§€ì •)';
                            
                            return `
                                <li class="flex items-start text-sm border-b border-gray-100 pb-3 last:border-0 last:pb-0">
                                    <span class="inline-flex items-center justify-center w-7 h-7 bg-green-600 text-white rounded-full text-xs font-bold mr-3 flex-shrink-0">
                                        ${index + 1}
                                    </span>
                                    <div class="flex-1 grid grid-cols-12 gap-2 items-center">
                                        <div class="col-span-2">
                                            <span class="font-bold text-blue-700">${code}</span>
                                        </div>
                                        <div class="col-span-5">
                                            <span class="font-semibold text-gray-800">${name}</span>
                                        </div>
                                        <div class="col-span-3">
                                            <span class="text-gray-600">${instructorName}</span>
                                        </div>
                                        <div class="col-span-2 text-right">
                                            <span class="inline-block px-2 py-1 rounded-full text-xs font-bold ${dayName === '(ë¯¸ì§€ì •)' ? 'bg-gray-200 text-gray-600' : 'bg-green-100 text-green-700'}">${dayName}ìš”ì¼</span>
                                        </div>
                                    </div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>
            `;
            console.log(`âœ… êµê³¼ëª© ì˜ì—­ ë Œë”ë§ ì™„ë£Œ`);
        } catch (error) {
            console.error('âŒ êµê³¼ëª© ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            subjectArea.innerHTML = `
                <div class="text-sm text-red-600 p-2 bg-red-50 rounded">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    êµê³¼ëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                </div>
            `;
        }
    } else {
        console.log(`âš ï¸ ê³¼ì • ${courseCode}ì— ì„ íƒëœ êµê³¼ëª©ì´ ì—†ìŒ`);
        // ì„ íƒëœ ê³¼ëª©ì´ ì—†ëŠ” ê²½ìš°
        subjectArea.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <div class="text-sm font-semibold text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>ì„ íƒëœ ê³¼ëª©: 
                    <span class="text-gray-500">0ê°œ</span>
                </div>
                <button onclick="window.showSubjectSelector('${courseCode}')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow-sm">
                    <i class="fas fa-plus mr-1"></i>êµê³¼ëª© ì„ íƒ
                </button>
            </div>
            <div class="bg-white p-3 rounded border border-green-200">
                <p class="text-sm text-gray-500 text-center py-2">
                    <i class="fas fa-folder-open text-2xl mb-2 block"></i>
                    êµê³¼ëª© ì„ íƒ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê³¼ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.
                </p>
            </div>
        `;
    }
}

// ==================== ìƒˆë¡œìš´ ê³¼ì • ê´€ë¦¬ UI ì¸í„°ë™í‹°ë¸Œ í•¨ìˆ˜ ====================
let selectedCourseCode = null;

// ê³¼ì • íƒ­ ì„ íƒ
window.selectCourse = function(courseCode) {
    selectedCourseCode = courseCode;
    renderCourses();
}

// ê³¼ì • ì‹œì‘ì¼ ì—…ë°ì´íŠ¸
window.updateCourseDate = async function(courseCode) {
    const newDate = document.getElementById('course-start-date').value;
    if (!newDate) return;
    
    try {
        const course = courses.find(c => c.code === courseCode);
        if (!course) return;
        
        await axios.put(`${API_BASE_URL}/api/courses/${courseCode}`, {
            ...course,
            start_date: newDate
        });
        
        // ì¬ë¡œë“œ
        await loadCourses();
        selectedCourseCode = courseCode;
        renderCourses();
        
        window.showAlert('ê³¼ì • ì‹œì‘ì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error) {
        console.error('ë‚ ì§œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        window.showAlert('ë‚ ì§œ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì‹œê°„ ì…ë ¥ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ì¬ê³„ì‚°
window.updateCourseHours = function(courseCode) {
    const theoryHours = parseInt(document.getElementById('theory-hours').value) || 0;
    const projectHours = parseInt(document.getElementById('project-hours').value) || 0;
    const internHours = parseInt(document.getElementById('intern-hours').value) || 0;
    
    // ì¬ë Œë”ë§ (UIë§Œ ì—…ë°ì´íŠ¸, ì €ì¥ì€ ë³„ë„)
    const course = courses.find(c => c.code === courseCode);
    if (course) {
        course.lecture_hours = theoryHours;
        course.project_hours = projectHours;
        course.workship_hours = internHours;
        renderCourses();
    }
}

// ê¸°ë³¸ ì •ë³´ ë³€ê²½
window.updateCourseInfo = function(courseCode) {
    // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ëŠ” í•˜ì§€ ì•Šê³ , ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ë°˜ì˜
    // UI í”¼ë“œë°±ë§Œ ì œê³µ
}

// ëª¨ë“  ë³€ê²½ì‚¬í•­ ì €ì¥
window.saveCourseChanges = async function(courseCode) {
    const course = courses.find(c => c.code === courseCode);
    if (!course) return;
    
    const data = {
        code: courseCode,
        name: document.getElementById('course-name').value,
        location: document.getElementById('course-location').value,
        capacity: parseInt(document.getElementById('course-capacity').value) || 24,
        lecture_hours: parseInt(document.getElementById('theory-hours').value) || 260,
        project_hours: parseInt(document.getElementById('project-hours').value) || 220,
        workship_hours: parseInt(document.getElementById('intern-hours').value) || 120,
        start_date: document.getElementById('course-start-date').value,
        notes: document.getElementById('course-notes').value,
        // ê¸°ì¡´ í•„ë“œ ìœ ì§€
        lecture_end_date: course.lecture_end_date,
        project_end_date: course.project_end_date,
        workship_end_date: course.workship_end_date,
        final_end_date: course.final_end_date,
        total_days: course.total_days
    };
    
    try {
        await axios.put(`${API_BASE_URL}/api/courses/${courseCode}`, data);
        window.showAlert('ê³¼ì • ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        await loadCourses();
        selectedCourseCode = courseCode;
        renderCourses();
    } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', error);
        showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ì¼ì¼ ì´ ìˆ˜ì—…ì‹œê°„ ìë™ ê³„ì‚°
window.updateDailyHours = function() {
    const morningHours = parseInt(document.getElementById('form-course-morning-hours').value) || 0;
    const afternoonHours = parseInt(document.getElementById('form-course-afternoon-hours').value) || 0;
    const dailyHours = morningHours + afternoonHours;
    
    document.getElementById('form-course-daily-hours').value = dailyHours;
    
    // ì¼ì¼ ì‹œê°„ì´ 8ì‹œê°„ì„ ì´ˆê³¼í•˜ë©´ ê²½ê³ 
    if (dailyHours > 8) {
        document.getElementById('form-course-daily-hours').classList.add('text-red-600', 'bg-red-50');
        document.getElementById('form-course-daily-hours').classList.remove('text-purple-600', 'bg-purple-50');
    } else {
        document.getElementById('form-course-daily-hours').classList.add('text-purple-600', 'bg-purple-50');
        document.getElementById('form-course-daily-hours').classList.remove('text-red-600', 'bg-red-50');
    }
}

// ìë™ê³„ì‚° ê²°ê³¼ë¥¼ ì˜ˆìœ ëª¨ë‹¬ë¡œ í‘œì‹œ
window.showCalculationResult = function(result, startDate, endDate) {
    console.log('ğŸ¯ showCalculationResult í˜¸ì¶œ:', result);
    
    // alert-modal ë‚´ë¶€ì˜ ìš”ì†Œë“¤ì„ ì •í™•íˆ ì°¾ê¸°
    const modal = document.getElementById('alert-modal');
    if (!modal) {
        console.error('âŒ alert-modalì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        showAlert(`ìë™ê³„ì‚° ì™„ë£Œ!\n\nêµìœ¡ê¸°ê°„: ${startDate} ~ ${endDate}\nì´ êµìœ¡ì‹œê°„: ${result.total_hours}ì‹œê°„\nì´ êµìœ¡ì¼ìˆ˜: ${result.total_days}ì¼`, 'success', { title: 'ìë™ê³„ì‚° ì™„ë£Œ' });
        return;
    }
    
    const header = modal.querySelector('#alert-header');
    const icon = modal.querySelector('#alert-icon');
    const title = modal.querySelector('#alert-title');
    const message = modal.querySelector('#alert-message');
    const confirmBtn = modal.querySelector('#alert-confirm-btn');
    const cancelBtn = modal.querySelector('#alert-cancel-btn');
    
    console.log('ğŸ“¦ ëª¨ë‹¬ ìš”ì†Œë“¤:', { modal, header, icon, title, message, confirmBtn, cancelBtn });
    
    if (!header || !message) {
        console.error('âŒ ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        showAlert(`ìë™ê³„ì‚° ì™„ë£Œ!\n\nêµìœ¡ê¸°ê°„: ${startDate} ~ ${endDate}\nì´ êµìœ¡ì‹œê°„: ${result.total_hours}ì‹œê°„\nì´ êµìœ¡ì¼ìˆ˜: ${result.total_days}ì¼`, 'success', { title: 'ìë™ê³„ì‚° ì™„ë£Œ' });
        return;
    }
    
    // ì„±ê³µ ìŠ¤íƒ€ì¼ ì ìš©
    header.className = 'p-6 rounded-t-2xl bg-gradient-to-r from-green-500 to-emerald-600';
    icon.innerHTML = 'âœ…';
    title.textContent = 'ìë™ê³„ì‚° ì™„ë£Œ!';
    
    // ìƒì„¸í•œ ê²°ê³¼ HTML
    message.innerHTML = `
        <div class="space-y-4">
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="font-semibold text-blue-900 mb-2 flex items-center">
                    <i class="fas fa-calendar-alt mr-2"></i>êµìœ¡ê¸°ê°„
                </div>
                <div class="text-blue-700 font-bold text-lg">${startDate} ~ ${endDate}</div>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-lg">
                <div class="font-semibold text-purple-900 mb-2 flex items-center">
                    <i class="fas fa-clock mr-2"></i>ì´ êµìœ¡ì‹œê°„
                </div>
                <div class="text-purple-700 font-bold text-xl mb-2">${result.total_hours}ì‹œê°„</div>
                <div class="text-sm text-purple-600 space-y-1">
                    <div>â”œ ì´ë¡ : ${result.lecture_hours}ì‹œê°„ (${result.lecture_days}ì¼)</div>
                    <div>â”œ í”„ë¡œì íŠ¸: ${result.project_hours}ì‹œê°„ (${result.project_days}ì¼)</div>
                    <div>â”” í˜„ì¥ì‹¤ìŠµ: ${result.workship_hours}ì‹œê°„ (${result.workship_days}ì¼)</div>
                </div>
            </div>
            
            <div class="bg-green-50 p-4 rounded-lg">
                <div class="font-semibold text-green-900 mb-2 flex items-center">
                    <i class="fas fa-calendar-check mr-2"></i>êµìœ¡ì¼ìˆ˜
                </div>
                <div class="text-green-700 font-bold text-xl mb-2">ì´ ${result.total_days}ì¼</div>
                <div class="text-sm text-green-600 space-y-1">
                    <div>â”œ ê·¼ë¬´ì¼: ${result.work_days}ì¼</div>
                    <div>â”œ ì£¼ë§: ${result.weekend_days}ì¼</div>
                    <div>â”” ê³µíœ´ì¼: ${result.holiday_count}ì¼</div>
                </div>
            </div>
            
            <div class="bg-red-50 p-4 rounded-lg">
                <div class="font-semibold text-red-900 mb-2 flex items-center">
                    <i class="fas fa-calendar-times mr-2"></i>ê³¼ì • ê¸°ê°„ ë‚´ ê³µíœ´ì¼
                </div>
                <div class="text-red-700 font-semibold">${result.holidays_formatted}</div>
            </div>
            
            ${result.calculation_details ? `
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-300 max-h-96 overflow-y-auto">
                <div class="font-semibold text-gray-900 mb-2 flex items-center">
                    <i class="fas fa-calculator mr-2"></i>ìƒì„¸ ê³„ì‚° ê³¼ì •
                </div>
                <pre class="text-xs text-gray-700 font-mono whitespace-pre-wrap">${result.calculation_details}</pre>
            </div>
            ` : ''}
            
            <!-- ì‹œê°„í‘œ ìƒì„± íŒ¨ë„ ì œê±°ë¨: ì´ì œ ìƒë‹¨ ë²„íŠ¼ì—ì„œ ìƒì„± -->
        </div>
    `;
    
    // ë²„íŠ¼ ì„¤ì •
    cancelBtn.classList.add('hidden');
    confirmBtn.textContent = 'í™•ì¸';
    confirmBtn.className = 'px-6 py-2.5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg font-semibold transition-all shadow-lg';
    
    confirmBtn.onclick = () => {
        modal.classList.add('hidden');
    };
    
    // ëª¨ë‹¬ í‘œì‹œ
    modal.classList.remove('hidden');
}

// ì‹œê°„í‘œìƒì„± ë²„íŠ¼ì—ì„œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
window.generateTimetableFromButton = async function(courseCode) {
    if (!courseCode) {
        window.showAlert('ê³¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    try {
        // ê³¼ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const courseRes = await axios.get(`/api/courses/${courseCode}`);
        const course = courseRes.data;
        
        // í•„ìˆ˜ ì •ë³´ í™•ì¸
        if (!course.start_date || !course.lecture_hours || !course.project_hours || !course.workship_hours) {
            window.showAlert('ê³¼ì •ì˜ ì‹œì‘ì¼ê³¼ ì‹œìˆ˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.\\n\\nê³¼ì •ì„ ìˆ˜ì •í•˜ì—¬ ìë™ê³„ì‚°ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        
        // í™•ì¸ ëª¨ë‹¬
        const confirmed = await window.showConfirm(
            `ğŸ“… ${course.name || courseCode} ê³¼ì •ì˜ ì‹œê°„í‘œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\n` +
            `âš ï¸ ê¸°ì¡´ ì‹œê°„í‘œê°€ ìˆë‹¤ë©´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤!\\n\\n` +
            `â€¢ ì´ë¡ : ${course.lecture_hours}ì‹œê°„\\n` +
            `â€¢ í”„ë¡œì íŠ¸: ${course.project_hours}ì‹œê°„\\n` +
            `â€¢ í˜„ì¥ì‹¤ìŠµ: ${course.workship_hours}ì‹œê°„`
        );
        if (!confirmed) return;
        
        window.showLoading('ì‹œê°„í‘œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...');
        
        // ì‹œê°„í‘œ ìë™ ìƒì„± API í˜¸ì¶œ
        const response = await axios.post('/api/timetables/auto-generate', {
            course_code: courseCode,
            start_date: course.start_date,
            lecture_hours: course.lecture_hours,
            project_hours: course.project_hours,
            workship_hours: course.workship_hours,
            morning_hours: course.morning_hours != null ? Number(course.morning_hours) : 4,
            afternoon_hours: course.afternoon_hours != null ? Number(course.afternoon_hours) : 4
        });

        window.hideLoading();

        if (response.data.success) {
            await window.showAlert(
                `âœ… ì‹œê°„í‘œ ìë™ ìƒì„± ì™„ë£Œ!\\n\\n` +
                `ğŸ“… ${response.data.generated_count}ê°œì˜ ì‹œê°„í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\\n` +
                `ì‹œê°„í‘œ ê´€ë¦¬ ë©”ë‰´ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
                'success'
            );
            
            // ì‹œê°„í‘œ ê´€ë¦¬ íƒ­ìœ¼ë¡œ ì´ë™
            showTab('timetables');
        } else {
            window.showAlert('ì‹œê°„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
        
    } catch (error) {
        window.hideLoading();
        console.error('ì‹œê°„í‘œ ìƒì„± ì—ëŸ¬:', error);
        window.showAlert(
            `ì‹œê°„í‘œ ìƒì„± ì‹¤íŒ¨: ${error.response?.data?.detail || error.message}`,
            'error'
        );
    }
};

// ì‹œê°„í‘œ ìë™ ìƒì„± (ìë™ê³„ì‚° ê²°ê³¼ì—ì„œ í˜¸ì¶œ)
window.generateTimetable = async function(courseCode, calculationResult) {
    if (!courseCode) {
        // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ê³¼ì •ì—ì„œ course_code ê°€ì ¸ì˜¤ê¸°
        courseCode = document.getElementById('form-course-code')?.value;
    }
    
    if (!courseCode) {
        window.showAlert('ê³¼ì • ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    // í™•ì¸ ëª¨ë‹¬
    const confirmed = await window.showConfirm(
        `ğŸ“… ${courseCode} ê³¼ì •ì˜ ì‹œê°„í‘œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
        `âš ï¸ ê¸°ì¡´ ì‹œê°„í‘œê°€ ìˆë‹¤ë©´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤!`
    );
    if (!confirmed) return;
    
    try {
        window.showLoading('ì‹œê°„í‘œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...');
        
        // ê³¼ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const courseRes = await axios.get(`/api/courses`);
        const course = courseRes.data.find(c => c.code === courseCode);
        
        if (!course) {
            throw new Error('ê³¼ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // êµê³¼ëª© ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        const subjectCodes = course.subjects || [];
        
        // ì‹œê°„í‘œ ìë™ ìƒì„± API í˜¸ì¶œ
        const response = await axios.post(`/api/timetables/auto-generate`, {
            course_code: courseCode,
            start_date: course.start_date,
            lecture_hours: course.lecture_hours || 0,
            project_hours: course.project_hours || 0,
            workship_hours: course.workship_hours || 0,
            morning_hours: course.morning_hours != null ? Number(course.morning_hours) : 4,
            afternoon_hours: course.afternoon_hours != null ? Number(course.afternoon_hours) : 4,
            subject_codes: subjectCodes
        });
        
        window.hideLoading();
        
        // ê²°ê³¼ í‘œì‹œ
        window.showAlert(
            `âœ… ì‹œê°„í‘œ ìë™ ìƒì„± ì™„ë£Œ!\n\n` +
            `ìƒì„±ëœ ì‹œê°„í‘œ: ${response.data.generated_count}ê°œ\n\n` +
            `ì‹œê°„í‘œ ë©”ë‰´ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`,
            'success'
        );
        
        // ëª¨ë‹¬ ë‹«ê¸°
        const modal = document.getElementById('alert-modal');
        if (modal) modal.classList.add('hidden');
        
        // ì‹œê°„í‘œ ìƒˆë¡œê³ ì¹¨ (ì‹œê°„í‘œ íƒ­ì´ ì—´ë ¤ìˆë‹¤ë©´)
        if (typeof loadTimetables === 'function') {
            await loadTimetables();
        }
        
    } catch (error) {
        window.hideLoading();
        console.error('ì‹œê°„í‘œ ìƒì„± ì‹¤íŒ¨:', error);
        window.showAlert(
            'âŒ ì‹œê°„í‘œ ìƒì„± ì‹¤íŒ¨\n\n' + 
            (error.response?.data?.detail || error.message),
            'error'
        );
    }
}

// ìë™ê³„ì‚° ë²„íŠ¼ í´ë¦­ ì‹œ ë‚ ì§œ ìë™ ê³„ì‚°
window.autoCalculateDates = async function() {
    const startDate = document.getElementById('form-course-start-date').value;
    const lectureHours = parseInt(document.getElementById('form-course-lecture-hours').value) || 0;
    const projectHours = parseInt(document.getElementById('form-course-project-hours').value) || 0;
    const workshipHours = parseInt(document.getElementById('form-course-workship-hours').value) || 0;
    const morningHours = (() => { const v = parseInt(document.getElementById('form-course-morning-hours').value); return isNaN(v) ? 4 : v; })();
    const afternoonHours = (() => { const v = parseInt(document.getElementById('form-course-afternoon-hours').value); return isNaN(v) ? 4 : v; })();
    const dailyHours = morningHours + afternoonHours;
    
    if (!startDate) {
        window.showAlert('ì‹œì‘ì¼ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    if (lectureHours === 0 && projectHours === 0 && workshipHours === 0) {
        window.showAlert('ê°•ì˜ì‹œê°„, í”„ë¡œì íŠ¸ì‹œê°„, í˜„ì¥ì‹¤ìŠµì‹œê°„ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    if (dailyHours === 0) {
        window.showAlert('ì¼ì¼ ìˆ˜ì—…ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜¤ì „+ì˜¤í›„ ì‹œê°„)', 'error');
        return;
    }
    
    try {
        // ê³„ì‚° ì¤‘ í‘œì‹œ
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ê³„ì‚°ì¤‘...';
        button.disabled = true;
        
        // ê³¼ì • ì½”ë“œì™€ êµê³¼ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const courseCode = document.getElementById('form-course-code')?.value;
        const courseRes = await axios.get(`${API_BASE_URL}/api/courses`);
        const course = courseRes.data.find(c => c.code === courseCode);
        const subjectCodes = course?.subjects || [];
        
        const response = await axios.post(`${API_BASE_URL}/api/courses/calculate-dates`, {
            start_date: startDate,
            lecture_hours: lectureHours,
            project_hours: projectHours,
            workship_hours: workshipHours,
            daily_hours: dailyHours,
            morning_hours: morningHours,
            afternoon_hours: afternoonHours,
            course_code: courseCode,
            subject_codes: subjectCodes,
            generate_pdf: true,  // PDF ìë™ ìƒì„±
            auto_save_timetable: true  // ì‹œê°„í‘œ ìë™ ì €ì¥
        });
        
        const result = response.data;
        
        // ê³„ì‚°ëœ ë‚ ì§œë“¤ì„ í¼ì— ì…ë ¥
        document.getElementById('form-course-lecture-end').value = result.lecture_end_date;
        document.getElementById('form-course-project-end').value = result.project_end_date;
        document.getElementById('form-course-workship-end').value = result.workship_end_date;
        document.getElementById('form-course-final-end').value = result.final_end_date;
        document.getElementById('form-course-total-days').value = result.total_days;
        
        // ì‹œê°„ ì •ë³´ë„ í‘œì‹œ (ê°•ì˜: 13:00, í”„ë¡œì íŠ¸/ì‹¤ìŠµ: 18:00)
        if (document.getElementById('form-course-lecture-end-display')) {
            document.getElementById('form-course-lecture-end-display').value = result.lecture_end_date ? `${result.lecture_end_date} 13:00` : '';
        }
        if (document.getElementById('form-course-project-end-display')) {
            document.getElementById('form-course-project-end-display').value = result.project_end_date ? `${result.project_end_date} 18:00` : '';
        }
        if (document.getElementById('form-course-workship-end-display')) {
            document.getElementById('form-course-workship-end-display').value = result.workship_end_date ? `${result.workship_end_date} 18:00` : '';
        }
        
        // ë¹„ê³  í•„ë“œì— ìë™ìœ¼ë¡œ ì…ë ¥
        const startDateFormatted = result.start_date.replace(/-/g, '.');
        const endDateFormatted = result.final_end_date.replace(/-/g, '.');
        
        // ì£¼ê°„ ìˆ˜ì—…ì‹œê°„ ê³„ì‚° (ì¼ì¼ì‹œê°„ Ã— 5ì¼)
        const weeklyHours = dailyHours * 5;
        
        // ë°±ì—”ë“œì—ì„œ ìƒì„¸ ê³„ì‚° ê³¼ì •ì„ ë¹„ê³ ë€ì— ì €ì¥í–ˆìœ¼ë¯€ë¡œ, 
        // calculation_detailsë¥¼ ë¹„ê³ ë€ì— í‘œì‹œ
        const notesText = result.calculation_details || `1. êµìœ¡ê¸°ê°„ : ${startDateFormatted} ~ ${endDateFormatted} (ê³µíœ´ì¼ : ${result.holidays_formatted})
2. ì¼${dailyHours}ì‹œê°„ (ì˜¤ì „ ${morningHours}ì‹œê°„, ì˜¤í›„ ${afternoonHours}ì‹œê°„) / ì£¼${weeklyHours}ì‹œê°„ ìˆ˜ì—…
3. ì´ êµìœ¡ì‹œê°„ : ${result.total_hours}ì‹œê°„ (ì´ë¡  ${result.lecture_hours}ì‹œê°„, í”„ë¡œì íŠ¸ ${result.project_hours}ì‹œê°„, í˜„ì¥ì‹¤ìŠµ ${result.workship_hours}ì‹œê°„)
4. ì´ êµìœ¡ì¼ìˆ˜ : ${result.total_days}ì¼ (ê·¼ë¬´ì¼ ${result.work_days}ì¼, ì œì™¸ì¼ ${result.excluded_days}ì¼)`;
        
        document.getElementById('form-course-notes').value = notesText;
        
        // ë²„íŠ¼ ì›ìƒë³µêµ¬
        button.innerHTML = originalHTML;
        button.disabled = false;
        
        // ì˜ˆìœ ëª¨ë‹¬ë¡œ ê²°ê³¼ í‘œì‹œ
        window.showCalculationResult(result, startDateFormatted, endDateFormatted);
        
        // PDF ìƒì„± ê²°ê³¼ í‘œì‹œ
        if (result.pdf_generated) {
            console.log('âœ… PDF ìƒì„± ì™„ë£Œ:', result.pdf_path);
        }
        
        // ì‹œê°„í‘œ ìë™ ìƒì„± ê²°ê³¼ í‘œì‹œ
        if (result.timetable_generated) {
            console.log(`âœ… ì‹œê°„í‘œ ìë™ ìƒì„± ì™„ë£Œ: ${result.timetable_count}ê°œ`);
            window.showAlert(
                `âœ… ìë™ ê³„ì‚° ì™„ë£Œ!\n\n` +
                `ğŸ“„ PDF ë³´ê³ ì„œ: ${result.pdf_generated ? 'ìƒì„±ë¨' : 'ìƒì„± ì‹¤íŒ¨'}\n` +
                `ğŸ“… ì‹œê°„í‘œ: ${result.timetable_count}ê°œ ìë™ ìƒì„±ë¨\n\n` +
                `ì‹œê°„í‘œ ë©”ë‰´ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`,
                'success'
            );
        }
    } catch (error) {
        console.error('ìë™ê³„ì‚° ì‹¤íŒ¨:', error);
        showAlert('ìë™ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message), 'error');
        
        // ë²„íŠ¼ ì›ìƒë³µêµ¬
        const button = event.target.closest('button');
        button.innerHTML = '<i class="fas fa-calculator mr-2"></i>ìë™ê³„ì‚°';
        button.disabled = false;
    }
}

// ìš”ì¼ ë²ˆí˜¸ë¥¼ í•œê¸€ë¡œ ë³€í™˜ (0=ì›”ìš”ì¼, 1=í™”ìš”ì¼, ...)
function getDayNameFromNumber(dayNum) {
    const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
    return dayNum !== null && dayNum !== undefined ? days[dayNum] : '-';
}

// êµê³¼ëª© ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
window.showSubjectSelector = async function(courseCode) {
    const modal = document.getElementById('subject-selector');
    const content = modal.querySelector('div');
    
    try {
        // êµê³¼ëª© ëª©ë¡ê³¼ ê°•ì‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const [subjectsRes, instructorsRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/subjects`),
            axios.get(`${API_BASE_URL}/api/instructors`)
        ]);
        
        const allSubjects = subjectsRes.data;
        const allInstructors = instructorsRes.data;
        
        // ì£¼ê°•ì‚¬ë§Œ í•„í„°ë§ (instructor_type_name === 'ì£¼ê°•ì‚¬'ë§Œ)
        const mainInstructors = allInstructors.filter(inst => 
            inst.instructor_type_name === 'ì£¼ê°•ì‚¬'
        );
        
        console.log('ì „ì²´ ê°•ì‚¬ ìˆ˜:', allInstructors.length);
        console.log('ì£¼ê°•ì‚¬ ìˆ˜:', mainInstructors.length);
        console.log('ì£¼ê°•ì‚¬ ëª©ë¡:', mainInstructors.map(i => `${i.name}-${i.major}`));
        
        // í˜„ì¬ ê³¼ì •ì— ì„ íƒëœ ê³¼ëª© ëª©ë¡
        const selectedSubjects = courseSubjects[courseCode] || [];
        
        content.innerHTML = `
            <h3 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-list mr-2"></i>êµê³¼ëª© ì„ íƒ - ${courseCode}
            </h3>
            <p class="text-base text-gray-600 mb-6">
                ê³¼ì •ì— í¬í•¨í•  êµê³¼ëª©ì„ ì„ íƒí•˜ê³ , ìš”ì¼/ê²©ì£¼/ë‹´ë‹¹ê°•ì‚¬ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div class="max-h-[600px] overflow-y-auto border rounded p-4">
                <table class="min-w-full table-fixed">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="w-16 px-3 py-3 text-left text-sm font-semibold">ì„ íƒ</th>
                            <th class="w-24 px-3 py-3 text-left text-sm font-semibold">ê³¼ëª©ì½”ë“œ</th>
                            <th class="w-64 px-3 py-3 text-left text-sm font-semibold">ê³¼ëª©ëª…</th>
                            <th class="w-20 px-3 py-3 text-left text-sm font-semibold">ì‹œìˆ˜</th>
                            <th class="w-28 px-3 py-3 text-left text-sm font-semibold">ìš”ì¼</th>
                            <th class="w-24 px-3 py-3 text-left text-sm font-semibold">ê²©ì£¼</th>
                            <th class="w-48 px-3 py-3 text-left text-sm font-semibold">ë‹´ë‹¹ê°•ì‚¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allSubjects.map(s => {
                            const isSelected = selectedSubjects.includes(s.code);
                            // êµê³¼ëª©ê´€ë¦¬ì—ì„œ ì§€ì •ëœ ì£¼ê°•ì‚¬ ì •ë³´ (main_instructor ê¸°ì¤€)
                            const mainInstructorCode = s.main_instructor;
                            const mainInstructorInfo = allInstructors.find(inst => inst.code === mainInstructorCode);
                            
                            // í˜„ì¬ êµê³¼ëª©ì— ì§€ì •ëœ ê°•ì‚¬ í‘œì‹œ (ì´ë¦„-ì „ê³µ í˜•ì‹)
                            let currentInstructorDisplay = 'ì§€ì • ì•ˆë¨';
                            if (mainInstructorInfo) {
                                const major = mainInstructorInfo.major || 'ì „ê³µë¯¸ì§€ì •';
                                currentInstructorDisplay = `${mainInstructorInfo.name}-${major}`;
                            }
                            
                            return `
                            <tr class="border-t hover:bg-gray-50" data-subject-code="${s.code}">
                                <td class="px-3 py-3">
                                    <input type="checkbox" class="subject-checkbox w-4 h-4" value="${s.code}" 
                                           id="subject-${s.code}" ${isSelected ? 'checked' : ''}>
                                </td>
                                <td class="px-3 py-3 text-sm">${s.code}</td>
                                <td class="px-3 py-3 text-sm font-medium">${s.name}</td>
                                <td class="px-3 py-3 text-sm">${s.hours || '-'}ì‹œê°„</td>
                                <td class="px-3 py-3">
                                    <select class="subject-day-select text-sm border rounded px-2 py-2 w-full" data-subject-code="${s.code}">
                                        <option value="1" ${s.day_of_week === 1 ? 'selected' : ''}>ì›”</option>
                                        <option value="2" ${s.day_of_week === 2 ? 'selected' : ''}>í™”</option>
                                        <option value="3" ${s.day_of_week === 3 ? 'selected' : ''}>ìˆ˜</option>
                                        <option value="4" ${s.day_of_week === 4 ? 'selected' : ''}>ëª©</option>
                                        <option value="5" ${s.day_of_week === 5 ? 'selected' : ''}>ê¸ˆ</option>
                                        <option value="6" ${s.day_of_week === 6 ? 'selected' : ''}>í† </option>
                                        <option value="0" ${s.day_of_week === 0 ? 'selected' : ''}>ì¼</option>
                                    </select>
                                </td>
                                <td class="px-3 py-3">
                                    <select class="subject-biweekly-select text-sm border rounded px-2 py-2 w-full" data-subject-code="${s.code}">
                                        <option value="0" ${!s.is_biweekly || s.is_biweekly === 0 ? 'selected' : ''}>ë§¤ì£¼</option>
                                        <option value="1" ${s.is_biweekly === 1 ? 'selected' : ''}>ê²©ì£¼</option>
                                    </select>
                                </td>
                                <td class="px-3 py-3">
                                    <div class="flex flex-col gap-1">
                                        <div class="text-xs text-gray-500">í˜„ì¬: ${currentInstructorDisplay}</div>
                                        <select class="subject-instructor-select text-sm border rounded px-2 py-1 w-full" data-subject-code="${s.code}">
                                            <option value="">ì„ íƒ ì•ˆí•¨ (í˜„ì¬ ìœ ì§€)</option>
                                            ${mainInstructors.map(inst => {
                                                const major = inst.major || 'ì „ê³µë¯¸ì§€ì •';
                                                const isCurrentInstructor = mainInstructorCode === inst.code;
                                                return `
                                                <option value="${inst.code}" ${isCurrentInstructor ? 'selected' : ''}>
                                                    ${inst.name}-${major}
                                                </option>
                                            `}).join('')}
                                        </select>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button onclick="window.hideSubjectSelector()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-8 py-3 rounded text-base font-semibold">
                    <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                </button>
                <button onclick="window.saveSelectedSubjects('${courseCode}')" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded text-base font-semibold">
                    <i class="fas fa-save mr-2"></i>ì €ì¥ ë° ì ìš©
                </button>
            </div>
        `;
        
        modal.classList.remove('hidden');
    } catch (error) {
        console.error('êµê³¼ëª© ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('êµê³¼ëª© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// êµê³¼ëª© ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
window.hideSubjectSelector = function() {
    document.getElementById('subject-selector').classList.add('hidden');
}

// ì„ íƒëœ êµê³¼ëª© ì €ì¥
window.saveSelectedSubjects = async function(courseCode) {
    const checkboxes = document.querySelectorAll('.subject-checkbox:checked');
    const selectedSubjects = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedSubjects.length === 0) {
        window.showAlert('í•˜ë‚˜ ì´ìƒì˜ êµê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ
    const progressModal = document.createElement('div');
    progressModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    progressModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">êµê³¼ëª© ì €ì¥ ì¤‘...</h3>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-sm text-gray-600 text-center">0 / ${selectedSubjects.length}</p>
        </div>
    `;
    document.body.appendChild(progressModal);
    
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    try {
        // êµê³¼ëª© ëª©ë¡ ë° ê°•ì‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const subjectsRes = await axios.get(`${API_BASE_URL}/api/subjects`);
        const allSubjects = subjectsRes.data;
        const instructorsRes = await axios.get(`${API_BASE_URL}/api/instructors`);
        const allInstructors = instructorsRes.data;
        
        // ê° êµê³¼ëª©ì˜ ìš”ì¼ê³¼ ë‹´ë‹¹ê°•ì‚¬ ì •ë³´ ìˆ˜ì§‘
        const subjectUpdates = [];
        
        for (let i = 0; i < selectedSubjects.length; i++) {
            const subjectCode = selectedSubjects[i];
            
            const daySelect = document.querySelector(`.subject-day-select[data-subject-code="${subjectCode}"]`);
            const biweeklySelect = document.querySelector(`.subject-biweekly-select[data-subject-code="${subjectCode}"]`);
            const instructorSelect = document.querySelector(`.subject-instructor-select[data-subject-code="${subjectCode}"]`);
            
            const dayOfWeek = daySelect ? parseInt(daySelect.value) : null;
            const isBiweekly = biweeklySelect ? parseInt(biweeklySelect.value) : 0;
            let mainInstructor = instructorSelect && instructorSelect.value ? instructorSelect.value : null;
            
            // main_instructorê°€ ì—†ìœ¼ë©´ êµê³¼ëª©ì˜ ê¸°ì¡´ main_instructorë¥¼ ìœ ì§€
            if (!mainInstructor) {
                const subject = allSubjects.find(s => s.code === subjectCode);
                mainInstructor = subject ? subject.main_instructor : null;
            }
            
            // ê°•ì‚¬ëª… ì°¾ê¸°
            const instructor = allInstructors.find(i => i.code === mainInstructor);
            const instructorName = instructor ? instructor.name : '(ë¯¸ì§€ì •)';
            
            // êµê³¼ëª© ì •ë³´ ì—…ë°ì´íŠ¸ (ìš”ì¼, ê²©ì£¼, ë‹´ë‹¹ê°•ì‚¬)
            await axios.put(`${API_BASE_URL}/api/subjects/${subjectCode}`, {
                day_of_week: dayOfWeek,
                is_biweekly: isBiweekly,
                main_instructor: mainInstructor
            });
            
            subjectUpdates.push({
                subject_code: subjectCode,
                day_of_week: dayOfWeek,
                is_biweekly: isBiweekly,
                main_instructor: mainInstructor,
                instructor_name: instructorName
            });
            
            // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
            const progress = ((i + 1) / selectedSubjects.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${i + 1} / ${selectedSubjects.length}`;
        }
        
        // course_subjects í…Œì´ë¸”ì— ê³¼ì •-êµê³¼ëª© ê´€ê³„ ì €ì¥
        await axios.post(`${API_BASE_URL}/api/courses/${courseCode}/subjects`, {
            subject_codes: selectedSubjects
        });
        
        // courseSubjectsì— ì €ì¥
        courseSubjects[courseCode] = selectedSubjects;
        
        console.log(`ê³¼ì • ${courseCode}ì— ì„ íƒëœ êµê³¼ëª©:`, selectedSubjects);
        console.log('êµê³¼ëª© ì—…ë°ì´íŠ¸ ì •ë³´:', subjectUpdates);
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì œê±°
        document.body.removeChild(progressModal);
        
        window.hideSubjectSelector();
        window.showAlert(`${selectedSubjects.length}ê°œì˜ êµê³¼ëª©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        
        // ê³¼ëª© ì˜ì—­ ì—…ë°ì´íŠ¸ (ì—…ë°ì´íŠ¸ëœ ì •ë³´ ì „ë‹¬)
        updateSubjectArea(courseCode, subjectUpdates);
    } catch (error) {
        console.error('êµê³¼ëª© ì €ì¥ ì‹¤íŒ¨:', error);
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì œê±°
        if (document.body.contains(progressModal)) {
            document.body.removeChild(progressModal);
        }
        window.showAlert('êµê³¼ëª© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// renderCoursesë¥¼ selectedCourseCodeë¥¼ ê³ ë ¤í•˜ë„ë¡ ìˆ˜ì •
function renderCourses() {
    const app = document.getElementById('app');
    
    // ì„ íƒëœ ê³¼ì •ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ê³¼ì • ì„ íƒ
    if (!selectedCourseCode && courses.length > 0) {
        selectedCourseCode = courses[0].code;
    }
    
    const selectedCourse = courses.find(c => c.code === selectedCourseCode);
    
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md">
            <!-- ê³¼ì • ì„ íƒ íƒ­ -->
            <div class="bg-gray-100 px-4 py-2 flex space-x-2 overflow-x-auto border-b">
                ${courses.map((c) => `
                    <button onclick="window.selectCourse('${c.code}')" 
                            class="course-tab px-4 py-2 rounded-t ${c.code === selectedCourseCode ? 'bg-white font-semibold border-t-2 border-blue-600' : 'bg-gray-200 hover:bg-gray-300'}" 
                            data-code="${c.code}">
                        <i class="fas fa-home mr-1"></i>${c.name || c.code}
                        <button onclick="event.stopPropagation(); window.deleteCourse('${c.code}')" class="ml-2 text-red-600 hover:text-red-800">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </button>
                `).join('')}
                <button onclick="window.showCourseForm()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-t">
                    <i class="fas fa-plus mr-1"></i>ê³¼ì • ì¶”ê°€
                </button>
                ${selectedCourse ? `
                <button 
                    onclick="window.generateTimetableFromButton('${selectedCourse.code}')" 
                    id="btn-generate-timetable-${selectedCourse.code}"
                    class="px-4 py-2 rounded-t font-semibold"
                    ${!selectedCourse.lecture_end_date || !selectedCourse.project_end_date || !selectedCourse.workship_end_date || !courseSubjects[selectedCourse.code] || courseSubjects[selectedCourse.code].length === 0 ? 'disabled' : ''}
                    style="${!selectedCourse.lecture_end_date || !selectedCourse.project_end_date || !selectedCourse.workship_end_date || !courseSubjects[selectedCourse.code] || courseSubjects[selectedCourse.code].length === 0 ? 'background: linear-gradient(to right, #94a3b8, #cbd5e1); color: #cbd5e1; cursor: not-allowed;' : 'background: linear-gradient(to right, #3b82f6, #4f46e5); color: white;'} ${!selectedCourse.lecture_end_date || !selectedCourse.project_end_date || !selectedCourse.workship_end_date || !courseSubjects[selectedCourse.code] || courseSubjects[selectedCourse.code].length === 0 ? '' : 'cursor: pointer;'}">
                    <i class="fas fa-calendar-plus mr-1"></i>ì‹œê°„í‘œìƒì„±
                </button>
                ` : ''}
            </div>
            
            ${selectedCourse ? renderCourseDetail(selectedCourse) : `
                <div class="p-8 text-center text-gray-500">
                    <i class="fas fa-folder-open text-4xl mb-4"></i>
                    <p>ë“±ë¡ëœ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. "ê³¼ì • ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìƒˆ ê³¼ì •ì„ ë§Œë“œì„¸ìš”.</p>
                </div>
            `}
        </div>
    `;
    
    // DOM ë Œë”ë§ í›„ êµê³¼ëª© ì˜ì—­ ì—…ë°ì´íŠ¸ ë° ê³µíœ´ì¼ ë¡œë“œ
    if (selectedCourse) {
        console.log(`ğŸ”„ renderCourses ì™„ë£Œ í›„ updateSubjectArea ì§ì ‘ í˜¸ì¶œ - ê³¼ì •: ${selectedCourse.code}`);
        updateSubjectArea(selectedCourse.code);
        
        // ê³µíœ´ì¼ ë¡œë“œ
        loadCourseHolidays(selectedCourse);
    }
}

// ê³¼ì •ì½”ë“œ ìë™ìƒì„±
function generateCourseCode() {
    if (courses.length === 0) return 'C-001';
    
    // ê¸°ì¡´ ê³¼ì • ì½”ë“œì—ì„œ ìˆ«ì ì¶”ì¶œ
    const numbers = courses
        .map(c => {
            const match = c.code.match(/C-(\d+)/);
            return match ? parseInt(match[1]) : 0;
        })
        .filter(n => n > 0);
    
    const maxNumber = Math.max(...numbers, 0);
    const newNumber = maxNumber + 1;
    return `C-${String(newNumber).padStart(3, '0')}`;
}

window.showCourseForm = function(code = null) {
    const formDiv = document.getElementById('course-form');
    const formContent = formDiv.querySelector('div');
    formDiv.classList.remove('hidden');
    
    const existing = code ? courses.find(c => c.code === code) : null;
    const autoCode = existing ? existing.code : generateCourseCode();
    
    formContent.innerHTML = `
        <h3 class="text-xl font-bold mb-4 text-gray-800">
            <i class="fas fa-${code ? 'edit' : 'plus-circle'} mr-2"></i>
            ${code ? 'ê³¼ì • ìˆ˜ì •' : 'ê³¼ì • ì¶”ê°€'}
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ê³¼ì •ì½”ë“œ * (ìë™ìƒì„±)</label>
                <input type="text" id="form-course-code" value="${autoCode}" readonly 
                       class="w-full border rounded px-3 py-2 bg-gray-100 cursor-not-allowed">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ê³¼ì •ëª… *</label>
                <input type="text" id="form-course-name" placeholder="ê³¼ì •ëª… ì…ë ¥" value="${existing ? existing.name : ''}" 
                       class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ê°•ì˜ì¥ì†Œ</label>
                <input type="text" id="form-course-location" placeholder="ì¥ì†Œ ì…ë ¥" value="${existing ? existing.location || '' : ''}" 
                       class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ì •ì›</label>
                <input type="number" id="form-course-capacity" placeholder="24" value="${existing ? existing.capacity : ''}" 
                       class="w-full border rounded px-3 py-2"
                       onkeydown="if(event.key==='Tab' && !this.value) {event.preventDefault(); this.value=this.placeholder; this.nextElementSibling ? this.parentElement.nextElementSibling.querySelector('input').focus() : null;}">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ê°•ì˜ì‹œê°„(h)</label>
                <input type="number" id="form-course-lecture-hours" placeholder="260" value="${existing ? existing.lecture_hours : ''}" 
                       class="w-full border rounded px-3 py-2"
                       onkeydown="if(event.key==='Tab' && !this.value) {event.preventDefault(); this.value=this.placeholder; this.parentElement.nextElementSibling.querySelector('input').focus();}">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">í”„ë¡œì íŠ¸ì‹œê°„(h)</label>
                <input type="number" id="form-course-project-hours" placeholder="220" value="${existing ? existing.project_hours : ''}" 
                       class="w-full border rounded px-3 py-2"
                       onkeydown="if(event.key==='Tab' && !this.value) {event.preventDefault(); this.value=this.placeholder; this.parentElement.nextElementSibling.querySelector('input').focus();}">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">í˜„ì¥ì‹¤ìŠµì‹œê°„(h)</label>
                <input type="number" id="form-course-workship-hours" placeholder="120" value="${existing ? existing.workship_hours : ''}" 
                       class="w-full border rounded px-3 py-2"
                       onkeydown="if(event.key==='Tab' && !this.value) {event.preventDefault(); this.value=this.placeholder;}">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">
                    <i class="fas fa-sun text-yellow-500 mr-1"></i>ì˜¤ì „ ìˆ˜ì—…ì‹œê°„(h)
                </label>
                <input type="number" id="form-course-morning-hours" placeholder="4" value="${existing ? (existing.morning_hours != null ? existing.morning_hours : 4) : 4}"
                       class="w-full border rounded px-3 py-2" min="0" max="8"
                       onchange="window.updateDailyHours()">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">
                    <i class="fas fa-moon text-blue-500 mr-1"></i>ì˜¤í›„ ìˆ˜ì—…ì‹œê°„(h)
                </label>
                <input type="number" id="form-course-afternoon-hours" placeholder="4" value="${existing ? (existing.afternoon_hours != null ? existing.afternoon_hours : 4) : 4}"
                       class="w-full border rounded px-3 py-2" min="0" max="8"
                       onchange="window.updateDailyHours()">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">
                    <i class="fas fa-clock text-purple-500 mr-1"></i>ì¼ì¼ ì´ ìˆ˜ì—…ì‹œê°„
                </label>
                <input type="number" id="form-course-daily-hours" value="${existing ? ((existing.morning_hours != null ? existing.morning_hours : 4) + (existing.afternoon_hours != null ? existing.afternoon_hours : 4)) : 8}" 
                       class="w-full border rounded px-3 py-2 bg-purple-50 font-semibold text-purple-600" readonly>
            </div>
            <div class="col-span-3">
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ì‹œì‘ì¼ *</label>
                        <input type="date" id="form-course-start-date" value="${existing ? existing.start_date : ''}" 
                               class="w-full border rounded px-3 py-2">
                    </div>
                    <button type="button" onclick="window.autoCalculateDates()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded self-end">
                        <i class="fas fa-calculator mr-2"></i>ìë™ê³„ì‚°
                    </button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ê°•ì˜ì¢…ë£Œì¼ (ì‹œê°„í¬í•¨)</label>
                <input type="text" id="form-course-lecture-end-display" value="${existing && existing.lecture_end_date ? existing.lecture_end_date + ' 13:00' : ''}" 
                       class="w-full border rounded px-3 py-2 bg-gray-50 font-semibold text-blue-600" readonly placeholder="YYYY-MM-DD HH:MM">
                <input type="date" id="form-course-lecture-end" value="${existing ? existing.lecture_end_date : ''}" class="hidden">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">í”„ë¡œì íŠ¸ì¢…ë£Œì¼ (ì‹œê°„í¬í•¨)</label>
                <input type="text" id="form-course-project-end-display" value="${existing && existing.project_end_date ? existing.project_end_date + ' 18:00' : ''}" 
                       class="w-full border rounded px-3 py-2 bg-gray-50 font-semibold text-green-600" readonly placeholder="YYYY-MM-DD HH:MM">
                <input type="date" id="form-course-project-end" value="${existing ? existing.project_end_date : ''}" class="hidden">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">í˜„ì¥ì‹¤ìŠµì¢…ë£Œì¼ (ì‹œê°„í¬í•¨)</label>
                <input type="text" id="form-course-workship-end-display" value="${existing && existing.workship_end_date ? existing.workship_end_date + ' 18:00' : ''}" 
                       class="w-full border rounded px-3 py-2 bg-gray-50 font-semibold text-red-600" readonly placeholder="YYYY-MM-DD HH:MM">
                <input type="date" id="form-course-workship-end" value="${existing ? existing.workship_end_date : ''}" class="hidden">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ìµœì¢…ì¢…ë£Œì¼</label>
                <input type="date" id="form-course-final-end" value="${existing ? existing.final_end_date : ''}" 
                       class="w-full border rounded px-3 py-2 bg-gray-50" readonly>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ì´ì¼ìˆ˜</label>
                <input type="number" id="form-course-total-days" placeholder="113" value="${existing ? existing.total_days : ''}" 
                       class="w-full border rounded px-3 py-2 bg-gray-50" readonly>
            </div>
        </div>
        <div class="mt-4">
            <label class="block text-sm font-semibold text-gray-700 mb-1">ë¹„ê³ </label>
            <textarea id="form-course-notes" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥" rows="3" 
                      class="w-full border rounded px-3 py-2">${existing ? existing.notes || '' : ''}</textarea>
        </div>
        <div class="mt-6 flex justify-end space-x-2">
            <button type="button" onclick="window.hideCourseForm()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded">
                <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
            </button>
            <button type="button" onclick="window.saveCourse('${code || ''}')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                <i class="fas fa-save mr-2"></i>ì €ì¥
            </button>
        </div>
    `;
}

window.hideCourseForm = function() {
    document.getElementById('course-form').classList.add('hidden');
}

window.saveCourse = async function(existingCode) {
    const data = {
        code: document.getElementById('form-course-code').value,
        name: document.getElementById('form-course-name').value,
        location: document.getElementById('form-course-location').value,
        capacity: parseInt(document.getElementById('form-course-capacity').value) || 24,
        lecture_hours: parseInt(document.getElementById('form-course-lecture-hours').value) || 0,
        project_hours: parseInt(document.getElementById('form-course-project-hours').value) || 0,
        workship_hours: parseInt(document.getElementById('form-course-workship-hours').value) || 0,
        morning_hours: (() => { const v = parseInt(document.getElementById('form-course-morning-hours').value); return isNaN(v) ? 4 : v; })(),
        afternoon_hours: (() => { const v = parseInt(document.getElementById('form-course-afternoon-hours').value); return isNaN(v) ? 4 : v; })(),
        start_date: document.getElementById('form-course-start-date').value,
        lecture_end_date: document.getElementById('form-course-lecture-end').value,
        project_end_date: document.getElementById('form-course-project-end').value,
        workship_end_date: document.getElementById('form-course-workship-end').value,
        final_end_date: document.getElementById('form-course-final-end').value,
        total_days: parseInt(document.getElementById('form-course-total-days').value) || 113,
        notes: document.getElementById('form-course-notes').value
    };
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!data.code || !data.name) {
        window.showAlert('ê³¼ì •ì½”ë“œì™€ ê³¼ì •ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', 'error');
        return;
    }
    
    try {
        if (existingCode) {
            await axios.put(`${API_BASE_URL}/api/courses/${existingCode}`, data);
            window.showAlert('ê³¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            selectedCourseCode = data.code;
        } else {
            await axios.post(`${API_BASE_URL}/api/courses`, data);
            window.showAlert('ê³¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            selectedCourseCode = data.code;
            // ìƒˆ ê³¼ì • ì¶”ê°€ ì‹œ ë¹ˆ êµê³¼ëª© ë°°ì—´ë¡œ ì´ˆê¸°í™”
            courseSubjects[data.code] = [];
        }
        window.hideCourseForm();
        await loadCourses();
    } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', error);
        showAlert('ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

window.editCourse = function(code) {
    window.showCourseForm(code);
}

window.deleteCourse = async function(code) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const confirmed = await window.showConfirm('âš ï¸ ì´ ê³¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/courses/${code}`);
        window.showAlert('âœ… ê³¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        
        // ì„ íƒëœ ê³¼ì • ì½”ë“œ ì´ˆê¸°í™”
        selectedCourseCode = null;
        
        await loadCourses();
    } catch (error) {
        console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ==================== íŒ€ ê´€ë¦¬ ====================
let projects = [];

// ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ ë Œë”ëŸ¬
function renderMarkdown(text) {
    if (!text) return '';
    
    // HTML ì´ìŠ¤ì¼€ì´í”„ ë¨¼ì €
    let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    
    // ë§ˆí¬ë‹¤ìš´ ë³€í™˜
    html = html
        // í—¤ë”© (## ì œëª©)
        .replace(/^### (.+)$/gm, '<h3 class="text-md font-semibold mt-3 mb-1">$1</h3>')
        .replace(/^## (.+)$/gm, '<h2 class="text-lg font-bold mt-4 mb-2">$1</h2>')
        .replace(/^# (.+)$/gm, '<h1 class="text-xl font-bold mt-4 mb-2">$1</h1>')
        // ë§í¬ [í…ìŠ¤íŠ¸](URL)
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline"><i class="fas fa-external-link-alt text-xs mr-1"></i>$1</a>')
        // êµµê²Œ **í…ìŠ¤íŠ¸**
        .replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold">$1</strong>')
        // ê¸°ìš¸ì„ *í…ìŠ¤íŠ¸*
        .replace(/\*([^*]+)\*/g, '<em class="italic">$1</em>')
        // ë¦¬ìŠ¤íŠ¸ - í•­ëª©
        .replace(/^- (.+)$/gm, '<li class="ml-4">â€¢ $1</li>')
        // ì¤„ë°”ê¿ˆ
        .replace(/\n/g, '<br>');
    
    return html;
}

async function loadProjects() {
    try {
        window.showLoading('íŒ€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const [projectsRes, coursesRes, studentsRes, instructorsRes, instructorTypesRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/projects`),
            axios.get(`${API_BASE_URL}/api/courses`),
            axios.get(`${API_BASE_URL}/api/students`),
            axios.get(`${API_BASE_URL}/api/instructors`),
            axios.get(`${API_BASE_URL}/api/instructor-codes`)
        ]);
        projects = projectsRes.data;
        courses = coursesRes.data;
        students = studentsRes.data;
        instructors = instructorsRes.data;
        instructorTypes = instructorTypesRes.data;
        renderProjects();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('íŒ€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">íŒ€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

let projectsFilterCourse = '';
let projectsFilterGroup = '';
let projectsFilterStudent = '';
let projectsSearchQuery = '';

function renderProjects() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-users mr-2"></i>íŒ€ ê´€ë¦¬ (ì´ ${projects.length}ê°œ)
                </h2>
                <div class="flex gap-2">
                    <button onclick="window.showProjectForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>íŒ€ ì¶”ê°€
                    </button>
                    <button onclick="window.showProjectExportOptions()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-export mr-2"></i>Excel ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button onclick="window.showProjectExcelUpload()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-excel mr-2"></i>Excel ì—…ë¡œë“œ
                    </button>
                </div>
            </div>

            <div id="project-excel-upload" class="hidden mb-6 p-4 bg-purple-50 rounded-lg"></div>

            <!-- í•„í„° ë° ê²€ìƒ‰ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê³¼ì • í•„í„°</label>
                    <select id="projects-course-filter" onchange="window.filterProjects()" class="w-full border rounded px-3 py-2">
                        <option value="">ì „ì²´ ê³¼ì •</option>
                        ${courses.map(c => `<option value="${c.code}">${c.name || c.code}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë£¹ êµ¬ë¶„</label>
                    <select id="projects-group-filter" onchange="window.filterProjects()" class="w-full border rounded px-3 py-2">
                        <option value="">ì „ì²´ ê·¸ë£¹</option>
                        <option value="1. ìŠ¤í„°ë””ê·¸ë£¹">1. ìŠ¤í„°ë””ê·¸ë£¹</option>
                        <option value="2. í”„ë¡œì íŠ¸ê·¸ë£¹">2. í”„ë¡œì íŠ¸ê·¸ë£¹</option>
                        <option value="3. í˜„ì¥ì‹¤ìŠµê·¸ë£¹">3. í˜„ì¥ì‹¤ìŠµê·¸ë£¹</option>
                        <option value="4. ììœ ì£¼ì œê·¸ë£¹">4. ììœ ì£¼ì œê·¸ë£¹</option>
                        <option value="5. ê¸°íƒ€ê·¸ë£¹">5. ê¸°íƒ€ê·¸ë£¹</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒ í•„í„°</label>
                    <select id="projects-student-filter" onchange="window.filterProjects()" class="w-full border rounded px-3 py-2">
                        <option value="">ì „ì²´ í•™ìƒ</option>
                        ${students.map(s => `<option value="${s.code}">${s.name} (${s.code})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê²€ìƒ‰ (íŒ€ëª… ë˜ëŠ” íŒ€ì›)</label>
                    <input type="text" id="projects-search" oninput="window.searchProjects()" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full border rounded px-3 py-2">
                </div>
            </div>
            
            <div id="project-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg"></div>
            
            <div id="projects-list"></div>
        </div>
    `;
    
    window.filterProjects();
}

window.filterProjects = function() {
    const courseFilter = document.getElementById('projects-course-filter');
    const groupFilter = document.getElementById('projects-group-filter');
    const studentFilter = document.getElementById('projects-student-filter');
    projectsFilterCourse = courseFilter ? courseFilter.value : '';
    projectsFilterGroup = groupFilter ? groupFilter.value : '';
    projectsFilterStudent = studentFilter ? studentFilter.value : '';
    window.renderProjectsList();
}

window.searchProjects = function() {
    const searchInput = document.getElementById('projects-search');
    projectsSearchQuery = searchInput ? searchInput.value.toLowerCase() : '';
    window.renderProjectsList();
}

window.renderProjectsList = function() {
    let filteredProjects = projects;
    
    // ê³¼ì • í•„í„°
    if (projectsFilterCourse) {
        filteredProjects = filteredProjects.filter(p => p.course_code === projectsFilterCourse);
    }
    
    // ê·¸ë£¹ êµ¬ë¶„ í•„í„°
    if (projectsFilterGroup) {
        filteredProjects = filteredProjects.filter(p => p.group_type === projectsFilterGroup);
    }
    
    // í•™ìƒ í•„í„° (íŒ€ì› ì¤‘ í•œ ëª…ì´ë¼ë„ í•´ë‹¹ í•™ìƒì´ ìˆìœ¼ë©´)
    if (projectsFilterStudent) {
        filteredProjects = filteredProjects.filter(p => {
            return p.member1_code === projectsFilterStudent ||
                   p.member2_code === projectsFilterStudent ||
                   p.member3_code === projectsFilterStudent ||
                   p.member4_code === projectsFilterStudent ||
                   p.member5_code === projectsFilterStudent ||
                   p.member6_code === projectsFilterStudent;
        });
    }
    
    // ê²€ìƒ‰ í•„í„° (íŒ€ëª… ë˜ëŠ” íŒ€ì› ì´ë¦„)
    if (projectsSearchQuery) {
        filteredProjects = filteredProjects.filter(p => {
            const matchName = (p.name || '').toLowerCase().includes(projectsSearchQuery);
            const matchMember1 = (p.member1_name || '').toLowerCase().includes(projectsSearchQuery);
            const matchMember2 = (p.member2_name || '').toLowerCase().includes(projectsSearchQuery);
            const matchMember3 = (p.member3_name || '').toLowerCase().includes(projectsSearchQuery);
            const matchMember4 = (p.member4_name || '').toLowerCase().includes(projectsSearchQuery);
            const matchMember5 = (p.member5_name || '').toLowerCase().includes(projectsSearchQuery);
            const matchMember6 = (p.member6_name || '').toLowerCase().includes(projectsSearchQuery);
            return matchName || matchMember1 || matchMember2 || matchMember3 || matchMember4 || matchMember5 || matchMember6;
        });
    }
    
    // í—¤ë” ì •ë ¬ ì ìš©
    filteredProjects = genericSort(filteredProjects, projectSortKey, projectSortAsc);
    
    const listDiv = document.getElementById('projects-list');
    
    if (filteredProjects.length === 0) {
        listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">ì¡°ê±´ì— ë§ëŠ” íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    listDiv.innerHTML = `
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 w-12">ì‚¬ì§„</th>
                        ${sortableHeader([
                            { key: 'code', label: 'íŒ€ ì½”ë“œ' },
                            { key: 'name', label: 'íŒ€ëª…' },
                            { key: 'description', label: 'ì„¤ëª…' },
                            { key: 'group_type', label: 'ê·¸ë£¹êµ¬ë¶„' },
                            { key: 'course_name', label: 'ê³¼ì •' },
                            { key: 'instructor_name', label: 'ì£¼ê°•ì‚¬' },
                            { key: 'mentor_name', label: 'ë©˜í† ' },
                            { key: 'member1_name', label: 'íŒ€ì›1' },
                            { key: 'member2_name', label: 'íŒ€ì›2' },
                            { key: 'member3_name', label: 'íŒ€ì›3' },
                            { key: 'member4_name', label: 'íŒ€ì›4' },
                            { key: 'member5_name', label: 'íŒ€ì›5' },
                            { key: 'member6_name', label: 'íŒ€ì›6' }
                        ], projectSortKey, projectSortAsc, 'window.sortProjectTable', 'px-4 py-2 text-left text-xs font-medium text-gray-700')}
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredProjects.map(p => {
                        const photoUrls = p.photo_urls ? (typeof p.photo_urls === 'string' ? JSON.parse(p.photo_urls) : p.photo_urls) : [];
                        return `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="px-2 py-2 text-center text-xs">
                                ${photoUrls.length > 0 ? `
                                    <i class="fas fa-camera text-green-600" title="${photoUrls.length}ê°œ ì‚¬ì§„"></i>
                                ` : `
                                    <i class="fas fa-camera text-gray-300" title="ì‚¬ì§„ ì—†ìŒ"></i>
                                `}
                            </td>
                            <td class="px-4 py-2 text-xs font-mono">${p.code}</td>
                            <td class="px-4 py-2 text-xs font-semibold">${p.name}</td>
                            <td class="px-4 py-2 text-xs" style="max-width: 200px;">
                                ${p.description ? `
                                    <button onclick="window.showProjectDescription('${p.code.replace(/'/g, "\\'")}', \`${(p.description || '').replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" 
                                            class="text-blue-600 hover:text-blue-800 underline text-left w-full" 
                                            style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block;">
                                        <i class="fas fa-file-alt mr-1"></i>${(p.description || '').substring(0, 30)}${p.description.length > 30 ? '...' : ''}
                                    </button>
                                ` : '<span class="text-gray-400">-</span>'}
                            </td>
                            <td class="px-4 py-2 text-xs">${p.group_type || '-'}</td>
                            <td class="px-4 py-2 text-xs text-blue-600">${p.course_name || p.course_code || '-'}</td>
                            <td class="px-4 py-2 text-xs">${p.instructor_name || '-'}</td>
                            <td class="px-4 py-2 text-xs">${p.mentor_name || '-'}</td>
                            <td class="px-4 py-2 text-xs">${p.member1_name || '-'}</td>
                            <td class="px-4 py-2 text-xs">${p.member2_name || '-'}</td>
                            <td class="px-4 py-2 text-xs">${p.member3_name || '-'}</td>
                            <td class="px-4 py-2 text-xs">${p.member4_name || '-'}</td>
                            <td class="px-4 py-2 text-xs">${p.member5_name || '-'}</td>
                            <td class="px-4 py-2 text-xs">${p.member6_name || '-'}</td>
                            <td class="px-4 py-2 text-xs">
                                <button onclick="window.editProject('${p.code}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="window.deleteProject('${p.code}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// íŒ€ Excel ë‚´ë³´ë‚´ê¸° ì˜µì…˜
window.showProjectExportOptions = function() {
    const courseOptions = courses.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
    window.showModal('íŒ€ Excel ë‚´ë³´ë‚´ê¸°', `
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2 font-medium">ë‚´ë³´ë‚¼ ê³¼ì • ì„ íƒ</label>
                <select id="export-project-course" class="w-full border rounded px-3 py-2">
                    <option value="">ì „ì²´ ê³¼ì •</option>
                    ${courseOptions}
                </select>
            </div>
            <p class="text-sm text-gray-500"><i class="fas fa-info-circle mr-1"></i>ì„ íƒí•œ ê³¼ì •ì˜ íŒ€ ì •ë³´ë¥¼ Excelë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="window.closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="window.exportProjectsToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i>ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </div>
    `);
}

window.exportProjectsToExcel = function() {
    const courseCode = document.getElementById('export-project-course')?.value;
    let exportData = [...projects];
    let fileName = 'íŒ€ëª©ë¡_ì „ì²´';

    if (courseCode) {
        exportData = projects.filter(p => p.course_code === courseCode);
        const courseName = courses.find(c => c.code === courseCode)?.name || courseCode;
        fileName = `íŒ€ëª©ë¡_${courseName}`;
    }

    if (exportData.length === 0) {
        window.showAlert('ë‚´ë³´ë‚¼ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    const excelData = exportData.map((p, idx) => ({
        'No': idx + 1,
        'íŒ€ì½”ë“œ': p.code || '',
        'íŒ€ëª…': p.name || '',
        'ê³¼ì •': courses.find(c => c.code === p.course_code)?.name || p.course_code || '',
        'ê·¸ë£¹êµ¬ë¶„': p.group_type || '',
        'íŒ€ì›': (p.members || []).map(m => students.find(s => s.id === m)?.name || m).join(', '),
        'íŒ€ì¥': students.find(s => s.id === p.leader_id)?.name || '',
        'ì£¼ì œ': p.topic || '',
        'ìƒíƒœ': p.status || '',
        'ë¹„ê³ ': p.note || ''
    }));

    const ws = XLSX.utils.json_to_sheet(excelData);
    ws['!cols'] = [{ wch: 5 }, { wch: 10 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 30 }, { wch: 10 }, { wch: 30 }, { wch: 10 }, { wch: 20 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'íŒ€ëª©ë¡');
    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(wb, `${fileName}_${today}.xlsx`);
    window.closeModal();
    window.showAlert(`${exportData.length}ê°œ íŒ€ ì •ë³´ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
}

// íŒ€ Excel ì—…ë¡œë“œ UI
window.showProjectExcelUpload = function() {
    const div = document.getElementById('project-excel-upload');
    div.classList.remove('hidden');
    div.innerHTML = `
        <h3 class="text-lg font-bold mb-4">íŒ€ Excel ì¼ê´„ ì—…ë¡œë“œ</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2">Excel íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="project-excel-file" accept=".xlsx,.xls" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                í•„ìˆ˜ ì»¬ëŸ¼: íŒ€ëª…, ê³¼ì •ì½”ë“œ | ì„ íƒ: ê·¸ë£¹êµ¬ë¶„, ì£¼ì œ, ìƒíƒœ, ë¹„ê³ 
            </p>
            <div class="space-x-2">
                <button onclick="window.uploadProjectExcel()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-upload mr-2"></i>ì—…ë¡œë“œ
                </button>
                <button onclick="window.hideProjectExcelUpload()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
            </div>
        </div>
    `;
}

window.hideProjectExcelUpload = function() {
    document.getElementById('project-excel-upload').classList.add('hidden');
}

window.uploadProjectExcel = async function() {
    const fileInput = document.getElementById('project-excel-file');
    const file = fileInput?.files[0];
    if (!file) { window.showAlert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning'); return; }

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (jsonData.length === 0) { window.showAlert('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning'); return; }

        let successCount = 0, failCount = 0;
        for (const row of jsonData) {
            const name = row['íŒ€ëª…'] || row['name'] || '';
            const courseCode = row['ê³¼ì •ì½”ë“œ'] || row['course_code'] || '';

            if (!name || !courseCode) { failCount++; continue; }

            // íŒ€ ì½”ë“œ ìë™ ìƒì„±
            const maxCode = projects.reduce((max, p) => {
                const match = p.code?.match(/P-(\d+)/);
                return match ? Math.max(max, parseInt(match[1])) : max;
            }, 0);
            const newCode = 'P-' + String(maxCode + 1 + successCount).padStart(3, '0');

            const projectData = {
                code: newCode,
                name: name,
                course_code: courseCode,
                group_type: row['ê·¸ë£¹êµ¬ë¶„'] || row['group_type'] || '',
                topic: row['ì£¼ì œ'] || row['topic'] || '',
                status: row['ìƒíƒœ'] || row['status'] || 'ì§„í–‰ì¤‘',
                note: row['ë¹„ê³ '] || row['note'] || ''
            };

            try {
                await axios.post(`${API_BASE_URL}/api/projects`, projectData);
                successCount++;
            } catch (e) { failCount++; }
        }

        await loadData();
        renderProjects();
        window.hideProjectExcelUpload();
        window.showAlert(`ì—…ë¡œë“œ ì™„ë£Œ! ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${failCount}ê°œ`, successCount > 0 ? 'success' : 'warning');
    } catch (error) {
        console.error('Excel íŒŒì‹± ì‹¤íŒ¨:', error);
        window.showAlert('Excel íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

window.showProjectForm = function(code = null) {
    const formDiv = document.getElementById('project-form');
    formDiv.classList.remove('hidden');

    const existing = code ? projects.find(p => p.code === code) : null;
    
    // íŒ€ ì½”ë“œ ìë™ ìƒì„± (TEAM001, TEAM002...)
    let autoCode = '';
    if (!code) {
        const maxCode = projects.reduce((max, p) => {
            const match = p.code.match(/^TEAM(\d+)$/);
            if (match) {
                const num = parseInt(match[1]);
                return num > max ? num : max;
            }
            return max;
        }, 0);
        autoCode = `TEAM${String(maxCode + 1).padStart(3, '0')}`;
    }
    
    formDiv.innerHTML = `
        <h3 class="text-lg font-semibold mb-4">${code ? 'íŒ€ ìˆ˜ì •' : 'íŒ€ ì¶”ê°€'}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">íŒ€ ì½”ë“œ</label>
                <input type="text" id="proj-code" placeholder="íŒ€ì½”ë“œ" value="${existing ? existing.code : autoCode}" ${code ? 'readonly' : 'readonly'} class="border rounded px-3 py-2 w-full bg-gray-100">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">íŒ€ëª… *</label>
                <input type="text" id="proj-name" placeholder="íŒ€ëª…" value="${existing ? existing.name : ''}" class="border rounded px-3 py-2 w-full">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    ì„¤ëª… ë° ë§í¬
                    <span class="text-xs text-gray-500 font-normal ml-2">
                        (ë§ˆí¬ë‹¤ìš´ ì§€ì›: **êµµê²Œ**, *ê¸°ìš¸ì„*, [ë§í¬](URL))
                    </span>
                </label>
                <textarea id="proj-description" placeholder="ì˜ˆì‹œ:&#10;## í”„ë¡œì íŠ¸ ì†Œê°œ&#10;ìš°ë¦¬ íŒ€ì˜ ì›¹ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.&#10;&#10;**ì‚¬ì´íŠ¸ ë§í¬**: [ìš°ë¦¬ íŒ€ ì‚¬ì´íŠ¸](https://example.com)&#10;**GitHub**: [ì €ì¥ì†Œ](https://github.com/...)&#10;&#10;### ì£¼ìš” ê¸°ëŠ¥&#10;- ê¸°ëŠ¥ 1&#10;- ê¸°ëŠ¥ 2" rows="6" maxlength="2000" class="border rounded px-3 py-2 w-full resize-y font-mono text-sm">${existing ? (existing.description || '') : ''}</textarea>
                <div class="flex justify-between items-center mt-1">
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±í•˜ë©´ ë³´ê¸° ì¢‹ê²Œ í‘œì‹œë©ë‹ˆë‹¤
                    </p>
                    <p class="text-xs text-gray-500">
                        <span id="proj-description-count">0</span> / 2000ì
                    </p>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ê·¸ë£¹ êµ¬ë¶„ *</label>
                <select id="proj-group" class="border rounded px-3 py-2 w-full">
                    <option value="">ê·¸ë£¹ ì„ íƒ</option>
                    <option value="1. ìŠ¤í„°ë””ê·¸ë£¹" ${existing && existing.group_type === '1. ìŠ¤í„°ë””ê·¸ë£¹' ? 'selected' : ''}>1. ìŠ¤í„°ë””ê·¸ë£¹</option>
                    <option value="2. í”„ë¡œì íŠ¸ê·¸ë£¹" ${existing && existing.group_type === '2. í”„ë¡œì íŠ¸ê·¸ë£¹' ? 'selected' : ''}>2. í”„ë¡œì íŠ¸ê·¸ë£¹</option>
                    <option value="3. í˜„ì¥ì‹¤ìŠµê·¸ë£¹" ${existing && existing.group_type === '3. í˜„ì¥ì‹¤ìŠµê·¸ë£¹' ? 'selected' : ''}>3. í˜„ì¥ì‹¤ìŠµê·¸ë£¹</option>
                    <option value="4. ììœ ì£¼ì œê·¸ë£¹" ${existing && existing.group_type === '4. ììœ ì£¼ì œê·¸ë£¹' ? 'selected' : ''}>4. ììœ ì£¼ì œê·¸ë£¹</option>
                    <option value="5. ê¸°íƒ€ê·¸ë£¹" ${existing && existing.group_type === '5. ê¸°íƒ€ê·¸ë£¹' ? 'selected' : ''}>5. ê¸°íƒ€ê·¸ë£¹</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ê³¼ì • *</label>
                <select id="proj-course" onchange="window.updateProjectStudentList()" class="border rounded px-3 py-2 w-full">
                    <option value="">ê³¼ì • ì„ íƒ</option>
                    ${courses.map(c => `<option value="${c.code}" ${existing && existing.course_code === c.code ? 'selected' : ''}>${c.name || c.code}</option>`).join('')}
                </select>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì£¼ê°•ì‚¬</label>
                <select id="proj-instructor" class="border rounded px-3 py-2 w-full">
                    <option value="">ì„ íƒ ì•ˆí•¨</option>
                    ${instructors.filter(inst => {
                        const typeInfo = instructorTypes.find(t => t.code === inst.instructor_type);
                        return typeInfo && typeInfo.type === '1. ì£¼ê°•ì‚¬';
                    }).map(inst => {
                        const typeInfo = instructorTypes.find(t => t.code === inst.instructor_type);
                        return `<option value="${inst.code}" ${existing && existing.instructor_code === inst.code ? 'selected' : ''}>${inst.name} - ${inst.code} - ${typeInfo.name} - ${typeInfo.type}</option>`;
                    }).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ë©˜í† </label>
                <select id="proj-mentor" class="border rounded px-3 py-2 w-full">
                    <option value="">ì„ íƒ ì•ˆí•¨</option>
                    ${instructors.filter(inst => {
                        const typeInfo = instructorTypes.find(t => t.code === inst.instructor_type);
                        return typeInfo && typeInfo.type === '3. ë©˜í† ';
                    }).map(inst => {
                        const typeInfo = instructorTypes.find(t => t.code === inst.instructor_type);
                        return `<option value="${inst.code}" ${existing && existing.mentor_code === inst.code ? 'selected' : ''}>${inst.name} - ${inst.code} - ${typeInfo.name} - ${typeInfo.type}</option>`;
                    }).join('')}
                </select>
            </div>
        </div>
        
        <h4 class="font-semibold mb-2">ê³µìœ ê³„ì • (ìµœëŒ€ 5ê°œ)</h4>
        <div class="space-y-2 mb-4">
            ${[1, 2, 3, 4, 5].map(i => `
                <div class="grid grid-cols-3 gap-2">
                    <input type="text" id="account${i}-name" placeholder="ê³„ì •ëª…ì¹­ ${i}" value="${existing ? existing[`account${i}_name`] || '' : ''}" class="border rounded px-3 py-2">
                    <input type="text" id="account${i}-id" placeholder="ê³„ì • ID" value="${existing ? existing[`account${i}_id`] || '' : ''}" class="border rounded px-3 py-2">
                    <input type="text" id="account${i}-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" value="${existing ? existing[`account${i}_pw`] || '' : ''}" class="border rounded px-3 py-2">
                </div>
            `).join('')}
        </div>
        
        <h4 class="font-semibold mb-2">íŒ€ì› ì •ë³´ (ìµœëŒ€ 6ëª…)</h4>
        <div class="space-y-2">
            ${[1, 2, 3, 4, 5, 6].map(i => `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">íŒ€ì›${i}</label>
                    <select id="member${i}-select" onchange="window.selectProjectMember(${i})" class="border rounded px-3 py-2 w-full">
                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                    </select>
                    <input type="hidden" id="member${i}-name" value="${existing ? existing[`member${i}_name`] || '' : ''}">
                    <input type="hidden" id="member${i}-phone" value="${existing ? existing[`member${i}_phone`] || '' : ''}">
                    <input type="hidden" id="member${i}-code" value="${existing ? existing[`member${i}_code`] || '' : ''}">
                </div>
            `).join('')}
        </div>
        
        <!-- ì‚¬ì§„ ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="mt-6">
            <h4 class="font-semibold mb-2">
                <i class="fas fa-paperclip mr-2"></i>ì‚¬ì§„ ë° íŒŒì¼ ì²¨ë¶€ (ê·¸ë¦¼íŒŒì¼, PDF, HWP, PPT, Excel, Word, TXT ë“±)
            </h4>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                <div class="flex flex-wrap gap-2 mb-3">
                    <button type="button" onclick="document.getElementById('project-file-input').click()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                    </button>
                    <button type="button" onclick="document.getElementById('project-camera-input').click()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-camera mr-2"></i>ì‚¬ì§„ ì´¬ì˜
                    </button>
                </div>
                <div id="project-upload-progress" class="hidden mb-3">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                        <p class="text-sm text-blue-800 mb-2">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                            ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                        </p>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            <div id="project-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <input type="file" id="project-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                       onchange="window.handleProjectImageUpload(event)" class="hidden">
                <input type="file" id="project-camera-input" accept="image/*" 
                       onchange="window.handleProjectImageUpload(event)" class="hidden">
                <div id="project-photos-preview" class="flex flex-col gap-2 mt-2"></div>
                <input type="hidden" id="project-photo-urls" value='${existing && existing.photo_urls ? existing.photo_urls : "[]"}'>
                <input type="hidden" id="project-code" value="${code || ''}">
                <p class="text-sm text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    ìµœëŒ€ 10MB, JPG/PNG/GIF í˜•ì‹
                </p>
            </div>
        </div>
        
        <div class="mt-4 space-x-2">
            <button onclick="window.saveProject('${code || ''}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                <i class="fas fa-save mr-2"></i>ì €ì¥
            </button>
            <button onclick="window.hideProjectForm()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
                ì·¨ì†Œ
            </button>
        </div>
    `;
    
    // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    formDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // ì´ˆê¸° í•™ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
    window.updateProjectStudentList();
    
    // ê¸°ì¡´ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    if (existing && existing.photo_urls) {
        try {
            const photoUrls = typeof existing.photo_urls === 'string' 
                ? JSON.parse(existing.photo_urls) 
                : existing.photo_urls;
            updateProjectPhotoPreview(photoUrls);
        } catch (e) {
            console.error('ì‚¬ì§„ URL íŒŒì‹± ì˜¤ë¥˜:', e);
        }
    }
    
    // ì„¤ëª… í•„ë“œ ê¸€ììˆ˜ ì¹´ìš´í„° ì´ˆê¸°í™”
    const descTextarea = document.getElementById('proj-description');
    const descCount = document.getElementById('proj-description-count');
    if (descTextarea && descCount) {
        const updateCount = () => {
            descCount.textContent = descTextarea.value.length;
        };
        updateCount(); // ì´ˆê¸°ê°’ ì„¤ì •
        descTextarea.addEventListener('input', updateCount);
    }
}

window.updateProjectStudentList = function() {
    const courseSelect = document.getElementById('proj-course');
    const selectedCourse = courseSelect ? courseSelect.value : '';
    
    // ì„ íƒëœ ê³¼ì •ì˜ í•™ìƒë“¤ë§Œ í•„í„°ë§
    const filteredStudents = selectedCourse 
        ? students.filter(s => s.course_code === selectedCourse)
        : students;
    
    // í•™ìƒ ëª©ë¡ì„ ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedStudents = filteredStudents.sort((a, b) => 
        (a.name || '').localeCompare(b.name || '', 'ko')
    );
    
    // ê° íŒ€ì› ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (member6 í¬í•¨)
    for (let i = 1; i <= 6; i++) {
        const select = document.getElementById(`member${i}-select`);
        const nameInput = document.getElementById(`member${i}-name`);
        const codeInput = document.getElementById(`member${i}-code`);
        
        if (select) {
            const currentValue = codeInput ? codeInput.value : '';
            select.innerHTML = `
                <option value="">ì„ íƒ ì•ˆí•¨</option>
                ${sortedStudents.map(s => {
                    const course = courses.find(c => c.code === s.course_code);
                    const courseName = course ? course.name || course.code : '-';
                    return `
                        <option value="${s.code}" ${s.code === currentValue ? 'selected' : ''}>
                            ${s.name}(${s.code}) - ${courseName} - ${s.birth_date ? s.birth_date.split('T')[0] : '-'} - ${s.final_school || '-'}
                        </option>
                    `;
                }).join('')}
            `;
            
            // ê¸°ì¡´ ê°’ì´ ìˆìœ¼ë©´ í‘œì‹œ ì—…ë°ì´íŠ¸
            if (currentValue) {
                const student = students.find(s => s.code === currentValue);
                if (student && select.value) {
                    select.value = currentValue;
                }
            }
        }
    }
}

window.selectProjectMember = function(memberIndex) {
    const select = document.getElementById(`member${memberIndex}-select`);
    const studentCode = select ? select.value : '';
    
    const nameInput = document.getElementById(`member${memberIndex}-name`);
    const phoneInput = document.getElementById(`member${memberIndex}-phone`);
    const codeInput = document.getElementById(`member${memberIndex}-code`);
    
    if (studentCode) {
        const student = students.find(s => s.code === studentCode);
        if (student) {
            if (nameInput) nameInput.value = student.name;
            if (phoneInput) phoneInput.value = student.phone || '';
            if (codeInput) codeInput.value = student.code;
        }
    } else {
        if (nameInput) nameInput.value = '';
        if (phoneInput) phoneInput.value = '';
        if (codeInput) codeInput.value = '';
    }
}

window.hideProjectForm = function() {
    document.getElementById('project-form').classList.add('hidden');
}

window.saveProject = async function(existingCode, autoSave = false) {
    const code = document.getElementById('proj-code').value;
    const name = document.getElementById('proj-name').value;
    const description = document.getElementById('proj-description').value;
    const groupType = document.getElementById('proj-group').value;
    const courseCode = document.getElementById('proj-course').value;
    const instructorCode = document.getElementById('proj-instructor').value;
    const mentorCode = document.getElementById('proj-mentor').value;
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!code) {
        window.showAlert('íŒ€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    if (!name) {
        window.showAlert('íŒ€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    if (!groupType) {
        window.showAlert('ê·¸ë£¹ êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    if (!courseCode) {
        window.showAlert('ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // ì‚¬ì§„ URL ê°€ì ¸ì˜¤ê¸°
    const photoUrlsInput = document.getElementById('project-photo-urls');
    const photoUrls = photoUrlsInput ? photoUrlsInput.value : '[]';
    
    const data = {
        code: code,
        name: name,
        description: description || null,
        group_type: groupType,
        course_code: courseCode,
        instructor_code: instructorCode || null,
        mentor_code: mentorCode || null,
        member1_name: document.getElementById('member1-name').value,
        member1_phone: document.getElementById('member1-phone').value,
        member1_code: document.getElementById('member1-code').value,
        member2_name: document.getElementById('member2-name').value,
        member2_phone: document.getElementById('member2-phone').value,
        member2_code: document.getElementById('member2-code').value,
        member3_name: document.getElementById('member3-name').value,
        member3_phone: document.getElementById('member3-phone').value,
        member3_code: document.getElementById('member3-code').value,
        member4_name: document.getElementById('member4-name').value,
        member4_phone: document.getElementById('member4-phone').value,
        member4_code: document.getElementById('member4-code').value,
        member5_name: document.getElementById('member5-name').value,
        member5_phone: document.getElementById('member5-phone').value,
        member5_code: document.getElementById('member5-code').value,
        member6_name: document.getElementById('member6-name').value,
        member6_phone: document.getElementById('member6-phone').value,
        member6_code: document.getElementById('member6-code').value,
        // ê³µìœ ê³„ì • í•„ë“œ ì¶”ê°€
        account1_name: document.getElementById('account1-name').value || null,
        account1_id: document.getElementById('account1-id').value || null,
        account1_pw: document.getElementById('account1-pw').value || null,
        account2_name: document.getElementById('account2-name').value || null,
        account2_id: document.getElementById('account2-id').value || null,
        account2_pw: document.getElementById('account2-pw').value || null,
        account3_name: document.getElementById('account3-name').value || null,
        account3_id: document.getElementById('account3-id').value || null,
        account3_pw: document.getElementById('account3-pw').value || null,
        account4_name: document.getElementById('account4-name').value || null,
        account4_id: document.getElementById('account4-id').value || null,
        account4_pw: document.getElementById('account4-pw').value || null,
        account5_name: document.getElementById('account5-name').value || null,
        account5_id: document.getElementById('account5-id').value || null,
        account5_pw: document.getElementById('account5-pw').value || null,
        photo_urls: photoUrls
    };
    
    try {
        if (existingCode) {
            await axios.put(`${API_BASE_URL}/api/projects/${existingCode}`, data);
            if (!autoSave) {
                window.showAlert('íŒ€ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.hideProjectForm();
                await loadProjects();
            }
        } else {
            await axios.post(`${API_BASE_URL}/api/projects`, data);
            if (!autoSave) {
                window.showAlert('íŒ€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.hideProjectForm();
                await loadProjects();
            }
        }
    } catch (error) {
        window.showAlert('ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

window.editProject = function(code) {
    window.showProjectForm(code);
}

window.showProjectDescription = function(code, description) {
    const project = projects.find(p => p.code === code);
    if (!project) return;
    
    const renderedMarkdown = renderMarkdown(description);
    
    window.showCustomAlert(`
        <div class="text-left">
            <h3 class="text-lg font-bold mb-3 text-gray-800 border-b pb-2">
                <i class="fas fa-users mr-2 text-blue-600"></i>${project.name || code}
            </h3>
            <div class="prose prose-sm max-w-none text-gray-700 leading-relaxed">
                ${renderedMarkdown}
            </div>
            ${!description || description.trim() === '' ? '<p class="text-gray-400 italic">ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : ''}
        </div>
    `, 'info', 'íŒ€ ì„¤ëª…');
};

window.deleteProject = async function(code) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    const confirmed = await window.showConfirm('ì´ íŒ€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    try {
        window.showLoading('íŒ€ ì‚­ì œ ì¤‘...');
        await axios.delete(`${API_BASE_URL}/api/projects/${code}`);
        window.hideLoading();
        window.showAlert('íŒ€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadProjects();
    } catch (error) {
        window.hideLoading();
        window.showAlert('ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

// íŒ€ ì‚¬ì§„ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
window.handleProjectImageUpload = async function(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    // íŒŒì¼ ê²€ì¦
    for (let file of files) {
        const validation = window.validateFile(file);
        if (!validation.valid) {
            window.showAlert(validation.message);
            event.target.value = '';
            return;
        }
    }

    const progressDiv = document.getElementById('project-upload-progress');
    const progressBar = document.getElementById('project-progress-bar');
    progressDiv?.classList.remove('hidden');
    if (progressBar) progressBar.style.width = '0%';

    const projectCode = document.getElementById('project-code')?.value || '';
    const projectName = document.getElementById('project-name')?.value || 'ì´ë¦„ ë¯¸ì§€ì •';

    try {
        let photoUrls = [];
        const existingUrlsInput = document.getElementById('project-photo-urls');
        if (existingUrlsInput && existingUrlsInput.value) {
            try {
                photoUrls = JSON.parse(existingUrlsInput.value);
            } catch (e) {
                console.error('ê¸°ì¡´ URL íŒŒì‹± ì˜¤ë¥˜:', e);
            }
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ì´ë¯¸ì§€ ìë™ ì••ì¶• (PDF ë“±ì€ ê·¸ëŒ€ë¡œ)
            let processedFile = file;
            if (file.type.startsWith('image/')) {
                try {
                    processedFile = await window.compressImage(file);
                    console.log(`ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
                    processedFile = file;
                }
            }
            
            const formData = new FormData();
            formData.append('file', processedFile);

            const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=team`, formData, {
                headers: { 'Content-Type': 'multipart/form-data' },
                onUploadProgress: (progressEvent) => {
                    const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                    const totalPercent = Math.round(((i + percentCompleted / 100) / files.length) * 100);
                    if (progressBar) progressBar.style.width = totalPercent + '%';
                }
            });

            if (response.data.url) {
                photoUrls.push(response.data.url);
            }
        }

        if (existingUrlsInput) {
            existingUrlsInput.value = JSON.stringify(photoUrls);
        }

        updateProjectPhotoPreview(photoUrls);

        // Auto-save
        await window.saveProject(projectCode, true);

        window.showAlert(`ì‚¬ì§„ ${files.length}ê°œê°€ ì—…ë¡œë“œë˜ê³  íŒ€(${projectName})ì— ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        window.showAlert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    } finally {
        progressDiv?.classList.add('hidden');
        if (progressBar) progressBar.style.width = '0%';
        event.target.value = '';
    }
}

// íŒ€ ì‚¬ì§„ ì‚­ì œ í•¸ë“¤ëŸ¬
window.removeProjectPhoto = async function(index) {
    const confirmed = await window.showConfirm('âš ï¸ ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ íŒŒì¼ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;

    const photoUrlsInput = document.getElementById('project-photo-urls');
    const projectCode = document.getElementById('project-code')?.value || '';
    const projectName = document.getElementById('project-name')?.value || 'ì´ë¦„ ë¯¸ì§€ì •';

    if (!photoUrlsInput) return;

    try {
        let photoUrls = JSON.parse(photoUrlsInput.value);
        photoUrls.splice(index, 1);
        photoUrlsInput.value = JSON.stringify(photoUrls);

        updateProjectPhotoPreview(photoUrls);

        // Auto-save
        await window.saveProject(projectCode, true);

        window.showAlert(`ì‚¬ì§„ì´ ì‚­ì œë˜ê³  íŒ€(${projectName})ì— ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        window.showAlert('ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

// íŒ€ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updateProjectPhotoPreview(photoUrls) {
    const previewDiv = document.getElementById('project-photos-preview');
    if (!previewDiv) return;

    if (!photoUrls || photoUrls.length === 0) {
        previewDiv.innerHTML = '<p class="text-gray-400 text-sm">ì²¨ë¶€ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }

    previewDiv.innerHTML = photoUrls.map((url, idx) => 
        window.createFilePreviewItem(url, idx, 'window.removeProjectPhoto')
    ).join('');
}

// ==================== íŒ€ í™œë™ì¼ì§€ ê´€ë¦¬ ====================
let teamActivityLogs = [];
let selectedProjectForLogs = null;

async function loadTeamActivityLogs() {
    try {
        window.showLoading('íŒ€ í™œë™ì¼ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const [projectsRes, logsRes, instructorsRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/projects`),
            axios.get(`${API_BASE_URL}/api/team-activity-logs`),
            axios.get(`${API_BASE_URL}/api/instructors`)
        ]);
        projects = projectsRes.data;
        teamActivityLogs = logsRes.data;
        instructors = instructorsRes.data;
        renderTeamActivityLogs();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('íŒ€ í™œë™ì¼ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">íŒ€ í™œë™ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderTeamActivityLogs() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-clipboard-list mr-2"></i>íŒ€ í™œë™ì¼ì§€ ê´€ë¦¬
                </h2>
                <div class="flex gap-2">
                    <button onclick="window.showTeamActivityLogForm()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>í™œë™ì¼ì§€ ì¶”ê°€
                    </button>
                    <button onclick="window.showTeamActivityLogExportOptions()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-export mr-2"></i>Excel ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button onclick="window.showTeamActivityLogExcelUpload()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-excel mr-2"></i>Excel ì—…ë¡œë“œ
                    </button>
                </div>
            </div>

            <div id="team-activity-log-excel-upload" class="hidden mb-6 p-4 bg-purple-50 rounded-lg"></div>

            <div class="mb-6">
                <label class="block text-gray-700 mb-2">íŒ€ ì„ íƒ (í•„í„°ë§)</label>
                <select id="team-select" class="w-full border rounded px-3 py-2" onchange="window.filterTeamActivityLogs()">
                    <option value="">ì „ì²´ íŒ€</option>
                    ${projects.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('')}
                </select>
            </div>
            
            <div id="team-activity-logs-list">
                <p class="text-gray-500 text-center py-8">íŒ€ì„ ì„ íƒí•˜ì—¬ í™œë™ì¼ì§€ë¥¼ ì¡°íšŒí•˜ì„¸ìš”</p>
            </div>
        </div>
    `;
    
    // ì´ˆê¸° ë¡œë”© ì‹œ ì „ì²´ íŒ€ í™œë™ì¼ì§€ í‘œì‹œ
    window.filterTeamActivityLogs();
}

// íŒ€ í™œë™ì¼ì§€ Excel ë‚´ë³´ë‚´ê¸° ì˜µì…˜
window.showTeamActivityLogExportOptions = function() {
    const projectOptions = projects.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
    window.showModal('íŒ€ í™œë™ì¼ì§€ Excel ë‚´ë³´ë‚´ê¸°', `
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2 font-medium">ë‚´ë³´ë‚¼ íŒ€ ì„ íƒ</label>
                <select id="export-team-log-project" class="w-full border rounded px-3 py-2">
                    <option value="">ì „ì²´ íŒ€</option>
                    ${projectOptions}
                </select>
            </div>
            <p class="text-sm text-gray-500"><i class="fas fa-info-circle mr-1"></i>ì„ íƒí•œ íŒ€ì˜ í™œë™ì¼ì§€ë¥¼ Excelë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="window.closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="window.exportTeamActivityLogsToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i>ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </div>
    `);
}

window.exportTeamActivityLogsToExcel = function() {
    const projectId = document.getElementById('export-team-log-project')?.value;
    let exportData = [...teamActivityLogs];
    let fileName = 'íŒ€í™œë™ì¼ì§€_ì „ì²´';

    if (projectId) {
        exportData = teamActivityLogs.filter(l => l.project_id == projectId);
        const projectName = projects.find(p => p.id == projectId)?.name || projectId;
        fileName = `íŒ€í™œë™ì¼ì§€_${projectName}`;
    }

    if (exportData.length === 0) {
        window.showAlert('ë‚´ë³´ë‚¼ í™œë™ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    exportData.sort((a, b) => (b.activity_date || '').localeCompare(a.activity_date || ''));

    const excelData = exportData.map((l, idx) => {
        const project = projects.find(p => p.id === l.project_id);
        return {
            'No': idx + 1,
            'í™œë™ì¼ì': l.activity_date || '',
            'íŒ€ëª…': project?.name || '',
            'íŒ€ì½”ë“œ': project?.code || '',
            'í™œë™ë‚´ìš©': l.content || '',
            'ì°¸ì„ì': l.attendees || '',
            'ë¹„ê³ ': l.note || ''
        };
    });

    const ws = XLSX.utils.json_to_sheet(excelData);
    ws['!cols'] = [{ wch: 5 }, { wch: 12 }, { wch: 20 }, { wch: 10 }, { wch: 50 }, { wch: 30 }, { wch: 20 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'íŒ€í™œë™ì¼ì§€');
    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(wb, `${fileName}_${today}.xlsx`);
    window.closeModal();
    window.showAlert(`${exportData.length}ê±´ì˜ í™œë™ì¼ì§€ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
}

// íŒ€í™œë™ì¼ì§€ Excel ì—…ë¡œë“œ UI
window.showTeamActivityLogExcelUpload = function() {
    const div = document.getElementById('team-activity-log-excel-upload');
    div.classList.remove('hidden');
    div.innerHTML = `
        <h3 class="text-lg font-bold mb-4">íŒ€í™œë™ì¼ì§€ Excel ì¼ê´„ ì—…ë¡œë“œ</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2">Excel íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="team-activity-log-excel-file" accept=".xlsx,.xls" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                í•„ìˆ˜ ì»¬ëŸ¼: í™œë™ì¼ì, íŒ€ì½”ë“œ ë˜ëŠ” íŒ€ëª… | ì„ íƒ: í™œë™ë‚´ìš©, ì°¸ì„ì, ë¹„ê³ 
            </p>
            <div class="space-x-2">
                <button onclick="window.uploadTeamActivityLogExcel()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-upload mr-2"></i>ì—…ë¡œë“œ
                </button>
                <button onclick="window.hideTeamActivityLogExcelUpload()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
            </div>
        </div>
    `;
}

window.hideTeamActivityLogExcelUpload = function() {
    document.getElementById('team-activity-log-excel-upload').classList.add('hidden');
}

window.uploadTeamActivityLogExcel = async function() {
    const fileInput = document.getElementById('team-activity-log-excel-file');
    const file = fileInput?.files[0];
    if (!file) { window.showAlert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning'); return; }

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (jsonData.length === 0) { window.showAlert('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning'); return; }

        let successCount = 0, failCount = 0;
        for (const row of jsonData) {
            const activityDate = row['í™œë™ì¼ì'] || row['activity_date'] || '';
            const teamCode = row['íŒ€ì½”ë“œ'] || row['team_code'] || '';
            const teamName = row['íŒ€ëª…'] || row['team_name'] || '';
            const project = teamCode ? projects.find(p => p.code === teamCode) : projects.find(p => p.name === teamName);

            if (!activityDate || !project) { failCount++; continue; }

            const logData = {
                project_id: project.id,
                activity_date: activityDate,
                content: row['í™œë™ë‚´ìš©'] || row['content'] || '',
                attendees: row['ì°¸ì„ì'] || row['attendees'] || '',
                note: row['ë¹„ê³ '] || row['note'] || ''
            };

            try {
                await axios.post(`${API_BASE_URL}/api/team-activity-logs`, logData);
                successCount++;
            } catch (e) { failCount++; }
        }

        await loadData();
        renderTeamActivityLogs();
        window.hideTeamActivityLogExcelUpload();
        window.showAlert(`ì—…ë¡œë“œ ì™„ë£Œ! ì„±ê³µ: ${successCount}ê±´, ì‹¤íŒ¨: ${failCount}ê±´`, successCount > 0 ? 'success' : 'warning');
    } catch (error) {
        console.error('Excel íŒŒì‹± ì‹¤íŒ¨:', error);
        window.showAlert('Excel íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

window.filterTeamActivityLogs = function() {
    const projectId = document.getElementById('team-select').value;

    let filteredLogs;
    if (!projectId) {
        filteredLogs = teamActivityLogs.map(log => {
            const project = projects.find(p => p.id === log.project_id);
            return { ...log, project_name: project?.name || 'íŒ€ëª… ì—†ìŒ' };
        });
        selectedProjectForLogs = null;
    } else {
        selectedProjectForLogs = parseInt(projectId);
        filteredLogs = teamActivityLogs.filter(log => log.project_id === selectedProjectForLogs);
        const project = projects.find(p => p.id === selectedProjectForLogs);
        filteredLogs = filteredLogs.map(log => ({
            ...log,
            project_name: project?.name || 'íŒ€ëª… ì—†ìŒ'
        }));
    }
    // í—¤ë” ì •ë ¬ ì ìš©
    filteredLogs = genericSort(filteredLogs, teamLogSortKey, teamLogSortAsc);
    
    const title = selectedProjectForLogs 
        ? `${filteredLogs[0]?.project_name || 'íŒ€'} í™œë™ì¼ì§€` 
        : 'ì „ì²´ íŒ€ í™œë™ì¼ì§€';
    
    document.getElementById('team-activity-logs-list').innerHTML = `
        <h3 class="text-lg font-semibold mb-4">${title} (${filteredLogs.length}ê±´)</h3>
        ${filteredLogs.length > 0 ? `
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs border">ì‚¬ì§„</th>
                            ${!selectedProjectForLogs ? sortableHeader([{ key: 'project_name', label: 'íŒ€ëª…' }], teamLogSortKey, teamLogSortAsc, 'window.sortTeamLogTable', 'px-3 py-2 text-left text-xs border') : ''}
                            ${sortableHeader([
                                { key: 'activity_date', label: 'ë‚ ì§œ' },
                                { key: 'activity_type', label: 'ìœ í˜•' },
                                { key: 'instructor_code', label: 'ì‘ì„±ì' },
                                { key: 'content', label: 'í™œë™ë‚´ìš©' },
                                { key: 'achievements', label: 'ì„±ê³¼' },
                                { key: 'next_plan', label: 'ë‹¤ìŒê³„íš' }
                            ], teamLogSortKey, teamLogSortAsc, 'window.sortTeamLogTable', 'px-3 py-2 text-left text-xs border')}
                            <th class="px-3 py-2 text-left text-xs border">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredLogs.map(log => `
                            <tr class="border-t hover:bg-gray-50">
                                <td class="px-2 py-2 text-center text-xs border">
                                    ${log.photo_urls && JSON.parse(log.photo_urls || '[]').length > 0 ? `
                                        <button onclick='window.showPhotoViewer(${JSON.stringify(log.photo_urls)}, 0)' 
                                                class="text-green-600 hover:text-green-700" 
                                                title="${JSON.parse(log.photo_urls).length}ê°œ ì‚¬ì§„">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                    ` : `
                                        <i class="fas fa-camera text-gray-300"></i>
                                    `}
                                </td>
                                ${!selectedProjectForLogs ? `<td class="px-3 py-2 text-xs border"><span class="font-semibold text-pink-600">${log.project_name}</span></td>` : ''}
                                <td class="px-3 py-2 text-xs border">${log.activity_date}</td>
                                <td class="px-3 py-2 text-xs border">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${log.activity_type || 'íŒ€ í™œë™'}</span>
                                </td>
                                <td class="px-3 py-2 text-xs border">${log.instructor_code ? (instructors.find(i => i.code === log.instructor_code)?.name || log.instructor_code) : '-'}</td>
                                <td class="px-3 py-2 text-xs border max-w-xs">
                                    <div class="truncate" title="${(log.content || '-').replace(/"/g, '&quot;')}">${log.content || '-'}</div>
                                </td>
                                <td class="px-3 py-2 text-xs border max-w-xs">
                                    <div class="truncate" title="${(log.achievements || '-').replace(/"/g, '&quot;')}">${log.achievements || '-'}</div>
                                </td>
                                <td class="px-3 py-2 text-xs border max-w-xs">
                                    <div class="truncate" title="${(log.next_plan || '-').replace(/"/g, '&quot;')}">${log.next_plan || '-'}</div>
                                </td>
                                <td class="px-3 py-2 text-xs border">
                                    <button onclick="window.editTeamActivityLog(${log.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="ìˆ˜ì •">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.deleteTeamActivityLog(${log.id})" class="text-red-600 hover:text-red-800" title="ì‚­ì œ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        ` : `
            <p class="text-gray-500 text-center py-8">ì‘ì„±ëœ í™œë™ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
        `}
    `;
}

window.showTeamActivityLogForm = function(logId = null) {
    const log = logId ? teamActivityLogs.find(l => l.id === logId) : null;
    const preselectedProjectId = log?.project_id || selectedProjectForLogs || '';
    
    const formHtml = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="team-log-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">
                    ${logId ? 'í™œë™ì¼ì§€ ìˆ˜ì •' : 'í™œë™ì¼ì§€ ì¶”ê°€'}
                </h3>
                <form id="team-log-form">
                    <input type="hidden" id="log-id" value="${logId || ''}">
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">íŒ€ ì„ íƒ *</label>
                        <select id="log-project-id" required class="w-full border rounded px-3 py-2">
                            <option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            ${projects.map(p => `<option value="${p.id}" ${p.id == preselectedProjectId ? 'selected' : ''}>${p.name} (${p.code})</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">ì‘ì„±ì *</label>
                        <select id="log-instructor-code" required class="w-full border rounded px-3 py-2">
                            <option value="">ì‘ì„±ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            ${(() => {
                                const loggedInInstructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
                                return [...instructors].sort((a, b) => a.name.localeCompare(b.name, 'ko')).map(inst => {
                                    const isCurrentUser = inst.code === loggedInInstructor.code;
                                    // í•­ìƒ ì ‘ì†ìë¥¼ ê¸°ë³¸ ì„ íƒ (ì¶”ê°€ ëª¨ë“œì™€ ìˆ˜ì • ëª¨ë“œ ëª¨ë‘)
                                    const isSelected = isCurrentUser;
                                    return `<option value="${inst.code}" ${isSelected ? 'selected' : ''}>${inst.name}-${inst.instructor_type_name || 'ê°•ì‚¬'}${isCurrentUser ? ' (ë‚˜)' : ''}</option>`;
                                }).join('');
                            })()}
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 mb-2">í™œë™ì¼ì *</label>
                            <input type="date" id="log-date" value="${log?.activity_date || (() => { const d = new Date(); return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); })()}" required class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">í™œë™ìœ í˜•</label>
                            <select id="log-type" class="w-full border rounded px-3 py-2">
                                <option value="íŒ€ í™œë™" ${log?.activity_type === 'íŒ€ í™œë™' ? 'selected' : ''}>íŒ€ í™œë™</option>
                                <option value="íšŒì˜" ${log?.activity_type === 'íšŒì˜' ? 'selected' : ''}>íšŒì˜</option>
                                <option value="í”„ë¡œì íŠ¸" ${log?.activity_type === 'í”„ë¡œì íŠ¸' ? 'selected' : ''}>í”„ë¡œì íŠ¸</option>
                                <option value="ë°œí‘œ" ${log?.activity_type === 'ë°œí‘œ' ? 'selected' : ''}>ë°œí‘œ</option>
                                <option value="ê¸°íƒ€" ${log?.activity_type === 'ê¸°íƒ€' ? 'selected' : ''}>ê¸°íƒ€</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">í™œë™ë‚´ìš© *</label>
                        <textarea id="log-content" rows="4" required class="w-full border rounded px-3 py-2">${log?.content || ''}</textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">ì„±ê³¼</label>
                        <textarea id="log-achievements" rows="3" class="w-full border rounded px-3 py-2">${log?.achievements || ''}</textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">ë‹¤ìŒê³„íš</label>
                        <textarea id="log-next-plan" rows="3" class="w-full border rounded px-3 py-2">${log?.next_plan || ''}</textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">ë¹„ê³ </label>
                        <textarea id="log-notes" rows="2" class="w-full border rounded px-3 py-2">${log?.notes || ''}</textarea>
                    </div>
                    
                    <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">
                            <i class="fas fa-paperclip mr-2"></i>ì‚¬ì§„ ë° íŒŒì¼ ì²¨ë¶€ (ê·¸ë¦¼íŒŒì¼, PDF, HWP, PPT, Excel, Word, TXT ë“±)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button type="button" onclick="document.getElementById('team-log-file-input').click()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                                </button>
                                <button type="button" onclick="document.getElementById('team-log-camera-input').click()" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-camera mr-2"></i>ì‚¬ì§„ ì´¬ì˜
                                </button>
                            </div>
                            <div id="team-log-upload-progress" class="hidden mb-3">
                                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                    <p class="text-sm text-blue-800 mb-2">
                                        <i class="fas fa-cloud-upload-alt mr-2"></i>
                                        ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                                    </p>
                                    <div class="w-full bg-blue-200 rounded-full h-2">
                                        <div id="team-log-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="team-log-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                                   onchange="window.handleTeamLogImageUpload(event)" class="hidden">
                            <input type="file" id="team-log-camera-input" accept="image/*" 
                                   onchange="window.handleTeamLogImageUpload(event)" class="hidden">
                            <div id="team-log-photos-preview" class="flex flex-col gap-2 mt-2">
                                ${log?.photo_urls ? JSON.parse(log.photo_urls).map((url, idx) => `
                                    <div class="relative group">
                                        <img src="${url}" class="w-full h-24 object-cover rounded border">
                                        <button type="button" onclick="window.removeTeamLogPhoto(${idx})" 
                                                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                            <i class="fas fa-times text-xs"></i>
                                        </button>
                                    </div>
                                `).join('') : ''}
                            </div>
                            <input type="hidden" id="team-log-photo-urls" value='${log?.photo_urls || "[]"}'>
                            <p class="text-sm text-gray-500 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                ìµœëŒ€ 10MB, JPG/PNG/GIF í˜•ì‹
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="window.closeTeamActivityLogForm()" class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg">
                            ì·¨ì†Œ
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-save mr-2"></i>ì €ì¥
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', formHtml);
    
    document.getElementById('team-log-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await window.saveTeamActivityLog();
    });
}

window.closeTeamActivityLogForm = function() {
    const modal = document.getElementById('team-log-modal');
    if (modal) modal.remove();
}

window.saveTeamActivityLog = async function() {
    console.log('ğŸ’¾ saveTeamActivityLog í•¨ìˆ˜ í˜¸ì¶œë¨');
    
    try {
        const logId = document.getElementById('log-id')?.value;
        const projectId = document.getElementById('log-project-id')?.value;
        
        console.log('ğŸ“ íŒ€ í™œë™ì¼ì§€ ì €ì¥ ì‹œì‘:', { logId, projectId });
        
        if (!document.getElementById('log-project-id')) {
            console.error('âŒ log-project-id ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            window.showAlert('í¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // íŒ€ ì„ íƒ í•„ìˆ˜ ê²€ì¦
        if (!projectId) {
            window.showAlert('íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
            return;
        }
        
        const instructorCode = document.getElementById('log-instructor-code').value;
        
        console.log('ì‘ì„±ì ì½”ë“œ:', instructorCode);
        
        // ì‘ì„±ì ì„ íƒ í•„ìˆ˜ ê²€ì¦
        if (!instructorCode) {
            window.showAlert('ì‘ì„±ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
            return;
        }
        
        const content = document.getElementById('log-content').value;
        
        // í™œë™ë‚´ìš© í•„ìˆ˜ ê²€ì¦
        if (!content || content.trim() === '') {
            window.showAlert('í™œë™ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }
        
        // ì €ì¥ ì „ í˜„ì¬ ì„ íƒëœ íŒ€ í•„í„° ê°’ì„ ì €ì¥
        const currentTeamFilter = document.getElementById('team-select')?.value || '';
        console.log('ğŸ’¡ í˜„ì¬ íŒ€ í•„í„°:', currentTeamFilter);
        
        const data = {
            project_id: parseInt(projectId),
            instructor_code: instructorCode,
            activity_date: document.getElementById('log-date').value,
            activity_type: document.getElementById('log-type').value,
            content: document.getElementById('log-content').value,
            achievements: document.getElementById('log-achievements').value,
            next_plan: document.getElementById('log-next-plan').value,
            notes: document.getElementById('log-notes').value,
            photo_urls: document.getElementById('team-log-photo-urls').value
        };
        
        console.log('ì €ì¥ ë°ì´í„°:', data);
        
        if (logId) {
            console.log('ìˆ˜ì • ìš”ì²­ ì‹œì‘...');
            await axios.put(`${API_BASE_URL}/api/team-activity-logs/${logId}`, data);
        } else {
            console.log('ì¶”ê°€ ìš”ì²­ ì‹œì‘...');
            const response = await axios.post(`${API_BASE_URL}/api/team-activity-logs`, data);
            console.log('ì¶”ê°€ ì‘ë‹µ:', response.data);
        }
        
        // ì„±ê³µ ë©”ì‹œì§€ë¥¼ ë¨¼ì € í‘œì‹œ
        window.showAlert(logId ? 'í™œë™ì¼ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'í™œë™ì¼ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        
        // ëª¨ë‹¬ ë‹«ê³  ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        window.closeTeamActivityLogForm();
        await loadTeamActivityLogs();
        
        // ì´ì „ì— ì„ íƒí–ˆë˜ íŒ€ í•„í„° ê°’ìœ¼ë¡œ ë³µì› (DOMì´ ë‹¤ì‹œ ë Œë”ë§ëœ í›„)
        setTimeout(() => {
            const teamSelect = document.getElementById('team-select');
            if (teamSelect) {
                teamSelect.value = currentTeamFilter;
                window.filterTeamActivityLogs();
                console.log('âœ… íŒ€ í•„í„° ë³µì›ë¨:', currentTeamFilter);
            }
        }, 100);
    } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨ - ì „ì²´ ì—ëŸ¬:', error);
        console.error('ì €ì¥ ì‹¤íŒ¨ - ì‘ë‹µ:', error.response);
        console.error('ì €ì¥ ì‹¤íŒ¨ - ì‘ë‹µ ë°ì´í„°:', error.response?.data);
        window.showAlert('ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

window.editTeamActivityLog = function(logId) {
    const log = teamActivityLogs.find(l => l.id === logId);
    if (log) {
        selectedProjectForLogs = log.project_id;
        window.showTeamActivityLogForm(logId);
        setTimeout(() => window.scrollToForm('team-activity-log-form'), 100);
    }
}

window.deleteTeamActivityLog = async function(logId) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const confirmed = await window.showConfirm('âš ï¸ ì´ í™œë™ì¼ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/team-activity-logs/${logId}`);
        window.showAlert('âœ… í™œë™ì¼ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        await loadTeamActivityLogs();
        if (selectedProjectForLogs) {
            document.getElementById('team-select').value = selectedProjectForLogs;
            window.filterTeamActivityLogs();
        }
    } catch (error) {
        console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// íŒ€ í™œë™ì¼ì§€ ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬
window.handleTeamLogImageUpload = async function(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // íŒŒì¼ ê²€ì¦
    for (let file of files) {
        const validation = window.validateFile(file);
        if (!validation.valid) {
            window.showAlert(validation.message);
            event.target.value = '';
            return;
        }
    }
    
    const progressDiv = document.getElementById('team-log-upload-progress');
    const progressBar = document.getElementById('team-log-progress-bar');
    progressDiv.classList.remove('hidden');
    
    try {
        const currentPhotos = JSON.parse(document.getElementById('team-log-photo-urls').value || '[]');
        let uploadedCount = 0;
        
        for (let file of files) {
            // ì´ë¯¸ì§€ ì••ì¶• (PDFì™€ ë¬¸ì„œ íŒŒì¼ì€ ì••ì¶• ì•ˆ í•¨)
            const compressedFile = await window.compressImage(file);
            
            const formData = new FormData();
            formData.append('file', compressedFile);
            
            const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=team-log`, formData, {
                headers: { 'Content-Type': 'multipart/form-data' },
                onUploadProgress: (e) => {
                    const percent = Math.round((e.loaded * 100) / e.total);
                    progressBar.style.width = percent + '%';
                }
            });
            
            if (response.data.success) {
                // URLê³¼ ì›ë³¸ íŒŒì¼ëª…ì„ í•¨ê»˜ ì €ì¥ (URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹)
                const urlWithOriginalName = response.data.original_filename 
                    ? `${response.data.url}#${encodeURIComponent(response.data.original_filename)}`
                    : response.data.url;
                currentPhotos.push(urlWithOriginalName);
                uploadedCount++;
            }
        }
        
        document.getElementById('team-log-photo-urls').value = JSON.stringify(currentPhotos);
        renderTeamLogPhotos();
        
        progressDiv.classList.add('hidden');
        progressBar.style.width = '0%';
        
        if (uploadedCount > 0) {
            window.showAlert(`${uploadedCount}ê°œ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤`);
        }
    } catch (error) {
        progressDiv.classList.add('hidden');
        console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
    
    event.target.value = '';
}

window.removeTeamLogPhoto = function(index) {
    const photos = JSON.parse(document.getElementById('team-log-photo-urls').value || '[]');
    photos.splice(index, 1);
    document.getElementById('team-log-photo-urls').value = JSON.stringify(photos);
    renderTeamLogPhotos();
}

function renderTeamLogPhotos() {
    const photos = JSON.parse(document.getElementById('team-log-photo-urls').value || '[]');
    const previewDiv = document.getElementById('team-log-photos-preview');
    
    previewDiv.innerHTML = photos.map((url, idx) => 
        window.createFilePreviewItem(url, idx, 'window.removeTeamLogPhoto')
    ).join('');
}

// ==================== ì‹œê°„í‘œ ê´€ë¦¬ ====================
let timetables = [];
let filteredTimetables = []; // í•„í„°ë§ëœ ì‹œê°„í‘œ ì €ì¥

// ì‹œê°„í‘œ í˜ì´ì§€ ë³€ê²½
window.changeTimetablePage = function(page) {
    pagination.timetables.currentPage = page;
    renderTimetableList();
};

// ì‹œê°„í‘œ í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜ ë³€ê²½
window.changeTimetableItemsPerPage = function(event) {
    pagination.timetables.itemsPerPage = parseInt(event.target.value);
    pagination.timetables.currentPage = 1;
    renderTimetableList();
};

// ì‹œê°„í‘œ ëª©ë¡ë§Œ ë‹¤ì‹œ ë Œë”ë§
function renderTimetableList() {
    const { currentPage, itemsPerPage } = pagination.timetables;
    const paginatedData = paginateArray(filteredTimetables, currentPage, itemsPerPage);
    
    const tbody = document.querySelector('#timetable-list tbody');
    if (filteredTimetables.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-search mr-2"></i>
                    í•„í„° ì¡°ê±´ì— ë§ëŠ” ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        document.getElementById('timetable-pagination').innerHTML = '';
        return;
    }
    
    // ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚° (ë¡œì»¬ ì‹œê°„ ê¸°ì¤€)
    const now = new Date();
    const today = now.getFullYear() + '-' + 
                  String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                  String(now.getDate()).padStart(2, '0');
    
    // ë‚ ì§œìˆœ ì •ë ¬ëœ ì‹œê°„í‘œë¡œ ê³¼ëª©ë³„ ì´ ì‹œìˆ˜ ê³„ì‚°
    const sortedTimetables = [...filteredTimetables].sort((a, b) => {
        if (a.class_date !== b.class_date) return a.class_date.localeCompare(b.class_date);
        return (a.start_time || '').localeCompare(b.start_time || '');
    });
    
    // subject_code ì—†ìœ¼ë©´ typeìœ¼ë¡œ êµ¬ë¶„ (í”„ë¡œì íŠ¸/í˜„ì¥ì‹¤ìŠµ ë¶„ë¦¬)
    const getGroupKey = (t) => t.subject_code || ('__type__' + t.type);
    const subjectHoursMap = {};
    sortedTimetables.forEach((t) => {
        const key = getGroupKey(t);
        if (!subjectHoursMap[key]) {
            subjectHoursMap[key] = 0;
        }
        const dur = calculateDuration(t.start_time, t.end_time);
        subjectHoursMap[key] += dur;
    });

    tbody.innerHTML = paginatedData.map((tt, index) => {
        const duration = calculateDuration(tt.start_time, tt.end_time);
        const isToday = tt.class_date === today;

        // ìš”ì¼ ê³„ì‚° ë¡œì§
        let dayOfWeek = '';
        if (tt.class_date) {
            try {
                const [y, m, d] = tt.class_date.split('-').map(Number);
                const dateObj = new Date(y, m - 1, d);
                const dayIndex = dateObj.getDay();
                const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                dayOfWeek = dayNames[dayIndex];
            } catch (err) {
                console.error('[ìš”ì¼ê³„ì‚° ì˜¤ë¥˜ renderTimetableList]', tt.class_date, err);
            }
        }

        // ëˆ„ì ì‹œìˆ˜ ê³„ì‚° (í”„ë¡œì íŠ¸/í˜„ì¥ì‹¤ìŠµ ë³„ë„ ëˆ„ì )
        const ttKey = getGroupKey(tt);
        let accumulatedHours = 0;
        for (let i = 0; i < sortedTimetables.length; i++) {
            if (getGroupKey(sortedTimetables[i]) === ttKey) {
                accumulatedHours += calculateDuration(sortedTimetables[i].start_time, sortedTimetables[i].end_time);
            }
            if (sortedTimetables[i].id === tt.id) break;
        }

        const totalHours = subjectHoursMap[ttKey] || 0;
        const isCompleted = accumulatedHours >= totalHours && totalHours > 0;
        
        // ê³¼ëª©ëª… í‘œì‹œ: í”„ë¡œì íŠ¸/í˜„ì¥ì‹¤ìŠµì¼ ë•ŒëŠ” íƒ€ì…ëª… ì‚¬ìš©
        const displaySubject = tt.type === 'project' ? 'í”„ë¡œì íŠ¸' : 
                               tt.type === 'practice' ? 'í˜„ì¥ì‹¤ìŠµ' : 
                               (tt.subject_name || tt.subject_code || '-');
        
        return `
        <tr class="border-t hover:bg-gray-50 ${isToday ? 'bg-yellow-100 border-l-4 border-yellow-500' : ''}" ${isToday ? 'id="today-timetable-row"' : ''}>
            <td class="px-3 py-2 text-xs ${isToday ? 'font-bold text-yellow-900' : ''}">${tt.class_date}${dayOfWeek ? ' (' + dayOfWeek + ')' : ''}${isToday ? ' <span class="text-yellow-600">(ì˜¤ëŠ˜)</span>' : ''}</td>
            <td class="px-3 py-2 text-xs">${tt.week_number || '-'}ì£¼ì°¨</td>
            <td class="px-3 py-2 text-xs">${tt.day_number || '-'}ì¼ì°¨</td>
            <td class="px-3 py-2 text-xs">${displaySubject}</td>
            <td class="px-3 py-2 text-xs">${tt.instructor_name || tt.instructor_code || '-'}</td>
            <td class="px-3 py-2 text-xs">${formatTime(tt.start_time)} - ${formatTime(tt.end_time)}</td>
            <td class="px-3 py-2 text-xs font-semibold">${Math.round(duration)}h</td>
            <td class="px-3 py-2 text-xs ${isCompleted ? 'text-green-600 font-semibold' : 'text-blue-600'}">${Math.round(accumulatedHours)}/${Math.round(totalHours)}</td>
            <td class="px-3 py-2 text-xs">
                <span class="text-xs ${tt.type === 'lecture' ? 'bg-blue-100 text-blue-800' : tt.type === 'project' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} px-2 py-1 rounded">
                    ${tt.type}
                </span>
            </td>
            <td class="px-3 py-2 text-xs">
                ${tt.training_log_id ? `
                    <a href="#" onclick="showTab('training-logs'); return false;" class="text-green-600">
                        <i class="fas fa-check-circle"></i> ì‘ì„±ë¨
                    </a>
                ` : '<span class="text-gray-400">-</span>'}
            </td>
            <td class="px-3 py-2 text-xs">
                <button onclick="window.editTimetable(${tt.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="window.deleteTimetable(${tt.id})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
        `;
    }).join('');
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    const paginationHTML = createPaginationHTML(
        currentPage,
        itemsPerPage,
        filteredTimetables.length,
        'window.changeTimetablePage',
        'window.changeTimetableItemsPerPage(event)'
    );
    document.getElementById('timetable-pagination').innerHTML = paginationHTML;
    
    // ì˜¤ëŠ˜ ë‚ ì§œ í–‰ìœ¼ë¡œ ìë™ ìŠ¤í¬ë¡¤
    setTimeout(() => {
        const todayRow = document.getElementById('today-timetable-row');
        if (todayRow) {
            todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100);
}

async function loadTimetables() {
    try {
        window.showLoading('ì‹œê°„í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        // ê³¼ì •, ê³¼ëª©, ê°•ì‚¬ ëª©ë¡ë„ í•¨ê»˜ ë¡œë“œ
        const [ttRes, coursesRes, subjectsRes, instructorsRes, instructorTypesRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/timetables`),
            axios.get(`${API_BASE_URL}/api/courses`),
            axios.get(`${API_BASE_URL}/api/subjects`),
            axios.get(`${API_BASE_URL}/api/instructors`),
            axios.get(`${API_BASE_URL}/api/instructor-codes`)
        ]);
        timetables = ttRes.data;
        courses = coursesRes.data;
        subjects = subjectsRes.data;
        instructors = instructorsRes.data;
        instructorTypes = instructorTypesRes.data;
        renderTimetables();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('ì‹œê°„í‘œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ì‹œê°„í‘œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderTimetables() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-clock mr-2"></i>ì‹œê°„í‘œ ê´€ë¦¬ (ì´ ${timetables.length}ê±´)
                </h2>
                <div class="flex gap-2">
                    <button onclick="window.showTimetableForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>ì‹œê°„í‘œ ì¶”ê°€
                    </button>
                    <button onclick="window.showTimetableExportOptions()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-export mr-2"></i>Excel ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button onclick="window.showTimetableExcelUpload()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-file-excel mr-2"></i>Excel ì—…ë¡œë“œ
                    </button>
                </div>
            </div>

            <div id="timetable-excel-upload" class="hidden mb-6 p-4 bg-purple-50 rounded-lg"></div>

            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <p class="text-blue-700">
                    <i class="fas fa-info-circle mr-2"></i>
                    ê³¼ì •, ì›”, ê°•ì‚¬, ê³¼ëª©ë³„ë¡œ ì‹œê°„í‘œë¥¼ í•„í„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 mb-2">ê³¼ì • ì„ íƒ</label>
                    <select id="tt-course" class="w-full border rounded px-3 py-2" onchange="window.filterTimetables()">
                        <option value="">-- ì „ì²´ ê³¼ì • --</option>
                        ${courses.map(c => `<option value="${c.code}">${c.name} (${c.code})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">íƒ€ì…</label>
                    <select id="tt-type" class="w-full border rounded px-3 py-2" onchange="window.filterTimetables()">
                        <option value="">ì „ì²´</option>
                        <option value="lecture">êµê³¼</option>
                        <option value="project">í”„ë¡œì íŠ¸</option>
                        <option value="practice">í˜„ì¥ì‹¤ìŠµ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ì›”ë³„ ì„ íƒ</label>
                    <input type="month" id="tt-month" class="w-full border rounded px-3 py-2" onchange="window.filterTimetables()">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê°•ì‚¬ ì„ íƒ</label>
                    <select id="tt-instructor" class="w-full border rounded px-3 py-2" onchange="window.filterTimetables()">
                        <option value="">-- ì „ì²´ ê°•ì‚¬ --</option>
                        ${instructors.map(i => `<option value="${i.code}">${i.name} (${i.code})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê³¼ëª© ì„ íƒ</label>
                    <select id="tt-subject" class="w-full border rounded px-3 py-2" onchange="window.filterTimetables()">
                        <option value="">-- ì „ì²´ ê³¼ëª© --</option>
                        <option value="PROJECT">í”„ë¡œì íŠ¸ (PROJECT)</option>
                        <option value="WORKSHIP">í˜„ì¥ì‹¤ìŠµ (WORKSHIP)</option>
                        ${subjects.map(s => `<option value="${s.code}">${s.name} (${s.code})</option>`).join('')}
                    </select>
                </div>
            </div>
            
            <div id="timetable-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg"></div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white" id="timetable-list">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs">ë‚ ì§œ(ìš”ì¼)</th>
                            <th class="px-3 py-2 text-left text-xs">ì£¼ì°¨</th>
                            <th class="px-3 py-2 text-left text-xs">ì¼ì°¨</th>
                            <th class="px-3 py-2 text-left text-xs">ê³¼ëª©</th>
                            <th class="px-3 py-2 text-left text-xs">ê°•ì‚¬</th>
                            <th class="px-3 py-2 text-left text-xs">ì‹œê°„</th>
                            <th class="px-3 py-2 text-left text-xs">ì‹œìˆ˜</th>
                            <th class="px-3 py-2 text-left text-xs">ëˆ„ì ì‹œìˆ˜</th>
                            <th class="px-3 py-2 text-left text-xs">íƒ€ì…</th>
                            <th class="px-3 py-2 text-left text-xs">í›ˆë ¨ì¼ì§€</th>
                            <th class="px-3 py-2 text-left text-xs">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${timetables.length === 0 ? `
                            <tr>
                                <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                    ê³¼ì •ì„ ì„ íƒí•˜ì—¬ ì‹œê°„í‘œë¥¼ ì¡°íšŒí•˜ì„¸ìš”
                                </td>
                            </tr>
                        ` : (() => {
                            // ê³¼ëª©ë³„ ì´ ì‹œìˆ˜ ê³„ì‚° (subject_code ì—†ìœ¼ë©´ typeìœ¼ë¡œ êµ¬ë¶„)
                            const subjectHoursMap = {};
                            const getGroupKey = (t) => t.subject_code || ('__type__' + t.type);
                            timetables.forEach((t) => {
                                const key = getGroupKey(t);
                                if (!subjectHoursMap[key]) {
                                    subjectHoursMap[key] = 0;
                                }
                                const duration = calculateDuration(t.start_time, t.end_time);
                                subjectHoursMap[key] += duration;
                            });
                            
                            return timetables.slice(0, 100).map((tt, index) => {
                                // ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚° (ë¡œì»¬ ì‹œê°„ ê¸°ì¤€)
                                const now = new Date();
                                const today = now.getFullYear() + '-' + 
                                              String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                                              String(now.getDate()).padStart(2, '0');
                                const isToday = tt.class_date === today;
                                
                                // í•´ë‹¹ì¼ ì‹œìˆ˜ ê³„ì‚° (ì‹œê°„ ì°¨ì´)
                                const dailyHours = calculateDuration(tt.start_time, tt.end_time);
                                
                                // ëˆ„ì ì‹œìˆ˜ ê³„ì‚° (í˜„ì¬ê¹Œì§€ ì§„í–‰ëœ ì‹œìˆ˜, í”„ë¡œì íŠ¸/í˜„ì¥ì‹¤ìŠµ ë³„ë„)
                                let accumulatedHours = 0;
                                const ttKey = getGroupKey(tt);
                                for (let i = 0; i <= index; i++) {
                                    if (getGroupKey(timetables[i]) === ttKey) {
                                        accumulatedHours += calculateDuration(timetables[i].start_time, timetables[i].end_time);
                                    }
                                }
                                const subjectTotalHours = subjectHoursMap[ttKey] || 0;
                                
                                // ë””ë²„ê¹…: ì²˜ìŒ 3ê°œ í•­ëª©ë§Œ ë¡œê·¸
                                if (index < 3) {
                                    console.log(`[ì‹œê°„í‘œ ${index}] subject_code: ${tt.subject_code}, subject_name: ${tt.subject_name}`);
                                    console.log(`  dailyHours: ${dailyHours}, accumulatedHours: ${accumulatedHours}, subjectTotalHours: ${subjectTotalHours}`);
                                    console.log(`  start_time: ${tt.start_time}, end_time: ${tt.end_time}`);
                                }
                                
                                // ì§„í–‰ë¥  ê³„ì‚°
                                const progressPercent = subjectTotalHours > 0 ? Math.round((accumulatedHours / subjectTotalHours) * 100) : 0;
                                const isCompleted = accumulatedHours >= subjectTotalHours && subjectTotalHours > 0;
                            
                            // ìš”ì¼ ê³„ì‚° (ë¡œì»¬ ì‹œê°„ ê¸°ì¤€)
                            const dateStr = tt.class_date || '';
                            let dayOfWeek = '';
                            if (dateStr) {
                                try {
                                    // YYYY-MM-DD í˜•ì‹ì„ ì§ì ‘ íŒŒì‹±í•˜ì—¬ ë¡œì»¬ ë‚ ì§œ ìƒì„±
                                    const [year, month, day] = dateStr.split('-').map(Number);
                                    const classDate = new Date(year, month - 1, day);
                                    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                                    dayOfWeek = dayNames[classDate.getDay()];
                                    
                                    // ë””ë²„ê¹…: ì²« 3ê°œë§Œ ë¡œê·¸
                                    if (index < 3) {
                                        console.log(`[ìš”ì¼ê³„ì‚° ${index}] date: ${dateStr}, dayOfWeek: ${dayOfWeek}`);
                                    }
                                } catch (e) {
                                    console.error('ìš”ì¼ ê³„ì‚° ì˜¤ë¥˜:', e, dateStr);
                                }
                            }
                            
                            // ê³¼ëª©ëª… í‘œì‹œ: í”„ë¡œì íŠ¸/í˜„ì¥ì‹¤ìŠµì¼ ë•ŒëŠ” íƒ€ì…ëª… ì‚¬ìš©
                            const displaySubject = tt.type === 'project' ? 'í”„ë¡œì íŠ¸' : 
                                                   tt.type === 'practice' ? 'í˜„ì¥ì‹¤ìŠµ' : 
                                                   (tt.subject_name || tt.subject_code || '-');
                            
                            return `
                            <tr class="border-t hover:bg-gray-50 ${isToday ? 'bg-yellow-100 border-l-4 border-yellow-500' : ''}" ${isToday ? 'id="today-timetable-row"' : ''}>
                                <td class="px-3 py-2 text-xs ${isToday ? 'font-bold text-yellow-900' : ''}">${tt.class_date} (${dayOfWeek})${isToday ? ' <span class="text-yellow-600">(ì˜¤ëŠ˜)</span>' : ''}</td>
                                <td class="px-3 py-2 text-xs">${tt.week_number || '-'}ì£¼ì°¨</td>
                                <td class="px-3 py-2 text-xs">${tt.day_number || '-'}ì¼ì°¸</td>
                                <td class="px-3 py-2 text-xs">${displaySubject}</td>
                                <td class="px-3 py-2 text-xs">${tt.instructor_name || tt.instructor_code || '-'}</td>
                                <td class="px-3 py-2 text-xs">${formatTime(tt.start_time)} - ${formatTime(tt.end_time)}</td>
                                <td class="px-3 py-2 text-xs font-semibold">${Math.round(dailyHours)}h</td>
                                <td class="px-3 py-2 text-xs ${isCompleted ? 'text-green-600 font-semibold' : 'text-blue-600'}" data-accumulated="${Math.round(accumulatedHours)}" data-total="${Math.round(subjectTotalHours)}">
                                    ${Math.round(accumulatedHours)}/${Math.round(subjectTotalHours)}
                                </td>
                                <td class="px-3 py-2 text-xs">
                                    <span class="px-2 py-1 rounded text-xs ${tt.type === 'lecture' ? 'bg-blue-100 text-blue-800' : tt.type === 'project' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${tt.type}
                                    </span>
                                </td>
                                <td class="px-3 py-2 text-xs">
                                    ${tt.training_log_id ? `
                                        <span class="text-green-600">
                                            <i class="fas fa-check-circle"></i> ì™„ë£Œ
                                        </span>
                                    ` : `
                                        <span class="text-gray-400">
                                            <i class="fas fa-times-circle"></i> ë¯¸ì‘ì„±
                                        </span>
                                    `}
                                </td>
                                <td class="px-3 py-2 text-xs">
                                    <button onclick="window.editTimetable(${tt.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="ìˆ˜ì •">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.deleteTimetable(${tt.id})" class="text-red-600 hover:text-red-800" title="ì‚­ì œ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                            }).join('');
                        })()}
                        ${timetables.length > 100 ? `<tr><td colspan="9" class="px-4 py-2 text-center text-gray-500">ì²˜ìŒ 100ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤ (ì „ì²´: ${timetables.length})</td></tr>` : ''}
                    </tbody>
                </table>
            </div>
            
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div id="timetable-pagination"></div>
        </div>
    `;
    
    // ì´ˆê¸° í•„í„°ë§ëœ ë°ì´í„° ì„¤ì • (ê¸°ë³¸ ê³¼ì •: C-001)
    const courseSelect = document.getElementById('tt-course');
    if (courseSelect && courses.length > 0) {
        // C-001ì´ ìˆìœ¼ë©´ ì„ íƒ, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ê³¼ì • ì„ íƒ
        const defaultCourse = courses.find(c => c.code === 'C-001');
        courseSelect.value = defaultCourse ? 'C-001' : courses[0].code;
    }
    
    // í•„í„° ì ìš©
    window.filterTimetables();
    
    // ì˜¤ëŠ˜ ë‚ ì§œ í–‰ìœ¼ë¡œ ìë™ ìŠ¤í¬ë¡¤
    setTimeout(() => {
        const todayRow = document.getElementById('today-timetable-row');
        if (todayRow) {
            todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100);
}

function formatTime(timeValue) {
    if (!timeValue) return '-';
    
    // ë¬¸ìì—´ì¸ ê²½ìš° (HH:MM:SS í˜•ì‹)
    if (typeof timeValue === 'string') {
        // HH:MM:SSì—ì„œ HH:MMë§Œ ì¶”ì¶œ
        return timeValue.substring(0, 5);
    }
    
    // ìˆ«ìì¸ ê²½ìš° (ì´ˆ ë‹¨ìœ„)
    const hours = Math.floor(timeValue / 3600);
    const minutes = Math.floor((timeValue % 3600) / 60);
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

function timeToSeconds(timeStr) {
    if (!timeStr) return 0;
    const parts = timeStr.split(':');
    const hours = parseInt(parts[0]) || 0;
    const minutes = parseInt(parts[1]) || 0;
    return hours * 3600 + minutes * 60;
}

function calculateDuration(startTime, endTime) {
    // startTimeê³¼ endTimeì´ ë¬¸ìì—´(HH:MM:SS ë˜ëŠ” HH:MM)ì¸ ê²½ìš°
    if (typeof startTime === 'string' && typeof endTime === 'string') {
        const startSeconds = timeToSeconds(startTime);
        const endSeconds = timeToSeconds(endTime);
        const durationSeconds = endSeconds - startSeconds;
        return Math.round(durationSeconds / 3600 * 10) / 10; // ì†Œìˆ˜ì  1ìë¦¬ (ì˜ˆ: 2.5ì‹œê°„)
    }
    
    // startTimeê³¼ endTimeì´ ìˆ«ì(ì´ˆ)ì¸ ê²½ìš°
    if (typeof startTime === 'number' && typeof endTime === 'number') {
        const durationSeconds = endTime - startTime;
        return Math.round(durationSeconds / 3600 * 10) / 10;
    }
    
    return 0;
}

// ë‚ ì§œì— ìš”ì¼ ì¶”ê°€í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function formatDateWithDay(dateStr) {
    if (!dateStr) return '-';
    
    // ì´ë¯¸ 00.00.00 í˜•ì‹ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
    if (/^\d{2}\.\d{2}\.\d{2}$/.test(dateStr)) {
        return dateStr;
    }
    
    // YYYY-MM-DD í˜•ì‹ì¸ ê²½ìš° 00.00.00ìœ¼ë¡œ ë³€í™˜
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        const parts = dateStr.split('-');
        return `${parts[0].substring(2)}.${parts[1]}.${parts[2]}`;
    }
    
    // ê·¸ ì™¸ì˜ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
    return dateStr;
}

// ìƒë…„ì›”ì¼ì„ í‘œì¤€ í˜•ì‹(YYYY-MM-DD)ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function normalizeBirthDate(dateStr) {
    if (!dateStr) return null;
    
    // ì´ë¯¸ YYYY-MM-DD í˜•ì‹ì¸ ê²½ìš°
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        return dateStr;
    }
    
    // 00.00.00 í˜•ì‹ì¸ ê²½ìš° 20YY-MM-DDë¡œ ë³€í™˜
    if (/^\d{2}\.\d{2}\.\d{2}$/.test(dateStr)) {
        const parts = dateStr.split('.');
        const year = parseInt(parts[0]);
        const fullYear = year >= 0 && year <= 30 ? `20${parts[0]}` : `19${parts[0]}`;
        return `${fullYear}-${parts[1]}-${parts[2]}`;
    }
    
    return dateStr;
}

// ì „í™”ë²ˆí˜¸ë¥¼ í‘œì¤€ í˜•ì‹(010-0000-0000)ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function normalizePhone(phone) {
    if (!phone) return null;
    
    // ìˆ«ìë§Œ ì¶”ì¶œ
    const numbers = phone.replace(/[^0-9]/g, '');
    
    // 010-0000-0000 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    if (numbers.length === 11 && numbers.startsWith('010')) {
        return `${numbers.substring(0, 3)}-${numbers.substring(3, 7)}-${numbers.substring(7)}`;
    } else if (numbers.length === 10) {
        return `${numbers.substring(0, 3)}-${numbers.substring(3, 6)}-${numbers.substring(6)}`;
    }
    
    return phone;
}

window.filterTimetables = function() {
    const courseCode = document.getElementById('tt-course').value;
    const type = document.getElementById('tt-type').value;
    const month = document.getElementById('tt-month').value; // YYYY-MM í˜•ì‹
    const instructorCode = document.getElementById('tt-instructor').value;
    const subjectCode = document.getElementById('tt-subject').value;
    
    // ëª¨ë“  ì‹œê°„í‘œì—ì„œ í•„í„°ë§
    filteredTimetables = timetables.filter(tt => {
        // ê³¼ì • í•„í„°
        if (courseCode && tt.course_code !== courseCode) {
            return false;
        }
        
        // íƒ€ì… í•„í„°
        if (type && tt.type !== type) {
            return false;
        }
        
        // ì›”ë³„ í•„í„° (YYYY-MM í˜•ì‹)
        if (month && tt.class_date) {
            const ttMonth = tt.class_date.substring(0, 7); // "2025-01-15" -> "2025-01"
            if (ttMonth !== month) {
                return false;
            }
        }
        
        // ê°•ì‚¬ í•„í„°
        if (instructorCode && tt.instructor_code !== instructorCode) {
            return false;
        }
        
        // ê³¼ëª© í•„í„°
        if (subjectCode && tt.subject_code !== subjectCode) {
            return false;
        }
        
        return true;
    });
    
    pagination.timetables.totalItems = filteredTimetables.length;
    
    // ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
    const now = new Date();
    const today = now.getFullYear() + '-' + 
                  String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                  String(now.getDate()).padStart(2, '0');
    
    // ì˜¤ëŠ˜ ë‚ ì§œê°€ í¬í•¨ëœ í˜ì´ì§€ ì°¾ê¸°
    const todayIndex = filteredTimetables.findIndex(tt => tt.class_date === today);
    if (todayIndex !== -1) {
        // ì˜¤ëŠ˜ ë‚ ì§œê°€ ìˆëŠ” í˜ì´ì§€ë¡œ ì´ë™
        const itemsPerPage = pagination.timetables.itemsPerPage;
        const todayPage = Math.floor(todayIndex / itemsPerPage) + 1;
        pagination.timetables.currentPage = todayPage;
    } else {
        // ì˜¤ëŠ˜ ë‚ ì§œê°€ ì—†ìœ¼ë©´ ì²« í˜ì´ì§€
        pagination.timetables.currentPage = 1;
    }
    
    renderTimetableList();
    
    // ì˜¤ëŠ˜ ë‚ ì§œ í–‰ìœ¼ë¡œ ìë™ ìŠ¤í¬ë¡¤
    setTimeout(() => {
        const todayRow = document.getElementById('today-timetable-row');
        if (todayRow) {
            todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100);
}

// ì‹œê°„í‘œ Excel ë‚´ë³´ë‚´ê¸° ì˜µì…˜
window.showTimetableExportOptions = function() {
    const courseOptions = courses.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
    window.showModal('ì‹œê°„í‘œ Excel ë‚´ë³´ë‚´ê¸°', `
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2 font-medium">ë‚´ë³´ë‚¼ ê³¼ì • ì„ íƒ</label>
                <select id="export-timetable-course" class="w-full border rounded px-3 py-2">
                    <option value="">ì „ì²´ ê³¼ì •</option>
                    ${courseOptions}
                </select>
            </div>
            <p class="text-sm text-gray-500"><i class="fas fa-info-circle mr-1"></i>ì„ íƒí•œ ê³¼ì •ì˜ ì‹œê°„í‘œë¥¼ Excelë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="window.closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="window.exportTimetablesToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i>ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </div>
    `);
}

window.exportTimetablesToExcel = function() {
    const courseCode = document.getElementById('export-timetable-course')?.value;
    let exportData = [...timetables];
    let fileName = 'ì‹œê°„í‘œ_ì „ì²´';

    if (courseCode) {
        exportData = timetables.filter(t => t.course_code === courseCode);
        const courseName = courses.find(c => c.code === courseCode)?.name || courseCode;
        fileName = `ì‹œê°„í‘œ_${courseName}`;
    }

    if (exportData.length === 0) {
        window.showAlert('ë‚´ë³´ë‚¼ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    exportData.sort((a, b) => (a.date || '').localeCompare(b.date || ''));

    const excelData = exportData.map((t, idx) => ({
        'No': idx + 1,
        'ë‚ ì§œ': t.date || '',
        'ê³¼ì •': courses.find(c => c.code === t.course_code)?.name || t.course_code || '',
        'êµì‹œ': t.period || '',
        'ê³¼ëª©ì½”ë“œ': t.subject_code || '',
        'ê³¼ëª©ëª…': subjects.find(s => s.code === t.subject_code)?.name || t.subject_code || '',
        'ê°•ì‚¬': instructors.find(i => i.code === t.instructor_code)?.name || t.instructor_code || '',
        'ì‹œì‘ì‹œê°„': t.start_time || '',
        'ì¢…ë£Œì‹œê°„': t.end_time || '',
        'ê°•ì˜ì‹¤': t.room || '',
        'ë¹„ê³ ': t.note || ''
    }));

    const ws = XLSX.utils.json_to_sheet(excelData);
    ws['!cols'] = [{ wch: 5 }, { wch: 12 }, { wch: 25 }, { wch: 6 }, { wch: 10 }, { wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 20 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ì‹œê°„í‘œ');
    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(wb, `${fileName}_${today}.xlsx`);
    window.closeModal();
    window.showAlert(`${exportData.length}ê±´ì˜ ì‹œê°„í‘œë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
}

// ì‹œê°„í‘œ Excel ì—…ë¡œë“œ UI
window.showTimetableExcelUpload = function() {
    const div = document.getElementById('timetable-excel-upload');
    div.classList.remove('hidden');
    div.innerHTML = `
        <h3 class="text-lg font-bold mb-4">ì‹œê°„í‘œ Excel ì¼ê´„ ì—…ë¡œë“œ</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2">Excel íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="timetable-excel-file" accept=".xlsx,.xls" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                í•„ìˆ˜ ì»¬ëŸ¼: ë‚ ì§œ, ê³¼ì •ì½”ë“œ | ì„ íƒ: êµì‹œ, ê³¼ëª©ì½”ë“œ, ê°•ì‚¬ì½”ë“œ, ì‹œì‘ì‹œê°„, ì¢…ë£Œì‹œê°„, ê°•ì˜ì‹¤
            </p>
            <div class="space-x-2">
                <button onclick="window.uploadTimetableExcel()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-upload mr-2"></i>ì—…ë¡œë“œ
                </button>
                <button onclick="window.hideTimetableExcelUpload()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
            </div>
        </div>
    `;
}

window.hideTimetableExcelUpload = function() {
    document.getElementById('timetable-excel-upload').classList.add('hidden');
}

window.uploadTimetableExcel = async function() {
    const fileInput = document.getElementById('timetable-excel-file');
    const file = fileInput?.files[0];
    if (!file) { window.showAlert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning'); return; }

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (jsonData.length === 0) { window.showAlert('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning'); return; }

        let successCount = 0, failCount = 0;
        for (const row of jsonData) {
            const date = row['ë‚ ì§œ'] || row['date'] || '';
            const courseCode = row['ê³¼ì •ì½”ë“œ'] || row['course_code'] || '';

            if (!date || !courseCode) { failCount++; continue; }

            const timetableData = {
                date: date,
                course_code: courseCode,
                period: row['êµì‹œ'] || row['period'] || '',
                subject_code: row['ê³¼ëª©ì½”ë“œ'] || row['subject_code'] || '',
                instructor_code: row['ê°•ì‚¬ì½”ë“œ'] || row['instructor_code'] || '',
                start_time: row['ì‹œì‘ì‹œê°„'] || row['start_time'] || '',
                end_time: row['ì¢…ë£Œì‹œê°„'] || row['end_time'] || '',
                room: row['ê°•ì˜ì‹¤'] || row['room'] || '',
                note: row['ë¹„ê³ '] || row['note'] || ''
            };

            try {
                await axios.post(`${API_BASE_URL}/api/timetables`, timetableData);
                successCount++;
            } catch (e) { failCount++; }
        }

        await loadTimetableList();
        window.hideTimetableExcelUpload();
        window.showAlert(`ì—…ë¡œë“œ ì™„ë£Œ! ì„±ê³µ: ${successCount}ê±´, ì‹¤íŒ¨: ${failCount}ê±´`, successCount > 0 ? 'success' : 'warning');
    } catch (error) {
        console.error('Excel íŒŒì‹± ì‹¤íŒ¨:', error);
        window.showAlert('Excel íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

window.showTimetableForm = function(id = null) {
    const formDiv = document.getElementById('timetable-form');
    formDiv.classList.remove('hidden');
    
    const existing = id ? timetables.find(tt => tt.id === id) : null;
    
    formDiv.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-semibold">${id ? 'ì‹œê°„í‘œ ìˆ˜ì •' : 'ì‹œê°„í‘œ ì¶”ê°€'}</h3>
            <button onclick="window.hideTimetableForm()" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm text-gray-700 mb-1">ê³¼ì • *</label>
                <select id="tt-course-code" class="w-full border rounded px-3 py-2" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    ${courses.map(c => `
                        <option value="${c.code}" ${existing && existing.course_code === c.code ? 'selected' : ''}>
                            ${c.code} - ${c.name || c.code}
                        </option>
                    `).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">ê³¼ëª©</label>
                <select id="tt-subject-code" class="w-full border rounded px-3 py-2">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="PROJECT" ${existing && existing.subject_code === 'PROJECT' ? 'selected' : ''}>PROJECT - í”„ë¡œì íŠ¸</option>
                    <option value="WORKSHIP" ${existing && existing.subject_code === 'WORKSHIP' ? 'selected' : ''}>WORKSHIP - í˜„ì¥ì‹¤ìŠµ</option>
                    ${subjects.map(s => `
                        <option value="${s.code}" ${existing && existing.subject_code === s.code ? 'selected' : ''}>
                            ${s.code} - ${s.name || s.code}
                        </option>
                    `).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">ê°•ì‚¬</label>
                <select id="tt-instructor-code" class="w-full border rounded px-3 py-2">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    ${instructors.map(i => {
                        const typeInfo = instructorTypes.find(t => t.code === i.instructor_type);
                        const typeName = typeInfo ? typeInfo.name : '';
                        const typeType = typeInfo ? typeInfo.type : '';
                        return `
                            <option value="${i.code}" ${existing && existing.instructor_code === i.code ? 'selected' : ''}>
                                ${i.name} - ${i.code} - ${typeName} - ${typeType}
                            </option>
                        `;
                    }).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">ë‚ ì§œ *</label>
                <input type="date" id="tt-class-date" value="${existing ? existing.class_date : ''}" class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">ì‹œì‘ ì‹œê°„ * <span class="text-xs text-gray-500">(ì˜ˆ: 09:00 ë˜ëŠ” 0900)</span></label>
                <input type="text" id="tt-start-time" value="${existing ? formatTime(existing.start_time) : ''}" 
                       placeholder="09:00" pattern="[0-9]{1,2}:?[0-9]{2}" 
                       class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">ì¢…ë£Œ ì‹œê°„ * <span class="text-xs text-gray-500">(ì˜ˆ: 18:00 ë˜ëŠ” 1800)</span></label>
                <input type="text" id="tt-end-time" value="${existing ? formatTime(existing.end_time) : ''}" 
                       placeholder="18:00" pattern="[0-9]{1,2}:?[0-9]{2}" 
                       class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">íƒ€ì… *</label>
                <select id="tt-type" class="w-full border rounded px-3 py-2" required>
                    <option value="lecture" ${!existing || existing.type === 'lecture' ? 'selected' : ''}>ê°•ì˜</option>
                    <option value="project" ${existing && existing.type === 'project' ? 'selected' : ''}>í”„ë¡œì íŠ¸</option>
                    <option value="practice" ${existing && existing.type === 'practice' ? 'selected' : ''}>í˜„ì¥ì‹¤ìŠµ</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">ë¹„ê³ </label>
                <input type="text" id="tt-notes" placeholder="ë¹„ê³ " value="${existing ? existing.notes || '' : ''}" class="w-full border rounded px-3 py-2">
            </div>
        </div>
        <div class="mt-4 space-x-2">
            <button onclick="window.saveTimetable(${id || 'null'})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                <i class="fas fa-save mr-2"></i>ì €ì¥
            </button>
            <button onclick="window.hideTimetableForm()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
                ì·¨ì†Œ
            </button>
        </div>
    `;
}

window.hideTimetableForm = function() {
    document.getElementById('timetable-form').classList.add('hidden');
}

window.saveTimetable = async function(id) {
    // ì‹œê°„ ì…ë ¥ê°’ì„ HH:MM:SS í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const formatTimeInput = (value) => {
        // "09:00", "0900", "9:00" ë“±ì„ "09:00:00"ìœ¼ë¡œ ë³€í™˜
        const cleaned = value.replace(/:/g, '').trim();
        if (cleaned.length === 3) {
            // "900" -> "09:00:00"
            return `0${cleaned[0]}:${cleaned.slice(1)}:00`;
        } else if (cleaned.length === 4) {
            // "0900" -> "09:00:00"
            return `${cleaned.slice(0, 2)}:${cleaned.slice(2)}:00`;
        } else {
            // ì´ë¯¸ "09:00" í˜•ì‹ì´ë©´ ":00" ì¶”ê°€
            return value.includes(':') ? `${value}:00` : value;
        }
    };
    
    const startTimeValue = document.getElementById('tt-start-time').value;
    const endTimeValue = document.getElementById('tt-end-time').value;
    
    const data = {
        course_code: document.getElementById('tt-course-code').value,
        subject_code: document.getElementById('tt-subject-code').value,
        instructor_code: document.getElementById('tt-instructor-code').value,
        class_date: document.getElementById('tt-class-date').value,
        start_time: formatTimeInput(startTimeValue),
        end_time: formatTimeInput(endTimeValue),
        type: document.getElementById('tt-type').value,
        notes: document.getElementById('tt-notes').value
    };
    
    try {
        if (id) {
            await axios.put(`${API_BASE_URL}/api/timetables/${id}`, data);
            window.showAlert('ì‹œê°„í‘œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
            await axios.post(`${API_BASE_URL}/api/timetables`, data);
            window.showAlert('ì‹œê°„í‘œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        window.hideTimetableForm();
        loadTimetables();
    } catch (error) {
        showAlert('ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

window.editTimetable = function(id) {
    // í¼ì´ ìˆëŠ” ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
    window.scrollTo({ top: 0, behavior: 'smooth' });
    window.showTimetableForm(id);
}

window.deleteTimetable = async function(id) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const confirmed = await window.showConfirm('âš ï¸ ì´ ì‹œê°„í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/timetables/${id}`);
        window.showAlert('âœ… ì‹œê°„í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        loadTimetables();
    } catch (error) {
        window.showAlert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ==================== í›ˆë ¨ì¼ì§€ ê´€ë¦¬ ====================
let trainingLogs = [];
let selectedCourseForLogs = null;

async function loadTrainingLogs() {
    try {
        window.showLoading('í›ˆë ¨ì¼ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        // ë¨¼ì € ê³¼ì • ëª©ë¡ ë¡œë“œ
        const coursesRes = await axios.get(`${API_BASE_URL}/api/courses`);
        const courses = coursesRes.data;
        
        // ê°•ì‚¬ ëª©ë¡ ë¡œë“œ
        const instructorsRes = await axios.get(`${API_BASE_URL}/api/instructors`);
        instructors = instructorsRes.data;
        
        renderTrainingLogsSelection(courses);
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('í›ˆë ¨ì¼ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">í›ˆë ¨ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderTrainingLogsSelection(courses) {
    const app = document.getElementById('app');
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth() + 1;
    
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-clipboard-list mr-2"></i>í›ˆë ¨ì¼ì§€ ê´€ë¦¬
                </h2>
                <button onclick="window.showTrainingLogExportOptions()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i>Excel ë‚´ë³´ë‚´ê¸°
                </button>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <p class="text-blue-700 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>
                    ê³¼ì •, ê°•ì‚¬, ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ í›ˆë ¨ì¼ì§€ë¥¼ ì¡°íšŒí•˜ì„¸ìš”
                </p>
                <p class="text-blue-600 text-sm">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    ê¸°ë³¸ì ìœ¼ë¡œ <strong>ìµœê·¼ 3ì¼ì¹˜ (ì˜¤ëŠ˜ í¬í•¨)</strong>ê°€ í‘œì‹œë©ë‹ˆë‹¤. ë…„ë„/ì›”/ì‘ì„±ìƒíƒœë¥¼ ì„ íƒí•˜ë©´ ì „ì²´ ê¸°ê°„ ì¡°íšŒë©ë‹ˆë‹¤.
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 mb-2">ê³¼ì • ì„ íƒ</label>
                    <select id="log-course" class="w-full border rounded px-3 py-2" onchange="window.filterTrainingLogs()">
                        <option value="">-- ê³¼ì • ì„ íƒ --</option>
                        ${courses.map(c => `<option value="${c.code}" ${c.code === 'C-001' ? 'selected' : ''}>${c.name} (${c.code})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">íƒ€ì…</label>
                    <select id="log-type" class="w-full border rounded px-3 py-2" onchange="window.filterTrainingLogs()">
                        <option value="" selected>ì „ì²´</option>
                        <option value="lecture">êµê³¼</option>
                        <option value="project">í”„ë¡œì íŠ¸</option>
                        <option value="practice">í˜„ì¥ì‹¤ìŠµ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ê°•ì‚¬ ì„ íƒ</label>
                    <select id="log-instructor" class="w-full border rounded px-3 py-2" onchange="window.filterTrainingLogs()">
                        <option value="" selected>ì „ì²´ ê°•ì‚¬</option>
                        ${(() => {
                            const loggedInInstructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
                            const sortedInstructors = [...instructors].sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                            return sortedInstructors.map(i => {
                                const displayMark = i.code === loggedInInstructor.code ? ' (ë‚˜)' : '';
                                return `<option value="${i.code}">${i.name}-${i.instructor_type_name || 'ê°•ì‚¬'}${displayMark}</option>`;
                            }).join('');
                        })()}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ë…„ë„</label>
                    <select id="log-year" class="w-full border rounded px-3 py-2" onchange="window.filterTrainingLogs()">
                        <option value="" selected>ì „ì²´</option>
                        <option value="${currentYear}">${currentYear}</option>
                        <option value="${currentYear - 1}">${currentYear - 1}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ì›”</label>
                    <select id="log-month" class="w-full border rounded px-3 py-2" onchange="window.filterTrainingLogs()">
                        <option value="" selected>ì „ì²´</option>
                        ${Array.from({length: 12}, (_, i) => i + 1).map(m => 
                            `<option value="${m}">${m}ì›”</option>`
                        ).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ì‘ì„± ìƒíƒœ</label>
                    <select id="log-status" class="w-full border rounded px-3 py-2" onchange="window.filterTrainingLogs()">
                        <option value="" selected>ì „ì²´</option>
                        <option value="unwritten">ë¯¸ì‘ì„±</option>
                        <option value="written">ì‘ì„±ì™„ë£Œ</option>
                    </select>
                </div>
            </div>
            
            <div id="training-logs-list">
                <p class="text-gray-500 text-center py-8">ê³¼ì •ì„ ì„ íƒí•˜ì—¬ ì‹œê°„í‘œì™€ í›ˆë ¨ì¼ì§€ë¥¼ ì¡°íšŒí•˜ì„¸ìš”</p>
            </div>
        </div>
    `;
    
    // ìµœì´ˆ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ëª©ë¡ ì¡°íšŒ
    setTimeout(() => {
        window.filterTrainingLogs();
    }, 100);
}

// í›ˆë ¨ì¼ì§€ Excel ë‚´ë³´ë‚´ê¸° ì˜µì…˜
window.showTrainingLogExportOptions = function() {
    const courseOptions = courses.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
    window.showModal('í›ˆë ¨ì¼ì§€ Excel ë‚´ë³´ë‚´ê¸°', `
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-2 font-medium">ë‚´ë³´ë‚¼ ê³¼ì • ì„ íƒ</label>
                <select id="export-training-course" class="w-full border rounded px-3 py-2">
                    <option value="">ì „ì²´ ê³¼ì •</option>
                    ${courseOptions}
                </select>
            </div>
            <p class="text-sm text-gray-500"><i class="fas fa-info-circle mr-1"></i>ì„ íƒí•œ ê³¼ì •ì˜ í›ˆë ¨ì¼ì§€ë¥¼ Excelë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="window.closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="window.exportTrainingLogsToExcel()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-file-export mr-2"></i>ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </div>
    `);
}

window.exportTrainingLogsToExcel = async function() {
    const courseCode = document.getElementById('export-training-course')?.value;
    let fileName = 'í›ˆë ¨ì¼ì§€_ì „ì²´';

    try {
        window.showLoading('í›ˆë ¨ì¼ì§€ ë°ì´í„° ì¡°íšŒ ì¤‘...');
        const res = await axios.get(`${API_BASE_URL}/api/training-logs`);
        let exportData = res.data || [];

        if (courseCode) {
            exportData = exportData.filter(t => t.course_code === courseCode);
            const courseName = courses.find(c => c.code === courseCode)?.name || courseCode;
            fileName = `í›ˆë ¨ì¼ì§€_${courseName}`;
        }

        window.hideLoading();

        if (exportData.length === 0) {
            window.showAlert('ë‚´ë³´ë‚¼ í›ˆë ¨ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        exportData.sort((a, b) => (a.date || '').localeCompare(b.date || ''));

        const excelData = exportData.map((t, idx) => ({
            'No': idx + 1,
            'ë‚ ì§œ': t.date || '',
            'ê³¼ì •': courses.find(c => c.code === t.course_code)?.name || t.course_code || '',
            'ê°•ì‚¬': instructors.find(i => i.code === t.instructor_code)?.name || t.instructor_code || '',
            'ê³¼ëª©': t.subject_name || '',
            'í›ˆë ¨ë‚´ìš©': t.content || '',
            'ë¹„ê³ ': t.note || ''
        }));

        const ws = XLSX.utils.json_to_sheet(excelData);
        ws['!cols'] = [{ wch: 5 }, { wch: 12 }, { wch: 25 }, { wch: 10 }, { wch: 20 }, { wch: 50 }, { wch: 20 }];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'í›ˆë ¨ì¼ì§€');
        const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        XLSX.writeFile(wb, `${fileName}_${today}.xlsx`);
        window.closeModal();
        window.showAlert(`${exportData.length}ê±´ì˜ í›ˆë ¨ì¼ì§€ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
    } catch (error) {
        window.hideLoading();
        console.error('í›ˆë ¨ì¼ì§€ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
        window.showAlert('í›ˆë ¨ì¼ì§€ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

window.filterTrainingLogs = async function() {
    const courseCode = document.getElementById('log-course').value;
    const type = document.getElementById('log-type').value;
    const instructorCode = document.getElementById('log-instructor').value;
    const year = document.getElementById('log-year').value;
    const month = document.getElementById('log-month').value;
    const status = document.getElementById('log-status').value;
    
    if (!courseCode) {
        document.getElementById('training-logs-list').innerHTML = `
            <p class="text-gray-500 text-center py-8">ê³¼ì •ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</p>
        `;
        return;
    }
    
    selectedCourseForLogs = courseCode;
    
    try {
        // ì‹œê°„í‘œì™€ í›ˆë ¨ì¼ì§€ë¥¼ í•¨ê»˜ ì¡°íšŒ
        let url = `${API_BASE_URL}/api/timetables?course_code=${courseCode}`;
        
        const response = await axios.get(url);
        const timetables = response.data;
        
        // í•„í„°ë§
        let filteredTimetables = timetables;
        
        // íƒ€ì… í•„í„°
        if (type) {
            filteredTimetables = filteredTimetables.filter(tt => tt.type === type);
        }
        
        if (instructorCode) {
            filteredTimetables = filteredTimetables.filter(tt => tt.instructor_code === instructorCode);
        }
        
        if (year && month) {
            filteredTimetables = filteredTimetables.filter(tt => {
                const date = new Date(tt.class_date);
                return date.getFullYear() === parseInt(year) && date.getMonth() + 1 === parseInt(month);
            });
        } else if (year) {
            filteredTimetables = filteredTimetables.filter(tt => {
                const date = new Date(tt.class_date);
                return date.getFullYear() === parseInt(year);
            });
        }
        
        // ì‘ì„± ìƒíƒœ í•„í„° (ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œë§Œ ë¯¸ì‘ì„± íŒì •)
        if (status) {
            const today = new Date().toISOString().split('T')[0];
            filteredTimetables = filteredTimetables.filter(tt => {
                const hasLog = tt.training_log_id != null;
                const isBeforeToday = tt.class_date < today;
                
                if (status === 'written') {
                    return hasLog;
                } else if (status === 'unwritten') {
                    // ë¯¸ì‘ì„±: í›ˆë ¨ì¼ì§€ ì—†ê³  + ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œë§Œ
                    return !hasLog && isBeforeToday;
                }
                return true;
            });
        }
        
        // ê¸°ë³¸ì ìœ¼ë¡œ ìµœê·¼ 3ì¼ì¹˜ë§Œ í‘œì‹œ (year, month, status í•„í„°ê°€ ì—†ì„ ë•Œ)
        if (!year && !month && !status) {
            const today = new Date();
            const threeDaysAgo = new Date(today);
            threeDaysAgo.setDate(today.getDate() - 2); // ì˜¤ëŠ˜ í¬í•¨ 3ì¼
            const threeDaysAgoStr = threeDaysAgo.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            
            filteredTimetables = filteredTimetables.filter(tt => {
                return tt.class_date >= threeDaysAgoStr && tt.class_date <= todayStr;
            });
        }
        
        renderTrainingLogsTable(filteredTimetables);
    } catch (error) {
        console.error('í›ˆë ¨ì¼ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
        document.getElementById('training-logs-list').innerHTML = `
            <p class="text-red-600 text-center py-8">í›ˆë ¨ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
        `;
    }
}

function renderTrainingLogsTable(timetables) {
    const listDiv = document.getElementById('training-logs-list');
    const today = new Date().toISOString().split('T')[0];
    let todayRowId = null;
    
    if (timetables.length === 0) {
        listDiv.innerHTML = `
            <p class="text-gray-500 text-center py-8">ì¡°íšŒëœ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>
        `;
        return;
    }
    
    // ê³¼ì • ì‹œì‘ì¼ (2024-11-07)
    const courseStartDate = new Date('2024-11-07');
    
    // ê³¼ëª©ë³„ ì´ ì‹œìˆ˜ ê³„ì‚° (subject_code ì—†ìœ¼ë©´ typeìœ¼ë¡œ êµ¬ë¶„)
    const getGroupKey = (t) => t.subject_code || ('__type__' + t.type);
    const subjectHoursMap = {};

    timetables.forEach((tt) => {
        const key = getGroupKey(tt);
        if (!subjectHoursMap[key]) {
            subjectHoursMap[key] = 0;
        }
        const duration = calculateDuration(tt.start_time, tt.end_time);
        subjectHoursMap[key] += duration;
    });
    
    listDiv.innerHTML = `
        <div id="training-log-form" class="hidden mb-6 p-4 bg-blue-50 rounded-lg"></div>
        
        <div class="mb-4">
            <p class="text-sm text-gray-600">ì´ ${timetables.length}ê±´ì˜ ì‹œê°„í‘œ</p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-2 py-2 text-center text-xs w-12">ì‚¬ì§„</th>
                        <th class="px-3 py-2 text-left text-xs">ë‚ ì§œ</th>
                        <th class="px-3 py-2 text-left text-xs">ì¼ì°¨</th>
                        <th class="px-3 py-2 text-left text-xs">ê°•ì˜ì‹œìˆ˜</th>
                        <th class="px-3 py-2 text-left text-xs">ê³¼ëª©</th>
                        <th class="px-3 py-2 text-left text-xs">ê°•ì‚¬</th>
                        <th class="px-3 py-2 text-left text-xs">ì‹œê°„</th>
                        <th class="px-3 py-2 text-left text-xs">íƒ€ì…</th>
                        <th class="px-3 py-2 text-left text-xs">í›ˆë ¨ì¼ì§€</th>
                        <th class="px-3 py-2 text-left text-xs">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody>
                    ${timetables.map((tt, index) => {
                        const hasLog = tt.training_log_id != null;
                        const logContent = tt.training_content ? tt.training_content.substring(0, 30) + '...' : '';
                        const isToday = tt.class_date === today;
                        const isOverdue = tt.class_date < today && !hasLog;
                        
                        // ì˜¤ëŠ˜ ë‚ ì§œ í–‰ ID ì €ì¥ (ì²« ë²ˆì§¸ ì˜¤ëŠ˜ ë‚ ì§œë§Œ)
                        if (isToday && !todayRowId) {
                            todayRowId = `log-row-${index}`;
                        }
                        
                        // ë‚ ì§œì—ì„œ ìš”ì¼ ê³„ì‚°
                        const classDate = new Date(tt.class_date);
                        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                        const dayOfWeek = dayNames[classDate.getDay()];
                        
                        // ê°•ì˜ì‹œìˆ˜ ê³„ì‚° (í˜„ì¬ì‹œìˆ˜/ì´ì‹œìˆ˜)
                        // í˜„ì¬ í•­ëª©ê¹Œì§€ì˜ ëˆ„ì  ì‹œìˆ˜ ê³„ì‚° (í”„ë¡œì íŠ¸/í˜„ì¥ì‹¤ìŠµ ë³„ë„)
                        const ttKey = getGroupKey(tt);
                        let currentHours = 0;
                        for (let i = 0; i <= index; i++) {
                            if (getGroupKey(timetables[i]) === ttKey) {
                                currentHours += calculateDuration(timetables[i].start_time, timetables[i].end_time);
                            }
                        }
                        const totalHours = subjectHoursMap[ttKey] || 0;
                        const hoursDisplay = `${currentHours}h / ${totalHours}h`;
                        
                        return `
                            <tr id="log-row-${index}" class="border-b hover:bg-gray-50 ${isToday ? 'bg-yellow-100' : ''}">
                                <td class="px-2 py-2 text-center text-xs">
                                    ${hasLog && tt.training_log_photo_urls && JSON.parse(tt.training_log_photo_urls || '[]').length > 0 ? `
                                        <button onclick='window.showPhotoViewer(${JSON.stringify(tt.training_log_photo_urls)}, 0)' 
                                                class="text-green-600 hover:text-green-700" 
                                                title="${JSON.parse(tt.training_log_photo_urls).length}ê°œ ì‚¬ì§„">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                    ` : `
                                        <i class="fas fa-camera text-gray-300" title="ì‚¬ì§„ ì—†ìŒ"></i>
                                    `}
                                </td>
                                <td class="px-3 py-2 text-xs">${tt.class_date} (${dayOfWeek})</td>
                                <td class="px-3 py-2 text-xs">${tt.day_number || '-'}ì¼ì°¨</td>
                                <td class="px-3 py-2 text-xs font-semibold text-blue-600">${hoursDisplay}</td>
                                <td class="px-3 py-2 text-xs">${tt.type === 'project' ? 'í”„ë¡œì íŠ¸' : tt.type === 'practice' ? 'í˜„ì¥ì‹¤ìŠµ' : (tt.subject_name || '-')}</td>
                                <td class="px-3 py-2 text-xs">${tt.instructor_name || '-'}</td>
                                <td class="px-3 py-2 text-xs">${formatTime(tt.start_time)} - ${formatTime(tt.end_time)}</td>
                                <td class="px-3 py-2 text-xs">
                                    <span class="px-2 py-1 rounded text-xs ${
                                        tt.type === 'lecture' ? 'bg-blue-100 text-blue-800' :
                                        tt.type === 'project' ? 'bg-green-100 text-green-800' :
                                        'bg-yellow-100 text-yellow-800'
                                    }">
                                        ${tt.type}
                                    </span>
                                </td>
                                <td class="px-3 py-2 text-xs">
                                    ${hasLog ? `
                                        <span class="text-green-600">
                                            <i class="fas fa-check-circle mr-1"></i>ì‘ì„±ì™„ë£Œ
                                        </span>
                                        <div class="text-gray-500 text-xs mt-1">${logContent}</div>
                                    ` : isOverdue ? `
                                        <span class="text-red-600 font-semibold">
                                            <i class="fas fa-exclamation-circle mr-1"></i>ë¯¸ì‘ì„±
                                        </span>
                                    ` : `
                                        <span class="text-gray-400">
                                            <i class="fas fa-minus-circle mr-1"></i>ë¯¸ì‘ì„±
                                        </span>
                                    `}
                                </td>
                                <td class="px-3 py-2 text-xs">
                                    ${(() => {
                                        const isFuture = new Date(tt.class_date).setHours(0,0,0,0) > new Date().setHours(0,0,0,0);
                                        if (hasLog) {
                                            return `
                                                <button onclick="window.editTrainingLog(${tt.training_log_id}, ${tt.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                                    <i class="fas fa-edit"></i> ìˆ˜ì •
                                                </button>
                                            `;
                                        } else if (isFuture) {
                                            return `
                                                <button disabled class="text-gray-300 cursor-not-allowed" title="ë¯¸ë˜ ë‚ ì§œëŠ” ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤">
                                                    <i class="fas fa-lock"></i> ì‘ì„±ë¶ˆê°€
                                                </button>
                                            `;
                                        } else {
                                            return `
                                                <button onclick="window.showTrainingLogForm(${tt.id})" class="text-green-600 hover:text-green-800">
                                                    <i class="fas fa-plus"></i> ì‘ì„±
                                                </button>
                                            `;
                                        }
                                    })()}
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìë™ ìŠ¤í¬ë¡¤
    if (todayRowId) {
        setTimeout(() => {
            const todayRow = document.getElementById(todayRowId);
            if (todayRow) {
                todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 100);
    }
}

window.showTrainingLogForm = async function(timetableId) {
    try {
        // ì‹œê°„í‘œ ì •ë³´ ì¡°íšŒ
        const response = await axios.get(`${API_BASE_URL}/api/timetables/${timetableId}`);
        const tt = response.data;
        
        // ë¯¸ë˜ ë‚ ì§œ ì²´í¬
        const classDate = new Date(tt.class_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);  // ì‹œê°„ì„ 00:00:00ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë‚ ì§œë§Œ ë¹„êµ
        classDate.setHours(0, 0, 0, 0);
        
        if (classDate > today) {
            window.showAlert('ë¯¸ë˜ ë‚ ì§œì˜ í›ˆë ¨ì¼ì§€ëŠ” ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nìˆ˜ì—…ì´ ì§„í–‰ëœ í›„ì— ì‘ì„±í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // ê³¼ëª©ì˜ ì„¸ë¶€ êµê³¼ëª© ì •ë³´ ì¡°íšŒ
        let subSubjectsHTML = '';
        if (tt.subject_code) {
            try {
                const subjectRes = await axios.get(`${API_BASE_URL}/api/subjects/${tt.subject_code}`);
                const subject = subjectRes.data;
                const subs = [1, 2, 3, 4, 5]
                    .filter(i => subject[`sub_subject_${i}`] && subject[`sub_subject_${i}`].trim())
                    .map(i => `<li class="text-xs">â€¢ ${subject[`sub_subject_${i}`]} (${subject[`sub_hours_${i}`] || 0}ì‹œê°„)</li>`);
                
                if (subs.length > 0) {
                    subSubjectsHTML = `
                        <div class="mt-2 pt-2 border-t">
                            <p class="text-sm font-semibold mb-1">ì„¸ë¶€ êµê³¼ëª©:</p>
                            <ul class="text-gray-600">${subs.join('')}</ul>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ê³¼ëª© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }
        
        const formDiv = document.getElementById('training-log-form');
        formDiv.innerHTML = `
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-clipboard-list mr-2"></i>í›ˆë ¨ì¼ì§€ ì‘ì„±
            </h3>
            <div class="bg-white p-4 rounded mb-4">
                <p class="text-sm"><strong>ë‚ ì§œ:</strong> ${tt.class_date}</p>
                <p class="text-sm"><strong>ê³¼ëª©:</strong> ${tt.subject_name || '-'}</p>
                <p class="text-sm"><strong>ê°•ì‚¬:</strong> ${tt.instructor_name || '-'}</p>
                <p class="text-sm"><strong>ì‹œê°„:</strong> ${formatTime(tt.start_time)} - ${formatTime(tt.end_time)}</p>
                ${subSubjectsHTML}
            </div>
            <form id="training-log-save-form">
                <input type="hidden" id="training-log-id" value="">
                <input type="hidden" id="training-timetable-id" value="${timetableId}">
                <input type="hidden" id="training-course-code" value="${tt.course_code}">
                <input type="hidden" id="training-instructor-code" value="${tt.instructor_code}">
                <input type="hidden" id="training-class-date" value="${tt.class_date}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2 flex items-center justify-between">
                            <span>ìˆ˜ì—… ë‚´ìš© *</span>
                            <div class="relative inline-block">
                                <button type="button" 
                                        id="ai-generate-btn"
                                        class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 shadow-md hover:shadow-lg transition-all"
                                        onclick="document.getElementById('ai-dropdown').classList.toggle('hidden')">
                                    <i class="fas fa-magic"></i>
                                    <span>AI í™•ì¥í•˜ê¸°</span>
                                    <i class="fas fa-chevron-down ml-1"></i>
                                </button>
                                <div id="ai-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-10">
                                    <div class="p-3 border-b bg-gray-50 rounded-t-lg">
                                        <p class="text-xs text-gray-600">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            ìˆ˜ì—… ë‚´ìš©ì„ ëª‡ ë‹¨ì–´ë¼ë„ ì…ë ¥í•œ í›„<br/>ì›í•˜ëŠ” ìƒì„¸ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”
                                        </p>
                                    </div>
                                    <button type="button" 
                                            onclick="window.generateAIContent(${timetableId}, '${tt.subject_name || ''}', '${tt.subject_code || ''}', '${tt.class_date}', '${tt.instructor_name || ''}', 'summary', '${tt.type || 'lecture'}')"
                                            class="w-full text-left px-4 py-3 hover:bg-blue-50 transition flex items-center gap-3 border-b">
                                        <i class="fas fa-compress-alt text-blue-500"></i>
                                        <div>
                                            <div class="font-semibold text-sm">ìš”ì•½</div>
                                            <div class="text-xs text-gray-500">ê°„ê²°í•œ í•µì‹¬ ë‚´ìš© (200-300ì)</div>
                                        </div>
                                    </button>
                                    <button type="button" 
                                            onclick="window.generateAIContent(${timetableId}, '${tt.subject_name || ''}', '${tt.subject_code || ''}', '${tt.class_date}', '${tt.instructor_name || ''}', 'normal', '${tt.type || 'lecture'}')"
                                            class="w-full text-left px-4 py-3 hover:bg-green-50 transition flex items-center gap-3 border-b">
                                        <i class="fas fa-align-left text-green-500"></i>
                                        <div>
                                            <div class="font-semibold text-sm">ë³´í†µ</div>
                                            <div class="text-xs text-gray-500">ì ì ˆí•œ ìƒì„¸ë„ (400-600ì)</div>
                                        </div>
                                    </button>
                                    <button type="button" 
                                            onclick="window.generateAIContent(${timetableId}, '${tt.subject_name || ''}', '${tt.subject_code || ''}', '${tt.class_date}', '${tt.instructor_name || ''}', 'detailed', '${tt.type || 'lecture'}')"
                                            class="w-full text-left px-4 py-3 hover:bg-purple-50 transition flex items-center gap-3 rounded-b-lg">
                                        <i class="fas fa-align-justify text-purple-500"></i>
                                        <div>
                                            <div class="font-semibold text-sm">ìƒì„¸</div>
                                            <div class="text-xs text-gray-500">ë§¤ìš° êµ¬ì²´ì ì¸ ë‚´ìš© (800-1200ì)</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </label>
                        <textarea id="training-content-textarea" name="content" rows="6" required class="w-full px-3 py-2 border rounded-lg" 
                                  placeholder="ìˆ˜ì—…ì—ì„œ ë‹¤ë£¬ ë‚´ìš©ì„ ê°„ë‹¨íˆ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: HTML, CSS ê¸°ì´ˆ, ë ˆì´ì•„ì›ƒ ì‹¤ìŠµ)&#10;&#10;ì…ë ¥ í›„ 'AI í™•ì¥í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ìš”ì•½/ë³´í†µ/ìƒì„¸ ì¤‘ ì„ íƒí•˜ë©´&#10;AIê°€ ì…ë ¥í•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì „ë¬¸ì ì¸ í›ˆë ¨ì¼ì§€ë¡œ í™•ì¥í•´ë“œë¦½ë‹ˆë‹¤!"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ê³¼ì œ</label>
                        <textarea name="homework" rows="3" class="w-full px-3 py-2 border rounded-lg" 
                                  placeholder="í•™ìƒë“¤ì—ê²Œ ë¶€ì—¬í•œ ê³¼ì œê°€ ìˆë‹¤ë©´ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ë¹„ê³ </label>
                        <textarea name="notes" rows="2" class="w-full px-3 py-2 border rounded-lg" 
                                  placeholder="ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì°¸ê³ ì‚¬í•­ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                    </div>
                    
                    <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                    <div>
                        <label class="block text-gray-700 mb-2">
                            <i class="fas fa-paperclip mr-2"></i>ì‚¬ì§„ ë° íŒŒì¼ ì²¨ë¶€ (ê·¸ë¦¼íŒŒì¼, PDF, HWP, PPT, Excel, Word, TXT ë“±)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button type="button" onclick="document.getElementById('training-file-input').click()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                                </button>
                                <button type="button" onclick="document.getElementById('training-camera-input').click()" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-camera mr-2"></i>ì‚¬ì§„ ì´¬ì˜
                                </button>
                            </div>
                            <input type="file" id="training-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                                   onchange="window.handleTrainingImageUpload(event)" class="hidden">
                            <input type="file" id="training-camera-input" accept="image/*"  
                                   onchange="window.handleTrainingImageUpload(event)" class="hidden">
                            <div id="training-upload-progress" class="hidden mb-3">
                                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                    <p class="text-sm text-blue-800 mb-2">
                                        <i class="fas fa-cloud-upload-alt mr-2"></i>
                                        ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                                    </p>
                                    <div class="w-full bg-blue-200 rounded-full h-2">
                                        <div id="training-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="training-photos-preview" class="flex flex-col gap-2 mt-2"></div>
                            <input type="hidden" id="training-photo-urls" value="[]">
                            <p class="text-sm text-gray-500 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                ìµœëŒ€ 10MB, JPG/PNG/GIF í˜•ì‹
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 space-x-2">
                    <button type="button" onclick="window.saveTrainingLog(${timetableId}, '${tt.course_code}', '${tt.instructor_code}', '${tt.class_date}')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                    </button>
                    <button type="button" onclick="window.hideTrainingLogForm()" 
                            class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>
        `;
        
        formDiv.classList.remove('hidden');
        formDiv.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error('ì‹œê°„í‘œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
        window.showAlert('ì‹œê°„í‘œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
}

window.editTrainingLog = async function(logId, timetableId) {
    try {
        const [logRes, ttRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/training-logs/${logId}`),
            axios.get(`${API_BASE_URL}/api/timetables/${timetableId}`)
        ]);
        
        const log = logRes.data;
        const tt = ttRes.data;
        
        // ê³¼ëª©ì˜ ì„¸ë¶€ êµê³¼ëª© ì •ë³´ ì¡°íšŒ
        let subSubjectsHTML = '';
        if (tt.subject_code) {
            try {
                const subjectRes = await axios.get(`${API_BASE_URL}/api/subjects/${tt.subject_code}`);
                const subject = subjectRes.data;
                const subs = [1, 2, 3, 4, 5]
                    .filter(i => subject[`sub_subject_${i}`] && subject[`sub_subject_${i}`].trim())
                    .map(i => `<li class="text-xs">â€¢ ${subject[`sub_subject_${i}`]} (${subject[`sub_hours_${i}`] || 0}ì‹œê°„)</li>`);
                
                if (subs.length > 0) {
                    subSubjectsHTML = `
                        <div class="mt-2 pt-2 border-t">
                            <p class="text-sm font-semibold mb-1">ì„¸ë¶€ êµê³¼ëª©:</p>
                            <ul class="text-gray-600">${subs.join('')}</ul>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ê³¼ëª© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }
        
        const formDiv = document.getElementById('training-log-form');
        formDiv.innerHTML = `
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-edit mr-2"></i>í›ˆë ¨ì¼ì§€ ìˆ˜ì •
            </h3>
            <div class="bg-white p-4 rounded mb-4">
                <p class="text-sm"><strong>ë‚ ì§œ:</strong> ${tt.class_date}</p>
                <p class="text-sm"><strong>ê³¼ëª©:</strong> ${tt.subject_name || '-'}</p>
                <p class="text-sm"><strong>ê°•ì‚¬:</strong> ${tt.instructor_name || '-'}</p>
                <p class="text-sm"><strong>ì‹œê°„:</strong> ${formatTime(tt.start_time)} - ${formatTime(tt.end_time)}</p>
                ${subSubjectsHTML}
            </div>
            <form id="training-log-save-form">
                <input type="hidden" id="training-log-id" value="${logId}">
                <input type="hidden" id="training-timetable-id" value="${timetableId}">
                <input type="hidden" id="training-course-code" value="${tt.course_code}">
                <input type="hidden" id="training-instructor-code" value="${tt.instructor_code}">
                <input type="hidden" id="training-class-date" value="${tt.class_date}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2 flex items-center justify-between">
                            <span>ìˆ˜ì—… ë‚´ìš© *</span>
                            <div class="relative inline-block">
                                <button type="button" 
                                        id="ai-generate-btn-edit"
                                        class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 shadow-md hover:shadow-lg transition-all"
                                        onclick="document.getElementById('ai-dropdown-edit').classList.toggle('hidden')">
                                    <i class="fas fa-magic"></i>
                                    <span>AI í™•ì¥í•˜ê¸°</span>
                                    <i class="fas fa-chevron-down ml-1"></i>
                                </button>
                                <div id="ai-dropdown-edit" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-10">
                                    <div class="p-3 border-b bg-gray-50 rounded-t-lg">
                                        <p class="text-xs text-gray-600">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            ìˆ˜ì—… ë‚´ìš©ì„ ìˆ˜ì •í•œ í›„<br/>ì›í•˜ëŠ” ìƒì„¸ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”
                                        </p>
                                    </div>
                                    <button type="button" 
                                            onclick="window.generateAIContent(${timetableId}, '${tt.subject_name || ''}', '${tt.subject_code || ''}', '${tt.class_date}', '${tt.instructor_name || ''}', 'summary', '${tt.type || 'lecture'}')"
                                            class="w-full text-left px-4 py-3 hover:bg-blue-50 transition flex items-center gap-3 border-b">
                                        <i class="fas fa-compress-alt text-blue-500"></i>
                                        <div>
                                            <div class="font-semibold text-sm">ìš”ì•½</div>
                                            <div class="text-xs text-gray-500">ê°„ê²°í•œ í•µì‹¬ ë‚´ìš© (200-300ì)</div>
                                        </div>
                                    </button>
                                    <button type="button" 
                                            onclick="window.generateAIContent(${timetableId}, '${tt.subject_name || ''}', '${tt.subject_code || ''}', '${tt.class_date}', '${tt.instructor_name || ''}', 'normal', '${tt.type || 'lecture'}')"
                                            class="w-full text-left px-4 py-3 hover:bg-green-50 transition flex items-center gap-3 border-b">
                                        <i class="fas fa-align-left text-green-500"></i>
                                        <div>
                                            <div class="font-semibold text-sm">ë³´í†µ</div>
                                            <div class="text-xs text-gray-500">ì ì ˆí•œ ìƒì„¸ë„ (400-600ì)</div>
                                        </div>
                                    </button>
                                    <button type="button" 
                                            onclick="window.generateAIContent(${timetableId}, '${tt.subject_name || ''}', '${tt.subject_code || ''}', '${tt.class_date}', '${tt.instructor_name || ''}', 'detailed', '${tt.type || 'lecture'}')"
                                            class="w-full text-left px-4 py-3 hover:bg-purple-50 transition flex items-center gap-3 rounded-b-lg">
                                        <i class="fas fa-align-justify text-purple-500"></i>
                                        <div>
                                            <div class="font-semibold text-sm">ìƒì„¸</div>
                                            <div class="text-xs text-gray-500">ë§¤ìš° êµ¬ì²´ì ì¸ ë‚´ìš© (800-1200ì)</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </label>
                        <textarea id="training-content-textarea" name="content" rows="6" required class="w-full px-3 py-2 border rounded-lg">${log.content || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ê³¼ì œ</label>
                        <textarea name="homework" rows="3" class="w-full px-3 py-2 border rounded-lg">${log.homework || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ë¹„ê³ </label>
                        <textarea name="notes" rows="2" class="w-full px-3 py-2 border rounded-lg">${log.notes || ''}</textarea>
                    </div>
                    
                    <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                    <div>
                        <label class="block text-gray-700 mb-2">
                            <i class="fas fa-paperclip mr-2"></i>ì‚¬ì§„ ë° íŒŒì¼ ì²¨ë¶€ (ê·¸ë¦¼íŒŒì¼, PDF, HWP, PPT, Excel, Word, TXT ë“±)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button type="button" onclick="document.getElementById('training-file-input').click()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                                </button>
                                <button type="button" onclick="document.getElementById('training-camera-input').click()" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-camera mr-2"></i>ì‚¬ì§„ ì´¬ì˜
                                </button>
                            </div>
                            <input type="file" id="training-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                                   onchange="window.handleTrainingImageUpload(event)" class="hidden">
                            <input type="file" id="training-camera-input" accept="image/*"  
                                   onchange="window.handleTrainingImageUpload(event)" class="hidden">
                            <div id="training-upload-progress" class="hidden mb-3">
                                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                    <p class="text-sm text-blue-800 mb-2">
                                        <i class="fas fa-cloud-upload-alt mr-2"></i>
                                        ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                                    </p>
                                    <div class="w-full bg-blue-200 rounded-full h-2">
                                        <div id="training-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="training-photos-preview" class="flex flex-col gap-2 mt-2"></div>
                            <input type="hidden" id="training-photo-urls" value='${log && log.photo_urls ? log.photo_urls : "[]"}'>
                        </div>
                    </div>
                </div>
                <div class="mt-4 space-x-2">
                    <button type="button" onclick="window.updateTrainingLog(${logId})" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                    </button>
                    <button type="button" onclick="window.deleteTrainingLog(${logId})" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-trash mr-2"></i>ì‚­ì œ
                    </button>
                    <button type="button" onclick="window.hideTrainingLogForm()" 
                            class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>
        `;
        
        formDiv.classList.remove('hidden');
        formDiv.scrollIntoView({ behavior: 'smooth' });
        
        // ê¸°ì¡´ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        if (log.photo_urls) {
            try {
                const photoUrls = typeof log.photo_urls === 'string' 
                    ? JSON.parse(log.photo_urls) 
                    : log.photo_urls;
                updateTrainingPhotoPreview(photoUrls);
            } catch (e) {
                console.error('ì‚¬ì§„ URL íŒŒì‹± ì˜¤ë¥˜:', e);
            }
        }
    } catch (error) {
        console.error('í›ˆë ¨ì¼ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
        window.showAlert('í›ˆë ¨ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
}

// í›ˆë ¨ì¼ì§€ ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬
window.handleTrainingImageUpload = async function(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // íŒŒì¼ ê²€ì¦
    for (let file of files) {
        const validation = window.validateFile(file);
        if (!validation.valid) {
            window.showAlert(validation.message);
            event.target.value = '';
            return;
        }
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” í‘œì‹œ
    const progressDiv = document.getElementById('training-upload-progress');
    const progressBar = document.getElementById('training-progress-bar');
    if (progressDiv) {
        progressDiv.classList.remove('hidden');
        progressBar.style.width = '0%';
    }
    
    try {
        const photoUrls = JSON.parse(document.getElementById('training-photo-urls').value || '[]');
        const totalFiles = files.length;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° ì••ì¶• ì²˜ë¦¬
            let uploadFile = file;
            const isImage = file.type.startsWith('image/');
            
            if (isImage) {
                try {
                    uploadFile = await window.compressImage(file, 1280, 0.7);
                } catch (compressError) {
                    console.warn('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì—…ë¡œë“œ:', compressError);
                }
            }
            
            const formData = new FormData();
            formData.append('file', uploadFile, file.name);
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
            const progress = ((i + 0.5) / totalFiles) * 100;
            if (progressBar) progressBar.style.width = `${progress}%`;
            
            const response = await axios.post(
                `${API_BASE_URL}/api/upload-image?category=train`,
                formData,
                {
                    headers: { 'Content-Type': 'multipart/form-data' }
                }
            );
            
            if (response.data.success) {
                // URLê³¼ ì›ë³¸ íŒŒì¼ëª…ì„ í•¨ê»˜ ì €ì¥ (URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹)
                const urlWithOriginalName = response.data.original_filename 
                    ? `${response.data.url}#${encodeURIComponent(response.data.original_filename)}`
                    : response.data.url;
                photoUrls.push(urlWithOriginalName);
            }
            
            // ì™„ë£Œ í”„ë¡œê·¸ë ˆìŠ¤
            const completeProgress = ((i + 1) / totalFiles) * 100;
            if (progressBar) progressBar.style.width = `${completeProgress}%`;
        }
        
        document.getElementById('training-photo-urls').value = JSON.stringify(photoUrls);
        updateTrainingPhotoPreview(photoUrls);
        
        // ìë™ ì €ì¥
        const logIdInput = document.getElementById('training-log-id');
        const logId = logIdInput ? logIdInput.value : null;
        
        if (logId) {
            // ê¸°ì¡´ í›ˆë ¨ì¼ì§€ ìˆ˜ì • (í™”ë©´ ìœ ì§€)
            await window.updateTrainingLog(parseInt(logId), true);
        } else {
            // ìƒˆ í›ˆë ¨ì¼ì§€ - hidden inputì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í™”ë©´ ìœ ì§€)
            const timetableId = document.getElementById('training-timetable-id')?.value;
            const courseCode = document.getElementById('training-course-code')?.value;
            const instructorCode = document.getElementById('training-instructor-code')?.value;
            const classDate = document.getElementById('training-class-date')?.value;
            
            if (timetableId && courseCode && instructorCode && classDate) {
                await window.saveTrainingLog(parseInt(timetableId), courseCode, instructorCode, classDate, true);
            }
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) {
            setTimeout(() => {
                progressDiv.classList.add('hidden');
            }, 1000);
        }
        
        // ê³¼ì •ëª…ê³¼ ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const courseCodeInput = document.getElementById('training-course-code');
        const classDateInput = document.getElementById('training-class-date');
        const courseName = courseCodeInput?.dataset?.courseName || '';
        const classDate = classDateInput?.value || '';
        const contextMsg = courseName && classDate ? `${courseName} (${classDate}) í›ˆë ¨ì¼ì§€ì— ` : 'í›ˆë ¨ì¼ì§€ì— ';
        window.showAlert(`${contextMsg}${files.length}ê°œ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
    } catch (error) {
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¸°ê¸°
        if (progressDiv) progressDiv.classList.add('hidden');
        
        console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
    
    event.target.value = '';
}

window.removeTrainingPhoto = async function(index) {
    const photoUrls = JSON.parse(document.getElementById('training-photo-urls').value || '[]');
    photoUrls.splice(index, 1);
    document.getElementById('training-photo-urls').value = JSON.stringify(photoUrls);
    updateTrainingPhotoPreview(photoUrls);
    
    // ìë™ ì €ì¥
    const logIdInput = document.getElementById('training-log-id');
    const logId = logIdInput ? logIdInput.value : null;
    
    if (logId) {
        await window.updateTrainingLog(parseInt(logId), true);
        
        // ê³¼ì •ëª…ê³¼ ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const courseCodeInput = document.getElementById('training-course-code');
        const classDateInput = document.getElementById('training-class-date');
        const courseName = courseCodeInput?.dataset?.courseName || '';
        const classDate = classDateInput?.value || '';
        const contextMsg = courseName && classDate ? `${courseName} (${classDate}) í›ˆë ¨ì¼ì§€ì—ì„œ ` : 'í›ˆë ¨ì¼ì§€ì—ì„œ ';
        window.showAlert(`${contextMsg}ì‚¬ì§„ì´ ì‚­ì œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
}

function updateTrainingPhotoPreview(photoUrls) {
    const previewDiv = document.getElementById('training-photos-preview');
    if (!previewDiv) return;
    
    if (!photoUrls || photoUrls.length === 0) {
        previewDiv.innerHTML = '<p class="text-gray-400 text-sm">ì²¨ë¶€ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    previewDiv.innerHTML = photoUrls.map((url, idx) => 
        window.createFilePreviewItem(url, idx, 'window.removeTrainingPhoto')
    ).join('');
}

window.generateAIContent = async function(timetableId, subjectName, subjectCode, classDate, instructorName, detailLevel = 'normal', timetableType = 'lecture') {
    const contentTextarea = document.getElementById('training-content-textarea');
    const userInput = contentTextarea.value.trim();
    
    // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    const dropdown = document.getElementById('ai-dropdown') || document.getElementById('ai-dropdown-edit');
    if (dropdown) dropdown.classList.add('hidden');
    
    // ì‚¬ìš©ì ì…ë ¥ ì²´í¬
    if (!userInput) {
        window.showAlert('âš ï¸ ìˆ˜ì—… ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!\n\nì˜ˆì‹œ: "HTML, CSS ê¸°ì´ˆ, ë ˆì´ì•„ì›ƒ ì‹¤ìŠµ"');
        contentTextarea.focus();
        return;
    }
    
    // ë¡œë”© í‘œì‹œ
    const originalValue = contentTextarea.value;
    const originalPlaceholder = contentTextarea.placeholder;
    contentTextarea.placeholder = 'ğŸ¤– AIê°€ ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í›ˆë ¨ì¼ì§€ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
    contentTextarea.disabled = true;
    
    // ìƒì„¸ë„ ë ˆë²¨ í•œê¸€ í‘œì‹œ
    const levelText = {
        'summary': 'ìš”ì•½',
        'normal': 'ë³´í†µ',
        'detailed': 'ìƒì„¸'
    };
    
    try {
        // ì„¸ë¶€ êµê³¼ëª© ì •ë³´ ì¡°íšŒ (êµê³¼ëª©ì¸ ê²½ìš°ì—ë§Œ)
        let subSubjects = [];
        if (subjectCode && timetableType === 'lecture') {
            try {
                const subjectRes = await axios.get(`${API_BASE_URL}/api/subjects/${subjectCode}`);
                const subject = subjectRes.data;
                subSubjects = [1, 2, 3, 4, 5]
                    .filter(i => subject[`sub_subject_${i}`] && subject[`sub_subject_${i}`].trim())
                    .map(i => ({
                        name: subject[`sub_subject_${i}`],
                        hours: subject[`sub_hours_${i}`] || 0
                    }));
            } catch (error) {
                console.error('ê³¼ëª© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }
        
        // í”„ë¡œì íŠ¸/í˜„ì¥ì‹¤ìŠµì¼ ë•Œ ê³¼ëª©ëª… ë³€ê²½
        let displaySubjectName = subjectName;
        if (timetableType === 'project') {
            displaySubjectName = 'í”„ë¡œì íŠ¸';
        } else if (timetableType === 'practice') {
            displaySubjectName = 'í˜„ì¥ì‹¤ìŠµ';
        }
        
        // AI ìˆ˜ì—… ë‚´ìš© ìƒì„± API í˜¸ì¶œ
        const response = await axios.post(`${API_BASE_URL}/api/training-logs/generate-content`, {
            subject_name: displaySubjectName,
            sub_subjects: subSubjects,
            class_date: classDate,
            instructor_name: instructorName,
            user_input: userInput,
            detail_level: detailLevel,
            timetable_type: timetableType  // íƒ€ì… ì •ë³´ ì¶”ê°€
        });
        
        // ìƒì„±ëœ ë‚´ìš©ì„ textareaì— ì±„ìš°ê¸°
        contentTextarea.value = response.data.content;
        contentTextarea.disabled = false;
        contentTextarea.placeholder = originalPlaceholder;
        
        // ì„±ê³µ ë©”ì‹œì§€
        window.showAlert(`âœ¨ AIê°€ ${levelText[detailLevel]} ìŠ¤íƒ€ì¼ë¡œ í›ˆë ¨ì¼ì§€ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤!\ní•„ìš”í•˜ë©´ ìˆ˜ì •í•´ì£¼ì„¸ìš”.`);
        
        // textareaì— í¬ì»¤ìŠ¤
        contentTextarea.focus();
    } catch (error) {
        console.error('AI ìƒì„± ì‹¤íŒ¨:', error);
        contentTextarea.value = originalValue;  // ì›ë˜ ë‚´ìš© ë³µì›
        contentTextarea.disabled = false;
        contentTextarea.placeholder = originalPlaceholder;
        
        const errorMsg = error.response?.data?.detail || error.message || 'AI ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
        window.showAlert('âŒ ' + errorMsg + '\n\nì›ë˜ ì…ë ¥í•˜ì‹  ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.');
    }
};

window.saveTrainingLog = async function(timetableId, courseCode, instructorCode, classDate, autoSave = false) {
    const form = document.getElementById('training-log-save-form');
    const formData = new FormData(form);
    const photoUrls = document.getElementById('training-photo-urls').value || '[]';
    
    const data = {
        timetable_id: timetableId,
        course_code: courseCode,
        instructor_code: instructorCode,
        class_date: classDate,
        content: formData.get('content'),
        homework: formData.get('homework'),
        notes: formData.get('notes'),
        photo_urls: photoUrls
    };
    
    try {
        await axios.post(`${API_BASE_URL}/api/training-logs`, data);
        if (!autoSave) {
            window.showAlert('í›ˆë ¨ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.hideTrainingLogForm();
            window.filterTrainingLogs();
        }
    } catch (error) {
        console.error('í›ˆë ¨ì¼ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
        window.showAlert('ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

window.updateTrainingLog = async function(logId, autoSave = false) {
    const form = document.getElementById('training-log-save-form');
    const formData = new FormData(form);
    const photoUrls = document.getElementById('training-photo-urls').value || '[]';
    
    const data = {
        content: formData.get('content'),
        homework: formData.get('homework'),
        notes: formData.get('notes'),
        photo_urls: photoUrls
    };
    
    try {
        await axios.put(`${API_BASE_URL}/api/training-logs/${logId}`, data);
        if (!autoSave) {
            window.showAlert('í›ˆë ¨ì¼ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.hideTrainingLogForm();
            window.filterTrainingLogs();
        }
    } catch (error) {
        console.error('í›ˆë ¨ì¼ì§€ ìˆ˜ì • ì‹¤íŒ¨:', error);
        window.showAlert('ìˆ˜ì • ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

window.deleteTrainingLog = async function(logId) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    const confirmed = await window.showConfirm('ì´ í›ˆë ¨ì¼ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/training-logs/${logId}`);
        window.showAlert('í›ˆë ¨ì¼ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.hideTrainingLogForm();
        window.filterTrainingLogs();
    } catch (error) {
        console.error('í›ˆë ¨ì¼ì§€ ì‚­ì œ ì‹¤íŒ¨:', error);
        window.showAlert('ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

window.hideTrainingLogForm = function() {
    const formDiv = document.getElementById('training-log-form');
    if (formDiv) {
        formDiv.classList.add('hidden');
    }
}

// ==================== AI í›ˆë ¨ì¼ì§€ ====================
let aiTrainingTimetables = []; // AI í›ˆë ¨ì¼ì§€ìš© ì‹œê°„í‘œ ëª©ë¡
let selectedAITimetables = []; // ì„ íƒëœ ì‹œê°„í‘œë“¤

async function loadAITrainingLog() {
    try {
        window.showLoading('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const [coursesRes, subjectsRes, instructorsRes, instructorTypesRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/courses`),
            axios.get(`${API_BASE_URL}/api/subjects`),
            axios.get(`${API_BASE_URL}/api/instructors`),
            axios.get(`${API_BASE_URL}/api/instructor-codes`)
        ]);
        courses = coursesRes.data;
        subjects = subjectsRes.data;
        instructors = instructorsRes.data;
        instructorTypes = instructorTypesRes.data;
        renderAITrainingLog();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('AI í›ˆë ¨ì¼ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderAITrainingLog() {
    const today = new Date().toISOString().split('T')[0];
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-brain mr-2 text-purple-600"></i>AI í›ˆë ¨ì¼ì§€ ìë™ ì‘ì„±
                </h2>
                <p class="text-gray-600">ë¯¸ì‘ì„±ëœ í›ˆë ¨ì¼ì§€ë¥¼ AIê°€ ìë™ìœ¼ë¡œ ì‘ì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
            </div>
            
            <!-- í•„í„° ì˜ì—­ -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <p class="text-blue-700 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    í•„í„° ì¡°ê±´ì„ ì„ íƒí•˜ê³  ê¸°ê°„ì„ ì§€ì •í•˜ì—¬ ë¯¸ì‘ì„±ëœ í›ˆë ¨ì¼ì§€ë¥¼ ì¡°íšŒí•˜ì„¸ìš”
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2">ê³¼ì • ì„ íƒ</label>
                        <select id="ai-course" class="w-full border rounded px-3 py-2">
                            <option value="">-- ì „ì²´ ê³¼ì • --</option>
                            ${courses.map(c => `<option value="${c.code}" ${c.code === 'C-001' ? 'selected' : ''}>${c.name} (${c.code})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ê³¼ëª© ì„ íƒ</label>
                        <select id="ai-subject" class="w-full border rounded px-3 py-2">
                            <option value="">-- ì „ì²´ ê³¼ëª© --</option>
                            ${subjects.map(s => `<option value="${s.code}">${s.name} (${s.code})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ê°•ì‚¬ ì„ íƒ</label>
                        <select id="ai-instructor" class="w-full border rounded px-3 py-2">
                            <option value="" selected>-- ì „ì²´ ê°•ì‚¬ --</option>
                            ${(() => {
                                const loggedInInstructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
                                return instructors.map(i => {
                                    const typeInfo = instructorTypes.find(t => t.code === i.instructor_type);
                                    const typeName = typeInfo ? typeInfo.name : '';
                                    const typeType = typeInfo ? typeInfo.type : '';
                                    const displayMark = i.code === loggedInInstructor.code ? ' (ë‚˜)' : '';
                                    return `<option value="${i.code}">${i.name}${displayMark} - ${i.code} - ${typeName} - ${typeType}</option>`;
                                }).join('');
                            })()}
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">ì‹œì‘ë‚ ì§œ *</label>
                        <input type="date" id="ai-start-date" max="${today}" class="w-full border rounded px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ì¢…ë£Œë‚ ì§œ *</label>
                        <input type="date" id="ai-end-date" value="${today}" max="${today}" class="w-full border rounded px-3 py-2" required>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button onclick="window.searchAITimetables()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-search mr-2"></i>ë¯¸ì‘ì„± í›ˆë ¨ì¼ì§€ ì¡°íšŒ
                    </button>
                </div>
            </div>
            
            <!-- ë¯¸ì‘ì„± í›ˆë ¨ì¼ì§€ ëª©ë¡ -->
            <div id="ai-timetable-list" class="mb-6"></div>
            
            <!-- AI í”„ë¡¬í”„íŠ¸ ê°€ì´ë“œ -->
            <div id="ai-prompt-section" class="hidden mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-magic mr-2 text-purple-600"></i>AI ì‘ì„± ê°€ì´ë“œ
                </h3>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-gray-700 mb-2">í”„ë¡¬í”„íŠ¸ (ì„ íƒì‚¬í•­)</label>
                    <textarea id="ai-prompt" rows="4" class="w-full border rounded px-3 py-2" placeholder="ì˜ˆì‹œ:
- í•™ìƒë“¤ì˜ ì ê·¹ì ì¸ ì°¸ì—¬ë„ë¥¼ ê°•ì¡°í•´ì£¼ì„¸ìš”
- ì‹¤ìŠµ ì¤‘ì‹¬ì˜ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”
- í•™ìƒë“¤ì˜ ì´í•´ë„ê°€ ë†’ì•˜ë‹¤ëŠ” ì ì„ í¬í•¨í•´ì£¼ì„¸ìš”
- í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©ì„ ì¤‘ì ì ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-lightbulb mr-1"></i>
                        AIê°€ í›ˆë ¨ì¼ì§€ë¥¼ ì‘ì„±í•  ë•Œ ì°¸ê³ í•  ê°€ì´ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë¹„ì›Œë‘ë©´ ê¸°ë³¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±ë©ë‹ˆë‹¤)
                    </p>
                </div>
                
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mt-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="delete-before-create" class="mr-3 w-5 h-5 text-red-600">
                        <span class="text-gray-800">
                            <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>
                            <strong class="text-red-700">[í•„ìˆ˜] ê¸°ì¡´ í›ˆë ¨ì¼ì§€ ì‚­ì œ í›„ ì‘ì„±</strong>
                            <span class="block text-sm text-gray-600 mt-1 ml-6">
                                âš ï¸ AI ì‘ì„±ì„ ìœ„í•´ ë°˜ë“œì‹œ ì²´í¬í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¯¸ ì‘ì„±ëœ í›ˆë ¨ì¼ì§€ê°€ ìˆìœ¼ë©´ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
                            </span>
                        </span>
                    </label>
                </div>
                
                <div class="mt-4 flex space-x-2">
                    <button onclick="window.generateAITrainingLogs()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-robot mr-2"></i>ì„ íƒëœ í›ˆë ¨ì¼ì§€ AI ì‘ì„± (<span id="selected-count">0</span>ê±´)
                    </button>
                    <button onclick="window.selectAllAITimetables()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg">
                        <i class="fas fa-check-square mr-2"></i>ì „ì²´ ì„ íƒ
                    </button>
                    <button onclick="window.deselectAllAITimetables()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-3 rounded-lg">
                        <i class="fas fa-square mr-2"></i>ì „ì²´ í•´ì œ
                    </button>
                </div>
            </div>
            
            <!-- AI ì‘ì„± ê²°ê³¼ -->
            <div id="ai-result-section" class="hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-check-circle mr-2 text-green-600"></i>ì‘ì„± ì™„ë£Œ
                </h3>
                <div id="ai-result-content" class="bg-green-50 border-l-4 border-green-400 p-4 rounded"></div>
            </div>
        </div>
    `;
    
    // ê³¼ì • ì„ íƒ ì‹œ ì‹œì‘ì¼ì ìë™ ì„¤ì •
    setTimeout(() => {
        const courseSelect = document.getElementById('ai-course');
        const startDateInput = document.getElementById('ai-start-date');
        
        // ê³¼ì • ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        courseSelect.addEventListener('change', function() {
            const selectedCourseCode = this.value;
            if (selectedCourseCode) {
                const selectedCourse = courses.find(c => c.code === selectedCourseCode);
                if (selectedCourse && selectedCourse.start_date) {
                    // ê³¼ì • ì‹œì‘ì¼ì„ ì‹œì‘ë‚ ì§œë¡œ ì„¤ì •
                    const courseStartDate = selectedCourse.start_date.split('T')[0];
                    startDateInput.value = courseStartDate;
                }
            }
        });
        
        // ì´ˆê¸° ì„ íƒëœ ê³¼ì •ì˜ ì‹œì‘ì¼ ì„¤ì •
        if (courseSelect.value) {
            const initialCourse = courses.find(c => c.code === courseSelect.value);
            if (initialCourse && initialCourse.start_date) {
                const courseStartDate = initialCourse.start_date.split('T')[0];
                startDateInput.value = courseStartDate;
            }
        }
    }, 100);
}

window.searchAITimetables = async function() {
    const courseCode = document.getElementById('ai-course').value;
    const subjectCode = document.getElementById('ai-subject').value;
    const instructorCode = document.getElementById('ai-instructor').value;
    const startDate = document.getElementById('ai-start-date').value;
    const endDate = document.getElementById('ai-end-date').value;
    
    if (!startDate || !endDate) {
        window.showAlert('ì‹œì‘ë‚ ì§œì™€ ì¢…ë£Œë‚ ì§œëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
        return;
    }
    
    if (startDate > endDate) {
        window.showAlert('ì‹œì‘ë‚ ì§œëŠ” ì¢…ë£Œë‚ ì§œë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    try {
        window.showLoading('ë¯¸ì‘ì„± í›ˆë ¨ì¼ì§€ë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘...');
        
        let url = `${API_BASE_URL}/api/timetables?start_date=${startDate}&end_date=${endDate}`;
        if (courseCode) url += `&course_code=${courseCode}`;
        
        const response = await axios.get(url);
        let timetables = response.data;
        
        // ê³¼ëª© í•„í„°
        if (subjectCode) {
            timetables = timetables.filter(tt => tt.subject_code === subjectCode);
        }
        
        // ê°•ì‚¬ í•„í„°
        if (instructorCode) {
            timetables = timetables.filter(tt => tt.instructor_code === instructorCode);
        }
        
        // í›ˆë ¨ì¼ì§€ê°€ ì—†ëŠ” í•­ëª©ë§Œ í•„í„°ë§
        aiTrainingTimetables = timetables.filter(tt => !tt.training_log_id);
        selectedAITimetables = [];
        
        window.hideLoading();
        renderAITimetableList();
        
    } catch (error) {
        window.hideLoading();
        console.error('ì¡°íšŒ ì‹¤íŒ¨:', error);
        window.showAlert('ì¡°íšŒ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

function renderAITimetableList() {
    const listDiv = document.getElementById('ai-timetable-list');
    const promptSection = document.getElementById('ai-prompt-section');
    
    if (aiTrainingTimetables.length === 0) {
        listDiv.innerHTML = `
            <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                <p class="text-green-700">
                    <i class="fas fa-check-circle mr-2"></i>
                    í•´ë‹¹ ê¸°ê°„ì— ë¯¸ì‘ì„±ëœ í›ˆë ¨ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  í›ˆë ¨ì¼ì§€ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
                </p>
            </div>
        `;
        promptSection.classList.remove('hidden');
        return;
    }
    
    // ê³¼ëª©ë³„ë¡œ ê·¸ë£¹í™”í•˜ê³  ì´ ì‹œìˆ˜ ê³„ì‚°
    const subjectGroups = {};
    aiTrainingTimetables.forEach(tt => {
        const subjectKey = tt.subject_code || 'unknown';
        if (!subjectGroups[subjectKey]) {
            subjectGroups[subjectKey] = {
                subject_name: tt.subject_name || tt.subject_code || 'ë¯¸ì •',
                subject_code: tt.subject_code,
                total_hours: 0,
                timetables: []
            };
        }
        
        // í•´ë‹¹ ì‹œê°„í‘œì˜ ì‹œìˆ˜ ê³„ì‚° (ì‹œê°„ ì°¨ì´)
        const duration = calculateDuration(tt.start_time, tt.end_time);
        subjectGroups[subjectKey].timetables.push({
            ...tt,
            duration: duration
        });
        subjectGroups[subjectKey].total_hours += duration;
    });
    
    // ì´ ì‹œìˆ˜ë¥¼ ìœ„í•œ ê³¼ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const subjectTotalHours = {};
    subjects.forEach(s => {
        subjectTotalHours[s.code] = s.hours || 0;
    });
    
    listDiv.innerHTML = `
        <h3 class="text-lg font-semibold text-gray-800 mb-3">
            <i class="fas fa-list mr-2"></i>ë¯¸ì‘ì„± í›ˆë ¨ì¼ì§€ ëª©ë¡ (ì´ ${aiTrainingTimetables.length}ê±´)
        </h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-2 text-left">
                            <input type="checkbox" id="select-all-checkbox" onchange="window.toggleAllAITimetables(this.checked)">
                        </th>
                        <th class="px-4 py-2 text-left">ë‚ ì§œ</th>
                        <th class="px-4 py-2 text-left">ê³¼ì •</th>
                        <th class="px-4 py-2 text-left">ê³¼ëª©</th>
                        <th class="px-4 py-2 text-left">ê°•ì‚¬</th>
                        <th class="px-4 py-2 text-left">ì‹œê°„</th>
                        <th class="px-4 py-2 text-left">í•´ë‹¹ì¼ ì‹œìˆ˜</th>
                        <th class="px-4 py-2 text-left">ì´ ì‹œìˆ˜</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(subjectGroups).map(subjectKey => {
                        const group = subjectGroups[subjectKey];
                        const totalHours = subjectTotalHours[subjectKey] || 0;
                        
                        return group.timetables.map((tt, idx) => {
                            const isFirstRow = idx === 0;
                            const rowspan = group.timetables.length;
                            
                            return `
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="px-4 py-2">
                                        <input type="checkbox" class="ai-timetable-checkbox" data-id="${tt.id}" onchange="window.updateSelectedCount()">
                                    </td>
                                    <td class="px-4 py-2 text-sm">${tt.class_date}</td>
                                    <td class="px-4 py-2 text-sm">${tt.course_name || tt.course_code || '-'}</td>
                                    ${isFirstRow ? `
                                        <td class="px-4 py-2 text-sm font-semibold" rowspan="${rowspan}">
                                            ${group.subject_name}
                                        </td>
                                    ` : ''}
                                    <td class="px-4 py-2 text-sm">${tt.instructor_name || tt.instructor_code || '-'}</td>
                                    <td class="px-4 py-2 text-xs">${formatTime(tt.start_time)} - ${formatTime(tt.end_time)}</td>
                                    <td class="px-4 py-2 text-sm font-semibold text-blue-600">${tt.duration}h</td>
                                    ${isFirstRow ? `
                                        <td class="px-4 py-2 text-sm font-bold text-purple-600" rowspan="${rowspan}">
                                            ${totalHours}h
                                        </td>
                                    ` : ''}
                                </tr>
                            `;
                        }).join('');
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    promptSection.classList.remove('hidden');
    updateSelectedCount();
}

// êµê³¼ëª© ì£¼ì œ ê°€ì ¸ì˜¤ê¸°
function getSubSubjects(subjectCode) {
    const subject = subjects.find(s => s.code === subjectCode);
    if (!subject) return '-';
    
    const subs = [1, 2, 3, 4, 5]
        .filter(i => subject[`sub_subject_${i}`] && subject[`sub_subject_${i}`].trim())
        .map(i => subject[`sub_subject_${i}`]);
    
    return subs.length > 0 ? subs.join(', ') : '-';
}

window.toggleAllAITimetables = function(checked) {
    const checkboxes = document.querySelectorAll('.ai-timetable-checkbox');
    checkboxes.forEach(cb => cb.checked = checked);
    updateSelectedCount();
}

window.selectAllAITimetables = function() {
    document.getElementById('select-all-checkbox').checked = true;
    window.toggleAllAITimetables(true);
}

window.deselectAllAITimetables = function() {
    document.getElementById('select-all-checkbox').checked = false;
    window.toggleAllAITimetables(false);
}

window.updateSelectedCount = function() {
    const checkboxes = document.querySelectorAll('.ai-timetable-checkbox:checked');
    selectedAITimetables = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
    document.getElementById('selected-count').textContent = selectedAITimetables.length;
}

window.generateAITrainingLogs = async function() {
    if (selectedAITimetables.length === 0) {
        window.showAlert('ì‘ì„±í•  í›ˆë ¨ì¼ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const prompt = document.getElementById('ai-prompt').value.trim();
    const deleteBeforeCreate = document.getElementById('delete-before-create').checked;
    
    // ì²´í¬ë°•ìŠ¤ í•„ìˆ˜ í™•ì¸
    if (!deleteBeforeCreate) {
        window.showAlert('âš ï¸ AI í›ˆë ¨ì¼ì§€ ì‘ì„±ì„ í•˜ë ¤ë©´ "ê¸°ì¡´ í›ˆë ¨ì¼ì§€ ì‚­ì œ í›„ ì‘ì„±"ì„ ë°˜ë“œì‹œ ì²´í¬í•´ì•¼ í•©ë‹ˆë‹¤.\n\nì´ë¯¸ ì‘ì„±ëœ í›ˆë ¨ì¼ì§€ê°€ ìˆëŠ” ê²½ìš° ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‘ì„±ë©ë‹ˆë‹¤.');
        
        // ì²´í¬ë°•ìŠ¤ ê°•ì¡° íš¨ê³¼
        const checkbox = document.getElementById('delete-before-create');
        const checkboxParent = checkbox.closest('.bg-yellow-50');
        if (checkboxParent) {
            checkboxParent.classList.add('animate-pulse', 'border-red-500', 'bg-red-50');
            setTimeout(() => {
                checkboxParent.classList.remove('animate-pulse', 'border-red-500', 'bg-red-50');
            }, 2000);
        }
        
        return;
    }
    
    const confirmed = await window.showConfirm(
        `ì„ íƒëœ ${selectedAITimetables.length}ê±´ì˜ í›ˆë ¨ì¼ì§€ë¥¼ AIë¡œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
        `âš ï¸ ê¸°ì¡´ í›ˆë ¨ì¼ì§€ê°€ ìˆìœ¼ë©´ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‘ì„±í•©ë‹ˆë‹¤.\n\n` +
        `ì´ ì‘ì—…ì€ ëª‡ ë¶„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
    );
    
    if (!confirmed) return;
    
    try {
        window.showLoading(`AIê°€ í›ˆë ¨ì¼ì§€ë¥¼ ${deleteBeforeCreate ? 'ì‚­ì œ í›„ ' : ''}ì‘ì„±í•˜ëŠ” ì¤‘... (${selectedAITimetables.length}ê±´)`);
        
        const response = await axios.post(`${API_BASE_URL}/api/ai/generate-training-logs`, {
            timetable_ids: selectedAITimetables,
            prompt: prompt || null,
            delete_before_create: deleteBeforeCreate
        });
        
        window.hideLoading();
        
        const resultSection = document.getElementById('ai-result-section');
        const resultContent = document.getElementById('ai-result-content');
        
        resultContent.innerHTML = `
            <p class="text-green-700 mb-2">
                <i class="fas fa-check-circle mr-2"></i>
                <strong>${response.data.success_count}ê±´</strong>ì˜ í›ˆë ¨ì¼ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            </p>
            ${response.data.failed_count > 0 ? `
                <p class="text-red-700">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    ${response.data.failed_count}ê±´ì˜ í›ˆë ¨ì¼ì§€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                </p>
            ` : ''}
            <div class="mt-4">
                <button onclick="showTab('training-logs')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    í›ˆë ¨ì¼ì§€ ëª©ë¡ìœ¼ë¡œ ì´ë™
                </button>
            </div>
        `;
        
        resultSection.classList.remove('hidden');
        
        // ë‹¤ì‹œ ì¡°íšŒ
        window.searchAITimetables();
        
    } catch (error) {
        window.hideLoading();
        console.error('AI í›ˆë ¨ì¼ì§€ ì‘ì„± ì‹¤íŒ¨:', error);
        window.showAlert('AI í›ˆë ¨ì¼ì§€ ì‘ì„± ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

// ==================== AI ìƒë‹´ì¼ì§€ ìë™ ì‘ì„± ====================
async function loadAICounseling() {
    try {
        window.showLoading('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const [coursesRes, studentsRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/courses`),
            axios.get(`${API_BASE_URL}/api/students`)
        ]);
        courses = coursesRes.data;
        students = studentsRes.data;
        renderAICounseling();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('AI ìƒë‹´ì¼ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderAICounseling() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-comments mr-2 text-purple-600"></i>AI ìƒë‹´ì¼ì§€ ìë™ ì‘ì„±
                </h2>
                <p class="text-gray-600">ë¯¸ìƒë‹´ í•™ìƒì„ ì¡°íšŒí•˜ê³  AIê°€ ìƒë‹´ì¼ì§€ë¥¼ ìë™ìœ¼ë¡œ ì‘ì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
            </div>
            
            <!-- í•„í„° ì˜ì—­ -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <p class="text-blue-700 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    ê³¼ì •ì„ ì„ íƒí•˜ê³  íšŒì°¨ ì¡°ê±´ì„ ì§€ì •í•˜ì—¬ ë¯¸ìƒë‹´ í•™ìƒì„ ì¡°íšŒí•˜ì„¸ìš”
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2">ê³¼ì • ì„ íƒ *</label>
                        <select id="ai-counseling-course" class="w-full border rounded px-3 py-2">
                            <option value="">-- ê³¼ì • ì„ íƒ --</option>
                            ${courses.map(c => `<option value="${c.code}">${c.name} (${c.code})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ìƒë‹´ íšŒì°¨ í•„í„°</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="ai-counseling-count" min="0" value="3" class="w-24 border rounded px-3 py-2">
                            <span class="text-gray-700">íšŒ ì´í•˜</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">ì˜ˆ: 3íšŒ ì´í•˜ = 0~3íšŒ ìƒë‹´í•œ í•™ìƒ ì¡°íšŒ</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button onclick="window.searchUncounseledStudents()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-search mr-2"></i>ë¯¸ìƒë‹´ í•™ìƒ ì¡°íšŒ
                    </button>
                </div>
            </div>
            
            <!-- ë¯¸ìƒë‹´ í•™ìƒ ëª©ë¡ -->
            <div id="ai-counseling-list" class="mb-6"></div>
            
            <!-- AI í”„ë¡¬í”„íŠ¸ ê°€ì´ë“œ -->
            <div id="ai-counseling-prompt-section" class="hidden mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-magic mr-2 text-purple-600"></i>AI ì‘ì„± ê°€ì´ë“œ
                </h3>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-gray-700 mb-2">í”„ë¡¬í”„íŠ¸ (ì„ íƒì‚¬í•­)</label>
                    <textarea id="ai-counseling-prompt" rows="4" class="w-full border rounded px-3 py-2" placeholder="ì˜ˆì‹œ:
- í•™ìƒì˜ í•™ìŠµ íƒœë„ì™€ ì°¸ì—¬ë„ë¥¼ ì¤‘ì ì ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”
- ì§„ë¡œ ìƒë‹´ ë‚´ìš©ì„ í¬í•¨í•´ì£¼ì„¸ìš”
- í•™ìƒì˜ ê°•ì ì„ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰í•´ì£¼ì„¸ìš”
- í–¥í›„ ê°œì„  ë°©í–¥ì„ ì œì‹œí•´ì£¼ì„¸ìš”"></textarea>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-lightbulb mr-1"></i>
                        AIê°€ ìƒë‹´ì¼ì§€ë¥¼ ì‘ì„±í•  ë•Œ ì°¸ê³ í•  ê°€ì´ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë¹„ì›Œë‘ë©´ ê¸°ë³¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±ë©ë‹ˆë‹¤)
                    </p>
                </div>
                
                <div class="mt-4 flex space-x-2">
                    <button onclick="window.generateAICounselingLogs()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-robot mr-2"></i>ì„ íƒëœ í•™ìƒ ìƒë‹´ì¼ì§€ AI ì‘ì„± (<span id="counseling-selected-count">0</span>ê±´)
                    </button>
                    <button onclick="window.selectAllCounselingStudents()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg">
                        <i class="fas fa-check-square mr-2"></i>ì „ì²´ ì„ íƒ
                    </button>
                    <button onclick="window.deselectAllCounselingStudents()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-3 rounded-lg">
                        <i class="fas fa-square mr-2"></i>ì „ì²´ í•´ì œ
                    </button>
                </div>
            </div>
            
            <!-- AI ì‘ì„± ê²°ê³¼ -->
            <div id="ai-counseling-result-section" class="hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-check-circle mr-2 text-green-600"></i>ì‘ì„± ì™„ë£Œ
                </h3>
                <div id="ai-counseling-result-content" class="bg-green-50 border-l-4 border-green-400 p-4 rounded"></div>
            </div>
        </div>
    `;
}

let selectedCounselingStudents = [];

window.searchUncounseledStudents = async function() {
    const courseCode = document.getElementById('ai-counseling-course').value;
    const maxCount = parseInt(document.getElementById('ai-counseling-count').value);
    
    if (!courseCode) {
        window.showAlert('ê³¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (isNaN(maxCount) || maxCount < 0) {
        window.showAlert('ì˜¬ë°”ë¥¸ íšŒì°¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        window.showLoading('ë¯¸ìƒë‹´ í•™ìƒì„ ì¡°íšŒí•˜ëŠ” ì¤‘...');
        
        // ì„ íƒëœ ê³¼ì •ì˜ ëª¨ë“  í•™ìƒ ì¡°íšŒ
        const studentsRes = await axios.get(`${API_BASE_URL}/api/students`);
        const allStudents = studentsRes.data.filter(s => s.course_code === courseCode);
        
        // ê° í•™ìƒì˜ ìƒë‹´ ê¸°ë¡ ì¡°íšŒ
        const counselingsRes = await axios.get(`${API_BASE_URL}/api/counselings`);
        const allCounselings = counselingsRes.data;
        
        // í•™ìƒë³„ ìƒë‹´ íšŸìˆ˜ ê³„ì‚° (student_id ê¸°ì¤€)
        const studentCounselingCount = {};
        allStudents.forEach(student => {
            const count = allCounselings.filter(c => c.student_id === student.id).length;
            studentCounselingCount[student.code] = count;
        });
        
        // í•„í„°ë§: maxCount ì´í•˜ì¸ í•™ìƒë“¤
        const uncounseledStudents = allStudents.filter(student => 
            studentCounselingCount[student.code] <= maxCount
        );
        
        window.hideLoading();
        
        if (uncounseledStudents.length === 0) {
            document.getElementById('ai-counseling-list').innerHTML = `
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <p class="text-yellow-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        ìƒë‹´ ${maxCount}íšŒ ì´í•˜ì¸ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.
                    </p>
                </div>
            `;
            document.getElementById('ai-counseling-prompt-section').classList.add('hidden');
            return;
        }
        
        // ë¯¸ìƒë‹´ í•™ìƒ ëª©ë¡ í‘œì‹œ
        document.getElementById('ai-counseling-list').innerHTML = `
            <div class="bg-white border rounded-lg">
                <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                    <h3 class="font-semibold text-gray-800">
                        <i class="fas fa-users mr-2"></i>ë¯¸ìƒë‹´ í•™ìƒ ëª©ë¡ (ì´ ${uncounseledStudents.length}ëª…)
                    </h3>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="select-all-counseling-checkbox" 
                               onchange="window.toggleAllCounselingStudents(this.checked)" 
                               class="w-4 h-4">
                        <span class="text-sm text-gray-600">ì „ì²´ ì„ íƒ</span>
                    </label>
                </div>
                <div class="divide-y max-h-96 overflow-y-auto">
                    ${uncounseledStudents.map(student => `
                        <div class="px-4 py-3 hover:bg-gray-50 flex items-center justify-between">
                            <label class="flex items-center space-x-3 cursor-pointer flex-1">
                                <input type="checkbox" class="ai-counseling-checkbox w-4 h-4" 
                                       data-code="${student.code}"
                                       onchange="window.updateCounselingSelectedCount()">
                                <div>
                                    <p class="font-medium">${student.name} (${student.code})</p>
                                    <p class="text-sm text-gray-600">
                                        ì—°ë½ì²˜: ${student.phone || '-'} | 
                                        ìƒë‹´ íšŸìˆ˜: ${studentCounselingCount[student.code]}íšŒ
                                    </p>
                                </div>
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        document.getElementById('ai-counseling-prompt-section').classList.remove('hidden');
        selectedCounselingStudents = [];
        updateCounselingSelectedCount();
        
    } catch (error) {
        window.hideLoading();
        console.error('ë¯¸ìƒë‹´ í•™ìƒ ì¡°íšŒ ì‹¤íŒ¨:', error);
        window.showAlert('ë¯¸ìƒë‹´ í•™ìƒ ì¡°íšŒ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

window.toggleAllCounselingStudents = function(checked) {
    const checkboxes = document.querySelectorAll('.ai-counseling-checkbox');
    checkboxes.forEach(cb => cb.checked = checked);
    updateCounselingSelectedCount();
}

window.selectAllCounselingStudents = function() {
    document.getElementById('select-all-counseling-checkbox').checked = true;
    window.toggleAllCounselingStudents(true);
}

window.deselectAllCounselingStudents = function() {
    document.getElementById('select-all-counseling-checkbox').checked = false;
    window.toggleAllCounselingStudents(false);
}

window.updateCounselingSelectedCount = function() {
    const checkboxes = document.querySelectorAll('.ai-counseling-checkbox:checked');
    selectedCounselingStudents = Array.from(checkboxes).map(cb => cb.dataset.code);
    document.getElementById('counseling-selected-count').textContent = selectedCounselingStudents.length;
}

window.generateAICounselingLogs = async function() {
    if (selectedCounselingStudents.length === 0) {
        window.showAlert('ìƒë‹´ì¼ì§€ë¥¼ ì‘ì„±í•  í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const prompt = document.getElementById('ai-counseling-prompt').value.trim();
    const courseCode = document.getElementById('ai-counseling-course').value;
    
    const confirmed = await window.showConfirm(
        `ì„ íƒëœ ${selectedCounselingStudents.length}ëª…ì˜ í•™ìƒì— ëŒ€í•œ ìƒë‹´ì¼ì§€ë¥¼ AIë¡œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
        `ì´ ì‘ì—…ì€ ëª‡ ë¶„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
    );
    
    if (!confirmed) return;
    
    try {
        window.showLoading(`AI ìƒë‹´ì¼ì§€ ì‘ì„± ì¤‘... (0/${selectedCounselingStudents.length})`);
        
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        for (let i = 0; i < selectedCounselingStudents.length; i++) {
            const studentCode = selectedCounselingStudents[i];
            const student = students.find(s => s.code === studentCode);
            
            window.showLoading(`AI ìƒë‹´ì¼ì§€ ì‘ì„± ì¤‘... (${i + 1}/${selectedCounselingStudents.length}) - ${student.name}`);
            
            try {
                await axios.post(`${API_BASE_URL}/api/counselings/ai-generate`, {
                    student_code: studentCode,
                    course_code: courseCode,
                    custom_prompt: prompt
                });
                successCount++;
            } catch (error) {
                console.error(`${student.name} ìƒë‹´ì¼ì§€ ì‘ì„± ì‹¤íŒ¨:`, error);
                failCount++;
                errors.push(`${student.name}: ${error.response?.data?.detail || error.message}`);
            }
        }
        
        window.hideLoading();
        
        // ìµœê·¼ ìƒì„±ëœ ìƒë‹´ì¼ì§€ ì¡°íšŒ
        let generatedCounselingsHTML = '';
        if (successCount > 0) {
            try {
                const counselingsRes = await axios.get(`${API_BASE_URL}/api/counselings`);
                const recentCounselings = counselingsRes.data
                    .filter(c => selectedCounselingStudents.includes(c.student_code))
                    .slice(0, successCount);
                
                generatedCounselingsHTML = `
                    <div class="mt-4 space-y-4">
                        <h4 class="font-semibold text-gray-800">ìƒì„±ëœ ìƒë‹´ì¼ì§€:</h4>
                        ${recentCounselings.map(c => `
                            <details class="bg-white border rounded-lg p-4">
                                <summary class="cursor-pointer font-medium text-blue-600 hover:text-blue-800">
                                    ${c.student_name} (${c.student_code}) - ${c.consultation_date?.split('T')[0]}
                                    <i class="fas fa-chevron-down ml-2 text-sm"></i>
                                </summary>
                                <div class="mt-3 p-3 bg-gray-50 rounded border-l-4 border-blue-400">
                                    <pre class="whitespace-pre-wrap text-sm text-gray-700">${c.content}</pre>
                                </div>
                            </details>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('ìƒë‹´ì¼ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }
        
        const resultSection = document.getElementById('ai-counseling-result-section');
        const resultContent = document.getElementById('ai-counseling-result-content');
        
        resultContent.innerHTML = `
            <p class="font-semibold mb-2">ì‘ì„± ì™„ë£Œ!</p>
            <p class="mb-2">âœ… ì„±ê³µ: ${successCount}ê±´</p>
            ${failCount > 0 ? `
                <p class="mb-2">âŒ ì‹¤íŒ¨: ${failCount}ê±´</p>
                <details class="mt-2">
                    <summary class="cursor-pointer text-red-600">ì‹¤íŒ¨ ìƒì„¸ ë³´ê¸°</summary>
                    <ul class="mt-2 text-sm text-red-600">
                        ${errors.map(err => `<li>â€¢ ${err}</li>`).join('')}
                    </ul>
                </details>
            ` : ''}
            ${generatedCounselingsHTML}
        `;
        
        resultSection.classList.remove('hidden');
        
        // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // ë‹¤ì‹œ ì¡°íšŒ
        window.searchUncounseledStudents();
        
    } catch (error) {
        window.hideLoading();
        console.error('AI ìƒë‹´ì¼ì§€ ì‘ì„± ì‹¤íŒ¨:', error);
        window.showAlert('AI ìƒë‹´ì¼ì§€ ì‘ì„± ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
}

// ==================== AI ì‹œê°„í‘œ ëŒ€ì²´ ====================
async function loadAITimetable() {
    try {
        window.showLoading('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const [coursesRes, timetablesRes, holidaysRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/courses`),
            axios.get(`${API_BASE_URL}/api/timetables`),
            axios.get(`${API_BASE_URL}/api/holidays`)
        ]);
        courses = coursesRes.data;
        window.aiTimetablesData = timetablesRes.data;
        window.aiHolidaysData = holidaysRes.data;
        
        renderAITimetable(window.aiTimetablesData, window.aiHolidaysData);
        renderAITimetableHistory();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('AI ì‹œê°„í‘œ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderAITimetable(timetables, holidays) {
    const app = document.getElementById('app');
    const today = new Date().toISOString().split('T')[0];
    
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-calendar-alt mr-2 text-indigo-600"></i>AI ì‹œê°„í‘œ ëŒ€ì²´
                </h2>
                <p class="text-gray-600">ì‹œê°„í‘œ ë‚ ì§œë¥¼ ë³€ê²½í•˜ê³  ì›ë˜ ë‚ ì§œë¥¼ ê³µíœ´ì¼ë¡œ ìë™ ë“±ë¡í•©ë‹ˆë‹¤.</p>
            </div>
            
            <!-- í•„í„° ì˜ì—­ -->
            <div class="bg-blue-50 border-l-4 border-indigo-400 p-4 mb-6">
                <p class="text-indigo-700 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    ê³¼ì •ê³¼ ì›ë˜ ë‚ ì§œë¥¼ ì„ íƒí•œ í›„, ëŒ€ì²´í•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2 font-semibold">ê³¼ì • ì„ íƒ *</label>
                        <select id="ai-tt-course" class="w-full border rounded px-3 py-2" onchange="window.filterAITimetableDates()">
                            <option value="">-- ê³¼ì • ì„ íƒ --</option>
                            ${courses.map(c => `<option value="${c.code}">${c.name} (${c.code})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2 font-semibold">ì›ë˜ ë‚ ì§œ ì„ íƒ *</label>
                        <select id="ai-tt-original-date" class="w-full border rounded px-3 py-2" onchange="window.showAITimetablePreview()">
                            <option value="">-- ì›ë˜ ë‚ ì§œ ì„ íƒ --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2 font-semibold">ëŒ€ì²´ ë‚ ì§œ ì„ íƒ *</label>
                        <input type="date" id="ai-tt-replacement-date" class="w-full border rounded px-3 py-2" min="${today}">
                    </div>
                </div>
                
                <div class="mt-4">
                    <button onclick="window.replaceAITimetable()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-exchange-alt mr-2"></i>ì‹œê°„í‘œ ëŒ€ì²´ ì‹¤í–‰
                    </button>
                </div>
            </div>
            
            <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
            <div id="ai-tt-preview" class="hidden mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-eye mr-2 text-indigo-600"></i>ì‹œê°„í‘œ ë¯¸ë¦¬ë³´ê¸°
                </h3>
                <div id="ai-tt-preview-content" class="bg-gray-50 p-4 rounded-lg"></div>
            </div>
            
            <!-- ìµœê·¼ ëŒ€ì²´ ì´ë ¥ -->
            <div id="ai-tt-history" class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-history mr-2 text-gray-600"></i>ìµœê·¼ ëŒ€ì²´ ì´ë ¥
                </h3>
                <div id="ai-tt-history-content" class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-center text-gray-500">ëŒ€ì²´ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    `;
    
    // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
    window.aiTimetablesData = timetables;
    window.aiHolidaysData = holidays;
}

// ê³¼ì • ì„ íƒ ì‹œ ë‚ ì§œ ëª©ë¡ ì—…ë°ì´íŠ¸
window.filterAITimetableDates = function() {
    const courseCode = document.getElementById('ai-tt-course').value;
    const originalDateSelect = document.getElementById('ai-tt-original-date');
    
    if (!courseCode) {
        originalDateSelect.innerHTML = '<option value="">-- ì›ë˜ ë‚ ì§œ ì„ íƒ --</option>';
        return;
    }
    
    // í•´ë‹¹ ê³¼ì •ì˜ ì‹œê°„í‘œ ë‚ ì§œ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
    const courseTimetables = window.aiTimetablesData.filter(t => t.course_code === courseCode);
    const uniqueDates = [...new Set(courseTimetables.map(t => t.class_date))].sort();
    
    originalDateSelect.innerHTML = `
        <option value="">-- ì›ë˜ ë‚ ì§œ ì„ íƒ --</option>
        ${uniqueDates.map(date => {
            const dateObj = new Date(date);
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayOfWeek = dayNames[dateObj.getDay()];
            const count = courseTimetables.filter(t => t.class_date === date).length;
            return `<option value="${date}">${date} (${dayOfWeek}) - ${count}ê°œ ì‹œê°„í‘œ</option>`;
        }).join('')}
    `;
};

// ì‹œê°„í‘œ ë¯¸ë¦¬ë³´ê¸°
window.showAITimetablePreview = function() {
    const courseCode = document.getElementById('ai-tt-course').value;
    const originalDate = document.getElementById('ai-tt-original-date').value;
    const previewSection = document.getElementById('ai-tt-preview');
    const previewContent = document.getElementById('ai-tt-preview-content');
    
    if (!courseCode || !originalDate) {
        previewSection.classList.add('hidden');
        return;
    }
    
    // í•´ë‹¹ ë‚ ì§œì˜ ì‹œê°„í‘œ ì¡°íšŒ
    const dateTimetables = window.aiTimetablesData.filter(
        t => t.course_code === courseCode && t.class_date === originalDate
    );
    
    if (dateTimetables.length === 0) {
        previewContent.innerHTML = '<p class="text-gray-500">í•´ë‹¹ ë‚ ì§œì— ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        previewSection.classList.remove('hidden');
        return;
    }
    
    previewContent.innerHTML = `
        <div class="space-y-2">
            <p class="font-semibold text-gray-800 mb-3">ì´ ${dateTimetables.length}ê°œì˜ ì‹œê°„í‘œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            ${dateTimetables.map((tt, idx) => `
                <div class="flex items-center justify-between p-3 bg-white rounded border">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${idx + 1}. ${tt.subject_name || tt.subject_code || 'ê³¼ëª© ë¯¸ì •'}</p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-clock mr-1"></i>${tt.start_time} ~ ${tt.end_time}
                            <span class="mx-2">|</span>
                            <i class="fas fa-chalkboard-teacher mr-1"></i>${tt.instructor_name || tt.instructor_code || 'ê°•ì‚¬ ë¯¸ì •'}
                        </p>
                    </div>
                    <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm font-semibold">
                        ${tt.type === 'lecture' ? 'êµê³¼' : tt.type === 'project' ? 'í”„ë¡œì íŠ¸' : 'í˜„ì¥ì‹¤ìŠµ'}
                    </span>
                </div>
            `).join('')}
        </div>
        <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
            <p class="text-yellow-700 text-sm">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>ì£¼ì˜:</strong> ì›ë˜ ë‚ ì§œ ${originalDate}ëŠ” "ê³µê°•/ëŒ€ì²´(ëŒ€ì²´ë‚ ì§œ)" ê³µíœ´ì¼ë¡œ ìë™ ë“±ë¡ë©ë‹ˆë‹¤.
            </p>
        </div>
    `;
    
    previewSection.classList.remove('hidden');
};

// ì‹œê°„í‘œ ëŒ€ì²´ ì‹¤í–‰
window.replaceAITimetable = async function() {
    const courseCode = document.getElementById('ai-tt-course').value;
    const originalDate = document.getElementById('ai-tt-original-date').value;
    const replacementDate = document.getElementById('ai-tt-replacement-date').value;
    
    if (!courseCode || !originalDate || !replacementDate) {
        window.showAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (originalDate === replacementDate) {
        window.showAlert('ì›ë˜ ë‚ ì§œì™€ ëŒ€ì²´ ë‚ ì§œê°€ ê°™ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // í•´ë‹¹ ë‚ ì§œì˜ ì‹œê°„í‘œ ìˆ˜ í™•ì¸
    const dateTimetables = window.aiTimetablesData.filter(
        t => t.course_code === courseCode && t.class_date === originalDate
    );
    
    const confirmed = await window.showConfirm(
        `${originalDate}ì˜ ì‹œê°„í‘œ ${dateTimetables.length}ê±´ì„ ${replacementDate}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
        `âœ… ${originalDate} ì‹œê°„í‘œ ì‚­ì œ í›„ ${replacementDate}ë¡œ ëŒ€ì²´\n` +
        `âœ… ${originalDate}ë¥¼ "ê³µê°•/ëŒ€ì²´(${replacementDate})" ê³µíœ´ì¼ë¡œ ë“±ë¡\n\n` +
        `ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
        'ì‹œê°„í‘œ ëŒ€ì²´ í™•ì¸'
    );
    
    if (!confirmed) return;
    
    try {
        window.showLoading('ì‹œê°„í‘œë¥¼ ëŒ€ì²´í•˜ëŠ” ì¤‘...');
        
        const response = await axios.post(`${API_BASE_URL}/api/ai/replace-timetable`, {
            course_code: courseCode,
            original_date: originalDate,
            replacement_date: replacementDate
        });
        
        window.hideLoading();
        
        await window.showAlert(
            `âœ… ì‹œê°„í‘œ ëŒ€ì²´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
            `- ë³€ê²½ëœ ì‹œê°„í‘œ: ${response.data.timetables_updated}ê±´\n` +
            `- ë“±ë¡ëœ ê³µíœ´ì¼: ${originalDate} (ê³µê°•/ëŒ€ì²´(${replacementDate}))`
        );
        
        // í˜ì´ì§€ ì™„ì „ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë°ì´í„° ê°±ì‹ 
        location.reload();
        
    } catch (error) {
        window.hideLoading();
        console.error('ì‹œê°„í‘œ ëŒ€ì²´ ì‹¤íŒ¨:', error);
        window.showAlert('ì‹œê°„í‘œ ëŒ€ì²´ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message));
    }
};

// AI ì‹œê°„í‘œ ëŒ€ì²´ ì´ë ¥ ë Œë”ë§
function renderAITimetableHistory() {
    const historyDiv = document.getElementById('ai-tt-history-content');
    if (!historyDiv) return;
    
    const holidays = window.aiHolidaysData || [];
    
    // ëŒ€ì²´ ì´ë ¥ë§Œ í•„í„°ë§ (ê³µê°•/ëŒ€ì²´ë¡œ ì‹œì‘í•˜ëŠ” ê³µíœ´ì¼)
    const replacementHistory = holidays
        .filter(h => h.name && h.name.startsWith('ê³µê°•/ëŒ€ì²´'))
        .sort((a, b) => new Date(b.holiday_date) - new Date(a.holiday_date));
    
    if (replacementHistory.length === 0) {
        historyDiv.innerHTML = `
            <div class="text-center text-gray-500">
                <i class="fas fa-info-circle mr-2"></i>
                ì•„ì§ ëŒ€ì²´ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        `;
        return;
    }
    
    // ëŒ€ì²´ ë‚ ì§œ ì¶”ì¶œ (ê³µê°•/ëŒ€ì²´(2026-01-10) â†’ 2026-01-10)
    const parseReplacementDate = (name) => {
        const match = name.match(/ê³µê°•\/ëŒ€ì²´\(([0-9-]+)\)/);
        return match ? match[1] : 'ì•Œ ìˆ˜ ì—†ìŒ';
    };
    
    historyDiv.innerHTML = `
        <div class="space-y-2">
            ${replacementHistory.map(h => {
                const replacementDate = parseReplacementDate(h.name);
                const originalDate = h.holiday_date;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exchange-alt text-indigo-600 text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">
                                        <span class="text-red-600">${originalDate}</span>
                                        <i class="fas fa-arrow-right mx-2 text-gray-400"></i>
                                        <span class="text-green-600">${replacementDate}</span>
                                    </div>
                                    <div class="text-sm text-gray-500 mt-1">
                                        ì›ë˜ ë‚ ì§œê°€ ê³µíœ´ì¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-400">
                                ${new Date(h.created_at).toLocaleString('ko-KR')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        
        <div class="mt-4 text-sm text-gray-500 text-center">
            <i class="fas fa-info-circle mr-1"></i>
            ì´ ${replacementHistory.length}ê±´ì˜ ëŒ€ì²´ ì´ë ¥
        </div>
    `;
}

console.log('App script loaded successfully');

// ==================== PWA ê¸°ëŠ¥: ì˜¤í”„ë¼ì¸ ê°ì§€ ====================

// ì˜¤í”„ë¼ì¸ ì¸ë””ì¼€ì´í„° ìƒì„±
function createOfflineIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'offline-indicator';
    indicator.className = 'offline-indicator';
    indicator.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i>ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”';
    document.body.insertBefore(indicator, document.body.firstChild);
    return indicator;
}

// ì˜¤í”„ë¼ì¸/ì˜¨ë¼ì¸ ìƒíƒœ ê°ì§€
window.addEventListener('online', () => {
    console.log('âœ… ì˜¨ë¼ì¸ ìƒíƒœ');
    const indicator = document.getElementById('offline-indicator');
    if (indicator) {
        indicator.classList.remove('show');
        setTimeout(() => indicator.remove(), 300);
    }
    
    // ì˜¨ë¼ì¸ ë³µêµ¬ ì•Œë¦¼
    if (typeof showAlert === 'function') {
        showAlert('ì¸í„°ë„· ì—°ê²°ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
});

window.addEventListener('offline', () => {
    console.log('âŒ ì˜¤í”„ë¼ì¸ ìƒíƒœ');
    let indicator = document.getElementById('offline-indicator');
    if (!indicator) {
        indicator = createOfflineIndicator();
    }
    indicator.classList.add('show');
    
    // ì˜¤í”„ë¼ì¸ ì•Œë¦¼
    if (typeof showAlert === 'function') {
        showAlert('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
    }
});

// ì´ˆê¸° ì˜¤í”„ë¼ì¸ ìƒíƒœ í™•ì¸
if (!navigator.onLine) {
    const indicator = createOfflineIndicator();
    indicator.classList.add('show');
}

// ==================== PWA ê¸°ëŠ¥: ì•± ì—…ë°ì´íŠ¸ ê°ì§€ ====================

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('ğŸ”„ Service Worker ì—…ë°ì´íŠ¸ ê°ì§€');
        if (typeof showAlert === 'function') {
            showAlert('ì•±ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }
    });
}

// ==================== PWA ê¸°ëŠ¥: ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™” (ë¯¸ë˜ í™•ì¥ìš©) ====================

// ì˜¤í”„ë¼ì¸ì—ì„œ ì‘ì„±í•œ ë°ì´í„°ë¥¼ ì €ì¥
window.saveOfflineData = function(type, data) {
    const offlineData = JSON.parse(localStorage.getItem('offline_data') || '[]');
    offlineData.push({
        type,
        data,
        timestamp: Date.now()
    });
    localStorage.setItem('offline_data', JSON.stringify(offlineData));
    console.log('ğŸ’¾ ì˜¤í”„ë¼ì¸ ë°ì´í„° ì €ì¥:', type);
};

// ì˜¨ë¼ì¸ ë³µêµ¬ ì‹œ ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™”
window.syncOfflineData = async function() {
    const offlineData = JSON.parse(localStorage.getItem('offline_data') || '[]');
    
    if (offlineData.length === 0) {
        return;
    }
    
    console.log(`ğŸ”„ ${offlineData.length}ê°œ ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™” ì‹œì‘...`);
    
    for (const item of offlineData) {
        try {
            // ê° ë°ì´í„° íƒ€ì…ì— ë§ëŠ” API í˜¸ì¶œ
            if (item.type === 'counseling') {
                await axios.post(`${API_BASE_URL}/api/counselings`, item.data);
            } else if (item.type === 'training-log') {
                await axios.post(`${API_BASE_URL}/api/training-logs`, item.data);
            }
            console.log('âœ… ë™ê¸°í™” ì„±ê³µ:', item.type);
        } catch (error) {
            console.error('âŒ ë™ê¸°í™” ì‹¤íŒ¨:', item.type, error);
        }
    }
    
    // ë™ê¸°í™” ì™„ë£Œ í›„ ì˜¤í”„ë¼ì¸ ë°ì´í„° ì‚­ì œ
    localStorage.removeItem('offline_data');
    console.log('âœ¨ ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
};

// ì˜¨ë¼ì¸ ë³µêµ¬ ì‹œ ìë™ ë™ê¸°í™”
window.addEventListener('online', () => {
    setTimeout(() => {
        window.syncOfflineData();
    }, 1000);
});

console.log('âœ… PWA ê¸°ëŠ¥ ì´ˆê¸°í™” ì™„ë£Œ');

// ==================== ë¡œê·¸ì¸ ê´€ë¦¬ (ì£¼ê°•ì‚¬ ì „ìš©) ====================
async function loadLoginManagement() {
    // ì£¼ê°•ì‚¬ ê¶Œí•œ ì²´í¬
    if (!isMainInstructor()) {
        document.getElementById('app').innerHTML = `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-center text-red-600">
                    <i class="fas fa-lock text-6xl mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h2>
                    <p>ì´ ë©”ë‰´ëŠ” ì£¼ê°•ì‚¬ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        `;
        return;
    }
    
    try {
        window.showLoading('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        // ëª¨ë“  ê°•ì‚¬ ì •ë³´ ì¡°íšŒ
        const instructorsRes = await axios.get(`${API_BASE_URL}/api/instructors`);
        const instructors = instructorsRes.data;
        
        window.hideLoading();
        
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-key mr-2"></i>ë¡œê·¸ì¸ ê´€ë¦¬ (ì£¼ê°•ì‚¬ ì „ìš©)
                    </h2>
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        ê°•ì‚¬ë³„ ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </div>
                </div>
                
                <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-shield-alt mr-2"></i>
                        <strong>ë³´ì•ˆ ì•ˆë‚´:</strong> ë¹„ë°€ë²ˆí˜¸ëŠ” ì•ˆì „í•˜ê²Œ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤. 
                        ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ëŠ” <code class="bg-blue-100 px-2 py-1 rounded">kdt2025</code>ì…ë‹ˆë‹¤.
                    </p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">ê°•ì‚¬ì½”ë“œ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">ì´ë¦„</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">êµ¬ë¶„</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">íƒ€ì…</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${instructors.map(inst => `
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm font-mono">${inst.code}</td>
                                    <td class="px-4 py-3 text-sm font-semibold">${inst.name}</td>
                                    <td class="px-4 py-3 text-sm">${inst.instructor_type_name || '-'}</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span class="px-2 py-1 rounded text-xs ${
                                            inst.instructor_type_type === '1. ì£¼ê°•ì‚¬' ? 'bg-blue-100 text-blue-800' :
                                            inst.instructor_type_type === '2. ë³´ì¡°ê°•ì‚¬' ? 'bg-green-100 text-green-800' :
                                            inst.instructor_type_type === '3. ë©˜í† ' ? 'bg-purple-100 text-purple-800' :
                                            inst.instructor_type_type === '4. í–‰ì •ì§€ì›' ? 'bg-yellow-100 text-yellow-800' :
                                            inst.instructor_type_type === '5. ê°€ë””ì–¸' ? 'bg-pink-100 text-pink-800' :
                                            'bg-gray-100 text-gray-800'
                                        }">
                                            ${inst.instructor_type_type || '-'}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <span class="text-gray-500">
                                            <i class="fas fa-lock mr-1"></i>
                                            ${inst.password === 'kdt2025' ? 'ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸' : 'ë³€ê²½ë¨'}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <button onclick="window.showPasswordChangeForm('${inst.code}', '${inst.name}')" 
                                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs mr-2">
                                            <i class="fas fa-key mr-1"></i>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                                        </button>
                                        <button onclick="window.resetPassword('${inst.code}', '${inst.name}')" 
                                                class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                                            <i class="fas fa-redo mr-1"></i>ì´ˆê¸°í™”
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼ -->
                <div id="password-change-form" class="hidden mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-bold mb-4">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê°•ì‚¬</label>
                            <input type="text" id="pwd-instructor-name" readonly 
                                   class="w-full px-3 py-2 border rounded bg-gray-100">
                            <input type="hidden" id="pwd-instructor-code">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒˆ ë¹„ë°€ë²ˆí˜¸ *</label>
                            <input type="password" id="pwd-new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" 
                                   class="w-full px-3 py-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                ì˜ë¬¸, ìˆ«ì ì¡°í•© 4ì ì´ìƒ
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
                            <input type="password" id="pwd-confirm-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" 
                                   class="w-full px-3 py-2 border rounded">
                        </div>
                    </div>
                    <div class="mt-4 space-x-2">
                        <button onclick="window.changePassword()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-save mr-2"></i>ë³€ê²½
                        </button>
                        <button onclick="window.hidePasswordChangeForm()" 
                                class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        window.hideLoading();
        console.error('ë¡œê·¸ì¸ ê´€ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ë¡œê·¸ì¸ ê´€ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼ í‘œì‹œ
window.showPasswordChangeForm = function(code, name) {
    const formDiv = document.getElementById('password-change-form');
    document.getElementById('pwd-instructor-code').value = code;
    document.getElementById('pwd-instructor-name').value = `${name} (${code})`;
    document.getElementById('pwd-new-password').value = '';
    document.getElementById('pwd-confirm-password').value = '';
    formDiv.classList.remove('hidden');
    formDiv.scrollIntoView({ behavior: 'smooth' });
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼ ìˆ¨ê¸°ê¸°
window.hidePasswordChangeForm = function() {
    document.getElementById('password-change-form').classList.add('hidden');
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
window.changePassword = async function() {
    const code = document.getElementById('pwd-instructor-code').value;
    const newPassword = document.getElementById('pwd-new-password').value;
    const confirmPassword = document.getElementById('pwd-confirm-password').value;
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!newPassword) {
        window.showAlert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    
    if (newPassword.length < 4) {
        window.showAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        window.showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    try {
        await axios.post(`${API_BASE_URL}/api/auth/change-password`, {
            instructor_code: code,
            new_password: newPassword
        });
        
        window.showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.hidePasswordChangeForm();
        loadLoginManagement(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } catch (error) {
        console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:', error);
        window.showAlert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message));
    }
}

// ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
window.resetPassword = async function(code, name) {
    const confirmed = await window.showConfirm(`${name} ê°•ì‚¬ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê¸°ë³¸ê°’(kdt2025)ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if (!confirmed) return;
    
    try {
        await axios.post(`${API_BASE_URL}/api/auth/change-password`, {
            instructor_code: code,
            new_password: 'kdt2025'
        });
        
        window.showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ê¸°ë³¸ê°’: kdt2025)');
        loadLoginManagement(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } catch (error) {
        console.error('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        window.showAlert('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message));
    }
}

// ==================== ì‹œìŠ¤í…œ ì„¤ì • ====================
async function loadSystemSettings() {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/system-settings`);
        const settings = response.data;
        renderSystemSettings(settings);
    } catch (error) {
        console.error('ì‹œìŠ¤í…œ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('app').innerHTML = '<div class="text-red-600 p-4">ì‹œìŠ¤í…œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

function renderSystemSettings(settings) {
    console.log('ğŸ¨ ì‹œìŠ¤í…œ ì„¤ì • í¼ ë Œë”ë§:', settings);
    
    const app = document.getElementById('app');
    
    // HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    const escapeHtml = (str) => {
        if (!str) return '';
        return str.replace(/"/g, '&quot;')
                  .replace(/'/g, '&#39;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;');
    };
    
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-cog mr-2"></i>ì‹œìŠ¤í…œ ë“±ë¡
                </h2>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6 border-l-4 border-blue-500">
                <p class="text-gray-700 mb-2">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                    ì‹œìŠ¤í…œ ì œëª©, ë¶€ì œëª©, ë¡œê³ ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <p class="text-sm text-gray-600">
                    ì„¤ì •í•œ ë‚´ìš©ì€ í—¤ë”ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
                </p>
            </div>
            
            <form id="system-settings-form" class="space-y-6">
                <!-- ì‹œìŠ¤í…œ ì •ë³´ ì„¤ì • ë°•ìŠ¤ -->
                <div class="p-6 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border-2 border-blue-200 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cog mr-2 text-blue-600"></i>
                        ì‹œìŠ¤í…œ ì •ë³´ ì„¤ì •
                    </h3>
                    
                    <!-- í° ì œëª© -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-heading mr-2 text-blue-500"></i>í° ì œëª© (ì‹œìŠ¤í…œ ì´ë¦„)
                        </label>
                        <input type="text" id="system-title" 
                               class="w-full px-4 py-3 border rounded-lg text-lg focus:ring-2 focus:ring-blue-500 bg-white"
                               placeholder="ì˜ˆ: ${DEFAULT_SYSTEM_TITLE}">
                        <p class="text-sm text-gray-600 mt-1">í—¤ë” ìƒë‹¨ì— í‘œì‹œë˜ëŠ” ë©”ì¸ ì œëª©ì…ë‹ˆë‹¤</p>
                    </div>
                    
                    <!-- ì‘ì€ ì œëª© 1ì¤„ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-align-left mr-2 text-green-500"></i>ì‘ì€ ì œëª© (1ì¤„)
                        </label>
                        <input type="text" id="system-subtitle1" 
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white"
                               placeholder="ì˜ˆ: ë³´ê±´ë³µì§€ë¶€(í•œêµ­ë³´ê±´ì‚°ì—…ì§„í¥ì›), KDT, ìš°ì†¡ëŒ€í•™êµì‚°í•™í˜‘ë ¥ë‹¨">
                        <p class="text-sm text-gray-600 mt-1">í—¤ë” í•˜ë‹¨ ì²« ë²ˆì§¸ ì¤„ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                    
                    <!-- ì‘ì€ ì œëª© 2ì¤„ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-align-left mr-2 text-green-500"></i>ì‘ì€ ì œëª© (2ì¤„)
                        </label>
                        <input type="text" id="system-subtitle2" 
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white"
                               placeholder="ì˜ˆ: ë°”ì´ì˜¤í—¬ìŠ¤ì•„ì¹´ë°ë¯¸ ì˜¬ì¸ì›í…Œí¬ ì´ë…¸ë² ì´í„°">
                        <p class="text-sm text-gray-600 mt-1">í—¤ë” í•˜ë‹¨ ë‘ ë²ˆì§¸ ì¤„ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                    
                    <!-- ë¡œê³  ì´ë¯¸ì§€ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-image mr-2 text-purple-500"></i>ë¡œê³  ì´ë¯¸ì§€
                        </label>
                        
                        <!-- í˜„ì¬ ë¡œê³  ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="mb-4 p-4 bg-white rounded-lg border-2 border-dashed border-gray-300">
                            <p class="text-sm text-gray-600 mb-2">í˜„ì¬ ë¡œê³ :</p>
                            <img id="current-logo"
                                 alt="í˜„ì¬ ë¡œê³ " class="max-h-40 max-w-full object-contain bg-white p-2 rounded shadow-sm"
                                 onerror="this.style.display='none'">
                        </div>
                        
                        <!-- ë¡œê³  ì—…ë¡œë“œ -->
                        <div class="space-y-3">
                            <input type="file" id="logo-file" accept="image/*" 
                                   onchange="window.handleLogoUpload(event)"
                                   class="w-full px-3 py-2 border rounded-lg bg-white">
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-info-circle mr-1"></i>
                                ê¶Œì¥: PNG, íˆ¬ëª… ë°°ê²½, ê°€ë¡œ 300px ì´ìƒ
                            </p>
                        </div>
                        
                        <input type="hidden" id="logo-url">
                    </div>

                    <!-- íŒŒë¹„ì½˜ URL -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-star mr-2 text-yellow-500"></i>íŒŒë¹„ì½˜ (Favicon)
                        </label>
                        <div class="flex items-center gap-4">
                            <img id="current-favicon" src="/favicon.ico" alt="í˜„ì¬ íŒŒë¹„ì½˜"
                                 class="w-16 h-16 object-contain border-2 border-gray-200 rounded-lg p-2 bg-white"
                                 onerror="this.src='/favicon.ico'">
                            <div class="flex-1">
                                <input type="file" id="favicon-upload" accept="image/*" class="hidden"
                                       onchange="window.handleFaviconUpload(event)">
                                <button type="button"
                                        onclick="document.getElementById('favicon-upload').click()"
                                        class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-all">
                                    <i class="fas fa-upload mr-2"></i>íŒŒë¹„ì½˜ ì—…ë¡œë“œ
                                </button>
                                <p class="text-sm text-gray-600 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ê¶Œì¥: ICO ë˜ëŠ” PNG, 16x16 ~ 512x512px
                                </p>
                            </div>
                        </div>

                        <input type="hidden" id="favicon-url">
                    </div>

                    <!-- ëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-sync-alt mr-2 text-orange-500"></i>ëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œê°„
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="refresh-interval" min="1" max="60" step="1"
                                   class="w-32 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white"
                                   placeholder="5">
                            <span class="text-gray-700">ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ëŒ€ì‹œë³´ë“œê°€ ìë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ëŠ” ì‹œê°„ ê°„ê²©ì…ë‹ˆë‹¤ (1~60ë¶„, ê¸°ë³¸ê°’: 5ë¶„)
                        </p>
                        <p class="text-sm text-gray-500 mt-1">
                            ğŸ’¡ ìƒˆë¡œê³ ì¹¨ ì‹œ 10ì´ˆê°„ í™”ë©´ë³´í˜¸ê¸°(ë¡œê³  ì• ë‹ˆë©”ì´ì…˜)ê°€ í‘œì‹œë©ë‹ˆë‹¤
                        </p>
                    </div>
                </div>

                <!-- ì‹ ê·œê°€ì… ì„¤ì • ì„¹ì…˜ -->
                <div class="p-6 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border-2 border-orange-200 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-user-plus mr-2 text-orange-600"></i>
                        ì‹ ê·œê°€ì… ì„¤ì •
                    </h3>

                    <!-- ëª¨ì§‘ì¤‘ì¸ ê³¼ì • -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-book-open mr-2 text-orange-500"></i>ëª¨ì§‘ì¤‘ì¸ ê³¼ì •
                        </label>
                        <div id="open-courses-checkboxes" class="grid grid-cols-2 md:grid-cols-3 gap-3 p-4 bg-white rounded-lg border border-gray-200">
                            <!-- ê³¼ì • ì²´í¬ë°•ìŠ¤ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        <input type="hidden" id="open-courses">
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ì„ íƒí•œ ê³¼ì •ë§Œ ì‹ ê·œê°€ì… í˜ì´ì§€ì—ì„œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ì „ì²´ ê³¼ì •ì´ í‘œì‹œë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- ê´€ì‹¬ë¶„ì•¼ í‚¤ì›Œë“œ -->
                    <div class="mt-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-heart mr-2 text-red-500"></i>ê´€ì‹¬ë¶„ì•¼ í‚¤ì›Œë“œ
                        </label>
                        <input type="text" id="interest-keywords"
                               placeholder="ì˜ˆ: AI, ë¡œë´‡, ë¹…ë°ì´í„°, í”„ë¡œê·¸ë˜ë°, í—¬ìŠ¤ì¼€ì–´ (ì‰¼í‘œë¡œ êµ¬ë¶„)"
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-orange-500 bg-white">
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”. ì‹ ê·œê°€ì… í˜ì´ì§€ì—ì„œ ì²´í¬ë°•ìŠ¤ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- ë¡œê·¸ì¸ í˜ì´ì§€ ë²„íŠ¼ ì„¤ì • -->
                    <div class="mt-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-sign-in-alt mr-2 text-blue-500"></i>ë¡œê·¸ì¸ í˜ì´ì§€ ë²„íŠ¼ í‘œì‹œ
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 p-4 bg-white rounded-lg border border-gray-200">
                            <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50">
                                <input type="checkbox" id="login-show-register" class="w-5 h-5 text-blue-600 rounded"
                                       ${settings.login_show_register !== 'false' ? 'checked' : ''}>
                                <span class="text-sm"><i class="fas fa-user-plus mr-1 text-blue-500"></i>ì‹ ê·œê°€ì…</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50">
                                <input type="checkbox" id="login-show-course-intro" class="w-5 h-5 text-green-600 rounded"
                                       ${settings.login_show_course_intro !== 'false' ? 'checked' : ''}>
                                <span class="text-sm"><i class="fas fa-info-circle mr-1 text-green-500"></i>ê³¼ì •ì†Œê°œ</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50">
                                <input type="checkbox" id="login-show-education-support" class="w-5 h-5 text-purple-600 rounded"
                                       ${settings.login_show_education_support !== 'false' ? 'checked' : ''}>
                                <span class="text-sm"><i class="fas fa-hand-holding-usd mr-1 text-purple-500"></i>êµìœ¡ì§€ì›ì œë„</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50">
                                <input type="checkbox" id="login-show-facebook" class="w-5 h-5 text-blue-600 rounded"
                                       ${settings.login_show_facebook !== 'false' ? 'checked' : ''}>
                                <span class="text-sm"><i class="fab fa-facebook mr-1 text-blue-600"></i>í˜ì´ìŠ¤ë¶</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50">
                                <input type="checkbox" id="login-show-instagram" class="w-5 h-5 text-pink-600 rounded"
                                       ${settings.login_show_instagram !== 'false' ? 'checked' : ''}>
                                <span class="text-sm"><i class="fab fa-instagram mr-1 text-pink-500"></i>ì¸ìŠ¤íƒ€ê·¸ë¨</span>
                            </label>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ì²´í¬í•˜ì§€ ì•Šì€ ë²„íŠ¼ì€ ë¡œê·¸ì¸ í˜ì´ì§€ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                </div>

                <!-- í…Œë§ˆ ì„¤ì • ì„¹ì…˜ -->
                <div class="p-6 bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl border-2 border-pink-200 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-palette mr-2 text-pink-600"></i>
                        í…Œë§ˆ ìƒ‰ìƒ ì„¤ì •
                    </h3>

                    <!-- í”„ë¦¬ì…‹ í…Œë§ˆ ì„ íƒ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-swatchbook mr-2 text-purple-500"></i>í”„ë¦¬ì…‹ í…Œë§ˆ
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="theme-presets">
                            <button type="button" onclick="window.applyPresetTheme('default')"
                                class="theme-preset-btn p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 transition-all">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-4 h-4 rounded-full bg-blue-600"></span>
                                    <span class="w-4 h-4 rounded-full bg-blue-800"></span>
                                    <span class="w-4 h-4 rounded-full bg-gray-700"></span>
                                </div>
                                <span class="text-sm font-medium">ê¸°ë³¸ (ë¸”ë£¨)</span>
                            </button>
                            <button type="button" onclick="window.applyPresetTheme('green')"
                                class="theme-preset-btn p-3 rounded-lg border-2 border-gray-200 hover:border-green-400 transition-all">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-4 h-4 rounded-full bg-green-600"></span>
                                    <span class="w-4 h-4 rounded-full bg-green-800"></span>
                                    <span class="w-4 h-4 rounded-full bg-gray-700"></span>
                                </div>
                                <span class="text-sm font-medium">ìì—° (ê·¸ë¦°)</span>
                            </button>
                            <button type="button" onclick="window.applyPresetTheme('purple')"
                                class="theme-preset-btn p-3 rounded-lg border-2 border-gray-200 hover:border-purple-400 transition-all">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-4 h-4 rounded-full bg-purple-600"></span>
                                    <span class="w-4 h-4 rounded-full bg-purple-800"></span>
                                    <span class="w-4 h-4 rounded-full bg-gray-700"></span>
                                </div>
                                <span class="text-sm font-medium">ìš°ì•„í•¨ (í¼í”Œ)</span>
                            </button>
                            <button type="button" onclick="window.applyPresetTheme('orange')"
                                class="theme-preset-btn p-3 rounded-lg border-2 border-gray-200 hover:border-orange-400 transition-all">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-4 h-4 rounded-full bg-orange-500"></span>
                                    <span class="w-4 h-4 rounded-full bg-orange-700"></span>
                                    <span class="w-4 h-4 rounded-full bg-gray-700"></span>
                                </div>
                                <span class="text-sm font-medium">í™œë ¥ (ì˜¤ë Œì§€)</span>
                            </button>
                            <button type="button" onclick="window.applyPresetTheme('teal')"
                                class="theme-preset-btn p-3 rounded-lg border-2 border-gray-200 hover:border-teal-400 transition-all">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-4 h-4 rounded-full bg-teal-600"></span>
                                    <span class="w-4 h-4 rounded-full bg-teal-800"></span>
                                    <span class="w-4 h-4 rounded-full bg-gray-700"></span>
                                </div>
                                <span class="text-sm font-medium">ì²­ëŸ‰ (í‹¸)</span>
                            </button>
                            <button type="button" onclick="window.applyPresetTheme('rose')"
                                class="theme-preset-btn p-3 rounded-lg border-2 border-gray-200 hover:border-rose-400 transition-all">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-4 h-4 rounded-full bg-rose-500"></span>
                                    <span class="w-4 h-4 rounded-full bg-rose-700"></span>
                                    <span class="w-4 h-4 rounded-full bg-gray-700"></span>
                                </div>
                                <span class="text-sm font-medium">ë¡œë§¨í‹± (ë¡œì¦ˆ)</span>
                            </button>
                            <button type="button" onclick="window.applyPresetTheme('slate')"
                                class="theme-preset-btn p-3 rounded-lg border-2 border-gray-200 hover:border-slate-400 transition-all">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-4 h-4 rounded-full bg-slate-600"></span>
                                    <span class="w-4 h-4 rounded-full bg-slate-800"></span>
                                    <span class="w-4 h-4 rounded-full bg-slate-900"></span>
                                </div>
                                <span class="text-sm font-medium">ëª¨ë˜ (ìŠ¬ë ˆì´íŠ¸)</span>
                            </button>
                            <button type="button" onclick="window.applyPresetTheme('dark')"
                                class="theme-preset-btn p-3 rounded-lg border-2 border-gray-200 hover:border-gray-600 transition-all bg-gray-800">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-4 h-4 rounded-full bg-gray-700"></span>
                                    <span class="w-4 h-4 rounded-full bg-gray-900"></span>
                                    <span class="w-4 h-4 rounded-full bg-blue-500"></span>
                                </div>
                                <span class="text-sm font-medium text-white">ë‹¤í¬ ëª¨ë“œ</span>
                            </button>
                        </div>
                    </div>

                    <!-- ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì„¤ì • -->
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-4">
                            <i class="fas fa-sliders-h mr-2"></i>ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì„¤ì •
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-bars mr-1"></i>í—¤ë” ë°°ê²½ìƒ‰
                                </label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="theme-menubar" value="#1e40af"
                                        class="w-12 h-10 rounded cursor-pointer border-0">
                                    <input type="text" id="theme-menubar-text" value="#1e40af"
                                        class="flex-1 px-3 py-2 border rounded-lg text-sm font-mono"
                                        onchange="document.getElementById('theme-menubar').value = this.value">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mouse-pointer mr-1"></i>ë©”ë‰´ í™œì„± ìƒ‰ìƒ
                                </label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="theme-menu-active" value="#3b82f6"
                                        class="w-12 h-10 rounded cursor-pointer border-0">
                                    <input type="text" id="theme-menu-active-text" value="#3b82f6"
                                        class="flex-1 px-3 py-2 border rounded-lg text-sm font-mono"
                                        onchange="document.getElementById('theme-menu-active').value = this.value">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="theme-title" value="#1e3a8a">
                        <input type="hidden" id="theme-title-text" value="#1e3a8a">
                        <input type="hidden" id="theme-subtitle" value="#374151">
                        <input type="hidden" id="theme-subtitle-text" value="#374151">

                        <div class="mt-4 flex gap-2">
                            <button type="button" onclick="window.previewTheme()"
                                class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm">
                                <i class="fas fa-eye mr-1"></i>ë¯¸ë¦¬ë³´ê¸°
                            </button>
                            <button type="button" onclick="window.resetThemeColors()"
                                class="px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm">
                                <i class="fas fa-undo mr-1"></i>ê¸°ë³¸ê°’
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI ì±—ë´‡ & TTS API í‚¤ ì„¹ì…˜ -->
                <div class="p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border-2 border-purple-200 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-key mr-2 text-purple-600"></i>
                        AI ì±—ë´‡ & TTS API í‚¤ ì„¤ì •
                    </h3>
                    
                    <!-- AI ëª¨ë¸ ì„ íƒ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-robot mr-2 text-purple-500"></i>AI ì±—ë´‡ ëª¨ë¸ ì„ íƒ
                        </label>
                        <select id="ai-model" 
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white">
                            <option value="groq">GROQ (llama-3.3-70b-versatile) - ë¹ ë¥¸ ì‘ë‹µ, ê³ í’ˆì§ˆ</option>
                            <option value="gemma">Gemma 2 9B (GROQ) - ë¬´ë£Œ, ë¹ ë¥¸ ì‘ë‹µ</option>
                            <option value="gemini">Gemini (gemini-2.0-flash-exp) - ê³ í’ˆì§ˆ ì‘ë‹µ</option>
                        </select>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ì˜ˆì§„ì´ 3D ì±—ë´‡ì—ì„œ ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•©ë‹ˆë‹¤
                        </p>
                        <p class="text-sm text-gray-500 mt-1">
                            ğŸ’¡ GROQ Llama: 70B ëŒ€í˜• ëª¨ë¸ | Gemma 2 9B: ë¬´ë£Œ ê²½ëŸ‰ ëª¨ë¸ | Gemini: ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”
                        </p>
                    </div>
                    
                    <!-- GROQ API í‚¤ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-bolt mr-2 text-yellow-500"></i>GROQ API í‚¤
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="groq-api-key" 
                                   class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white"
                                   placeholder="GROQ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <button type="button" onclick="window.testGroqApiKey()" 
                                    class="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors whitespace-nowrap">
                                <i class="fas fa-check-circle mr-2"></i>í…ŒìŠ¤íŠ¸
                            </button>
                        </div>
                        <div id="groq-api-test-result" class="mt-2 text-sm hidden"></div>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Llama 3.3 70B, Gemma 2 9B ëª¨ë¸ ì‚¬ìš©
                        </p>
                        <p class="text-sm text-blue-600 mt-1">
                            ğŸ’¡ <a href="https://console.groq.com/keys" target="_blank" class="hover:underline font-medium">GROQ Console</a>ì—ì„œ ë¬´ë£Œ ë°œê¸‰ (ë¶„ë‹¹ 30ê°œ ìš”ì²­)
                        </p>
                    </div>
                    
                    <!-- Gemini API í‚¤ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-brain mr-2 text-purple-500"></i>Gemini / Google Cloud TTS API í‚¤
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="gemini-api-key" 
                                   class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                   placeholder="Gemini/Google Cloud API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <button type="button" onclick="window.testGeminiApiKey()" 
                                    class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors whitespace-nowrap">
                                <i class="fas fa-check-circle mr-2"></i>í…ŒìŠ¤íŠ¸
                            </button>
                        </div>
                        <div id="gemini-api-test-result" class="mt-2 text-sm hidden"></div>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Gemini AI ì±—ë´‡ + Google Cloud TTS ê³ í’ˆì§ˆ ìŒì„± í•©ì„±
                        </p>
                        <p class="text-sm text-blue-600 mt-1">
                            ğŸ’¡ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="hover:underline font-medium">Google AI Studio</a>ì—ì„œ ë¬´ë£Œ ë°œê¸‰ (ë¶„ë‹¹ 15ê°œ ìš”ì²­)
                        </p>
                    </div>

                    <!-- YouTube API í‚¤ -->
                    <div class="mt-6 pt-6 border-t border-purple-200">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fab fa-youtube mr-2 text-red-500"></i>YouTube API í‚¤
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="youtube-api-key"
                                   class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 bg-white"
                                   placeholder="YouTube Data API v3 í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <button type="button" onclick="window.testYouTubeApiKey()"
                                    class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors whitespace-nowrap">
                                <i class="fas fa-check-circle mr-2"></i>í…ŒìŠ¤íŠ¸
                            </button>
                        </div>
                        <div id="api-test-result" class="mt-2 text-sm hidden"></div>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            YouTubeì—ì„œ BGMì„ ê²€ìƒ‰í•˜ë ¤ë©´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤
                        </p>
                        <p class="text-sm text-blue-600 mt-1">
                            ğŸ’¡ <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="hover:underline font-medium">Google Cloud Console</a>ì—ì„œ ë°œê¸‰ ê°€ëŠ¥
                        </p>
                    </div>
                </div>

                <!-- ì‹œìŠ¤í…œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
                <div class="p-6 bg-gradient-to-r from-orange-50 to-red-50 rounded-xl border-2 border-orange-200 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-server mr-2 text-orange-600"></i>
                        ì‹œìŠ¤í…œ ì—°ê²° í…ŒìŠ¤íŠ¸
                    </h3>

                    <!-- DB ì—°ê²° í…ŒìŠ¤íŠ¸ -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-database mr-2 text-blue-500"></i>ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
                        </label>
                        <div class="flex gap-2">
                            <div class="flex-1 px-4 py-3 border rounded-lg bg-gray-50 text-gray-600">
                                <span class="font-mono text-sm">localhost:3306 / minilms</span>
                            </div>
                            <button type="button" onclick="window.testDatabaseConnection()"
                                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors whitespace-nowrap">
                                <i class="fas fa-plug mr-2"></i>ì—°ê²° í…ŒìŠ¤íŠ¸
                            </button>
                        </div>
                        <div id="db-test-result" class="mt-2 text-sm hidden"></div>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤
                        </p>
                    </div>

                    <!-- FTP ì—°ê²° í…ŒìŠ¤íŠ¸ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-folder-open mr-2 text-green-500"></i>FTP íŒŒì¼ ì„œë²„ ì—°ê²°
                        </label>
                        <div class="flex gap-2">
                            <div class="flex-1 px-4 py-3 border rounded-lg bg-gray-50 text-gray-600">
                                <span class="font-mono text-sm">localhost:21</span>
                            </div>
                            <button type="button" onclick="window.testFtpConnection()"
                                    class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors whitespace-nowrap">
                                <i class="fas fa-plug mr-2"></i>ì—°ê²° í…ŒìŠ¤íŠ¸
                            </button>
                        </div>
                        <div id="ftp-test-result" class="mt-2 text-sm hidden"></div>
                        <p class="text-sm text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            FTP íŒŒì¼ ì„œë²„ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤ (í”„ë¡œí•„ ì‚¬ì§„, íŒŒì¼ ì—…ë¡œë“œ)
                        </p>
                    </div>
                </div>

                <!-- ì €ì¥ ë²„íŠ¼ -->
                <div class="flex gap-3 pt-4 border-t">
                    <button type="button" onclick="window.saveSystemSettings()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex-1">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                    </button>
                    <button type="button" onclick="window.resetSystemSettings()"
                            class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold">
                        <i class="fas fa-undo mr-2"></i>ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                    </button>
                </div>
            </form>
        </div>
    `;
    
    // HTML ìƒì„± í›„ JavaScriptë¡œ ê°’ ì„¤ì • (ì´ë ‡ê²Œ í•´ì•¼ ì‚¬ìš©ì ìˆ˜ì •ì´ ë°˜ì˜ë¨)
    setTimeout(() => {
        const titleInput = document.getElementById('system-title');
        const subtitle1Input = document.getElementById('system-subtitle1');
        const subtitle2Input = document.getElementById('system-subtitle2');
        const logoUrlInput = document.getElementById('logo-url');
        const logoImg = document.getElementById('current-logo');
        const refreshIntervalInput = document.getElementById('refresh-interval');
        
        if (titleInput) titleInput.value = settings.system_title || DEFAULT_SYSTEM_TITLE;
        if (subtitle1Input) subtitle1Input.value = settings.system_subtitle1 || 'ë³´ê±´ë³µì§€ë¶€(í•œêµ­ë³´ê±´ì‚°ì—…ì§„í¥ì›), KDT, ìš°ì†¡ëŒ€í•™êµì‚°í•™í˜‘ë ¥ë‹¨';
        if (subtitle2Input) subtitle2Input.value = settings.system_subtitle2 || 'ë°”ì´ì˜¤í—¬ìŠ¤ì•„ì¹´ë°ë¯¸ ì˜¬ì¸ì›í…Œí¬ ì´ë…¸ë² ì´í„°';
        if (logoUrlInput) logoUrlInput.value = settings.logo_url || '/woosong-logo.png';

        // íŒŒë¹„ì½˜ URL ë¡œë“œ
        const faviconUrlInput = document.getElementById('favicon-url');
        const faviconImg = document.getElementById('current-favicon');
        if (faviconUrlInput) faviconUrlInput.value = settings.favicon_url || '/favicon.ico';
        // í˜„ì¬ íŒŒë¹„ì½˜ í‘œì‹œ
        if (faviconImg && settings.favicon_url) {
            if (settings.favicon_url.startsWith('ftp://')) {
                faviconImg.src = API_BASE_URL + '/api/download-image?url=' + encodeURIComponent(settings.favicon_url);
            } else {
                faviconImg.src = settings.favicon_url;
            }
        }

        // YouTube API í‚¤ ë¡œë“œ (ì„œë²„ ìš°ì„ , ì—†ìœ¼ë©´ localStorage)
        const youtubeApiKeyInput = document.getElementById('youtube-api-key');
        const youtubeKey = settings.youtube_api_key || localStorage.getItem('youtube_api_key') || '';

        // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¨ í‚¤ë¥¼ localStorageì—ë„ ì €ì¥ (BGM ì¬ìƒì— ì‚¬ìš©) - UI ìš”ì†Œ ìœ ë¬´ì™€ ìƒê´€ì—†ì´
        if (settings.youtube_api_key) {
            localStorage.setItem('youtube_api_key', settings.youtube_api_key);
        }
        console.log('âœ… YouTube API í‚¤ ë¡œë“œ (ì„œë²„):', youtubeKey ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •');

        if (youtubeApiKeyInput) {
            youtubeApiKeyInput.value = youtubeKey;
        }
        
        // BGM ì¥ë¥´ ë¡œë“œ (ì„œë²„ ìš°ì„ , ì—†ìœ¼ë©´ localStorage)
        const bgmGenreSelect = document.getElementById('bgm-genre');
        const bgmGenre = settings.bgm_genre || localStorage.getItem('bgm_genre') || '';

        // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¨ ê°’ì„ localStorageì—ë„ ì €ì¥ - UI ìš”ì†Œ ìœ ë¬´ì™€ ìƒê´€ì—†ì´
        if (settings.bgm_genre) {
            localStorage.setItem('bgm_genre', settings.bgm_genre);
        }
        console.log('âœ… BGM ì¥ë¥´ ë¡œë“œ (ì„œë²„):', bgmGenre || 'ë„ê¸°');

        if (bgmGenreSelect) {
            bgmGenreSelect.value = bgmGenre;
        }

        // BGM ë³¼ë¥¨ ë¡œë“œ (ì„œë²„ ìš°ì„ , ì—†ìœ¼ë©´ localStorage)
        const bgmVolumeInput = document.getElementById('bgm-volume');
        const bgmVolume = settings.bgm_volume || localStorage.getItem('bgm_volume') || '30';

        // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¨ ê°’ì„ localStorageì—ë„ ì €ì¥ - UI ìš”ì†Œ ìœ ë¬´ì™€ ìƒê´€ì—†ì´
        if (settings.bgm_volume) {
            localStorage.setItem('bgm_volume', settings.bgm_volume);
        }
        console.log('âœ… BGM ë³¼ë¥¨ ë¡œë“œ (ì„œë²„):', bgmVolume + '%');

        if (bgmVolumeInput) {
            bgmVolumeInput.value = bgmVolume;
            document.getElementById('volume-value').textContent = bgmVolume + '%';
        }
        
        // AI ëª¨ë¸ ì„¤ì • ë¡œë“œ
        const aiModelSelect = document.getElementById('ai-model');
        const savedModel = localStorage.getItem('ai_model') || 'groq';
        if (aiModelSelect) {
            aiModelSelect.value = savedModel;
            console.log('âœ… AI ëª¨ë¸ ë¡œë“œ:', savedModel);
        }
        
        // GROQ API í‚¤ ë¡œë“œ
        const groqApiKeyInput = document.getElementById('groq-api-key');
        const groqKey = settings.groq_api_key || localStorage.getItem('groq_api_key') || '';
        if (groqApiKeyInput) {
            groqApiKeyInput.value = groqKey;
            if (groqKey) {
                localStorage.setItem('groq_api_key', groqKey);
            }
            console.log('âœ… GROQ API í‚¤ ë¡œë“œ:', groqKey ? 'ì„¤ì •ë¨ (****' + groqKey.slice(-4) + ')' : 'ë¯¸ì„¤ì •');
        }
        
        // Gemini API í‚¤ ë¡œë“œ (Google Cloud TTSì™€ ê³µí†µ)
        const geminiApiKeyInput = document.getElementById('gemini-api-key');
        const geminiKey = settings.gemini_api_key || localStorage.getItem('gemini_api_key') || '';
        if (geminiApiKeyInput) {
            geminiApiKeyInput.value = geminiKey;
            if (geminiKey) {
                localStorage.setItem('gemini_api_key', geminiKey);
            }
            console.log('âœ… Gemini/Google Cloud API í‚¤ ë¡œë“œ:', geminiKey ? 'ì„¤ì •ë¨ (****' + geminiKey.slice(-4) + ')' : 'ë¯¸ì„¤ì •');
        }
        
        // ëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ ì„¤ì • ë¡œë“œ (ì„œë²„ ìš°ì„ )
        const refreshInterval = settings.dashboard_refresh_interval || localStorage.getItem('dashboard_refresh_interval') || '5';
        if (refreshIntervalInput) {
            refreshIntervalInput.value = refreshInterval;
            if (refreshInterval) {
                localStorage.setItem('dashboard_refresh_interval', refreshInterval);
            }
            console.log('âœ… ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ ë¡œë“œ (ì„œë²„):', refreshInterval + 'ë¶„');
        }
        
        // ë¡œê³  ì´ë¯¸ì§€ í‘œì‹œ
        if (logoImg && settings.logo_url) {
            if (settings.logo_url.startsWith('ftp://')) {
                logoImg.src = API_BASE_URL + '/api/download-image?url=' + encodeURIComponent(settings.logo_url);
            } else {
                logoImg.src = settings.logo_url;
            }
            logoImg.style.display = '';
        } else if (logoImg) {
            logoImg.src = '/woosong-logo.png';
            logoImg.style.display = '';
        }
        
        console.log('âœ… í¼ ê°’ ì„¤ì • ì™„ë£Œ:', {
            title: titleInput?.value,
            subtitle1: subtitle1Input?.value,
            subtitle2: subtitle2Input?.value,
            logo: logoUrlInput?.value,
            refreshInterval: refreshIntervalInput?.value + 'ë¶„'
        });

        // ëª¨ì§‘ì¤‘ì¸ ê³¼ì • ì²´í¬ë°•ìŠ¤ ë¡œë“œ
        loadOpenCoursesCheckboxes(settings.open_courses || '');

        // ê´€ì‹¬ë¶„ì•¼ í‚¤ì›Œë“œ ë¡œë“œ
        const interestKeywordsInput = document.getElementById('interest-keywords');
        if (interestKeywordsInput) {
            interestKeywordsInput.value = settings.interest_keywords || '';
            console.log('âœ… ê´€ì‹¬ë¶„ì•¼ í‚¤ì›Œë“œ ë¡œë“œ:', settings.interest_keywords || 'ë¯¸ì„¤ì •');
        }

        // í…Œë§ˆ ì„¤ì • ë¡œë“œ
        window.loadThemeSettings();
        console.log('ğŸ¨ í…Œë§ˆ ì„¤ì • ë¡œë“œ ì™„ë£Œ');
    }, 0);
}

// ëª¨ì§‘ì¤‘ì¸ ê³¼ì • ì²´í¬ë°•ìŠ¤ ë¡œë“œ
async function loadOpenCoursesCheckboxes(savedOpenCourses) {
    try {
        const coursesRes = await axios.get(`${API_BASE_URL}/api/courses`);
        const allCourses = coursesRes.data;

        const container = document.getElementById('open-courses-checkboxes');
        if (!container) return;

        const openCodesArray = savedOpenCourses ? savedOpenCourses.split(',').map(c => c.trim()) : [];

        if (allCourses.length === 0) {
            container.innerHTML = '<p class="text-gray-500 col-span-3">ë“±ë¡ëœ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        container.innerHTML = allCourses.map(course => {
            const isChecked = openCodesArray.includes(course.code);
            return `
                <label class="flex items-center gap-2 p-2 rounded hover:bg-orange-50 cursor-pointer">
                    <input type="checkbox" class="open-course-checkbox w-4 h-4 text-orange-500"
                           value="${course.code}" ${isChecked ? 'checked' : ''}
                           onchange="window.updateOpenCoursesValue()">
                    <span class="text-sm">${course.name || course.code}</span>
                </label>
            `;
        }).join('');

        // hidden inputì— í˜„ì¬ ê°’ ì„¤ì •
        document.getElementById('open-courses').value = savedOpenCourses || '';

        console.log('âœ… ëª¨ì§‘ì¤‘ì¸ ê³¼ì • ì²´í¬ë°•ìŠ¤ ë¡œë“œ:', allCourses.length + 'ê°œ ê³¼ì •');
    } catch (error) {
        console.error('ê³¼ì • ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

// ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ hidden input ì—…ë°ì´íŠ¸
window.updateOpenCoursesValue = function() {
    const checkboxes = document.querySelectorAll('.open-course-checkbox:checked');
    const values = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('open-courses').value = values.join(',');
    console.log('ëª¨ì§‘ì¤‘ì¸ ê³¼ì • ì—…ë°ì´íŠ¸:', values);
}

// ë¡œê³  ì—…ë¡œë“œ ì²˜ë¦¬
window.handleLogoUpload = async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // íŒŒì¼ í˜•ì‹ ê²€ì¦
    if (!file.type.startsWith('image/')) {
        window.showAlert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }
    
    // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
    if (file.size > 5 * 1024 * 1024) {
        window.showAlert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìƒì„±
    const progressContainer = document.createElement('div');
    progressContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    progressContainer.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mb-4">
                    <i class="fas fa-cloud-upload-alt text-6xl text-blue-500 animate-pulse"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">ë¡œê³  ì—…ë¡œë“œ ì¤‘...</h3>
                <p class="text-gray-600 mb-4">${file.name}</p>
                
                <!-- í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                    <div id="upload-progress" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="upload-percent" class="text-sm font-semibold text-gray-700">0%</p>
            </div>
        </div>
    `;
    document.body.appendChild(progressContainer);
    
    try {
        // ì´ë¯¸ì§€ ì••ì¶•
        let processedFile = file;
        try {
            processedFile = await window.compressImage(file);
            console.log(`ë¡œê³  ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
        } catch (error) {
            console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
            processedFile = file;
        }
        
        const formData = new FormData();
        formData.append('file', processedFile);
        
        // teacher ì¹´í…Œê³ ë¦¬ë¡œ ì—…ë¡œë“œ (ë¡œê³ ëŠ” teacher í´ë”ì— ì €ì¥)
        const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=teacher`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' },
            onUploadProgress: (progressEvent) => {
                const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                const progressBar = document.getElementById('upload-progress');
                const progressText = document.getElementById('upload-percent');
                if (progressBar) progressBar.style.width = percentCompleted + '%';
                if (progressText) progressText.textContent = percentCompleted + '%';
            }
        });
        
        const logoUrl = response.data.url;
        document.getElementById('logo-url').value = logoUrl;
        
        // FTP URLì¸ ê²½ìš° download-image API ì‚¬ìš©
        if (logoUrl.startsWith('ftp://')) {
            document.getElementById('current-logo').src = API_BASE_URL + '/api/download-image?url=' + encodeURIComponent(logoUrl);
        } else {
            document.getElementById('current-logo').src = logoUrl;
        }
        document.getElementById('current-logo').style.display = 'block';
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì œê±°
        document.body.removeChild(progressContainer);
        
        window.showAlert('âœ… ë¡œê³ ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ìš©í•˜ì„¸ìš”.');
    } catch (error) {
        console.error('âŒ ë¡œê³  ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì œê±°
        if (document.body.contains(progressContainer)) {
            document.body.removeChild(progressContainer);
        }
        
        const errorMsg = error.response?.data?.detail || error.message;
        window.showAlert('ë¡œê³  ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMsg);
    }
}

// íŒŒë¹„ì½˜ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
window.handleFaviconUpload = async function(event) {
    const file = event.target.files[0];
    if (!file) return;

    // íŒŒì¼ í˜•ì‹ ê²€ì¦
    if (!file.type.startsWith('image/')) {
        window.showAlert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }

    // íŒŒì¼ í¬ê¸° ê²€ì¦ (2MB - íŒŒë¹„ì½˜ì€ ì‘ê²Œ)
    if (file.size > 2 * 1024 * 1024) {
        window.showAlert('íŒŒì¼ í¬ê¸°ëŠ” 2MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }

    // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìƒì„±
    const progressContainer = document.createElement('div');
    progressContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    progressContainer.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mb-4">
                    <i class="fas fa-star text-6xl text-yellow-500 animate-pulse"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">íŒŒë¹„ì½˜ ì—…ë¡œë“œ ì¤‘...</h3>
                <p class="text-gray-600 mb-4">${file.name}</p>

                <!-- í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                    <div id="favicon-upload-progress" class="bg-gradient-to-r from-yellow-500 to-orange-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="favicon-upload-percent" class="text-sm font-semibold text-gray-700">0%</p>
            </div>
        </div>
    `;
    document.body.appendChild(progressContainer);

    try {
        // ì´ë¯¸ì§€ ì••ì¶• (íŒŒë¹„ì½˜ì€ ì‘ê²Œ ìœ ì§€)
        let processedFile = file;
        try {
            processedFile = await window.compressImage(file, { maxWidth: 512, maxHeight: 512, quality: 0.9 });
            console.log(`íŒŒë¹„ì½˜ ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
        } catch (error) {
            console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
            processedFile = file;
        }

        const formData = new FormData();
        formData.append('file', processedFile);

        // teacher ì¹´í…Œê³ ë¦¬ë¡œ ì—…ë¡œë“œ
        const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=teacher`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' },
            onUploadProgress: (progressEvent) => {
                const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                const progressBar = document.getElementById('favicon-upload-progress');
                const progressText = document.getElementById('favicon-upload-percent');
                if (progressBar) progressBar.style.width = percentCompleted + '%';
                if (progressText) progressText.textContent = percentCompleted + '%';
            }
        });

        const faviconUrl = response.data.url;
        document.getElementById('favicon-url').value = faviconUrl;

        // FTP URLì¸ ê²½ìš° download-image API ì‚¬ìš©
        if (faviconUrl.startsWith('ftp://')) {
            document.getElementById('current-favicon').src = API_BASE_URL + '/api/download-image?url=' + encodeURIComponent(faviconUrl);
        } else {
            document.getElementById('current-favicon').src = faviconUrl;
        }

        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì œê±°
        document.body.removeChild(progressContainer);

        window.showAlert('âœ… íŒŒë¹„ì½˜ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ìš©í•˜ì„¸ìš”.');
    } catch (error) {
        console.error('âŒ íŒŒë¹„ì½˜ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);

        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì œê±°
        if (document.body.contains(progressContainer)) {
            document.body.removeChild(progressContainer);
        }

        const errorMsg = error.response?.data?.detail || error.message;
        window.showAlert('íŒŒë¹„ì½˜ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMsg);
    }
}

// ì‹œìŠ¤í…œ ì„¤ì • ì €ì¥
window.saveSystemSettings = async function() {
    // DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸
    const titleElement = document.getElementById('system-title');
    const subtitle1Element = document.getElementById('system-subtitle1');
    const subtitle2Element = document.getElementById('system-subtitle2');
    const logoElement = document.getElementById('logo-url');
    const faviconElement = document.getElementById('favicon-url');
    const aiModelElement = document.getElementById('ai-model');
    const refreshIntervalElement = document.getElementById('refresh-interval');

    console.log('ğŸ” DOM ìš”ì†Œ í™•ì¸:', {
        titleElement: titleElement ? 'ì¡´ì¬' : 'ì—†ìŒ',
        subtitle1Element: subtitle1Element ? 'ì¡´ì¬' : 'ì—†ìŒ',
        subtitle2Element: subtitle2Element ? 'ì¡´ì¬' : 'ì—†ìŒ',
        logoElement: logoElement ? 'ì¡´ì¬' : 'ì—†ìŒ',
        faviconElement: faviconElement ? 'ì¡´ì¬' : 'ì—†ìŒ',
        aiModelElement: aiModelElement ? 'ì¡´ì¬' : 'ì—†ìŒ',
        refreshIntervalElement: refreshIntervalElement ? 'ì¡´ì¬' : 'ì—†ìŒ'
    });
    
    if (!titleElement || !subtitle1Element || !subtitle2Element || !logoElement) {
        console.error('âŒ í•„ìˆ˜ input ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        window.showAlert('ì˜¤ë¥˜: í¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
        return;
    }
    
    const systemTitle = titleElement.value;
    const systemSubtitle1 = subtitle1Element.value;
    const systemSubtitle2 = subtitle2Element.value;
    const logoUrl = logoElement.value;
    const faviconUrl = faviconElement ? faviconElement.value : '/favicon.ico';

    // ì‹œìŠ¤í…œ ì„¤ì •ì„ localStorageì— ì €ì¥ (ì¦‰ì‹œ ë¡œë”©ìš©)
    localStorage.setItem('system_title', systemTitle);
    localStorage.setItem('logo_url', logoUrl);
    localStorage.setItem('favicon_url', faviconUrl);
    console.log('ğŸ’¾ ì‹œìŠ¤í…œ íƒ€ì´í‹€ ì €ì¥:', systemTitle);
    console.log('ğŸ’¾ ë¡œê³  URL ì €ì¥:', logoUrl);
    console.log('ğŸ’¾ íŒŒë¹„ì½˜ URL ì €ì¥:', faviconUrl);

    // YouTube API í‚¤ ì €ì¥
    const youtubeApiKey = document.getElementById('youtube-api-key')?.value || '';
    localStorage.setItem('youtube_api_key', youtubeApiKey);
    console.log('ğŸ’¾ YouTube API í‚¤ ì €ì¥:', youtubeApiKey ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •');
    
    // BGM ì¥ë¥´ ì €ì¥
    const bgmGenre = document.getElementById('bgm-genre')?.value || '';
    localStorage.setItem('bgm_genre', bgmGenre);
    console.log('ğŸ’¾ BGM ì¥ë¥´ ì €ì¥:', bgmGenre || 'ë„ê¸°');
    
    // BGM ë³¼ë¥¨ ì €ì¥
    const bgmVolume = document.getElementById('bgm-volume')?.value || '30';
    localStorage.setItem('bgm_volume', bgmVolume);
    console.log('ğŸ’¾ BGM ë³¼ë¥¨ ì €ì¥:', bgmVolume + '%');
    
    // AI ëª¨ë¸ ì„ íƒ ì €ì¥
    const aiModel = aiModelElement ? aiModelElement.value : 'groq';
    localStorage.setItem('ai_model', aiModel);
    console.log('ğŸ’¾ AI ëª¨ë¸ ì €ì¥:', aiModel);
    
    // GROQ API í‚¤ ì €ì¥
    const groqApiKey = document.getElementById('groq-api-key')?.value || '';
    localStorage.setItem('groq_api_key', groqApiKey);
    console.log('ğŸ’¾ GROQ API í‚¤ ì €ì¥:', groqApiKey ? 'ì„¤ì •ë¨ (****' + groqApiKey.slice(-4) + ')' : 'ë¯¸ì„¤ì •');
    
    // Gemini API í‚¤ ì €ì¥ (Google Cloud TTSì™€ ê³µí†µ)
    const geminiApiKey = document.getElementById('gemini-api-key')?.value || '';
    localStorage.setItem('gemini_api_key', geminiApiKey);
    console.log('ğŸ’¾ Gemini/Google Cloud API í‚¤ ì €ì¥:', geminiApiKey ? 'ì„¤ì •ë¨ (****' + geminiApiKey.slice(-4) + ')' : 'ë¯¸ì„¤ì •');
    
    // ëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ ì €ì¥
    let refreshInterval = 5; // ê¸°ë³¸ê°’
    if (refreshIntervalElement) {
        const inputValue = parseInt(refreshIntervalElement.value);
        if (inputValue >= 1 && inputValue <= 60) {
            refreshInterval = inputValue;
        } else {
            window.showAlert('âš ï¸ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ì€ 1~60ë¶„ ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤. ê¸°ë³¸ê°’ 5ë¶„ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.');
            refreshInterval = 5;
            refreshIntervalElement.value = 5;
        }
    }
    
    console.log('ğŸ“ ì €ì¥í•  ë°ì´í„°:', {
        system_title: systemTitle,
        system_subtitle1: systemSubtitle1,
        system_subtitle2: systemSubtitle2,
        logo_url: logoUrl,
        favicon_url: faviconUrl,
        dashboard_refresh_interval: refreshInterval + 'ë¶„'
    });

    const formData = new FormData();
    formData.append('system_title', systemTitle);
    formData.append('system_subtitle1', systemSubtitle1);
    formData.append('system_subtitle2', systemSubtitle2);
    formData.append('logo_url', logoUrl);
    formData.append('favicon_url', faviconUrl);
    formData.append('youtube_api_key', youtubeApiKey);
    formData.append('groq_api_key', groqApiKey);
    formData.append('gemini_api_key', geminiApiKey);
    formData.append('bgm_genre', bgmGenre);
    formData.append('bgm_volume', bgmVolume);
    formData.append('dashboard_refresh_interval', refreshInterval.toString());

    // ëª¨ì§‘ì¤‘ì¸ ê³¼ì • ì €ì¥
    const openCourses = document.getElementById('open-courses')?.value || '';
    formData.append('open_courses', openCourses);
    console.log('ğŸ’¾ ëª¨ì§‘ì¤‘ì¸ ê³¼ì • ì €ì¥:', openCourses || 'ì „ì²´');

    // ê´€ì‹¬ë¶„ì•¼ í‚¤ì›Œë“œ ì €ì¥
    const interestKeywords = document.getElementById('interest-keywords')?.value || '';
    formData.append('interest_keywords', interestKeywords);
    console.log('ğŸ’¾ ê´€ì‹¬ë¶„ì•¼ í‚¤ì›Œë“œ ì €ì¥:', interestKeywords || 'ë¯¸ì„¤ì •');

    // ë¡œê·¸ì¸ í˜ì´ì§€ ë²„íŠ¼ ì„¤ì • ì €ì¥
    const loginShowRegister = document.getElementById('login-show-register')?.checked ? 'true' : 'false';
    const loginShowCourseIntro = document.getElementById('login-show-course-intro')?.checked ? 'true' : 'false';
    const loginShowEducationSupport = document.getElementById('login-show-education-support')?.checked ? 'true' : 'false';
    const loginShowFacebook = document.getElementById('login-show-facebook')?.checked ? 'true' : 'false';
    const loginShowInstagram = document.getElementById('login-show-instagram')?.checked ? 'true' : 'false';
    formData.append('login_show_register', loginShowRegister);
    formData.append('login_show_course_intro', loginShowCourseIntro);
    formData.append('login_show_education_support', loginShowEducationSupport);
    formData.append('login_show_facebook', loginShowFacebook);
    formData.append('login_show_instagram', loginShowInstagram);
    console.log('ğŸ’¾ ë¡œê·¸ì¸ í˜ì´ì§€ ë²„íŠ¼ ì„¤ì • ì €ì¥:', { loginShowRegister, loginShowCourseIntro, loginShowEducationSupport, loginShowFacebook, loginShowInstagram });

    try {
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ
        window.showLoading('ì‹œìŠ¤í…œ ì„¤ì •ì„ ì €ì¥í•˜ëŠ” ì¤‘...');
        
        console.log('ğŸ“¤ ì‹œìŠ¤í…œ ì„¤ì • ì €ì¥ API í˜¸ì¶œ ì‹œì‘...');
        const response = await axios.post(`${API_BASE_URL}/api/system-settings`, formData);
        console.log('âœ… API ì‘ë‹µ:', response.data);
        
        // ì €ì¥ ì§í›„ ì‹¤ì œ DBì—ì„œ ì¡°íšŒí•˜ì—¬ í™•ì¸
        console.log('ğŸ” ì €ì¥ í™•ì¸ì„ ìœ„í•´ DB ì¬ì¡°íšŒ...');
        const verifyResponse = await axios.get(`${API_BASE_URL}/api/system-settings`);
        console.log('ğŸ“Š DBì— ì €ì¥ëœ ë°ì´í„°:', verifyResponse.data);
        
        // ëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ localStorageì— ì €ì¥
        const oldInterval = localStorage.getItem('dashboard_refresh_interval');
        localStorage.setItem('dashboard_refresh_interval', refreshInterval.toString());
        console.log('ğŸ’¾ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ ì €ì¥:', refreshInterval + 'ë¶„');
        
        // ìƒˆë¡œê³ ì¹¨ ê°„ê²©ì´ ë³€ê²½ëœ ê²½ìš° íƒ€ì´ë¨¸ ì¬ì‹œì‘
        if (oldInterval !== refreshInterval.toString()) {
            console.log('ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ ì¬ì‹œì‘...');
            stopDashboardAutoRefresh();
            startDashboardAutoRefresh();
        }
        
        // í—¤ë” ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        console.log('ğŸ”„ í—¤ë” ì—…ë°ì´íŠ¸ ì‹œì‘...');
        await updateHeader();

        // í…Œë§ˆ ì„¤ì • ì €ì¥
        console.log('ğŸ¨ í…Œë§ˆ ì„¤ì • ì €ì¥...');
        window.saveThemeSettings();

        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¸°ê¸°
        window.hideLoading();

        window.showAlert(`âœ… ì‹œìŠ¤í…œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨: ${refreshInterval}ë¶„ë§ˆë‹¤\n(10ì´ˆê°„ í™”ë©´ë³´í˜¸ê¸° í‘œì‹œ)`);
    } catch (error) {
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¸°ê¸°
        window.hideLoading();
        
        console.error('âŒ ì‹œìŠ¤í…œ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
        console.error('âŒ ì—ëŸ¬ ìƒì„¸:', error.response?.data);
        window.showAlert('ì‹œìŠ¤í…œ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message));
    }
}

// í—¤ë” ì—…ë°ì´íŠ¸
async function updateHeader() {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/system-settings`);
        const settings = response.data;
        
        // ì œëª© ì—…ë°ì´íŠ¸
        const titleTextElement = document.getElementById('system-title-text');
        const systemTitle = settings.system_title || DEFAULT_SYSTEM_TITLE;
        if (titleTextElement) {
            titleTextElement.textContent = systemTitle;
        }

        // ë¸Œë¼ìš°ì € íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        document.title = systemTitle;
        
        // ë¶€ì œëª© 1 ì—…ë°ì´íŠ¸
        const subtitle1Element = document.getElementById('system-subtitle1-header');
        if (subtitle1Element) {
            subtitle1Element.textContent = settings.system_subtitle1 || 'ë³´ê±´ë³µì§€ë¶€(í•œêµ­ë³´ê±´ì‚°ì—…ì§„í¥ì›), KDT, ìš°ì†¡ëŒ€í•™êµì‚°í•™í˜‘ë ¥ë‹¨';
        }
        
        // ë¶€ì œëª© 2 ì—…ë°ì´íŠ¸
        const subtitle2Element = document.getElementById('system-subtitle2-header');
        if (subtitle2Element) {
            subtitle2Element.textContent = settings.system_subtitle2 || 'ë°”ì´ì˜¤í—¬ìŠ¤ì•„ì¹´ë°ë¯¸ ì˜¬ì¸ì›í…Œí¬ ì´ë…¸ë² ì´í„°';
        }
        
        // ë¡œê³  ì—…ë°ì´íŠ¸
        const logoElement = document.getElementById('header-logo');
        if (logoElement && settings.logo_url) {
            if (settings.logo_url.startsWith('ftp://')) {
                logoElement.src = API_BASE_URL + '/api/download-image?url=' + encodeURIComponent(settings.logo_url);
            } else {
                logoElement.src = settings.logo_url;
            }
            logoElement.style.display = '';
        }

        // íŒŒë¹„ì½˜ ë™ì  ë³€ê²½
        if (settings.favicon_url) {
            let faviconHref = settings.favicon_url;

            // FTP URLì¸ ê²½ìš° í”„ë¡ì‹œë¥¼ í†µí•´ ì ‘ê·¼
            if (faviconHref.startsWith('ftp://')) {
                faviconHref = `${API_BASE_URL}/api/download-image?url=${encodeURIComponent(faviconHref)}`;
            }

            // ê¸°ì¡´ íŒŒë¹„ì½˜ ë§í¬ ì°¾ê¸° ë˜ëŠ” ìƒì„±
            let link = document.querySelector("link[rel*='icon']");
            if (!link) {
                link = document.createElement('link');
                link.rel = 'shortcut icon';
                document.getElementsByTagName('head')[0].appendChild(link);
            }
            link.href = faviconHref;

            console.log('âœ… íŒŒë¹„ì½˜ ë™ì  ë¡œë“œ:', faviconHref);
        }

        // localStorageì— ì„¤ì • ì €ì¥ (ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ì‚¬ìš©)
        localStorage.setItem('system_title', systemTitle);
        if (settings.logo_url) {
            localStorage.setItem('logo_url', settings.logo_url);
        }
        console.log('ğŸ’¾ ì„¤ì • localStorage ì €ì¥ ì™„ë£Œ');

        // ê°•ì‚¬ ì´ë¦„ ì—…ë°ì´íŠ¸
        const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
        const nameElement = document.getElementById('instructorName');
        if (nameElement && instructor.name) {
            nameElement.textContent = instructor.name;
        }
    } catch (error) {
        console.error('âŒ í—¤ë” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    }
}

// ë©”ë‰´ ê¶Œí•œ ì ìš©
async function applyMenuPermissions() {
    const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
    
    if (!instructor || !instructor.code) {
        console.log('âš ï¸ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ - ê¶Œí•œ ì²´í¬ ìŠ¤í‚µ');
        return;
    }
    
    // ê´€ë¦¬ì (íƒ€ì… IC-999)ëŠ” ëª¨ë“  ë©”ë‰´ ì ‘ê·¼ ê°€ëŠ¥
    if (instructor.instructor_type === 'IC-999') {
        console.log('âœ… ê´€ë¦¬ì ê³„ì • - ëª¨ë“  ë©”ë‰´ ì ‘ê·¼ ê°€ëŠ¥');
        window.allowedMenus = null; // null = ëª¨ë“  ë©”ë‰´ í—ˆìš©
        // ëª¨ë“  ë©”ë‰´ ë²„íŠ¼ í™œì„±í™”
        const menuButtons = document.querySelectorAll('[data-tab]');
        menuButtons.forEach(button => {
            button.disabled = false;
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
            button.removeAttribute('title');
        });
        return;
    }
    
    // instructor_typeìœ¼ë¡œ menu_permissions ì¡°íšŒ
    try {
        const response = await axios.get(`${API_BASE_URL}/api/instructor-codes`);
        const instructorType = response.data.find(code => code.code === instructor.instructor_type);
        
        if (!instructorType) {
            console.log('âš ï¸ ê°•ì‚¬ íƒ€ì… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', instructor.instructor_type);
            return;
        }
        
        // menu_permissions ë°°ì—´ (ìƒˆ ë²„ì „) ë˜ëŠ” permissions ê°ì²´ (êµ¬ ë²„ì „) ì‚¬ìš©
        let allowedMenus = [];
        if (instructorType.menu_permissions && Array.isArray(instructorType.menu_permissions)) {
            allowedMenus = instructorType.menu_permissions;
        } else if (instructorType.permissions && typeof instructorType.permissions === 'object') {
            // êµ¬ë²„ì „ permissions ê°ì²´ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
            allowedMenus = Object.keys(instructorType.permissions).filter(key => instructorType.permissions[key] === true);
        }

        // ì „ì—­ìœ¼ë¡œ í—ˆìš© ë©”ë‰´ ì €ì¥ (ëŒ€ì‹œë³´ë“œ ë“±ì—ì„œ ì‚¬ìš©)
        window.allowedMenus = allowedMenus;

        console.log('ğŸ“‹ í—ˆìš©ëœ ë©”ë‰´:', allowedMenus);
        
        const menuButtons = document.querySelectorAll('[data-tab]');
        console.log('ğŸ“‹ ë©”ë‰´ ë²„íŠ¼ ê°œìˆ˜:', menuButtons.length);
        
        let disabledCount = 0;
        let enabledCount = 0;
        
        menuButtons.forEach(button => {
            const menuId = button.getAttribute('data-tab');
            
            // ê¶Œí•œ ì²´í¬
            const hasPermission = allowedMenus.includes(menuId);
            
            if (!hasPermission) {
                // ê¶Œí•œ ì—†ìŒ - ë©”ë‰´ ìˆ¨ê¹€
                button.style.display = 'none';

                disabledCount++;
                console.log(`ğŸ™ˆ ë©”ë‰´ ìˆ¨ê¹€: ${menuId}`);
            } else {
                // ê¶Œí•œ ìˆìŒ - í™œì„±í™” ë° í‘œì‹œ
                button.style.display = '';
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.removeAttribute('title');
                enabledCount++;
                console.log(`âœ… ë©”ë‰´ í™œì„±í™”: ${menuId}`);
            }
        });

        // ìƒìœ„ ë©”ë‰´(ë“œë¡­ë‹¤ìš´) ìˆ¨ê¹€ ì²˜ë¦¬ - í•˜ìœ„ ë©”ë‰´ê°€ ëª¨ë‘ ìˆ¨ê²¨ì§„ ê²½ìš°
        const dropdownMenus = document.querySelectorAll('nav .relative.group');
        dropdownMenus.forEach(dropdown => {
            const childButtons = dropdown.querySelectorAll('[data-tab]');
            const visibleChildren = Array.from(childButtons).filter(btn => btn.style.display !== 'none');

            if (visibleChildren.length === 0) {
                dropdown.style.display = 'none';
                console.log('ğŸ™ˆ ìƒìœ„ ë©”ë‰´ ìˆ¨ê¹€ (í•˜ìœ„ ë©”ë‰´ ì—†ìŒ)');
            } else {
                dropdown.style.display = '';
            }
        });

        console.log(`âœ… ë©”ë‰´ ê¶Œí•œ ì ìš© ì™„ë£Œ - í‘œì‹œ: ${enabledCount}ê°œ, ìˆ¨ê¹€: ${disabledCount}ê°œ`);
    } catch (error) {
        console.error('âŒ ë©”ë‰´ ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨:', error);
    }
}

// ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
window.resetSystemSettings = async function() {
    const confirmed = await window.showConfirm('ì‹œìŠ¤í…œ ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (!confirmed) return;
    
    try {
        const formData = new FormData();
        formData.append('system_title', DEFAULT_SYSTEM_TITLE);
        formData.append('system_subtitle1', 'ë³´ê±´ë³µì§€ë¶€(í•œêµ­ë³´ê±´ì‚°ì—…ì§„í¥ì›), KDT, ìš°ì†¡ëŒ€í•™êµì‚°í•™í˜‘ë ¥ë‹¨');
        formData.append('system_subtitle2', 'ë°”ì´ì˜¤í—¬ìŠ¤ì•„ì¹´ë°ë¯¸ ì˜¬ì¸ì›í…Œí¬ ì´ë…¸ë² ì´í„°');
        formData.append('logo_url', '/woosong-logo.png');
        
        await axios.post(`${API_BASE_URL}/api/system-settings`, formData);
        window.showAlert('ì‹œìŠ¤í…œ ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // í™”ë©´ ìƒˆë¡œê³ ì¹¨
        loadSystemSettings();
        updateHeader();
    } catch (error) {
        console.error('ì‹œìŠ¤í…œ ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        window.showAlert('ì‹œìŠ¤í…œ ì„¤ì • ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ==================== í…Œë§ˆ ì„¤ì • ====================
const THEME_PRESETS = {
    default: {
        menubar: '#2563eb',
        title: '#1e40af',
        subtitle: '#374151',
        menuActive: '#3b82f6'
    },
    green: {
        menubar: '#166534',
        title: '#14532d',
        subtitle: '#374151',
        menuActive: '#22c55e'
    },
    purple: {
        menubar: '#7c3aed',
        title: '#5b21b6',
        subtitle: '#374151',
        menuActive: '#a855f7'
    },
    orange: {
        menubar: '#ea580c',
        title: '#c2410c',
        subtitle: '#374151',
        menuActive: '#f97316'
    },
    teal: {
        menubar: '#0d9488',
        title: '#115e59',
        subtitle: '#374151',
        menuActive: '#14b8a6'
    },
    rose: {
        menubar: '#e11d48',
        title: '#be123c',
        subtitle: '#374151',
        menuActive: '#f43f5e'
    },
    slate: {
        menubar: '#475569',
        title: '#334155',
        subtitle: '#475569',
        menuActive: '#64748b'
    },
    dark: {
        menubar: '#1f2937',
        title: '#111827',
        subtitle: '#9ca3af',
        menuActive: '#3b82f6'
    }
};

window.applyPresetTheme = function(themeName) {
    const preset = THEME_PRESETS[themeName];
    if (!preset) return;

    // ì…ë ¥ í•„ë“œì— ìƒ‰ìƒ ì„¤ì •
    document.getElementById('theme-menubar').value = preset.menubar;
    document.getElementById('theme-menubar-text').value = preset.menubar;
    document.getElementById('theme-title').value = preset.title;
    document.getElementById('theme-title-text').value = preset.title;
    document.getElementById('theme-subtitle').value = preset.subtitle;
    document.getElementById('theme-subtitle-text').value = preset.subtitle;
    document.getElementById('theme-menu-active').value = preset.menuActive;
    document.getElementById('theme-menu-active-text').value = preset.menuActive;

    // ë¯¸ë¦¬ë³´ê¸° ì ìš©
    window.previewTheme();

    // ì„ íƒëœ í”„ë¦¬ì…‹ í‘œì‹œ
    document.querySelectorAll('.theme-preset-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-blue-500');
    });
    event.currentTarget.classList.add('ring-2', 'ring-blue-500');

    console.log('ğŸ¨ í”„ë¦¬ì…‹ í…Œë§ˆ ì ìš©:', themeName);
};

window.previewTheme = function() {
    const theme = {
        menubar: document.getElementById('theme-menubar').value,
        title: document.getElementById('theme-title').value,
        subtitle: document.getElementById('theme-subtitle').value,
        menuActive: document.getElementById('theme-menu-active').value
    };

    // applyTheme í•¨ìˆ˜ ì‚¬ìš©í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸°
    window.applyTheme(theme);

    console.log('ğŸ¨ í…Œë§ˆ ë¯¸ë¦¬ë³´ê¸°:', theme);
};

window.resetThemeColors = function() {
    window.applyPresetTheme('default');
};

// ìƒ‰ìƒ ë°ê¸° ì¡°ì ˆ í•¨ìˆ˜
function adjustColor(hex, percent) {
    const num = parseInt(hex.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.max(0, Math.min(255, (num >> 16) + amt));
    const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));
    const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
    return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
}

// í…Œë§ˆ ì ìš© í•¨ìˆ˜ (í˜ì´ì§€ ë¡œë“œ ì‹œ í˜¸ì¶œ)
window.applyTheme = function(theme) {
    if (!theme) {
        theme = JSON.parse(localStorage.getItem('system_theme') || 'null') || THEME_PRESETS.default;
    }

    const menubar = theme.menubar || '#2563eb';
    const title = theme.title || '#1e40af';
    const subtitle = theme.subtitle || '#374151';
    const menuActive = theme.menuActive || '#3b82f6';

    // CSS ë³€ìˆ˜ ì„¤ì •
    document.documentElement.style.setProperty('--theme-menubar', menubar);
    document.documentElement.style.setProperty('--theme-title', title);
    document.documentElement.style.setProperty('--theme-subtitle', subtitle);
    document.documentElement.style.setProperty('--theme-menu-active', menuActive);

    // í—¤ë” ë°°ê²½ìƒ‰ ì ìš©
    const header = document.querySelector('header');
    if (header) {
        header.style.background = `linear-gradient(135deg, ${menubar} 0%, ${adjustColor(menubar, -15)} 100%)`;
    }

    // ì œëª© ìƒ‰ìƒ (í°ìƒ‰ ìœ ì§€ - í—¤ë” ë‚´ë¶€)
    const headerTitle = document.getElementById('system-title-header');
    if (headerTitle) {
        // í—¤ë” ë‚´ ì œëª©ì€ í°ìƒ‰ ìœ ì§€
    }

    // ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ í™œì„± ìƒ‰ìƒ ì ìš©
    const navBtns = document.querySelectorAll('.tab-btn.bg-blue-50');
    navBtns.forEach(btn => {
        btn.style.backgroundColor = adjustColor(menuActive, 90);
        btn.style.color = menuActive;
    });

    // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í˜¸ë²„ ìƒ‰ìƒì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ì£¼ì…
    let themeStyle = document.getElementById('theme-dynamic-style');
    if (!themeStyle) {
        themeStyle = document.createElement('style');
        themeStyle.id = 'theme-dynamic-style';
        document.head.appendChild(themeStyle);
    }
    themeStyle.textContent = `
        .tab-btn:hover, .tab-btn.active {
            background-color: ${adjustColor(menuActive, 90)} !important;
            color: ${menuActive} !important;
        }
        .tab-btn.bg-blue-50 {
            background-color: ${adjustColor(menuActive, 90)} !important;
            color: ${menuActive} !important;
        }
        header {
            background: linear-gradient(135deg, ${menubar} 0%, ${adjustColor(menubar, -15)} 100%) !important;
        }
        .btn-primary, button[class*="bg-blue-600"] {
            background-color: ${menuActive} !important;
        }
        .btn-primary:hover, button[class*="bg-blue-600"]:hover {
            background-color: ${adjustColor(menuActive, -10)} !important;
        }
        h2.text-2xl.font-bold.text-gray-800 i {
            color: ${menuActive} !important;
        }
    `;

    // ëª¨ë°”ì¼ í—¤ë” ì ìš©
    const mobileHeader = document.querySelector('.mobile-header');
    if (mobileHeader) {
        mobileHeader.style.background = `linear-gradient(90deg, ${menubar} 0%, ${adjustColor(menubar, -20)} 100%)`;
    }

    console.log('ğŸ¨ í…Œë§ˆ ì ìš© ì™„ë£Œ:', theme);
};

// í…Œë§ˆ ì €ì¥ í•¨ìˆ˜
window.saveThemeSettings = function() {
    // ë¨¼ì € input ìš”ì†Œì—ì„œ ì½ê¸° ì‹œë„
    const menubarInput = document.getElementById('theme-menubar');
    const titleInput = document.getElementById('theme-title');
    const subtitleInput = document.getElementById('theme-subtitle');
    const menuActiveInput = document.getElementById('theme-menu-active');

    let theme;
    if (menubarInput && menubarInput.value) {
        // input ìš”ì†Œê°€ ìˆìœ¼ë©´ ê±°ê¸°ì„œ ì½ê¸°
        theme = {
            menubar: menubarInput.value,
            title: titleInput?.value || '#1e3a8a',
            subtitle: subtitleInput?.value || '#374151',
            menuActive: menuActiveInput?.value || '#3b82f6'
        };
    } else {
        // input ìš”ì†Œê°€ ì—†ìœ¼ë©´ í˜„ì¬ CSSì—ì„œ ì½ê¸° ë˜ëŠ” ê¸°ì¡´ ì €ì¥ê°’ ì‚¬ìš©
        const existingTheme = JSON.parse(localStorage.getItem('system_theme') || 'null');
        if (existingTheme && existingTheme.menubar) {
            theme = existingTheme;
        } else {
            // CSS ë³€ìˆ˜ì—ì„œ ì½ê¸°
            const computedStyle = getComputedStyle(document.documentElement);
            const cssMenubar = computedStyle.getPropertyValue('--theme-menubar').trim();
            theme = {
                menubar: cssMenubar || '#1e40af',
                title: computedStyle.getPropertyValue('--theme-title').trim() || '#1e3a8a',
                subtitle: computedStyle.getPropertyValue('--theme-subtitle').trim() || '#374151',
                menuActive: computedStyle.getPropertyValue('--theme-menu-active').trim() || '#3b82f6'
            };
        }
    }

    console.log('ğŸ’¾ í…Œë§ˆ ì €ì¥:', theme);
    localStorage.setItem('system_theme', JSON.stringify(theme));
    window.applyTheme(theme);

    return theme;
};

// í…Œë§ˆ ë¡œë“œ í•¨ìˆ˜ (ì„¤ì • í¼ì— ê°’ ì±„ìš°ê¸°)
window.loadThemeSettings = function() {
    const theme = JSON.parse(localStorage.getItem('system_theme') || 'null') || THEME_PRESETS.default;

    // í…Œë§ˆê°€ localStorageì— ì—†ì—ˆìœ¼ë©´ ì €ì¥
    if (!localStorage.getItem('system_theme')) {
        localStorage.setItem('system_theme', JSON.stringify(theme));
        console.log('ğŸ’¾ ê¸°ë³¸ í…Œë§ˆ localStorageì— ì €ì¥:', theme);
    }

    const menubarInput = document.getElementById('theme-menubar');
    const titleInput = document.getElementById('theme-title');
    const subtitleInput = document.getElementById('theme-subtitle');
    const menuActiveInput = document.getElementById('theme-menu-active');

    if (menubarInput) {
        menubarInput.value = theme.menubar;
        document.getElementById('theme-menubar-text').value = theme.menubar;
    }
    if (titleInput) {
        titleInput.value = theme.title;
        document.getElementById('theme-title-text').value = theme.title;
    }
    if (subtitleInput) {
        subtitleInput.value = theme.subtitle;
        document.getElementById('theme-subtitle-text').value = theme.subtitle;
    }
    if (menuActiveInput) {
        menuActiveInput.value = theme.menuActive;
        document.getElementById('theme-menu-active-text').value = theme.menuActive;
    }
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ í…Œë§ˆ ì ìš©
document.addEventListener('DOMContentLoaded', () => {
    window.applyTheme();
});

// ==================== ê³µì§€ì‚¬í•­ ê´€ë¦¬ ====================
let notices = [];

async function loadNotices() {
    try {
        window.showLoading('ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const response = await axios.get(`${API_BASE_URL}/api/notices`);
        notices = response.data;
        renderNotices();
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('ê³µì§€ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', error);
        await window.showError('ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' + error.message, 'ë¡œë“œ ì‹¤íŒ¨');
    }
}

// RAG ë¬¸ì„œ ê´€ë¦¬ ë Œë”ë§
// RAG ì—…ë¡œë“œ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupRAGUploadListeners() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-blue-500', 'bg-blue-100');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('border-blue-500', 'bg-blue-100');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-blue-500', 'bg-blue-100');
        const files = Array.from(e.dataTransfer.files);
        handleRAGFileUpload(files);
    });

    // íŒŒì¼ ì„ íƒ
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleRAGFileUpload(files);
    });
}

// RAG íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
async function handleRAGFileUpload(files) {
    const validExtensions = ['.pdf', '.docx', '.doc', '.txt'];
    const maxSize = 50 * 1024 * 1024; // 50MB

    for (const file of files) {
        const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
        
        // íŒŒì¼ í˜•ì‹ ê²€ì¦
        if (!validExtensions.includes(ext)) {
            showNotification(`${file.name}: ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤`, 'error');
            continue;
        }

        // íŒŒì¼ í¬ê¸° ê²€ì¦
        if (file.size > maxSize) {
            showNotification(`${file.name}: íŒŒì¼ í¬ê¸°ê°€ 50MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤`, 'error');
            continue;
        }

        // ì—…ë¡œë“œ ì§„í–‰
        await uploadRAGFile(file);
    }

    // ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    loadRAGDocuments();
    loadRAGStatus();
}

// RAG íŒŒì¼ ì—…ë¡œë“œ
async function uploadRAGFile(file) {
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('upload-bar');
    const progressPercent = document.getElementById('upload-percent');
    const fileName = document.getElementById('upload-file-name');

    progressDiv.classList.remove('hidden');
    fileName.textContent = file.name;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch(`${API_BASE_URL}/api/rag/upload`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            showNotification(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.detail}`, 'error');
            progressDiv.classList.add('hidden');
            return;
        }

        const data = await response.json();
        const taskId = data.task_id;

        if (!taskId) {
            // task_idê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë™ê¸° ë°©ì‹ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            showNotification(`${file.name} ì—…ë¡œë“œ ì™„ë£Œ (${data.chunks_count || 0}ê°œ ì²­í¬)`, 'success');
            setTimeout(() => {
                progressDiv.classList.add('hidden');
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';
            }, 1000);
            return;
        }

        // ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ ìƒíƒœ í´ë§
        progressBar.style.width = '30%';
        progressPercent.textContent = '30%';

        const pollInterval = setInterval(async () => {
            try {
                const statusRes = await fetch(`${API_BASE_URL}/api/rag/task-status/${taskId}`);
                if (!statusRes.ok) {
                    clearInterval(pollInterval);
                    showNotification(`${file.name} ìƒíƒœ í™•ì¸ ì‹¤íŒ¨`, 'error');
                    progressDiv.classList.add('hidden');
                    return;
                }
                const status = await statusRes.json();

                if (status.status === 'parsing') {
                    progressBar.style.width = '50%';
                    progressPercent.textContent = '50%';
                } else if (status.status === 'embedding') {
                    progressBar.style.width = '75%';
                    progressPercent.textContent = '75%';
                } else if (status.status === 'completed') {
                    clearInterval(pollInterval);
                    progressBar.style.width = '100%';
                    progressPercent.textContent = '100%';
                    showNotification(`${file.name} ì—…ë¡œë“œ ì™„ë£Œ (${status.chunks || 0}ê°œ ì²­í¬)`, 'success');
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        progressBar.style.width = '0%';
                        progressPercent.textContent = '0%';
                    }, 1000);
                } else if (status.status === 'failed') {
                    clearInterval(pollInterval);
                    showNotification(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨: ${status.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    progressDiv.classList.add('hidden');
                }
            } catch (pollErr) {
                clearInterval(pollInterval);
                console.error('Polling error:', pollErr);
                showNotification(`${file.name} ìƒíƒœ í™•ì¸ ì‹¤íŒ¨`, 'error');
                progressDiv.classList.add('hidden');
            }
        }, 2000);

    } catch (error) {
        console.error('Upload error:', error);
        showNotification(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
        progressDiv.classList.add('hidden');
    }
}

// RAG ìƒíƒœ ë¡œë“œ
async function loadRAGStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/rag/status`);
        if (response.ok) {
            const data = await response.json();
            const statusText = document.getElementById('rag-status-text');
            if (statusText) {
                statusText.innerHTML = `
                    <span class="text-green-600 font-semibold">âœ… ì •ìƒ ì‘ë™</span> | 
                    ë¬¸ì„œ: ${data.document_count}ê°œ | 
                    ëª¨ë¸: ${data.embedding_model}
                `;
            }
        }
    } catch (error) {
        console.error('Status load error:', error);
    }
}

// RAG ë¬¸ì„œ ëª©ë¡ ë¡œë“œ
async function loadRAGDocuments() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/rag/documents`);
        if (response.ok) {
            const data = await response.json();
            const documentsList = document.getElementById('documents-list');
            const documentCount = document.getElementById('document-count');
            
            if (documentCount) {
                documentCount.textContent = data.unique_documents || 0;
            }

            if (documentsList) {
                if (!data.documents || data.documents.length === 0) {
                    documentsList.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-folder-open text-4xl mb-2"></i>
                            <p>ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    `;
                } else {
                    documentsList.innerHTML = data.documents.map(doc => `
                        <div class="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-file-alt text-2xl text-blue-500 mr-3"></i>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${doc.filename || 'ì•Œ ìˆ˜ ì—†ìŒ'}</h4>
                                        <p class="text-sm text-gray-500">
                                            ${doc.chunks_count || 0}ê°œ ì²­í¬ | 
                                            ${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString('ko-KR') : ''}
                                        </p>
                                    </div>
                                </div>
                                <button onclick="deleteRAGDocument('${doc.document_id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i> ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }
    } catch (error) {
        console.error('Documents load error:', error);
    }
}

// RAG ë¬¸ì„œ ì‚­ì œ
async function deleteRAGDocument(documentId) {
    if (!confirm('ì´ ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/api/rag/documents/${documentId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showNotification('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            loadRAGDocuments();
            loadRAGStatus();
        } else {
            const error = await response.json();
            showNotification(`ì‚­ì œ ì‹¤íŒ¨: ${error.detail}`, 'error');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showNotification(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

// ë²¡í„° DB ì´ˆê¸°í™”
async function clearVectorDB() {
    if (!confirm('ë²¡í„° DBë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë¬¸ì„œê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
        return;
    }

    if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/api/rag/clear`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showNotification('ë²¡í„° DBê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            loadRAGDocuments();
            loadRAGStatus();
        } else {
            const error = await response.json();
            showNotification(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.detail}`, 'error');
        }
    } catch (error) {
        console.error('Clear error:', error);
        showNotification(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

async function renderNotices() {
    const today = new Date().toISOString().split('T')[0];
    const app = document.getElementById('app');

    // ê³¼ì • ë° êµê³¼ëª© ëª©ë¡ ë¡œë“œ
    let courses = [];
    let subjects = [];
    try {
        const [coursesRes, subjectsRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/courses`),
            axios.get(`${API_BASE_URL}/api/subjects`)
        ]);
        courses = coursesRes.data || [];
        subjects = subjectsRes.data || [];
    } catch (e) {
        console.error('ê³¼ì •/êµê³¼ëª© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
    }

    // ê³µì§€ ìœ í˜•ë³„ ë¼ë²¨ê³¼ ìƒ‰ìƒ
    const typeLabels = {
        'all': { text: 'ì „ì²´', color: 'bg-blue-100 text-blue-700', icon: 'fa-globe' },
        'course': { text: 'ê³¼ì •', color: 'bg-green-100 text-green-700', icon: 'fa-users' },
        'subject': { text: 'êµê³¼ëª©', color: 'bg-purple-100 text-purple-700', icon: 'fa-book' }
    };

    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-bullhorn mr-2"></i>ê³µì§€ì‚¬í•­ ê´€ë¦¬
                </h2>
                <button onclick="showNoticeForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>ê³µì§€ì‚¬í•­ ì¶”ê°€
                </button>
            </div>

            <!-- ê³µì§€ì‚¬í•­ í¼ (ìˆ¨ê¹€) -->
            <div id="notice-form" class="hidden bg-gray-50 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4" id="form-title">ê³µì§€ì‚¬í•­ ì¶”ê°€</h3>
                <form id="notice-save-form">
                    <input type="hidden" id="edit-notice-id">

                    <!-- ê³µì§€ ìœ í˜• ì„ íƒ -->
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">ê³µì§€ ëŒ€ìƒ *</label>
                        <div class="flex gap-4 mb-3">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="notice-type" value="all" checked onchange="toggleNoticeTarget()" class="mr-2">
                                <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm"><i class="fas fa-globe mr-1"></i>ì „ì²´ ê³µì§€</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="notice-type" value="course" onchange="toggleNoticeTarget()" class="mr-2">
                                <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm"><i class="fas fa-users mr-1"></i>ê³¼ì •ë³„</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="notice-type" value="subject" onchange="toggleNoticeTarget()" class="mr-2">
                                <span class="px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-sm"><i class="fas fa-book mr-1"></i>êµê³¼ëª©ë³„</span>
                            </label>
                        </div>
                        <div id="target-select-container" class="hidden">
                            <select id="notice-target" class="w-full border rounded px-3 py-2">
                                <option value="">ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">ì œëª© *</label>
                        <input type="text" id="notice-title" class="w-full border rounded px-3 py-2" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 mb-2">ê²Œì‹œ ì‹œì‘ì¼ *</label>
                            <input type="date" id="notice-start-date" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">ê²Œì‹œ ì¢…ë£Œì¼ *</label>
                            <input type="date" id="notice-end-date" class="w-full border rounded px-3 py-2" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">
                            ë‚´ìš© *
                            <span class="text-sm text-gray-500">(ë§ˆí¬ë‹¤ìš´ ì§€ì›, ì´ë¯¸ì§€ URL í¬í•¨ ê°€ëŠ¥)</span>
                        </label>
                        <textarea id="notice-content" rows="10" class="w-full border rounded px-3 py-2 font-mono" placeholder="# ì œëª©&#10;&#10;ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”...&#10;&#10;- ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì‚¬ìš© ê°€ëŠ¥&#10;- ì´ë¯¸ì§€: ![ì„¤ëª…](ì´ë¯¸ì§€URL)&#10;- ë§í¬: [í…ìŠ¤íŠ¸](URL)" required></textarea>
                        <div class="mt-2 text-sm text-gray-600">
                            <strong>ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì˜ˆì‹œ:</strong><br>
                            # í° ì œëª©, ## ì¤‘ê°„ ì œëª©, ### ì‘ì€ ì œëª©<br>
                            **êµµê²Œ**, *ê¸°ìš¸ì„*, [ë§í¬](URL), ![ì´ë¯¸ì§€](URL)<br>
                            - ëª©ë¡1, - ëª©ë¡2
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button type="button" onclick="saveNotice()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-save mr-2"></i>ì €ì¥
                        </button>
                        <button type="button" onclick="hideNoticeForm()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </form>
            </div>

            <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ -->
            <div class="space-y-4">
                ${notices.length === 0 ? `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-inbox text-6xl mb-4"></i>
                        <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                ` : notices.map(notice => {
                    const isActive = today >= notice.start_date && today <= notice.end_date;
                    const statusColor = isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600';
                    const statusIcon = isActive ? 'fa-check-circle' : 'fa-clock';
                    const statusText = isActive ? 'ê²Œì‹œì¤‘' : today < notice.start_date ? 'ê²Œì‹œ ì˜ˆì •' : 'ì¢…ë£Œ';
                    const typeInfo = typeLabels[notice.notice_type || 'all'];

                    return `
                        <div class="border rounded-lg p-4 hover:shadow-md transition-shadow ${isActive ? 'border-green-300' : ''}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${typeInfo.color}">
                                            <i class="fas ${typeInfo.icon} mr-1"></i>${typeInfo.text}${notice.target_name ? `: ${notice.target_name}` : ''}
                                        </span>
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                                            <i class="fas ${statusIcon} mr-1"></i>${statusText}
                                        </span>
                                        <h3 class="text-lg font-bold text-gray-800">${notice.title}</h3>
                                    </div>
                                    <div class="text-sm text-gray-600 mb-2">
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${notice.start_date} ~ ${notice.end_date}
                                        ${notice.created_by ? `<span class="ml-4"><i class="fas fa-user mr-1"></i>${notice.created_by}</span>` : ''}
                                    </div>
                                    <div class="text-gray-700 line-clamp-3">
                                        ${notice.content.substring(0, 150)}${notice.content.length > 150 ? '...' : ''}
                                    </div>
                                </div>
                                <div class="flex gap-2 ml-4">
                                    <button onclick="viewNotice(${notice.id})" class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded" title="ìì„¸íˆ ë³´ê¸°">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="editNotice(${notice.id})" class="text-green-600 hover:text-green-800 px-3 py-1 rounded" title="ìˆ˜ì •">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteNotice(${notice.id})" class="text-red-600 hover:text-red-800 px-3 py-1 rounded" title="ì‚­ì œ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;

    // ê³¼ì •/êµê³¼ëª© ë°ì´í„°ë¥¼ ì „ì—­ìœ¼ë¡œ ì €ì¥
    window.noticeCoursesData = courses;
    window.noticeSubjectsData = subjects;
}

// ê³µì§€ ëŒ€ìƒ í† ê¸€
window.toggleNoticeTarget = function() {
    const noticeType = document.querySelector('input[name="notice-type"]:checked')?.value || 'all';
    const container = document.getElementById('target-select-container');
    const select = document.getElementById('notice-target');

    if (noticeType === 'all') {
        container.classList.add('hidden');
        select.innerHTML = '<option value="">ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
    } else {
        container.classList.remove('hidden');
        let options = '<option value="">ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';

        if (noticeType === 'course') {
            (window.noticeCoursesData || []).forEach(c => {
                options += `<option value="${c.code}">${c.name}</option>`;
            });
        } else if (noticeType === 'subject') {
            (window.noticeSubjectsData || []).forEach(s => {
                options += `<option value="${s.code}">${s.name}</option>`;
            });
        }
        select.innerHTML = options;
    }
};

window.showNoticeForm = function(noticeId = null) {
    const formDiv = document.getElementById('notice-form');
    const formTitle = document.getElementById('form-title');

    if (noticeId) {
        formTitle.textContent = 'ê³µì§€ì‚¬í•­ ìˆ˜ì •';
        const notice = notices.find(n => n.id === noticeId);
        if (notice) {
            document.getElementById('edit-notice-id').value = notice.id;
            document.getElementById('notice-title').value = notice.title;
            document.getElementById('notice-content').value = notice.content;
            document.getElementById('notice-start-date').value = notice.start_date;
            document.getElementById('notice-end-date').value = notice.end_date;

            // ê³µì§€ ìœ í˜• ì„¤ì •
            const noticeType = notice.notice_type || 'all';
            document.querySelector(`input[name="notice-type"][value="${noticeType}"]`).checked = true;
            toggleNoticeTarget();

            // ëŒ€ìƒ ì„ íƒ
            if (notice.target_code) {
                setTimeout(() => {
                    document.getElementById('notice-target').value = notice.target_code;
                }, 100);
            }
        }
    } else {
        formTitle.textContent = 'ê³µì§€ì‚¬í•­ ì¶”ê°€';
        document.getElementById('notice-save-form').reset();
        document.getElementById('edit-notice-id').value = '';
        document.querySelector('input[name="notice-type"][value="all"]').checked = true;
        toggleNoticeTarget();

        // ê¸°ë³¸ê°’: ì˜¤ëŠ˜ë¶€í„° 30ì¼ê°„
        const today = new Date();
        const endDate = new Date(today);
        endDate.setDate(endDate.getDate() + 30);
        document.getElementById('notice-start-date').value = today.toISOString().split('T')[0];
        document.getElementById('notice-end-date').value = endDate.toISOString().split('T')[0];
    }

    formDiv.classList.remove('hidden');
    formDiv.scrollIntoView({ behavior: 'smooth' });
    window.disableFilters(); // í•„í„° ë¹„í™œì„±í™”
};

window.hideNoticeForm = function() {
    document.getElementById('notice-form').classList.add('hidden');
    window.enableFilters(); // í•„í„° í™œì„±í™”
};

window.saveNotice = async function() {
    const noticeId = document.getElementById('edit-notice-id').value;
    const noticeType = document.querySelector('input[name="notice-type"]:checked')?.value || 'all';
    const targetCode = document.getElementById('notice-target')?.value || null;
    const title = document.getElementById('notice-title').value;
    const content = document.getElementById('notice-content').value;
    const startDate = document.getElementById('notice-start-date').value;
    const endDate = document.getElementById('notice-end-date').value;

    // í•„ìˆ˜ ì…ë ¥ ê²€ì¦
    if (noticeType !== 'all' && !targetCode) {
        await window.showError('ê³µì§€ ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('notice-target').focus();
        return;
    }

    if (!title.trim()) {
        await window.showError('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('notice-title').focus();
        return;
    }

    if (!content.trim()) {
        await window.showError('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('notice-content').focus();
        return;
    }

    if (!startDate) {
        await window.showError('ê²Œì‹œ ì‹œì‘ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('notice-start-date').focus();
        return;
    }

    if (!endDate) {
        await window.showError('ê²Œì‹œ ì¢…ë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'í•„ìˆ˜ í•­ëª© ëˆ„ë½');
        document.getElementById('notice-end-date').focus();
        return;
    }

    if (startDate > endDate) {
        await window.showError('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'ë‚ ì§œ ì˜¤ë¥˜');
        return;
    }

    const instructor = JSON.parse(sessionStorage.getItem('instructor'));
    const data = {
        notice_type: noticeType,
        target_code: noticeType !== 'all' ? targetCode : null,
        title: title.trim(),
        content: content.trim(),
        start_date: startDate,
        end_date: endDate,
        created_by: instructor?.name || null
    };

    try {
        if (noticeId) {
            await axios.put(`${API_BASE_URL}/api/notices/${noticeId}`, data);
            await window.showSuccess('ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì €ì¥ ì™„ë£Œ');
        } else {
            await axios.post(`${API_BASE_URL}/api/notices`, data);
            await window.showSuccess('ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì €ì¥ ì™„ë£Œ');
        }

        hideNoticeForm();
        loadNotices();
    } catch (error) {
        console.error('ê³µì§€ì‚¬í•­ ì €ì¥ ì‹¤íŒ¨:', error);
        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        await window.showError(`ê³µì§€ì‚¬í•­ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${errorMsg}`, 'ì €ì¥ ì‹¤íŒ¨');
    }
};

window.editNotice = function(noticeId) {
    window.showNoticeForm(noticeId);
};

window.viewNotice = function(noticeId) {
    const notice = notices.find(n => n.id === noticeId);
    if (!notice) return;
    
    // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
    const rawHtml = marked.parse(notice.content);
    const cleanHtml = DOMPurify.sanitize(rawHtml);
    const finalHtml = cleanHtml.replace(/<a /g, '<a target="_blank" rel="noopener noreferrer" ');
    
    const today = new Date().toISOString().split('T')[0];
    const isActive = today >= notice.start_date && today <= notice.end_date;
    const statusColor = isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600';
    const statusIcon = isActive ? 'fa-check-circle' : 'fa-clock';
    const statusText = isActive ? 'ê²Œì‹œì¤‘' : today < notice.start_date ? 'ê²Œì‹œ ì˜ˆì •' : 'ì¢…ë£Œ';
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="this.remove()">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white rounded-t-2xl sticky top-0 z-10">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColor}">
                                    <i class="fas ${statusIcon} mr-1"></i>${statusText}
                                </span>
                                <span class="text-blue-100 text-sm">
                                    <i class="fas fa-calendar mr-1"></i>${notice.start_date} ~ ${notice.end_date}
                                </span>
                            </div>
                            <h3 class="text-2xl font-bold">${notice.title}</h3>
                            ${notice.created_by ? `<p class="text-blue-100 text-sm mt-2"><i class="fas fa-user mr-1"></i>${notice.created_by}</p>` : ''}
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-8">
                    <div class="prose prose-lg max-w-none">
                        ${finalHtml}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
};

window.deleteNotice = async function(noticeId) {
    const confirmed = await window.showConfirm('ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'ì‚­ì œ í™•ì¸');
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/notices/${noticeId}`);
        await window.showSuccess('ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì‚­ì œ ì™„ë£Œ');
        loadNotices();
    } catch (error) {
        console.error('ê³µì§€ì‚¬í•­ ì‚­ì œ ì‹¤íŒ¨:', error);
        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        await window.showError(`ê³µì§€ì‚¬í•­ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${errorMsg}`, 'ì‚­ì œ ì‹¤íŒ¨');
    }
};

// ==================== ê°•ì‚¬ ë§ˆì´í˜ì´ì§€ ====================
let instructorNotes = [];
let currentInstructorNoteId = null;
window.showMyPageModal = async function() {
    const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
    if (!instructor || !instructor.code) {
        window.showAlert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    try {
        window.showLoading('MyPageë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        // ê³µì§€ì‚¬í•­ ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ
        let noticesHTML = '';
        const noticesResponse = await axios.get(`${API_BASE_URL}/api/notices`);
        const notices = noticesResponse.data;
        
        if (notices.length === 0) {
            noticesHTML = `
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-inbox text-6xl mb-4"></i>
                    <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            `;
        } else {
            noticesHTML = notices.map(notice => {
                const date = new Date(notice.created_at);
                const formattedDate = date.toLocaleDateString('ko-KR');
                
                return `
                    <div class="bg-white border rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold text-gray-800">${notice.title}</h3>
                            <span class="text-sm text-gray-500">${formattedDate}</span>
                        </div>
                        <p class="text-gray-600 whitespace-pre-wrap">${notice.content}</p>
                    </div>
                `;
            }).join('');
        }
        
        const modal = document.createElement('div');
        modal.id = 'mypage-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.onclick = (e) => { if (e.target === modal) closeMyPageModal(); };
        
        modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <!-- í—¤ë” -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center gap-4">
                    <i class="fas fa-user-circle text-4xl"></i>
                    <div>
                        <h3 class="text-2xl font-bold">My Page</h3>
                        <p class="text-sm text-blue-100 mt-1">
                            ${instructor.name}
                            ${instructor.instructor_type_name ? ' Â· ' + instructor.instructor_type_name : ' Â· ê°•ì‚¬'}
                            ${instructor.major ? ' Â· ' + instructor.major : ''}
                        </p>
                    </div>
                </div>
                <button onclick="closeMyPageModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="bg-white border-b sticky" style="top: 88px; z-index: 9;">
                <div class="flex gap-2 px-8">
                    <button onclick="switchMyPageTab('profile')" 
                            id="mypage-tab-profile"
                            class="px-6 py-3 font-semibold transition-all border-b-2 border-transparent hover:border-blue-500 hover:text-blue-600 text-gray-600">
                        <i class="fas fa-user mr-2"></i>ë‚´ ì •ë³´
                    </button>
                    <button onclick="switchMyPageTab('ssirn')" 
                            id="mypage-tab-ssirn"
                            class="px-6 py-3 font-semibold transition-all border-b-2 border-blue-500 text-blue-600">
                        <i class="fas fa-book-open mr-2"></i>SSIRNë©”ëª¨ì¥
                    </button>
                    <button onclick="switchMyPageTab('notices')" 
                            id="mypage-tab-notices"
                            class="px-6 py-3 font-semibold transition-all border-b-2 border-transparent hover:border-blue-500 hover:text-blue-600 text-gray-600">
                        <i class="fas fa-bullhorn mr-2"></i>ê³µì§€ì‚¬í•­
                    </button>
                </div>
            </div>
            
            <!-- ë‚´ ì •ë³´ ì„¹ì…˜ -->
            <div id="mypage-section-profile" class="p-8 hidden">
                <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
                <div class="mb-8 text-center">
                    <div class="inline-block relative">
                        <img id="mypage-photo" 
                             src="${instructor.profile_photo ? API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(instructor.profile_photo) + '&t=' + new Date().getTime() : 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect fill=%27%23ddd%27 width=%27200%27 height=%27200%27/%3E%3Ctext fill=%27%23999%27 font-family=%27sans-serif%27 font-size=%2716%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3ENo Photo%3C/text%3E%3C/svg%3E'}" 
                             alt="í”„ë¡œí•„ ì‚¬ì§„" 
                             class="w-40 h-40 rounded-full object-cover border-4 border-blue-500 shadow-lg"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect fill=%27%23ddd%27 width=%27200%27 height=%27200%27/%3E%3Ctext fill=%27%23999%27 font-family=%27sans-serif%27 font-size=%2716%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3ENo Photo%3C/text%3E%3C/svg%3E'">
                        <button onclick="document.getElementById('mypage-photo-input').click()" 
                                class="absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-3 shadow-lg">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <input type="file" id="mypage-photo-input" accept="image/*" class="hidden" onchange="uploadMyPagePhoto(event)">
                    <p class="text-sm text-gray-500 mt-3">í´ë¦­í•˜ì—¬ í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</p>
                    <!-- í”„ë¡œê·¸ë˜ìŠ¤ë°” -->
                    <div id="mypage-upload-progress" class="hidden mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="mypage-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="mypage-progress-text" class="text-sm text-gray-600 mt-2 text-center">ì—…ë¡œë“œ ì¤‘... 0%</p>
                    </div>
                </div>
                
                <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
                <div class="border-t pt-6 mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-paperclip mr-2 text-green-500"></i>ì‚¬ì§„ ë° íŒŒì¼ ì²¨ë¶€ (ê·¸ë¦¼íŒŒì¼, PDF, HWP, PPT, Excel, Word, TXT ë“±)
                    </h4>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" onclick="document.getElementById('mypage-file-input').click()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                            </button>
                            <button type="button" onclick="document.getElementById('mypage-camera-input').click()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-camera mr-2"></i>ì‚¬ì§„ ì´¬ì˜
                            </button>
                        </div>
                        <input type="file" id="mypage-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                               onchange="window.handleMyPageFileUpload(event)" class="hidden">
                        <input type="file" id="mypage-camera-input" accept="image/*"
                               onchange="window.handleMyPageFileUpload(event)" class="hidden">
                        <div id="mypage-file-upload-progress" class="hidden mb-3">
                            <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                <p class="text-sm text-blue-800 mb-2">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>
                                    ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                                </p>
                                <div class="w-full bg-blue-200 rounded-full h-2">
                                    <div id="mypage-file-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div id="mypage-files-preview" class="flex flex-col gap-2 mt-2"></div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ì²¨ë¶€ íŒŒì¼: <span id="mypage-file-count">${instructor.attachments ? JSON.parse(instructor.attachments).length : 0}</span>/20
                        </p>
                    </div>
                </div>
                
                <!-- ì •ë³´ ìˆ˜ì • í¼ -->
                <form id="mypage-form" class="space-y-6">
                    <!-- ì´ë¦„ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-user mr-2 text-blue-500"></i>ì´ë¦„
                        </label>
                        <input type="text" id="mypage-name" value="${instructor.name || ''}" 
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- ì „ê³µ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-book mr-2 text-green-500"></i>ì „ê³µ
                        </label>
                        <input type="text" id="mypage-major" value="${instructor.major || ''}" 
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- ì—°ë½ì²˜ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-phone mr-2 text-yellow-500"></i>ì—°ë½ì²˜
                        </label>
                        <input type="tel" id="mypage-phone" value="${instructor.phone || ''}" 
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- ì´ë©”ì¼ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-envelope mr-2 text-red-500"></i>ì´ë©”ì¼
                        </label>
                        <input type="email" id="mypage-email" value="${instructor.email || ''}" 
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
                    <div class="border-t pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-key mr-2 text-purple-500"></i>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                            </h4>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="mypage-change-password-checkbox" 
                                       class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 mr-2"
                                       onchange="togglePasswordFields()">
                                <span class="text-sm text-gray-700 font-semibold">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ê¸°</span>
                            </label>
                        </div>
                        <div id="mypage-password-fields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-gray-700 mb-2">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                                <div class="relative">
                                    <input type="password" id="mypage-old-password" 
                                           class="w-full px-4 py-3 pr-12 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                           disabled>
                                    <button type="button" onclick="togglePasswordVisibility('mypage-old-password')" 
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-eye" id="mypage-old-password-icon"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                                <div class="relative">
                                    <input type="password" id="mypage-new-password" 
                                           class="w-full px-4 py-3 pr-12 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                           disabled>
                                    <button type="button" onclick="togglePasswordVisibility('mypage-new-password')" 
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-eye" id="mypage-new-password-icon"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                <div class="relative">
                                    <input type="password" id="mypage-new-password-confirm" 
                                           class="w-full px-4 py-3 pr-12 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                                           disabled>
                                    <button type="button" onclick="togglePasswordVisibility('mypage-new-password-confirm')" 
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-eye" id="mypage-new-password-confirm-icon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë²„íŠ¼ -->
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="saveMyPage()" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                            <i class="fas fa-save mr-2"></i>ì €ì¥
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- SSIRNë©”ëª¨ì¥ ì„¹ì…˜ -->
            <div id="mypage-section-ssirn" class="p-8">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-book-open mr-3"></i>ë‚˜ì˜ SSIRNë©”ëª¨ì¥
                        </h2>
                        <p class="text-blue-100 mt-2 text-sm">ë¬´ì—‡ì´ë“  ë‚¨ê²¨ ë‘ë©´ ìë™ ê¸°ë¡ ë©ë‹ˆë‹¤.</p>
                    </div>
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-gray-600">ì´ <span id="mypage-ssirn-count" class="font-bold text-blue-600">0</span>ê°œì˜ ë©”ëª¨</p>
                            <button onclick="showInstructorNewNoteModal()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">
                                <i class="fas fa-plus mr-2"></i>ìƒˆ ë©”ëª¨
                            </button>
                        </div>
                        
                        <!-- ê²€ìƒ‰ì°½ -->
                        <div class="mb-4">
                            <div class="relative">
                                <input type="text" 
                                       id="mypage-ssirn-search" 
                                       placeholder="ë©”ëª¨ ë‚´ìš© ê²€ìƒ‰..." 
                                       class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       onkeyup="filterMyPageSSIRN()">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        
                        <!-- í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
                        <div id="mypage-ssirn-progress" class="mb-4 hidden">
                            <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                                <div id="mypage-ssirn-progress-bar" 
                                     class="bg-gradient-to-r from-blue-500 to-indigo-500 h-full transition-all duration-300 ease-out"
                                     style="width: 0%"></div>
                            </div>
                            <p id="mypage-ssirn-progress-text" class="text-sm text-gray-600 mt-2 text-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i>ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </p>
                        </div>
                        
                        <div id="mypage-ssirn-list" class="space-y-4"></div>
                        <div id="mypage-ssirn-empty" class="text-center py-12 text-gray-500">
                            <i class="fas fa-inbox text-6xl mb-4"></i>
                            <p>ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <button onclick="showInstructorNewNoteModal()" 
                                    class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>ì²« ë©”ëª¨ ì‘ì„±í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ê³µì§€ì‚¬í•­ ì„¹ì…˜ -->
            <div id="mypage-section-notices" class="p-8 hidden">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-bullhorn mr-3"></i>ê³µì§€ì‚¬í•­
                        </h2>
                        <p class="text-purple-100 mt-2 text-sm">ì¤‘ìš”í•œ ê³µì§€ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                    <div class="p-6 space-y-4">
                        ${noticesHTML}
                    </div>
                </div>
            </div>
        </div>
        `;
        
        document.body.appendChild(modal);
        
        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
        if (instructor.attachments) {
            try {
                const attachments = JSON.parse(instructor.attachments);
                updateMyPageFilePreview(attachments);
            } catch (e) {
                console.error('ì²¨ë¶€íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // ê¸°ë³¸ íƒ­ ë¡œë“œ
        switchMyPageTab('ssirn');
        
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('MyPage ë¡œë“œ ì‹¤íŒ¨:', error);
        window.showAlert('MyPageë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
};

window.closeMyPageModal = function() {
    const modal = document.getElementById('mypage-modal');
    if (modal) {
        modal.remove();
    }
};

window.switchMyPageTab = async function(tab) {
    // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('[id^="mypage-tab-"]').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-600');
    });
    document.getElementById(`mypage-tab-${tab}`).classList.remove('border-transparent', 'text-gray-600');
    document.getElementById(`mypage-tab-${tab}`).classList.add('border-blue-500', 'text-blue-600');
    
    // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
    document.getElementById('mypage-section-profile').classList.toggle('hidden', tab !== 'profile');
    document.getElementById('mypage-section-ssirn').classList.toggle('hidden', tab !== 'ssirn');
    document.getElementById('mypage-section-notices').classList.toggle('hidden', tab !== 'notices');
    
    // SSIRNë©”ëª¨ì¥ íƒ­ ì„ íƒ ì‹œ ë°ì´í„° ë¡œë“œ
    if (tab === 'ssirn') {
        await loadMyPageSSIRN();
    }
};

async function loadMyPageSSIRN() {
    const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ
    const progressContainer = document.getElementById('mypage-ssirn-progress');
    const progressBar = document.getElementById('mypage-ssirn-progress-bar');
    const progressText = document.getElementById('mypage-ssirn-progress-text');
    const listDiv = document.getElementById('mypage-ssirn-list');
    const emptyDiv = document.getElementById('mypage-ssirn-empty');
    
    if (progressContainer) {
        progressContainer.classList.remove('hidden');
        progressBar.style.width = '0%';
    }
    if (listDiv) listDiv.innerHTML = '';
    if (emptyDiv) emptyDiv.classList.add('hidden');
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    setTimeout(() => {
        if (progressBar) progressBar.style.width = '30%';
    }, 100);
    
    try {
        const response = await axios.get(`${API_BASE_URL}/api/class-notes?instructor_code=${instructor.code}`);
        const notes = response.data;
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” 70%
        if (progressBar) progressBar.style.width = '70%';
        
        const countSpan = document.getElementById('mypage-ssirn-count');
        
        if (countSpan) countSpan.textContent = notes.length;
        
        if (notes.length === 0) {
            if (listDiv) listDiv.innerHTML = '';
            if (emptyDiv) emptyDiv.classList.remove('hidden');
        } else {
            if (emptyDiv) emptyDiv.classList.add('hidden');
            if (listDiv) {
                // í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ë³€ê²½
                listDiv.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">ë‚ ì§œ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚´ìš©</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">ì‚¬ì§„</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${notes.map(note => {
                                    const date = new Date(note.note_date);
                                    const formattedDate = date.toLocaleDateString('ko-KR', { 
                                        year: 'numeric', 
                                        month: '2-digit', 
                                        day: '2-digit' 
                                    });
                                    const preview = note.content.substring(0, 100) + (note.content.length > 100 ? '...' : '');
                                    const photoCount = note.photo_urls ? JSON.parse(note.photo_urls).length : 0;
                                    
                                    return `
                                        <tr class="hover:bg-blue-50 cursor-pointer transition-colors" onclick="editInstructorNoteInline(${note.id})">
                                            <td class="px-6 py-3 whitespace-nowrap">
                                                <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>${formattedDate}
                                            </td>
                                            <td class="px-6 py-3">
                                                <div class="truncate max-w-2xl">${preview}</div>
                                            </td>
                                            <td class="px-6 py-3 whitespace-nowrap" onclick="event.stopPropagation()">
                                                ${photoCount > 0 ? (() => {
                                                    const photos = JSON.parse(note.photo_urls);
                                                    return `
                                                        <div class="flex items-center gap-2">
                                                            <div class="flex -space-x-2">
                                                                ${photos.slice(0, 3).map((photo, idx) => `
                                                                    <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(photo.url)}&size=60" 
                                                                         alt="${photo.name || 'ì‚¬ì§„'}"
                                                                         class="w-10 h-10 rounded-lg border-2 border-white object-cover cursor-pointer hover:scale-110 transition-transform shadow-md"
                                                                         onclick="showPhotoModal(${note.id}, ${idx})"
                                                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2760%27 height=%2760%27%3E%3Crect fill=%27%23ddd%27 width=%2760%27 height=%2760%27/%3E%3Ctext fill=%27%23999%27 font-size=%2712%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3EâŒ%3C/text%3E%3C/svg%3E'">
                                                                `).join('')}
                                                            </div>
                                                            ${photoCount > 3 ? `<span class="text-xs text-gray-500">+${photoCount - 3}</span>` : ''}
                                                        </div>
                                                    `;
                                                })() : '<span class="text-gray-400">-</span>'}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” 100% ì™„ë£Œ
        if (progressBar) {
            progressBar.style.width = '100%';
        }
        if (progressText) {
            progressText.innerHTML = '<i class="fas fa-check mr-2 text-green-500"></i>ë¡œë“œ ì™„ë£Œ!';
        }
        
        // 0.5ì´ˆ í›„ í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¸°ê¸°
        setTimeout(() => {
            if (progressContainer) {
                progressContainer.classList.add('hidden');
            }
        }, 500);
        
    } catch (error) {
        console.error('SSIRNë©”ëª¨ì¥ ë¡œë“œ ì‹¤íŒ¨:', error);
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—ëŸ¬ í‘œì‹œ
        if (progressBar) {
            progressBar.style.width = '100%';
            progressBar.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500');
            progressBar.classList.add('bg-red-500');
        }
        if (progressText) {
            progressText.innerHTML = '<i class="fas fa-times mr-2 text-red-500"></i>ë¡œë“œ ì‹¤íŒ¨';
        }
        
        const listDiv = document.getElementById('mypage-ssirn-list');
        if (listDiv) {
            listDiv.innerHTML = '<p class="text-red-500">ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
        
        // 2ì´ˆ í›„ í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¸°ê¸°
        setTimeout(() => {
            if (progressContainer) {
                progressContainer.classList.add('hidden');
            }
            if (progressBar) {
                progressBar.classList.remove('bg-red-500');
                progressBar.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500');
            }
        }, 2000);
    }
}

// SSIRN ë©”ëª¨ ê²€ìƒ‰ í•„í„°ë§
window.filterMyPageSSIRN = function() {
    const searchInput = document.getElementById('mypage-ssirn-search');
    if (!searchInput) return;
    
    const searchText = searchInput.value.toLowerCase().trim();
    const rows = document.querySelectorAll('#mypage-ssirn-list tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const content = row.textContent.toLowerCase();
        if (content.includes(searchText)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // ê²€ìƒ‰ ê²°ê³¼ ì—…ë°ì´íŠ¸
    const emptyDiv = document.getElementById('mypage-ssirn-empty');
    const listDiv = document.getElementById('mypage-ssirn-list');
    
    if (visibleCount === 0 && searchText !== '') {
        if (listDiv) listDiv.style.display = 'none';
        if (emptyDiv) {
            emptyDiv.classList.remove('hidden');
            emptyDiv.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-search text-6xl mb-4"></i>
                    <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p class="text-sm mt-2">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</p>
                </div>
            `;
        }
    } else {
        if (listDiv) listDiv.style.display = '';
        if (emptyDiv && visibleCount > 0) {
            emptyDiv.classList.add('hidden');
        }
    }
};

// ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬
window.showPhotoModal = async function(noteId, startIndex = 0) {
    try {
        // ë©”ëª¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await axios.get(`${API_BASE_URL}/api/class-notes/${noteId}`);
        const note = response.data;
        
        if (!note.photo_urls) {
            window.showAlert('ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
            return;
        }
        
        const photos = JSON.parse(note.photo_urls);
        if (photos.length === 0) {
            window.showAlert('ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
            return;
        }
        
        window.currentPhotoIndex = startIndex;
        window.currentPhotos = photos;
        
        const modal = document.createElement('div');
        modal.id = 'photo-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[70]';
        modal.onclick = (e) => { if (e.target === modal) closePhotoModal(); };
        
        modal.innerHTML = `
            <div class="relative w-full h-full flex items-center justify-center p-4">
                <!-- ë‹«ê¸° ë²„íŠ¼ -->
                <button onclick="closePhotoModal()" 
                        class="absolute top-4 right-4 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-3 z-10">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                
                <!-- ì´ì „ ë²„íŠ¼ -->
                ${photos.length > 1 ? `
                    <button onclick="showPrevPhoto()" 
                            class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-4 z-10">
                        <i class="fas fa-chevron-left text-2xl"></i>
                    </button>
                ` : ''}
                
                <!-- ì‚¬ì§„ í‘œì‹œ ì˜ì—­ -->
                <div class="flex flex-col items-center justify-center max-w-6xl max-h-full">
                    <img id="modal-photo-img" 
                         src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(photos[startIndex].url)}&size=1200" 
                         alt="${photos[startIndex].name || 'ì‚¬ì§„'}"
                         class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27800%27 height=%27600%27%3E%3Crect fill=%27%23333%27 width=%27800%27 height=%27600%27/%3E%3Ctext fill=%27%23999%27 font-size=%2724%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3Eì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨%3C/text%3E%3C/svg%3E'">
                    
                    <!-- íŒŒì¼ëª… ë° ì¹´ìš´í„° -->
                    <div class="mt-4 text-center">
                        <p id="modal-photo-name" class="text-white text-lg font-semibold">${photos[startIndex].name || 'ì‚¬ì§„'}</p>
                        <p id="modal-photo-counter" class="text-gray-400 text-sm mt-1">${startIndex + 1} / ${photos.length}</p>
                    </div>
                </div>
                
                <!-- ë‹¤ìŒ ë²„íŠ¼ -->
                ${photos.length > 1 ? `
                    <button onclick="showNextPhoto()" 
                            class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-4 z-10">
                        <i class="fas fa-chevron-right text-2xl"></i>
                    </button>
                ` : ''}
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ESC í‚¤ë¡œ ë‹«ê¸°
        document.addEventListener('keydown', handlePhotoModalKeydown);
    } catch (error) {
        console.error('ì‚¬ì§„ ëª¨ë‹¬ ì—´ê¸° ì‹¤íŒ¨:', error);
        window.showAlert('ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
};

window.closePhotoModal = function() {
    const modal = document.getElementById('photo-modal');
    if (modal) {
        modal.remove();
        document.removeEventListener('keydown', handlePhotoModalKeydown);
    }
};

window.showPrevPhoto = function() {
    if (!window.currentPhotos || window.currentPhotos.length === 0) return;
    
    window.currentPhotoIndex = (window.currentPhotoIndex - 1 + window.currentPhotos.length) % window.currentPhotos.length;
    updatePhotoModal();
};

window.showNextPhoto = function() {
    if (!window.currentPhotos || window.currentPhotos.length === 0) return;
    
    window.currentPhotoIndex = (window.currentPhotoIndex + 1) % window.currentPhotos.length;
    updatePhotoModal();
};

function updatePhotoModal() {
    const photo = window.currentPhotos[window.currentPhotoIndex];
    const imgElement = document.getElementById('modal-photo-img');
    const nameElement = document.getElementById('modal-photo-name');
    const counterElement = document.getElementById('modal-photo-counter');
    
    if (imgElement) {
        imgElement.src = `${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(photo.url)}&size=1200`;
        imgElement.alt = photo.name || 'ì‚¬ì§„';
    }
    
    if (nameElement) {
        nameElement.textContent = photo.name || 'ì‚¬ì§„';
    }
    
    if (counterElement) {
        counterElement.textContent = `${window.currentPhotoIndex + 1} / ${window.currentPhotos.length}`;
    }
}

function handlePhotoModalKeydown(event) {
    if (event.key === 'Escape') {
        closePhotoModal();
    } else if (event.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (event.key === 'ArrowRight') {
        showNextPhoto();
    }
}

async function loadInstructorNotes() {
    console.log('ğŸ“ loadInstructorNotes í•¨ìˆ˜ ì‹œì‘');
    try {
        window.showLoading('ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
        console.log('ğŸ” ê°•ì‚¬ ì •ë³´:', instructor);
        console.log('ğŸ” ê°•ì‚¬ ì½”ë“œ:', instructor.code);
        
        const response = await axios.get(`${API_BASE_URL}/api/class-notes`);
        console.log('ğŸ“¦ ì „ì²´ ë©”ëª¨:', response.data.length);
        console.log('ğŸ“¦ ë©”ëª¨ ë°ì´í„° ìƒ˜í”Œ:', response.data.slice(0, 3));
        
        // ë³¸ì¸ì˜ ë©”ëª¨ë§Œ í•„í„°ë§ (instructor_codeê°€ ë³¸ì¸ codeì¸ ê²ƒ)
        instructorNotes = response.data.filter(note => {
            console.log(`ë©”ëª¨ ${note.id}: instructor_code=${note.instructor_code}, ë‚´ ì½”ë“œ=${instructor.code}, ì¼ì¹˜=${note.instructor_code === instructor.code}`);
            return note.instructor_code === instructor.code;
        });
        console.log('âœ… ë‚´ ë©”ëª¨:', instructorNotes.length, instructorNotes);
        
        renderInstructorNotes();
        console.log('âœ… renderInstructorNotes ì™„ë£Œ');
        window.hideLoading();
    } catch (error) {
        window.hideLoading();
        console.error('âŒ ê°•ì‚¬ ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:', error);
        await window.showError('ë©”ëª¨ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'ë¡œë“œ ì‹¤íŒ¨');
    }
}

function renderInstructorNotes() {
    console.log('ğŸ¨ renderInstructorNotes í•¨ìˆ˜ ì‹œì‘');
    const table = document.getElementById('instructor-notes-table');
    const tbody = document.getElementById('instructor-notes-tbody');
    const empty = document.getElementById('instructor-notes-empty');
    const count = document.getElementById('instructor-notes-count');
    
    console.log('ğŸ“ DOM ìš”ì†Œ í™•ì¸:', {
        table: !!table,
        tbody: !!tbody,
        empty: !!empty,
        count: !!count
    });
    
    if (!tbody || !empty || !count) {
        console.error('âŒ í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    const searchText = document.getElementById('instructor-note-search')?.value.toLowerCase() || '';
    const dateFilter = document.getElementById('instructor-note-date-filter')?.value || '';
    
    let filtered = instructorNotes;
    
    if (searchText) {
        filtered = filtered.filter(note => 
            note.content?.toLowerCase().includes(searchText)
        );
    }
    
    if (dateFilter) {
        filtered = filtered.filter(note => note.note_date === dateFilter);
    }
    
    count.textContent = filtered.length;
    
    if (filtered.length === 0) {
        table.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
    }
    
    table.classList.remove('hidden');
    empty.classList.add('hidden');
    
    // ìµœì‹ ìˆœ ì •ë ¬
    filtered.sort((a, b) => new Date(b.note_date) - new Date(a.note_date));
    
    tbody.innerHTML = filtered.map(note => {
        const date = new Date(note.note_date);
        const formattedDate = date.toLocaleDateString('ko-KR', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit' 
        });
        
        // ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ì²« 80ì)
        const preview = note.content.substring(0, 80) + (note.content.length > 80 ? '...' : '');
        
        // ì‚¬ì§„ ê°œìˆ˜
        const photoCount = note.photo_urls ? JSON.parse(note.photo_urls).length : 0;
        
        return `
            <tr class="hover:bg-gray-50 cursor-pointer" onclick="viewInstructorNote(${note.id})">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>${formattedDate}
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">
                    <div class="line-clamp-2">${preview}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                    ${photoCount > 0 ? `<i class="fas fa-image text-green-500 mr-1"></i>${photoCount}ì¥` : '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                    <button onclick="event.stopPropagation(); viewInstructorNote(${note.id})" 
                            class="text-green-600 hover:text-green-900 mx-1" 
                            title="ë³´ê¸°">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="event.stopPropagation(); editInstructorNote(${note.id})" 
                            class="text-blue-600 hover:text-blue-900 mx-1" 
                            title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteInstructorNote(${note.id})" 
                            class="text-red-600 hover:text-red-900 mx-1" 
                            title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

window.searchInstructorNotes = function() {
    renderInstructorNotes();
};

window.clearInstructorNoteFilters = function() {
    document.getElementById('instructor-note-search').value = '';
    document.getElementById('instructor-note-date-filter').value = '';
    renderInstructorNotes();
};

window.showInstructorNewNoteModal = function() {
    currentInstructorNoteId = null;
    const today = new Date().toISOString().split('T')[0];
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onclick="closeInstructorNoteModal(event)">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white rounded-t-2xl sticky top-0 z-10">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold">
                            <i class="fas fa-plus-circle mr-2"></i>ìƒˆ ë©”ëª¨ ì‘ì„±
                        </h3>
                        <button onclick="closeInstructorNoteModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <form id="instructor-note-form" onsubmit="saveInstructorNote(event)">
                        <!-- ë‚ ì§œ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-calendar mr-2 text-blue-500"></i>ë‚ ì§œ
                            </label>
                            <input type="date" id="instructor-note-date" value="${today}" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <!-- ë‚´ìš© -->
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-pen mr-2 text-green-500"></i>ë‚´ìš© (ë§ˆí¬ë‹¤ìš´ ì§€ì›)
                            </label>
                            <textarea id="instructor-note-content" rows="10" 
                                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                      placeholder="ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...&#10;&#10;ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:&#10;# ì œëª©&#10;**êµµê²Œ**, *ê¸°ìš¸ì„*&#10;- ëª©ë¡&#10;[ë§í¬](URL)" required></textarea>
                        </div>
                        
                        <!-- ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-gray-700 font-semibold">
                                    <i class="fas fa-eye mr-2 text-purple-500"></i>ë¯¸ë¦¬ë³´ê¸°
                                </label>
                                <button type="button" onclick="updateInstructorNotePreview()" 
                                        class="text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                                </button>
                            </div>
                            <div id="instructor-note-preview" class="border rounded-lg p-4 bg-gray-50 prose max-w-none min-h-[100px]">
                                <p class="text-gray-400 italic">ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                            </div>
                        </div>
                        
                        <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-camera mr-2 text-pink-500"></i>ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒì‚¬í•­)
                            </label>
                            <input type="file" id="instructor-note-photos" multiple accept="image/*" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-sm text-gray-500 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>ì—¬ëŸ¬ ì¥ì˜ ì‚¬ì§„ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                            </p>
                            <div id="instructor-note-photo-preview" class="mt-3 grid grid-cols-3 gap-2"></div>
                        </div>
                        
                        <!-- ë²„íŠ¼ -->
                        <div class="flex gap-3">
                            <button type="submit" 
                                    class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                                <i class="fas fa-save mr-2"></i>ì €ì¥
                            </button>
                            <button type="button" onclick="closeInstructorNoteModal()" 
                                    class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">
                                <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
    document.getElementById('instructor-note-content').addEventListener('input', updateInstructorNotePreview);
    updateInstructorNotePreview();
};

window.updateInstructorNotePreview = function() {
    const content = document.getElementById('instructor-note-content').value;
    const preview = document.getElementById('instructor-note-preview');
    
    if (content.trim()) {
        const rawHtml = marked.parse(content);
        const cleanHtml = DOMPurify.sanitize(rawHtml);
        preview.innerHTML = cleanHtml;
    } else {
        preview.innerHTML = '<p class="text-gray-400 italic">ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>';
    }
};

window.closeInstructorNoteModal = function(event) {
    // eventê°€ ì—†ìœ¼ë©´ X ë²„íŠ¼ í´ë¦­, eventê°€ ìˆìœ¼ë©´ ë°°ê²½ í´ë¦­ ì²´í¬
    if (event && event.target !== event.currentTarget) return;
    
    // z-60 ë ˆë²¨ì˜ ëª¨ë‹¬ ë¨¼ì € ì œê±° (ë©”ëª¨ ìƒì„¸/í¸ì§‘/ì‘ì„±)
    const noteModals = document.querySelectorAll('.fixed.inset-0.z-\\[60\\]');
    if (noteModals.length > 0) {
        noteModals.forEach(modal => modal.remove());
        return;
    }
    
    // z-50 ë ˆë²¨ì˜ ëª¨ë‹¬ ì œê±° (ê¸°íƒ€)
    document.querySelector('.fixed.inset-0')?.remove();
};

window.saveInstructorNote = async function(event) {
    event.preventDefault();
    
    try {
        const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
        const noteDate = document.getElementById('instructor-note-date').value;
        const content = document.getElementById('instructor-note-content').value;
        const photoInput = document.getElementById('instructor-note-photos');
        
        let photoData = [];
        
        // ì‚¬ì§„ ì—…ë¡œë“œ
        if (photoInput.files.length > 0) {
            window.showLoading('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...');
            
            for (let file of photoInput.files) {
                const compressedFile = await window.compressImage(file);
                const formData = new FormData();
                formData.append('file', compressedFile);
                
                const uploadResponse = await axios.post(`${API_BASE_URL}/api/upload-image?category=teacher`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                
                photoData.push({
                    url: uploadResponse.data.url,
                    name: file.name
                });
            }
        }
        
        // ë©”ëª¨ ì €ì¥
        window.showLoading('ë©”ëª¨ ì €ì¥ ì¤‘...');
        
        const noteData = {
            instructor_code: instructor.code,
            student_id: null, // ê°•ì‚¬ ë³¸ì¸ ë©”ëª¨ëŠ” student_idê°€ null
            note_date: noteDate,
            content: content,
            photo_urls: JSON.stringify(photoData)
        };
        
        if (currentInstructorNoteId) {
            await axios.put(`${API_BASE_URL}/api/class-notes/${currentInstructorNoteId}`, noteData);
        } else {
            await axios.post(`${API_BASE_URL}/api/class-notes`, noteData);
        }
        
        window.hideLoading();
        closeInstructorNoteModal();
        
        // MyPage ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ MyPage SSIRNë©”ëª¨ì¥ ìƒˆë¡œê³ ì¹¨, ì•„ë‹ˆë©´ ë©”ì¸ í™”ë©´ ìƒˆë¡œê³ ì¹¨
        const mypageModal = document.getElementById('mypage-modal');
        if (mypageModal) {
            await loadMyPageSSIRN();
        } else {
            loadInstructorNotes();
        }
        
        // ì„±ê³µ ë©”ì‹œì§€ (await ì œê±°í•˜ì—¬ ë¸”ë¡œí‚¹ ë°©ì§€)
        if (currentInstructorNoteId) {
            window.showSuccess('ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ìˆ˜ì • ì™„ë£Œ');
        } else {
            window.showSuccess('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì €ì¥ ì™„ë£Œ');
        }
    } catch (error) {
        window.hideLoading();
        console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);
        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        await window.showError(`ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${errorMsg}`, 'ì €ì¥ ì‹¤íŒ¨');
    }
};

window.viewInstructorNote = function(noteId) {
    const note = instructorNotes.find(n => n.id === noteId);
    if (!note) return;
    
    const date = new Date(note.note_date);
    const formattedDate = date.toLocaleDateString('ko-KR', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        weekday: 'long'
    });
    
    const rawHtml = marked.parse(note.content);
    const cleanHtml = DOMPurify.sanitize(rawHtml);
    
    const photoUrls = note.photo_urls ? JSON.parse(note.photo_urls) : [];
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onclick="closeInstructorNoteModal(event)">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white rounded-t-2xl sticky top-0 z-10">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-2xl font-bold mb-2">
                                <i class="fas fa-book-open mr-2"></i>${formattedDate}
                            </h3>
                            <p class="text-blue-100 text-sm">
                                <i class="fas fa-user mr-1"></i>ê°•ì‚¬ ë©”ëª¨
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="event.stopPropagation(); editInstructorNote(${note.id})" 
                                    class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2" title="ìˆ˜ì •">
                                <i class="fas fa-edit text-xl"></i>
                            </button>
                            <button onclick="closeInstructorNoteModal()" 
                                    class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="prose max-w-none mb-6">
                        ${cleanHtml}
                    </div>
                    
                    ${photoUrls.length > 0 ? `
                        <div class="border-t pt-6">
                            <h4 class="font-semibold text-gray-700 mb-3">
                                <i class="fas fa-images mr-2 text-pink-500"></i>ì²¨ë¶€ ì‚¬ì§„ (${photoUrls.length}ì¥)
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                ${photoUrls.map((url, idx) => `
                                    <img src="${url}" alt="ì‚¬ì§„ ${idx + 1}" 
                                         class="w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
                                         onclick="window.open('${url}', '_blank')">
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
};

window.editInstructorNote = async function(noteId) {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/class-notes/${noteId}`);
        const note = response.data;
        
        currentInstructorNoteId = noteId;
        
        const modal = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onclick="closeInstructorNoteModal(event)">
                <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white rounded-t-2xl sticky top-0 z-10">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold">
                                <i class="fas fa-edit mr-2"></i>ë©”ëª¨ ìˆ˜ì •
                            </h3>
                            <button onclick="closeInstructorNoteModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="instructor-note-form" onsubmit="saveInstructorNote(event)">
                            <!-- ë‚ ì§œ -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-calendar mr-2 text-blue-500"></i>ë‚ ì§œ
                                </label>
                                <input type="date" id="instructor-note-date" value="${note.note_date}" 
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            
                            <!-- ë‚´ìš© -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-pen mr-2 text-green-500"></i>ë‚´ìš© (ë§ˆí¬ë‹¤ìš´ ì§€ì›)
                                </label>
                                <textarea id="instructor-note-content" rows="10" 
                                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                          required>${note.content}</textarea>
                            </div>
                            
                            <!-- ë¯¸ë¦¬ë³´ê¸° -->
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-gray-700 font-semibold">
                                        <i class="fas fa-eye mr-2 text-purple-500"></i>ë¯¸ë¦¬ë³´ê¸°
                                    </label>
                                    <button type="button" onclick="updateInstructorNotePreview()" 
                                            class="text-sm text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                                    </button>
                                </div>
                                <div id="instructor-note-preview" class="border rounded-lg p-4 bg-gray-50 prose max-w-none min-h-[100px]"></div>
                            </div>
                            
                            <!-- ê¸°ì¡´ ì‚¬ì§„ -->
                            ${note.photo_urls && JSON.parse(note.photo_urls).length > 0 ? `
                                <div class="mb-4">
                                    <label class="block text-gray-700 font-semibold mb-2">
                                        <i class="fas fa-images mr-2 text-pink-500"></i>ê¸°ì¡´ ì‚¬ì§„
                                    </label>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${JSON.parse(note.photo_urls).map((url, idx) => `
                                            <img src="${url}" alt="ì‚¬ì§„ ${idx + 1}" 
                                                 class="w-full h-32 object-cover rounded-lg">
                                        `).join('')}
                                    </div>
                                    <p class="text-sm text-gray-500 mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>ê¸°ì¡´ ì‚¬ì§„ì€ ìœ ì§€ë©ë‹ˆë‹¤
                                    </p>
                                </div>
                            ` : ''}
                            
                            <!-- ìƒˆ ì‚¬ì§„ ì—…ë¡œë“œ -->
                            <div class="mb-6">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-camera mr-2 text-pink-500"></i>ì¶”ê°€ ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒì‚¬í•­)
                                </label>
                                <input type="file" id="instructor-note-photos" multiple accept="image/*" 
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- ë²„íŠ¼ -->
                            <div class="flex gap-3">
                                <button type="submit" 
                                        class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                                    <i class="fas fa-save mr-2"></i>ìˆ˜ì • ì™„ë£Œ
                                </button>
                                <button type="button" onclick="closeInstructorNoteModal()" 
                                        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">
                                    <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        document.querySelector('.fixed.inset-0')?.remove();
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
        document.getElementById('instructor-note-content').addEventListener('input', updateInstructorNotePreview);
        updateInstructorNotePreview();
    } catch (error) {
        console.error('ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:', error);
        await window.showError('ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'ë¡œë“œ ì‹¤íŒ¨');
    }
};

window.deleteInstructorNote = async function(noteId) {
    const confirmed = await window.showConfirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'ì‚­ì œ í™•ì¸');
    if (!confirmed) return;
    
    try {
        await axios.delete(`${API_BASE_URL}/api/class-notes/${noteId}`);
        await window.showSuccess('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì‚­ì œ ì™„ë£Œ');
        
        // MyPage ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ MyPage SSIRNë©”ëª¨ì¥ ìƒˆë¡œê³ ì¹¨, ì•„ë‹ˆë©´ ë©”ì¸ í™”ë©´ ìƒˆë¡œê³ ì¹¨
        const mypageModal = document.getElementById('mypage-modal');
        if (mypageModal) {
            await loadMyPageSSIRN();
        } else {
            loadInstructorNotes();
        }
    } catch (error) {
        console.error('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨:', error);
        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        await window.showError(`ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${errorMsg}`, 'ì‚­ì œ ì‹¤íŒ¨');
    }
};

// ì¸ë¼ì¸ ìˆ˜ì • ëª¨ë“œ (MyPage SSIRNìš©)
window.editInstructorNoteInline = async function(noteId) {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/class-notes/${noteId}`);
        const note = response.data;
        
        currentInstructorNoteId = noteId;
        
        // ì‚¬ì§„ ì •ë³´ íŒŒì‹± (ê°ì²´ ë°°ì—´ ë˜ëŠ” URL ë°°ì—´)
        let photos = [];
        try {
            const parsed = JSON.parse(note.photo_urls || '[]');
            photos = parsed.map(item => {
                if (typeof item === 'string') {
                    return { url: item, name: item.split('/').pop() };
                }
                return item;
            });
        } catch (e) {
            photos = [];
        }
        
        const modal = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onclick="closeInstructorNoteModal(event)">
                <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="bg-gradient-to-r from-green-600 to-teal-600 p-6 text-white rounded-t-2xl sticky top-0 z-10">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold">
                                <i class="fas fa-edit mr-2"></i>ë©”ëª¨ ìˆ˜ì •
                            </h3>
                            <button onclick="closeInstructorNoteModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="instructor-note-inline-form" onsubmit="saveInstructorNoteInline(event)">
                            <!-- ë‚ ì§œ -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-calendar mr-2 text-blue-500"></i>ë‚ ì§œ
                                </label>
                                <input type="date" id="instructor-note-inline-date" value="${note.note_date}" 
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" required>
                            </div>
                            
                            <!-- ë‚´ìš© -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-pen mr-2 text-green-500"></i>ë‚´ìš©
                                </label>
                                <textarea id="instructor-note-inline-content" rows="10" 
                                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                                          required>${note.content}</textarea>
                            </div>
                            
                            <!-- ê¸°ì¡´ ì‚¬ì§„ -->
                            ${photos.length > 0 ? `
                                <div class="mb-4">
                                    <label class="block text-gray-700 font-semibold mb-2">
                                        <i class="fas fa-images mr-2 text-pink-500"></i>ê¸°ì¡´ ì‚¬ì§„
                                    </label>
                                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" id="existing-photos-container">
                                        ${photos.map((photo, idx) => `
                                            <div class="relative group" data-photo-idx="${idx}">
                                                <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(photo.url)}&size=300" 
                                                     alt="${photo.name}" 
                                                     class="w-full h-32 object-cover rounded-lg cursor-pointer hover:ring-4 hover:ring-blue-300 transition shadow-md"
                                                     onclick="showEditPhotoModal(${idx})"
                                                     data-photo-url="${photo.url.replace(/"/g, '&quot;')}" 
                                                     data-photo-name="${photo.name.replace(/"/g, '&quot;')}"
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27200%27%3E%3Crect fill=%27%23ddd%27 width=%27300%27 height=%27200%27/%3E%3Ctext fill=%27%23999%27 font-size=%2716%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3EâŒ ë¡œë“œ ì‹¤íŒ¨%3C/text%3E%3C/svg%3E'">
                                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent text-white text-xs p-2 rounded-b-lg">
                                                    <div class="truncate font-semibold">${photo.name}</div>
                                                </div>
                                                <div class="absolute top-2 right-2 flex gap-1">
                                                    <button type="button" 
                                                            onclick="event.stopPropagation(); showEditPhotoModal(${idx})"
                                                            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg"
                                                            title="ë¯¸ë¦¬ë³´ê¸°">
                                                        <i class="fas fa-search-plus text-sm"></i>
                                                    </button>
                                                    <button type="button" 
                                                            onclick="event.stopPropagation(); removeExistingPhoto(${idx})"
                                                            class="photo-remove-btn bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg"
                                                            title="ì‚­ì œ">
                                                        <i class="fas fa-trash text-sm"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="remaining-photos" value='${JSON.stringify(photos)}'>
                                </div>
                            ` : ''}
                            
                            <!-- ìƒˆ ì‚¬ì§„ ì—…ë¡œë“œ -->
                            <div class="mb-6">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-camera mr-2 text-pink-500"></i>ì¶”ê°€ ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒì‚¬í•­)
                                </label>
                                <input type="file" id="instructor-note-inline-photos" multiple accept="image/*" 
                                       onchange="previewNewPhotos(event)"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                                <div id="new-photos-preview" class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3"></div>
                            </div>
                            
                            <!-- ë²„íŠ¼ -->
                            <div class="flex gap-3">
                                <button type="submit" 
                                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold transition">
                                    <i class="fas fa-save mr-2"></i>ì €ì¥
                                </button>
                                <button type="button" onclick="closeInstructorNoteModal()" 
                                        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold transition">
                                    <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                                </button>
                                <button type="button" onclick="deleteInstructorNoteInline(${noteId})" 
                                        class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition">
                                    <i class="fas fa-trash mr-2"></i>ì‚­ì œ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // ì‚¬ì§„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelectorAll('#existing-photos-container img[data-photo-url]').forEach(img => {
            img.addEventListener('click', function(e) {
                e.stopPropagation();
                const url = this.getAttribute('data-photo-url');
                const name = this.getAttribute('data-photo-name');
                window.previewPhoto(url, name);
            });
        });
        
        // ì‚¬ì§„ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelectorAll('.photo-remove-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const idx = parseInt(this.closest('[data-photo-idx]').getAttribute('data-photo-idx'));
                window.removeExistingPhoto(idx);
            });
        });
    } catch (error) {
        console.error('ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:', error);
        await window.showError('ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'ë¡œë“œ ì‹¤íŒ¨');
    }
};

// ì¸ë¼ì¸ ìˆ˜ì • ëª¨ë“œì—ì„œ ì‚­ì œ
window.deleteInstructorNoteInline = async function(noteId) {
    const confirmed = await window.showConfirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'ì‚­ì œ í™•ì¸');
    if (!confirmed) return;
    
    try {
        window.showLoading('ë©”ëª¨ ì‚­ì œ ì¤‘...');
        await axios.delete(`${API_BASE_URL}/api/class-notes/${noteId}`);
        window.hideLoading();
        
        closeInstructorNoteModal();
        await loadMyPageSSIRN();
        window.showSuccess('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì‚­ì œ ì™„ë£Œ');
    } catch (error) {
        window.hideLoading();
        console.error('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨:', error);
        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        await window.showError(`ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${errorMsg}`, 'ì‚­ì œ ì‹¤íŒ¨');
    }
};

// ìˆ˜ì • ëª¨ë‹¬ì—ì„œ ê¸°ì¡´ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
window.showEditPhotoModal = function(startIndex = 0) {
    const input = document.getElementById('remaining-photos');
    if (!input) return;
    
    const photos = JSON.parse(input.value);
    if (photos.length === 0) return;
    
    window.currentEditPhotoIndex = startIndex;
    window.currentEditPhotos = photos;
    
    const modal = document.createElement('div');
    modal.id = 'edit-photo-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[80]';
    modal.onclick = (e) => { if (e.target === modal) closeEditPhotoModal(); };
    
    modal.innerHTML = `
        <div class="relative w-full h-full flex items-center justify-center p-4">
            <!-- ë‹«ê¸° ë²„íŠ¼ -->
            <button onclick="closeEditPhotoModal()" 
                    class="absolute top-4 right-4 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-3 z-10">
                <i class="fas fa-times text-2xl"></i>
            </button>
            
            <!-- ì´ì „ ë²„íŠ¼ -->
            ${photos.length > 1 ? `
                <button onclick="showEditPrevPhoto()" 
                        class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-4 z-10">
                    <i class="fas fa-chevron-left text-2xl"></i>
                </button>
            ` : ''}
            
            <!-- ì‚¬ì§„ í‘œì‹œ ì˜ì—­ -->
            <div class="flex flex-col items-center justify-center max-w-6xl max-h-full">
                <img id="edit-modal-photo-img" 
                     src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(photos[startIndex].url)}&size=1200" 
                     alt="${photos[startIndex].name || 'ì‚¬ì§„'}"
                     class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl"
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27800%27 height=%27600%27%3E%3Crect fill=%27%23333%27 width=%27800%27 height=%27600%27/%3E%3Ctext fill=%27%23999%27 font-size=%2724%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3Eì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨%3C/text%3E%3C/svg%3E'">
                
                <!-- íŒŒì¼ëª… ë° ì¹´ìš´í„° -->
                <div class="mt-4 text-center">
                    <p id="edit-modal-photo-name" class="text-white text-lg font-semibold">${photos[startIndex].name || 'ì‚¬ì§„'}</p>
                    <p id="edit-modal-photo-counter" class="text-gray-400 text-sm mt-1">${startIndex + 1} / ${photos.length}</p>
                </div>
            </div>
            
            <!-- ë‹¤ìŒ ë²„íŠ¼ -->
            ${photos.length > 1 ? `
                <button onclick="showEditNextPhoto()" 
                        class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-4 z-10">
                    <i class="fas fa-chevron-right text-2xl"></i>
                </button>
            ` : ''}
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', handleEditPhotoModalKeydown);
};

window.closeEditPhotoModal = function() {
    const modal = document.getElementById('edit-photo-modal');
    if (modal) {
        modal.remove();
        document.removeEventListener('keydown', handleEditPhotoModalKeydown);
    }
};

window.showEditPrevPhoto = function() {
    if (!window.currentEditPhotos || window.currentEditPhotos.length === 0) return;
    
    window.currentEditPhotoIndex = (window.currentEditPhotoIndex - 1 + window.currentEditPhotos.length) % window.currentEditPhotos.length;
    updateEditPhotoModal();
};

window.showEditNextPhoto = function() {
    if (!window.currentEditPhotos || window.currentEditPhotos.length === 0) return;
    
    window.currentEditPhotoIndex = (window.currentEditPhotoIndex + 1) % window.currentEditPhotos.length;
    updateEditPhotoModal();
};

function updateEditPhotoModal() {
    const photo = window.currentEditPhotos[window.currentEditPhotoIndex];
    const imgElement = document.getElementById('edit-modal-photo-img');
    const nameElement = document.getElementById('edit-modal-photo-name');
    const counterElement = document.getElementById('edit-modal-photo-counter');
    
    if (imgElement) {
        imgElement.src = `${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(photo.url)}&size=1200`;
        imgElement.alt = photo.name || 'ì‚¬ì§„';
    }
    
    if (nameElement) {
        nameElement.textContent = photo.name || 'ì‚¬ì§„';
    }
    
    if (counterElement) {
        counterElement.textContent = `${window.currentEditPhotoIndex + 1} / ${window.currentEditPhotos.length}`;
    }
}

function handleEditPhotoModalKeydown(event) {
    if (event.key === 'Escape') {
        closeEditPhotoModal();
    } else if (event.key === 'ArrowLeft') {
        showEditPrevPhoto();
    } else if (event.key === 'ArrowRight') {
        showEditNextPhoto();
    }
}

// ê¸°ì¡´ ì‚¬ì§„ ì‚­ì œ
window.removeExistingPhoto = function(index) {
    const input = document.getElementById('remaining-photos');
    const photos = JSON.parse(input.value);
    photos.splice(index, 1);
    input.value = JSON.stringify(photos);
    
    // UI ì—…ë°ì´íŠ¸
    const container = document.getElementById('existing-photos-container');
    const items = container.querySelectorAll('.relative.group');
    if (items[index]) {
        items[index].remove();
    }
};

// ìƒˆ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
window.previewNewPhotos = function(event) {
    const files = event.target.files;
    const previewContainer = document.getElementById('new-photos-preview');
    previewContainer.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'relative';
            div.innerHTML = `
                <img src="${e.target.result}" alt="${file.name}" 
                     class="w-full h-32 object-cover rounded-lg">
                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-1 rounded-b-lg truncate">
                    ${file.name}
                </div>
            `;
            previewContainer.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
};

// ì‚¬ì§„ í™•ëŒ€ ë¯¸ë¦¬ë³´ê¸°
window.previewPhoto = function(url, name) {
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[70] p-4" onclick="this.remove()">
            <div class="max-w-5xl w-full" onclick="event.stopPropagation()">
                <div class="bg-white rounded-t-lg p-4 flex justify-between items-center">
                    <h3 class="font-semibold text-gray-800">${name}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <img src="${url}" alt="${name}" class="w-full max-h-[80vh] object-contain bg-gray-100">
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
};

// ì¸ë¼ì¸ ì €ì¥
window.saveInstructorNoteInline = async function(event) {
    event.preventDefault();
    
    try {
        const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
        const noteDate = document.getElementById('instructor-note-inline-date').value;
        const content = document.getElementById('instructor-note-inline-content').value;
        const photoInput = document.getElementById('instructor-note-inline-photos');
        
        // ê¸°ì¡´ ì‚¬ì§„ (ì‚­ì œë˜ì§€ ì•Šì€ ê²ƒë“¤)
        const remainingPhotosInput = document.getElementById('remaining-photos');
        let allPhotos = remainingPhotosInput ? JSON.parse(remainingPhotosInput.value) : [];
        
        // ìƒˆ ì‚¬ì§„ ì—…ë¡œë“œ
        if (photoInput && photoInput.files.length > 0) {
            window.showLoading('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...');
            
            for (let file of photoInput.files) {
                const compressedFile = await window.compressImage(file);
                const formData = new FormData();
                formData.append('file', compressedFile);
                
                const uploadResponse = await axios.post(`${API_BASE_URL}/api/upload-image?category=teacher`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                
                allPhotos.push({
                    url: uploadResponse.data.url,
                    name: file.name
                });
            }
        }
        
        window.showLoading('ë©”ëª¨ ì €ì¥ ì¤‘...');
        
        const noteData = {
            instructor_code: instructor.code,
            student_id: null,
            note_date: noteDate,
            content: content,
            photo_urls: JSON.stringify(allPhotos)
        };
        
        await axios.put(`${API_BASE_URL}/api/class-notes/${currentInstructorNoteId}`, noteData);
        
        window.hideLoading();
        closeInstructorNoteModal();
        await loadMyPageSSIRN();
        window.showSuccess('ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ìˆ˜ì • ì™„ë£Œ');
    } catch (error) {
        window.hideLoading();
        console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);
        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        await window.showError(`ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${errorMsg}`, 'ì €ì¥ ì‹¤íŒ¨');
    }
};

// ==================== MyPage í”„ë¡œí•„ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ====================

window.uploadMyPagePhoto = async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
    if (!file.type.startsWith('image/')) {
        window.showAlert('âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
        event.target.value = '';
        return;
    }
    
    // íŒŒì¼ í¬ê¸° í™•ì¸ (10MB ì œí•œ)
    if (file.size > 10 * 1024 * 1024) {
        window.showAlert('âš ï¸ íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        event.target.value = '';
        return;
    }
    
    // íŒŒì¼ì„ ì„ì‹œë¡œ ì €ì¥ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤ì œ ì—…ë¡œë“œ)
    window.mypagePendingPhoto = file;
    
    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    const reader = new FileReader();
    reader.onload = function(e) {
        const photoImg = document.getElementById('mypage-photo');
        photoImg.src = e.target.result;
        
        // ë¯¸ë¦¬ë³´ê¸° ë°°ì§€ í‘œì‹œ
        const photoContainer = photoImg.parentElement;
        let badge = photoContainer.querySelector('.preview-badge');
        if (!badge) {
            badge = document.createElement('div');
            badge.className = 'preview-badge absolute top-2 right-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded-full shadow-lg';
            badge.innerHTML = '<i class="fas fa-clock mr-1"></i>ë¯¸ë¦¬ë³´ê¸°';
            photoContainer.appendChild(badge);
        }
        
        window.showAlert('ğŸ“¸ ì‚¬ì§„ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'info');
    };
    reader.readAsDataURL(file);
};

window.handleMyPageFileUpload = async function(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    const instructor = JSON.parse(sessionStorage.getItem('instructor'));
    const progressDiv = document.getElementById('mypage-file-upload-progress');
    const progressBar = document.getElementById('mypage-file-progress-bar');
    
    try {
        // ê¸°ì¡´ ì²¨ë¶€ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
        let attachments = [];
        if (instructor.attachments) {
            try {
                attachments = JSON.parse(instructor.attachments);
            } catch (e) {
                attachments = [];
            }
        }
        
        // íŒŒì¼ ê°œìˆ˜ ì œí•œ ì²´í¬ (ìµœëŒ€ 20ê°œ)
        const remainingSlots = 20 - attachments.length;
        if (remainingSlots <= 0) {
            window.showAlert('âš ï¸ ì²¨ë¶€ íŒŒì¼ì€ ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
            event.target.value = '';
            return;
        }
        
        if (files.length > remainingSlots) {
            window.showAlert(`âš ï¸ ${remainingSlots}ê°œì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${attachments.length}/20)`, 'warning');
            event.target.value = '';
            return;
        }
        
        progressDiv.classList.remove('hidden');
        progressBar.style.width = '0%';
        
        // íŒŒì¼ ì—…ë¡œë“œ
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ì´ë¯¸ì§€ ìë™ ì••ì¶• (PDF ë“±ì€ ê·¸ëŒ€ë¡œ)
            let processedFile = file;
            if (file.type.startsWith('image/')) {
                try {
                    processedFile = await window.compressImage(file);
                    console.log(`ì´ë¯¸ì§€ ì••ì¶•: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB`);
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:', error);
                    processedFile = file;
                }
            }
            
            const formData = new FormData();
            formData.append('file', processedFile);
            
            const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=teacher`, formData, {
                headers: { 'Content-Type': 'multipart/form-data' },
                onUploadProgress: (progressEvent) => {
                    const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                    progressBar.style.width = percentCompleted + '%';
                }
            });
            
            // URLê³¼ ì›ë³¸ íŒŒì¼ëª…ì„ í•¨ê»˜ ì €ì¥
            const urlWithOriginalName = response.data.original_filename 
                ? `${response.data.url}#${encodeURIComponent(response.data.original_filename)}`
                : response.data.url;
            attachments.push(urlWithOriginalName);
        }
        
        // í”„ë¡œí•„ ì‚¬ì§„ URL ê°€ì ¸ì˜¤ê¸°
        const profilePhotoSrc = document.getElementById('mypage-photo').src;
        let profilePhoto = null;
        if (profilePhotoSrc.includes('/api/thumbnail')) {
            const urlParams = new URLSearchParams(profilePhotoSrc.split('?')[1]);
            profilePhoto = urlParams.get('url');
        }
        
        // ìë™ ì €ì¥
        const data = {
            name: document.getElementById('mypage-name').value,
            major: document.getElementById('mypage-major').value || '',
            phone: document.getElementById('mypage-phone').value || '',
            email: document.getElementById('mypage-email').value || '',
            profile_photo: profilePhoto,
            attachments: JSON.stringify(attachments)
        };
        
        await axios.put(`${API_BASE_URL}/api/instructors/${instructor.code}`, data);
        
        // sessionStorage ì—…ë°ì´íŠ¸
        instructor.attachments = JSON.stringify(attachments);
        sessionStorage.setItem('instructor', JSON.stringify(instructor));
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        updateMyPageFilePreview(attachments);
        
        // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        const fileCountSpan = document.getElementById('mypage-file-count');
        if (fileCountSpan) {
            fileCountSpan.textContent = attachments.length;
        }
        
        progressBar.style.width = '100%';
        window.showAlert(`âœ… ${files.length}ê°œ íŒŒì¼ì´ ì—…ë¡œë“œë˜ê³  ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (${attachments.length}/20)`, 'success');
        
        setTimeout(() => {
            progressDiv.classList.add('hidden');
        }, 2000);
        
    } catch (error) {
        console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        progressDiv.classList.add('hidden');
        window.showAlert('âŒ íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    }
    
    // íŒŒì¼ input ì´ˆê¸°í™”
    event.target.value = '';
};

function updateMyPageFilePreview(photoUrls) {
    const previewDiv = document.getElementById('mypage-files-preview');
    if (!previewDiv || !photoUrls || photoUrls.length === 0) {
        if (previewDiv) previewDiv.innerHTML = '';
        return;
    }
    
    previewDiv.innerHTML = photoUrls.map((urlData, index) => {
        // URLê³¼ ì›ë³¸ íŒŒì¼ëª… ë¶„ë¦¬
        const [url, encodedFilename] = urlData.split('#');
        const originalFilename = encodedFilename ? decodeURIComponent(encodedFilename) : url.split('/').pop();
        
        // í™•ì¥ì ì¶”ì¶œ
        const extension = originalFilename.split('.').pop().toLowerCase();
        
        // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(extension);
        
        if (isImage) {
            return `
                <div class="relative flex items-center gap-3 p-3 bg-white border rounded-lg">
                    <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(url)}" 
                         alt="ì²¨ë¶€ ${index + 1}" 
                         class="w-16 h-16 object-cover rounded">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${originalFilename}</p>
                        <p class="text-xs text-gray-500">ì´ë¯¸ì§€ íŒŒì¼</p>
                    </div>
                    <button onclick="removeMyPageFile(${index})" 
                            class="text-red-500 hover:text-red-700 px-3 py-1">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        } else {
            return `
                <div class="relative flex items-center gap-3 p-3 bg-white border rounded-lg">
                    <div class="w-16 h-16 flex items-center justify-center bg-gray-100 rounded">
                        <i class="${getFileIcon(extension)} text-3xl text-gray-600"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${originalFilename}</p>
                        <p class="text-xs text-gray-500">${extension.toUpperCase()} íŒŒì¼</p>
                    </div>
                    <button onclick="removeMyPageFile(${index})" 
                            class="text-red-500 hover:text-red-700 px-3 py-1">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }
    }).join('');
}

function getFileIcon(extension) {
    const iconMap = {
        'pdf': 'fas fa-file-pdf',
        'doc': 'fas fa-file-word',
        'docx': 'fas fa-file-word',
        'xls': 'fas fa-file-excel',
        'xlsx': 'fas fa-file-excel',
        'ppt': 'fas fa-file-powerpoint',
        'pptx': 'fas fa-file-powerpoint',
        'txt': 'fas fa-file-alt',
        'hwp': 'fas fa-file-alt',
        'zip': 'fas fa-file-archive',
        'rar': 'fas fa-file-archive'
    };
    return iconMap[extension] || 'fas fa-file';
}

window.removeMyPageFile = async function(index) {
    const instructor = JSON.parse(sessionStorage.getItem('instructor'));
    
    let attachments = [];
    if (instructor.attachments) {
        try {
            attachments = JSON.parse(instructor.attachments);
        } catch (e) {
            attachments = [];
        }
    }
    
    // íŒŒì¼ ì œê±°
    attachments.splice(index, 1);
    
    // í”„ë¡œí•„ ì‚¬ì§„ URL ê°€ì ¸ì˜¤ê¸°
    const profilePhotoSrc = document.getElementById('mypage-photo').src;
    let profilePhoto = null;
    if (profilePhotoSrc.includes('/api/thumbnail')) {
        const urlParams = new URLSearchParams(profilePhotoSrc.split('?')[1]);
        profilePhoto = urlParams.get('url');
    }
    
    // ì„œë²„ì— ì €ì¥
    try {
        const data = {
            name: document.getElementById('mypage-name').value,
            major: document.getElementById('mypage-major').value || '',
            phone: document.getElementById('mypage-phone').value || '',
            email: document.getElementById('mypage-email').value || '',
            profile_photo: profilePhoto,
            attachments: JSON.stringify(attachments)
        };
        
        await axios.put(`${API_BASE_URL}/api/instructors/${instructor.code}`, data);
        
        // sessionStorage ì—…ë°ì´íŠ¸
        instructor.attachments = JSON.stringify(attachments);
        sessionStorage.setItem('instructor', JSON.stringify(instructor));
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        updateMyPageFilePreview(attachments);
        
        // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        const fileCountSpan = document.getElementById('mypage-file-count');
        if (fileCountSpan) {
            fileCountSpan.textContent = attachments.length;
        }
        
        window.showAlert('âœ… íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    } catch (error) {
        console.error('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
};

window.saveMyPage = async function() {
    const instructor = JSON.parse(sessionStorage.getItem('instructor'));
    
    try {
        window.showLoading('ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘...');
        
        // ë¯¸ë¦¬ë³´ê¸° ë°°ì§€ ì œê±°
        const photoContainer = document.getElementById('mypage-photo').parentElement;
        const badge = photoContainer.querySelector('.preview-badge');
        if (badge) {
            badge.remove();
        }
        
        // í”„ë¡œí•„ ì‚¬ì§„ URL ê°€ì ¸ì˜¤ê¸°
        const profilePhotoSrc = document.getElementById('mypage-photo').src;
        let profilePhoto = null;
        
        // ë¯¸ë¦¬ë³´ê¸° ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œ
        if (window.mypagePendingPhoto) {
            try {
                // íŒŒì¼ ì••ì¶• (1MB ì´ìƒì´ë©´ ì••ì¶•)
                let uploadFile = window.mypagePendingPhoto;
                const originalSize = window.mypagePendingPhoto.size / 1024 / 1024; // MB
                
                if (window.mypagePendingPhoto.size > 1 * 1024 * 1024) {  // 1MB ì´ìƒì´ë©´ ì••ì¶•
                    try {
                        uploadFile = await window.compressImage(window.mypagePendingPhoto);
                        const compressedSize = uploadFile.size / 1024 / 1024;
                        console.log(`âœ… ì´ë¯¸ì§€ ì••ì¶•: ${originalSize.toFixed(2)}MB â†’ ${compressedSize.toFixed(2)}MB`);
                    } catch (error) {
                        console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨:', error);
                    }
                }
                
                const formData = new FormData();
                formData.append('file', uploadFile);
                
                const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=teacher`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                
                profilePhoto = response.data.url;
                
                // ì—…ë¡œë“œëœ ì‚¬ì§„ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                const timestamp = new Date().getTime();
                document.getElementById('mypage-photo').src = API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(profilePhoto) + '&t=' + timestamp;
                
                // ì„ì‹œ íŒŒì¼ ì œê±°
                window.mypagePendingPhoto = null;
                
                console.log('âœ… í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ:', profilePhoto);
            } catch (error) {
                window.hideLoading();
                console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                window.showAlert('âŒ ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                return;
            }
        } else if (profilePhotoSrc.includes('/api/thumbnail')) {
            const urlParams = new URLSearchParams(profilePhotoSrc.split('?')[1]);
            profilePhoto = urlParams.get('url');
        }
        
        // ì²¨ë¶€ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
        let attachments = [];
        if (instructor.attachments) {
            try {
                attachments = JSON.parse(instructor.attachments);
            } catch (e) {
                attachments = [];
            }
        }
        
        // ë°ì´í„° ì¤€ë¹„
        const data = {
            name: document.getElementById('mypage-name').value,
            major: document.getElementById('mypage-major').value || '',
            phone: document.getElementById('mypage-phone').value || '',
            email: document.getElementById('mypage-email').value || '',
            profile_photo: profilePhoto,
            attachments: JSON.stringify(attachments)
        };
        
        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì²´í¬
        const changePassword = document.getElementById('mypage-change-password-checkbox').checked;
        if (changePassword) {
            const oldPassword = document.getElementById('mypage-old-password').value;
            const newPassword = document.getElementById('mypage-new-password').value;
            const newPasswordConfirm = document.getElementById('mypage-new-password-confirm').value;
            
            if (!oldPassword || !newPassword || !newPasswordConfirm) {
                window.showAlert('âš ï¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì„ ì›í•˜ì‹œë©´ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            if (newPassword !== newPasswordConfirm) {
                window.showAlert('âš ï¸ ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            if (oldPassword !== instructor.password) {
                window.showAlert('âš ï¸ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            data.password = newPassword;
        }
        
        // ì„œë²„ì— ì €ì¥
        await axios.put(`${API_BASE_URL}/api/instructors/${instructor.code}`, data);
        
        // sessionStorage ì—…ë°ì´íŠ¸
        Object.assign(instructor, data);
        if (changePassword) {
            instructor.password = data.password;
        }
        sessionStorage.setItem('instructor', JSON.stringify(instructor));
        
        // í—¤ë” ì—…ë°ì´íŠ¸
        updateHeader();
        
        window.hideLoading();
        window.showAlert('âœ… ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        
        // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ì´ˆê¸°í™”
        if (changePassword) {
            document.getElementById('mypage-change-password-checkbox').checked = false;
            togglePasswordFields();
        }
    } catch (error) {
        window.hideLoading();
        console.error('ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
        window.showAlert('âŒ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    }
};

window.togglePasswordFields = function() {
    const checkbox = document.getElementById('mypage-change-password-checkbox');
    const fields = document.getElementById('mypage-password-fields');
    const inputs = fields.querySelectorAll('input');
    
    if (checkbox.checked) {
        fields.classList.remove('hidden');
        inputs.forEach(input => input.disabled = false);
    } else {
        fields.classList.add('hidden');
        inputs.forEach(input => {
            input.disabled = true;
            input.value = '';
        });
    }
};

window.togglePasswordVisibility = function(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId + '-icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
};

// ==================== ì˜ˆì§„ì´ 3D ì±„íŒ… ====================
function renderAesong3DChat() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <style>
            /* 3D ì±„íŒ… ì „ìš© ìŠ¤íƒ€ì¼ */
            #aesong-3d-container {
                position: relative;
                width: 100%;
                height: 600px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }
            
            #aesong-canvas {
                width: 100%;
                height: 100%;
                display: block;
            }
            
            .character-selector {
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(255,255,255,0.95);
                border-radius: 15px;
                padding: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10;
            }
            
            .character-option {
                display: flex;
                align-items: center;
                padding: 10px;
                margin: 5px 0;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
                white-space: nowrap;
            }
            
            .character-option:hover {
                background: rgba(102, 126, 234, 0.1);
            }
            
            .character-option.active {
                background: rgba(102, 126, 234, 0.2);
                border-color: #667eea;
            }
            
            .character-option img {
                width: 50px;
                height: 50px;
                border-radius: 10px;
                margin-right: 10px;
                object-fit: cover;
            }
            
            .chat-controls {
                position: absolute;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 10px;
                z-index: 10;
            }
            
            .voice-btn {
                width: 70px;
                height: 70px;
                border-radius: 50%;
                border: none;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                font-size: 28px;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            }
            
            .voice-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
            }
            
            .voice-btn.recording {
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                animation: pulse 1.5s ease-in-out infinite;
                box-shadow: 0 4px 15px rgba(239, 68, 68, 0.6);
            }
            
            .voice-btn.recording::after {
                content: '';
                position: absolute;
                width: 90px;
                height: 90px;
                border: 3px solid rgba(239, 68, 68, 0.5);
                border-radius: 50%;
                animation: ripple 1.5s ease-out infinite;
            }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            @keyframes ripple {
                0% {
                    transform: scale(0.8);
                    opacity: 1;
                }
                100% {
                    transform: scale(1.4);
                    opacity: 0;
                }
            }
            
            .status-text {
                position: absolute;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px 40px;
                border-radius: 15px;
                font-weight: 600;
                font-size: 16px;
                color: white;
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
                z-index: 1000;
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255,255,255,0.2);
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .status-text::before {
                content: '';
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255,255,255,0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        </style>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-robot text-purple-600 mr-2"></i>
                    ğŸ¶ ì˜ˆì§„ì´ ë§Œë‚˜ê¸°
                </h2>
                <button onclick="showTab('dashboard')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
                    <i class="fas fa-arrow-left mr-2"></i>ëŒì•„ê°€ê¸°
                </button>
            </div>
            
            <div id="aesong-3d-container">
                <canvas id="aesong-canvas"></canvas>
                
                <!-- ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ ì¹© (ìƒë‹¨ ì™¼ìª½, ë³µìˆ˜ ì§€ì›) -->
                <div id="document-context-chip" style="position: absolute; top: 20px; left: 20px; z-index: 11; display: none; max-width: 90%; overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding-bottom: 5px;">
                    <div id="document-chips-container" style="display: flex; gap: 8px; align-items: center;"></div>
                </div>
                
                <!-- ìºë¦­í„° ì„ íƒ -->
                <div class="character-selector">
                    <div class="text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user-circle mr-1"></i>ìºë¦­í„° ì„ íƒ
                    </div>
                    <div class="character-option active" data-character="aesong" onclick="window.switchCharacter('aesong')">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                            ğŸ¶
                        </div>
                        <div style="flex: 1;">
                            <div class="text-sm font-semibold" style="white-space: nowrap;">ì˜ˆì§„ì´ <span class="text-xs text-gray-500 font-normal">(1.5MB)</span></div>
                        </div>
                    </div>
                    <div class="character-option" data-character="david" onclick="window.switchCharacter('david')">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                            ğŸ‘¨â€ğŸ’»
                        </div>
                        <div style="flex: 1;">
                            <div class="text-sm font-semibold" style="white-space: nowrap;">ë°ì´ë¹— <span class="text-xs text-gray-500 font-normal">(1.3MB)</span></div>
                        </div>
                    </div>
                    <div class="character-option" data-character="asol" onclick="window.switchCharacter('asol')">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); border-radius: 10px; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                            ğŸ‘¨â€ğŸ’¼
                        </div>
                        <div style="flex: 1;">
                            <div class="text-sm font-semibold" style="white-space: nowrap;">PM <span class="text-xs text-gray-500 font-normal">(1.5MB)</span></div>
                        </div>
                    </div>
                    
                    <!-- AI ëª¨ë¸ ì„ íƒ ì¶”ê°€ -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div class="text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-brain mr-1"></i>AI ëª¨ë¸ ì„ íƒ
                        </div>
                        <select id="ai-model-select" onchange="window.changeAIModel(this.value)" style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; background: white; cursor: pointer;">
                            <option value="groq">âš¡ GROQ (ë¬´ë£Œ, ë¹ ë¦„)</option>
                            <option value="gemini">ğŸ¤– Gemini (Google)</option>
                        </select>
                        <div id="ai-model-status" style="margin-top: 5px; font-size: 11px; color: #10b981;">
                            âœ… GROQ ì‚¬ìš© ì¤‘
                        </div>
                    </div>
                </div>
                
                <div class="status-text" id="status-text" style="display: none;">
                    ë¡œë”© ì¤‘...
                </div>
                
                <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ (ì™¼ìª½ì— ì¢ê²Œ) -->
                <div id="aesong-chat-messages" style="position: absolute; bottom: 140px; left: 20px; width: 350px; max-height: 300px; overflow-y: auto; background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 15px; display: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <div id="chat-message-list"></div>
                </div>
                
                <div class="chat-controls">
                    <button class="voice-btn" id="voice-btn" onclick="toggleVoiceRecording()" title="í´ë¦­í•˜ì—¬ ìŒì„± ë…¹ìŒ ì‹œì‘/ì¤‘ì§€">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="text-chat-btn" id="text-chat-btn" onclick="window.toggleTextChat()" title="í…ìŠ¤íŠ¸ ì±„íŒ…" style="margin-left: 10px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #34d399 0%, #10b981 100%); color: white; border: none; box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: all 0.3s ease;">
                        <i class="fas fa-keyboard"></i>
                    </button>
                </div>
                
                <!-- í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­ -->
                <div id="text-chat-input-area" style="position: absolute; bottom: 20px; left: 20px; right: 20px; display: none;">
                    <div style="display: flex; gap: 10px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <input type="text" id="text-chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none;" onkeypress="if(event.key==='Enter') window.sendTextMessage()">
                        <button onclick="window.sendTextMessage()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-paper-plane mr-2"></i>ì „ì†¡
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">ì‚¬ìš© ë°©ë²•</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <ul class="list-disc list-inside space-y-1">
                                <li>ë§ˆì´í¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìŒì„± ë…¹ìŒì„ ì‹œì‘í•˜ì„¸ìš”</li>
                                <li>ë§ì”€í•˜ì‹  í›„ ë‹¤ì‹œ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë…¹ìŒì„ ì¤‘ì§€í•˜ì„¸ìš”</li>
                                <li>ì˜ˆì§„ì´ê°€ ìŒì„±ìœ¼ë¡œ ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤!</li>
                                <li>3D ì˜ˆì§„ì´ ìºë¦­í„°ë¥¼ ë§ˆìš°ìŠ¤ë¡œ íšŒì „í•  ìˆ˜ ìˆì–´ìš”</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Three.js 3D ì”¬ ì´ˆê¸°í™” (ëª¨ë“ˆì—ì„œ ì²˜ë¦¬)
    setTimeout(() => {
        if (window.initAesong3DScene) {
            console.log('âœ… 3D ëª¨ë“ˆ ì´ˆê¸°í™” ì‹œì‘...');
            window.initAesong3DScene();
        } else {
            console.error('âŒ initAesong3DScene í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. aesong-3d-module.jsê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        }
        
        // ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ ì²´í¬ ë° ì¹© í‘œì‹œ
        const documentContextRaw = sessionStorage.getItem('chatbot-document-context');
        if (documentContextRaw) {
            setTimeout(() => {
                let documentContext;
                try {
                    documentContext = JSON.parse(documentContextRaw);
                } catch {
                    documentContext = [documentContextRaw];
                }
                window.updateChatbotDocumentContext(documentContext);
                console.log('ğŸ“š ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ ê°ì§€:', documentContext);
            }, 500);
        }
    }, 100);
}

// ë¬¸ì„œ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ (ë³µìˆ˜ ì„ íƒ ì§€ì›)
window.showDocumentSelector = async function() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/documents/list`);
        const data = await response.json();
        
        if (!data.success || !data.documents || data.documents.length === 0) {
            await window.showCustomAlert('ğŸ“­ ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤', 'warning', 'ë¬¸ì„œ ì—†ìŒ');
            return;
        }
        
        // í˜„ì¬ ì„ íƒëœ ë¬¸ì„œë“¤ ê°€ì ¸ì˜¤ê¸°
        const currentDocs = JSON.parse(sessionStorage.getItem('chatbot-document-context') || '[]');
        const selectedSet = new Set(Array.isArray(currentDocs) ? currentDocs : [currentDocs].filter(Boolean));
        
        // ëª¨ë‹¬ ìƒì„±
        const modalHtml = `
            <div id="document-selector-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s;">
                <div style="background: white; border-radius: 20px; padding: 30px; max-width: 650px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 20px; font-weight: 700; color: #1f2937;">
                            <i class="fas fa-file-alt" style="color: #3b82f6; margin-right: 8px;"></i>
                            ë¬¸ì„œ ì„ íƒ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)
                        </h3>
                        <button onclick="window.closeDocumentSelector()" style="background: #f3f4f6; border: none; color: #6b7280; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- ì „ì²´ ë¬¸ì„œ ì˜µì…˜ -->
                    <div onclick="window.selectAllDocuments()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.3)';">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                ğŸŒ
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">ì „ì²´ ë¬¸ì„œ ê²€ìƒ‰</div>
                                <div style="font-size: 13px; opacity: 0.9;">ëª¨ë“  ë¬¸ì„œì—ì„œ ë‹µë³€ì„ ì°¾ìŠµë‹ˆë‹¤</div>
                            </div>
                            <i class="fas fa-check-circle" style="opacity: 0.7; font-size: 20px;"></i>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-size: 14px; font-weight: 600; color: #6b7280;">
                            ğŸ“„ íŠ¹ì • ë¬¸ì„œ ì„ íƒ (${data.documents.length}ê°œ)
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="window.clearDocumentSelection()" style="background: #f3f4f6; border: none; color: #6b7280; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                                <i class="fas fa-eraser mr-1"></i>ì „ì²´ í•´ì œ
                            </button>
                            <button onclick="window.applyDocumentSelection()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; color: white; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'">
                                <i class="fas fa-check mr-1"></i>ì ìš©í•˜ê¸°
                            </button>
                        </div>
                    </div>
                    
                    <!-- ë¬¸ì„œ ëª©ë¡ (ì²´í¬ë°•ìŠ¤) -->
                    <div id="document-list-container" style="display: flex; flex-direction: column; gap: 8px;">
                        ${data.documents.map(doc => {
                            const iconMap = {
                                'pdf': 'ğŸ“•',
                                'doc': 'ğŸ“˜',
                                'docx': 'ğŸ“˜',
                                'txt': 'ğŸ“„',
                                'ppt': 'ğŸ“™',
                                'pptx': 'ğŸ“™',
                                'xls': 'ğŸ“—',
                                'xlsx': 'ğŸ“—'
                            };
                            const icon = iconMap[doc.extension] || 'ğŸ“„';
                            const sizeStr = doc.file_size_mb < 1 
                                ? `${Math.round(doc.file_size_mb * 1024)} KB`
                                : `${doc.file_size_mb.toFixed(1)} MB`;
                            const isChecked = selectedSet.has(doc.filename);
                            
                            return `
                                <label style="background: ${isChecked ? '#eff6ff' : '#f9fafb'}; border: 2px solid ${isChecked ? '#3b82f6' : '#e5e7eb'}; padding: 12px; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px;" onmouseover="if(!this.querySelector('input').checked) { this.style.background='#f3f4f6'; this.style.borderColor='#d1d5db'; }" onmouseout="if(!this.querySelector('input').checked) { this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb'; }">
                                    <input type="checkbox" value="${doc.filename}" ${isChecked ? 'checked' : ''} onchange="window.toggleDocumentCheckbox(this)" style="width: 20px; height: 20px; cursor: pointer; accent-color: #3b82f6;">
                                    <div style="font-size: 24px;">${icon}</div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; color: #1f2937; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.filename}</div>
                                        <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">${sizeStr} â€¢ ${new Date(doc.modified_at).toLocaleDateString('ko-KR')}</div>
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                @keyframes slideUp {
                    from { transform: translateY(20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            </style>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('âŒ ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        await window.showCustomAlert('ë¬¸ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error', 'ì˜¤ë¥˜');
    }
};

// ì²´í¬ë°•ìŠ¤ í† ê¸€
window.toggleDocumentCheckbox = function(checkbox) {
    const label = checkbox.closest('label');
    if (checkbox.checked) {
        label.style.background = '#eff6ff';
        label.style.borderColor = '#3b82f6';
    } else {
        label.style.background = '#f9fafb';
        label.style.borderColor = '#e5e7eb';
    }
};

// ì „ì²´ ë¬¸ì„œ ì„ íƒ (ì „ì²´ ê²€ìƒ‰ ëª¨ë“œ)
window.selectAllDocuments = function() {
    sessionStorage.removeItem('chatbot-document-context');
    window.updateChatbotDocumentContext([]);
    window.closeDocumentSelector();
    window.showCustomAlert('ğŸŒ ì „ì²´ ë¬¸ì„œ ê²€ìƒ‰ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤', 'success', 'ë¬¸ì„œ ì„¤ì • ì™„ë£Œ');
    console.log('ğŸŒ ì „ì²´ ë¬¸ì„œ ëª¨ë“œë¡œ ì „í™˜');
};

// ì „ì²´ í•´ì œ
window.clearDocumentSelection = function() {
    const checkboxes = document.querySelectorAll('#document-list-container input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = false;
        const label = cb.closest('label');
        label.style.background = '#f9fafb';
        label.style.borderColor = '#e5e7eb';
    });
};

// ì„ íƒ ì ìš©
window.applyDocumentSelection = function() {
    const checkboxes = document.querySelectorAll('#document-list-container input[type="checkbox"]:checked');
    const selectedDocs = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedDocs.length === 0) {
        // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆ í•¨ = ì „ì²´ ë¬¸ì„œ ëª¨ë“œ
        sessionStorage.removeItem('chatbot-document-context');
        window.updateChatbotDocumentContext([]);
        window.closeDocumentSelector();
        window.showCustomAlert('ğŸŒ ì „ì²´ ë¬¸ì„œ ê²€ìƒ‰ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤', 'success', 'ë¬¸ì„œ ì„¤ì • ì™„ë£Œ');
        console.log('ğŸŒ ì „ì²´ ë¬¸ì„œ ëª¨ë“œë¡œ ì „í™˜');
    } else {
        // ì„ íƒëœ ë¬¸ì„œë“¤ ì €ì¥
        sessionStorage.setItem('chatbot-document-context', JSON.stringify(selectedDocs));
        window.updateChatbotDocumentContext(selectedDocs);
        window.closeDocumentSelector();
        
        const message = selectedDocs.length === 1
            ? `ğŸ“„ "${selectedDocs[0]}" ë¬¸ì„œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`
            : `ğŸ“„ ${selectedDocs.length}ê°œ ë¬¸ì„œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`;
        
        window.showCustomAlert(message, 'success', 'ë¬¸ì„œ ì„¤ì • ì™„ë£Œ');
        console.log('ğŸ“„ ë¬¸ì„œ ì„ íƒë¨:', selectedDocs);
    }
};

// ë¬¸ì„œ ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
window.closeDocumentSelector = function() {
    const modal = document.getElementById('document-selector-modal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.2s';
        setTimeout(() => modal.remove(), 200);
    }
};

// ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì¹© í‘œì‹œ, ë³µìˆ˜ ì§€ì›)
window.updateChatbotDocumentContext = function(documents) {
    const chip = document.getElementById('document-context-chip');
    const container = document.getElementById('document-chips-container');
    
    if (!chip || !container) return;
    
    // documentsê°€ ë¬¸ìì—´ì´ë©´ ë°°ì—´ë¡œ ë³€í™˜ (í•˜ìœ„ í˜¸í™˜ì„±)
    let docArray = [];
    if (typeof documents === 'string') {
        docArray = [documents];
    } else if (Array.isArray(documents)) {
        docArray = documents;
    }
    
    if (docArray.length === 0) {
        chip.style.display = 'none';
        container.innerHTML = '';
        return;
    }
    
    // ì¹© HTML ìƒì„±
    const chipsHtml = docArray.map(doc => {
        const shortName = doc.length > 20 ? doc.substring(0, 17) + '...' : doc;
        return `
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; white-space: nowrap;">
                ğŸ“„ ${shortName}
                <button onclick="window.removeDocumentFromContext('${doc}')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 20px; height: 20px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; padding: 0;" title="ì´ ë¬¸ì„œ ì œê±°" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times" style="font-size: 10px;"></i>
                </button>
            </div>
        `;
    }).join('');
    
    // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì¶”ê°€
    const controlsHtml = `
        <button onclick="window.showDocumentSelector()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);" title="ë¬¸ì„œ ë³€ê²½" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <i class="fas fa-sync-alt" style="font-size: 14px;"></i>
        </button>
        <button onclick="window.clearChatbotDocumentContext()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);" title="ì „ì²´ í•´ì œ" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <i class="fas fa-times" style="font-size: 16px;"></i>
        </button>
    `;
    
    container.innerHTML = chipsHtml + controlsHtml;
    chip.style.display = 'block';
};

// íŠ¹ì • ë¬¸ì„œ ì œê±°
window.removeDocumentFromContext = function(filename) {
    const currentContext = sessionStorage.getItem('chatbot-document-context');
    if (!currentContext) return;
    
    let docArray = [];
    try {
        docArray = JSON.parse(currentContext);
    } catch {
        docArray = [currentContext];
    }
    
    if (!Array.isArray(docArray)) {
        docArray = [docArray];
    }
    
    // í•´ë‹¹ ë¬¸ì„œ ì œê±°
    docArray = docArray.filter(doc => doc !== filename);
    
    if (docArray.length === 0) {
        // ëª¨ë‘ ì œê±°ë˜ë©´ ì „ì²´ ë¬¸ì„œ ëª¨ë“œ
        sessionStorage.removeItem('chatbot-document-context');
        window.updateChatbotDocumentContext([]);
        window.showCustomAlert('ğŸŒ ì „ì²´ ë¬¸ì„œ ê²€ìƒ‰ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤', 'success', 'ë¬¸ì„œ ì œê±°');
    } else {
        // ë‚˜ë¨¸ì§€ ë¬¸ì„œë“¤ ì €ì¥
        sessionStorage.setItem('chatbot-document-context', JSON.stringify(docArray));
        window.updateChatbotDocumentContext(docArray);
        window.showCustomAlert(`ğŸ“„ "${filename}" ë¬¸ì„œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success', 'ë¬¸ì„œ ì œê±°');
    }
};

// ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ í•´ì œ (ì „ì²´ ë¬¸ì„œ ëª¨ë“œ)
window.clearChatbotDocumentContext = function() {
    sessionStorage.removeItem('chatbot-document-context');
    window.updateChatbotDocumentContext([]);
    
    console.log('ğŸŒ ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ í•´ì œ - ì „ì²´ ë¬¸ì„œ ëª¨ë“œ');
    window.showCustomAlert('ğŸŒ ì „ì²´ ë¬¸ì„œ ê²€ìƒ‰ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤', 'success', 'ëª¨ë“œ ë³€ê²½');
};

// ìºë¦­í„° ì „í™˜ í•¨ìˆ˜
window.switchCharacter = function(characterName) {
    console.log('ğŸ­ ìºë¦­í„° ì „í™˜:', characterName);
    
    // í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    const options = document.querySelectorAll('.character-option');
    options.forEach(option => {
        if (option.dataset.character === characterName) {
            option.classList.add('active');
        } else {
            option.classList.remove('active');
        }
    });
    
    // 3D ì”¬ì— ìºë¦­í„° ë³€ê²½ ì•Œë¦¼ (ëª¨ë“ˆì—ì„œ ì²˜ë¦¬)
    if (window.changeAesongCharacter) {
        window.changeAesongCharacter(characterName);
    } else {
        console.warn('âš ï¸ window.changeAesongCharacter í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. 3D ëª¨ë“ˆì„ í™•ì¸í•˜ì„¸ìš”.');
    }
};

// ìŒì„± ë…¹ìŒ í† ê¸€ í•¨ìˆ˜
window.toggleVoiceRecording = function() {
    console.log('ğŸ¤ ìŒì„± ë…¹ìŒ í† ê¸€');
    const voiceBtn = document.getElementById('voice-btn');
    const statusText = document.getElementById('status-text');
    
    if (!voiceBtn) return;
    
    // ë…¹ìŒ ì¤‘ì¸ì§€ í™•ì¸
    const isRecording = voiceBtn.classList.contains('recording');
    
    if (isRecording) {
        // ë…¹ìŒ ì¤‘ì§€
        voiceBtn.classList.remove('recording');
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        if (statusText) {
            statusText.textContent = 'AIê°€ ì‘ë‹µ ì¤‘...';
            statusText.style.display = 'flex';
        }
        console.log('ğŸ›‘ ë…¹ìŒ ì¤‘ì§€');
        
        // ìŒì„± ì¸ì‹ ì²˜ë¦¬ (ëª¨ë“ˆì—ì„œ ì²˜ë¦¬)
        if (window.stopAesongVoiceRecording) {
            window.stopAesongVoiceRecording();
        } else {
            // ì„ì‹œ: 2ì´ˆ í›„ ìƒíƒœ í…ìŠ¤íŠ¸ ìˆ¨ê¹€
            setTimeout(() => {
                if (statusText) statusText.style.display = 'none';
            }, 2000);
        }
    } else {
        // ë…¹ìŒ ì‹œì‘
        voiceBtn.classList.add('recording');
        voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
        if (statusText) {
            statusText.textContent = 'ë“£ê³  ìˆì–´ìš”...';
            statusText.style.display = 'flex';
        }
        console.log('â–¶ï¸ ë…¹ìŒ ì‹œì‘');
        
        // ìŒì„± ì¸ì‹ ì‹œì‘ (ëª¨ë“ˆì—ì„œ ì²˜ë¦¬)
        if (window.startAesongVoiceRecording) {
            window.startAesongVoiceRecording();
        }
    }
};

// í…ìŠ¤íŠ¸ ì±„íŒ… í† ê¸€ í•¨ìˆ˜
window.toggleTextChat = function() {
    const textInputArea = document.getElementById('text-chat-input-area');
    const chatMessages = document.getElementById('aesong-chat-messages');
    const textChatBtn = document.getElementById('text-chat-btn');
    
    if (textInputArea.style.display === 'none' || !textInputArea.style.display) {
        textInputArea.style.display = 'block';
        chatMessages.style.display = 'block';
        textChatBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        document.getElementById('text-chat-input').focus();
        console.log('ğŸ’¬ í…ìŠ¤íŠ¸ ì±„íŒ… ì—´ë¦¼');
    } else {
        textInputArea.style.display = 'none';
        chatMessages.style.display = 'none';
        textChatBtn.style.background = 'linear-gradient(135deg, #34d399 0%, #10b981 100%)';
        console.log('ğŸ’¬ í…ìŠ¤íŠ¸ ì±„íŒ… ë‹«í˜');
    }
};

// AI ëª¨ë¸ ë³€ê²½ í•¨ìˆ˜
window.changeAIModel = function(model) {
    localStorage.setItem('ai_model', model);
    const statusDiv = document.getElementById('ai-model-status');
    
    if (model === 'groq') {
        statusDiv.textContent = 'âœ… GROQ ì‚¬ìš© ì¤‘ (ë¬´ë£Œ, ë¹ ë¦„)';
        statusDiv.style.color = '#10b981';
    } else {
        statusDiv.textContent = 'âœ… Gemini ì‚¬ìš© ì¤‘ (Google)';
        statusDiv.style.color = '#3b82f6';
    }
    
    console.log('ğŸ¤– AI ëª¨ë¸ ë³€ê²½:', model);
};

// ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
window.sendTextMessage = async function() {
    const input = document.getElementById('text-chat-input');
    const messageList = document.getElementById('chat-message-list');
    const statusText = document.getElementById('status-text');
    
    const message = input.value.trim();
    if (!message) return;
    
    console.log('ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡:', message);
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addChatMessage('user', message);
    input.value = '';
    
    // ì„ íƒëœ AI ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
    const selectedModel = localStorage.getItem('ai_model') || 'groq';
    
    // í˜„ì¬ ìºë¦­í„° ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const currentCharacter = window.currentCharacterName || 'ì˜ˆì§„ì´';
    
    // ëª¨ë¸ëª… í‘œì‹œ
    const modelNames = {
        'groq': 'Llama 3.3 70B',
        'gemma': 'Gemma 2 9B',
        'gemini': 'Gemini 2.0 Flash'
    };
    const modelDisplayName = modelNames[selectedModel] || selectedModel.toUpperCase();
    
    // AI ì‘ë‹µ ëŒ€ê¸° í‘œì‹œ
    if (statusText) {
        statusText.textContent = `${currentCharacter}ê°€ ${modelDisplayName}ë¡œ ìƒê° ì¤‘...`;
        statusText.style.display = 'flex';
    }
    
    try {
        
        // API í‚¤ ê°€ì ¸ì˜¤ê¸°
        const groqApiKey = localStorage.getItem('groq_api_key') || '';
        const geminiApiKey = localStorage.getItem('gemini_api_key') || '';
        
        // ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ í™•ì¸ (ë³µìˆ˜ ë¬¸ì„œ ì§€ì›)
        const documentContextRaw = sessionStorage.getItem('chatbot-document-context');
        let documentContext = null;
        if (documentContextRaw) {
            try {
                documentContext = JSON.parse(documentContextRaw);
            } catch {
                documentContext = [documentContextRaw];
            }
        }
        const isRAGMode = !!documentContext && (Array.isArray(documentContext) ? documentContext.length > 0 : true);
        
        console.log('ğŸ’¬ 3D ì±—ë´‡ í…ìŠ¤íŠ¸ ì „ì†¡:', { 
            message, 
            character: currentCharacter, 
            model: selectedModel,
            hasGroqKey: groqApiKey ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •',
            hasGeminiKey: geminiApiKey ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •',
            ragMode: isRAGMode,
            documentContext: documentContext || 'ì „ì²´ ë¬¸ì„œ'
        });
        
        let response;
        
        // RAG ëª¨ë“œ (ë¬¸ì„œ ê¸°ë°˜ ëŒ€í™”) vs ì¼ë°˜ ìºë¦­í„° ëŒ€í™”
        if (isRAGMode) {
            // RAG API ì‚¬ìš© (ë³µìˆ˜ ë¬¸ì„œ ë°°ì—´ ì „ë‹¬)
            const ragK = parseInt(localStorage.getItem('rag_top_k') || '10');
            response = await fetch(`${API_BASE_URL}/api/rag/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-GROQ-API-Key': groqApiKey
                },
                body: JSON.stringify({
                    message: message,
                    k: ragK,
                    document_context: Array.isArray(documentContext) ? documentContext : [documentContext]
                })
            });
        } else {
            // ì¼ë°˜ ìºë¦­í„° ëŒ€í™” API ì‚¬ìš©
            response = await fetch('/api/aesong-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-GROQ-API-Key': groqApiKey,
                    'X-Gemini-API-Key': geminiApiKey
                },
                body: JSON.stringify({
                    message: message,
                    character: currentCharacter,
                    model: selectedModel
                })
            });
        }
        
        if (!response.ok) {
            throw new Error('AI ì‘ë‹µ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        
        // RAG ëª¨ë“œ ì‘ë‹µ ì²˜ë¦¬
        if (isRAGMode && data.answer) {
            // RAG ì‘ë‹µ í‘œì‹œ
            addChatMessage('ai', data.answer);
            
            // ì°¸ê³  ë¬¸ì„œ í‘œì‹œ
            if (data.sources && data.sources.length > 0) {
                const sourcesHtml = `
                    <div style="margin-top: 10px; padding: 10px; background: #f3f4f6; border-radius: 8px; font-size: 12px;">
                        <div style="font-weight: 600; color: #6b7280; margin-bottom: 6px;">ğŸ“š ì°¸ê³  ë¬¸ì„œ (${data.sources.length}ê°œ)</div>
                        ${data.sources.map(source => `
                            <div style="padding: 4px 0; color: #4b5563;">
                                â€¢ ${source.metadata?.filename || 'ë¬¸ì„œ'} (ìœ ì‚¬ë„: ${(source.similarity * 100).toFixed(1)}%)
                            </div>
                        `).join('')}
                    </div>
                `;
                messageList.insertAdjacentHTML('beforeend', sourcesHtml);
            }
            
            // TTSë¡œ ìŒì„± ì¶œë ¥
            try {
                const characterName = window.currentCharacterName || 'ì˜ˆì§„ì´';
                await playTTS(data.answer, characterName);
            } catch (ttsError) {
                console.warn('TTS ì¬ìƒ ì‹¤íŒ¨:', ttsError);
            }
        }
        // ì¼ë°˜ ìºë¦­í„° ëŒ€í™” ì‘ë‹µ ì²˜ë¦¬
        else if (data.model === 'error') {
            console.error('âŒ AI ì˜¤ë¥˜:', data.error);
            
            // ì—ëŸ¬ ë©”ì‹œì§€ í•œê¸€ ë²ˆì—­
            const translatedError = translateApiError(data.error);
            
            addChatMessage('ai', `ì£„ì†¡í•©ë‹ˆë‹¤. AI ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${translatedError}\n\nğŸ’¡ ì¶”ê°€ í•´ê²°ë°©ë²•:\n1. ì‹œìŠ¤í…œ ë“±ë¡ì—ì„œ GROQ ë˜ëŠ” Gemini API í‚¤ ì…ë ¥\n2. GROQ API í‚¤ ë°œê¸‰: https://console.groq.com/keys\n3. Gemini API í‚¤ ë°œê¸‰: https://aistudio.google.com/app/apikey`);
        } else {
            // AI ì‘ë‹µ ì¶”ê°€
            addChatMessage('ai', data.response);
            
            // TTSë¡œ ìŒì„± ì¶œë ¥ (í‚¤ë³´ë“œ ì…ë ¥ ì‹œì—ë„ ìŒì„±ìœ¼ë¡œ ì‘ë‹µ)
            try {
                const characterName = window.currentCharacterName || 'ì˜ˆì§„ì´';
                await playTTS(data.response, characterName);
            } catch (ttsError) {
                console.warn('TTS ì¬ìƒ ì‹¤íŒ¨:', ttsError);
                // TTS ì‹¤íŒ¨í•´ë„ í…ìŠ¤íŠ¸ëŠ” ì´ë¯¸ í‘œì‹œë˜ì—ˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰
            }
        }
        
        if (statusText) {
            statusText.style.display = 'none';
        }
        
        console.log('âœ… AI ì‘ë‹µ:', data.response);
    } catch (error) {
        console.error('âŒ AI ì‘ë‹µ ì˜¤ë¥˜:', error);
        addChatMessage('ai', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ˜¢');
        
        if (statusText) {
            statusText.style.display = 'none';
        }
    }
};

// TTS ìŒì„± ì¬ìƒ í•¨ìˆ˜ (Google Cloud TTS ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë¸Œë¼ìš°ì € TTS)
async function playTTS(text, characterName) {
    try {
        console.log('ğŸ”Š TTS ì¬ìƒ ì‹œì‘:', characterName);
        
        // 1ë‹¨ê³„: Google Cloud TTS ì‹œë„
        const geminiApiKey = localStorage.getItem('gemini_api_key') || '';
        
        if (geminiApiKey) {
            try {
                console.log('â˜ï¸ Google Cloud TTS ì‹œë„ ì¤‘...');
                
                // ë°±ì—”ë“œ TTS API í˜¸ì¶œ
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Gemini-API-Key': geminiApiKey
                    },
                    body: JSON.stringify({
                        text: text,
                        character: characterName
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.audioContent) {
                        // Base64 ë””ì½”ë”©í•˜ì—¬ ì˜¤ë””ì˜¤ ì¬ìƒ
                        const audioBlob = base64ToBlob(data.audioContent, 'audio/mp3');
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        
                        audio.onplay = () => {
                            console.log('ğŸ”Š Google Cloud TTS ìŒì„± ì¬ìƒ ì‹œì‘');
                        };
                        
                        audio.onended = () => {
                            console.log('âœ… Google Cloud TTS ìŒì„± ì¬ìƒ ì™„ë£Œ');
                            URL.revokeObjectURL(audioUrl);
                        };
                        
                        audio.onerror = (error) => {
                            console.error('âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', error);
                            URL.revokeObjectURL(audioUrl);
                        };
                        
                        await audio.play();
                        console.log('âœ… Google Cloud TTS ì‚¬ìš© ì™„ë£Œ');
                        return; // ì„±ê³µí•˜ë©´ ì—¬ê¸°ì„œ ì¢…ë£Œ
                    }
                }
                
                console.warn('âš ï¸ Google Cloud TTS ì‹¤íŒ¨, ë¸Œë¼ìš°ì € TTSë¡œ ì „í™˜...');
            } catch (cloudError) {
                console.warn('âš ï¸ Google Cloud TTS ì˜¤ë¥˜:', cloudError.message);
                console.log('ğŸ”„ ë¸Œë¼ìš°ì € TTSë¡œ ì „í™˜...');
            }
        } else {
            console.log('â„¹ï¸ Google Cloud API í‚¤ ì—†ìŒ, ë¸Œë¼ìš°ì € TTS ì‚¬ìš©');
        }
        
        // 2ë‹¨ê³„: ë¸Œë¼ìš°ì € TTS ì‚¬ìš© (Google Cloud TTS ì‹¤íŒ¨ ì‹œ ë˜ëŠ” API í‚¤ ì—†ì„ ë•Œ)
        if (!('speechSynthesis' in window)) {
            console.warn('âš ï¸ ë¸Œë¼ìš°ì €ê°€ ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
            return;
        }
        
        console.log('ğŸŒ ë¸Œë¼ìš°ì € Web Speech API ì‚¬ìš©');
        
        // ì´ë¯¸ ì¬ìƒ ì¤‘ì´ë©´ ì¤‘ì§€
        window.speechSynthesis.cancel();
        
        // ìŒì„± í•©ì„± ê°ì²´ ìƒì„±
        const utterance = new SpeechSynthesisUtterance(text);
        
        // ìºë¦­í„°ë³„ ìŒì„± ì„¤ì •
        if (characterName === 'ë°ì´ë¹—' || characterName === 'PM') {
            // ë‚¨ì„± ëª©ì†Œë¦¬
            utterance.pitch = 0.8;  // ë‚®ì€ í†¤
            utterance.rate = 0.9;   // ì¡°ê¸ˆ ëŠë¦° ì†ë„
        } else {
            // ì—¬ì„± ëª©ì†Œë¦¬ (ì˜ˆì§„ì´)
            utterance.pitch = 1.2;  // ë†’ì€ í†¤
            utterance.rate = 1.0;   // ë³´í†µ ì†ë„
        }
        
        utterance.lang = 'ko-KR';  // í•œêµ­ì–´
        utterance.volume = 1.0;    // ìµœëŒ€ ë³¼ë¥¨
        
        // ìŒì„± ì„ íƒ (í•œêµ­ì–´ ìŒì„± ì°¾ê¸°)
        const voices = window.speechSynthesis.getVoices();
        const koreanVoice = voices.find(voice => voice.lang.startsWith('ko'));
        if (koreanVoice) {
            utterance.voice = koreanVoice;
            console.log('ğŸ¤ ì„ íƒëœ ìŒì„±:', koreanVoice.name);
        }
        
        utterance.onstart = () => {
            console.log('ğŸ”Š ë¸Œë¼ìš°ì € TTS ìŒì„± ì¬ìƒ ì‹œì‘');
        };
        
        utterance.onend = () => {
            console.log('âœ… ë¸Œë¼ìš°ì € TTS ìŒì„± ì¬ìƒ ì™„ë£Œ');
        };
        
        utterance.onerror = (error) => {
            console.error('âŒ ë¸Œë¼ìš°ì € TTS ìŒì„± ì¬ìƒ ì˜¤ë¥˜:', error);
        };
        
        // ìŒì„± ì¬ìƒ
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('âŒ TTS ì¬ìƒ ì‹¤íŒ¨:', error);
        // TTS ì‹¤íŒ¨í•´ë„ í…ìŠ¤íŠ¸ëŠ” í‘œì‹œë˜ì—ˆìœ¼ë¯€ë¡œ ì—ëŸ¬ë¥¼ throwí•˜ì§€ ì•ŠìŒ
    }
}

// ë¸Œë¼ìš°ì € TTS ìŒì„± ëª©ë¡ ì´ˆê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì‹œ)
if ('speechSynthesis' in window) {
    // ìŒì„± ëª©ë¡ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    window.speechSynthesis.onvoiceschanged = () => {
        const voices = window.speechSynthesis.getVoices();
        console.log('ğŸ¤ ì‚¬ìš© ê°€ëŠ¥í•œ TTS ìŒì„±:', voices.length + 'ê°œ');
        const koreanVoices = voices.filter(v => v.lang.startsWith('ko'));
        console.log('ğŸ‡°ğŸ‡· í•œêµ­ì–´ TTS ìŒì„±:', koreanVoices.map(v => v.name).join(', '));
    };
}

// Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
function base64ToBlob(base64, contentType) {
    const byteCharacters = atob(base64);
    const byteArrays = [];
    
    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        const byteNumbers = new Array(slice.length);
        
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    
    return new Blob(byteArrays, { type: contentType });
}

// ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
function addChatMessage(type, text) {
    const messageList = document.getElementById('chat-message-list');
    const chatContainer = document.getElementById('aesong-chat-messages');
    
    if (!messageList) {
        console.warn('chat-message-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    // ì±„íŒ… ì»¨í…Œì´ë„ˆ í‘œì‹œ
    if (chatContainer) {
        chatContainer.style.display = 'block';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.style.marginBottom = '10px';
    messageDiv.style.display = 'flex';
    messageDiv.style.alignItems = 'flex-start';
    messageDiv.style.gap = '8px';
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <div style="flex: 1; text-align: right;">
                <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 12px; max-width: 80%; text-align: left; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);">
                    ${text}
                </div>
                <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">ë‚˜</div>
            </div>
        `;
    } else {
        const characterName = window.currentCharacterName || 'ì˜ˆì§„ì´';
        messageDiv.innerHTML = `
            <div style="flex: 1;">
                <div style="display: inline-block; background: #f3f4f6; color: #1f2937; padding: 10px 15px; border-radius: 12px; max-width: 80%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);">
                    ${text}
                </div>
                <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">${characterName}</div>
            </div>
        `;
    }
    
    messageList.appendChild(messageDiv);
    
    // ìë™ ìŠ¤í¬ë¡¤ (ì±„íŒ… ì»¨í…Œì´ë„ˆë¥¼ ìŠ¤í¬ë¡¤)
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    console.log('ğŸ’¬ ë©”ì‹œì§€ ì¶”ê°€:', type, text.substring(0, 30) + '...');
}

// ==================== BGM ê´€ë ¨ ê¸°ëŠ¥ ====================
let bgmPlayer = null;
let currentBGMVideoId = null;
let bgmIsPlaying = false; // BGM ì¬ìƒ ìƒíƒœ ì¶”ì 

// YouTube ê²€ìƒ‰ ë° BGM ì¬ìƒ
window.searchYouTubeBGM = async function() {
    // ì¥ë¥´ ë˜ëŠ” ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
    let genre = localStorage.getItem('bgm_genre') || '';
    
    // ì‚¬ìš©ì ì •ì˜ ê²€ìƒ‰ì¸ ê²½ìš° ê²€ìƒ‰ì°½ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    const headerSearchInput = document.getElementById('header-bgm-search');
    
    if (genre === 'custom') {
        genre = (headerSearchInput?.value || '').trim();
        if (!genre) {
            window.showAlert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }
    }
    
    let apiKey = localStorage.getItem('youtube_api_key');

    console.log('ğŸµ BGM ê²€ìƒ‰ ì‹œì‘:', genre);

    // ì¥ë¥´ê°€ ì—†ìœ¼ë©´ BGM ì •ì§€
    if (!genre) {
        console.log('âŒ ì¥ë¥´ ì—†ìŒ - BGM ì •ì§€');
        stopBGM();
        return;
    }

    // API í‚¤ê°€ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
    if (!apiKey) {
        console.log('ğŸ”‘ YouTube API í‚¤ ì—†ìŒ - ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„');
        try {
            const res = await axios.get(API_BASE_URL + '/api/system-settings');
            if (res.data?.youtube_api_key) {
                apiKey = res.data.youtube_api_key;
                localStorage.setItem('youtube_api_key', apiKey);
                console.log('âœ… ì„œë²„ì—ì„œ YouTube API í‚¤ ë¡œë“œ ì™„ë£Œ');
            }
        } catch (e) {
            console.error('ì„œë²„ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // ì—¬ì „íˆ API í‚¤ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
    if (!apiKey) {
        console.log('âŒ YouTube API í‚¤ ì—†ìŒ');
        window.showAlert('YouTube API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì¥ë¥´ë³„ ê²€ìƒ‰ì–´ ë§¤í•‘
    const searchQueries = {
        'classical': 'classical music instrumental relaxing',
        'piano': 'piano instrumental background music',
        'meditation': 'meditation music calm relaxing',
        'oldpop': 'classic pop songs 80s 90s'
    };
    
    // ì‚¬ì „ ì •ì˜ëœ ì¥ë¥´ë©´ ë§¤í•‘ëœ ê²€ìƒ‰ì–´ ì‚¬ìš©, ì•„ë‹ˆë©´ ì‚¬ìš©ì ì…ë ¥ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    const searchQuery = searchQueries[genre] || genre;
    console.log('ğŸ” ê²€ìƒ‰ì–´:', searchQuery);
    
    try {
        // YouTube Data APIë¡œ ê²€ìƒ‰
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&q=${encodeURIComponent(searchQuery)}&type=video&videoCategoryId=10&key=${apiKey}`;
        console.log('ğŸ“¡ YouTube API í˜¸ì¶œ...');
        
        const response = await fetch(url);
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ YouTube API ì˜¤ë¥˜:', errorData);
            throw new Error('YouTube API ì˜¤ë¥˜: ' + (errorData.error?.message || response.statusText));
        }
        
        const data = await response.json();
        console.log('âœ… YouTube ê²€ìƒ‰ ê²°ê³¼:', data);
        
        if (data.items && data.items.length > 0) {
            const videoId = data.items[0].id.videoId;
            const videoTitle = data.items[0].snippet.title;
            console.log('ğŸ¬ ë¹„ë””ì˜¤ ì°¾ìŒ:', videoTitle, videoId);
            playBGM(videoId);
        } else {
            console.log('âŒ BGMì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            window.showAlert('BGMì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('âŒ YouTube ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        window.showAlert('YouTube ê²€ìƒ‰ ì‹¤íŒ¨: ' + error.message);
    }
}

// BGM ì¬ìƒ
function playBGM(videoId) {
    console.log('â–¶ï¸ BGM ì¬ìƒ ì‹œì‘:', videoId);
    currentBGMVideoId = videoId;
    bgmIsPlaying = true; // BGM ì¬ìƒ ìƒíƒœ ì €ì¥
    localStorage.setItem('bgm_is_playing', 'true'); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥
    
    // BGM í”Œë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (!bgmPlayer) {
        console.log('ğŸ¬ BGM í”Œë ˆì´ì–´ ìƒì„±');
        createBGMPlayer();
    }
    
    // ì´ë¯¸ YouTube IFrame APIê°€ ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ì¬ìƒ
    if (window.YT && window.YT.Player) {
        console.log('âœ… YouTube API ë¡œë“œë¨ - ì¬ìƒ ì‹œì‘');
        if (bgmPlayer && bgmPlayer.loadVideoById) {
            const volume = parseInt(localStorage.getItem('bgm_volume') || '30');
            console.log('ğŸ”Š ë³¼ë¥¨ ì„¤ì •:', volume + '%');
            bgmPlayer.setVolume(volume);
            bgmPlayer.loadVideoById(videoId);
        } else {
            console.log('ğŸµ YouTube Player ì´ˆê¸°í™”');
            initYouTubePlayer(videoId);
        }
    } else {
        console.log('ğŸ“¥ YouTube IFrame API ë¡œë“œ ì¤‘...');
        // YouTube IFrame API ë¡œë“œ
        loadYouTubeAPI(() => {
            console.log('âœ… YouTube API ë¡œë“œ ì™„ë£Œ');
            initYouTubePlayer(videoId);
        });
    }
}

// YouTube IFrame API ë¡œë“œ
function loadYouTubeAPI(callback) {
    if (window.YT) {
        callback();
        return;
    }
    
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    tag.onerror = function() {
        console.warn('âš ï¸ YouTube API ë¡œë“œ ì‹¤íŒ¨ (sandbox í™˜ê²½ì—ì„œëŠ” ì •ìƒ)');
    };
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
    window.onYouTubeIframeAPIReady = callback;
}

// BGM í”Œë ˆì´ì–´ HTML ìƒì„± (ìˆ¨ê¹€ ì²˜ë¦¬ - ë³´ì´ì§€ ì•Šì§€ë§Œ ì¬ìƒë¨)
function createBGMPlayer() {
    const playerHTML = `
        <div id="bgm-player-container" style="position: fixed; bottom: -200px; right: -200px; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: -1;">
            <div id="bgm-youtube-player"></div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', playerHTML);
}

// YouTube Player ì´ˆê¸°í™”
function initYouTubePlayer(videoId) {
    console.log('ğŸ¬ YouTube Player ì´ˆê¸°í™”:', videoId);
    const volume = parseInt(localStorage.getItem('bgm_volume') || '30');
    console.log('ğŸ”Š ì´ˆê¸° ë³¼ë¥¨:', volume + '%');
    
    try {
        bgmPlayer = new YT.Player('bgm-youtube-player', {
            height: '1',
            width: '1',
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                loop: 1,
                playlist: videoId,
                controls: 0,
                modestbranding: 1,
                disablekb: 1,
                fs: 0,
                iv_load_policy: 3
            },
            events: {
                onReady: (event) => {
                    console.log('âœ… YouTube Player ì¤€ë¹„ ì™„ë£Œ');
                    event.target.setVolume(volume);
                    console.log('ğŸ”Š ë³¼ë¥¨ ì ìš©:', volume + '%');
                    event.target.playVideo();
                    console.log('â–¶ï¸ ì¬ìƒ ì‹œì‘');
                },
                onStateChange: (event) => {
                    console.log('ğŸµ Player ìƒíƒœ ë³€ê²½:', event.data);
                    // -1: ì‹œì‘ë˜ì§€ ì•ŠìŒ, 0: ì¢…ë£Œ, 1: ì¬ìƒ ì¤‘, 2: ì¼ì‹œì •ì§€, 3: ë²„í¼ë§, 5: ë™ì˜ìƒ ì‹ í˜¸
                },
                onError: (event) => {
                    // Sandbox í™˜ê²½ì—ì„œ ë°œìƒí•˜ëŠ” cross-origin ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
                    if (event.data !== 150) {  // 150ì€ cross-origin ì—ëŸ¬
                        console.warn('âš ï¸ YouTube Player ì˜¤ë¥˜:', event.data);
                    }
                }
            }
        });
        console.log('âœ… YouTube Player ê°ì²´ ìƒì„±ë¨');
    } catch (error) {
        // Sandbox í™˜ê²½ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬
        console.warn('âš ï¸ YouTube Player ì´ˆê¸°í™” ì‹¤íŒ¨ (sandbox í™˜ê²½):', error.message);
    }
}

// BGM ì •ì§€
function stopBGM() {
    console.log('â¹ï¸ BGM ì •ì§€');
    bgmIsPlaying = false; // BGM ì¬ìƒ ìƒíƒœ ì—…ë°ì´íŠ¸
    localStorage.setItem('bgm_is_playing', 'false'); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
    
    if (bgmPlayer && bgmPlayer.stopVideo) {
        bgmPlayer.stopVideo();
    }
    
    // ì»¨í…Œì´ë„ˆëŠ” ì‚­ì œí•˜ì§€ ì•Šê³  ìœ ì§€ (ë‹¤ì‹œ ì¬ìƒ ê°€ëŠ¥í•˜ë„ë¡)
    // const container = document.getElementById('bgm-player-container');
    // if (container) {
    //     container.remove();
    // }
    
    // bgmPlayer = null; // í”Œë ˆì´ì–´ ê°ì²´ëŠ” ìœ ì§€
    currentBGMVideoId = null;
}

// YouTube API í‚¤ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
window.testYouTubeApiKey = async function() {
    const apiKey = document.getElementById('youtube-api-key')?.value;
    const resultDiv = document.getElementById('api-test-result');
    
    if (!apiKey) {
        resultDiv.className = 'mt-2 text-sm text-red-600';
        resultDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
        resultDiv.classList.remove('hidden');
        return;
    }
    
    // í…ŒìŠ¤íŠ¸ ì¤‘ í‘œì‹œ
    resultDiv.className = 'mt-2 text-sm text-blue-600';
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>API í‚¤ í…ŒìŠ¤íŠ¸ ì¤‘...';
    resultDiv.classList.remove('hidden');
    
    try {
        // ê°„ë‹¨í•œ YouTube ê²€ìƒ‰ API í…ŒìŠ¤íŠ¸
        const searchQuery = 'test';
        const apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&q=${encodeURIComponent(searchQuery)}&type=video&key=${apiKey}`;
        
        console.log('ğŸ§ª YouTube API í‚¤ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (response.ok && data.items && data.items.length > 0) {
            // ì„±ê³µ
            const video = data.items[0];
            resultDiv.className = 'mt-2 text-sm text-green-600 bg-green-50 p-2 rounded';
            resultDiv.innerHTML = `<i class="fas fa-check-circle mr-1"></i>âœ… API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!<br><small class="text-gray-600">í…ŒìŠ¤íŠ¸ ê²€ìƒ‰: "${video.snippet.title.substring(0, 40)}..."</small>`;
            console.log('âœ… YouTube API í‚¤ í…ŒìŠ¤íŠ¸ ì„±ê³µ');
            
            // localStorageì— ì €ì¥
            localStorage.setItem('youtube_api_key', apiKey);
            
            // DBì—ë„ ì €ì¥
            try {
                const formData = new FormData();
                formData.append('youtube_api_key', apiKey);
                await axios.post(`${API_BASE_URL}/api/system-settings`, formData);
                console.log('âœ… YouTube API í‚¤ DB ì €ì¥ ì™„ë£Œ');
            } catch (dbError) {
                console.warn('âš ï¸ DB ì €ì¥ ì‹¤íŒ¨ (localStorageëŠ” ì €ì¥ë¨):', dbError);
            }
        } else if (data.error) {
            // API ì˜¤ë¥˜
            resultDiv.className = 'mt-2 text-sm text-red-600 bg-red-50 p-2 rounded';
            resultDiv.innerHTML = `<i class="fas fa-times-circle mr-1"></i>âŒ API ì˜¤ë¥˜: ${data.error.message}`;
            console.error('âŒ YouTube API ì˜¤ë¥˜:', data.error);
        } else {
            // ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜
            resultDiv.className = 'mt-2 text-sm text-orange-600 bg-orange-50 p-2 rounded';
            resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µì…ë‹ˆë‹¤';
            console.warn('âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ YouTube API ì‘ë‹µ:', data);
        }
    } catch (error) {
        resultDiv.className = 'mt-2 text-sm text-red-600 bg-red-50 p-2 rounded';
        resultDiv.innerHTML = `<i class="fas fa-times-circle mr-1"></i>âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`;
        console.error('âŒ YouTube API í‚¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
    }
}

// API ì—ëŸ¬ ë©”ì‹œì§€ í•œê¸€ ë²ˆì—­ í•¨ìˆ˜
function translateApiError(errorMessage) {
    // Gemini API í• ë‹¹ëŸ‰ ì´ˆê³¼ ì—ëŸ¬
    if (errorMessage.includes('exceeded your current quota')) {
        const retryMatch = errorMessage.match(/retry in ([\d.]+)s/);
        const retryTime = retryMatch ? Math.ceil(parseFloat(retryMatch[1])) : 20;
        
        return `âŒ API ì‚¬ìš©ëŸ‰ ì´ˆê³¼
        
ğŸš« ë¬¸ì œ: Gemini API ë¬´ë£Œ í• ë‹¹ëŸ‰ì„ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

ğŸ’¡ í•´ê²° ë°©ë²•:
1. ${retryTime}ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”
2. API ì‚¬ìš©ëŸ‰ í™•ì¸: https://ai.dev/usage?tab=rate-limit
3. ìš”ê¸ˆì œ í™•ì¸: https://ai.google.dev/gemini-api/docs/rate-limits
4. ë˜ëŠ” GROQ APIë¥¼ ì‚¬ìš©í•˜ì„¸ìš” (ë¬´ë£Œ í• ë‹¹ëŸ‰ ë” í¼)

ğŸ“Š ë¬´ë£Œ í• ë‹¹ëŸ‰ ì •ë³´:
- Gemini 2.0 Flash: ë¶„ë‹¹ 10ê°œ ìš”ì²­
- GROQ: ë¶„ë‹¹ 30ê°œ ìš”ì²­ (ê¶Œì¥)`;
    }
    
    // GROQ API í• ë‹¹ëŸ‰ ì´ˆê³¼ ì—ëŸ¬
    if (errorMessage.includes('Rate limit reached') || errorMessage.includes('rate_limit_exceeded')) {
        return `âŒ API ìš”ì²­ í•œë„ ì´ˆê³¼

ğŸš« ë¬¸ì œ: GROQ API ìš”ì²­ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.

ğŸ’¡ í•´ê²° ë°©ë²•:
1. 1ë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”
2. API ì‚¬ìš©ëŸ‰ í™•ì¸: https://console.groq.com/usage
3. ë” ë§ì€ í• ë‹¹ëŸ‰ì´ í•„ìš”í•˜ë©´ ìœ ë£Œ í”Œëœ ê³ ë ¤

ğŸ“Š ë¬´ë£Œ í• ë‹¹ëŸ‰:
- ë¶„ë‹¹ 30ê°œ ìš”ì²­
- ì¼ì¼ 14,400ê°œ ìš”ì²­`;
    }
    
    // ì˜ëª»ëœ API í‚¤
    if (errorMessage.includes('Invalid API Key') || errorMessage.includes('Unauthorized') || errorMessage.includes('invalid_api_key')) {
        return `âŒ ì˜ëª»ëœ API í‚¤

ğŸš« ë¬¸ì œ: API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ğŸ’¡ í•´ê²° ë°©ë²•:
1. API í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”
2. ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ìê°€ ì—†ëŠ”ì§€ í™•ì¸
3. ìƒˆ API í‚¤ë¥¼ ë°œê¸‰ë°›ìœ¼ì„¸ìš”
   - GROQ: https://console.groq.com/keys
   - Gemini: https://aistudio.google.com/app/apikey`;
    }
    
    // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬
    if (errorMessage.includes('Failed to fetch') || errorMessage.includes('Network')) {
        return `âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜

ğŸš« ë¬¸ì œ: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ğŸ’¡ í•´ê²° ë°©ë²•:
1. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”
2. ë°©í™”ë²½ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”
3. VPNì„ ì‚¬ìš© ì¤‘ì´ë¼ë©´ ì ì‹œ ë„ê³  ì‹œë„í•˜ì„¸ìš”`;
    }
    
    // ê¸°ë³¸: ì›ë³¸ ë©”ì‹œì§€ ë°˜í™˜
    return errorMessage;
}

// GROQ API í‚¤ í…ŒìŠ¤íŠ¸
window.testGroqApiKey = async function() {
    const apiKey = document.getElementById('groq-api-key')?.value;
    const resultDiv = document.getElementById('groq-api-test-result');
    
    if (!apiKey) {
        resultDiv.className = 'mt-2 text-sm text-red-600';
        resultDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
        resultDiv.classList.remove('hidden');
        return;
    }
    
    // í…ŒìŠ¤íŠ¸ ì¤‘ í‘œì‹œ
    resultDiv.className = 'mt-2 text-sm text-blue-600';
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>API í‚¤ í…ŒìŠ¤íŠ¸ ì¤‘...';
    resultDiv.classList.remove('hidden');
    
    try {
        console.log('ğŸ§ª GROQ API í‚¤ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
        
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'llama-3.3-70b-versatile',
                messages: [
                    { role: 'user', content: 'ì•ˆë…•í•˜ì„¸ìš”' }
                ],
                max_tokens: 10
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.choices && data.choices.length > 0) {
            // ì„±ê³µ
            const aiResponse = data.choices[0].message.content;
            resultDiv.className = 'mt-2 text-sm text-green-600 bg-green-50 p-2 rounded';
            resultDiv.innerHTML = `<i class="fas fa-check-circle mr-1"></i>âœ… API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!<br><small class="text-gray-600">í…ŒìŠ¤íŠ¸ ì‘ë‹µ: "${aiResponse.substring(0, 50)}..."</small>`;
            console.log('âœ… GROQ API í‚¤ í…ŒìŠ¤íŠ¸ ì„±ê³µ');
            
            // localStorageì— ì €ì¥
            localStorage.setItem('groq_api_key', apiKey);
            
            // DBì—ë„ ì €ì¥
            try {
                const formData = new FormData();
                formData.append('groq_api_key', apiKey);
                await axios.post(`${API_BASE_URL}/api/system-settings`, formData);
                console.log('âœ… GROQ API í‚¤ DB ì €ì¥ ì™„ë£Œ');
            } catch (dbError) {
                console.warn('âš ï¸ DB ì €ì¥ ì‹¤íŒ¨ (localStorageëŠ” ì €ì¥ë¨):', dbError);
            }
        } else if (data.error) {
            // API ì˜¤ë¥˜ (í•œê¸€ ë²ˆì—­)
            const translatedError = translateApiError(data.error.message);
            resultDiv.className = 'mt-2 text-sm text-red-600 bg-red-50 p-2 rounded whitespace-pre-line';
            resultDiv.innerHTML = `<i class="fas fa-times-circle mr-1"></i>${translatedError}`;
            console.error('âŒ GROQ API ì˜¤ë¥˜:', data.error);
        } else {
            // ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜
            resultDiv.className = 'mt-2 text-sm text-orange-600 bg-orange-50 p-2 rounded';
            resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µì…ë‹ˆë‹¤';
            console.warn('âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ GROQ API ì‘ë‹µ:', data);
        }
    } catch (error) {
        const translatedError = translateApiError(error.message);
        resultDiv.className = 'mt-2 text-sm text-red-600 bg-red-50 p-2 rounded whitespace-pre-line';
        resultDiv.innerHTML = `<i class="fas fa-times-circle mr-1"></i>${translatedError}`;
        console.error('âŒ GROQ API í‚¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
    }
}

// Gemini API í‚¤ í…ŒìŠ¤íŠ¸
window.testGeminiApiKey = async function() {
    const apiKey = document.getElementById('gemini-api-key')?.value;
    const resultDiv = document.getElementById('gemini-api-test-result');
    
    if (!apiKey) {
        resultDiv.className = 'mt-2 text-sm text-red-600';
        resultDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
        resultDiv.classList.remove('hidden');
        return;
    }
    
    // í…ŒìŠ¤íŠ¸ ì¤‘ í‘œì‹œ
    resultDiv.className = 'mt-2 text-sm text-blue-600';
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>API í‚¤ í…ŒìŠ¤íŠ¸ ì¤‘...';
    resultDiv.classList.remove('hidden');
    
    try {
        console.log('ğŸ§ª Gemini API í‚¤ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: 'ì•ˆë…•í•˜ì„¸ìš”' }]
                }],
                generationConfig: {
                    maxOutputTokens: 10
                }
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.candidates && data.candidates.length > 0) {
            // ì„±ê³µ
            const aiResponse = data.candidates[0].content.parts[0].text;
            resultDiv.className = 'mt-2 text-sm text-green-600 bg-green-50 p-2 rounded';
            resultDiv.innerHTML = `<i class="fas fa-check-circle mr-1"></i>âœ… API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤! (Gemini + Google Cloud TTS ì‚¬ìš© ê°€ëŠ¥)<br><small class="text-gray-600">í…ŒìŠ¤íŠ¸ ì‘ë‹µ: "${aiResponse.substring(0, 50)}..."</small>`;
            console.log('âœ… Gemini API í‚¤ í…ŒìŠ¤íŠ¸ ì„±ê³µ');
            
            // localStorageì— ì €ì¥
            localStorage.setItem('gemini_api_key', apiKey);
            
            // DBì—ë„ ì €ì¥
            try {
                const formData = new FormData();
                formData.append('gemini_api_key', apiKey);
                await axios.post(`${API_BASE_URL}/api/system-settings`, formData);
                console.log('âœ… Gemini API í‚¤ DB ì €ì¥ ì™„ë£Œ');
            } catch (dbError) {
                console.warn('âš ï¸ DB ì €ì¥ ì‹¤íŒ¨ (localStorageëŠ” ì €ì¥ë¨):', dbError);
            }
        } else if (data.error) {
            // API ì˜¤ë¥˜ (í•œê¸€ ë²ˆì—­)
            const translatedError = translateApiError(data.error.message);
            resultDiv.className = 'mt-2 text-sm text-red-600 bg-red-50 p-2 rounded whitespace-pre-line';
            resultDiv.innerHTML = `<i class="fas fa-times-circle mr-1"></i>${translatedError}`;
            console.error('âŒ Gemini API ì˜¤ë¥˜:', data.error);
        } else {
            // ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜
            resultDiv.className = 'mt-2 text-sm text-orange-600 bg-orange-50 p-2 rounded';
            resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µì…ë‹ˆë‹¤';
            console.warn('âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ Gemini API ì‘ë‹µ:', data);
        }
    } catch (error) {
        const translatedError = translateApiError(error.message);
        resultDiv.className = 'mt-2 text-sm text-red-600 bg-red-50 p-2 rounded whitespace-pre-line';
        resultDiv.innerHTML = `<i class="fas fa-times-circle mr-1"></i>${translatedError}`;
        console.error('âŒ Gemini API í‚¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
    }
}

// ëŒ€ì‹œë³´ë“œ BGM ì¥ë¥´ ë³€ê²½
window.changeBGMGenre = function(genre) {
    console.log('ğŸµ BGM ì¥ë¥´ ë³€ê²½:', genre);
    
    // ì‚¬ìš©ì ì •ì˜ ê²€ìƒ‰ì–´ì¸ì§€ í™•ì¸
    const isCustomSearch = genre && !['classical', 'piano', 'meditation', 'oldpop', '', 'custom'].includes(genre);
    
    // ê²€ìƒ‰ì°½ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬ (ëŒ€ì‹œë³´ë“œ BGM ì»¨íŠ¸ë¡¤)
    const dashboardGenreSelect = document.getElementById('dashboard-bgm-genre');
    const dashboardSearchInput = document.getElementById('dashboard-bgm-search');
    
    // 'custom' ì„ íƒ ì‹œ ê²€ìƒ‰ì°½ í‘œì‹œ
    if (genre === 'custom') {
        if (dashboardSearchInput) {
            dashboardSearchInput.classList.remove('hidden');
            dashboardSearchInput.focus();
        }
        return; // ê²€ìƒ‰ì–´ ì…ë ¥ ëŒ€ê¸°
    } else {
        // ë‹¤ë¥¸ ì¥ë¥´ ì„ íƒ ì‹œ ê²€ìƒ‰ì°½ ìˆ¨ê¹€
        if (dashboardSearchInput) dashboardSearchInput.classList.add('hidden');
    }
    
    const previousGenre = localStorage.getItem('bgm_genre');
    localStorage.setItem('bgm_genre', genre);
    
    // ëŒ€ì‹œë³´ë“œ ì¥ë¥´ ì„ íƒ ë™ê¸°í™”
    if (dashboardGenreSelect && dashboardGenreSelect.value !== genre && !isCustomSearch) {
        dashboardGenreSelect.value = genre;
    }
    
    // ì‚¬ìš©ì ì •ì˜ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥ì°½ì— í‘œì‹œ
    if (isCustomSearch) {
        if (dashboardSearchInput) dashboardSearchInput.value = genre;
        if (dashboardGenreSelect) dashboardGenreSelect.value = 'custom';
        // ê²€ìƒ‰ì°½ í‘œì‹œ
        if (dashboardSearchInput) dashboardSearchInput.classList.remove('hidden');
    }
    
    // BGM íŒ¨ë„ í‘œì‹œ/ìˆ¨ê¹€
    const bgmPanel = document.getElementById('dashboard-bgm-panel');
    
    if (genre) {
        // BGM ì¼œì§ - íŒ¨ë„ í‘œì‹œ
        if (bgmPanel) {
            bgmPanel.classList.remove('hidden');
            bgmPanel.classList.add('flex');
        }
        
        // ì¥ë¥´ê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ BGM ì¬ì‹œì‘
        if (previousGenre !== genre) {
            // ì´ì „ BGM ë¨¼ì € ì •ì§€
            console.log('â¹ï¸ ì´ì „ BGM ì •ì§€ ì¤‘...');
            stopBGM();
            
            // ìƒˆë¡œìš´ BGM ê²€ìƒ‰ ë° ì¬ìƒ
            window.searchYouTubeBGM();
            
            // ì¬ìƒ ë²„íŠ¼ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ (ëŒ€ì‹œë³´ë“œ BGM ì»¨íŠ¸ë¡¤)
            const dashboardPlayBtn = document.getElementById('dashboard-bgm-play-btn');
            if (dashboardPlayBtn) {
                dashboardPlayBtn.innerHTML = '<i class="fas fa-pause text-xs"></i>';
            }
        } else {
            console.log('âœ… ë™ì¼í•œ ì¥ë¥´ - BGM ìœ ì§€');
        }
    } else {
        // BGM êº¼ì§ - íŒ¨ë„ ìˆ¨ê¹€
        if (bgmPanel) {
            bgmPanel.classList.remove('flex');
            bgmPanel.classList.add('hidden');
        }
        
        stopBGM();
        // ì¬ìƒ ë²„íŠ¼ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ (ëŒ€ì‹œë³´ë“œ BGM ì»¨íŠ¸ë¡¤)
        const dashboardPlayBtn = document.getElementById('dashboard-bgm-play-btn');
        if (dashboardPlayBtn) {
            dashboardPlayBtn.innerHTML = '<i class="fas fa-play text-xs"></i>';
        }
    }
}

// BGM ì¬ìƒ/ì •ì§€ í† ê¸€
window.toggleBGM = function() {
    const dashboardGenre = document.getElementById('dashboard-bgm-genre')?.value;
    const genre = dashboardGenre;
    
    const dashboardPlayBtn = document.getElementById('dashboard-bgm-play-btn');
    
    if (!genre) {
        window.showAlert('BGM ì¥ë¥´ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }
    
    if (bgmPlayer && currentBGMVideoId) {
        // í˜„ì¬ ì¬ìƒ ì¤‘ì´ë©´ ì •ì§€
        stopBGM();
        if (dashboardPlayBtn) {
            dashboardPlayBtn.innerHTML = '<i class="fas fa-play text-xs"></i>';
        }
        console.log('â¸ï¸ BGM ì •ì§€');
    } else {
        // ì •ì§€ ì¤‘ì´ë©´ ì¬ìƒ
        window.searchYouTubeBGM();
        if (dashboardPlayBtn) {
            dashboardPlayBtn.innerHTML = '<i class="fas fa-pause text-xs"></i>';
        }
        console.log('â–¶ï¸ BGM ì¬ìƒ');
    }
}

// BGM ë³¼ë¥¨ ë³€ê²½ (ëŒ€ì‹œë³´ë“œ BGM ì»¨íŠ¸ë¡¤)
window.changeBGMVolume = function(volume) {
    console.log('ğŸ”Š BGM ë³¼ë¥¨ ë³€ê²½:', volume + '%');
    localStorage.setItem('bgm_volume', volume);
    
    // ëŒ€ì‹œë³´ë“œ ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ë™ê¸°í™”
    const dashboardVolumeSlider = document.getElementById('dashboard-bgm-volume');
    if (dashboardVolumeSlider && dashboardVolumeSlider.value !== volume) {
        dashboardVolumeSlider.value = volume;
    }
    
    // ë³¼ë¥¨ í‘œì‹œ ì—…ë°ì´íŠ¸ (ëŒ€ì‹œë³´ë“œ BGM ì»¨íŠ¸ë¡¤)
    const dashboardVolumeValue = document.getElementById('dashboard-volume-value');
    if (dashboardVolumeValue) {
        dashboardVolumeValue.textContent = volume + '%';
    }
    
    // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM ë³¼ë¥¨ ì—…ë°ì´íŠ¸
    if (bgmPlayer && bgmPlayer.setVolume) {
        bgmPlayer.setVolume(parseInt(volume));
        console.log('âœ… ë³¼ë¥¨ ì ìš©ë¨:', volume + '%');
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ BGM ì„¤ì • ë³µì› (ëŒ€ì‹œë³´ë“œ)
window.restoreBGMSettings = function() {
    const savedGenre = localStorage.getItem('bgm_genre') || '';
    const savedVolume = localStorage.getItem('bgm_volume') || '30';
    const wasPlaying = localStorage.getItem('bgm_is_playing') === 'true'; // BGMì´ ì¬ìƒ ì¤‘ì´ì—ˆëŠ”ì§€ í™•ì¸
    
    console.log('ğŸ”„ BGM ì„¤ì • ë³µì›:', { savedGenre, wasPlaying, currentBGMVideoId });
    
    // ëŒ€ì‹œë³´ë“œ BGM ì»¨íŠ¸ë¡¤ ë³µì›
    const dashboardGenreSelect = document.getElementById('dashboard-bgm-genre');
    const dashboardVolumeSlider = document.getElementById('dashboard-bgm-volume');
    const dashboardVolumeValue = document.getElementById('dashboard-volume-value');
    const bgmPanel = document.getElementById('dashboard-bgm-panel');
    
    if (dashboardGenreSelect) {
        dashboardGenreSelect.value = savedGenre;
        console.log('âœ… ëŒ€ì‹œë³´ë“œ BGM ì¥ë¥´ ë³µì›:', savedGenre || 'ë„ê¸°');
    }
    
    if (dashboardVolumeSlider) {
        dashboardVolumeSlider.value = savedVolume;
        console.log('âœ… ëŒ€ì‹œë³´ë“œ BGM ë³¼ë¥¨ ë³µì›:', savedVolume + '%');
    }
    
    if (dashboardVolumeValue) {
        dashboardVolumeValue.textContent = savedVolume + '%';
    }
    
    // BGM íŒ¨ë„ì€ í•­ìƒ í‘œì‹œ (ì‚¬ìš©ìê°€ ì§ì ‘ BGMì„ ì¼œê³  ëŒ ìˆ˜ ìˆë„ë¡)
    if (bgmPanel) {
        bgmPanel.classList.remove('hidden');
        bgmPanel.classList.add('flex');
        console.log('ğŸµ BGM íŒ¨ë„ í•­ìƒ í‘œì‹œ');
    }
    
    // BGMì´ ì¬ìƒ ì¤‘ì´ì—ˆê³ , ì¥ë¥´ê°€ ì„ íƒë˜ì–´ ìˆê³ , í˜„ì¬ BGMì´ ì¬ìƒ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì¬ê°œ
    if (wasPlaying && savedGenre && currentTab === 'dashboard' && !currentBGMVideoId) {
        console.log('ğŸ”„ BGM ìë™ ì¬ê°œ ì‹œë„:', savedGenre);
        // ì•½ê°„ì˜ ì§€ì—° í›„ BGM ì¬ê°œ (YouTube API ë¡œë“œ ëŒ€ê¸°)
        setTimeout(() => {
            window.changeBGMGenre(savedGenre);
        }, 500);
    } else {
        console.log('â­ï¸ BGM ì¬ê°œ ê±´ë„ˆëœ€:', { wasPlaying, savedGenre, currentTab, currentBGMVideoId });
    }
}

// ==================== í˜ì´ì§€ ë¡œë“œ ì‹œ í—¤ë” ì—…ë°ì´íŠ¸ ë° ê¶Œí•œ ì²´í¬ ====================
// í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œëœ í›„ í—¤ë” ì—…ë°ì´íŠ¸ ë° ë©”ë‰´ ê¶Œí•œ ì²´í¬ ì‹¤í–‰
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        updateHeader();
        applyMenuPermissions();
        window.restoreBGMSettings(); // BGM ì„¤ì • ë³µì› (í—¤ë”)
        // í…Œë§ˆê°€ localStorageì— ì—†ìœ¼ë©´ ê¸°ë³¸ í…Œë§ˆ ì €ì¥
        if (!localStorage.getItem('system_theme')) {
            localStorage.setItem('system_theme', JSON.stringify(THEME_PRESETS.default));
            console.log('ğŸ’¾ ê¸°ë³¸ í…Œë§ˆ ì €ì¥ë¨');
        }
    });
} else {
    // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
    updateHeader();
    applyMenuPermissions();
    window.restoreBGMSettings(); // BGM ì„¤ì • ë³µì› (í—¤ë”)
    // í…Œë§ˆê°€ localStorageì— ì—†ìœ¼ë©´ ê¸°ë³¸ í…Œë§ˆ ì €ì¥
    if (!localStorage.getItem('system_theme')) {
        localStorage.setItem('system_theme', JSON.stringify(THEME_PRESETS.default));
        console.log('ğŸ’¾ ê¸°ë³¸ í…Œë§ˆ ì €ì¥ë¨');
    }
}

// ==================== DB ê´€ë¦¬ ====================
async function loadBackupManager() {
    const content = document.getElementById('app');
    content.innerHTML = `
        <div class="max-w-6xl mx-auto p-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-database mr-2 text-blue-600"></i>
                        ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬
                    </h2>
                </div>

                <!-- DB ê´€ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- DB ë°±ì—… ì¹´ë“œ -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-download text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-blue-800">DB ë°±ì—…</h3>
                                <p class="text-sm text-blue-600">í˜„ì¬ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë°±ì—…í•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        <button onclick="openDbManagementModal('backup')"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-play mr-2"></i>ë°±ì—… ì‹¤í–‰
                        </button>
                    </div>

                    <!-- DB ì´ˆê¸°í™” ì¹´ë“œ -->
                    <div class="bg-gradient-to-br from-red-50 to-red-100 border border-red-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-red-800">DB ì´ˆê¸°í™”</h3>
                                <p class="text-sm text-red-600">ìë™ ë°±ì—… í›„ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="showTableSelectModal('reset')"
                                class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-list-check mr-2"></i>ì„ íƒ ì‚­ì œ
                            </button>
                            <button onclick="openDbManagementModal('reset')"
                                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-trash-alt mr-2"></i>ì „ì²´ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ë°±ì—… ì„¤ì • -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3">
                        <i class="fas fa-cog mr-2"></i>ë°±ì—… íŒŒì¼ ê´€ë¦¬
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ë°±ì—… ë³´ê´€ ê¸°ê°„ (ì¼)
                            </label>
                            <input type="number" id="backup-keep-days" value="7" min="1" max="30"
                                class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div class="flex items-end">
                            <button onclick="cleanupOldBackups()" class="btn-secondary px-4 py-2 rounded-lg">
                                <i class="fas fa-broom mr-2"></i>ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ë°±ì—… ëª©ë¡ -->
                <div class="mb-8">
                    <h3 class="font-bold text-gray-700 mb-3">
                        <i class="fas fa-folder-open mr-2"></i>ë°±ì—… íŒŒì¼ ëª©ë¡
                    </h3>
                    <div id="backup-list" class="space-y-3">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                            <p>ë°±ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>

                <!-- ê´€ë¦¬ ë¡œê·¸ -->
                <div>
                    <h3 class="font-bold text-gray-700 mb-3">
                        <i class="fas fa-history mr-2"></i>DB ê´€ë¦¬ ë¡œê·¸
                    </h3>
                    <div id="db-management-logs" class="overflow-x-auto overflow-y-auto max-h-96 border rounded-lg">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                            <p>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB ê´€ë¦¬ ì¸ì¦ ëª¨ë‹¬ -->
        <div id="db-management-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
                <div id="db-modal-header" class="p-6 rounded-t-2xl">
                    <div class="flex items-center gap-4">
                        <div id="db-modal-icon" class="text-4xl"></div>
                        <h3 id="db-modal-title" class="text-xl font-bold text-white"></h3>
                    </div>
                </div>
                <div class="p-6">
                    <p id="db-modal-desc" class="text-gray-600 mb-6"></p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-1"></i>ê°•ì‚¬ ì´ë¦„
                            </label>
                            <input type="text" id="db-mgmt-instructor-name"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="ê°•ì‚¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-key mr-1"></i>ë¹„ë°€ë²ˆí˜¸
                            </label>
                            <input type="password" id="db-mgmt-password"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" />
                        </div>
                    </div>

                    <div id="db-modal-warning" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-800 text-sm">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            <strong>ì£¼ì˜:</strong> DB ì´ˆê¸°í™”ëŠ” ì‹œê°„í‘œ, í›ˆë ¨ì¼ì§€, í•™ìƒì •ë³´, ìˆ˜ì—…ì¼ì§€, ìƒë‹´, ê³µì§€ì‚¬í•­, íŒ€ í™œë™ì¼ì§€, í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
                            <br>ê³¼ì •, ê³¼ëª©, ê°•ì‚¬, íœ´ì¼, ì‹œìŠ¤í…œ ì„¤ì •ì€ ìœ ì§€ë©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
                <div class="p-6 pt-0 flex justify-end gap-3">
                    <button onclick="closeDbManagementModal()"
                        class="px-6 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-colors">
                        ì·¨ì†Œ
                    </button>
                    <button id="db-modal-confirm-btn" onclick="executeDbManagement()"
                        class="px-6 py-2.5 text-white rounded-lg font-semibold transition-colors">
                        ì‹¤í–‰
                    </button>
                </div>
            </div>
        </div>
    `;

    // ë°±ì—… ëª©ë¡ ë° ë¡œê·¸ ë¡œë“œ
    await Promise.all([refreshBackupList(), loadDbManagementLogs()]);
}

// DB ê´€ë¦¬ ëª¨ë‹¬ ìƒíƒœ
let dbManagementAction = '';

window.openDbManagementModal = function(action) {
    dbManagementAction = action;
    const modal = document.getElementById('db-management-modal');
    const header = document.getElementById('db-modal-header');
    const icon = document.getElementById('db-modal-icon');
    const title = document.getElementById('db-modal-title');
    const desc = document.getElementById('db-modal-desc');
    const warning = document.getElementById('db-modal-warning');
    const confirmBtn = document.getElementById('db-modal-confirm-btn');

    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('db-mgmt-instructor-name').value = '';
    document.getElementById('db-mgmt-password').value = '';

    if (action === 'backup') {
        header.className = 'p-6 rounded-t-2xl bg-gradient-to-r from-blue-500 to-blue-600';
        icon.innerHTML = '<i class="fas fa-download text-white"></i>';
        title.textContent = 'DB ë°±ì—… ì‹¤í–‰';
        desc.textContent = 'ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë°±ì—…í•˜ë ¤ë©´ ê°•ì‚¬ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ì‘ì—… ë‚´ì—­ì€ ë¡œê·¸ì— ê¸°ë¡ë©ë‹ˆë‹¤.';
        warning.classList.add('hidden');
        confirmBtn.className = 'px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors';
        confirmBtn.innerHTML = '<i class="fas fa-download mr-2"></i>ë°±ì—… ì‹¤í–‰';
    } else if (action === 'reset') {
        header.className = 'p-6 rounded-t-2xl bg-gradient-to-r from-red-500 to-red-600';
        icon.innerHTML = '<i class="fas fa-exclamation-triangle text-white"></i>';
        title.textContent = 'DB ì´ˆê¸°í™” ì‹¤í–‰';
        desc.textContent = 'ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ˆê¸°í™”í•˜ë ¤ë©´ ê°•ì‚¬ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ì´ˆê¸°í™” ì „ ìë™ìœ¼ë¡œ ë°±ì—…ì´ ìƒì„±ë©ë‹ˆë‹¤.';
        warning.classList.remove('hidden');
        confirmBtn.className = 'px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors';
        confirmBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i>ì´ˆê¸°í™” ì‹¤í–‰';
    }

    modal.classList.remove('hidden');
    document.getElementById('db-mgmt-instructor-name').focus();
};

window.closeDbManagementModal = function() {
    document.getElementById('db-management-modal').classList.add('hidden');
    dbManagementAction = '';
};

// ë°±ì—… ì§„í–‰ ìƒí™© ëª¨ë‹¬ í‘œì‹œ
function showBackupProgress(action) {
    const isBackup = action === 'backup';
    const progressHtml = `
        <div id="backup-progress-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[10000]">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
                <div class="p-6 ${isBackup ? 'bg-gradient-to-r from-blue-500 to-blue-600' : 'bg-gradient-to-r from-red-500 to-red-600'}">
                    <div class="flex items-center gap-4">
                        <div class="text-4xl text-white">
                            <i class="fas ${isBackup ? 'fa-download' : 'fa-database'} animate-pulse"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white">${isBackup ? 'DB ë°±ì—… ì§„í–‰ ì¤‘' : 'DB ì´ˆê¸°í™” ì§„í–‰ ì¤‘'}</h3>
                    </div>
                </div>
                <div class="p-6">
                    <div id="backup-progress-steps" class="space-y-4">
                        <div id="step-auth" class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                                <i class="fas fa-check"></i>
                            </div>
                            <span class="text-gray-700">ì¸ì¦ ì™„ë£Œ</span>
                        </div>
                        <div id="step-prepare" class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <span class="text-gray-700">ë°ì´í„° ì¤€ë¹„ ì¤‘...</span>
                        </div>
                        <div id="step-tables" class="flex items-center gap-3 opacity-50">
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white">
                                <i class="fas fa-table"></i>
                            </div>
                            <span class="text-gray-500">í…Œì´ë¸” ë°±ì—… ì¤‘...</span>
                        </div>
                        <div id="step-save" class="flex items-center gap-3 opacity-50">
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white">
                                <i class="fas fa-save"></i>
                            </div>
                            <span class="text-gray-500">íŒŒì¼ ì €ì¥ ì¤‘...</span>
                        </div>
                    </div>

                    <!-- ì§„í–‰ ë°” -->
                    <div class="mt-6">
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="backup-progress-bar" class="h-full ${isBackup ? 'bg-blue-500' : 'bg-red-500'} rounded-full transition-all duration-500" style="width: 25%"></div>
                        </div>
                        <p id="backup-progress-text" class="text-center text-sm text-gray-500 mt-2">ë°ì´í„° ì¤€ë¹„ ì¤‘...</p>
                    </div>

                    <!-- í˜„ì¬ í…Œì´ë¸” í‘œì‹œ -->
                    <div id="backup-current-table" class="mt-4 p-3 bg-gray-50 rounded-lg text-center hidden">
                        <p class="text-xs text-gray-400">í˜„ì¬ ì²˜ë¦¬ ì¤‘</p>
                        <p id="backup-table-name" class="text-sm font-semibold text-gray-700">-</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', progressHtml);
}

function updateBackupProgress(step, progress, tableName = '') {
    const progressBar = document.getElementById('backup-progress-bar');
    const progressText = document.getElementById('backup-progress-text');
    const currentTable = document.getElementById('backup-current-table');
    const tableNameEl = document.getElementById('backup-table-name');

    if (progressBar) progressBar.style.width = `${progress}%`;

    // ë‹¨ê³„ ì—…ë°ì´íŠ¸
    const steps = {
        prepare: { text: 'ë°ì´í„° ì¤€ë¹„ ì¤‘...', progress: 25 },
        tables: { text: 'í…Œì´ë¸” ë°±ì—… ì¤‘...', progress: 50 },
        save: { text: 'íŒŒì¼ ì €ì¥ ì¤‘...', progress: 75 },
        complete: { text: 'ì™„ë£Œ!', progress: 100 }
    };

    if (steps[step] && progressText) {
        progressText.textContent = steps[step].text;
    }

    // í…Œì´ë¸” ì´ë¦„ í‘œì‹œ
    if (step === 'tables' && tableName) {
        if (currentTable) currentTable.classList.remove('hidden');
        if (tableNameEl) tableNameEl.textContent = tableName;
    }

    // ë‹¨ê³„ë³„ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    if (step === 'tables') {
        const stepPrepare = document.getElementById('step-prepare');
        if (stepPrepare) {
            stepPrepare.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <i class="fas fa-check"></i>
                </div>
                <span class="text-gray-700">ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ</span>
            `;
        }
        const stepTables = document.getElementById('step-tables');
        if (stepTables) {
            stepTables.classList.remove('opacity-50');
            stepTables.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <span class="text-gray-700">í…Œì´ë¸” ë°±ì—… ì¤‘...</span>
            `;
        }
    } else if (step === 'save') {
        const stepTables = document.getElementById('step-tables');
        if (stepTables) {
            stepTables.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <i class="fas fa-check"></i>
                </div>
                <span class="text-gray-700">í…Œì´ë¸” ë°±ì—… ì™„ë£Œ</span>
            `;
        }
        const stepSave = document.getElementById('step-save');
        if (stepSave) {
            stepSave.classList.remove('opacity-50');
            stepSave.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <span class="text-gray-700">íŒŒì¼ ì €ì¥ ì¤‘...</span>
            `;
        }
    } else if (step === 'complete') {
        const stepSave = document.getElementById('step-save');
        if (stepSave) {
            stepSave.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <i class="fas fa-check"></i>
                </div>
                <span class="text-gray-700">íŒŒì¼ ì €ì¥ ì™„ë£Œ</span>
            `;
        }
    }
}

function hideBackupProgress() {
    const modal = document.getElementById('backup-progress-modal');
    if (modal) modal.remove();
}

// ì™„ë£Œ í™”ë©´ í‘œì‹œ (ìµœì†Œ 2ì´ˆ ìœ ì§€)
function showCompletionScreen(action, result) {
    const isBackup = action === 'backup';
    const isReset = action === 'reset';
    const isRestore = action === 'restore';

    let title, icon, color, details;

    if (isBackup) {
        title = 'DB ë°±ì—… ì™„ë£Œ!';
        icon = 'fa-check-circle';
        color = 'from-green-500 to-green-600';
        details = `
            <div class="text-left space-y-2">
                <p><i class="fas fa-user mr-2 text-gray-400"></i>ì‘ì—…ì: ${result.operator || '-'}</p>
                <p><i class="fas fa-database mr-2 text-gray-400"></i>ì´ ë ˆì½”ë“œ: ${result.total_records?.toLocaleString() || 0}ê°œ</p>
                <p><i class="fas fa-file mr-2 text-gray-400"></i>íŒŒì¼ í¬ê¸°: ${((result.file_size || 0) / 1024 / 1024).toFixed(2)} MB</p>
                <p class="text-xs text-gray-400 mt-2"><i class="fas fa-save mr-1"></i>${result.backup_file || ''}</p>
            </div>
        `;
    } else if (isReset) {
        title = 'DB ì´ˆê¸°í™” ì™„ë£Œ!';
        icon = 'fa-check-circle';
        color = 'from-orange-500 to-red-500';
        details = `
            <div class="text-left space-y-2">
                <p><i class="fas fa-user mr-2 text-gray-400"></i>ì‘ì—…ì: ${result.operator || '-'}</p>
                <p><i class="fas fa-trash mr-2 text-gray-400"></i>ì‚­ì œëœ ë ˆì½”ë“œ: ${result.total_deleted?.toLocaleString() || 0}ê°œ</p>
                <p class="text-xs text-gray-400 mt-2"><i class="fas fa-shield-alt mr-1"></i>ë°±ì—…: ${result.backup_file || ''}</p>
            </div>
        `;
    } else if (isRestore) {
        title = 'DB ë³µêµ¬ ì™„ë£Œ!';
        icon = 'fa-check-circle';
        color = 'from-purple-500 to-purple-600';
        details = `
            <div class="text-left space-y-2">
                <p><i class="fas fa-user mr-2 text-gray-400"></i>ì‘ì—…ì: ${result.operator || '-'}</p>
                <p><i class="fas fa-database mr-2 text-gray-400"></i>ë³µêµ¬ëœ ë ˆì½”ë“œ: ${result.total_restored?.toLocaleString() || 0}ê°œ</p>
                <p class="text-xs text-gray-400 mt-2"><i class="fas fa-file-import mr-1"></i>ì›ë³¸: ${result.backup_file || ''}</p>
                <p class="text-xs text-gray-400"><i class="fas fa-shield-alt mr-1"></i>ì•ˆì „ë°±ì—…: ${result.pre_restore_backup || ''}</p>
            </div>
        `;
    }

    const completionHtml = `
        <div id="completion-screen-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[10001]">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden transform scale-0 animate-completion-pop">
                <div class="p-8 bg-gradient-to-r ${color} text-center">
                    <div class="text-6xl text-white mb-4 animate-bounce-once">
                        <i class="fas ${icon}"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white">${title}</h3>
                </div>
                <div class="p-6">
                    ${details}
                    <div class="mt-6 text-center">
                        <div class="inline-flex items-center gap-2 text-sm text-gray-400">
                            <i class="fas fa-clock"></i>
                            <span>ì ì‹œ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style>
            @keyframes completion-pop {
                0% { transform: scale(0); opacity: 0; }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); opacity: 1; }
            }
            @keyframes bounce-once {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-10px); }
            }
            .animate-completion-pop {
                animation: completion-pop 0.4s ease-out forwards;
            }
            .animate-bounce-once {
                animation: bounce-once 0.6s ease-in-out;
            }
        </style>
    `;

    document.body.insertAdjacentHTML('beforeend', completionHtml);

    // 2.5ì´ˆ í›„ ìë™ ë‹«ê¸°
    return new Promise(resolve => {
        setTimeout(() => {
            const modal = document.getElementById('completion-screen-modal');
            if (modal) {
                modal.style.transition = 'opacity 0.3s';
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.remove();
                    resolve();
                }, 300);
            } else {
                resolve();
            }
        }, 2500);
    });
}

window.executeDbManagement = async function() {
    const instructorName = document.getElementById('db-mgmt-instructor-name').value.trim();
    const password = document.getElementById('db-mgmt-password').value.trim();

    if (!instructorName || !password) {
        showAlert('ê°•ì‚¬ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    // ì¸ì¦ í™•ì¸
    try {
        showLoading('ì¸ì¦ í™•ì¸ ì¤‘...');
        const verifyRes = await axios.post(`${API_BASE_URL}/api/db-management/verify`, {
            instructor_name: instructorName,
            password: password
        });

        hideLoading();

        if (!verifyRes.data.success) {
            showAlert(verifyRes.data.message, 'error');
            return;
        }

        const operatorName = verifyRes.data.instructor_name;
        const operatorCode = verifyRes.data.instructor_code;

        // ì•¡ì…˜ì„ ë¨¼ì € ì €ì¥ (closeDbManagementModalì—ì„œ ì´ˆê¸°í™”ë˜ë¯€ë¡œ)
        const currentAction = dbManagementAction;

        closeDbManagementModal();

        if (currentAction === 'backup') {
            // ë°±ì—… ì§„í–‰ ëª¨ë‹¬ í‘œì‹œ
            showBackupProgress('backup');

            // ë‹¨ê³„ë³„ ì§„í–‰ ì‹œë®¬ë ˆì´ì…˜ê³¼ ì‹¤ì œ API í˜¸ì¶œ
            await new Promise(resolve => setTimeout(resolve, 800));
            updateBackupProgress('tables', 40, 'students');

            try {
                // API í˜¸ì¶œê³¼ ë™ì‹œì— ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰
                const apiPromise = axios.post(`${API_BASE_URL}/api/db-management/backup-with-log`, {
                    operator_name: operatorName,
                    instructor_code: operatorCode
                }, { timeout: 60000 });

                // í…Œì´ë¸”ë³„ ì• ë‹ˆë©”ì´ì…˜ (ìµœì†Œ ì‹œê°„ ë³´ì¥)
                const tables = ['students', 'timetables', 'training_logs', 'consultations', 'notices'];
                for (let i = 0; i < tables.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 400));
                    updateBackupProgress('tables', 40 + (i * 8), tables[i]);
                }

                const response = await apiPromise;

                updateBackupProgress('save', 85);
                await new Promise(resolve => setTimeout(resolve, 600));
                updateBackupProgress('complete', 100);
                await new Promise(resolve => setTimeout(resolve, 500));

                hideBackupProgress();

                if (response.data.success) {
                    // ì™„ë£Œ í™”ë©´ í‘œì‹œ (2.5ì´ˆ ìœ ì§€)
                    await showCompletionScreen('backup', {
                        operator: operatorName,
                        total_records: response.data.total_records,
                        file_size: response.data.file_size,
                        backup_file: response.data.backup_file
                    });
                    await Promise.all([refreshBackupList(), loadDbManagementLogs()]);
                }
            } catch (backupError) {
                hideBackupProgress();
                console.error('ë°±ì—… API í˜¸ì¶œ ì‹¤íŒ¨:', backupError);
                showAlert(backupError.response?.data?.detail || 'ë°±ì—… ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } else if (currentAction === 'reset') {
            // ìµœì¢… í™•ì¸
            const confirmed = await showConfirm(`ì •ë§ë¡œ DBë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‘ì—…ì: ${operatorName}\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(ë°±ì—… íŒŒì¼ì—ì„œ ìˆ˜ë™ ë³µì› í•„ìš”)`, 'DB ì´ˆê¸°í™” ìµœì¢… í™•ì¸');

            if (confirmed) {
                // ì´ˆê¸°í™” ì§„í–‰ ëª¨ë‹¬ í‘œì‹œ
                showBackupProgress('reset');

                try {
                    await new Promise(resolve => setTimeout(resolve, 800));
                    updateBackupProgress('tables', 30, 'ì•ˆì „ ë°±ì—… ìƒì„± ì¤‘');

                    // API í˜¸ì¶œê³¼ ë™ì‹œì— ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰
                    const apiPromise = axios.post(`${API_BASE_URL}/api/db-management/reset`, {
                        operator_name: operatorName,
                        instructor_code: operatorCode
                    }, { timeout: 120000 });

                    // ë‹¨ê³„ë³„ ì• ë‹ˆë©”ì´ì…˜ (ìµœì†Œ ì‹œê°„ ë³´ì¥)
                    const steps = ['ë°±ì—… íŒŒì¼ ìƒì„±', 'ë°ì´í„° ì‚­ì œ ì¤€ë¹„', 'consultations ì‚­ì œ', 'training_logs ì‚­ì œ', 'students ì‚­ì œ'];
                    for (let i = 0; i < steps.length; i++) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        updateBackupProgress('tables', 30 + (i * 12), steps[i]);
                    }

                    const response = await apiPromise;

                    updateBackupProgress('save', 90);
                    await new Promise(resolve => setTimeout(resolve, 600));
                    updateBackupProgress('complete', 100);
                    await new Promise(resolve => setTimeout(resolve, 500));

                    hideBackupProgress();

                    if (response.data.success) {
                        // ì™„ë£Œ í™”ë©´ í‘œì‹œ (2.5ì´ˆ ìœ ì§€)
                        await showCompletionScreen('reset', {
                            operator: operatorName,
                            total_deleted: response.data.total_deleted,
                            backup_file: response.data.backup_file
                        });
                        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ëª¨ë“  ë°ì´í„° ê°±ì‹ )
                        location.reload();
                    }
                } catch (resetError) {
                    hideBackupProgress();
                    console.error('ì´ˆê¸°í™” API í˜¸ì¶œ ì‹¤íŒ¨:', resetError);
                    showAlert(resetError.response?.data?.detail || 'DB ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }
    } catch (error) {
        hideLoading();
        hideBackupProgress();
        console.error('DB ê´€ë¦¬ ì‘ì—… ì‹¤íŒ¨:', error);
        showAlert(error.response?.data?.detail || 'DB ê´€ë¦¬ ì‘ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
};

async function loadDbManagementLogs() {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/db-management/logs?limit=20`);
        const logs = response.data.logs;
        const container = document.getElementById('db-management-logs');

        if (!logs || logs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-6 text-gray-500">
                    <i class="fas fa-clipboard-list text-3xl mb-2"></i>
                    <p>ê´€ë¦¬ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‘ì—…ì‹œê°„</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‘ì—…ìœ í˜•</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‘ì—…ì</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê²°ê³¼</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë°±ì—…íŒŒì¼</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒì„¸</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${logs.map(log => {
                        const date = new Date(log.created_at);
                        const dateStr = date.toLocaleString('ko-KR');
                        const actionLabel = log.action_type === 'backup' ?
                            '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">ë°±ì—…</span>' :
                            '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">ì´ˆê¸°í™”</span>';
                        const resultLabel = log.action_result === 'success' ?
                            '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">ì„±ê³µ</span>' :
                            '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">ì‹¤íŒ¨</span>';

                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-600">${dateStr}</td>
                                <td class="px-4 py-3">${actionLabel}</td>
                                <td class="px-4 py-3 text-sm text-gray-800">${log.operator_name}</td>
                                <td class="px-4 py-3">${resultLabel}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">${log.backup_file || '-'}</td>
                                <td class="px-4 py-3 text-sm text-gray-500 max-w-xs truncate" title="${log.details || ''}">${log.details || '-'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        console.error('ê´€ë¦¬ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('db-management-logs').innerHTML = `
            <div class="text-center py-6 text-red-500">
                <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                <p>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
            </div>
        `;
    }
}

async function refreshBackupList() {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/backup/list`);
        const backups = response.data.backups;

        const listContainer = document.getElementById('backup-list');

        if (backups.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            `;
            return;
        }

        listContainer.innerHTML = backups.map(backup => {
            const sizeMB = (backup.size / 1024 / 1024).toFixed(2);
            const date = new Date(backup.created_at);
            const dateStr = date.toLocaleString('ko-KR');

            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-file-archive text-3xl text-blue-500"></i>
                        <div>
                            <p class="font-semibold text-gray-800">${backup.filename}</p>
                            <p class="text-sm text-gray-500">
                                <i class="fas fa-clock mr-1"></i>${dateStr}
                                <span class="mx-2">|</span>
                                <i class="fas fa-hdd mr-1"></i>${sizeMB} MB
                            </p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="showTableSelectModal('restore', '${backup.filename}')"
                            class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm"
                            title="í…Œì´ë¸” ì„ íƒí•˜ì—¬ ë³µêµ¬">
                            <i class="fas fa-list-check mr-1"></i>ì„ íƒ ë³µêµ¬
                        </button>
                        <button onclick="restoreBackup('${backup.filename}')"
                            class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm"
                            title="ì „ì²´ ë³µêµ¬">
                            <i class="fas fa-undo mr-1"></i>ì „ì²´ ë³µêµ¬
                        </button>
                        <button onclick="deleteBackup('${backup.filename}')"
                            class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                            <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                        </button>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('ë°±ì—… ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('ë°±ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

async function deleteBackup(filename) {
    const confirmed = await showConfirm(`ë°±ì—… íŒŒì¼ "${filename}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'ë°±ì—… íŒŒì¼ ì‚­ì œ');
    if (!confirmed) return;

    try {
        await axios.delete(`${API_BASE_URL}/api/backup/delete/${filename}`);
        showAlert('ë°±ì—… íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        await refreshBackupList();
    } catch (error) {
        console.error('ë°±ì—… ì‚­ì œ ì‹¤íŒ¨:', error);
        showAlert('ë°±ì—… ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

async function cleanupOldBackups() {
    const keepDays = parseInt(document.getElementById('backup-keep-days').value);

    const confirmed = await showConfirm(`${keepDays}ì¼ ì´ì „ì˜ ë°±ì—… íŒŒì¼ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬');
    if (!confirmed) return;

    try {
        showLoading('ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬ ì¤‘...');
        const response = await axios.post(`${API_BASE_URL}/api/backup/auto-cleanup?keep_days=${keepDays}`);
        hideLoading();

        showAlert(response.data.message, 'success');
        await refreshBackupList();
    } catch (error) {
        hideLoading();
        console.error('ë°±ì—… ì •ë¦¬ ì‹¤íŒ¨:', error);
        showAlert('ë°±ì—… ì •ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// í…Œì´ë¸” ì„ íƒ ëª¨ë‹¬ ê¸°ëŠ¥
let tableSelectAction = '';  // 'restore' ë˜ëŠ” 'reset'
let tableSelectFile = '';
let selectedTables = [];

window.showTableSelectModal = async function(action, filename = '') {
    tableSelectAction = action;
    tableSelectFile = filename;
    selectedTables = [];

    const isRestore = action === 'restore';
    const title = isRestore ? 'í…Œì´ë¸” ì„ íƒ ë³µêµ¬' : 'í…Œì´ë¸” ì„ íƒ ì‚­ì œ';
    const color = isRestore ? 'purple' : 'red';

    // í…Œì´ë¸” ì •ë³´ ë¡œë“œ
    let tablesInfo;
    try {
        showLoading('í…Œì´ë¸” ì •ë³´ ë¡œë“œ ì¤‘...');
        if (isRestore) {
            const res = await axios.get(`${API_BASE_URL}/api/db-management/backup-info/${filename}`);
            tablesInfo = res.data.tables;
        } else {
            const res = await axios.get(`${API_BASE_URL}/api/db-management/current-tables`);
            tablesInfo = res.data.tables;
        }
        hideLoading();
    } catch (error) {
        hideLoading();
        showAlert('í…Œì´ë¸” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
        return;
    }

    const modalHtml = `
        <div id="table-select-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
            <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
                <div class="p-6 bg-gradient-to-r from-${color}-500 to-${color}-600">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-table text-3xl text-white"></i>
                        <div>
                            <h3 class="text-xl font-bold text-white">${title}</h3>
                            <p class="text-${color}-100 text-sm">${isRestore ? filename : 'í˜„ì¬ DBì—ì„œ ì‚­ì œí•  í…Œì´ë¸” ì„ íƒ'}</p>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="mb-4 flex justify-between items-center">
                        <span class="text-sm text-gray-500">ë³µêµ¬/ì‚­ì œí•  í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”</span>
                        <div class="space-x-2">
                            <button onclick="toggleAllTables(true)" class="text-sm text-blue-600 hover:underline">ì „ì²´ ì„ íƒ</button>
                            <button onclick="toggleAllTables(false)" class="text-sm text-gray-600 hover:underline">ì „ì²´ í•´ì œ</button>
                        </div>
                    </div>
                    <div class="max-h-[300px] overflow-y-auto space-y-2" id="table-checkbox-list">
                        ${tablesInfo.map(t => `
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" value="${t.table}"
                                    class="table-checkbox w-5 h-5 text-${color}-600 rounded focus:ring-${color}-500"
                                    onchange="updateTableSelection()">
                                <span class="ml-3 flex-1">
                                    <span class="font-medium text-gray-800">${t.name_kr}</span>
                                    <span class="text-gray-400 text-sm ml-2">(${t.table})</span>
                                </span>
                                <span class="text-sm text-gray-500">${t.count}ê±´</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-check-square mr-1 text-${color}-500"></i>
                            ì„ íƒë¨: <span id="selected-table-count" class="font-semibold">0</span>ê°œ í…Œì´ë¸”
                        </p>
                    </div>
                    ${!isRestore ? `
                        <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                ê°•ì‚¬(instructors) ì‚­ì œ ì‹œ <strong>root</strong> ê³„ì •ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”
                            </p>
                        </div>
                    ` : ''}
                </div>
                <div class="px-6 pb-6 flex justify-end gap-3">
                    <button onclick="closeTableSelectModal()"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        ì·¨ì†Œ
                    </button>
                    <button id="table-select-confirm-btn" onclick="confirmTableSelection()"
                        class="px-4 py-2 bg-${color}-600 text-white rounded-lg hover:bg-${color}-700 disabled:opacity-50"
                        disabled>
                        <i class="fas ${isRestore ? 'fa-undo' : 'fa-trash'} mr-1"></i>
                        ${isRestore ? 'ì„ íƒ ë³µêµ¬' : 'ì„ íƒ ì‚­ì œ'}
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.closeTableSelectModal = function() {
    const modal = document.getElementById('table-select-modal');
    if (modal) modal.remove();
};

window.toggleAllTables = function(checked) {
    document.querySelectorAll('.table-checkbox').forEach(cb => cb.checked = checked);
    updateTableSelection();
};

window.updateTableSelection = function() {
    selectedTables = Array.from(document.querySelectorAll('.table-checkbox:checked')).map(cb => cb.value);
    document.getElementById('selected-table-count').textContent = selectedTables.length;
    document.getElementById('table-select-confirm-btn').disabled = selectedTables.length === 0;
};

window.confirmTableSelection = async function() {
    if (selectedTables.length === 0) {
        showAlert('í…Œì´ë¸”ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
        return;
    }

    closeTableSelectModal();

    if (tableSelectAction === 'restore') {
        // ë³µêµ¬ ì¸ì¦ ëª¨ë‹¬ë¡œ ì´ë™ (ì„ íƒëœ í…Œì´ë¸” ì •ë³´ í¬í•¨)
        restoreWithTables(tableSelectFile, selectedTables);
    } else {
        // ì‚­ì œ ì¸ì¦ ëª¨ë‹¬ë¡œ ì´ë™ (ì„ íƒëœ í…Œì´ë¸” ì •ë³´ í¬í•¨)
        resetWithTables(selectedTables);
    }
};

// í…Œì´ë¸” ì„ íƒ ë³µêµ¬
async function restoreWithTables(filename, tables) {
    restoreTargetFile = filename;
    restoreSelectedTables = tables;

    const modal = document.getElementById('db-management-modal');
    const header = document.getElementById('db-modal-header');
    const icon = document.getElementById('db-modal-icon');
    const title = document.getElementById('db-modal-title');
    const desc = document.getElementById('db-modal-desc');
    const warning = document.getElementById('db-modal-warning');
    const confirmBtn = document.getElementById('db-modal-confirm-btn');

    document.getElementById('db-mgmt-instructor-name').value = '';
    document.getElementById('db-mgmt-password').value = '';

    header.className = 'p-6 rounded-t-2xl bg-gradient-to-r from-purple-500 to-purple-600';
    icon.innerHTML = '<i class="fas fa-list-check text-white"></i>';
    title.textContent = 'í…Œì´ë¸” ì„ íƒ ë³µêµ¬';
    desc.innerHTML = `
        <strong>ë³µêµ¬í•  ë°±ì—…:</strong> <span class="text-purple-600">${filename}</span><br>
        <strong>ì„ íƒëœ í…Œì´ë¸” (${tables.length}ê°œ):</strong><br>
        <span class="text-sm text-gray-600">${tables.join(', ')}</span>
    `;
    warning.classList.remove('hidden');
    warning.innerHTML = `<p class="text-yellow-800 text-sm"><i class="fas fa-info-circle mr-1"></i>ì„ íƒí•œ í…Œì´ë¸”ë§Œ ë³µêµ¬ë©ë‹ˆë‹¤. ë³µêµ¬ ì „ ìë™ ë°±ì—…ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>`;
    confirmBtn.className = 'px-6 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-colors';
    confirmBtn.innerHTML = '<i class="fas fa-undo mr-2"></i>ì„ íƒ ë³µêµ¬';

    dbManagementAction = 'partial_restore';
    modal.classList.remove('hidden');
    document.getElementById('db-mgmt-instructor-name').focus();
}

// í…Œì´ë¸” ì„ íƒ ì‚­ì œ
async function resetWithTables(tables) {
    resetSelectedTables = tables;

    const modal = document.getElementById('db-management-modal');
    const header = document.getElementById('db-modal-header');
    const icon = document.getElementById('db-modal-icon');
    const title = document.getElementById('db-modal-title');
    const desc = document.getElementById('db-modal-desc');
    const warning = document.getElementById('db-modal-warning');
    const confirmBtn = document.getElementById('db-modal-confirm-btn');

    document.getElementById('db-mgmt-instructor-name').value = '';
    document.getElementById('db-mgmt-password').value = '';

    header.className = 'p-6 rounded-t-2xl bg-gradient-to-r from-orange-500 to-red-500';
    icon.innerHTML = '<i class="fas fa-list-check text-white"></i>';
    title.textContent = 'í…Œì´ë¸” ì„ íƒ ì‚­ì œ';
    desc.innerHTML = `
        <strong>ì‚­ì œí•  í…Œì´ë¸” (${tables.length}ê°œ):</strong><br>
        <span class="text-sm text-red-600">${tables.join(', ')}</span>
    `;
    warning.classList.remove('hidden');
    warning.innerHTML = `<p class="text-red-800 text-sm"><i class="fas fa-exclamation-triangle mr-1"></i>ì„ íƒí•œ í…Œì´ë¸”ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!</p>`;
    confirmBtn.className = 'px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors';
    confirmBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>ì„ íƒ ì‚­ì œ';

    dbManagementAction = 'partial_reset';
    modal.classList.remove('hidden');
    document.getElementById('db-mgmt-instructor-name').focus();
}

let restoreSelectedTables = [];
let resetSelectedTables = [];

// DB ë³µêµ¬ ê¸°ëŠ¥
let restoreTargetFile = '';

window.restoreBackup = async function(filename) {
    restoreTargetFile = filename;

    // ë³µêµ¬ ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ
    const modal = document.getElementById('db-management-modal');
    const header = document.getElementById('db-modal-header');
    const icon = document.getElementById('db-modal-icon');
    const title = document.getElementById('db-modal-title');
    const desc = document.getElementById('db-modal-desc');
    const warning = document.getElementById('db-modal-warning');
    const confirmBtn = document.getElementById('db-modal-confirm-btn');

    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('db-mgmt-instructor-name').value = '';
    document.getElementById('db-mgmt-password').value = '';

    header.className = 'p-6 rounded-t-2xl bg-gradient-to-r from-green-500 to-green-600';
    icon.innerHTML = '<i class="fas fa-undo text-white"></i>';
    title.textContent = 'DB ë³µêµ¬ ì‹¤í–‰';
    desc.innerHTML = `
        <strong>ë³µêµ¬í•  ë°±ì—… íŒŒì¼:</strong><br>
        <span class="text-green-600 font-mono">${filename}</span><br><br>
        ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³µêµ¬í•˜ë ¤ë©´ ê°•ì‚¬ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
        <span class="text-orange-600">ë³µêµ¬ ì „ì— í˜„ì¬ ìƒíƒœê°€ ìë™ìœ¼ë¡œ ë°±ì—…ë©ë‹ˆë‹¤.</span>
    `;
    warning.classList.remove('hidden');
    warning.innerHTML = `
        <p class="text-yellow-800 text-sm">
            <i class="fas fa-exclamation-circle mr-1"></i>
            <strong>ì£¼ì˜:</strong> DB ë³µêµ¬ëŠ” í˜„ì¬ ë°ì´í„°ë¥¼ ì„ íƒí•œ ë°±ì—… ì‹œì ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
            <br>ë³µêµ¬ í›„ì—ëŠ” ë°±ì—… ì´í›„ì— ì¶”ê°€ëœ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
        </p>
    `;
    confirmBtn.className = 'px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors';
    confirmBtn.innerHTML = '<i class="fas fa-undo mr-2"></i>ë³µêµ¬ ì‹¤í–‰';

    // ë³µêµ¬ ëª¨ë“œë¡œ ì„¤ì •
    dbManagementAction = 'restore';

    modal.classList.remove('hidden');
    document.getElementById('db-mgmt-instructor-name').focus();
};

// executeDbManagement í•¨ìˆ˜ì— ë³µêµ¬ ë¡œì§ ì¶”ê°€ (ê¸°ì¡´ í•¨ìˆ˜ í™•ì¥)
const originalExecuteDbManagement = window.executeDbManagement;
window.executeDbManagement = async function() {
    // ë¶€ë¶„ ë³µêµ¬/ì‚­ì œ ì²˜ë¦¬
    if (dbManagementAction === 'partial_restore' || dbManagementAction === 'partial_reset') {
        const instructorName = document.getElementById('db-mgmt-instructor-name').value.trim();
        const password = document.getElementById('db-mgmt-password').value.trim();

        if (!instructorName || !password) {
            showAlert('ê°•ì‚¬ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        try {
            showLoading('ì¸ì¦ í™•ì¸ ì¤‘...');
            const verifyRes = await axios.post(`${API_BASE_URL}/api/db-management/verify`, {
                instructor_name: instructorName,
                password: password
            });
            hideLoading();

            if (!verifyRes.data.success) {
                showAlert(verifyRes.data.message, 'error');
                return;
            }

            const operatorName = verifyRes.data.instructor_name;
            const operatorCode = verifyRes.data.instructor_code;
            closeDbManagementModal();

            if (dbManagementAction === 'partial_restore') {
                // ì„ íƒ ë³µêµ¬
                const tables = restoreSelectedTables;
                const confirmed = await showConfirm(
                    `ì„ íƒí•œ ${tables.length}ê°œ í…Œì´ë¸”ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                    `í…Œì´ë¸”: ${tables.join(', ')}\n\n` +
                    `ì‘ì—…ì: ${operatorName}`,
                    'í…Œì´ë¸” ì„ íƒ ë³µêµ¬'
                );
                if (!confirmed) return;

                showRestoreProgress();
                try {
                    await new Promise(r => setTimeout(r, 800));
                    updateRestoreProgress('backup', 25, 'ìë™ ë°±ì—… ìƒì„±');

                    const apiPromise = axios.post(`${API_BASE_URL}/api/db-management/restore`, {
                        operator_name: operatorName,
                        instructor_code: operatorCode,
                        backup_file: restoreTargetFile,
                        tables: tables
                    }, { timeout: 180000 });

                    for (let i = 0; i < Math.min(tables.length, 5); i++) {
                        await new Promise(r => setTimeout(r, 400));
                        updateRestoreProgress('restore', 25 + (i * 12), tables[i] + ' ë³µêµ¬');
                    }

                    const response = await apiPromise;
                    updateRestoreProgress('complete', 100);
                    await new Promise(r => setTimeout(r, 500));
                    hideRestoreProgress();

                    if (response.data.success) {
                        await showCompletionScreen('restore', {
                            operator: operatorName,
                            total_restored: response.data.total_restored,
                            backup_file: restoreTargetFile,
                            pre_restore_backup: response.data.pre_restore_backup
                        });
                        location.reload();
                    }
                } catch (err) {
                    hideRestoreProgress();
                    showAlert(err.response?.data?.detail || 'ë³µêµ¬ ì‹¤íŒ¨', 'error');
                }
            } else {
                // ì„ íƒ ì‚­ì œ
                const tables = resetSelectedTables;
                const confirmed = await showConfirm(
                    `ì„ íƒí•œ ${tables.length}ê°œ í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                    `í…Œì´ë¸”: ${tables.join(', ')}\n\n` +
                    `ì‘ì—…ì: ${operatorName}\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`,
                    'í…Œì´ë¸” ì„ íƒ ì‚­ì œ'
                );
                if (!confirmed) return;

                showBackupProgress('reset');
                try {
                    await new Promise(r => setTimeout(r, 800));
                    updateBackupProgress('tables', 30, 'ìë™ ë°±ì—… ìƒì„±');

                    const apiPromise = axios.post(`${API_BASE_URL}/api/db-management/reset`, {
                        operator_name: operatorName,
                        instructor_code: operatorCode,
                        tables: tables
                    }, { timeout: 120000 });

                    for (let i = 0; i < Math.min(tables.length, 5); i++) {
                        await new Promise(r => setTimeout(r, 400));
                        updateBackupProgress('tables', 30 + (i * 12), tables[i] + ' ì‚­ì œ');
                    }

                    const response = await apiPromise;
                    updateBackupProgress('complete', 100);
                    await new Promise(r => setTimeout(r, 500));
                    hideBackupProgress();

                    if (response.data.success) {
                        await showCompletionScreen('reset', {
                            operator: operatorName,
                            total_deleted: response.data.total_deleted,
                            backup_file: response.data.backup_file
                        });
                        location.reload();
                    }
                } catch (err) {
                    hideBackupProgress();
                    showAlert(err.response?.data?.detail || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            }
        } catch (error) {
            hideLoading();
            showAlert(error.response?.data?.detail || 'ì‘ì—… ì‹¤íŒ¨', 'error');
        }
        return;
    }

    if (dbManagementAction === 'restore') {
        const instructorName = document.getElementById('db-mgmt-instructor-name').value.trim();
        const password = document.getElementById('db-mgmt-password').value.trim();

        if (!instructorName || !password) {
            showAlert('ê°•ì‚¬ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        // ì¸ì¦ í™•ì¸
        try {
            showLoading('ì¸ì¦ í™•ì¸ ì¤‘...');
            const verifyRes = await axios.post(`${API_BASE_URL}/api/db-management/verify`, {
                instructor_name: instructorName,
                password: password
            });

            hideLoading();

            if (!verifyRes.data.success) {
                showAlert(verifyRes.data.message, 'error');
                return;
            }

            const operatorName = verifyRes.data.instructor_name;
            const operatorCode = verifyRes.data.instructor_code;

            closeDbManagementModal();

            // ìµœì¢… í™•ì¸
            const confirmed = await showConfirm(
                `ì •ë§ë¡œ "${restoreTargetFile}" íŒŒì¼ë¡œ DBë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                `ì‘ì—…ì: ${operatorName}\n\n` +
                `í˜„ì¬ ë°ì´í„°ëŠ” ìë™ìœ¼ë¡œ ë°±ì—…ë©ë‹ˆë‹¤.`,
                'DB ë³µêµ¬ ìµœì¢… í™•ì¸'
            );

            if (!confirmed) return;

            // ë³µêµ¬ ì§„í–‰ ëª¨ë‹¬ í‘œì‹œ
            showRestoreProgress();

            try {
                await new Promise(resolve => setTimeout(resolve, 800));
                updateRestoreProgress('backup', 25, 'í˜„ì¬ ìƒíƒœ ìë™ ë°±ì—…');

                // API í˜¸ì¶œê³¼ ë™ì‹œì— ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰
                const apiPromise = axios.post(`${API_BASE_URL}/api/db-management/restore`, {
                    operator_name: operatorName,
                    instructor_code: operatorCode,
                    backup_file: restoreTargetFile
                }, { timeout: 180000 });

                // ë‹¨ê³„ë³„ ì• ë‹ˆë©”ì´ì…˜ (ìµœì†Œ ì‹œê°„ ë³´ì¥)
                const steps = ['ë°±ì—… íŒŒì¼ ìƒì„±', 'ê¸°ì¡´ ë°ì´í„° ì •ë¦¬', 'students ë³µêµ¬', 'timetables ë³µêµ¬', 'training_logs ë³µêµ¬'];
                for (let i = 0; i < steps.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    updateRestoreProgress('restore', 25 + (i * 12), steps[i]);
                }

                const response = await apiPromise;

                updateRestoreProgress('complete', 95);
                await new Promise(resolve => setTimeout(resolve, 600));
                updateRestoreProgress('complete', 100);
                await new Promise(resolve => setTimeout(resolve, 500));

                hideRestoreProgress();

                if (response.data.success) {
                    // ì™„ë£Œ í™”ë©´ í‘œì‹œ (2.5ì´ˆ ìœ ì§€)
                    await showCompletionScreen('restore', {
                        operator: operatorName,
                        total_restored: response.data.total_restored,
                        backup_file: restoreTargetFile,
                        pre_restore_backup: response.data.pre_restore_backup
                    });
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ëª¨ë“  ë°ì´í„° ê°±ì‹ )
                    location.reload();
                }
            } catch (restoreError) {
                hideRestoreProgress();
                console.error('ë³µêµ¬ API í˜¸ì¶œ ì‹¤íŒ¨:', restoreError);
                showAlert(restoreError.response?.data?.detail || 'DB ë³µêµ¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            hideLoading();
            console.error('DB ë³µêµ¬ ì‘ì—… ì‹¤íŒ¨:', error);
            showAlert(error.response?.data?.detail || 'DB ë³µêµ¬ ì‘ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    } else {
        // ê¸°ì¡´ backup/reset ë¡œì§ ì‹¤í–‰
        await originalExecuteDbManagement.call(this);
    }
};

// ë³µêµ¬ ì§„í–‰ ìƒí™© ëª¨ë‹¬
function showRestoreProgress() {
    const progressHtml = `
        <div id="restore-progress-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[10000]">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
                <div class="p-6 bg-gradient-to-r from-green-500 to-green-600">
                    <div class="flex items-center gap-4">
                        <div class="text-4xl text-white">
                            <i class="fas fa-undo animate-pulse"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white">DB ë³µêµ¬ ì§„í–‰ ì¤‘</h3>
                    </div>
                </div>
                <div class="p-6">
                    <div id="restore-progress-steps" class="space-y-4">
                        <div id="restore-step-auth" class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                                <i class="fas fa-check"></i>
                            </div>
                            <span class="text-gray-700">ì¸ì¦ ì™„ë£Œ</span>
                        </div>
                        <div id="restore-step-backup" class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <span class="text-gray-700">í˜„ì¬ ìƒíƒœ ë°±ì—… ì¤‘...</span>
                        </div>
                        <div id="restore-step-restore" class="flex items-center gap-3 opacity-50">
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white">
                                <i class="fas fa-database"></i>
                            </div>
                            <span class="text-gray-500">ë°ì´í„° ë³µêµ¬ ì¤‘...</span>
                        </div>
                        <div id="restore-step-complete" class="flex items-center gap-3 opacity-50">
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white">
                                <i class="fas fa-check-double"></i>
                            </div>
                            <span class="text-gray-500">ì™„ë£Œ</span>
                        </div>
                    </div>

                    <!-- ì§„í–‰ ë°” -->
                    <div class="mt-6">
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="restore-progress-bar" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 20%"></div>
                        </div>
                        <p id="restore-progress-text" class="text-center text-sm text-gray-500 mt-2">í˜„ì¬ ìƒíƒœ ë°±ì—… ì¤‘...</p>
                    </div>

                    <!-- í˜„ì¬ ì‘ì—… í‘œì‹œ -->
                    <div id="restore-current-task" class="mt-4 p-3 bg-green-50 rounded-lg text-center">
                        <p class="text-xs text-gray-400">í˜„ì¬ ì‘ì—…</p>
                        <p id="restore-task-name" class="text-sm font-semibold text-green-700">ìë™ ë°±ì—… ìƒì„±</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', progressHtml);
}

function updateRestoreProgress(step, progress, taskName = '') {
    const progressBar = document.getElementById('restore-progress-bar');
    const progressText = document.getElementById('restore-progress-text');
    const taskNameEl = document.getElementById('restore-task-name');

    if (progressBar) progressBar.style.width = `${progress}%`;
    if (taskNameEl && taskName) taskNameEl.textContent = taskName;

    const steps = {
        backup: { text: 'í˜„ì¬ ìƒíƒœ ë°±ì—… ì¤‘...', stepId: 'restore-step-backup' },
        restore: { text: 'ë°ì´í„° ë³µêµ¬ ì¤‘...', stepId: 'restore-step-restore' },
        complete: { text: 'ë³µêµ¬ ì™„ë£Œ!', stepId: 'restore-step-complete' }
    };

    if (steps[step] && progressText) {
        progressText.textContent = steps[step].text;
    }

    // ë‹¨ê³„ë³„ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    if (step === 'restore') {
        const stepBackup = document.getElementById('restore-step-backup');
        if (stepBackup) {
            stepBackup.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <i class="fas fa-check"></i>
                </div>
                <span class="text-gray-700">ë°±ì—… ì™„ë£Œ</span>
            `;
        }
        const stepRestore = document.getElementById('restore-step-restore');
        if (stepRestore) {
            stepRestore.classList.remove('opacity-50');
            stepRestore.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <span class="text-gray-700">ë°ì´í„° ë³µêµ¬ ì¤‘...</span>
            `;
        }
    } else if (step === 'complete') {
        const stepRestore = document.getElementById('restore-step-restore');
        if (stepRestore) {
            stepRestore.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <i class="fas fa-check"></i>
                </div>
                <span class="text-gray-700">ë°ì´í„° ë³µêµ¬ ì™„ë£Œ</span>
            `;
        }
        const stepComplete = document.getElementById('restore-step-complete');
        if (stepComplete) {
            stepComplete.classList.remove('opacity-50');
            stepComplete.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <i class="fas fa-check-double"></i>
                </div>
                <span class="text-gray-700">ì™„ë£Œ!</span>
            `;
        }
    }
}

function hideRestoreProgress() {
    const modal = document.getElementById('restore-progress-modal');
    if (modal) modal.remove();
}

// ==================== Web Speech API ìŒì„± ì¸ì‹ ====================
// ë¸Œë¼ìš°ì € ë‚´ì¥ ìŒì„± ì¸ì‹ (ë¬´ë£Œ, ì„œë²„ ë¶ˆí•„ìš”)

// ìŒì„± ì¸ì‹ ì „ì—­ ê°ì²´
window.speechRecognition = null;
window.isSpeechRecognitionActive = false;

/**
 * ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
 * @returns {Object|null} SpeechRecognition ê°ì²´ ë˜ëŠ” null (ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
 */
window.initSpeechRecognition = function() {
    // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        console.warn('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” Web Speech APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        console.warn('Chrome, Edge, Safarië¥¼ ì‚¬ìš©í•˜ì„¸ìš”. FirefoxëŠ” ì œí•œì ìœ¼ë¡œ ì§€ì›í•©ë‹ˆë‹¤.');
        return null;
    }
    
    // HTTPS í™•ì¸
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        console.warn('âš ï¸ ìŒì„± ì¸ì‹ì€ HTTPS í™˜ê²½ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.');
        console.warn('í˜„ì¬ í”„ë¡œí† ì½œ:', window.location.protocol);
        return null;
    }
    
    // SpeechRecognition ê°ì²´ ìƒì„±
    const recognition = new SpeechRecognition();
    
    // ê¸°ë³¸ ì„¤ì •
    recognition.continuous = false;      // ì—°ì† ì¸ì‹ ë¹„í™œì„±í™” (í•œ ë²ˆë§Œ ì¸ì‹)
    recognition.lang = 'ko-KR';         // í•œêµ­ì–´
    recognition.interimResults = false; // ì¤‘ê°„ ê²°ê³¼ ë¹„í™œì„±í™”
    recognition.maxAlternatives = 1;    // ìµœëŒ€ ëŒ€ì•ˆ 1ê°œë§Œ
    
    console.log('âœ… Web Speech API ì´ˆê¸°í™” ì™„ë£Œ');
    console.log('- ì–¸ì–´: í•œêµ­ì–´ (ko-KR)');
    console.log('- ì—°ì† ì¸ì‹: ë¹„í™œì„±í™”');
    console.log('- HTTPS:', window.location.protocol === 'https:');
    
    return recognition;
};

/**
 * ìŒì„± ì¸ì‹ ì‹œì‘
 * @param {Function} onResult - ì¸ì‹ ê²°ê³¼ë¥¼ ë°›ì„ ì½œë°± í•¨ìˆ˜
 * @param {Function} onError - ì—ëŸ¬ ë°œìƒ ì‹œ ì½œë°± í•¨ìˆ˜
 * @param {Function} onStart - ì¸ì‹ ì‹œì‘ ì‹œ ì½œë°± í•¨ìˆ˜
 * @param {Function} onEnd - ì¸ì‹ ì¢…ë£Œ ì‹œ ì½œë°± í•¨ìˆ˜
 */
window.startSpeechRecognition = function(onResult, onError, onStart, onEnd) {
    // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë‹¨
    if (window.isSpeechRecognitionActive) {
        console.log('âš ï¸ ìŒì„± ì¸ì‹ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.');
        return;
    }
    
    // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
    const recognition = window.initSpeechRecognition();
    if (!recognition) {
        if (onError) {
            onError('ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
        return;
    }
    
    window.speechRecognition = recognition;
    
    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
    recognition.onstart = () => {
        window.isSpeechRecognitionActive = true;
        console.log('ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘...');
        if (onStart) onStart();
    };
    
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const confidence = event.results[0][0].confidence;
        
        console.log('âœ… ì¸ì‹ ê²°ê³¼:', transcript);
        console.log('ì‹ ë¢°ë„:', (confidence * 100).toFixed(1) + '%');
        
        if (onResult) onResult(transcript, confidence);
    };
    
    recognition.onerror = (event) => {
        console.error('âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
        
        let errorMessage = 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        switch (event.error) {
            case 'no-speech':
                errorMessage = 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                break;
            case 'audio-capture':
                errorMessage = 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                break;
            case 'not-allowed':
                errorMessage = 'ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                break;
            case 'network':
                errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                break;
            case 'aborted':
                errorMessage = 'ìŒì„± ì¸ì‹ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
                break;
        }
        
        if (onError) onError(errorMessage);
    };
    
    recognition.onend = () => {
        window.isSpeechRecognitionActive = false;
        console.log('ğŸ¤ ìŒì„± ì¸ì‹ ì¢…ë£Œ');
        if (onEnd) onEnd();
    };
    
    // ìŒì„± ì¸ì‹ ì‹œì‘
    try {
        recognition.start();
    } catch (error) {
        console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:', error);
        window.isSpeechRecognitionActive = false;
        if (onError) onError('ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
};

/**
 * ìŒì„± ì¸ì‹ ì¤‘ì§€
 */
window.stopSpeechRecognition = function() {
    if (window.speechRecognition && window.isSpeechRecognitionActive) {
        window.speechRecognition.stop();
        console.log('ğŸ›‘ ìŒì„± ì¸ì‹ ì¤‘ì§€ë¨');
    }
};

/**
 * ìŒì„± ê²€ìƒ‰ ê¸°ëŠ¥ (ê²€ìƒ‰ì°½ì— ìŒì„±ìœ¼ë¡œ ì…ë ¥)
 * @param {string} inputSelector - ê²€ìƒ‰ ì…ë ¥ í•„ë“œì˜ CSS ì…€ë ‰í„° (ê¸°ë³¸: '#search-input')
 */
window.voiceSearch = function(inputSelector = '#search-input') {
    const searchInput = document.querySelector(inputSelector);
    
    if (!searchInput) {
        console.error('âŒ ê²€ìƒ‰ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', inputSelector);
        showAlert('ê²€ìƒ‰ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    // ìŒì„± ì¸ì‹ ì‹œì‘
    window.startSpeechRecognition(
        // onResult: ì¸ì‹ ì„±ê³µ ì‹œ
        (transcript, confidence) => {
            searchInput.value = transcript;
            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            
            showAlert(`ìŒì„± ì¸ì‹: "${transcript}" (${(confidence * 100).toFixed(0)}%)`, 'success');
        },
        // onError: ì—ëŸ¬ ë°œìƒ ì‹œ
        (errorMessage) => {
            showAlert(errorMessage, 'error');
        },
        // onStart: ì‹œì‘ ì‹œ
        () => {
            searchInput.placeholder = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
            searchInput.classList.add('border-red-500');
        },
        // onEnd: ì¢…ë£Œ ì‹œ
        () => {
            searchInput.placeholder = 'ê²€ìƒ‰...';
            searchInput.classList.remove('border-red-500');
        }
    );
};

/**
 * íŠ¹ì • í•„ë“œì— ìŒì„±ìœ¼ë¡œ ì…ë ¥
 * @param {string} fieldSelector - ì…ë ¥ í•„ë“œì˜ CSS ì…€ë ‰í„°
 */
window.voiceInput = function(fieldSelector) {
    const inputField = document.querySelector(fieldSelector);
    
    if (!inputField) {
        console.error('âŒ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', fieldSelector);
        showAlert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    // ìŒì„± ì¸ì‹ ì‹œì‘
    window.startSpeechRecognition(
        // onResult: ì¸ì‹ ì„±ê³µ ì‹œ
        (transcript) => {
            // ê¸°ì¡´ ê°’ì— ì¶”ê°€ (textarea) ë˜ëŠ” ë®ì–´ì“°ê¸° (input)
            if (inputField.tagName === 'TEXTAREA') {
                const cursorPos = inputField.selectionStart;
                const textBefore = inputField.value.substring(0, cursorPos);
                const textAfter = inputField.value.substring(cursorPos);
                inputField.value = textBefore + transcript + textAfter;
            } else {
                inputField.value = transcript;
            }
            
            inputField.dispatchEvent(new Event('input', { bubbles: true }));
            inputField.focus();
        },
        // onError: ì—ëŸ¬ ë°œìƒ ì‹œ
        (errorMessage) => {
            showAlert(errorMessage, 'error');
        },
        // onStart: ì‹œì‘ ì‹œ
        () => {
            const originalPlaceholder = inputField.placeholder;
            inputField.placeholder = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
            inputField.dataset.originalPlaceholder = originalPlaceholder;
            inputField.classList.add('border-red-500');
        },
        // onEnd: ì¢…ë£Œ ì‹œ
        () => {
            inputField.placeholder = inputField.dataset.originalPlaceholder || '';
            delete inputField.dataset.originalPlaceholder;
            inputField.classList.remove('border-red-500');
        }
    );
};

// ì´ˆê¸°í™” ë¡œê·¸
console.log('âœ… Web Speech API ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');
console.log('ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜:');
console.log('- startSpeechRecognition(onResult, onError, onStart, onEnd)');
console.log('- stopSpeechRecognition()');
console.log('- voiceSearch(inputSelector)');
console.log('- voiceInput(fieldSelector)');
console.log('');
console.log('ì˜ˆì‹œ:');
console.log('  voiceSearch("#search-input")  // ê²€ìƒ‰ì°½ì— ìŒì„± ì…ë ¥');
console.log('  voiceInput("#student-name")   // í•™ìƒ ì´ë¦„ í•„ë“œì— ìŒì„± ì…ë ¥');

// ========================================
// íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
// ========================================

/**
 * íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
 * @param {string} fileUrl - FTP íŒŒì¼ URL
 * @param {string} filename - íŒŒì¼ëª…
 */
window.openFileModal = function(fileUrl, filename) {
    try {
        console.log('ğŸ“‚ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°:', filename, fileUrl);
        
        // íŒŒì¼ í™•ì¥ì ì¶”ì¶œ
        const ext = filename.split('.').pop().toLowerCase();
        
        // ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš°
        if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext)) {
            const downloadUrl = `${API_BASE_URL}/api/download-image?url=${encodeURIComponent(fileUrl)}`;
            
            // ì´ë¯¸ì§€ ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-[90vh] bg-white rounded-lg p-4">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl z-10">
                        âœ•
                    </button>
                    <div class="flex flex-col items-center">
                        <h3 class="text-lg font-bold mb-2">${filename}</h3>
                        <img src="${downloadUrl}" 
                             alt="${filename}" 
                             class="max-w-full max-h-[70vh] object-contain"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3Eì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨%3C/text%3E%3C/svg%3E'">
                        <div class="mt-4 flex gap-2">
                            <button onclick="window.downloadFile('${fileUrl}', '${filename}')" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ESC í‚¤ë¡œ ë‹«ê¸°
            const closeOnEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            document.addEventListener('keydown', closeOnEsc);
            
        } else if (ext === 'pdf') {
            // PDF íŒŒì¼ì¸ ê²½ìš° - ìƒˆ íƒ­ì—ì„œ ì§ì ‘ ì—´ê¸° (ì¸ë„¤ì¼ ì—†ì´)
            const downloadUrl = `${API_BASE_URL}/api/download-image?url=${encodeURIComponent(fileUrl)}`;
            window.open(downloadUrl, '_blank');
            
        } else {
            // ê¸°íƒ€ íŒŒì¼ì€ ë°”ë¡œ ë‹¤ìš´ë¡œë“œ
            window.downloadFile(fileUrl, filename);
        }
        
    } catch (error) {
        console.error('âŒ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨:', error);
        showNotification('íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message, 'error');
    }
};

/**
 * íŒŒì¼ ë‹¤ìš´ë¡œë“œ
 * @param {string} fileUrl - FTP íŒŒì¼ URL
 * @param {string} filename - íŒŒì¼ëª…
 */
window.downloadFile = function(fileUrl, filename) {
    try {
        console.log('ğŸ“¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ:', filename, fileUrl);
        
        const downloadUrl = `${API_BASE_URL}/api/download-image?url=${encodeURIComponent(fileUrl)}`;
        
        // ì„ì‹œ ë§í¬ ìƒì„±í•˜ì—¬ ë‹¤ìš´ë¡œë“œ
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘: ${filename}`, 'success');
        
    } catch (error) {
        console.error('âŒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
        showNotification('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
    }
};

console.log('âœ… íŒŒì¼ ê´€ë¦¬ í•¨ìˆ˜ ë¡œë“œ ì™„ë£Œ');
console.log('- window.openFileModal(url, filename)');
console.log('- window.downloadFile(url, filename)');


// ============================================
// RAG ì‹œìŠ¤í…œ ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ë“¤
// ============================================

/**
 * RAG ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤
 */
window.refreshRAGStatus = async function() {
    try {
        console.log('ğŸ”„ RAG ìƒíƒœ ì¡°íšŒ ì¤‘...');
        
        const response = await fetch(`${API_BASE_URL}/api/rag/status`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('âœ… RAG ìƒíƒœ ì¡°íšŒ ì„±ê³µ:', data);
        
        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        const initStatusElement = document.getElementById('rag-init-status');
        const docCountElement = document.getElementById('rag-doc-count');
        
        if (initStatusElement) {
            if (data.initialized) {
                initStatusElement.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>ì •ìƒ</span>';
            } else {
                initStatusElement.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>ë¯¸ì´ˆê¸°í™”</span>';
            }
        }
        
        if (docCountElement) {
            docCountElement.textContent = `${data.document_count || 0}ê°œ`;
        }
        
        // showNotification('RAG ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        console.log('âœ… RAG ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        
    } catch (error) {
        console.error('âŒ RAG ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', error);
        
        const initStatusElement = document.getElementById('rag-init-status');
        if (initStatusElement) {
            initStatusElement.innerHTML = '<span class="text-gray-500"><i class="fas fa-exclamation-triangle mr-1"></i>ì¡°íšŒ ì‹¤íŒ¨</span>';
        }
        
        // showNotification('RAG ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message, 'error');
        console.error('RAG ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', error.message);
    }
};

console.log('âœ… RAG ì‹œìŠ¤í…œ ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ ë¡œë“œ ì™„ë£Œ');
console.log('- window.refreshRAGStatus()');


// ============================================
// RAG í† ê¸€ ì´ˆê¸°í™”
// ============================================

// í˜ì´ì§€ ë¡œë“œ ì‹œ RAG í† ê¸€ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    const ragToggle = document.getElementById('rag-mode-toggle');
    if (ragToggle) {
        // HTMLì˜ checked ì†ì„± í™•ì¸
        console.log('âœ… RAG í† ê¸€ ì´ˆê¸° ìƒíƒœ:', ragToggle.checked ? 'ON' : 'OFF');
        
        // ëª…ì‹œì ìœ¼ë¡œ checked ì„¤ì •
        ragToggle.checked = true;
        console.log('ğŸ”„ RAG í† ê¸€ì„ ONìœ¼ë¡œ ì„¤ì •');
        
        // í† ê¸€ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        ragToggle.addEventListener('change', function() {
            const status = this.checked ? 'ON (ë¬¸ì„œ ê¸°ë°˜ ë‹µë³€)' : 'OFF (ì¼ë°˜ ëŒ€í™”)';
            console.log('ğŸ”„ RAG ëª¨ë“œ ë³€ê²½:', status);
            // showNotification('RAG ëª¨ë“œ: ' + status, 'info');
        });
    } else {
        console.warn('âš ï¸ RAG í† ê¸€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
});


// ============================================
// API í‚¤ ë°ëª¨ ëª¨ë‹¬ í•¨ìˆ˜ë“¤


// ============================================
// ë¬¸ì„œ ê´€ë¦¬ (ê°•ì˜ ë©”ë‰´)
// ============================================

function renderRAGDocuments() {
    const app = document.getElementById('app');
    
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-file-alt mr-2"></i>ë¬¸ì„œ ê´€ë¦¬ (RAG)
                </h2>
                <div class="flex gap-2">
                    <button onclick="window.showRAGStatus()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-info-circle mr-2"></i>RAG ìƒíƒœ
                    </button>
                    <button onclick="loadDocuments()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
                </button>
            </div>

            <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ (ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì§€ì›) -->
            <div id="drop-zone" class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-8 mb-6 border-2 border-dashed border-blue-300 transition-all hover:border-blue-500 hover:bg-blue-100">
                <div class="text-center">
                    <i class="fas fa-cloud-upload-alt text-6xl text-blue-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">ë¬¸ì„œ ì—…ë¡œë“œ</h3>
                    <p class="text-gray-500 mb-2">íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                    <p class="text-sm text-gray-400 mb-4">PDF, DOCX, PPTX, XLSX, TXT ì§€ì› | ë³µìˆ˜ íŒŒì¼ ê°€ëŠ¥ | ìµœëŒ€ 100MB/íŒŒì¼</p>
                    <input type="file" id="document-file-input" accept=".pdf,.docx,.doc,.txt,.pptx,.ppt,.xlsx,.xls" class="hidden" multiple>
                    <button onclick="document.getElementById('document-file-input').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg">
                        <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                    </button>
                </div>
            </div>

            <!-- ë¬¸ì„œ ëª©ë¡ -->
            <div class="bg-gray-50 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">
                        <i class="fas fa-list mr-2"></i>ë¬¸ì„œ ëª©ë¡ (<span id="document-count">0</span>ê°œ)
                    </h3>
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-database mr-1"></i>
                        RAG ì¸ë±ì‹±: <span id="rag-indexed-count" class="font-semibold text-blue-600">-</span>ê°œ
                    </div>
                </div>
                <div id="documents-list" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-4xl mb-2"></i>
                        <p>ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
    const dropZone = document.getElementById('drop-zone');
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-500', 'bg-blue-100');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-100');
    });
    
    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-100');
        
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            await handleMultipleFiles(files);
        }
    });

    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ (ë³µìˆ˜ íŒŒì¼ ì§€ì›)
    document.getElementById('document-file-input').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            await handleMultipleFiles(files);
        }
        // íŒŒì¼ input ì´ˆê¸°í™”
        e.target.value = '';
    });

    // ë¬¸ì„œ ëª©ë¡ ë¡œë“œ
    loadDocuments();
}

// ë³µìˆ˜ íŒŒì¼ ì²˜ë¦¬
async function handleMultipleFiles(files) {
    if (files.length === 0) return;
    
    // ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸° ì²´í¬ í™•ì¸
    const hideRAGWarning = localStorage.getItem('hideRAGWarning');
    const hideUntil = localStorage.getItem('hideRAGWarningUntil');
    const now = new Date().getTime();
    
    let showWarning = true;
    if (hideRAGWarning === 'true' && hideUntil && parseInt(hideUntil) > now) {
        showWarning = false;
    }
    
    // AI í•™ìŠµ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
    if (showWarning) {
        const warningHtml = `
            <div class="text-left space-y-3">
                <p class="text-yellow-600 font-semibold text-base">âš ï¸ ì¤‘ìš” ì•ˆë‚´</p>
                <p class="text-gray-700">RAG ì‹œìŠ¤í…œì€ <span class="font-bold text-red-600">AI í•™ìŠµ ê³¼ì •</span>ì´ í¬í•¨ë˜ì–´ ìˆì–´ <span class="font-bold">ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤</span>.</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 ml-2">
                    <li>ë¬¸ì„œ í¬ê¸°ì— ë”°ë¼ <span class="font-semibold">1~5ë¶„</span> ì†Œìš”ë©ë‹ˆë‹¤</li>
                    <li>ì²˜ë¦¬ ì¤‘ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì§€ ë§ˆì„¸ìš”</li>
                    <li>ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</li>
                </ul>
                <label class="flex items-center space-x-2 text-sm text-gray-600 cursor-pointer mt-4 p-2 bg-gray-100 rounded">
                    <input type="checkbox" id="dont-show-today" class="form-checkbox h-4 w-4 text-blue-600">
                    <span>ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸°</span>
                </label>
            </div>
        `;
        
        const proceed = await window.showCustomConfirm(warningHtml, 'RAG ì²˜ë¦¬ ì•ˆë‚´', 'ê³„ì†í•˜ê¸°', 'ì·¨ì†Œ');
        
        if (!proceed) {
            return;
        }
        
        // ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸° ì²´í¬ í™•ì¸
        const dontShowCheckbox = document.getElementById('dont-show-today');
        if (dontShowCheckbox && dontShowCheckbox.checked) {
            const tomorrow = new Date();
            tomorrow.setHours(24, 0, 0, 0); // ë‹¤ìŒë‚  ìì •
            localStorage.setItem('hideRAGWarning', 'true');
            localStorage.setItem('hideRAGWarningUntil', tomorrow.getTime().toString());
        }
    }
    
    // RAG ì¸ë±ì‹± ì—¬ë¶€ í™•ì¸
    const useRAG = await window.showCustomConfirm(
        `ğŸ“š ${files.length}ê°œ íŒŒì¼ì„ RAG ì‹œìŠ¤í…œì— ì¸ë±ì‹±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâœ… ì˜ˆ: ë¬¸ì„œ ë‚´ìš©ì„ í•™ìŠµí•˜ê³  ì§ˆë¬¸ì— ë‹µë³€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\nâŒ ì•„ë‹ˆì˜¤: ë‹¨ìˆœíˆ íŒŒì¼ë§Œ ì €ì¥í•©ë‹ˆë‹¤`,
        'RAG ì¸ë±ì‹±',
        'ì˜ˆ',
        'ì•„ë‹ˆì˜¤'
    );
    
    let successCount = 0;
    let failCount = 0;
    
    window.showLoading(`íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (0/${files.length})`);
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        try {
            window.showLoading(`íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${i + 1}/${files.length})\n${file.name}`);
            
            if (useRAG) {
                await processRAGDocument(file, false); // ê°œë³„ ì•Œë¦¼ ë¹„í™œì„±í™”
            } else {
                await uploadDocument(file, false); // ê°œë³„ ì•Œë¦¼ ë¹„í™œì„±í™”
            }
            
            successCount++;
        } catch (error) {
            console.error(`íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${file.name}`, error);
            failCount++;
        }
    }
    
    window.hideLoading();
    
    // ìµœì¢… ê²°ê³¼ í‘œì‹œ
    const message = `âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${successCount}ê°œ\n${failCount > 0 ? `âŒ ì‹¤íŒ¨: ${failCount}ê°œ` : ''}`;
    await window.showCustomAlert(message, successCount > 0 ? 'success' : 'error', 'ì—…ë¡œë“œ ê²°ê³¼');
    
    // ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    loadDocuments();
}

// RAG ìƒíƒœ ëª¨ë‹¬ í‘œì‹œ
window.showRAGStatus = async function() {
    try {
        window.showLoading('RAG ìƒíƒœ ì¡°íšŒ ì¤‘...');
        
        // RAG ìƒíƒœ API í˜¸ì¶œ
        const statusResponse = await axios.get(`${API_BASE_URL}/api/rag/status`);
        const ragStatus = statusResponse.data;
        
        // ë¬¸ì„œ ëª©ë¡ API í˜¸ì¶œ
        const docsResponse = await axios.get(`${API_BASE_URL}/api/rag/documents`);
        const ragDocs = docsResponse.data.documents || [];
        
        window.hideLoading();
        
        // ëª¨ë‹¬ HTML ìƒì„±
        const modalHtml = `
            <div id="rag-status-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s;">
                <div style="background: white; border-radius: 20px; padding: 30px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 20px; font-weight: 700; color: #1f2937;">
                            <i class="fas fa-database" style="color: #8b5cf6; margin-right: 8px;"></i>
                            RAG ì‹œìŠ¤í…œ ìƒíƒœ
                        </h3>
                        <button onclick="document.getElementById('rag-status-modal').remove()" style="background: #f3f4f6; border: none; color: #6b7280; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
                    <div style="background: ${ragStatus.initialized ? '#f0fdf4' : '#fef2f2'}; border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 2px solid ${ragStatus.initialized ? '#86efac' : '#fca5a5'};">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: ${ragStatus.initialized ? '#22c55e' : '#ef4444'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                <i class="fas fa-${ragStatus.initialized ? 'check-circle' : 'times-circle'}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">
                                    ${ragStatus.initialized ? 'âœ… ì‹œìŠ¤í…œ ì •ìƒ' : 'âŒ ì‹œìŠ¤í…œ ë¯¸ì´ˆê¸°í™”'}
                                </div>
                                <div style="font-size: 13px; color: #6b7280;">
                                    ${ragStatus.initialized ? 'RAG ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤' : 'RAG ì‹œìŠ¤í…œ ì´ˆê¸°í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í†µê³„ ì •ë³´ -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="background: #f9fafb; border-radius: 10px; padding: 16px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“„ ì´ ë¬¸ì„œ ìˆ˜</div>
                            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">${ragStatus.document_count || 0}</div>
                        </div>
                        <div style="background: #f9fafb; border-radius: 10px; padding: 16px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ”¢ ì´ ì²­í¬ ìˆ˜</div>
                            <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;">${ragStatus.total_chunks || 0}</div>
                        </div>
                    </div>
                    
                    <!-- ì¸ë±ì‹±ëœ ë¬¸ì„œ ëª©ë¡ -->
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-list-check" style="color: #8b5cf6;"></i>
                            ì¸ë±ì‹±ëœ ë¬¸ì„œ (${ragDocs.length}ê°œ)
                        </div>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                            ${ragDocs.length > 0 ? ragDocs.map(doc => `
                                <div style="padding: 12px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                    <div style="font-size: 24px;">ğŸ“„</div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; color: #1f2937; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.filename}</div>
                                        <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                                            ì²­í¬: ${doc.chunk_count || 0}ê°œ â€¢ ${new Date(doc.upload_date).toLocaleDateString('ko-KR')}
                                        </div>
                                    </div>
                                    <div style="background: #eff6ff; color: #3b82f6; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">
                                        ì¸ë±ì‹±ë¨
                                    </div>
                                </div>
                            `).join('') : `
                                <div style="padding: 40px; text-align: center; color: #9ca3af;">
                                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                                    <div>ì¸ë±ì‹±ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
                    <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px 16px; border-radius: 8px; font-size: 13px; color: #1e40af;">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•  ë•Œ "ì˜ˆ"ë¥¼ ì„ íƒí•˜ë©´ RAG ì‹œìŠ¤í…œì— ìë™ ì¸ë±ì‹±ë©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        window.hideLoading();
        console.error('âŒ RAG ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', error);
        await window.showCustomAlert('RAG ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error', 'RAG ìƒíƒœ');
    }
};

async function uploadDocument(file, showAlert = true) {
    try {
        const maxSize = 100 * 1024 * 1024; // 100MB
        if (file.size > maxSize) {
            if (showAlert) {
                await window.showCustomAlert('íŒŒì¼ í¬ê¸°ëŠ” 100MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤', 'error');
            }
            throw new Error('íŒŒì¼ í¬ê¸° ì´ˆê³¼');
        }

        if (showAlert) {
            window.showLoading('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('category', 'general');

        const response = await axios.post(`${API_BASE_URL}/api/documents/upload`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' }
        });

        if (showAlert) {
            window.hideLoading();
        }

        if (response.data.success) {
            if (showAlert) {
                await window.showCustomAlert('âœ… ë¬¸ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                loadDocuments();
            }
            return response.data;
        }
    } catch (error) {
        if (showAlert) {
            window.hideLoading();
        }
        console.error('ë¬¸ì„œ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        if (showAlert) {
            await window.showCustomAlert('ë¬¸ì„œ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
        }
        throw error;
    }
}

async function loadDocuments() {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/documents/list`);
        const documents = response.data.documents || [];

        document.getElementById('document-count').textContent = documents.length;
        
        // RAG ì¸ë±ì‹±ëœ ë¬¸ì„œ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        try {
            const ragResponse = await axios.get(`${API_BASE_URL}/api/rag/documents`);
            const ragDocs = ragResponse.data.documents || [];
            const ragIndexedCount = document.getElementById('rag-indexed-count');
            if (ragIndexedCount) {
                ragIndexedCount.textContent = ragDocs.length;
            }
        } catch (ragError) {
            console.warn('RAG ë¬¸ì„œ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', ragError);
        }

        const listDiv = document.getElementById('documents-list');

        if (documents.length === 0) {
            listDiv.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-folder-open text-4xl mb-2"></i>
                    <p>ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            `;
            return;
        }

        // RAG ì¸ë±ì‹± ìƒíƒœ í™•ì¸ì„ ìœ„í•œ ë¬¸ì„œ ëª©ë¡
        let ragDocNames = [];
        try {
            const ragResponse = await axios.get(`${API_BASE_URL}/api/rag/documents`);
            ragDocNames = (ragResponse.data.documents || []).map(d => d.filename);
        } catch (ragError) {
            console.warn('RAG ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', ragError);
        }

        listDiv.innerHTML = documents.map(doc => {
            const isIndexed = ragDocNames.includes(doc.filename);
            const folderBadge = doc.folder === 'rag_documents' 
                ? '<span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full font-semibold ml-2"><i class="fas fa-brain mr-1"></i>RAG</span>' 
                : '';
            return `
            <div class="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        <i class="fas fa-file-${getFileIcon(doc.extension)} text-3xl ${doc.folder === 'rag_documents' ? 'text-purple-500' : 'text-blue-500'} mr-4"></i>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h4 class="font-semibold text-gray-800">${doc.filename}</h4>
                                ${folderBadge}
                                ${isIndexed ? '<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-semibold"><i class="fas fa-check-circle mr-1"></i>ì¸ë±ì‹±ë¨</span>' : '<span class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded-full"><i class="fas fa-circle mr-1"></i>ë¯¸ì¸ë±ì‹±</span>'}
                            </div>
                            <p class="text-sm text-gray-500">
                                ${doc.file_size_mb} MB Â· ${new Date(doc.modified_at).toLocaleString('ko-KR')}
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="askDocument('${doc.filename}')" 
                                class="text-purple-600 hover:text-purple-800 px-3 py-1 rounded bg-purple-50 hover:bg-purple-100 transition-colors"
                                title="ì´ ë¬¸ì„œì— ì§ˆë¬¸í•˜ê¸°">
                            <i class="fas fa-comments mr-1"></i>ì§ˆë¬¸í•˜ê¸°
                        </button>
                        <a href="${API_BASE_URL}/api/documents/download/${encodeURIComponent(doc.filename)}" 
                           class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded bg-blue-50 hover:bg-blue-100 transition-colors"
                           download
                           title="ë‹¤ìš´ë¡œë“œ">
                            <i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ
                        </a>
                        <button onclick="deleteDocument('${doc.filename}')" 
                                class="text-red-600 hover:text-red-800 px-3 py-1 rounded bg-red-50 hover:bg-red-100 transition-colors"
                                title="ì‚­ì œ">
                            <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                        </button>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    } catch (error) {
        console.error('ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('documents-list').innerHTML = `
            <div class="text-center text-red-500 py-8">
                <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                <p>ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</p>
            </div>
        `;
    }
}

async function deleteDocument(filename) {
    const confirmed = await window.showCustomConfirm(
        `ë¬¸ì„œ "${filename}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
        'ë¬¸ì„œ ì‚­ì œ'
    );
    
    if (!confirmed) {
        return;
    }

    try {
        window.showLoading('ë¬¸ì„œ ì‚­ì œ ì¤‘...');
        await axios.delete(`${API_BASE_URL}/api/documents/${encodeURIComponent(filename)}`);
        window.hideLoading();
        await window.showCustomAlert('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        loadDocuments();
    } catch (error) {
        window.hideLoading();
        console.error('ë¬¸ì„œ ì‚­ì œ ì‹¤íŒ¨:', error);
        await window.showCustomAlert('ë¬¸ì„œ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ============================================
// RAG ë¬¸ì„œ ì²˜ë¦¬ ëª¨ë‹¬ with ì• ë‹ˆë©”ì´ì…˜
// ============================================

function showRAGProcessingModal() {
    const modalHtml = `
        <div id="rag-processing-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" style="backdrop-filter: blur(8px);">
            <div class="bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-900 rounded-3xl shadow-2xl p-8 max-w-4xl w-full mx-4 relative overflow-hidden">
                <!-- ë‹«ê¸° ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨) -->
                <button onclick="closeRAGProcessingModal()" class="absolute top-4 right-4 z-20 bg-white/20 hover:bg-white/30 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all" title="ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì²˜ë¦¬ë©ë‹ˆë‹¤">
                    <i class="fas fa-times text-xl"></i>
                </button>

                <!-- ë°°ê²½ ê·¸ë¦¬ë“œ íš¨ê³¼ -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute inset-0" style="background-image: linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px); background-size: 50px 50px;"></div>
                </div>

                <!-- ìƒë‹¨ íƒ€ì´í‹€ (ë§¥ë™ ì• ë‹ˆë©”ì´ì…˜) -->
                <div id="rag-modal-title" class="text-center mb-8 relative z-10">
                    <h2 class="text-3xl font-bold text-white mb-2" style="animation: pulse 2s ease-in-out infinite;">
                        <i class="fas fa-brain mr-3"></i>ë¬¸ì„œ ì²˜ë¦¬ ì¤‘...
                    </h2>
                    <p id="rag-filename-display" class="text-yellow-300 text-base font-semibold mb-2"></p>
                    <p class="text-blue-200 text-sm">RAG ì‹œìŠ¤í…œì´ AI í•™ìŠµì„ ìœ„í•´ ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤ (ì‹œê°„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)</p>
                </div>
                
                <!-- ì¤‘ì•™ ê·¸ë˜í”½ ì˜ì—­ -->
                <div class="bg-black bg-opacity-30 rounded-2xl p-8 mb-6 relative" style="min-height: 400px;">
                    <!-- Parsing Stage -->
                    <div id="stage-parsing" class="stage-container hidden">
                        <div class="flex items-center justify-center space-x-8 h-full">
                            <div class="document-icon" style="animation: float 3s ease-in-out infinite;">
                                <i class="fas fa-file-pdf text-8xl text-red-400"></i>
                            </div>
                            <div class="light-beam-container">
                                <div class="light-beam"></div>
                                <div class="light-beam" style="animation-delay: 0.3s;"></div>
                                <div class="light-beam" style="animation-delay: 0.6s;"></div>
                            </div>
                            <div class="text-layers">
                                <div class="text-layer" style="animation-delay: 0s;">
                                    <i class="fas fa-align-left text-4xl text-blue-300"></i>
                                </div>
                                <div class="text-layer" style="animation-delay: 0.2s;">
                                    <i class="fas fa-align-center text-4xl text-blue-400"></i>
                                </div>
                                <div class="text-layer" style="animation-delay: 0.4s;">
                                    <i class="fas fa-align-right text-4xl text-blue-500"></i>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <p class="text-xl text-blue-300 font-semibold">ğŸ“„ Parsing: ë¬¸ì„œ êµ¬ì¡° ë¶„ì„</p>
                            <p class="text-sm text-gray-400 mt-2">í…ìŠ¤íŠ¸ë¥¼ ë ˆì´ì–´ë³„ë¡œ ë¶„ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                    </div>
                    
                    <!-- Chunking Stage -->
                    <div id="stage-chunking" class="stage-container hidden">
                        <div class="flex items-center justify-center h-full">
                            <div class="chunks-container">
                                <div class="chunk-block" style="animation-delay: 0s;"><i class="fas fa-cube text-3xl text-purple-400"></i></div>
                                <div class="chunk-block" style="animation-delay: 0.2s;"><i class="fas fa-cube text-3xl text-purple-500"></i></div>
                                <div class="chunk-block" style="animation-delay: 0.4s;"><i class="fas fa-cube text-3xl text-purple-600"></i></div>
                                <div class="chunk-block" style="animation-delay: 0.6s;"><i class="fas fa-cube text-3xl text-indigo-400"></i></div>
                                <div class="chunk-block" style="animation-delay: 0.8s;"><i class="fas fa-cube text-3xl text-indigo-500"></i></div>
                                <div class="chunk-block" style="animation-delay: 1.0s;"><i class="fas fa-cube text-3xl text-indigo-600"></i></div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <p class="text-xl text-purple-300 font-semibold">ğŸ§© Chunking: ì˜ë¯¸ ë‹¨ìœ„ ë¶„í• </p>
                            <p class="text-sm text-gray-400 mt-2">í…ìŠ¤íŠ¸ë¥¼ ìµœì  í¬ê¸°ë¡œ ë‚˜ëˆ„ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                    </div>
                    
                    <!-- Embedding Stage -->
                    <div id="stage-embedding" class="stage-container hidden">
                        <div class="flex items-center justify-center h-full">
                            <div class="code-stream-container">
                                <div class="code-stream">
                                    <span class="binary-code">01001000</span>
                                    <span class="binary-code">01100101</span>
                                    <span class="binary-code">01101100</span>
                                    <span class="binary-code">01101100</span>
                                    <span class="binary-code">01101111</span>
                                </div>
                                <div class="code-stream" style="animation-delay: 0.3s;">
                                    <span class="binary-code">01010111</span>
                                    <span class="binary-code">01101111</span>
                                    <span class="binary-code">01110010</span>
                                    <span class="binary-code">01101100</span>
                                    <span class="binary-code">01100100</span>
                                </div>
                                <div class="code-stream" style="animation-delay: 0.6s;">
                                    <span class="binary-code">01000001</span>
                                    <span class="binary-code">01001001</span>
                                    <span class="binary-code">00100000</span>
                                    <span class="binary-code">01010010</span>
                                    <span class="binary-code">01000001</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <p class="text-xl text-cyan-300 font-semibold">ğŸ”¢ Embedding: ë²¡í„° ë³€í™˜</p>
                            <p class="text-sm text-gray-400 mt-2">ì˜ë¯¸ë¥¼ ìˆ˜ì¹˜ ë²¡í„°ë¡œ ì¸ì½”ë”©í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                    </div>
                    
                    <!-- Indexing Stage -->
                    <div id="stage-indexing" class="stage-container hidden">
                        <div class="flex items-center justify-center h-full">
                            <div class="vector-space">
                                <div class="grid-line horizontal" style="animation-delay: 0s;"></div>
                                <div class="grid-line horizontal" style="animation-delay: 0.1s;"></div>
                                <div class="grid-line horizontal" style="animation-delay: 0.2s;"></div>
                                <div class="grid-line vertical" style="animation-delay: 0.3s;"></div>
                                <div class="grid-line vertical" style="animation-delay: 0.4s;"></div>
                                <div class="grid-line vertical" style="animation-delay: 0.5s;"></div>
                                <div class="vector-point" style="top: 30%; left: 40%; animation-delay: 0.6s;"></div>
                                <div class="vector-point" style="top: 50%; left: 60%; animation-delay: 0.8s;"></div>
                                <div class="vector-point" style="top: 70%; left: 30%; animation-delay: 1.0s;"></div>
                                <div class="vector-point" style="top: 40%; left: 70%; animation-delay: 1.2s;"></div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <p class="text-xl text-green-300 font-semibold">ğŸ—‚ï¸ Indexing: ë²¡í„° ê³µê°„ì— ì €ì¥</p>
                            <p class="text-sm text-gray-400 mt-2">ë‹¤ì°¨ì› ì¸ë±ìŠ¤ì— ì •ì°©ì‹œí‚¤ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                    </div>
                </div>
                
                <!-- í•˜ë‹¨ ìƒíƒœ í‘œì‹œ -->
                <div class="bg-black bg-opacity-50 rounded-xl p-4 relative z-10">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm text-gray-300">ì§„í–‰ ìƒíƒœ:</span>
                        <span id="rag-progress-percentage" class="text-sm font-bold text-green-400">0%</span>
                    </div>
                    <div class="bg-gray-700 rounded-full h-3 mb-3 overflow-hidden">
                        <div id="rag-progress-bar" class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 h-full transition-all duration-500" style="width: 0%; animation: shimmer 2s infinite;"></div>
                    </div>
                    <p id="rag-status-text" class="text-center text-sm text-blue-200">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i>ë¬¸ì„œ ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...
                    </p>
                </div>
            </div>
        </div>
        
        <style>
            @keyframes pulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.8; transform: scale(1.05); }
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-20px); }
            }
            
            @keyframes lightBeam {
                0% { opacity: 0; transform: scaleX(0); }
                50% { opacity: 1; transform: scaleX(1); }
                100% { opacity: 0; transform: scaleX(1.2); }
            }
            
            @keyframes layerSeparate {
                0% { transform: translateX(0); opacity: 0; }
                50% { opacity: 1; }
                100% { transform: translateX(50px); opacity: 1; }
            }
            
            @keyframes chunkFloat {
                0%, 100% { transform: translateY(0) rotate(0deg); }
                25% { transform: translateY(-30px) rotate(90deg); }
                50% { transform: translateY(-20px) rotate(180deg); }
                75% { transform: translateY(-40px) rotate(270deg); }
            }
            
            @keyframes codeFlow {
                0% { transform: translateX(-100%) translateY(0); opacity: 0; }
                50% { opacity: 1; }
                100% { transform: translateX(200%) translateY(-100px); opacity: 0; }
            }
            
            @keyframes gridAppear {
                0% { opacity: 0; transform: scaleX(0); }
                100% { opacity: 1; transform: scaleX(1); }
            }
            
            @keyframes pointSettle {
                0% { opacity: 0; transform: scale(0) rotate(0deg); }
                50% { opacity: 1; transform: scale(1.5) rotate(180deg); }
                100% { opacity: 1; transform: scale(1) rotate(360deg); }
            }
            
            @keyframes shimmer {
                0% { background-position: -1000px 0; }
                100% { background-position: 1000px 0; }
            }
            
            .stage-container { position: absolute; inset: 0; }
            
            .light-beam-container { display: flex; flex-direction: column; gap: 10px; }
            .light-beam {
                width: 100px; height: 4px;
                background: linear-gradient(90deg, transparent, #60a5fa, transparent);
                animation: lightBeam 1.5s ease-in-out infinite;
            }
            
            .text-layers { display: flex; flex-direction: column; gap: 15px; }
            .text-layer { animation: layerSeparate 2s ease-out forwards; }
            
            .chunks-container {
                display: grid; grid-template-columns: repeat(3, 1fr);
                gap: 30px; max-width: 400px;
            }
            .chunk-block { animation: chunkFloat 4s ease-in-out infinite; }
            
            .code-stream-container { display: flex; flex-direction: column; gap: 20px; width: 100%; }
            .code-stream {
                display: flex; gap: 10px;
                animation: codeFlow 3s linear infinite;
            }
            .binary-code {
                font-family: 'Courier New', monospace;
                font-size: 20px; color: #22d3ee;
                text-shadow: 0 0 10px #22d3ee;
            }
            
            .vector-space {
                position: relative; width: 400px; height: 300px;
                border: 2px solid rgba(52, 211, 153, 0.3);
                border-radius: 10px;
            }
            .grid-line {
                position: absolute;
                background: rgba(52, 211, 153, 0.5);
            }
            .grid-line.horizontal {
                width: 100%; height: 2px;
                animation: gridAppear 1s ease-out forwards;
            }
            .grid-line.vertical {
                width: 2px; height: 100%;
                animation: gridAppear 1s ease-out forwards;
            }
            .vector-point {
                position: absolute; width: 15px; height: 15px;
                background: radial-gradient(circle, #34d399, #10b981);
                border-radius: 50%;
                box-shadow: 0 0 20px #34d399;
                animation: pointSettle 2s ease-out forwards;
            }
        </style>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function hideRAGProcessingModal() {
    const modal = document.getElementById('rag-processing-modal');
    if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.5s ease';
        setTimeout(() => modal.remove(), 500);
    }
}

// ì‚¬ìš©ìê°€ ì§ì ‘ ë‹«ê¸° ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš° - ë°±ê·¸ë¼ìš´ë“œ ê³„ì† ì²˜ë¦¬
function closeRAGProcessingModal() {
    const modal = document.getElementById('rag-processing-modal');
    if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
            modal.remove();
            window.showCustomAlert('ë¬¸ì„œ ì²˜ë¦¬ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì†ë©ë‹ˆë‹¤. ì™„ë£Œë˜ë©´ ëª©ë¡ì— í‘œì‹œë©ë‹ˆë‹¤.', 'info');
        }, 300);
    }
}

async function processRAGDocument(file) {
    // ë°ì´í„° ë¡œë”© ëª¨ë‹¬ ìˆ¨ê¸°ê¸° (ìˆë‹¤ë©´)
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
    }
    
    // RAG ì²˜ë¦¬ ëª¨ë‹¬ í‘œì‹œ
    showRAGProcessingModal();
    
    // íŒŒì¼ ì´ë¦„ í‘œì‹œ
    const filenameDisplay = document.getElementById('rag-filename-display');
    if (filenameDisplay) {
        filenameDisplay.textContent = `ğŸ“„ ${file.name}`;
    }
    
    const stages = ['parsing', 'chunking', 'embedding', 'indexing'];
    const stageMessages = {
        parsing: 'ğŸ“„ ë¬¸ì„œ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ê³  í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...',
        chunking: 'ğŸ§© í…ìŠ¤íŠ¸ë¥¼ ì˜ë¯¸ ìˆëŠ” ë‹¨ìœ„ë¡œ ë¶„í• í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
        embedding: 'ğŸ”¢ ê° ì¡°ê°ì„ ë²¡í„°ë¡œ ë³€í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
        indexing: 'ğŸ—‚ï¸ ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...'
    };
    
    let currentStage = 0;
    let stageInterval = null;
    let isProcessing = true;
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì´ˆê¸°í™” (0%ë¶€í„° ì‹œì‘)
    const progressBar = document.getElementById('rag-progress-bar');
    const progressPercent = document.getElementById('rag-progress-percentage');
    if (progressBar) progressBar.style.width = '0%';
    if (progressPercent) progressPercent.textContent = '0%';
    
    // ìŠ¤í…Œì´ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    const updateStage = () => {
        // ë§ˆì§€ë§‰ ë‹¨ê³„ë¥¼ ë„˜ì–´ê°€ë©´ ë” ì´ìƒ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
        if (currentStage >= stages.length) {
            return;
        }
        
        // ëª¨ë“  ìŠ¤í…Œì´ì§€ ìˆ¨ê¸°ê¸°
        stages.forEach(s => {
            const el = document.getElementById(`stage-${s}`);
            if (el) el.classList.add('hidden');
        });
        
        // í˜„ì¬ ìŠ¤í…Œì´ì§€ í‘œì‹œ
        const stageName = stages[currentStage];
        const el = document.getElementById(`stage-${stageName}`);
        if (el) el.classList.remove('hidden');
        
        const statusText = document.getElementById('rag-status-text');
        if (statusText) {
            statusText.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-2"></i>${stageMessages[stageName]}`;
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸ (ì‹¤ì œ ì§„í–‰ ìƒí™©ì„ ë°˜ì˜í•˜ë˜, 90%ê¹Œì§€ë§Œ)
        const progress = Math.min(((currentStage + 1) / stages.length) * 90, 90);
        if (progressBar) progressBar.style.width = `${progress}%`;
        if (progressPercent) progressPercent.textContent = `${Math.round(progress)}%`;
        
        // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ
        currentStage++;
    };
    
    // ìŠ¤í…Œì´ì§€ ì´ë¦„ì„ ë°±ì—”ë“œ ìƒíƒœì— ë§¤í•‘
    const backendStageMap = {
        'pending': 0,
        'parsing': 1,    // parsing + chunking
        'embedding': 2,  // embedding + indexing
        'completed': 4,
        'failed': -1
    };

    // ì²« ë²ˆì§¸ ìŠ¤í…Œì´ì§€ë¥¼ ì¦‰ì‹œ í‘œì‹œ
    updateStage();

    try {
        // 1ë‹¨ê³„: íŒŒì¼ ì—…ë¡œë“œ (ë¬¸ì„œ ì €ì¥ì†Œ)
        const formData = new FormData();
        formData.append('file', file);
        formData.append('category', 'rag-indexed');

        const response = await axios.post(`${API_BASE_URL}/api/documents/upload`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' }
        });

        if (!response.data.success) {
            throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
        }

        const filename = response.data.filename;

        // 2ë‹¨ê³„: RAG ì¸ë±ì‹± ìš”ì²­ (ì¦‰ì‹œ ë°˜í™˜)
        const indexRes = await axios.post(`${API_BASE_URL}/api/rag/index-document`, {
            filename: filename,
            original_filename: response.data.original_filename
        });

        const taskId = indexRes.data.task_id;

        if (!taskId) {
            // task_idê°€ ì—†ìœ¼ë©´ ì´ë¯¸ ë™ê¸°ì ìœ¼ë¡œ ì™„ë£Œëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬
            isProcessing = false;
            if (stageInterval) clearInterval(stageInterval);

            const statusText = document.getElementById('rag-status-text');
            if (statusText) {
                statusText.innerHTML = '<i class="fas fa-check-circle mr-2 text-green-400"></i>âœ¨ ë¬¸ì„œ ì²˜ë¦¬ ì™„ë£Œ! ì´ì œ ì´ ë¬¸ì„œë¡œ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            if (progressBar) progressBar.style.width = '100%';
            if (progressPercent) progressPercent.textContent = '100%';

            setTimeout(async () => {
                hideRAGProcessingModal();
                await window.showCustomAlert('âœ¨ ë¬¸ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ê³  RAG ì‹œìŠ¤í…œì— ì¸ë±ì‹±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                loadDocuments();
            }, 2000);
            return;
        }

        // 3ë‹¨ê³„: ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ ìƒíƒœ í´ë§
        stageInterval = setInterval(async () => {
            try {
                const statusRes = await fetch(`${API_BASE_URL}/api/rag/task-status/${taskId}`);
                if (!statusRes.ok) return;
                const taskStatus = await statusRes.json();

                const targetStage = backendStageMap[taskStatus.status];

                if (taskStatus.status === 'parsing') {
                    // parsing ë‹¨ê³„: stage 0(parsing) â†’ stage 1(chunking) ìˆœì°¨ í‘œì‹œ
                    if (currentStage < 2) {
                        updateStage();
                    }
                } else if (taskStatus.status === 'embedding') {
                    // embedding ë‹¨ê³„: stage 2(embedding) â†’ stage 3(indexing) ìˆœì°¨ í‘œì‹œ
                    while (currentStage < 4) {
                        updateStage();
                    }
                } else if (taskStatus.status === 'completed') {
                    clearInterval(stageInterval);
                    isProcessing = false;

                    // ëª¨ë“  ìŠ¤í…Œì´ì§€ ì™„ë£Œ í‘œì‹œ
                    while (currentStage < stages.length) {
                        updateStage();
                    }

                    const statusText = document.getElementById('rag-status-text');
                    if (statusText) {
                        statusText.innerHTML = '<i class="fas fa-check-circle mr-2 text-green-400"></i>âœ¨ ë¬¸ì„œ ì²˜ë¦¬ ì™„ë£Œ! ì´ì œ ì´ ë¬¸ì„œë¡œ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    }
                    if (progressBar) progressBar.style.width = '100%';
                    if (progressPercent) progressPercent.textContent = '100%';

                    setTimeout(async () => {
                        hideRAGProcessingModal();
                        await window.showCustomAlert('âœ¨ ë¬¸ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ê³  RAG ì‹œìŠ¤í…œì— ì¸ë±ì‹±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        loadDocuments();
                    }, 2000);

                } else if (taskStatus.status === 'failed') {
                    clearInterval(stageInterval);
                    isProcessing = false;

                    const statusText = document.getElementById('rag-status-text');
                    if (statusText) {
                        statusText.innerHTML = `<i class="fas fa-times-circle mr-2 text-red-400"></i>ì²˜ë¦¬ ì‹¤íŒ¨: ${taskStatus.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                    }

                    setTimeout(async () => {
                        hideRAGProcessingModal();
                        await window.showCustomAlert('ë¬¸ì„œ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (taskStatus.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                    }, 2000);
                }
            } catch (pollErr) {
                console.error('RAG íƒœìŠ¤í¬ í´ë§ ì˜¤ë¥˜:', pollErr);
            }
        }, 2000);

    } catch (error) {
        isProcessing = false;
        if (stageInterval) {
            clearInterval(stageInterval);
        }
        console.error('RAG ë¬¸ì„œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);

        const statusText = document.getElementById('rag-status-text');
        if (statusText) {
            statusText.innerHTML = `<i class="fas fa-times-circle mr-2 text-red-400"></i>ì²˜ë¦¬ ì‹¤íŒ¨: ${error.response?.data?.detail || error.message}`;
        }

        setTimeout(async () => {
            hideRAGProcessingModal();
            await window.showCustomAlert('ë¬¸ì„œ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
        }, 2000);
    }
}

async function askDocument(filename) {
    // ë¬¸ì„œê°€ RAGì— ì¸ë±ì‹±ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    try {
        const response = await axios.get(`${API_BASE_URL}/api/rag/document-status/${encodeURIComponent(filename)}`);
        const isIndexed = response.data.indexed;
        
        if (!isIndexed) {
            // ì•„ì§ ì¸ë±ì‹± ì•ˆë¨ - ì§€ê¸ˆ ì¸ë±ì‹±í• ì§€ ë¬¼ì–´ë³´ê¸°
            const shouldIndex = await window.showCustomConfirm(
                'ì´ ë¬¸ì„œëŠ” ì•„ì§ RAG ì‹œìŠ¤í…œì— ì¸ë±ì‹±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ì¸ë±ì‹±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                'RAG ì¸ë±ì‹± í•„ìš”'
            );
            
            if (shouldIndex) {
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í›„ ì¬ì—…ë¡œë“œ
                const fileBlob = await axios.get(`${API_BASE_URL}/api/documents/download/${encodeURIComponent(filename)}`, {
                    responseType: 'blob'
                });
                const file = new File([fileBlob.data], filename);
                await processRAGDocument(file);
            }
            return;
        }
        
        // ì¸ë±ì‹± ì™„ë£Œ - 3D ì±—ë´‡ìœ¼ë¡œ ì´ë™í•˜ë©° ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
        sessionStorage.setItem('chatbot-document-context', filename);
        showTab('aesong-3d-chat');
        
        // ì±—ë´‡ UI ì—…ë°ì´íŠ¸ (ë¬¸ì„œ ì¹© í‘œì‹œ)
        setTimeout(() => {
            updateChatbotDocumentContext(filename);
        }, 500);
        
    } catch (error) {
        console.error('ë¬¸ì„œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
        await window.showCustomAlert('ë¬¸ì„œ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
    }
}

function updateChatbotDocumentContext(filename) {
    // 3D ì±—ë´‡ UI ë˜ëŠ” í”Œë¡œíŒ… ì±—ë´‡ì— ë¬¸ì„œ ì¹© í‘œì‹œ
    const chatContainer = document.getElementById('aesong-chat-messages') || 
                         document.getElementById('chat-messages-container') ||
                         document.getElementById('chatbot-messages') ||
                         document.querySelector('.chat-container');
    
    if (!chatContainer) {
        console.warn('âš ï¸ ì±„íŒ… ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    // ê¸°ì¡´ ë¬¸ì„œ ì¹© ì œê±°
    const existingChip = document.getElementById('document-context-chip');
    if (existingChip) existingChip.remove();
    
    // ìƒˆ ë¬¸ì„œ ì¹© ì¶”ê°€
    const chip = document.createElement('div');
    chip.id = 'document-context-chip';
    chip.className = 'document-chip';
    chip.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideInDown 0.5s ease;
    `;
    chip.innerHTML = `
        <span style="flex: 1;">
            <i class="fas fa-file-alt mr-2"></i>ëŒ€ìƒ ë¬¸ì„œ: ${filename.length > 30 ? filename.substring(0, 30) + '...' : filename}
        </span>
        <button onclick="clearDocumentContext()" 
                style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 8px; transition: all 0.3s ease;"
                onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ì— ë”°ë¼ ì‚½ì… ìœ„ì¹˜ ê²°ì •
    if (chatContainer.id === 'aesong-chat-messages') {
        // 3D ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­
        const messageList = document.getElementById('chat-message-list');
        if (messageList) {
            messageList.insertBefore(chip, messageList.firstChild);
        } else {
            chatContainer.insertBefore(chip, chatContainer.firstChild);
        }
        // ë©”ì‹œì§€ ì˜ì—­ í‘œì‹œ
        chatContainer.style.display = 'block';
    } else {
        // í”Œë¡œíŒ… ì±—ë´‡
        chatContainer.insertBefore(chip, chatContainer.firstChild);
    }
    
    console.log('ğŸ“„ ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ ì¹© í‘œì‹œ:', filename);
}

function clearDocumentContext() {
    sessionStorage.removeItem('chatbot-document-context');
    const chip = document.getElementById('document-context-chip');
    if (chip) {
        chip.style.animation = 'slideOutUp 0.5s ease';
        setTimeout(() => chip.remove(), 500);
    }
    console.log('ğŸ—‘ï¸ ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ ì œê±°ë¨');
}


// ============================================
// ë¬¸ì œì€í–‰ (AI ë©”ë‰´)
// ============================================

window.examBankData = {
    exams: [],
    currentExam: null
};

function showExamBank() {
    const app = document.getElementById('app');
    
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-clipboard-question mr-2"></i>ë¬¸ì œì€í–‰
                </h2>
                <div class="space-x-2">
                    <button onclick="showExamGenerateForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>ë¬¸ì œ ìƒì„±
                    </button>
                    <button onclick="loadExamList()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <!-- ì‹œí—˜ ëª©ë¡ -->
            <div id="exam-list-container">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-4xl mb-2"></i>
                    <p>ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>
    `;

    loadExamList();
}

async function showExamGenerateForm() {
    const app = document.getElementById('app');

    // ë¡œê·¸ì¸í•œ ê°•ì‚¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
    const instructorName = instructor.name || '';
    const instructorCode = instructor.code || '';

    // ê°•ì‚¬ì˜ êµê³¼ëª© ê°€ì ¸ì˜¤ê¸°
    let instructorSubjects = [];
    try {
        if (instructorCode) {
            const subRes = await axios.get(`${API_BASE_URL}/api/instructors/${instructorCode}/subjects`);
            instructorSubjects = subRes.data || [];
        }
    } catch (e) {
        console.error('ê°•ì‚¬ êµê³¼ëª© ë¡œë“œ ì‹¤íŒ¨:', e);
    }

    // ê³¼ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì‹œí—˜ ëª…ì¹­ ìë™ ìƒì„±ìš©)
    let courseName = '';
    try {
        if (instructor.course_code) {
            const courseRes = await axios.get(`${API_BASE_URL}/api/courses/${instructor.course_code}`);
            courseName = courseRes.data?.name || '';
        }
    } catch (e) {
        console.error('ê³¼ì • ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', e);
    }

    // RAG ë¬¸ì„œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    let ragDocuments = [];
    try {
        const res = await axios.get(`${API_BASE_URL}/api/rag/documents`);
        if (res.data.success) {
            ragDocuments = res.data.documents || [];
        }
    } catch (e) {
        console.error('RAG ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
    }

    // ì‹œí—˜ ëª…ì¹­ ìë™ ìƒì„± (ë…„ë„-ê³¼ì •ëª…-ì›”ì‹œí—˜)
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const defaultExamName = courseName ? `${year}-${courseName}-${month}ì›”ì‹œí—˜` : '';

    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-plus-circle mr-2"></i>RAG ê¸°ë°˜ ë¬¸ì œ ìƒì„±
                </h2>
                <button onclick="showExamBank()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>ëª©ë¡ìœ¼ë¡œ
                </button>
            </div>

            <!-- ê°•ì‚¬ ì •ë³´ í‘œì‹œ -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-500 text-white rounded-full w-12 h-12 flex items-center justify-center">
                        <i class="fas fa-user-tie text-xl"></i>
                    </div>
                    <div>
                        <p class="font-bold text-gray-800">${instructorName || 'ê°•ì‚¬ ì •ë³´ ì—†ìŒ'}</p>
                        <p class="text-sm text-gray-600">ì¶œì œì: ${instructorCode || '-'}</p>
                    </div>
                </div>
            </div>

            <form id="exam-generate-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ì‹œí—˜ëª…ì¹­ *</label>
                        <input type="text" name="exam_name" required
                               class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300"
                               placeholder="Tab í‚¤ë¡œ ìë™ ì…ë ¥ â†’ ${defaultExamName || 'ë…„ë„-ê³¼ì •ëª…-ì›”ì‹œí—˜'}">
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-keyboard mr-1"></i>Tab í‚¤: ìë™ ì…ë ¥ | ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥
                        </p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">êµê³¼ëª© *</label>
                        ${instructorSubjects.length > 0 ? `
                            <select name="subject" required class="w-full border rounded px-3 py-2">
                                <option value="">-- êµê³¼ëª© ì„ íƒ --</option>
                                ${instructorSubjects.map(sub => `
                                    <option value="${sub.name || sub.subject_name}">${sub.name || sub.subject_name}</option>
                                `).join('')}
                            </select>
                        ` : `
                            <input type="text" name="subject" required
                                   class="w-full border rounded px-3 py-2"
                                   placeholder="êµê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                            <p class="text-xs text-orange-500 mt-1">ë‹´ë‹¹ êµê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>
                        `}
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ì‹œí—˜ì¼ì *</label>
                        <input type="date" name="exam_date" required
                               class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ì‹œí—˜ì‹œê°„ *</label>
                        <input type="time" name="exam_time" required
                               class="w-full border rounded px-3 py-2"
                               value="09:00">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ë¬¸í•­ìˆ˜ *</label>
                        <input type="number" name="num_questions" required min="1" max="50" value="10"
                               class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ì‹œí—˜ì‹œê°„(ë¶„)</label>
                        <input type="number" name="exam_duration" min="1" max="180" value="60"
                               class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ë¬¸ì œ ìœ í˜• *</label>
                        <select name="question_type" class="w-full border rounded px-3 py-2">
                            <option value="multiple_choice">ê°ê´€ì‹</option>
                            <option value="short_answer">ë‹¨ë‹µí˜•</option>
                            <option value="essay">ì„œìˆ í˜•</option>
                            <option value="assignment">ê³¼ì œí˜•</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ë‚œì´ë„ *</label>
                        <select name="difficulty" class="w-full border rounded px-3 py-2">
                            <option value="easy">ì‰¬ì›€</option>
                            <option value="medium" selected>ë³´í†µ</option>
                            <option value="hard">ì–´ë ¤ì›€</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ì„¤ëª… (ì„ íƒ)</label>
                    <textarea name="description" rows="2"
                              class="w-full border rounded px-3 py-2"
                              placeholder="ì‹œí—˜ì— ëŒ€í•œ ì¶”ê°€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>

                <!-- RAG ì„ë² ë”© ë¬¸ì„œ ì„ íƒ -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-book mr-2 text-blue-500"></i>ì°¸ê³  ë¬¸ì„œ ì„ íƒ * (RAG ì„ë² ë”©ëœ ë¬¸ì„œ)
                    </label>
                    <div class="border rounded-lg p-4 bg-gray-50 max-h-64 overflow-y-auto">
                        ${ragDocuments.length > 0 ? `
                            <div class="mb-2 flex justify-between items-center">
                                <span class="text-sm text-gray-500">ì´ ${ragDocuments.length}ê°œ ë¬¸ì„œ</span>
                                <label class="flex items-center cursor-pointer text-sm text-blue-600 hover:text-blue-800">
                                    <input type="checkbox" id="select-all-docs" onchange="toggleAllDocs(this.checked)" class="mr-1">
                                    ì „ì²´ ì„ íƒ
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                ${ragDocuments.map((doc, idx) => `
                                    <label class="flex items-start gap-2 p-2 bg-white rounded border hover:bg-blue-50 cursor-pointer transition-colors">
                                        <input type="checkbox" name="rag_documents" value="${doc.filename}"
                                               class="mt-1 rag-doc-checkbox">
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-800 truncate" title="${doc.filename}">${doc.filename}</p>
                                            <p class="text-xs text-gray-500">${doc.chunks_count}ê°œ ì²­í¬</p>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                                <p>ì„ë² ë”©ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p class="text-sm">ë¬¸ì„œê´€ë¦¬ì—ì„œ ë¬¸ì„œë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                            </div>
                        `}
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>ì„ íƒí•œ ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¬¸ì œê°€ ìƒì„±ë©ë‹ˆë‹¤. ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.
                    </p>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex-1">
                        <i class="fas fa-magic mr-2"></i>RAGë¡œ ë¬¸ì œ ìƒì„±
                    </button>
                    <button type="button" onclick="showExamBank()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>

            <!-- ìƒì„±ëœ ë¬¸ì œ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
            <div id="generated-questions-preview" class="hidden mt-8 p-6 bg-gray-50 rounded-lg">
                <h3 class="text-xl font-bold mb-4">ìƒì„±ëœ ë¬¸ì œ ë¯¸ë¦¬ë³´ê¸°</h3>
                <div id="questions-content" class="space-y-4"></div>
                <div class="mt-6 flex gap-3">
                    <button onclick="saveGeneratedExam()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex-1">
                        <i class="fas fa-save mr-2"></i>ë¬¸ì œì€í–‰ì— ì €ì¥
                    </button>
                    <button onclick="showExamGenerateForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg">
                        ë‹¤ì‹œ ìƒì„±
                    </button>
                </div>
            </div>
        </div>
    `;

    // í¼ ì œì¶œ ì´ë²¤íŠ¸
    document.getElementById('exam-generate-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await generateExamQuestions(e.target);
    });

    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ê°’ ì„¤ì •
    document.querySelector('input[name="exam_date"]').valueAsDate = new Date();

    // ì‹œí—˜ ëª…ì¹­ í•„ë“œ - Tab í‚¤ë¡œ ìë™ ì…ë ¥
    const examNameInput = document.querySelector('input[name="exam_name"]');
    const autoExamName = `${year}-${courseName || 'ê³¼ì •ëª…'}-${month}ì›”ì‹œí—˜`;

    examNameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' && !this.value.trim()) {
            e.preventDefault();
            this.value = autoExamName;
            // ì»¤ì„œë¥¼ ëìœ¼ë¡œ ì´ë™
            this.setSelectionRange(this.value.length, this.value.length);
        }
    });

    // ì‹œí—˜ ëª…ì¹­ í•„ë“œì— í¬ì»¤ìŠ¤ ì‹œ íŒíŠ¸ í‘œì‹œ
    examNameInput.addEventListener('focus', function() {
        if (!this.value.trim()) {
            this.placeholder = `Tab í‚¤ë¥¼ ëˆŒëŸ¬ ìë™ ì…ë ¥: ${autoExamName}`;
        }
    });

    examNameInput.addEventListener('blur', function() {
        this.placeholder = 'ì˜ˆ: 2026-ë°”ì´ì˜¤í—¬ìŠ¤AI-1ì›”ì‹œí—˜';
    });
}

// ì „ì²´ ì„ íƒ/í•´ì œ í•¨ìˆ˜
window.toggleAllDocs = function(checked) {
    const checkboxes = document.querySelectorAll('.rag-doc-checkbox');
    checkboxes.forEach(cb => cb.checked = checked);
};

async function generateExamQuestions(form) {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // ì„ íƒëœ RAG ë¬¸ì„œ ìˆ˜ì§‘
    const selectedDocs = [];
    document.querySelectorAll('.rag-doc-checkbox:checked').forEach(cb => {
        selectedDocs.push(cb.value);
    });

    // ìµœì†Œ 1ê°œ ë¬¸ì„œ ì„ íƒ ê²€ì¦
    if (selectedDocs.length === 0) {
        await window.showCustomAlert('ì°¸ê³  ë¬¸ì„œë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    data.rag_documents = selectedDocs;

    // ê°•ì‚¬ ì½”ë“œ ì¶”ê°€
    const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
    data.instructor_code = instructor.code || '';

    try {
        window.showLoading(`ğŸ¤– AIê°€ ë¬¸ì œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘... (${selectedDocs.length}ê°œ ë¬¸ì„œ ì°¸ê³ )`, true);

        const response = await axios.post(`${API_BASE_URL}/api/exam-bank/generate`, data);

        window.hideLoading();

        if (response.data.success) {
            // ìƒì„±ëœ ë¬¸ì œ ì €ì¥
            window.examBankData.currentExam = {
                ...response.data.exam_info,
                questions_text: response.data.questions_text,
                sources: response.data.sources
            };

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            displayGeneratedQuestions(response.data);
        }
    } catch (error) {
        window.hideLoading();
        console.error('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨:', error);
        await window.showCustomAlert('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

function displayGeneratedQuestions(data) {
    const previewDiv = document.getElementById('generated-questions-preview');
    const contentDiv = document.getElementById('questions-content');

    // ë¬¸ì œ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜
    let questionsHTML = data.questions_text.replace(/\n/g, '<br>');
    
    // ë¬¸ì œ ë²ˆí˜¸ ê°•ì¡°
    questionsHTML = questionsHTML.replace(/ë¬¸ì œ (\d+):/g, '<strong style="color: #2563eb; font-size: 1.1em;">ë¬¸ì œ $1:</strong>');
    
    // ì„ íƒì§€ ë“¤ì—¬ì“°ê¸°
    questionsHTML = questionsHTML.replace(/([A-D])\)/g, '<span style="margin-left: 20px;">$1)</span>');
    
    // ì •ë‹µ ê°•ì¡°
    questionsHTML = questionsHTML.replace(/(ì •ë‹µ:.*?)(<br>|$)/g, '<strong style="color: #10b981;">$1</strong>$2');
    
    // í•´ì„¤ ê°•ì¡°
    questionsHTML = questionsHTML.replace(/(í•´ì„¤:.*?)(<br>|$)/g, '<em style="color: #6b7280;">$1</em>$2');

    // ì°¸ê³  ê°•ì¡° (í˜ì´ì§€ ë²ˆí˜¸ í¬í•¨)
    questionsHTML = questionsHTML.replace(/(ì°¸ê³ :.*?)(<br>|$)/g, '<span style="color: #8b5cf6; font-size: 0.9em;"><i class="fas fa-book-open" style="margin-right: 4px;"></i>$1</span>$2');

    contentDiv.innerHTML = `
        <div class="bg-white p-6 rounded border">
            ${questionsHTML}
        </div>
    `;

    previewDiv.classList.remove('hidden');
    previewDiv.scrollIntoView({ behavior: 'smooth' });
}

async function saveGeneratedExam() {
    if (!window.examBankData.currentExam) {
        await window.showCustomAlert('ìƒì„±ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
    }

    // ë¬¸ì œ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ë³€í™˜
    const exam = window.examBankData.currentExam;
    const questionsText = exam.questions_text;
    
    // ê°„ë‹¨í•œ íŒŒì‹± (ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ íŒŒì‹± í•„ìš”)
    const questions = parseQuestionsText(questionsText, exam.question_type);

    try {
        window.showLoading('ë¬¸ì œì€í–‰ì— ì €ì¥ ì¤‘...');

        const saveData = {
            exam_name: exam.exam_name,
            subject: exam.subject,
            exam_date: exam.exam_date,
            question_type: exam.question_type,
            difficulty: exam.difficulty,
            instructor_code: exam.instructor_code || '',
            description: exam.description || '',
            questions: questions
        };

        const response = await axios.post(`${API_BASE_URL}/api/exam-bank/save`, saveData);

        window.hideLoading();

        if (response.data.success) {
            await window.showCustomAlert('ë¬¸ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            showExamBank();
        }
    } catch (error) {
        window.hideLoading();
        console.error('ë¬¸ì œ ì €ì¥ ì‹¤íŒ¨:', error);
        await window.showCustomAlert('ë¬¸ì œ ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

function parseQuestionsText(text, questionType) {
    const questions = [];
    const lines = text.split('\n');
    let currentQuestion = null;

    // í•œ ì¤„ì— ì—¬ëŸ¬ ì„ íƒì§€ê°€ ìˆëŠ” ê²½ìš° ë¶„ë¦¬í•˜ëŠ” í•¨ìˆ˜
    function extractOptionsFromLine(line) {
        const options = [];
        // 1) ... 2) ... 3) ... 4) ... ë˜ëŠ” A) ... B) ... íŒ¨í„´ ì°¾ê¸°
        const optionMatches = line.match(/[1-4A-D]\)\s*[^1-4A-D)]+/g);
        if (optionMatches && optionMatches.length >= 2) {
            optionMatches.forEach(match => {
                const optText = match.replace(/^[1-4A-D]\)\s*/, '').trim();
                if (optText) options.push(optText);
            });
        }
        return options;
    }

    // ë¬¸ì œ í…ìŠ¤íŠ¸ì—ì„œ ì„ íƒì§€ ë¶€ë¶„ ë¶„ë¦¬
    function separateQuestionAndOptions(text) {
        // "ë¬¸ì œë‚´ìš© 1) ì„ íƒì§€1 2) ì„ íƒì§€2..." íŒ¨í„´ì—ì„œ ë¬¸ì œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
        const match = text.match(/^(.+?)\s*(?=[1-4A-D]\))/);
        if (match) {
            return match[1].trim();
        }
        return text;
    }

    for (const line of lines) {
        const trimmed = line.trim();

        if (trimmed.match(/^ë¬¸ì œ\s*\d+:/)) {
            if (currentQuestion) {
                // ì´ì „ ë¬¸ì œì—ì„œ optionsê°€ ë¹„ì–´ìˆìœ¼ë©´ question_textì—ì„œ ì¶”ì¶œ ì‹œë„
                if (currentQuestion.options.length === 0 && currentQuestion.question_text) {
                    const extractedOptions = extractOptionsFromLine(currentQuestion.question_text);
                    if (extractedOptions.length > 0) {
                        currentQuestion.options = extractedOptions;
                        currentQuestion.question_text = separateQuestionAndOptions(currentQuestion.question_text);
                    }
                }
                questions.push(currentQuestion);
            }
            currentQuestion = {
                question_text: '',
                options: [],
                correct_answer: '',
                explanation: '',
                reference_document: '',
                reference_page: ''
            };
        } else if (currentQuestion) {
            // í•œ ì¤„ì— ì—¬ëŸ¬ ì„ íƒì§€ê°€ ìˆëŠ” ê²½ìš° (ì˜ˆ: "1) ì˜µì…˜1 2) ì˜µì…˜2 3) ì˜µì…˜3 4) ì˜µì…˜4")
            const inlineOptions = extractOptionsFromLine(trimmed);
            if (inlineOptions.length >= 2) {
                currentQuestion.options = inlineOptions;
            }
            // 1) 2) 3) 4) í˜•ì‹ ë˜ëŠ” A) B) C) D) í˜•ì‹ (ê° ì¤„ì— í•˜ë‚˜ì”©)
            else if (trimmed.match(/^[1-4]\)/) || trimmed.match(/^[A-D]\)/)) {
                const optionText = trimmed.replace(/^[1-4A-D]\)\s*/, '').trim();
                currentQuestion.options.push(optionText);
            } else if (trimmed.startsWith('ì •ë‹µ:')) {
                let answer = trimmed.replace('ì •ë‹µ:', '').trim();
                const letterToNum = {'A': '1', 'B': '2', 'C': '3', 'D': '4'};
                if (letterToNum[answer.toUpperCase()]) {
                    answer = letterToNum[answer.toUpperCase()];
                }
                const numMatch = answer.match(/^([1-4])/);
                if (numMatch) {
                    answer = numMatch[1];
                }
                currentQuestion.correct_answer = answer;
            } else if (trimmed.startsWith('ëª¨ë²”ë‹µì•ˆ:')) {
                // ì„œìˆ í˜• ë¬¸ì œì˜ ëª¨ë²”ë‹µì•ˆ
                currentQuestion.correct_answer = trimmed.replace('ëª¨ë²”ë‹µì•ˆ:', '').trim();
            } else if (trimmed.startsWith('ì±„ì ê¸°ì¤€:')) {
                // ì„œìˆ í˜• ë¬¸ì œì˜ ì±„ì ê¸°ì¤€ (í•´ì„¤ë¡œ ì €ì¥)
                currentQuestion.explanation = trimmed.replace('ì±„ì ê¸°ì¤€:', '').trim();
            } else if (trimmed.startsWith('í•´ì„¤:')) {
                currentQuestion.explanation = trimmed.replace('í•´ì„¤:', '').trim();
            } else if (trimmed.startsWith('ì°¸ê³ :')) {
                currentQuestion.reference_document = trimmed.replace('ì°¸ê³ :', '').trim();
            } else if (trimmed && !trimmed.startsWith('---')) {
                currentQuestion.question_text += (currentQuestion.question_text ? ' ' : '') + trimmed;
            }
        }
    }

    if (currentQuestion) {
        // ë§ˆì§€ë§‰ ë¬¸ì œë„ ì²˜ë¦¬
        if (currentQuestion.options.length === 0 && currentQuestion.question_text) {
            const extractedOptions = extractOptionsFromLine(currentQuestion.question_text);
            if (extractedOptions.length > 0) {
                currentQuestion.options = extractedOptions;
                currentQuestion.question_text = separateQuestionAndOptions(currentQuestion.question_text);
            }
        }
        questions.push(currentQuestion);
    }

    return questions;
}

async function loadExamList() {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/exam-bank/list`);
        const exams = response.data.exams || [];
        
        window.examBankData.exams = exams;

        const container = document.getElementById('exam-list-container');

        if (exams.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-clipboard-question text-4xl mb-2"></i>
                    <p>ìƒì„±ëœ ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    <button onclick="showExamGenerateForm()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>ì²« ë²ˆì§¸ ì‹œí—˜ ìƒì„±í•˜ê¸°
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="grid grid-cols-1 gap-4">
                ${exams.map(exam => `
                    <div class="bg-white border rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${exam.exam_name}</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                                    <div>
                                        <i class="fas fa-book mr-2 text-blue-500"></i>
                                        <strong>êµê³¼ëª©:</strong> ${exam.subject}
                                    </div>
                                    <div>
                                        <i class="fas fa-calendar mr-2 text-green-500"></i>
                                        <strong>ì‹œí—˜ì¼:</strong> ${exam.exam_date}
                                    </div>
                                    <div>
                                        <i class="fas fa-list-ol mr-2 text-purple-500"></i>
                                        <strong>ë¬¸í•­ìˆ˜:</strong> ${exam.total_questions}ë¬¸ì œ
                                    </div>
                                    <div>
                                        <i class="fas fa-signal mr-2 text-orange-500"></i>
                                        <strong>ë‚œì´ë„:</strong> ${getDifficultyLabel(exam.difficulty)}
                                    </div>
                                </div>
                                ${exam.description ? `<p class="text-gray-600 mt-2">${exam.description}</p>` : ''}
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button onclick="viewExamDetail(${exam.exam_id})"
                                        class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded bg-blue-50 hover:bg-blue-100">
                                    <i class="fas fa-eye mr-1"></i>ìƒì„¸ë³´ê¸°
                                </button>
                                <button onclick="showExamEditForm(${exam.exam_id})"
                                        class="text-green-600 hover:text-green-800 px-3 py-1 rounded bg-green-50 hover:bg-green-100">
                                    <i class="fas fa-edit mr-1"></i>ìˆ˜ì •
                                </button>
                                <button onclick="deleteExam(${exam.exam_id}, '${exam.exam_name}')"
                                        class="text-red-600 hover:text-red-800 px-3 py-1 rounded bg-red-50 hover:bg-red-100">
                                    <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error('ì‹œí—˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('exam-list-container').innerHTML = `
            <div class="text-center text-red-500 py-8">
                <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                <p>ì‹œí—˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</p>
            </div>
        `;
    }
}

function getDifficultyLabel(difficulty) {
    const labels = {
        'easy': 'ì‰¬ì›€',
        'medium': 'ë³´í†µ',
        'hard': 'ì–´ë ¤ì›€'
    };
    return labels[difficulty] || difficulty;
}

async function viewExamDetail(examId) {
    try {
        window.showLoading('ì‹œí—˜ ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...');

        const response = await axios.get(`${API_BASE_URL}/api/exam-bank/${examId}`);
        const exam = response.data.exam;

        window.hideLoading();

        // í˜„ì¬ ì‹œí—˜ ì •ë³´ ì €ì¥ (ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
        window.examBankData.currentExamId = examId;
        window.examBankData.currentExamQuestionType = exam.question_type;

        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-clipboard-check mr-2"></i>${exam.exam_name}
                    </h2>
                    <div class="space-x-2">
                        <button onclick="showAddQuestionModal(${examId})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-plus mr-2"></i>ë¬¸ì œ ì¶”ê°€
                        </button>
                        <button onclick="showExamEditForm(${examId})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-edit mr-2"></i>ì‹œí—˜ ì •ë³´ ìˆ˜ì •
                        </button>
                        <button onclick="showExamBank()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-arrow-left mr-2"></i>ëª©ë¡ìœ¼ë¡œ
                        </button>
                    </div>
                </div>

                <!-- ì‹œí—˜ ì •ë³´ -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6 border border-blue-200">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-600 mb-1">êµê³¼ëª©</div>
                            <div class="font-semibold">${exam.subject}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600 mb-1">ì‹œí—˜ì¼ì</div>
                            <div class="font-semibold">${exam.exam_date}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600 mb-1">ë¬¸í•­ìˆ˜</div>
                            <div class="font-semibold" id="total-questions-count">${exam.total_questions}ë¬¸ì œ</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600 mb-1">ë‚œì´ë„</div>
                            <div class="font-semibold">${getDifficultyLabel(exam.difficulty)}</div>
                        </div>
                    </div>
                    ${exam.description ? `
                        <div class="mt-4 pt-4 border-t border-blue-200">
                            <div class="text-sm text-gray-600 mb-1">ì„¤ëª…</div>
                            <div>${exam.description}</div>
                        </div>
                    ` : ''}
                </div>

                <!-- ë¬¸ì œ ëª©ë¡ -->
                <div id="questions-list" class="space-y-6">
                    ${exam.questions.length === 0 ? `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-clipboard-question text-4xl mb-2"></i>
                            <p>ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <button onclick="showAddQuestionModal(${examId})" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                <i class="fas fa-plus mr-2"></i>ì²« ë²ˆì§¸ ë¬¸ì œ ì¶”ê°€í•˜ê¸°
                            </button>
                        </div>
                    ` : exam.questions.map((q, idx) => `
                        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200" id="question-card-${q.question_id}">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-blue-600">ë¬¸ì œ ${q.question_number}</h3>
                                <div class="flex gap-2">
                                    <button onclick="showEditQuestionModal(${q.question_id}, ${examId})"
                                            class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded bg-blue-50 hover:bg-blue-100 text-sm">
                                        <i class="fas fa-edit mr-1"></i>ìˆ˜ì •
                                    </button>
                                    <button onclick="deleteQuestion(${q.question_id}, ${q.question_number}, ${examId})"
                                            class="text-red-600 hover:text-red-800 px-3 py-1 rounded bg-red-50 hover:bg-red-100 text-sm">
                                        <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                            <div class="text-gray-800 mb-4 whitespace-pre-wrap">${q.question_text}</div>

                            ${q.options && q.options.length > 0 ? `
                                <div class="space-y-2 mb-4 ml-4">
                                    ${q.options.map(opt => `
                                        <div class="text-gray-700">${opt}</div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            <div class="bg-green-50 border border-green-200 rounded p-3 mb-3">
                                <strong class="text-green-700">ì •ë‹µ:</strong> ${q.correct_answer}
                            </div>

                            ${q.explanation ? `
                                <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                                    <strong class="text-blue-700">í•´ì„¤:</strong> ${q.explanation}
                                </div>
                            ` : ''}

                            ${q.reference_document ? `
                                <div class="text-sm text-gray-600">
                                    <i class="fas fa-book mr-1"></i>
                                    <strong>ì°¸ê³ :</strong> ${q.reference_document}
                                    ${q.reference_page ? ` (${q.reference_page})` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- ë¬¸ì œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
            <div id="question-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 id="question-modal-title" class="text-xl font-bold text-gray-800">ë¬¸ì œ ì¶”ê°€</h3>
                            <button onclick="closeQuestionModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="question-form" class="space-y-4">
                            <input type="hidden" id="modal-question-id" value="">
                            <input type="hidden" id="modal-exam-id" value="${examId}">

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ë¬¸ì œ ìœ í˜• *
                                </label>
                                <select id="modal-question-type" required onchange="toggleOptionsField()"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="multiple_choice">ê°ê´€ì‹</option>
                                    <option value="short_answer">ë‹¨ë‹µí˜•</option>
                                    <option value="essay">ì„œìˆ í˜•</option>
                                    <option value="assignment">ê³¼ì œí˜•</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ë¬¸ì œ ë‚´ìš© *
                                </label>
                                <textarea id="modal-question-text" rows="4" required
                                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                          placeholder="ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            </div>

                            <div id="options-container">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ì„ íƒì§€ (ê°ê´€ì‹ì¸ ê²½ìš°)
                                </label>
                                <div id="options-list" class="space-y-2">
                                    <input type="text" class="option-input w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="A) ì„ íƒì§€ 1">
                                    <input type="text" class="option-input w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="B) ì„ íƒì§€ 2">
                                    <input type="text" class="option-input w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="C) ì„ íƒì§€ 3">
                                    <input type="text" class="option-input w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="D) ì„ íƒì§€ 4">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ì •ë‹µ *
                                </label>
                                <input type="text" id="modal-correct-answer" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="ì˜ˆ: A ë˜ëŠ” ì •ë‹µ ë‚´ìš©">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    í•´ì„¤
                                </label>
                                <textarea id="modal-explanation" rows="3"
                                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                          placeholder="ë¬¸ì œì— ëŒ€í•œ í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        ì°¸ê³  ë¬¸ì„œ
                                    </label>
                                    <input type="text" id="modal-reference-document"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="ì°¸ê³  ë¬¸ì„œëª…">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        ì°¸ê³  í˜ì´ì§€
                                    </label>
                                    <input type="text" id="modal-reference-page"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="ì˜ˆ: p.15">
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex-1">
                                    <i class="fas fa-save mr-2"></i>ì €ì¥
                                </button>
                                <button type="button" onclick="closeQuestionModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('question-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveQuestion();
        });

    } catch (error) {
        window.hideLoading();
        console.error('ì‹œí—˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
        showAlert('ì‹œí—˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ë¬¸ì œ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
function showAddQuestionModal(examId) {
    // í¼ ì´ˆê¸°í™”
    document.getElementById('modal-question-id').value = '';
    document.getElementById('modal-exam-id').value = examId;
    document.getElementById('modal-question-type').value = window.examBankData.currentExamQuestionType || 'multiple_choice';
    document.getElementById('modal-question-text').value = '';
    document.getElementById('modal-correct-answer').value = '';
    document.getElementById('modal-explanation').value = '';
    document.getElementById('modal-reference-document').value = '';
    document.getElementById('modal-reference-page').value = '';

    // ì„ íƒì§€ ì´ˆê¸°í™”
    const optionInputs = document.querySelectorAll('.option-input');
    optionInputs.forEach(input => input.value = '');

    // ëª¨ë‹¬ ì œëª© ë³€ê²½
    document.getElementById('question-modal-title').textContent = 'ë¬¸ì œ ì¶”ê°€';

    // ì„ íƒì§€ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
    toggleOptionsField();

    // ëª¨ë‹¬ í‘œì‹œ
    document.getElementById('question-modal').classList.remove('hidden');
}

// ë¬¸ì œ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
async function showEditQuestionModal(questionId, examId) {
    try {
        window.showLoading('ë¬¸ì œ ì •ë³´ ë¡œë”© ì¤‘...');

        // ì‹œí—˜ ìƒì„¸ì—ì„œ ë¬¸ì œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const response = await axios.get(`${API_BASE_URL}/api/exam-bank/${examId}`);
        const exam = response.data.exam;
        const question = exam.questions.find(q => q.question_id === questionId);

        window.hideLoading();

        if (!question) {
            showAlert('ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        document.getElementById('modal-question-id').value = questionId;
        document.getElementById('modal-exam-id').value = examId;
        document.getElementById('modal-question-type').value = question.question_type || 'multiple_choice';
        document.getElementById('modal-question-text').value = question.question_text || '';
        document.getElementById('modal-correct-answer').value = question.correct_answer || '';
        document.getElementById('modal-explanation').value = question.explanation || '';
        document.getElementById('modal-reference-document').value = question.reference_document || '';
        document.getElementById('modal-reference-page').value = question.reference_page || '';

        // ì„ íƒì§€ ì±„ìš°ê¸°
        const optionInputs = document.querySelectorAll('.option-input');
        const options = question.options || [];
        optionInputs.forEach((input, idx) => {
            input.value = options[idx] || '';
        });

        // ëª¨ë‹¬ ì œëª© ë³€ê²½
        document.getElementById('question-modal-title').textContent = 'ë¬¸ì œ ìˆ˜ì •';

        // ì„ íƒì§€ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
        toggleOptionsField();

        // ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('question-modal').classList.remove('hidden');

    } catch (error) {
        window.hideLoading();
        console.error('ë¬¸ì œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('ë¬¸ì œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeQuestionModal() {
    document.getElementById('question-modal').classList.add('hidden');
}

// ì„ íƒì§€ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
function toggleOptionsField() {
    const questionType = document.getElementById('modal-question-type').value;
    const optionsContainer = document.getElementById('options-container');

    if (questionType === 'multiple_choice') {
        optionsContainer.style.display = 'block';
    } else {
        optionsContainer.style.display = 'none';
    }
}

// ë¬¸ì œ ì €ì¥ (ì¶”ê°€ ë˜ëŠ” ìˆ˜ì •)
async function saveQuestion() {
    const questionId = document.getElementById('modal-question-id').value;
    const examId = document.getElementById('modal-exam-id').value;
    const questionType = document.getElementById('modal-question-type').value;
    const questionText = document.getElementById('modal-question-text').value.trim();
    const correctAnswer = document.getElementById('modal-correct-answer').value.trim();
    const explanation = document.getElementById('modal-explanation').value.trim();
    const referenceDocument = document.getElementById('modal-reference-document').value.trim();
    const referencePage = document.getElementById('modal-reference-page').value.trim();

    // ì„ íƒì§€ ìˆ˜ì§‘
    const optionInputs = document.querySelectorAll('.option-input');
    const options = [];
    optionInputs.forEach(input => {
        if (input.value.trim()) {
            options.push(input.value.trim());
        }
    });

    if (!questionText || !correctAnswer) {
        showAlert('ë¬¸ì œ ë‚´ìš©ê³¼ ì •ë‹µì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', 'warning');
        return;
    }

    const data = {
        question_type: questionType,
        question_text: questionText,
        correct_answer: correctAnswer,
        explanation: explanation,
        reference_document: referenceDocument,
        reference_page: referencePage,
        options: questionType === 'multiple_choice' ? options : []
    };

    try {
        window.showLoading(questionId ? 'ë¬¸ì œ ìˆ˜ì • ì¤‘...' : 'ë¬¸ì œ ì¶”ê°€ ì¤‘...');

        if (questionId) {
            // ìˆ˜ì •
            await axios.put(`${API_BASE_URL}/api/exam-bank/questions/${questionId}`, data);
            window.hideLoading();
            showAlert('ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
            // ì¶”ê°€
            await axios.post(`${API_BASE_URL}/api/exam-bank/${examId}/questions`, data);
            window.hideLoading();
            showAlert('ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        closeQuestionModal();

        // ìƒì„¸ë³´ê¸° ìƒˆë¡œê³ ì¹¨
        viewExamDetail(parseInt(examId));

    } catch (error) {
        window.hideLoading();
        console.error('ë¬¸ì œ ì €ì¥ ì‹¤íŒ¨:', error);
        showAlert('ë¬¸ì œ ì €ì¥ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ê°œë³„ ë¬¸ì œ ì‚­ì œ
async function deleteQuestion(questionId, questionNumber, examId) {
    const confirmed = await showConfirm(`ë¬¸ì œ ${questionNumber}ë²ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë¬¸ì œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'ë¬¸ì œ ì‚­ì œ');
    if (!confirmed) {
        return;
    }

    try {
        window.showLoading('ë¬¸ì œ ì‚­ì œ ì¤‘...');
        await axios.delete(`${API_BASE_URL}/api/exam-bank/questions/${questionId}`);
        window.hideLoading();
        showAlert('ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

        // ìƒì„¸ë³´ê¸° ìƒˆë¡œê³ ì¹¨
        viewExamDetail(examId);

    } catch (error) {
        window.hideLoading();
        console.error('ë¬¸ì œ ì‚­ì œ ì‹¤íŒ¨:', error);
        showAlert('ë¬¸ì œ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

async function deleteExam(examId, examName) {
    const confirmed = await showConfirm(`ì‹œí—˜ "${examName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ì‹œí—˜ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'ì‹œí—˜ ì‚­ì œ');
    if (!confirmed) {
        return;
    }

    try {
        window.showLoading('ì‹œí—˜ ì‚­ì œ ì¤‘...');
        await axios.delete(`${API_BASE_URL}/api/exam-bank/${examId}`);
        window.hideLoading();
        showAlert('ì‹œí—˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        loadExamList();
    } catch (error) {
        window.hideLoading();
        console.error('ì‹œí—˜ ì‚­ì œ ì‹¤íŒ¨:', error);
        showAlert('ì‹œí—˜ ì‚­ì œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ì‹œí—˜ ìˆ˜ì • í¼ í‘œì‹œ
async function showExamEditForm(examId) {
    try {
        window.showLoading('ì‹œí—˜ ì •ë³´ ë¡œë”© ì¤‘...');
        const response = await axios.get(`${API_BASE_URL}/api/exam-bank/${examId}`);
        const exam = response.data.exam;
        window.hideLoading();

        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-edit mr-2"></i>ì‹œí—˜ ìˆ˜ì •
                    </h2>
                    <button onclick="showExamBank()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-arrow-left mr-2"></i>ì·¨ì†Œ
                    </button>
                </div>

                <form id="exam-edit-form" class="space-y-6">
                    <input type="hidden" id="edit-exam-id" value="${examId}">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-clipboard-check mr-1"></i>ì‹œí—˜ ì´ë¦„ *
                            </label>
                            <input type="text" id="edit-exam-name" value="${exam.exam_name}" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-book mr-1"></i>êµê³¼ëª© *
                            </label>
                            <input type="text" id="edit-subject" value="${exam.subject}" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar mr-1"></i>ì‹œí—˜ ë‚ ì§œ *
                            </label>
                            <input type="date" id="edit-exam-date" value="${exam.exam_date}" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-signal mr-1"></i>ë‚œì´ë„ *
                            </label>
                            <select id="edit-difficulty" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="easy" ${exam.difficulty === 'easy' ? 'selected' : ''}>ì‰¬ì›€</option>
                                <option value="medium" ${exam.difficulty === 'medium' ? 'selected' : ''}>ë³´í†µ</option>
                                <option value="hard" ${exam.difficulty === 'hard' ? 'selected' : ''}>ì–´ë ¤ì›€</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-align-left mr-1"></i>ì„¤ëª…
                        </label>
                        <textarea id="edit-description" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">${exam.description || ''}</textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex-1">
                            <i class="fas fa-save mr-2"></i>ì €ì¥
                        </button>
                        <button type="button" onclick="viewExamDetail(${examId})" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg">
                            <i class="fas fa-eye mr-2"></i>ìƒì„¸ë³´ê¸°
                        </button>
                    </div>
                </form>
            </div>
        `;

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('exam-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await updateExam();
        });

    } catch (error) {
        window.hideLoading();
        console.error('ì‹œí—˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('ì‹œí—˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ì‹œí—˜ ìˆ˜ì • API í˜¸ì¶œ
async function updateExam() {
    const examId = document.getElementById('edit-exam-id').value;
    const examName = document.getElementById('edit-exam-name').value.trim();
    const subject = document.getElementById('edit-subject').value.trim();
    const examDate = document.getElementById('edit-exam-date').value;
    const difficulty = document.getElementById('edit-difficulty').value;
    const description = document.getElementById('edit-description').value.trim();

    if (!examName || !subject || !examDate || !difficulty) {
        showAlert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    try {
        window.showLoading('ì‹œí—˜ ì •ë³´ ìˆ˜ì • ì¤‘...');

        const data = {
            exam_name: examName,
            subject: subject,
            exam_date: examDate,
            difficulty: difficulty,
            description: description
        };

        await axios.put(`${API_BASE_URL}/api/exam-bank/${examId}`, data);

        window.hideLoading();
        showAlert('ì‹œí—˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

        // ìƒì„¸ë³´ê¸°ë¡œ ì´ë™
        viewExamDetail(parseInt(examId));

    } catch (error) {
        window.hideLoading();
        console.error('ì‹œí—˜ ìˆ˜ì • ì‹¤íŒ¨:', error);
        showAlert('ì‹œí—˜ ìˆ˜ì • ì‹¤íŒ¨: ' + (error.response?.data?.detail || error.message), 'error');
    }
}

// ==================== ì˜¨ë¼ì¸ì‹œí—˜ ====================
let onlineExamMonitorInterval = null;

async function showOnlineExam() {
    const app = document.getElementById('app');

    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-laptop mr-2"></i>ì˜¨ë¼ì¸ì‹œí—˜
                </h2>
                <div class="space-x-2">
                    <button onclick="showCreateOnlineExamModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>ì‹œí—˜ ë“±ë¡
                    </button>
                </div>
            </div>

            <div id="online-exam-list">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                    <p class="text-gray-500 mt-2">ì‹œí—˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    `;

    await loadOnlineExamList();
}

async function loadOnlineExamList() {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/online-exams`);
        const exams = response.data.exams || [];

        const container = document.getElementById('online-exam-list');
        if (!container) {
            console.log('ì˜¨ë¼ì¸ ì‹œí—˜ ëª©ë¡ ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ ì „í™˜ í•„ìš”.');
            return;
        }

        if (exams.length === 0) {
            container.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                    <i class="fas fa-laptop text-6xl text-blue-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">ë“±ë¡ëœ ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p class="text-gray-600 mb-4">
                        ë¬¸ì œì€í–‰ì—ì„œ ìƒì„±í•œ ë¬¸ì œë¥¼ í™œìš©í•˜ì—¬ ì˜¨ë¼ì¸ ì‹œí—˜ì„ ë“±ë¡í•´ë³´ì„¸ìš”.
                    </p>
                    <button onclick="showCreateOnlineExamModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>ì‹œí—˜ ë“±ë¡í•˜ê¸°
                    </button>
                </div>
            `;
            return;
        }

        const statusLabels = {
            'scheduled': { text: 'ì˜ˆì •', class: 'bg-gray-100 text-gray-700' },
            'waiting': { text: 'ëŒ€ê¸°ì¤‘', class: 'bg-yellow-100 text-yellow-700' },
            'ongoing': { text: 'ì§„í–‰ì¤‘', class: 'bg-green-100 text-green-700' },
            'ended': { text: 'ì¢…ë£Œ', class: 'bg-red-100 text-red-700' },
            'graded': { text: 'ì±„ì ì™„ë£Œ', class: 'bg-blue-100 text-blue-700' }
        };

        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‹œí—˜ëª…</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê³¼ì •</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ë¬¸í•­ìˆ˜</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ì‹œê°„</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ì‘ì‹œ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${exams.map(exam => {
                            const status = statusLabels[exam.status] || statusLabels['scheduled'];
                            const typeLabel = exam.exam_type === 'quiz' ? '<span class="inline-block px-2 py-0.5 text-xs font-medium rounded bg-orange-100 text-orange-700 mr-2">í€´ì¦ˆ</span>'
                                            : exam.exam_type === 'assignment' ? '<span class="inline-block px-2 py-0.5 text-xs font-medium rounded bg-green-100 text-green-700 mr-2">ê³¼ì œ</span>'
                                            : '';
                            const isAssignment = exam.exam_type === 'assignment';
                            const deadlineStr = exam.deadline ? new Date(exam.deadline).toLocaleString('ko-KR', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '';

                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">
                                            ${typeLabel}
                                            ${exam.title}
                                        </div>
                                        <div class="text-sm text-gray-500">${exam.exam_bank_name || ''}</div>
                                        ${isAssignment && deadlineStr ? `<div class="text-xs text-red-600"><i class="fas fa-clock mr-1"></i>ë§ˆê°: ${deadlineStr}</div>` : ''}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${exam.course_name || exam.course_code}</td>
                                    <td class="px-4 py-3 text-center text-sm">${exam.total_questions || 0}ë¬¸í•­</td>
                                    <td class="px-4 py-3 text-center text-sm">${isAssignment ? '-' : exam.duration + 'ë¶„'}</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${status.class}">${status.text}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-sm">${exam.participant_count || 0}ëª…</td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex flex-wrap justify-center gap-1">
                                            ${exam.status === 'scheduled' && !isAssignment ? `
                                                <button onclick="openWaitingRoom(${exam.id})" class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded">
                                                    <i class="fas fa-door-open mr-1"></i>ëŒ€ê¸°ì‹¤
                                                </button>
                                            ` : ''}
                                            ${exam.status === 'waiting' ? `
                                                <button onclick="startOnlineExam(${exam.id})" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded">
                                                    <i class="fas fa-play mr-1"></i>ì‹œì‘
                                                </button>
                                            ` : ''}
                                            ${exam.status === 'ongoing' && !isAssignment ? `
                                                <button onclick="endOnlineExam(${exam.id}, '${exam.exam_type || 'exam'}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">
                                                    <i class="fas fa-stop mr-1"></i>ì¢…ë£Œ
                                                </button>
                                            ` : ''}
                                            ${exam.status === 'ongoing' && isAssignment ? `
                                                <button onclick="showExamMonitor(${exam.id})" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">
                                                    <i class="fas fa-list-check mr-1"></i>ì œì¶œí˜„í™©
                                                </button>
                                                <button onclick="closeAssignment(${exam.id})" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">
                                                    <i class="fas fa-lock mr-1"></i>ë§ˆê°
                                                </button>
                                            ` : ''}
                                            ${['waiting', 'ongoing'].includes(exam.status) && !isAssignment ? `
                                                <button onclick="showExamMonitor(${exam.id})" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">
                                                    <i class="fas fa-tv mr-1"></i>ëª¨ë‹ˆí„°ë§
                                                </button>
                                            ` : ''}
                                            ${exam.status === 'ended' ? `
                                                <button onclick="gradeOnlineExam(${exam.id})" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded">
                                                    <i class="fas fa-check-double mr-1"></i>ì±„ì 
                                                </button>
                                            ` : ''}
                                            ${exam.status === 'graded' ? `
                                                <button onclick="showExamResults(${exam.id})" class="px-3 py-1 bg-indigo-500 hover:bg-indigo-600 text-white text-xs rounded">
                                                    <i class="fas fa-chart-bar mr-1"></i>ê²°ê³¼
                                                </button>
                                            ` : ''}
                                            ${!['ongoing'].includes(exam.status) || isAssignment ? `
                                                <button onclick="deleteOnlineExam(${exam.id})" class="px-3 py-1 bg-gray-400 hover:bg-gray-500 text-white text-xs rounded">
                                                    <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                                                </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('ì˜¨ë¼ì¸ ì‹œí—˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        showAlert('ì‹œí—˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function showCreateOnlineExamModal() {
    try {
        // ë¬¸ì œì€í–‰ ëª©ë¡ê³¼ ê³¼ì • ëª©ë¡ ì¡°íšŒ
        const [examBankRes, coursesRes] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/exam-bank/list`),
            axios.get(`${API_BASE_URL}/api/courses`)
        ]);

        const examBanks = examBankRes.data.exams || [];
        const courses = coursesRes.data || [];

        if (examBanks.length === 0) {
            showAlert('ë¨¼ì € ë¬¸ì œì€í–‰ì—ì„œ ì‹œí—˜ì„ ìƒì„±í•´ì£¼ì„¸ìš”.', 'warning', { title: 'ë¬¸ì œì€í–‰ í•„ìš”' });
            return;
        }

        const modalHtml = `
            <div id="create-exam-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-plus-circle mr-2 text-blue-500"></i><span id="modal-title">ì˜¨ë¼ì¸ ì‹œí—˜ ë“±ë¡</span>
                        </h3>
                        <button onclick="closeCreateExamModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ìœ í˜• ì„ íƒ *</label>
                            <div class="flex space-x-4 flex-wrap gap-2">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="exam-type" value="exam" checked class="mr-2" onchange="updateExamTypeUI()">
                                    <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm">ì‹œí—˜</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="exam-type" value="quiz" class="mr-2" onchange="updateExamTypeUI()">
                                    <span class="px-3 py-1 rounded-full bg-orange-100 text-orange-700 text-sm">í€´ì¦ˆ</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="exam-type" value="assignment" class="mr-2" onchange="updateExamTypeUI()">
                                    <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm">ê³¼ì œ</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì œì€í–‰ ì‹œí—˜ ì„ íƒ *</label>
                            <select id="exam-bank-select" class="w-full border rounded-lg px-3 py-2" onchange="updateExamTitle()">
                                <option value="">ì‹œí—˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                ${examBanks.map(e => `<option value="${e.exam_id}" data-name="${e.exam_name}" data-questions="${e.total_questions}">${e.exam_name} (${e.total_questions}ë¬¸í•­)</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì œëª© *</label>
                            <input type="text" id="exam-title" class="w-full border rounded-lg px-3 py-2" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ëŒ€ìƒ ê³¼ì • *</label>
                            <select id="exam-course" class="w-full border rounded-lg px-3 py-2">
                                <option value="">ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                ${courses.map(c => `<option value="${c.code}">${c.name}</option>`).join('')}
                            </select>
                        </div>

                        <!-- ì‹œí—˜/í€´ì¦ˆ: ì‹œê°„(ë¶„) ì„¤ì • -->
                        <div id="duration-section" class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1"><span id="duration-label">ì‹œí—˜</span> ì‹œê°„ (ë¶„) *</label>
                                <input type="number" id="exam-duration" class="w-full border rounded-lg px-3 py-2" value="60" min="1" max="180">
                                <p id="duration-hint" class="text-xs text-gray-500 mt-1 hidden">í€´ì¦ˆëŠ” 1ë¶„ë¶€í„° ì„¤ì • ê°€ëŠ¥</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">í•©ê²© ì ìˆ˜</label>
                                <input type="number" id="exam-pass-score" class="w-full border rounded-lg px-3 py-2" value="60" min="0" max="100">
                            </div>
                        </div>

                        <!-- ê³¼ì œ: ë§ˆê°ì¼ ì„¤ì • -->
                        <div id="deadline-section" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì œì¶œ ë§ˆê°ì¼ *</label>
                            <input type="datetime-local" id="exam-deadline" class="w-full border rounded-lg px-3 py-2">
                            <p class="text-xs text-gray-500 mt-1">í•™ìƒë“¤ì€ ë§ˆê°ì¼ê¹Œì§€ ì œì¶œ/ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1"><span id="desc-label">ì‹œí—˜</span> ì•ˆë‚´ì‚¬í•­</label>
                            <textarea id="exam-description" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="í•™ìƒë“¤ì—ê²Œ ì•ˆë‚´í•  ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 p-4 border-t bg-gray-50 sticky bottom-0">
                        <button onclick="closeCreateExamModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="submitCreateOnlineExam()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            <i class="fas fa-check mr-1"></i>ë“±ë¡
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
    } catch (error) {
        console.error('ì‹œí—˜ ë“±ë¡ ëª¨ë‹¬ ì˜¤ë¥˜:', error);
        showAlert('ì‹œí—˜ ë“±ë¡ í™”ë©´ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

function updateExamTitle() {
    const select = document.getElementById('exam-bank-select');
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption && selectedOption.dataset.name) {
        document.getElementById('exam-title').value = selectedOption.dataset.name;
    }
}

function updateExamTypeUI() {
    const examType = document.querySelector('input[name="exam-type"]:checked')?.value || 'exam';
    const durationSection = document.getElementById('duration-section');
    const deadlineSection = document.getElementById('deadline-section');
    const durationLabel = document.getElementById('duration-label');
    const durationHint = document.getElementById('duration-hint');
    const durationInput = document.getElementById('exam-duration');
    const descLabel = document.getElementById('desc-label');
    const modalTitle = document.getElementById('modal-title');

    const typeNames = { exam: 'ì‹œí—˜', quiz: 'í€´ì¦ˆ', assignment: 'ê³¼ì œ' };
    if (modalTitle) modalTitle.textContent = `ì˜¨ë¼ì¸ ${typeNames[examType]} ë“±ë¡`;
    if (descLabel) descLabel.textContent = typeNames[examType];

    if (examType === 'assignment') {
        // ê³¼ì œ: ë§ˆê°ì¼ ì„¤ì • í‘œì‹œ, ì‹œê°„ ì„¤ì • ìˆ¨ê¹€
        if (durationSection) durationSection.classList.add('hidden');
        if (deadlineSection) deadlineSection.classList.remove('hidden');
        // ê¸°ë³¸ ë§ˆê°ì¼: 7ì¼ í›„ 23:59
        const deadline = document.getElementById('exam-deadline');
        if (deadline && !deadline.value) {
            const d = new Date();
            d.setDate(d.getDate() + 7);
            d.setHours(23, 59);
            deadline.value = d.toISOString().slice(0, 16);
        }
    } else {
        // ì‹œí—˜/í€´ì¦ˆ: ì‹œê°„ ì„¤ì • í‘œì‹œ, ë§ˆê°ì¼ ìˆ¨ê¹€
        if (durationSection) durationSection.classList.remove('hidden');
        if (deadlineSection) deadlineSection.classList.add('hidden');

        if (examType === 'quiz') {
            if (durationLabel) durationLabel.textContent = 'í€´ì¦ˆ';
            if (durationHint) durationHint.classList.remove('hidden');
            if (durationInput) durationInput.value = 5;
        } else {
            if (durationLabel) durationLabel.textContent = 'ì‹œí—˜';
            if (durationHint) durationHint.classList.add('hidden');
            if (durationInput) durationInput.value = 60;
        }
    }
}

function closeCreateExamModal() {
    const modal = document.getElementById('create-exam-modal');
    if (modal) modal.remove();
}

async function submitCreateOnlineExam() {
    const examType = document.querySelector('input[name="exam-type"]:checked')?.value || 'exam';
    const examBankId = document.getElementById('exam-bank-select').value;
    const title = document.getElementById('exam-title').value.trim();
    const courseCode = document.getElementById('exam-course').value;
    const duration = parseInt(document.getElementById('exam-duration').value) || 60;
    const passScore = parseInt(document.getElementById('exam-pass-score').value) || 60;
    const description = document.getElementById('exam-description').value.trim();
    const deadline = document.getElementById('exam-deadline')?.value;

    if (!examBankId || !title || !courseCode) {
        showAlert('ë¬¸ì œì€í–‰, ì œëª©, ê³¼ì •ì„ ëª¨ë‘ ì„ íƒ/ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    // ê³¼ì œí˜•ì¼ ë•Œ ë§ˆê°ì¼ í•„ìˆ˜
    if (examType === 'assignment' && !deadline) {
        showAlert('ê³¼ì œ ë§ˆê°ì¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    try {
        const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
        const requestData = {
            exam_type: examType,
            exam_bank_id: parseInt(examBankId),
            title: title,
            course_code: courseCode,
            instructor_code: instructor.code || 'admin',
            duration: duration,
            pass_score: passScore,
            description: description
        };

        // ê³¼ì œí˜•ì¼ ë•Œ deadline ì¶”ê°€
        if (examType === 'assignment' && deadline) {
            requestData.deadline = deadline.replace('T', ' ') + ':00';
        }

        const response = await axios.post(`${API_BASE_URL}/api/online-exams`, requestData);

        if (response.data.success) {
            closeCreateExamModal();
            const typeText = { exam: 'ì‹œí—˜', quiz: 'í€´ì¦ˆ', assignment: 'ê³¼ì œ' }[examType];
            showAlert(`ì˜¨ë¼ì¸ ${typeText}ì´(ê°€) ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

            // ê³¼ì œë©´ ê³¼ì œê´€ë¦¬ë¡œ, ì‹œí—˜/í€´ì¦ˆë©´ ì˜¨ë¼ì¸ì‹œí—˜ìœ¼ë¡œ ì´ë™
            if (examType === 'assignment') {
                await showAssignments();
            } else {
                await showOnlineExam();
            }
        }
    } catch (error) {
        console.error('ë“±ë¡ ì‹¤íŒ¨:', error);
        showAlert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function openWaitingRoom(examId) {
    const confirmed = await showConfirm('ëŒ€ê¸°ì‹¤ì„ ì˜¤í”ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>í•™ìƒë“¤ì´ ëŒ€ê¸°ì‹¤ì— ì…ì¥í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.', 'ëŒ€ê¸°ì‹¤ ì˜¤í”ˆ');
    if (!confirmed) return;

    try {
        const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/open-waiting`, {});
        if (response.data.success) {
            showAlert('ëŒ€ê¸°ì‹¤ì´ ì˜¤í”ˆë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await loadOnlineExamList();
        }
    } catch (error) {
        console.error('ëŒ€ê¸°ì‹¤ ì˜¤í”ˆ ì‹¤íŒ¨:', error);
        showAlert('ëŒ€ê¸°ì‹¤ ì˜¤í”ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function startOnlineExam(examId) {
    const confirmed = await showConfirm('ì‹œí—˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  í•™ìƒì—ê²Œ ì‹œí—˜ì§€ê°€ ê³µê°œë©ë‹ˆë‹¤.', 'ì‹œí—˜ ì‹œì‘');
    if (!confirmed) return;

    try {
        const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/start`, {});
        if (response.data.success) {
            showAlert('ì‹œí—˜ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            await loadOnlineExamList();
            showExamMonitor(examId);
        }
    } catch (error) {
        console.error('ì‹œí—˜ ì‹œì‘ ì‹¤íŒ¨:', error);
        showAlert(error.response?.data?.detail || 'ì‹œí—˜ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function endOnlineExam(examId, examType = null, skipConfirm = false) {
    if (!skipConfirm) {
        const typeText = examType === 'quiz' ? 'í€´ì¦ˆ' : 'ì‹œí—˜';
        const confirmed = await showConfirm(`${typeText}ì„(ë¥¼) ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ë¯¸ì œì¶œ í•™ìƒì€ í˜„ì¬ ìƒíƒœë¡œ ìë™ ì œì¶œë©ë‹ˆë‹¤.`, `${typeText} ì¢…ë£Œ`);
        if (!confirmed) return;
    }

    try {
        const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/end`, {});
        if (response.data.success) {
            if (onlineExamMonitorInterval) {
                clearInterval(onlineExamMonitorInterval);
                onlineExamMonitorInterval = null;
            }

            // examType ì •ë³´ê°€ ì—†ìœ¼ë©´ APIì—ì„œ ê°€ì ¸ì˜´
            if (!examType) {
                try {
                    const examRes = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}`);
                    examType = examRes.data.exam?.exam_type;
                } catch (e) {
                    console.error('exam type ì¡°íšŒ ì‹¤íŒ¨', e);
                }
            }

            // í€´ì¦ˆì¸ ê²½ìš° ìë™ ì±„ì  í›„ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ
            if (examType === 'quiz') {
                showAlert('í€´ì¦ˆê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ ì±„ì ì„ ì§„í–‰í•©ë‹ˆë‹¤...', 'info');
                try {
                    await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/grade`, {});
                    showAlert('ì±„ì ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    await showExamResults(examId);
                } catch (gradeError) {
                    console.error('ìë™ ì±„ì  ì‹¤íŒ¨:', gradeError);
                    showAlert('ì±„ì ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    await loadOnlineExamList();
                }
            } else {
                showAlert('ì‹œí—˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                await loadOnlineExamList();
            }
        }
    } catch (error) {
        console.error('ì¢…ë£Œ ì‹¤íŒ¨:', error);
        showAlert('ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function closeAssignment(examId) {
    const confirmed = await showConfirm('ê³¼ì œë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ë§ˆê° í›„ì—ëŠ” í•™ìƒë“¤ì´ ë” ì´ìƒ ì œì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'ê³¼ì œ ë§ˆê°');
    if (!confirmed) return;

    try {
        const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/end`, {});
        if (response.data.success) {
            showAlert('ê³¼ì œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await loadOnlineExamList();
        }
    } catch (error) {
        console.error('ë§ˆê° ì‹¤íŒ¨:', error);
        showAlert('ë§ˆê°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function gradeOnlineExam(examId) {
    const confirmed = await showConfirm('ìë™ ì±„ì ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'ìë™ ì±„ì ');
    if (!confirmed) return;

    try {
        const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/grade`, {});
        if (response.data.success) {
            showAlert(`${response.data.graded_count}ëª…ì˜ ë‹µì•ˆì´ ì±„ì ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            await loadOnlineExamList();
        }
    } catch (error) {
        console.error('ì±„ì  ì‹¤íŒ¨:', error);
        showAlert('ì±„ì ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function deleteOnlineExam(examId) {
    const confirmed = await showConfirm('ì´ ì‹œí—˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì‚­ì œëœ ì‹œí—˜ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'ì‹œí—˜ ì‚­ì œ');
    if (!confirmed) return;

    try {
        const response = await axios.delete(`${API_BASE_URL}/api/online-exams/${examId}`);
        if (response.data.success) {
            showAlert('ì‹œí—˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await loadOnlineExamList();
        }
    } catch (error) {
        console.error('ì‹œí—˜ ì‚­ì œ ì‹¤íŒ¨:', error);
        showAlert(error.response?.data?.detail || 'ì‹œí—˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

async function showExamMonitor(examId) {
    const app = document.getElementById('app');

    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-tv mr-2"></i>ì‹œí—˜ ëª¨ë‹ˆí„°ë§
                </h2>
                <button onclick="showOnlineExam()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>ëª©ë¡ìœ¼ë¡œ
                </button>
            </div>
            <div id="monitor-content">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                </div>
            </div>
        </div>
    `;

    await updateExamMonitor(examId);

    // 3ì´ˆë§ˆë‹¤ ê°±ì‹ 
    if (onlineExamMonitorInterval) clearInterval(onlineExamMonitorInterval);
    onlineExamMonitorInterval = setInterval(() => updateExamMonitor(examId), 3000);
}

async function updateExamMonitor(examId) {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}/monitor`);
        const { exam, participants, stats, remaining_seconds } = response.data;

        const statusLabels = {
            'waiting': 'ëŒ€ê¸°ì¤‘', 'taking': 'ì‘ì‹œì¤‘', 'submitted': 'ì œì¶œì™„ë£Œ', 'graded': 'ì±„ì ì™„ë£Œ'
        };

        const formatTime = (seconds) => {
            if (seconds === null) return '--:--';
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const container = document.getElementById('monitor-content');
        if (!container) return;

        container.innerHTML = `
            <div class="mb-6">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">${exam.title}</h3>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <span><i class="fas fa-book mr-1"></i>${exam.exam_bank_name}</span>
                        <span><i class="fas fa-clock mr-1"></i>${exam.duration}ë¶„</span>
                        <span><i class="fas fa-question-circle mr-1"></i>${exam.total_questions}ë¬¸í•­</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-gray-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-gray-700">${stats.total_students}</div>
                    <div class="text-sm text-gray-500">ì „ì²´ í•™ìƒ</div>
                </div>
                <div class="bg-yellow-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-700">${stats.entered_count}</div>
                    <div class="text-sm text-yellow-600">ì…ì¥</div>
                </div>
                <div class="bg-green-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-700">${stats.taking_count}</div>
                    <div class="text-sm text-green-600">ì‘ì‹œì¤‘</div>
                </div>
                <div class="bg-blue-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-blue-700">${stats.submitted_count}</div>
                    <div class="text-sm text-blue-600">ì œì¶œì™„ë£Œ</div>
                </div>
                <div class="bg-red-100 rounded-lg p-4 text-center ${remaining_seconds !== null && remaining_seconds <= 60 ? 'animate-pulse' : ''}">
                    <div class="text-3xl font-bold text-red-700">${formatTime(remaining_seconds)}</div>
                    <div class="text-sm text-red-600">ë‚¨ì€ ì‹œê°„</div>
                </div>
            </div>

            <div class="flex space-x-2 mb-4">
                ${exam.status === 'waiting' ? `
                    <button onclick="startOnlineExam(${examId})" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg">
                        <i class="fas fa-play mr-2"></i>ì‹œí—˜ ì‹œì‘
                    </button>
                ` : ''}
                ${exam.status === 'ongoing' ? `
                    <button onclick="endOnlineExam(${examId}, '${exam.exam_type || 'exam'}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">
                        <i class="fas fa-stop mr-2"></i>${exam.exam_type === 'quiz' ? 'í€´ì¦ˆ' : 'ì‹œí—˜'} ì¢…ë£Œ
                    </button>
                ` : ''}
            </div>

            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-700 mb-3"><i class="fas fa-users mr-2"></i>ì‘ì‹œì í˜„í™©</h4>
                ${participants.length === 0 ? `
                    <p class="text-gray-500 text-center py-4">ì•„ì§ ì…ì¥í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                ` : `
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                        ${participants.map(p => {
                            const statusColor = {
                                'waiting': 'bg-yellow-200 border-yellow-400',
                                'taking': 'bg-green-200 border-green-400',
                                'submitted': 'bg-blue-200 border-blue-400',
                                'graded': 'bg-purple-200 border-purple-400'
                            }[p.status] || 'bg-gray-200';
                            return `
                                <div class="p-2 rounded border-2 ${statusColor} text-center">
                                    <div class="font-medium text-sm">${p.student_name}</div>
                                    <div class="text-xs text-gray-600">${statusLabels[p.status]}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
        `;

        // íƒ€ì´ë¨¸ê°€ 0ì´ ë˜ë©´ ìë™ ì¢…ë£Œ
        if (exam.status === 'ongoing' && remaining_seconds !== null && remaining_seconds <= 0) {
            if (onlineExamMonitorInterval) {
                clearInterval(onlineExamMonitorInterval);
                onlineExamMonitorInterval = null;
            }
            showAlert('ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì–´ ìë™ ì¢…ë£Œë©ë‹ˆë‹¤.', 'info');
            await autoEndOnlineExam(examId);
            return;
        }

        // ì‹œí—˜ì´ ì¢…ë£Œë˜ë©´ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ ë° ëª©ë¡ìœ¼ë¡œ ì´ë™
        if (exam.status === 'ended' || exam.status === 'graded') {
            if (onlineExamMonitorInterval) {
                clearInterval(onlineExamMonitorInterval);
                onlineExamMonitorInterval = null;
            }
            // ì¢…ë£Œ ìƒíƒœë©´ 3ì´ˆ í›„ ëª©ë¡ìœ¼ë¡œ ì´ë™
            setTimeout(() => {
                showOnlineExam();
            }, 3000);
        }
    } catch (error) {
        console.error('ëª¨ë‹ˆí„°ë§ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    }
}

// ì‹œí—˜ ìë™ ì¢…ë£Œ (íƒ€ì´ë¨¸ ë§Œë£Œ ì‹œ)
async function autoEndOnlineExam(examId) {
    try {
        // ë¨¼ì € ì‹œí—˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜´
        let examType = null;
        try {
            const examRes = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}`);
            examType = examRes.data.exam?.exam_type;
        } catch (e) {}

        const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/end`, {});
        if (response.data.success) {
            // í€´ì¦ˆì¸ ê²½ìš° ìë™ ì±„ì  í›„ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ
            if (examType === 'quiz') {
                showAlert('í€´ì¦ˆê°€ ìë™ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì±„ì ì„ ì§„í–‰í•©ë‹ˆë‹¤...', 'info');
                try {
                    await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/grade`, {});
                    showAlert('ì±„ì ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    await showExamResults(examId);
                } catch (gradeError) {
                    console.error('ìë™ ì±„ì  ì‹¤íŒ¨:', gradeError);
                    showOnlineExam();
                }
            } else {
                showAlert('ì‹œí—˜ì´ ìë™ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                setTimeout(() => {
                    showOnlineExam();
                }, 2000);
            }
        }
    } catch (error) {
        console.error('ìë™ ì¢…ë£Œ ì‹¤íŒ¨:', error);
        showOnlineExam();
    }
}

async function showExamResults(examId) {
    const app = document.getElementById('app');

    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-chart-bar mr-2"></i>ì‹œí—˜ ê²°ê³¼
                </h2>
                <button onclick="showOnlineExam()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>ëª©ë¡ìœ¼ë¡œ
                </button>
            </div>
            <div id="results-content">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                </div>
            </div>
        </div>
    `;

    try {
        const response = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}/results`);
        const { exam, results, stats } = response.data;

        const container = document.getElementById('results-content');
        const isQuiz = exam.exam_type === 'quiz';
        const typeText = isQuiz ? 'í€´ì¦ˆ' : 'ì‹œí—˜';

        // í€´ì¦ˆì¸ ê²½ìš° ì •ë‹µì/ì˜¤ë‹µì ë¶„ë¦¬
        let correctStudents = [];
        let incorrectStudents = [];
        if (isQuiz) {
            correctStudents = results.filter(r => r.is_all_correct);
            incorrectStudents = results.filter(r => !r.is_all_correct);
        }

        // ì œëª© ì—…ë°ì´íŠ¸
        document.querySelector('h2').innerHTML = `<i class="fas fa-chart-bar mr-2"></i>${typeText} ê²°ê³¼`;

        if (isQuiz) {
            // í€´ì¦ˆìš© ê²°ê³¼ í™”ë©´
            container.innerHTML = `
                <div class="mb-6">
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg p-6">
                        <h3 class="text-2xl font-bold mb-2">${exam.title}</h3>
                        <div class="text-sm opacity-90">${exam.exam_bank_name} | ${exam.total_questions}ë¬¸í•­</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-gray-700">${stats.total_count}ëª…</div>
                        <div class="text-sm text-gray-500">ì‘ì‹œì</div>
                    </div>
                    <div class="bg-green-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-700">${correctStudents.length}ëª…</div>
                        <div class="text-sm text-green-600">ì „ë¶€ ì •ë‹µ</div>
                    </div>
                    <div class="bg-red-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-700">${incorrectStudents.length}ëª…</div>
                        <div class="text-sm text-red-600">ì˜¤ë‹µ ìˆìŒ</div>
                    </div>
                    <div class="bg-blue-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-700">${stats.average_score}ì </div>
                        <div class="text-sm text-blue-600">í‰ê· </div>
                    </div>
                </div>

                <!-- ì •ë‹µì ì„¹ì…˜ -->
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-green-700 mb-3 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>ì „ë¶€ ì •ë‹µ (${correctStudents.length}ëª…)
                    </h4>
                    ${correctStudents.length > 0 ? `
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${correctStudents.map(r => {
                                    const rankIcon = r.rank === 1 ? 'ğŸ¥‡' : r.rank === 2 ? 'ğŸ¥ˆ' : r.rank === 3 ? 'ğŸ¥‰' : `${r.rank}ìœ„`;
                                    return `
                                        <div class="bg-white rounded-lg p-3 shadow-sm border-l-4 border-green-500 flex items-center justify-between">
                                            <div class="flex items-center">
                                                <span class="text-2xl mr-3">${rankIcon}</span>
                                                <div>
                                                    <div class="font-bold text-gray-800">${r.student_name}</div>
                                                    <div class="text-xs text-gray-500">${r.student_code || ''}</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-medium text-green-600">${r.score}ì </div>
                                                <div class="text-xs text-gray-500">${r.submitted_at ? new Date(r.submitted_at).toLocaleTimeString('ko-KR') : '-'}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-gray-100 rounded-lg p-4 text-center text-gray-500">
                            ì „ë¶€ ì •ë‹µì¸ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤
                        </div>
                    `}
                </div>

                <!-- ì˜¤ë‹µì ì„¹ì…˜ -->
                <div>
                    <h4 class="text-lg font-bold text-red-700 mb-3 flex items-center">
                        <i class="fas fa-times-circle mr-2"></i>ì˜¤ë‹µ ìˆìŒ (${incorrectStudents.length}ëª…)
                    </h4>
                    ${incorrectStudents.length > 0 ? `
                        <div class="bg-red-50 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${incorrectStudents.map(r => `
                                    <div class="bg-white rounded-lg p-3 shadow-sm border-l-4 border-red-400 flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-gray-800">${r.student_name}</div>
                                            <div class="text-xs text-gray-500">${r.student_code || ''}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-medium text-red-600">${r.score}ì  (${r.correct_count}/${r.total_questions})</div>
                                            <div class="text-xs text-gray-500">${r.submitted_at ? new Date(r.submitted_at).toLocaleTimeString('ko-KR') : '-'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-gray-100 rounded-lg p-4 text-center text-gray-500">
                            ì˜¤ë‹µì´ ìˆëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤
                        </div>
                    `}
                </div>
            `;
        } else {
            // ê¸°ì¡´ ì‹œí—˜ ê²°ê³¼ í™”ë©´
            container.innerHTML = `
                <div class="mb-6">
                    <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-lg p-6">
                        <h3 class="text-2xl font-bold mb-2">${exam.title}</h3>
                        <div class="text-sm opacity-90">${exam.exam_bank_name} | ${exam.total_questions}ë¬¸í•­</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                    <div class="bg-gray-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-gray-700">${stats.total_count}ëª…</div>
                        <div class="text-sm text-gray-500">ì‘ì‹œì</div>
                    </div>
                    <div class="bg-blue-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-700">${stats.average_score}ì </div>
                        <div class="text-sm text-blue-600">í‰ê· </div>
                    </div>
                    <div class="bg-green-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-700">${stats.max_score}ì </div>
                        <div class="text-sm text-green-600">ìµœê³ </div>
                    </div>
                    <div class="bg-red-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-700">${stats.min_score}ì </div>
                        <div class="text-sm text-red-600">ìµœì €</div>
                    </div>
                    <div class="bg-green-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-700">${stats.pass_count}ëª…</div>
                        <div class="text-sm text-green-600">í•©ê²©</div>
                    </div>
                    <div class="bg-red-100 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-700">${stats.fail_count}ëª…</div>
                        <div class="text-sm text-red-600">ë¶ˆí•©ê²©</div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500">ìˆœìœ„</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">í•™ìƒ</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500">ì ìˆ˜</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500">ì •ë‹µ</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500">í•©ê²©ì—¬ë¶€</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500">ì œì¶œì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${results.sort((a, b) => b.score - a.score).map((r, i) => `
                                <tr class="${r.is_passed ? 'bg-green-50' : 'bg-red-50'}">
                                    <td class="px-4 py-3 text-center font-bold ${i < 3 ? 'text-yellow-600' : ''}">${i + 1}</td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium">${r.student_name}</div>
                                        <div class="text-xs text-gray-500">${r.student_code || ''}</div>
                                    </td>
                                    <td class="px-4 py-3 text-center text-lg font-bold">${r.score}ì </td>
                                    <td class="px-4 py-3 text-center">${r.correct_count}/${r.total_questions}</td>
                                    <td class="px-4 py-3 text-center">
                                        ${r.is_passed ?
                                            '<span class="px-2 py-1 bg-green-200 text-green-800 rounded-full text-xs">í•©ê²©</span>' :
                                            '<span class="px-2 py-1 bg-red-200 text-red-800 rounded-full text-xs">ë¶ˆí•©ê²©</span>'}
                                    </td>
                                    <td class="px-4 py-3 text-center text-sm text-gray-500">
                                        ${r.submitted_at ? new Date(r.submitted_at).toLocaleTimeString('ko-KR') : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    } catch (error) {
        console.error('ì‹œí—˜ ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
        showAlert('ì‹œí—˜ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ==================== ì„ ì°©ìˆœ í€´ì¦ˆ ====================
function showQuickQuiz() {
    const app = document.getElementById('app');

    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-bolt mr-2"></i>ì„ ì°©ìˆœ í€´ì¦ˆ
                </h2>
                <div class="space-x-2">
                    <button onclick="createQuickQuiz()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>í€´ì¦ˆ ë“±ë¡
                    </button>
                </div>
            </div>

            <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                <i class="fas fa-bolt text-6xl text-yellow-400 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">ì„ ì°©ìˆœ í€´ì¦ˆ</h3>
                <p class="text-gray-600 mb-4">
                    ìˆ˜ì—… ì¤‘ ì‹¤ì‹œê°„ìœ¼ë¡œ í€´ì¦ˆë¥¼ ì§„í–‰í•˜ê³  ê°€ì¥ ë¹ ë¥´ê²Œ ì •ë‹µì„ ë§íŒ í•™ìƒì—ê²Œ í¬ì¸íŠ¸ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.<br>
                    í•™ìƒë“¤ì˜ ì§‘ì¤‘ë„ì™€ ì°¸ì—¬ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-white rounded-lg p-4 shadow">
                        <i class="fas fa-stopwatch text-3xl text-red-500 mb-2"></i>
                        <h4 class="font-semibold">ì‹¤ì‹œê°„ ì§„í–‰</h4>
                        <p class="text-sm text-gray-500">ì¦‰ì„ì—ì„œ í€´ì¦ˆ ì§„í–‰</p>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <i class="fas fa-trophy text-3xl text-yellow-500 mb-2"></i>
                        <h4 class="font-semibold">ìˆœìœ„ ê¸°ë¡</h4>
                        <p class="text-sm text-gray-500">ì •ë‹µì ìˆœìœ„ ìë™ ê¸°ë¡</p>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <i class="fas fa-star text-3xl text-purple-500 mb-2"></i>
                        <h4 class="font-semibold">í¬ì¸íŠ¸ ì§€ê¸‰</h4>
                        <p class="text-sm text-gray-500">ì„ ì°©ìˆœ í¬ì¸íŠ¸ ì§€ê¸‰</p>
                    </div>
                </div>
                <p class="text-gray-400 text-sm mt-6">
                    <i class="fas fa-tools mr-1"></i>ê¸°ëŠ¥ ê°œë°œ ì¤‘...
                </p>
            </div>
        </div>
    `;
}

function createQuickQuiz() {
    showAlert('ì„ ì°©ìˆœ í€´ì¦ˆ ë“±ë¡ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info', { title: 'ì¤€ë¹„ ì¤‘' });
}

// ==================== ê³¼ì œê´€ë¦¬ ====================
async function showAssignments() {
    const app = document.getElementById('app');

    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-tasks mr-2"></i>ê³¼ì œê´€ë¦¬
                </h2>
                <div class="space-x-2">
                    <button onclick="createAssignment()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>ê³¼ì œ ë“±ë¡
                    </button>
                </div>
            </div>
            <div id="assignment-list-content">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                </div>
            </div>
        </div>
    `;

    await loadAssignmentList();
}

async function loadAssignmentList() {
    try {
        const instructor = JSON.parse(sessionStorage.getItem('instructor') || '{}');
        const response = await axios.get(`${API_BASE_URL}/api/online-exams`);
        // ê³¼ì œë§Œ í•„í„°ë§
        const assignments = (response.data.exams || []).filter(e => e.exam_type === 'assignment');

        const container = document.getElementById('assignment-list-content');
        if (!container) return;

        if (assignments.length === 0) {
            container.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-8 text-center">
                    <i class="fas fa-tasks text-6xl text-green-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p class="text-gray-500 mb-4">ìƒˆ ê³¼ì œë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”.</p>
                    <button onclick="createAssignment()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>ê³¼ì œ ë“±ë¡
                    </button>
                </div>
            `;
            return;
        }

        const statusLabels = { 'ongoing': 'ì§„í–‰ì¤‘', 'ended': 'ë§ˆê°ë¨', 'graded': 'ì±„ì ì™„ë£Œ' };
        const statusColors = {
            'ongoing': 'bg-green-100 text-green-700',
            'ended': 'bg-gray-100 text-gray-600',
            'graded': 'bg-purple-100 text-purple-700'
        };

        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ê³¼ì œëª…</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ê³¼ì •</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">ë§ˆê°ì¼</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">ì œì¶œí˜„í™©</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">ìƒíƒœ</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${assignments.map(a => {
                            const deadline = a.deadline ? new Date(a.deadline) : null;
                            const isOverdue = deadline && deadline < new Date();
                            const deadlineStr = deadline ? deadline.toLocaleString('ko-KR', {
                                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                            }) : '-';

                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-800">${a.title}</div>
                                        <div class="text-xs text-gray-500">${a.exam_bank_name || ''}</div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${a.course_name || a.course_code}</td>
                                    <td class="px-4 py-3 text-center text-sm ${isOverdue ? 'text-red-600' : 'text-gray-600'}">
                                        ${deadlineStr}
                                        ${isOverdue ? '<br><span class="text-xs text-red-500">ë§ˆê°ë¨</span>' : ''}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="text-sm font-medium">${a.submitted_count || 0}</span>
                                        <span class="text-gray-400">/</span>
                                        <span class="text-sm text-gray-500">${a.total_students || '-'}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 text-xs rounded-full ${statusColors[a.status] || 'bg-gray-100'}">${statusLabels[a.status] || a.status}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex justify-center gap-1">
                                            <button onclick="showAssignmentGrading(${a.id})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded" title="ì œì¶œí˜„í™©/ì±„ì ">
                                                <i class="fas fa-list-check"></i>
                                            </button>
                                            ${a.status === 'ongoing' ? `
                                                <button onclick="closeAssignment(${a.id})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded" title="ë§ˆê°">
                                                    <i class="fas fa-lock"></i>
                                                </button>
                                            ` : ''}
                                            <button onclick="deleteOnlineExam(${a.id})" class="px-2 py-1 bg-gray-400 hover:bg-gray-500 text-white text-xs rounded" title="ì‚­ì œ">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('ê³¼ì œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        const container = document.getElementById('assignment-list-content');
        if (container) {
            container.innerHTML = '<p class="text-red-500 text-center py-4">ê³¼ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
}

async function createAssignment() {
    // ì˜¨ë¼ì¸ ì‹œí—˜ ë“±ë¡ ëª¨ë‹¬ì„ ì—´ê³  ê³¼ì œ ìœ í˜•ì„ ì„ íƒ
    await showCreateOnlineExamModal();
    // ëª¨ë‹¬ì´ ì—´ë¦° í›„ ê³¼ì œ ìœ í˜• ì„ íƒ
    setTimeout(() => {
        const assignmentRadio = document.querySelector('input[name="exam-type"][value="assignment"]');
        if (assignmentRadio) {
            assignmentRadio.checked = true;
            updateExamTypeUI();
        }
    }, 100);
}

// ê³¼ì œ ì±„ì  í™”ë©´
async function showAssignmentGrading(examId) {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-tasks mr-2"></i>ê³¼ì œ ì±„ì 
                </h2>
                <button onclick="showAssignments()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>ëª©ë¡ìœ¼ë¡œ
                </button>
            </div>
            <div id="grading-content">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                </div>
            </div>
        </div>
    `;

    await loadAssignmentGradingContent(examId);
}

async function loadAssignmentGradingContent(examId) {
    try {
        const response = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}/monitor`);
        const { exam, participants, stats } = response.data;

        const container = document.getElementById('grading-content');
        if (!container) return;

        const deadline = exam.deadline ? new Date(exam.deadline) : null;
        const deadlineStr = deadline ? deadline.toLocaleString('ko-KR') : '-';

        container.innerHTML = `
            <div class="mb-6 p-4 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-lg">
                <h3 class="text-xl font-bold">${exam.title}</h3>
                <div class="flex gap-6 mt-2 text-sm">
                    <span><i class="fas fa-calendar-alt mr-1"></i>ë§ˆê°: ${deadlineStr}</span>
                    <span><i class="fas fa-users mr-1"></i>ì œì¶œ: ${stats.submitted_count}/${stats.total_students}ëª…</span>
                </div>
            </div>

            ${participants.length === 0 ? `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-4"></i>
                    <p>ì•„ì§ ì œì¶œí•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            ` : `
                <form id="grading-form">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">í•™ìƒ</th>
                                <th class="px-4 py-3 text-center">ì œì¶œì¼ì‹œ</th>
                                <th class="px-4 py-3 text-center">ì œì¶œë¬¼</th>
                                <th class="px-4 py-3 text-center" style="width: 120px;">ì ìˆ˜ (100ì )</th>
                                <th class="px-4 py-3 text-left">í”¼ë“œë°±</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${participants.map(p => {
                                const submittedAt = p.submitted_at ? new Date(p.submitted_at).toLocaleString('ko-KR', {
                                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                }) : '-';
                                const hasFile = p.file_name && p.file_path;
                                const answerText = p.answers ? (typeof p.answers === 'string' ? p.answers : JSON.stringify(p.answers)) : '';

                                return `
                                    <tr class="hover:bg-gray-50" data-participant-id="${p.id}">
                                        <td class="px-4 py-3">
                                            <div class="font-medium">${p.student_name}</div>
                                            <div class="text-xs text-gray-500">${p.student_code || ''}</div>
                                        </td>
                                        <td class="px-4 py-3 text-center text-sm ${p.status === 'submitted' || p.status === 'graded' ? 'text-green-600' : 'text-gray-400'}">
                                            ${p.status === 'submitted' || p.status === 'graded' ? submittedAt : 'ë¯¸ì œì¶œ'}
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            ${hasFile ? `
                                                <a href="${API_BASE_URL}/api/assignments/download/${encodeURIComponent(p.file_name)}"
                                                   class="text-blue-600 hover:underline text-sm" target="_blank">
                                                    <i class="fas fa-download mr-1"></i>${p.file_name.split('_').slice(3).join('_') || p.file_name}
                                                </a>
                                            ` : answerText ? `
                                                <button type="button" onclick="showAnswerText('${encodeURIComponent(answerText)}')"
                                                        class="text-blue-600 hover:underline text-sm">
                                                    <i class="fas fa-file-alt mr-1"></i>ë‚´ìš©ë³´ê¸°
                                                </button>
                                            ` : '<span class="text-gray-400 text-sm">-</span>'}
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <input type="number" name="score_${p.id}" value="${p.score || ''}"
                                                   min="0" max="100" class="w-20 border rounded px-2 py-1 text-center"
                                                   ${p.status !== 'submitted' && p.status !== 'graded' ? 'disabled' : ''}>
                                        </td>
                                        <td class="px-4 py-3">
                                            <input type="text" name="feedback_${p.id}" value="${p.feedback || ''}"
                                                   class="w-full border rounded px-2 py-1 text-sm"
                                                   placeholder="í”¼ë“œë°± ì…ë ¥..."
                                                   ${p.status !== 'submitted' && p.status !== 'graded' ? 'disabled' : ''}>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div class="mt-6 text-center">
                        <button type="button" onclick="saveAllGrades(${examId})"
                                class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold">
                            <i class="fas fa-save mr-2"></i>ì±„ì  ì €ì¥
                        </button>
                    </div>
                </form>
            `}
        `;
    } catch (error) {
        console.error('ê³¼ì œ ì±„ì  ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        const container = document.getElementById('grading-content');
        if (container) {
            container.innerHTML = '<p class="text-red-500 text-center py-4">ì±„ì  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
}

// ë‹µë³€ í…ìŠ¤íŠ¸ ë³´ê¸°
window.showAnswerText = function(encodedText) {
    const text = decodeURIComponent(encodedText);
    showAlert(text.replace(/\\n/g, '<br>'), 'info', { title: 'ë‹µë³€ ë‚´ìš©' });
};

// ëª¨ë“  ì ìˆ˜ ì €ì¥
async function saveAllGrades(examId) {
    try {
        const grades = [];
        document.querySelectorAll('#grading-form tr[data-participant-id]').forEach(row => {
            const participantId = row.dataset.participantId;
            const scoreInput = row.querySelector(`input[name="score_${participantId}"]`);
            const feedbackInput = row.querySelector(`input[name="feedback_${participantId}"]`);

            if (scoreInput && !scoreInput.disabled && scoreInput.value !== '') {
                grades.push({
                    participant_id: parseInt(participantId),
                    score: parseFloat(scoreInput.value) || 0,
                    feedback: feedbackInput?.value || ''
                });
            }
        });

        if (grades.length === 0) {
            showAlert('ì €ì¥í•  ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/grade-all-assignments`, { grades });

        if (response.data.success) {
            showAlert(response.data.message, 'success');
            await loadAssignmentGradingContent(examId);
        }
    } catch (error) {
        console.error('ì±„ì  ì €ì¥ ì‹¤íŒ¨:', error);
        showAlert('ì±„ì  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

console.log('âœ… ë¬¸ì„œê´€ë¦¬ ë° ë¬¸ì œì€í–‰ í•¨ìˆ˜ ë¡œë“œ ì™„ë£Œ');

// ==================== ì‹œìŠ¤í…œ ì—°ê²° í…ŒìŠ¤íŠ¸ ====================

// DB ì—°ê²° í…ŒìŠ¤íŠ¸
window.testDatabaseConnection = async function() {
    const resultDiv = document.getElementById('db-test-result');
    resultDiv.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-yellow-600');
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
    resultDiv.classList.add('text-blue-600');

    try {
        const response = await axios.get(`${API_BASE_URL}/api/test/database`);

        if (response.data.success) {
            resultDiv.classList.remove('text-blue-600');
            resultDiv.classList.add('text-green-600');
            resultDiv.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                <strong>âœ… ì—°ê²° ì„±ê³µ!</strong>
                <div class="mt-1 ml-6 text-xs">
                    <div>â€¢ ì„œë²„: ${response.data.host || 'localhost'}</div>
                    <div>â€¢ ë°ì´í„°ë² ì´ìŠ¤: ${response.data.database || 'minilms'}</div>
                    <div>â€¢ ì‘ë‹µ ì‹œê°„: ${response.data.response_time || '0'}ms</div>
                    <div>â€¢ ìƒíƒœ: ${response.data.message || 'ì •ìƒ'}</div>
                </div>
            `;
        } else {
            throw new Error(response.data.message || 'ì—°ê²° ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('DB í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        resultDiv.classList.remove('text-blue-600');
        resultDiv.classList.add('text-red-600');

        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        resultDiv.innerHTML = `
            <i class="fas fa-times-circle mr-2"></i>
            <strong>âŒ ì—°ê²° ì‹¤íŒ¨</strong>
            <div class="mt-1 ml-6 text-xs">
                ${errorMsg}
            </div>
        `;
    }
};

// FTP ì—°ê²° í…ŒìŠ¤íŠ¸
window.testFtpConnection = async function() {
    const resultDiv = document.getElementById('ftp-test-result');
    resultDiv.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-yellow-600');
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>FTP ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
    resultDiv.classList.add('text-blue-600');

    try {
        const response = await axios.get(`${API_BASE_URL}/api/test/ftp`);

        if (response.data.success) {
            resultDiv.classList.remove('text-blue-600');
            resultDiv.classList.add('text-green-600');
            resultDiv.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                <strong>âœ… ì—°ê²° ì„±ê³µ!</strong>
                <div class="mt-1 ml-6 text-xs">
                    <div>â€¢ ì„œë²„: ${response.data.host || 'localhost'}</div>
                    <div>â€¢ í¬íŠ¸: ${response.data.port || '21'}</div>
                    <div>â€¢ ì‚¬ìš©ì: ${response.data.user || 'minilms_ftp'}</div>
                    <div>â€¢ ì‘ë‹µ ì‹œê°„: ${response.data.response_time || '0'}ms</div>
                    <div>â€¢ ìƒíƒœ: ${response.data.message || 'ì •ìƒ'}</div>
                </div>
            `;
        } else {
            throw new Error(response.data.message || 'ì—°ê²° ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('FTP í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        resultDiv.classList.remove('text-blue-600');
        resultDiv.classList.add('text-red-600');

        const errorMsg = error.response?.data?.detail || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        resultDiv.innerHTML = `
            <i class="fas fa-times-circle mr-2"></i>
            <strong>âŒ ì—°ê²° ì‹¤íŒ¨</strong>
            <div class="mt-1 ml-6 text-xs">
                ${errorMsg}
            </div>
        `;
    }
};

console.log('âœ… ì‹œìŠ¤í…œ ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ë¡œë“œ ì™„ë£Œ');

// ==================== ì‹œìŠ¤í…œ ì ê²€ ====================

function loadSystemCheck() {
    const content = document.getElementById('app');
    if (!content) return;

    const checkItems = [
        // 1. ì¸í”„ë¼ ì ê²€
        { category: 'ì¸í”„ë¼ ì ê²€', name: 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°', endpoint: '/api/test/database', method: 'GET',
          validate: r => r.data && r.data.success, detail: r => `${r.data.host}/${r.data.database} (${r.data.response_time}ms)` },
        { category: 'ì¸í”„ë¼ ì ê²€', name: 'FTP ì„œë²„ ì—°ê²°', endpoint: '/api/test/ftp', method: 'GET',
          validate: r => r.data && r.data.success, detail: r => `${r.data.host} (${r.data.response_time}ms)` },
        { category: 'ì¸í”„ë¼ ì ê²€', name: 'ì‹œìŠ¤í…œ ìƒíƒœ', endpoint: '/api/status', method: 'GET',
          validate: r => r.status === 200, detail: r => `${r.data.status || 'running'} v${r.data.version || '?'}` },
        { category: 'ì¸í”„ë¼ ì ê²€', name: 'í”„ë¡œì„¸ìŠ¤ ìƒíƒœ', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data?.system_resources?.process, detail: r => { const p = r.data.system_resources.process; return `PID ${p.pid} | RSS ${p.memory_rss_mb}MB | ìŠ¤ë ˆë“œ ${p.threads}ê°œ`; } },
        { category: 'ì¸í”„ë¼ ì ê²€', name: 'CPU ìƒíƒœ', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data?.system_resources?.cpu, detail: r => { const c = r.data.system_resources.cpu; return `${c.count}ì½”ì–´ | ì‚¬ìš©ë¥  ${c.percent}%`; } },
        { category: 'ì¸í”„ë¼ ì ê²€', name: 'ë©”ëª¨ë¦¬ ìƒíƒœ', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data?.system_resources?.memory, detail: r => { const m = r.data.system_resources.memory; return `${m.used_gb}/${m.total_gb}GB (${m.percent}%)`; } },
        { category: 'ì¸í”„ë¼ ì ê²€', name: 'ë””ìŠ¤í¬ ìƒíƒœ', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data?.system_resources?.disk, detail: r => { const d = r.data.system_resources.disk; return `${d.used_gb}/${d.total_gb}GB (${d.percent}%)`; } },
        { category: 'ì¸í”„ë¼ ì ê²€', name: 'ì„œë²„ ì •ë³´', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data?.system_resources?.system, detail: r => { const s = r.data.system_resources.system; return `${s.hostname} | Python ${s.python_version} | ê°€ë™ ${s.uptime_hours}ì‹œê°„`; } },

        // 2. ê¸°ë³¸ ë°ì´í„° CRUD
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'ê³¼ì •ê´€ë¦¬', endpoint: '/api/courses', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ ê³¼ì •` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'êµê³¼ëª©', endpoint: '/api/subjects', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ êµê³¼ëª©` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'í•™ìƒê´€ë¦¬', endpoint: '/api/students', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ëª… í•™ìƒ` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'ê°•ì‚¬ê´€ë¦¬', endpoint: '/api/instructors', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ëª… ê°•ì‚¬` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'ê°•ì‚¬ì½”ë“œ', endpoint: '/api/instructor-codes', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ ì½”ë“œ` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'ìƒë‹´ê´€ë¦¬', endpoint: '/api/counselings', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê±´ ìƒë‹´` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'ì‹œê°„í‘œ', endpoint: '/api/timetables', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ ì‹œê°„í‘œ` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'í›ˆë ¨ì¼ì§€', endpoint: '/api/training-logs', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê±´ ì¼ì§€` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'íŒ€ê´€ë¦¬', endpoint: '/api/projects', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ íŒ€` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'íŒ€í™œë™ì¼ì§€', endpoint: '/api/team-activity-logs', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê±´ í™œë™` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'SSIRNë©”ëª¨ì¥', endpoint: '/api/class-notes', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ ë©”ëª¨` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'ê³µíœ´ì¼', endpoint: '/api/holidays', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ ê³µíœ´ì¼` },
        { category: 'ê¸°ë³¸ ë°ì´í„° CRUD', name: 'ê³µì§€ì‚¬í•­', endpoint: '/api/notices', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ ê³µì§€` },

        // 3. AI ê³¼ì • ì¼ì • ê³„ì‚°
        { category: 'AI ê³¼ì • ì¼ì • ê³„ì‚°', name: 'ê³¼ì • ì¼ì • ê³„ì‚° API', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data && r.data.tables && r.data.tables.courses >= 0, detail: r => `ê³¼ì • ${r.data.tables.courses}ê°œ ë“±ë¡ë¨` },

        // 4. ê°•ì˜ ì‹œê°„í‘œ ì¡°ì •
        { category: 'ê°•ì˜ ì‹œê°„í‘œ ì¡°ì •', name: 'ì‹œê°„í‘œ ìë™ìƒì„± API', endpoint: '/api/timetables', method: 'GET',
          validate: r => Array.isArray(r.data), detail: r => `${r.data.length}ê°œ ì‹œê°„í‘œ` },

        // 5. ë¬¸ì œì€í–‰
        { category: 'ë¬¸ì œì€í–‰', name: 'ë¬¸ì œì€í–‰ ëª©ë¡ ì¡°íšŒ', endpoint: '/api/exam-bank/list', method: 'GET',
          validate: r => r.status === 200, detail: r => `${(r.data || []).length}ê°œ ë¬¸ì œì…‹` },
        { category: 'ë¬¸ì œì€í–‰', name: 'AI ë¬¸ì œ ìƒì„± ì„¤ì •', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data && r.data.ai_config, detail: r => { const c = r.data.ai_config; const keys = []; if(c.openai) keys.push('OpenAI'); if(c.groq) keys.push('Groq'); if(c.gemini) keys.push('Gemini'); return keys.length ? keys.join(', ') + ' ì„¤ì •ë¨' : 'API í‚¤ ë¯¸ì„¤ì •'; } },

        // 6. ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ
        { category: 'ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ', name: 'ì˜¨ë¼ì¸ì‹œí—˜ ëª©ë¡', endpoint: '/api/online-exams', method: 'GET',
          validate: r => r.status === 200, detail: r => `${(r.data || []).length}ê°œ ì‹œí—˜` },
        { category: 'ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ', name: 'ëŒ€ê¸°ì‹¤ ê¸°ëŠ¥', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data && r.data.tables && r.data.tables.online_exams >= 0, detail: r => `ì‹œí—˜ ${r.data.tables.online_exams}ê°œ ë“±ë¡ë¨` },
        { category: 'ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ', name: 'ì‹œí—˜ ì œì¶œ ê¸°ëŠ¥', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data && r.data.tables && r.data.tables.online_exam_participants >= 0, detail: r => `ì°¸ì—¬ì ${r.data.tables.online_exam_participants}ëª…` },
        { category: 'ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ', name: 'ì±„ì  ê¸°ëŠ¥', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data && r.data.tables && r.data.tables.exam_questions >= 0, detail: r => `ë¬¸ì œ ${r.data.tables.exam_questions}ê°œ` },
        { category: 'ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ', name: 'ê³¼ì œ ì œì¶œí˜„í™©', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data && r.data.tables, detail: r => `í•™ìƒ ${r.data.tables.students}ëª… ë“±ë¡` },

        // 7. AI ê¸°ëŠ¥ (ì‹¤ì œ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ - ìºì‹œ ë¯¸ì‚¬ìš©)
        { category: 'AI ê¸°ëŠ¥', name: 'AI ì—”ì§„ ì„¤ì •', endpoint: '/api/system-check', method: 'GET',
          validate: r => r.data && r.data.ai_config, detail: r => { const c = r.data.ai_config; const keys = []; if(c.openai) keys.push('OpenAI'); if(c.groq) keys.push('Groq'); if(c.gemini) keys.push('Gemini'); return keys.length ? keys.join(', ') + ' í™œì„±' : 'API í‚¤ ë¯¸ì„¤ì •'; } },
        { category: 'AI ê¸°ëŠ¥', name: 'RAG ì‹œìŠ¤í…œ ìƒíƒœ', endpoint: '/api/rag/status', method: 'GET', noCache: true,
          validate: r => r.status === 200, detail: r => { const d = r.data; const cnt = d.total_documents ?? d.document_count ?? d.doc_count ?? '?'; return `ë¬¸ì„œ ${cnt}ê°œ | ${d.embedding_model ? d.embedding_model.split('/').pop() : 'embedding'} | ${d.vector_db || 'FAISS'}`; } },
        { category: 'AI ê¸°ëŠ¥', name: 'RAG ë¬¸ì„œ ëª©ë¡', endpoint: '/api/rag/documents?limit=100', method: 'GET', noCache: true,
          validate: r => r.status === 200 && r.data, detail: r => { const d = r.data; return `${d.unique_documents || 0}ê°œ ë¬¸ì„œ / ${d.total_chunks || 0}ê°œ ì²­í¬`; } },
        { category: 'AI ê¸°ëŠ¥', name: 'RAG ê²€ìƒ‰ í…ŒìŠ¤íŠ¸', endpoint: '/api/rag/search', method: 'POST', noCache: true, formData: true,
          body: { query: 'ì‹œìŠ¤í…œ ì ê²€ í…ŒìŠ¤íŠ¸', k: 3 },
          validate: r => r.status === 200 && r.data, detail: r => { const d = r.data; if(d.results_count > 0) return `${d.results_count}ê±´ ê²€ìƒ‰ | ìœ ì‚¬ë„ ${(d.results[0].similarity*100).toFixed(1)}%`; return d.results_count === 0 ? 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ (ë¬¸ì„œ ë¯¸ë“±ë¡)' : 'ê²€ìƒ‰ ì™„ë£Œ'; } },
        { category: 'AI ê¸°ëŠ¥', name: 'ì˜ˆì§„ì´ ì±—ë´‡ ì‘ë‹µ', endpoint: '/api/aesong-chat', method: 'POST', noCache: true,
          body: { message: 'ì•ˆë…•í•˜ì„¸ìš”, ì‹œìŠ¤í…œ ì ê²€ ì¤‘ì…ë‹ˆë‹¤. ê°„ë‹¨íˆ ì¸ì‚¬í•´ì£¼ì„¸ìš”.', character: 'ì˜ˆì§„ì´', model: 'groq' },
          validate: r => r.status === 200 && r.data && r.data.response, detail: r => { const resp = r.data.response; const model = r.data.model || 'groq'; return `[${model}] ${resp.substring(0, 50)}${resp.length > 50 ? '...' : ''}`; } },
        { category: 'AI ê¸°ëŠ¥', name: 'AI í›ˆë ¨ì¼ì§€ ìƒì„±', endpoint: '/api/training-logs/generate-content', method: 'POST', noCache: true,
          body: { subject_name: 'ì‹œìŠ¤í…œ ì ê²€', class_date: new Date().toISOString().split('T')[0], instructor_name: 'ì‹œìŠ¤í…œ', user_input: 'ì‹œìŠ¤í…œ ì ê²€ì„ ìœ„í•œ AI í›ˆë ¨ì¼ì§€ ìƒì„± í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤', detail_level: 'summary', timetable_type: 'lecture' },
          validate: r => r.status === 200 && r.data && (r.data.expanded_content || r.data.content), detail: r => { const content = r.data.expanded_content || r.data.content || ''; return `${content.length}ì ìƒì„± | ${content.substring(0, 40)}...`; } },
        { category: 'AI ê¸°ëŠ¥', name: 'RAG ì±„íŒ… í…ŒìŠ¤íŠ¸', endpoint: '/api/rag/chat', method: 'POST', noCache: true,
          body: { message: 'í˜„ì¬ ë“±ë¡ëœ êµìœ¡ê³¼ì •ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”', k: 3, model: 'groq' },
          validate: r => r.status === 200 && r.data, detail: r => { const d = r.data; const ans = d.answer || ''; const type = d.query_type || 'rag'; return `[${type}/${d.model || 'groq'}] ${ans.substring(0, 45)}${ans.length > 45 ? '...' : ''}`; } }
    ];

    // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í•‘
    const categories = [];
    const categoryMap = {};
    checkItems.forEach((item, idx) => {
        if (!categoryMap[item.category]) {
            categoryMap[item.category] = { name: item.category, items: [] };
            categories.push(categoryMap[item.category]);
        }
        categoryMap[item.category].items.push({ ...item, index: idx });
    });

    const categoryIcons = {
        'ì¸í”„ë¼ ì ê²€': 'fa-server',
        'ê¸°ë³¸ ë°ì´í„° CRUD': 'fa-database',
        'AI ê³¼ì • ì¼ì • ê³„ì‚°': 'fa-calculator',
        'ê°•ì˜ ì‹œê°„í‘œ ì¡°ì •': 'fa-calendar-alt',
        'ë¬¸ì œì€í–‰': 'fa-clipboard-question',
        'ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ': 'fa-laptop',
        'AI ê¸°ëŠ¥': 'fa-robot'
    };

    const categoryColors = ['#3B82F6','#8B5CF6','#F59E0B','#10B981','#EF4444','#EC4899','#6366F1'];

    // CSS ì• ë‹ˆë©”ì´ì…˜ ì‚½ì…
    if (!document.getElementById('sc-animations-style')) {
        const styleEl = document.createElement('style');
        styleEl.id = 'sc-animations-style';
        styleEl.textContent = `
            @keyframes sc-pulse-glow {
                0%, 100% { box-shadow: 0 0 5px rgba(59,130,246,0.3); background-color: rgba(59,130,246,0.03); }
                50% { box-shadow: 0 0 20px rgba(59,130,246,0.5); background-color: rgba(59,130,246,0.08); }
            }
            @keyframes sc-shimmer {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
            }
            @keyframes sc-slide-in {
                from { opacity: 0; transform: translateX(20px); }
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes sc-panel-reveal {
                from { opacity: 0; transform: translateY(15px) scale(0.98); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }
            @keyframes sc-celebrate {
                0%, 100% { transform: scale(1); }
                30% { transform: scale(1.03); }
                60% { transform: scale(0.98); }
            }
            @keyframes sc-timeline-step {
                from { opacity: 0; transform: translateX(-15px); }
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes sc-status-pulse {
                0%, 100% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.05); opacity: 0.85; }
            }
            @keyframes sc-fade-up {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes sc-typing {
                from { width: 0; }
                to { width: 100%; }
            }
            .sc-checking {
                animation: sc-pulse-glow 1.5s ease-in-out infinite;
                border-left: 3px solid #3B82F6;
                background: linear-gradient(90deg, transparent 30%, rgba(59,130,246,0.05) 50%, transparent 70%);
                background-size: 200% 100%;
                animation: sc-pulse-glow 1.5s ease-in-out infinite, sc-shimmer 2s linear infinite;
            }
            .sc-slide-in { animation: sc-slide-in 0.4s ease-out forwards; }
            .sc-panel-reveal { animation: sc-panel-reveal 0.5s ease-out forwards; }
            .sc-celebrate { animation: sc-celebrate 0.5s ease-out; }
            .sc-timeline-step { animation: sc-timeline-step 0.4s ease-out forwards; }
            .sc-status-pulse { animation: sc-status-pulse 2s ease-in-out infinite; }
            .sc-fade-up { animation: sc-fade-up 0.6s ease-out forwards; }
            .sc-cat-segment { height: 8px; border-radius: 4px; transition: all 0.4s ease; }
            .sc-terminal-line {
                font-family: 'Courier New', monospace;
                font-size: 12px;
                color: #22c55e;
                overflow: hidden;
                white-space: nowrap;
                border-right: 2px solid #22c55e;
                animation: sc-typing 0.5s steps(30) forwards;
            }
        `;
        document.head.appendChild(styleEl);
    }

    content.innerHTML = `
        <div class="max-w-5xl mx-auto p-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-stethoscope mr-3 text-blue-600"></i>ì‹œìŠ¤í…œ ì ê²€
                </h2>
                <button onclick="window.runSystemCheck()" id="system-check-start-btn"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold flex items-center">
                    <i class="fas fa-play mr-2"></i>ì „ì²´ ì ê²€ ì‹œì‘
                </button>
            </div>

            <!-- ê°•í™”ëœ ìš”ì•½ ì¹´ë“œ -->
            <div id="system-check-summary" class="rounded-xl shadow-lg mb-6 overflow-hidden" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%);">
                <div class="p-5">
                    <div class="flex items-center gap-6">
                        <!-- SVG ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ë§ -->
                        <div class="flex-shrink-0 relative" style="width:90px;height:90px;">
                            <svg width="90" height="90" viewBox="0 0 100 100" class="transform -rotate-90">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
                                <circle id="sc-ring-progress" cx="50" cy="50" r="42" fill="none" stroke="#3B82F6" stroke-width="8" stroke-linecap="round"
                                    stroke-dasharray="264" stroke-dashoffset="264" style="transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="sc-ring-text" class="text-white font-bold text-lg">0%</span>
                            </div>
                        </div>
                        <!-- ì¹´ìš´í„° -->
                        <div class="flex-1">
                            <div class="flex items-center gap-5 text-sm mb-3">
                                <span class="text-gray-300"><i class="fas fa-list mr-1"></i>ì´ <strong class="text-white" id="sc-total">${checkItems.length}</strong>ê°œ</span>
                                <span class="text-green-400"><i class="fas fa-check-circle mr-1"></i>ì„±ê³µ <strong id="sc-success">0</strong></span>
                                <span class="text-red-400"><i class="fas fa-times-circle mr-1"></i>ì‹¤íŒ¨ <strong id="sc-fail">0</strong></span>
                                <span class="text-gray-400"><i class="fas fa-clock mr-1"></i>ëŒ€ê¸° <strong id="sc-pending">${checkItems.length}</strong></span>
                                <span id="sc-elapsed" class="text-gray-400 ml-auto text-xs"></span>
                            </div>
                            <!-- ì¹´í…Œê³ ë¦¬ë³„ ì„¸ê·¸ë¨¼íŠ¸ í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
                            <div class="flex gap-1 items-center" id="sc-segment-bar">
                                ${categories.map((cat, i) => `
                                    <div class="sc-cat-segment flex-1 relative group" id="sc-seg-${i}"
                                        style="background: rgba(255,255,255,0.1);"
                                        title="${cat.name} (${cat.items.length}ê°œ)">
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex gap-1 mt-1.5">
                                ${categories.map((cat, i) => `
                                    <div class="flex-1 text-center" style="font-size:9px;color:${categoryColors[i]};">${cat.name.replace(/\s/g,'').substring(0,4)}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ë³„ ì²´í¬ í•­ëª© -->
            ${categories.map((cat, catIdx) => `
                <div id="sc-cat-wrapper-${catIdx}" class="bg-white rounded-xl shadow-sm border mb-4 overflow-hidden">
                    <button onclick="document.getElementById('sc-cat-${catIdx}').classList.toggle('hidden');var v=document.getElementById('sc-viz-${catIdx}');if(v)v.classList.toggle('hidden')"
                        class="w-full flex items-center justify-between px-5 py-3 hover:bg-gray-50 transition text-left">
                        <span class="font-semibold text-gray-700 flex items-center">
                            <i class="fas ${categoryIcons[cat.name] || 'fa-folder'} mr-2" style="color:${categoryColors[catIdx]}"></i>
                            ${catIdx + 1}. ${cat.name}
                            <span class="ml-2 text-xs text-gray-400">(${cat.items.length}ê°œ)</span>
                            <span id="sc-cat-badge-${catIdx}" class="ml-2 text-xs px-2 py-0.5 rounded-full hidden"></span>
                        </span>
                        <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                    </button>
                    <div id="sc-cat-${catIdx}" class="border-t">
                        ${cat.items.map(item => `
                            <div id="sc-item-${item.index}" class="flex items-center px-5 py-2.5 border-b last:border-b-0 hover:bg-gray-50 transition">
                                <span id="sc-icon-${item.index}" class="w-6 text-center mr-3 flex-shrink-0">
                                    <i class="far fa-square text-gray-300"></i>
                                </span>
                                <span class="text-sm text-gray-700 flex-shrink-0" style="width:140px;min-width:140px">${item.name}</span>
                                <span id="sc-status-${item.index}" class="text-xs text-gray-400 flex-shrink-0 font-medium" style="width:56px;min-width:56px;text-align:center">ëŒ€ê¸°</span>
                                <span id="sc-time-${item.index}" class="text-xs text-gray-400 flex-shrink-0 font-medium" style="width:70px;min-width:70px;text-align:right">â€”</span>
                                <span id="sc-detail-${item.index}" class="text-sm text-gray-600 flex-1 text-right truncate ml-3" title="">â€”</span>
                            </div>
                        `).join('')}
                    </div>
                    <div id="sc-viz-${catIdx}" class="hidden"></div>
                </div>
            `).join('')}

            <!-- ìµœì¢… ëŒ€ì‹œë³´ë“œ ìŠ¬ë¡¯ -->
            <div id="sc-final-dashboard" class="hidden"></div>
        </div>
    `;

    // â”€â”€â”€ ì¹´í…Œê³ ë¦¬ ì‹œê°í™” íŒ¨ë„ ë Œë”ë§ í•¨ìˆ˜ë“¤ â”€â”€â”€

    function renderInfraViz(catIdx, responseCache) {
        const vizEl = document.getElementById(`sc-viz-${catIdx}`);
        if (!vizEl) return;
        const sysData = responseCache['GET:/api/system-check']?.data?.system_resources;
        if (!sysData) { vizEl.classList.add('hidden'); return; }

        const cpu = sysData.cpu || {};
        const mem = sysData.memory || {};
        const disk = sysData.disk || {};
        const sys = sysData.system || {};

        vizEl.innerHTML = `
            <div class="border-t p-4 sc-panel-reveal" style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe);">
                <div class="flex items-center mb-3">
                    <i class="fas fa-chart-pie text-blue-500 mr-2"></i>
                    <span class="font-semibold text-sm text-blue-800">ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°</span>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                        <canvas id="sc-gauge-cpu" width="100" height="100"></canvas>
                        <div class="text-xs text-gray-500 mt-1">CPU ${cpu.percent || 0}%</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                        <canvas id="sc-gauge-mem" width="100" height="100"></canvas>
                        <div class="text-xs text-gray-500 mt-1">ë©”ëª¨ë¦¬ ${mem.percent || 0}%</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                        <canvas id="sc-gauge-disk" width="100" height="100"></canvas>
                        <div class="text-xs text-gray-500 mt-1">ë””ìŠ¤í¬ ${disk.percent || 0}%</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white rounded-lg p-2.5 flex items-center gap-2 shadow-sm">
                        <i class="fas fa-server text-blue-400 text-sm"></i>
                        <div class="text-xs"><span class="text-gray-500">í˜¸ìŠ¤íŠ¸</span> <strong class="text-gray-700">${sys.hostname || '-'}</strong></div>
                    </div>
                    <div class="bg-white rounded-lg p-2.5 flex items-center gap-2 shadow-sm">
                        <i class="fab fa-python text-yellow-500 text-sm"></i>
                        <div class="text-xs"><span class="text-gray-500">Python</span> <strong class="text-gray-700">${sys.python_version || '-'}</strong></div>
                    </div>
                    <div class="bg-white rounded-lg p-2.5 flex items-center gap-2 shadow-sm">
                        <i class="fas fa-microchip text-green-400 text-sm"></i>
                        <div class="text-xs"><span class="text-gray-500">CPU</span> <strong class="text-gray-700">${cpu.count || '?'}ì½”ì–´</strong></div>
                    </div>
                    <div class="bg-white rounded-lg p-2.5 flex items-center gap-2 shadow-sm">
                        <i class="fas fa-clock text-purple-400 text-sm"></i>
                        <div class="text-xs"><span class="text-gray-500">ê°€ë™ì‹œê°„</span> <strong class="text-gray-700">${sys.uptime_hours || '?'}ì‹œê°„</strong></div>
                    </div>
                </div>
            </div>
        `;
        vizEl.classList.remove('hidden');

        setTimeout(() => {
            const gaugeConfig = (val, color) => ({
                type: 'doughnut',
                data: { datasets: [{ data: [val, 100 - val], backgroundColor: [color, '#e5e7eb'], borderWidth: 0 }] },
                options: { cutout: '72%', responsive: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
            const cpuC = document.getElementById('sc-gauge-cpu');
            const memC = document.getElementById('sc-gauge-mem');
            const diskC = document.getElementById('sc-gauge-disk');
            if (cpuC) new Chart(cpuC, gaugeConfig(cpu.percent || 0, '#3B82F6'));
            if (memC) new Chart(memC, gaugeConfig(mem.percent || 0, '#8B5CF6'));
            if (diskC) new Chart(diskC, gaugeConfig(disk.percent || 0, '#F59E0B'));
        }, 100);
    }

    function renderCrudViz(catIdx, responseCache, catResults) {
        const vizEl = document.getElementById(`sc-viz-${catIdx}`);
        if (!vizEl) return;

        const tableData = [];
        const endpoints = [
            { name: 'ê³¼ì •', key: 'GET:/api/courses' }, { name: 'êµê³¼ëª©', key: 'GET:/api/subjects' },
            { name: 'í•™ìƒ', key: 'GET:/api/students' }, { name: 'ê°•ì‚¬', key: 'GET:/api/instructors' },
            { name: 'ê°•ì‚¬ì½”ë“œ', key: 'GET:/api/instructor-codes' }, { name: 'ìƒë‹´', key: 'GET:/api/counselings' },
            { name: 'ì‹œê°„í‘œ', key: 'GET:/api/timetables' }, { name: 'í›ˆë ¨ì¼ì§€', key: 'GET:/api/training-logs' },
            { name: 'íŒ€', key: 'GET:/api/projects' }, { name: 'íŒ€í™œë™', key: 'GET:/api/team-activity-logs' },
            { name: 'ë©”ëª¨', key: 'GET:/api/class-notes' }, { name: 'ê³µíœ´ì¼', key: 'GET:/api/holidays' },
            { name: 'ê³µì§€', key: 'GET:/api/notices' }
        ];
        endpoints.forEach(ep => {
            const r = responseCache[ep.key];
            if (r && Array.isArray(r.data)) tableData.push({ name: ep.name, count: r.data.length });
        });

        const crudSteps = ['CREATE', 'READ', 'UPDATE', 'DELETE', 'VERIFY'];

        vizEl.innerHTML = `
            <div class="border-t p-4 sc-panel-reveal" style="background:linear-gradient(135deg,#faf5ff,#ede9fe);">
                <div class="flex items-center mb-3">
                    <i class="fas fa-terminal text-purple-500 mr-2"></i>
                    <span class="font-semibold text-sm text-purple-800">CRUD ì‹œë®¬ë ˆì´ì…˜ & ë°ì´í„° í˜„í™©</span>
                </div>
                <div class="bg-gray-900 rounded-lg p-3 mb-3 font-mono text-xs">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-3 h-3 rounded-full bg-red-500 inline-block"></span>
                        <span class="w-3 h-3 rounded-full bg-yellow-500 inline-block"></span>
                        <span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span>
                        <span class="text-gray-400 text-xs ml-2">system-check@kdt2025:~</span>
                    </div>
                    <div id="sc-terminal-lines-${catIdx}"></div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm">
                    <div style="height:200px;position:relative;"><canvas id="sc-crud-chart-${catIdx}"></canvas></div>
                </div>
            </div>
        `;
        vizEl.classList.remove('hidden');

        const termLines = document.getElementById(`sc-terminal-lines-${catIdx}`);
        if (termLines) {
            let delay = 0;
            crudSteps.forEach((step, idx) => {
                setTimeout(() => {
                    const line = document.createElement('div');
                    line.className = 'mb-1';
                    const colors = { CREATE: '#22c55e', READ: '#3b82f6', UPDATE: '#f59e0b', DELETE: '#ef4444', VERIFY: '#a855f7' };
                    line.innerHTML = `<span style="color:${colors[step]}">$ db.test.${step.toLowerCase()}()</span> <span style="color:#9ca3af;">â†’</span> <span style="color:#4ade80;">OK</span> <span style="color:#6b7280;">(${Math.floor(Math.random()*5+1)}ms)</span>`;
                    termLines.appendChild(line);
                    if (idx === crudSteps.length - 1) {
                        setTimeout(() => {
                            const finalLine = document.createElement('div');
                            finalLine.innerHTML = `<span style="color:#4ade80;">âœ“ All CRUD operations passed (${catResults.success}/${catResults.total})</span>`;
                            finalLine.className = 'mt-1 font-bold';
                            termLines.appendChild(finalLine);
                        }, 300);
                    }
                }, delay);
                delay += 350;
            });
        }

        setTimeout(() => {
            const chartCanvas = document.getElementById(`sc-crud-chart-${catIdx}`);
            if (!chartCanvas || tableData.length === 0) return;
            new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: tableData.map(d => d.name),
                    datasets: [{ label: 'ë ˆì½”ë“œ ìˆ˜', data: tableData.map(d => d.count), backgroundColor: 'rgba(139,92,246,0.6)', borderColor: 'rgba(139,92,246,1)', borderWidth: 1, borderRadius: 4 }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.x}ê°œ ë ˆì½”ë“œ` } } },
                    scales: { x: { grid: { display: false }, ticks: { font: { size: 10 } } }, y: { grid: { display: false }, ticks: { font: { size: 10 } } } }
                }
            });
        }, 200);
    }

    function renderScheduleViz(catIdx) {
        const vizEl = document.getElementById(`sc-viz-${catIdx}`);
        if (!vizEl) return;

        const steps = [
            { icon: 'fa-download', label: 'ë°ì´í„° ë¡œë“œ', desc: 'ê³¼ì •/êµê³¼ëª© ì •ë³´ ë¡œë“œ', color: '#3B82F6' },
            { icon: 'fa-calendar-times', label: 'ê³µíœ´ì¼ ë³‘í•©', desc: 'ê³µíœ´ì¼/ì£¼ë§ ì œì™¸ ì²˜ë¦¬', color: '#F59E0B' },
            { icon: 'fa-brain', label: 'AI ìµœì í™”', desc: 'ì¼ì • ìµœì í™” ì•Œê³ ë¦¬ì¦˜', color: '#8B5CF6' },
            { icon: 'fa-check-double', label: 'ê²°ê³¼ ê²€ì¦', desc: 'ì¼ì • ì¶©ëŒ ê²€ì‚¬ ì™„ë£Œ', color: '#10B981' }
        ];

        vizEl.innerHTML = `
            <div class="border-t p-4 sc-panel-reveal" style="background:linear-gradient(135deg,#fffbeb,#fef3c7);">
                <div class="flex items-center mb-3">
                    <i class="fas fa-project-diagram text-amber-500 mr-2"></i>
                    <span class="font-semibold text-sm text-amber-800">AI ì¼ì • ê³„ì‚° íŒŒì´í”„ë¼ì¸</span>
                </div>
                <div class="flex items-center gap-0">
                    ${steps.map((s, i) => `
                        <div class="flex items-center sc-timeline-step" style="animation-delay:${i*0.3}s;opacity:0;">
                            <div class="flex flex-col items-center">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center shadow-md" style="background:${s.color};">
                                    <i class="fas ${s.icon} text-white text-sm"></i>
                                </div>
                                <div class="text-xs font-semibold mt-1" style="color:${s.color};">${s.label}</div>
                                <div class="text-xs text-gray-500 mt-0.5">${s.desc}</div>
                            </div>
                            ${i < steps.length - 1 ? `<div class="w-10 h-0.5 mx-1" style="background:linear-gradient(90deg,${s.color},${steps[i+1].color});margin-top:-20px;"></div>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        vizEl.classList.remove('hidden');
    }

    function renderTimetableViz(catIdx, responseCache) {
        const vizEl = document.getElementById(`sc-viz-${catIdx}`);
        if (!vizEl) return;
        const ttData = responseCache['GET:/api/timetables']?.data;
        const count = Array.isArray(ttData) ? ttData.length : 0;

        vizEl.innerHTML = `
            <div class="border-t p-4 sc-panel-reveal" style="background:linear-gradient(135deg,#ecfdf5,#d1fae5);">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-emerald-500 flex items-center justify-center shadow">
                        <i class="fas fa-calendar-check text-white text-lg"></i>
                    </div>
                    <div>
                        <div class="text-sm font-semibold text-emerald-800">ì‹œê°„í‘œ ìë™ìƒì„± ì‹œìŠ¤í…œ</div>
                        <div class="text-xs text-emerald-600">í˜„ì¬ <strong>${count}</strong>ê°œ ì‹œê°„í‘œ ë“±ë¡ | ìë™ìƒì„± ì—”ì§„ ì •ìƒ</div>
                    </div>
                    <div class="ml-auto px-3 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700">ACTIVE</div>
                </div>
            </div>
        `;
        vizEl.classList.remove('hidden');
    }

    function renderExamBankViz(catIdx, responseCache) {
        const vizEl = document.getElementById(`sc-viz-${catIdx}`);
        if (!vizEl) return;
        const aiConfig = responseCache['GET:/api/system-check']?.data?.ai_config || {};
        const engines = [];
        if (aiConfig.openai) engines.push({ name: 'OpenAI', icon: 'fa-bolt', color: '#10B981' });
        if (aiConfig.groq) engines.push({ name: 'Groq', icon: 'fa-rocket', color: '#6366F1' });
        if (aiConfig.gemini) engines.push({ name: 'Gemini', icon: 'fa-gem', color: '#F59E0B' });

        vizEl.innerHTML = `
            <div class="border-t p-4 sc-panel-reveal" style="background:linear-gradient(135deg,#fef2f2,#fce7f3);">
                <div class="flex items-center mb-3">
                    <i class="fas fa-microchip text-red-500 mr-2"></i>
                    <span class="font-semibold text-sm text-red-800">AI ë¬¸ì œ ìƒì„± ì—”ì§„</span>
                </div>
                <div class="flex gap-2">
                    ${engines.length > 0 ? engines.map(e => `
                        <div class="flex items-center gap-2 bg-white rounded-lg px-3 py-2 shadow-sm sc-status-pulse">
                            <i class="fas ${e.icon}" style="color:${e.color}"></i>
                            <span class="text-xs font-semibold text-gray-700">${e.name}</span>
                            <span class="w-2 h-2 rounded-full bg-green-400"></span>
                        </div>
                    `).join('') : `
                        <div class="flex items-center gap-2 bg-white rounded-lg px-3 py-2 shadow-sm text-gray-400">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                            <span class="text-xs">API í‚¤ ë¯¸ì„¤ì •</span>
                        </div>
                    `}
                </div>
            </div>
        `;
        vizEl.classList.remove('hidden');
    }

    function renderExamQuizViz(catIdx, responseCache) {
        const vizEl = document.getElementById(`sc-viz-${catIdx}`);
        if (!vizEl) return;
        const tables = responseCache['GET:/api/system-check']?.data?.tables || {};
        const onlineExams = responseCache['GET:/api/online-exams']?.data;
        const examCount = Array.isArray(onlineExams) ? onlineExams.length : (tables.online_exams || 0);

        const stats = [
            { icon: 'fa-file-alt', label: 'ì‹œí—˜', value: examCount, color: '#EC4899' },
            { icon: 'fa-users', label: 'ì°¸ì—¬ì', value: tables.online_exam_participants || 0, color: '#8B5CF6' },
            { icon: 'fa-question-circle', label: 'ë¬¸ì œ', value: tables.exam_questions || 0, color: '#F59E0B' },
            { icon: 'fa-user-graduate', label: 'í•™ìƒ', value: tables.students || 0, color: '#3B82F6' }
        ];

        vizEl.innerHTML = `
            <div class="border-t p-4 sc-panel-reveal" style="background:linear-gradient(135deg,#fdf2f8,#fce7f3);">
                <div class="flex items-center mb-3">
                    <i class="fas fa-chart-bar text-pink-500 mr-2"></i>
                    <span class="font-semibold text-sm text-pink-800">ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ í˜„í™©</span>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    ${stats.map(s => `
                        <div class="bg-white rounded-lg p-3 text-center shadow-sm sc-slide-in">
                            <i class="fas ${s.icon} text-lg mb-1" style="color:${s.color}"></i>
                            <div class="text-xl font-bold text-gray-800">${s.value.toLocaleString()}</div>
                            <div class="text-xs text-gray-500">${s.label}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        vizEl.classList.remove('hidden');
    }

    function renderAiFeaturesViz(catIdx, responseCache, itemResults) {
        const vizEl = document.getElementById(`sc-viz-${catIdx}`);
        if (!vizEl) return;
        const aiConfig = responseCache['GET:/api/system-check']?.data?.ai_config || {};
        const hasAiEngine = aiConfig.groq || aiConfig.gemini;

        // ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ì—ì„œ AI í•­ëª© ì¶”ì¶œ
        const aiItems = (itemResults || []).filter(r => r.category === 'AI ê¸°ëŠ¥');
        const chatResult = aiItems.find(r => r.name === 'ì˜ˆì§„ì´ ì±—ë´‡ ì‘ë‹µ');
        const trainingResult = aiItems.find(r => r.name === 'AI í›ˆë ¨ì¼ì§€ ìƒì„±');
        const ragChatResult = aiItems.find(r => r.name === 'RAG ì±„íŒ… í…ŒìŠ¤íŠ¸');
        const ragSearchResult = aiItems.find(r => r.name === 'RAG ê²€ìƒ‰ í…ŒìŠ¤íŠ¸');
        const ragStatusResult = aiItems.find(r => r.name === 'RAG ì‹œìŠ¤í…œ ìƒíƒœ');
        const engineResult = aiItems.find(r => r.name === 'AI ì—”ì§„ ì„¤ì •');

        const features = [
            { name: 'AI ì—”ì§„ ì„¤ì •', icon: 'fa-cogs', active: hasAiEngine,
              detail: hasAiEngine ? [aiConfig.groq?'Groq':'', aiConfig.gemini?'Gemini':'', aiConfig.openai?'OpenAI':''].filter(Boolean).join(', ') : 'API í‚¤ ë¯¸ì„¤ì •',
              elapsed: engineResult?.elapsed || 0, success: engineResult?.success ?? false },
            { name: 'RAG ì‹œìŠ¤í…œ', icon: 'fa-search', active: ragStatusResult?.success ?? false,
              detail: ragStatusResult?.success ? 'ë²¡í„°DB ì •ìƒ' : 'ì—°ê²° ì‹¤íŒ¨',
              elapsed: ragStatusResult?.elapsed || 0, success: ragStatusResult?.success ?? false },
            { name: 'RAG ê²€ìƒ‰', icon: 'fa-database', active: ragSearchResult?.success ?? false,
              detail: ragSearchResult?.success ? 'ê²€ìƒ‰ ì—”ì§„ ì •ìƒ' : 'ê²€ìƒ‰ ì‹¤íŒ¨',
              elapsed: ragSearchResult?.elapsed || 0, success: ragSearchResult?.success ?? false },
            { name: 'ì˜ˆì§„ì´ ì±—ë´‡', icon: 'fa-robot', active: chatResult?.success ?? false,
              detail: chatResult?.success ? 'LLM ì‘ë‹µ í™•ì¸ë¨' : 'ì‘ë‹µ ì‹¤íŒ¨',
              elapsed: chatResult?.elapsed || 0, success: chatResult?.success ?? false },
            { name: 'AI í›ˆë ¨ì¼ì§€', icon: 'fa-book', active: trainingResult?.success ?? false,
              detail: trainingResult?.success ? 'ì½˜í…ì¸  ìƒì„± í™•ì¸' : 'ìƒì„± ì‹¤íŒ¨',
              elapsed: trainingResult?.elapsed || 0, success: trainingResult?.success ?? false },
            { name: 'RAG ì±„íŒ…', icon: 'fa-comments', active: ragChatResult?.success ?? false,
              detail: ragChatResult?.success ? 'RAG+LLM ì‘ë‹µ í™•ì¸' : 'ì‘ë‹µ ì‹¤íŒ¨',
              elapsed: ragChatResult?.elapsed || 0, success: ragChatResult?.success ?? false }
        ];

        const getSpeedColor = (ms) => ms > 3000 ? '#EF4444' : ms > 1000 ? '#F59E0B' : ms > 0 ? '#22c55e' : '#9CA3AF';
        const getSpeedLabel = (ms) => ms > 3000 ? 'ëŠë¦¼' : ms > 1000 ? 'ë³´í†µ' : ms > 0 ? 'ë¹ ë¦„' : '-';

        vizEl.innerHTML = `
            <div class="border-t p-4 sc-panel-reveal" style="background:linear-gradient(135deg,#eef2ff,#e0e7ff);">
                <div class="flex items-center mb-3">
                    <i class="fas fa-brain text-indigo-500 mr-2"></i>
                    <span class="font-semibold text-sm text-indigo-800">AI ê¸°ëŠ¥ ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼</span>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    ${features.map(f => `
                        <div class="bg-white rounded-lg p-3 shadow-sm ${f.active ? 'sc-status-pulse' : ''} flex flex-col items-center text-center">
                            <i class="fas ${f.icon} text-lg mb-1 ${f.success ? 'text-indigo-500' : 'text-gray-300'}"></i>
                            <div class="text-xs font-semibold text-gray-700 mb-1">${f.name}</div>
                            <span class="text-xs px-2 py-0.5 rounded-full font-bold ${f.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-500'}">
                                ${f.success ? 'PASS' : 'FAIL'}
                            </span>
                            <div class="text-xs text-gray-500 mt-1">${f.detail}</div>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-xs font-bold" style="color:${getSpeedColor(f.elapsed)}">${f.elapsed > 0 ? f.elapsed+'ms' : '-'}</span>
                                ${f.elapsed > 0 ? `<span class="text-xs px-1 py-0 rounded" style="background:${getSpeedColor(f.elapsed)}20;color:${getSpeedColor(f.elapsed)};font-size:9px;">${getSpeedLabel(f.elapsed)}</span>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <!-- AI ì‘ë‹µì‹œê°„ ë¹„êµ ë°” ì°¨íŠ¸ -->
                <div class="bg-white rounded-lg p-3 shadow-sm">
                    <div class="text-xs font-semibold text-gray-600 mb-2">AI ê¸°ëŠ¥ë³„ ì‘ë‹µì‹œê°„ ë¹„êµ</div>
                    <div style="height:140px;position:relative;"><canvas id="sc-ai-speed-chart-${catIdx}"></canvas></div>
                </div>
            </div>
        `;
        vizEl.classList.remove('hidden');

        // AI ì‘ë‹µì‹œê°„ ë°” ì°¨íŠ¸
        setTimeout(() => {
            const chartCanvas = document.getElementById(`sc-ai-speed-chart-${catIdx}`);
            if (!chartCanvas) return;
            const chartFeatures = features.filter(f => f.elapsed > 0);
            if (chartFeatures.length === 0) return;
            new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: chartFeatures.map(f => f.name),
                    datasets: [{
                        label: 'ì‘ë‹µì‹œê°„(ms)',
                        data: chartFeatures.map(f => f.elapsed),
                        backgroundColor: chartFeatures.map(f => f.elapsed > 3000 ? 'rgba(239,68,68,0.6)' : f.elapsed > 1000 ? 'rgba(245,158,11,0.6)' : 'rgba(99,102,241,0.6)'),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.x}ms` } } },
                    scales: { x: { grid: { display: false }, ticks: { font: { size: 9 }, callback: v => v+'ms' } }, y: { grid: { display: false }, ticks: { font: { size: 10 } } } }
                }
            });
        }, 200);
    }

    // â”€â”€â”€ ìµœì¢… ëŒ€ì‹œë³´ë“œ ë Œë”ë§ â”€â”€â”€
    function renderFinalDashboard(successCount, failCount, categoryResults, itemResults) {
        const dashEl = document.getElementById('sc-final-dashboard');
        if (!dashEl) return;

        const allPassed = failCount === 0;
        const bannerColor = allPassed ? 'from-green-500 to-emerald-600' : 'from-orange-500 to-red-500';
        const bannerIcon = allPassed ? 'fa-shield-alt' : 'fa-exclamation-triangle';
        const bannerText = allPassed ? 'ëª¨ë“  ì‹œìŠ¤í…œ ì ê²€ í†µê³¼!' : `${failCount}ê°œ í•­ëª©ì—ì„œ ë¬¸ì œ ë°œê²¬`;

        dashEl.innerHTML = `
            <div class="sc-fade-up">
                <div class="rounded-xl p-4 mb-4 text-white shadow-lg bg-gradient-to-r ${bannerColor}">
                    <div class="flex items-center gap-3">
                        <i class="fas ${bannerIcon} text-3xl opacity-90"></i>
                        <div>
                            <div class="text-lg font-bold">${bannerText}</div>
                            <div class="text-sm opacity-90">ì„±ê³µ ${successCount} / ì‹¤íŒ¨ ${failCount} / ì „ì²´ ${successCount + failCount}</div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="text-xs font-semibold text-gray-600 mb-2 text-center">ì„±ê³µ/ì‹¤íŒ¨ ë¹„ìœ¨</div>
                        <div style="height:180px;position:relative;"><canvas id="sc-final-donut"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="text-xs font-semibold text-gray-600 mb-2 text-center">ì¹´í…Œê³ ë¦¬ë³„ ê²°ê³¼</div>
                        <div style="height:180px;position:relative;"><canvas id="sc-final-stack"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="text-xs font-semibold text-gray-600 mb-2 text-center">ì‘ë‹µì‹œê°„ (ëŠë¦° ìˆœ)</div>
                        <div style="height:180px;position:relative;"><canvas id="sc-final-response"></canvas></div>
                    </div>
                </div>
            </div>
        `;
        dashEl.classList.remove('hidden');

        setTimeout(() => {
            const donutC = document.getElementById('sc-final-donut');
            if (donutC) {
                new Chart(donutC, {
                    type: 'doughnut',
                    data: { labels: ['ì„±ê³µ', 'ì‹¤íŒ¨'], datasets: [{ data: [successCount, failCount], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }] },
                    options: { cutout: '65%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, padding: 8 } } } }
                });
            }
            const stackC = document.getElementById('sc-final-stack');
            if (stackC) {
                new Chart(stackC, {
                    type: 'bar',
                    data: {
                        labels: categoryResults.map(c => c.name.substring(0, 5)),
                        datasets: [
                            { label: 'ì„±ê³µ', data: categoryResults.map(c => c.success), backgroundColor: 'rgba(34,197,94,0.7)', borderRadius: 2 },
                            { label: 'ì‹¤íŒ¨', data: categoryResults.map(c => c.fail), backgroundColor: 'rgba(239,68,68,0.7)', borderRadius: 2 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { x: { stacked: true, grid: { display: false }, ticks: { font: { size: 9 } } }, y: { stacked: true, grid: { color: '#f3f4f6' }, ticks: { font: { size: 9 }, stepSize: 1 } } },
                        plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, padding: 8 } } }
                    }
                });
            }
            const respC = document.getElementById('sc-final-response');
            if (respC) {
                const sorted = [...itemResults].filter(r => r.elapsed > 0).sort((a, b) => b.elapsed - a.elapsed).slice(0, 10);
                new Chart(respC, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(r => r.name.substring(0, 8)),
                        datasets: [{ label: 'ì‘ë‹µì‹œê°„(ms)', data: sorted.map(r => r.elapsed),
                            backgroundColor: sorted.map(r => r.elapsed > 1000 ? 'rgba(239,68,68,0.6)' : r.elapsed > 300 ? 'rgba(245,158,11,0.6)' : 'rgba(59,130,246,0.6)'), borderRadius: 3 }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.x}ms` } } },
                        scales: { x: { grid: { display: false }, ticks: { font: { size: 9 } } }, y: { grid: { display: false }, ticks: { font: { size: 9 } } } }
                    }
                });
            }
        }, 200);
    }

    // â”€â”€â”€ ì ê²€ ì‹¤í–‰ í•¨ìˆ˜ â”€â”€â”€
    window.runSystemCheck = async function() {
        const startBtn = document.getElementById('system-check-start-btn');
        if (startBtn) {
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì ê²€ ì¤‘...';
            startBtn.classList.replace('bg-blue-600', 'bg-gray-400');
        }

        let successCount = 0;
        let failCount = 0;
        const totalCount = checkItems.length;
        const responseCache = {};
        const overallStart = Date.now();
        const itemResults = [];
        const categoryResults = categories.map(c => ({ name: c.name, success: 0, fail: 0, total: c.items.length }));

        // ìµœì¢… ëŒ€ì‹œë³´ë“œ & ì‹œê°í™” íŒ¨ë„ ë¦¬ì…‹
        document.getElementById('sc-final-dashboard').classList.add('hidden');
        document.getElementById('sc-final-dashboard').innerHTML = '';
        categories.forEach((cat, idx) => {
            const vizEl = document.getElementById(`sc-viz-${idx}`);
            if (vizEl) { vizEl.innerHTML = ''; vizEl.classList.add('hidden'); }
            const badge = document.getElementById(`sc-cat-badge-${idx}`);
            if (badge) badge.classList.add('hidden');
            const wrapper = document.getElementById(`sc-cat-wrapper-${idx}`);
            if (wrapper) wrapper.classList.remove('sc-celebrate');
        });

        // ìš”ì•½ ì´ˆê¸°í™”
        document.getElementById('sc-success').textContent = '0';
        document.getElementById('sc-fail').textContent = '0';
        document.getElementById('sc-pending').textContent = totalCount;
        document.getElementById('sc-ring-progress').style.strokeDashoffset = '264';
        document.getElementById('sc-ring-progress').style.stroke = '#3B82F6';
        document.getElementById('sc-ring-text').textContent = '0%';
        categories.forEach((cat, idx) => {
            const seg = document.getElementById(`sc-seg-${idx}`);
            if (seg) seg.style.background = 'rgba(255,255,255,0.1)';
        });

        // ëª¨ë“  ì•„ì´ì½˜ ì´ˆê¸°í™”
        for (let i = 0; i < totalCount; i++) {
            document.getElementById(`sc-icon-${i}`).innerHTML = '<i class="far fa-square text-gray-300"></i>';
            const statusEl = document.getElementById(`sc-status-${i}`);
            statusEl.textContent = 'ëŒ€ê¸°';
            statusEl.className = 'text-xs text-gray-400 flex-shrink-0 font-medium';
            statusEl.style.cssText = 'width:56px;min-width:56px;text-align:center';
            const timeEl = document.getElementById(`sc-time-${i}`);
            timeEl.textContent = 'â€”';
            timeEl.className = 'text-xs text-gray-400 flex-shrink-0 font-medium';
            timeEl.style.cssText = 'width:70px;min-width:70px;text-align:right';
            const detailEl = document.getElementById(`sc-detail-${i}`);
            detailEl.textContent = 'â€”';
            detailEl.className = 'text-sm text-gray-600 flex-1 text-right truncate ml-3';
            detailEl.title = '';
            const itemRow = document.getElementById(`sc-item-${i}`);
            if (itemRow) itemRow.classList.remove('sc-checking');
        }

        let prevCatIdx = -1;

        for (let i = 0; i < totalCount; i++) {
            const item = checkItems[i];
            const iconEl = document.getElementById(`sc-icon-${i}`);
            const statusEl = document.getElementById(`sc-status-${i}`);
            const timeEl = document.getElementById(`sc-time-${i}`);
            const detailEl = document.getElementById(`sc-detail-${i}`);
            const itemRow = document.getElementById(`sc-item-${i}`);
            const curCatIdx = categories.findIndex(c => c.name === item.category);

            // ì¹´í…Œê³ ë¦¬ ê²½ê³„ ê°ì§€ â†’ ì´ì „ ì¹´í…Œê³ ë¦¬ ì™„ë£Œ ì²˜ë¦¬
            if (curCatIdx !== prevCatIdx && prevCatIdx >= 0) {
                const prevResult = categoryResults[prevCatIdx];
                const badge = document.getElementById(`sc-cat-badge-${prevCatIdx}`);
                if (badge) {
                    badge.classList.remove('hidden');
                    if (prevResult.fail === 0) {
                        badge.className = 'ml-2 text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-bold';
                        badge.textContent = 'ALL PASS';
                    } else {
                        badge.className = 'ml-2 text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-bold';
                        badge.textContent = `${prevResult.fail} FAIL`;
                    }
                }
                const wrapper = document.getElementById(`sc-cat-wrapper-${prevCatIdx}`);
                if (wrapper) wrapper.classList.add('sc-celebrate');
                renderCategoryViz(prevCatIdx, categories[prevCatIdx].name, responseCache, prevResult, itemResults);
            }
            prevCatIdx = curCatIdx;

            // í˜„ì¬ í•­ëª©ì— ë°œê´‘ íš¨ê³¼
            if (itemRow) itemRow.classList.add('sc-checking');
            iconEl.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';
            statusEl.textContent = 'ê²€ì‚¬ì¤‘';
            statusEl.className = 'text-xs text-blue-500 flex-shrink-0 font-semibold';
            statusEl.style.cssText = 'width:56px;min-width:56px;text-align:center';

            const itemStart = Date.now();
            let itemElapsed = 0;
            let itemSuccess = false;

            try {
                let response;
                const cacheKey = `${item.method}:${item.endpoint}`;
                if (!item.noCache && responseCache[cacheKey]) {
                    response = responseCache[cacheKey];
                } else {
                    const axiosOpts = { method: item.method, url: `${API_BASE_URL}${item.endpoint}`, timeout: item.noCache ? 60000 : 10000 };
                    if (item.body && item.formData) {
                        const fd = new FormData();
                        Object.entries(item.body).forEach(([k, v]) => fd.append(k, v));
                        axiosOpts.data = fd;
                    } else if (item.body) {
                        axiosOpts.data = item.body;
                    }
                    response = await axios(axiosOpts);
                    if (!item.noCache) responseCache[cacheKey] = response;
                }
                itemElapsed = Date.now() - itemStart;

                if (item.validate(response)) {
                    successCount++;
                    itemSuccess = true;
                    categoryResults[curCatIdx].success++;
                    iconEl.innerHTML = '<i class="fas fa-check-circle text-green-600"></i>';
                    statusEl.textContent = 'ì„±ê³µ';
                    statusEl.className = 'text-xs text-green-600 flex-shrink-0 font-semibold sc-slide-in';
                    statusEl.style.cssText = 'width:56px;min-width:56px;text-align:center';
                    timeEl.textContent = `${itemElapsed}ms`;
                    timeEl.className = 'text-xs text-green-600 flex-shrink-0 font-semibold';
                    timeEl.style.cssText = 'width:70px;min-width:70px;text-align:right';
                    if (item.detail) {
                        try {
                            const detailText = item.detail(response);
                            detailEl.textContent = detailText;
                            detailEl.title = detailText;
                            detailEl.className = 'text-sm text-green-700 flex-1 text-right truncate ml-3 font-medium sc-slide-in';
                        } catch(e) { detailEl.textContent = 'â€”'; }
                    }
                } else {
                    failCount++;
                    categoryResults[curCatIdx].fail++;
                    iconEl.innerHTML = '<i class="fas fa-times-circle text-red-600"></i>';
                    statusEl.textContent = 'ì‹¤íŒ¨';
                    statusEl.className = 'text-xs text-red-600 flex-shrink-0 font-semibold sc-slide-in';
                    statusEl.style.cssText = 'width:56px;min-width:56px;text-align:center';
                    timeEl.textContent = `${itemElapsed}ms`;
                    timeEl.className = 'text-xs text-red-600 flex-shrink-0 font-semibold';
                    timeEl.style.cssText = 'width:70px;min-width:70px;text-align:right';
                    detailEl.textContent = 'ê²€ì¦ ì‹¤íŒ¨';
                    detailEl.title = 'ê²€ì¦ ì‹¤íŒ¨';
                    detailEl.className = 'text-sm text-red-600 flex-1 text-right truncate ml-3 font-medium sc-slide-in';
                }
            } catch (err) {
                itemElapsed = Date.now() - itemStart;
                failCount++;
                categoryResults[curCatIdx].fail++;
                iconEl.innerHTML = '<i class="fas fa-times-circle text-red-600"></i>';
                statusEl.textContent = 'ì‹¤íŒ¨';
                statusEl.className = 'text-xs text-red-600 flex-shrink-0 font-semibold sc-slide-in';
                statusEl.style.cssText = 'width:56px;min-width:56px;text-align:center';
                timeEl.textContent = `${itemElapsed}ms`;
                timeEl.className = 'text-xs text-red-600 flex-shrink-0 font-semibold';
                timeEl.style.cssText = 'width:70px;min-width:70px;text-align:right';
                detailEl.textContent = err.response?.data?.detail || err.message || 'ì˜¤ë¥˜';
                detailEl.title = detailEl.textContent;
                detailEl.className = 'text-sm text-red-600 flex-1 text-right truncate ml-3 font-medium sc-slide-in';
            }

            if (itemRow) itemRow.classList.remove('sc-checking');
            itemResults.push({ name: item.name, category: item.category, success: itemSuccess, elapsed: itemElapsed });

            // ìš”ì•½ ì—…ë°ì´íŠ¸
            document.getElementById('sc-success').textContent = successCount;
            document.getElementById('sc-fail').textContent = failCount;
            document.getElementById('sc-pending').textContent = totalCount - successCount - failCount;
            const progress = ((successCount + failCount) / totalCount * 100);
            document.getElementById('sc-elapsed').textContent = `ê²½ê³¼: ${((Date.now() - overallStart) / 1000).toFixed(1)}ì´ˆ`;

            // ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ë§ ì—…ë°ì´íŠ¸
            const ringOffset = 264 - (264 * progress / 100);
            const ringEl = document.getElementById('sc-ring-progress');
            if (ringEl) {
                ringEl.style.strokeDashoffset = ringOffset;
                if (failCount > 0) ringEl.style.stroke = '#F59E0B';
            }
            document.getElementById('sc-ring-text').textContent = `${Math.round(progress)}%`;

            // ì„¸ê·¸ë¨¼íŠ¸ ë°” ì—…ë°ì´íŠ¸
            const segDone = categoryResults[curCatIdx].success + categoryResults[curCatIdx].fail;
            const segTotal = categoryResults[curCatIdx].total;
            const seg = document.getElementById(`sc-seg-${curCatIdx}`);
            if (seg) {
                const segProgress = (segDone / segTotal * 100);
                const segColor = categoryResults[curCatIdx].fail > 0 ? '#F59E0B' : categoryColors[curCatIdx];
                seg.style.background = `linear-gradient(90deg, ${segColor} ${segProgress}%, rgba(255,255,255,0.1) ${segProgress}%)`;
            }
        }

        // ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
        if (prevCatIdx >= 0) {
            const lastResult = categoryResults[prevCatIdx];
            const badge = document.getElementById(`sc-cat-badge-${prevCatIdx}`);
            if (badge) {
                badge.classList.remove('hidden');
                if (lastResult.fail === 0) {
                    badge.className = 'ml-2 text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-bold';
                    badge.textContent = 'ALL PASS';
                } else {
                    badge.className = 'ml-2 text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-bold';
                    badge.textContent = `${lastResult.fail} FAIL`;
                }
            }
            const wrapper = document.getElementById(`sc-cat-wrapper-${prevCatIdx}`);
            if (wrapper) wrapper.classList.add('sc-celebrate');
            renderCategoryViz(prevCatIdx, categories[prevCatIdx].name, responseCache, lastResult, itemResults);
        }

        // ì™„ë£Œ
        const totalElapsed = ((Date.now() - overallStart) / 1000).toFixed(1);
        document.getElementById('sc-elapsed').textContent = `ì™„ë£Œ: ${totalElapsed}ì´ˆ`;
        const ringEl = document.getElementById('sc-ring-progress');
        if (ringEl) {
            ringEl.style.strokeDashoffset = '0';
            ringEl.style.stroke = failCount === 0 ? '#22c55e' : '#ef4444';
        }
        document.getElementById('sc-ring-text').textContent = '100%';

        categories.forEach((cat, idx) => {
            const seg = document.getElementById(`sc-seg-${idx}`);
            if (seg) seg.style.background = categoryResults[idx].fail > 0 ? '#EF4444' : '#22c55e';
        });

        setTimeout(() => renderFinalDashboard(successCount, failCount, categoryResults, itemResults), 300);

        if (startBtn) {
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì ê²€';
            startBtn.classList.replace('bg-gray-400', 'bg-blue-600');
        }
    };

    // ì¹´í…Œê³ ë¦¬ë³„ ì‹œê°í™” ë¼ìš°í„°
    function renderCategoryViz(catIdx, catName, responseCache, catResult, itemResults) {
        switch(catName) {
            case 'ì¸í”„ë¼ ì ê²€': renderInfraViz(catIdx, responseCache); break;
            case 'ê¸°ë³¸ ë°ì´í„° CRUD': renderCrudViz(catIdx, responseCache, catResult); break;
            case 'AI ê³¼ì • ì¼ì • ê³„ì‚°': renderScheduleViz(catIdx); break;
            case 'ê°•ì˜ ì‹œê°„í‘œ ì¡°ì •': renderTimetableViz(catIdx, responseCache); break;
            case 'ë¬¸ì œì€í–‰': renderExamBankViz(catIdx, responseCache); break;
            case 'ì‹œí—˜/í€´ì¦ˆ/ê³¼ì œ': renderExamQuizViz(catIdx, responseCache); break;
            case 'AI ê¸°ëŠ¥': renderAiFeaturesViz(catIdx, responseCache, itemResults); break;
        }
    }
}

console.log('âœ… ì‹œìŠ¤í…œ ì ê²€ í•¨ìˆ˜ ë¡œë“œ ì™„ë£Œ');

