<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="description" content="교육 과정 소개">
    <meta name="theme-color" content="#10b981">

    <title>과정 소개 - 교육관리시스템</title>

    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>

    <script>
        var __THEME_COLOR__ = null;
        var __LOGO_URL__ = null;
        try {
            const savedTheme = localStorage.getItem('system_theme');
            if (savedTheme) {
                const theme = JSON.parse(savedTheme);
                if (theme && theme.menubar) __THEME_COLOR__ = theme.menubar;
            }
            __LOGO_URL__ = localStorage.getItem('logo_url');
            if (__LOGO_URL__) {
                let faviconUrl = __LOGO_URL__;
                if (__LOGO_URL__.startsWith('ftp://')) {
                    faviconUrl = '/api/download-image?url=' + encodeURIComponent(__LOGO_URL__);
                }
                const favicon = document.querySelector('link[rel="icon"]');
                if (favicon) favicon.href = faviconUrl;
            }
        } catch(e) {}
    </script>

    <style>
        .info-card {
            transition: all 0.3s ease;
        }
        .info-card:hover {
            transform: translateY(-2px);
        }
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #10b981, #3b82f6);
            border-radius: 3px;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 13px;
            height: 13px;
            background: #10b981;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #10b981;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-teal-100 min-h-screen">
    <!-- 헤더 -->
    <header class="bg-gradient-to-r from-green-500 to-teal-500 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/login.html" class="text-white hover:text-green-100 transition-colors">
                        <i class="fas fa-arrow-left text-2xl"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-graduation-cap mr-3"></i>과정 소개
                        </h1>
                        <p class="text-green-100 text-sm mt-1">교육 과정 상세 정보를 확인하세요</p>
                    </div>
                </div>
                <div class="inline-block bg-white rounded-lg overflow-hidden shadow-md" style="width: 120px; height: 48px;">
                    <script>
                        var logoSrc = __LOGO_URL__ || '/woosong-logo.png';
                        if (logoSrc.startsWith('ftp://')) {
                            logoSrc = '/api/download-image?url=' + encodeURIComponent(logoSrc);
                        }
                        document.write('<img id="header-logo" src="' + logoSrc + '" alt="로고" style="width: 100%; height: 100%; object-fit: fill;">');
                    </script>
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 콘텐츠 -->
    <main class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 과정 선택 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <label class="block text-lg font-semibold text-gray-700 mb-3">
                <i class="fas fa-list mr-2 text-green-500"></i>과정 선택
            </label>
            <select id="courseSelect" onchange="loadCourseDetail()"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none text-lg">
                <option value="">-- 과정을 선택하세요 --</option>
            </select>
        </div>

        <!-- 로딩 -->
        <div id="loadingState" class="hidden bg-white rounded-2xl shadow-xl p-12 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-green-500 mb-4"></i>
            <p class="text-gray-500">과정 정보를 불러오는 중...</p>
        </div>

        <!-- 과정 상세 정보 -->
        <div id="courseDetail" class="hidden space-y-6">
            <!-- 과정 기본 정보 헤더 -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-teal-500 p-6 text-white">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold" id="courseName"></h2>
                            <p class="text-green-100 mt-2 flex items-center">
                                <i class="fas fa-hashtag mr-2"></i>
                                <span id="courseCode"></span>
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="bg-white/20 rounded-lg px-4 py-2">
                                <p class="text-sm text-green-100">현재 수강생</p>
                                <p class="text-2xl font-bold"><span id="studentCount">0</span>명</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 핵심 정보 그리드 -->
                <div class="p-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="info-card bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center border border-blue-200">
                            <i class="fas fa-users text-blue-500 text-2xl mb-2"></i>
                            <p class="text-xs text-gray-600 mb-1">모집 정원</p>
                            <p class="font-bold text-xl text-gray-800"><span id="courseCapacity">-</span>명</p>
                        </div>
                        <div class="info-card bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center border border-purple-200">
                            <i class="fas fa-calendar-check text-purple-500 text-2xl mb-2"></i>
                            <p class="text-xs text-gray-600 mb-1">총 교육일수</p>
                            <p class="font-bold text-xl text-gray-800"><span id="courseTotalDays">-</span>일</p>
                        </div>
                        <div class="info-card bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 text-center border border-orange-200">
                            <i class="fas fa-clock text-orange-500 text-2xl mb-2"></i>
                            <p class="text-xs text-gray-600 mb-1">총 교육시간</p>
                            <p class="font-bold text-xl text-gray-800"><span id="courseTotalHours">-</span>시간</p>
                        </div>
                        <div class="info-card bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 text-center border border-green-200">
                            <i class="fas fa-map-marker-alt text-green-500 text-2xl mb-2"></i>
                            <p class="text-xs text-gray-600 mb-1">교육 장소</p>
                            <p class="font-bold text-sm text-gray-800 truncate" id="courseLocation">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 교육 일정 타임라인 -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-calendar-alt text-blue-500 mr-3"></i>교육 일정
                </h3>
                <div class="space-y-6" id="courseTimeline">
                    <!-- 타임라인 아이템들이 여기에 동적으로 추가됨 -->
                </div>
            </div>

            <!-- 교육 시간 상세 -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-hourglass-half text-indigo-500 mr-3"></i>교육 시간 구성
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-indigo-600 font-semibold"><i class="fas fa-chalkboard-teacher mr-2"></i>강의</span>
                            <span class="text-2xl font-bold text-indigo-700"><span id="lectureHours">0</span>시간</span>
                        </div>
                        <div class="w-full bg-indigo-200 rounded-full h-2">
                            <div id="lectureBar" class="bg-indigo-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-teal-50 rounded-xl p-4 border border-teal-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-teal-600 font-semibold"><i class="fas fa-project-diagram mr-2"></i>프로젝트</span>
                            <span class="text-2xl font-bold text-teal-700"><span id="projectHours">0</span>시간</span>
                        </div>
                        <div class="w-full bg-teal-200 rounded-full h-2">
                            <div id="projectBar" class="bg-teal-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-amber-600 font-semibold"><i class="fas fa-building mr-2"></i>현장실습</span>
                            <span class="text-2xl font-bold text-amber-700"><span id="workshipHours">0</span>시간</span>
                        </div>
                        <div class="w-full bg-amber-200 rounded-full h-2">
                            <div id="workshipBar" class="bg-amber-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between">
                    <span class="text-gray-600">
                        <i class="fas fa-sun text-yellow-500 mr-2"></i>오전 <span id="morningHours">4</span>시간 /
                        <i class="fas fa-moon text-blue-500 ml-3 mr-2"></i>오후 <span id="afternoonHours">4</span>시간
                    </span>
                    <span class="font-bold text-gray-800">일 <span id="dailyHours">8</span>시간</span>
                </div>
            </div>

            <!-- 특이사항 / 비고 -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-star text-yellow-500 mr-3"></i>과정 특이사항
                </h3>
                <div id="courseNotes" class="bg-gradient-to-br from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl p-5 text-gray-700 whitespace-pre-wrap leading-relaxed">
                </div>
            </div>

            <!-- 교과목 목록 -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-book-open text-blue-500 mr-3"></i>교과목 (<span id="subjectCount">0</span>개)
                </h3>
                <div id="courseSubjects" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                </div>
            </div>

            <!-- 신규 수강 신청 버튼 -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <button
                    type="button"
                    onclick="goToRegister()"
                    class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg text-lg"
                >
                    <i class="fas fa-user-plus mr-2"></i>이 과정으로 신규 수강 신청하기
                </button>
                <p class="text-center text-gray-500 text-sm mt-3">
                    <i class="fas fa-info-circle mr-1"></i>신청 후 관리자 승인이 필요합니다
                </p>
            </div>
        </div>

        <!-- 빈 상태 -->
        <div id="emptyState" class="bg-white rounded-2xl shadow-xl p-12 text-center">
            <i class="fas fa-hand-pointer text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">위에서 과정을 선택하면 상세 정보가 표시됩니다.</p>
        </div>
    </main>

    <!-- 하단 네비게이션 -->
    <footer class="bg-white border-t border-gray-200 py-4 mt-8">
        <div class="container mx-auto px-4 flex flex-wrap justify-center gap-3">
            <a href="/login.html" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 transition-colors text-sm">
                <i class="fas fa-sign-in-alt mr-1"></i>로그인
            </a>
            <a href="/register.html" class="px-5 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm">
                <i class="fas fa-user-plus mr-1"></i>신규수강신청
            </a>
            <a href="/education-support.html" class="px-5 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors text-sm">
                <i class="fas fa-hand-holding-usd mr-1"></i>교육지원제도
            </a>
        </div>
    </footer>

    <script>
        const API_BASE_URL = window.location.origin.replace('3000', '8000');
        let selectedCourseCode = null;

        // 페이지 로드 시 과정 목록 불러오기
        async function loadCourses() {
            try {
                const response = await axios.get(`${API_BASE_URL}/api/courses`);
                const courses = response.data || [];

                const select = document.getElementById('courseSelect');
                select.innerHTML = '<option value="">-- 과정을 선택하세요 --</option>';

                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.code;
                    option.textContent = course.name;
                    select.appendChild(option);
                });

                // URL 파라미터에서 과정 코드 확인
                const urlParams = new URLSearchParams(window.location.search);
                const preselectedCourse = urlParams.get('course');
                if (preselectedCourse) {
                    select.value = preselectedCourse;
                    loadCourseDetail();
                }

            } catch (error) {
                console.error('과정 목록 로드 실패:', error);
            }
        }

        // 날짜 포맷팅
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // 과정 상세 정보 로드
        async function loadCourseDetail() {
            const courseCode = document.getElementById('courseSelect').value;
            selectedCourseCode = courseCode;

            if (!courseCode) {
                document.getElementById('courseDetail').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('loadingState').classList.add('hidden');
                return;
            }

            // 로딩 표시
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('courseDetail').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');

            try {
                // 과정 상세 정보 로드
                const courseResponse = await axios.get(`${API_BASE_URL}/api/courses/${courseCode}`);
                const course = courseResponse.data;

                // 교과목 목록 로드
                const subjectsResponse = await axios.get(`${API_BASE_URL}/api/subjects?course_code=${courseCode}`);
                const subjects = subjectsResponse.data || [];

                // 기본 정보 표시
                document.getElementById('courseName').textContent = course.name || '-';
                document.getElementById('courseCode').textContent = course.code || '-';
                document.getElementById('courseCapacity').textContent = course.capacity || '-';
                document.getElementById('courseTotalDays').textContent = course.total_days || '-';
                document.getElementById('courseLocation').textContent = course.location || '미정';
                document.getElementById('studentCount').textContent = course.student_count || 0;

                // 교육 시간
                const lectureHours = course.lecture_hours || 0;
                const projectHours = course.project_hours || 0;
                const workshipHours = course.internship_hours || course.workship_hours || 0;
                const totalHours = lectureHours + projectHours + workshipHours;
                const subjectTotalHours = subjects.reduce((sum, s) => sum + (s.hours || 0), 0);

                document.getElementById('lectureHours').textContent = lectureHours;
                document.getElementById('projectHours').textContent = projectHours;
                document.getElementById('workshipHours').textContent = workshipHours;
                document.getElementById('courseTotalHours').textContent = totalHours || subjectTotalHours;

                // 시간 막대 그래프
                if (totalHours > 0) {
                    document.getElementById('lectureBar').style.width = `${(lectureHours / totalHours) * 100}%`;
                    document.getElementById('projectBar').style.width = `${(projectHours / totalHours) * 100}%`;
                    document.getElementById('workshipBar').style.width = `${(workshipHours / totalHours) * 100}%`;
                }

                // 오전/오후 시간
                const morningHours = course.morning_hours || 4;
                const afternoonHours = course.afternoon_hours || 4;
                document.getElementById('morningHours').textContent = morningHours;
                document.getElementById('afternoonHours').textContent = afternoonHours;
                document.getElementById('dailyHours').textContent = morningHours + afternoonHours;

                // 교육 일정 타임라인
                const timelineDiv = document.getElementById('courseTimeline');
                const timelineItems = [];

                if (course.start_date) {
                    timelineItems.push({
                        date: course.start_date,
                        label: '교육 시작',
                        color: 'green',
                        icon: 'fa-play-circle'
                    });
                }
                if (course.lecture_end_date) {
                    timelineItems.push({
                        date: course.lecture_end_date,
                        label: '강의 종료',
                        color: 'blue',
                        icon: 'fa-chalkboard-teacher'
                    });
                }
                if (course.project_end_date) {
                    timelineItems.push({
                        date: course.project_end_date,
                        label: '프로젝트 종료',
                        color: 'teal',
                        icon: 'fa-project-diagram'
                    });
                }
                if (course.internship_end_date || course.workship_end_date) {
                    timelineItems.push({
                        date: course.internship_end_date || course.workship_end_date,
                        label: '현장실습 종료',
                        color: 'amber',
                        icon: 'fa-building'
                    });
                }
                if (course.final_end_date || course.end_date) {
                    timelineItems.push({
                        date: course.final_end_date || course.end_date,
                        label: '교육 종료',
                        color: 'red',
                        icon: 'fa-flag-checkered'
                    });
                }

                if (timelineItems.length > 0) {
                    timelineDiv.innerHTML = timelineItems.map(item => `
                        <div class="timeline-item bg-${item.color}-50 rounded-xl p-4 border border-${item.color}-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas ${item.icon} text-${item.color}-500 text-xl mr-3"></i>
                                    <span class="font-semibold text-gray-800">${item.label}</span>
                                </div>
                                <span class="text-${item.color}-600 font-bold">${formatDate(item.date)}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    timelineDiv.innerHTML = '<p class="text-gray-400 text-center py-4">등록된 일정이 없습니다.</p>';
                }

                // 특이사항 / 비고 표시
                const notesDiv = document.getElementById('courseNotes');
                const notes = course.special_notes || course.notes || '';
                if (notes && notes.trim()) {
                    notesDiv.textContent = notes;
                } else {
                    notesDiv.innerHTML = '<span class="text-gray-400 italic">등록된 특이사항이 없습니다.</span>';
                }

                // 교과목 목록 표시
                document.getElementById('subjectCount').textContent = subjects.length;
                const subjectsDiv = document.getElementById('courseSubjects');
                if (subjects.length > 0) {
                    subjectsDiv.innerHTML = subjects.map((subj, idx) => `
                        <div class="flex items-center bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                            <span class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 text-white flex items-center justify-center font-bold mr-4 shadow-md">${idx + 1}</span>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${subj.name}</p>
                                <p class="text-sm text-gray-500"><i class="fas fa-clock mr-1"></i>${subj.hours || 0}시간</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    subjectsDiv.innerHTML = '<p class="text-gray-400 text-center py-4 col-span-2">등록된 교과목이 없습니다.</p>';
                }

                // 상세 정보 표시
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('courseDetail').classList.remove('hidden');

            } catch (error) {
                console.error('과정 상세 정보 로드 실패:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // 신규 수강 신청 페이지로 이동
        function goToRegister() {
            if (selectedCourseCode) {
                window.location.href = `/register.html?course=${selectedCourseCode}`;
            } else {
                window.location.href = '/register.html';
            }
        }

        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', loadCourses);
    </script>
</body>
</html>
