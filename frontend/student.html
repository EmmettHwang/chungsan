<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>í•™ìƒ MyPage - ë°”ì´ì˜¤í—¬ìŠ¤êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- ë§ˆí¬ë‹¤ìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <style>
        /* ë§ˆí¬ë‹¤ìš´ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .prose {
            max-width: none;
        }
        .prose h1 { font-size: 2em; font-weight: bold; margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose h2 { font-size: 1.5em; font-weight: bold; margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose h3 { font-size: 1.25em; font-weight: bold; margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.6; }
        .prose ul, .prose ol { margin-left: 1.5em; margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose li { margin-top: 0.25em; margin-bottom: 0.25em; }
        .prose a { color: #3b82f6; text-decoration: underline; }
        .prose a:hover { color: #2563eb; }
        .prose code { background-color: #f3f4f6; padding: 0.2em 0.4em; border-radius: 0.25rem; font-size: 0.9em; }
        .prose pre { background-color: #1f2937; color: #f3f4f6; padding: 1em; border-radius: 0.5rem; overflow-x: auto; margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose pre code { background-color: transparent; padding: 0; color: inherit; }
        .prose blockquote { border-left: 4px solid #d1d5db; padding-left: 1em; color: #6b7280; margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose strong { font-weight: bold; }
        .prose em { font-style: italic; }
        .prose hr { border-top: 1px solid #e5e7eb; margin-top: 1em; margin-bottom: 1em; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- í—¤ë” -->
    <header class="bg-gradient-to-r from-green-600 to-teal-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.goToHome()">
                <i class="fas fa-user-graduate text-3xl"></i>
                <div>
                    <h1 class="text-2xl font-bold">í•™ìƒ MyPage</h1>
                    <p class="text-sm text-green-100">í™˜ì˜í•©ë‹ˆë‹¤, <span id="studentName"></span>ë‹˜!</p>
                </div>
            </div>
            <button onclick="window.logout()" class="bg-white text-green-600 hover:bg-green-50 px-4 py-2 rounded-lg font-semibold transition-all">
                <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </header>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex gap-2">
                    <button onclick="showTab('profile')" 
                            id="tab-profile"
                            class="px-6 py-3 font-semibold transition-all border-b-2 border-transparent hover:border-green-500 hover:text-green-600">
                        <i class="fas fa-user mr-2"></i>ë‚´ ì •ë³´
                    </button>
                    <button onclick="showTab('notes')" 
                            id="tab-notes"
                            class="px-6 py-3 font-semibold transition-all border-b-2 border-green-500 text-green-600">
                        <i class="fas fa-book-open mr-2"></i>SSIRN
                    </button>
                    <button onclick="showTab('notices')"
                            id="tab-notices"
                            class="px-6 py-3 font-semibold transition-all border-b-2 border-transparent hover:border-green-500 hover:text-green-600">
                        <i class="fas fa-bullhorn mr-2"></i>ê³µì§€ì‚¬í•­
                    </button>
                    <button onclick="showTab('exam')"
                            id="tab-exam"
                            class="px-6 py-3 font-semibold transition-all border-b-2 border-transparent hover:border-green-500 hover:text-green-600">
                        <i class="fas fa-laptop mr-2"></i>ì˜¨ë¼ì¸ì‹œí—˜/ê³¼ì œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- SSIRN ì„¹ì…˜ -->
            <div id="section-notes">
            <!-- SSIRN ì¹´ë“œ -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold flex items-center">
                                <i class="fas fa-book-open mr-3"></i>
                                SSIRN
                            </h2>
                            <p class="text-blue-100 mt-2 text-sm">ìˆ˜ì—… ë‚´ìš©ì„ ê¸°ë¡í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
                        </div>
                        <button onclick="showNewNoteModal()" 
                                class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 font-semibold">
                            <i class="fas fa-plus mr-2"></i>ìƒˆ ë©”ëª¨
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- ê²€ìƒ‰ ë° í•„í„° -->
                    <div class="mb-6 flex gap-2">
                        <div class="flex-1">
                            <input type="text" id="note-search" 
                                   placeholder="ë‚´ìš© ê²€ìƒ‰..." 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   onkeyup="searchNotes()">
                        </div>
                        <input type="date" id="note-date-filter" 
                               class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                               onchange="searchNotes()">
                        <button onclick="clearNoteFilters()" 
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- ë©”ëª¨ ê°œìˆ˜ -->
                    <div class="mb-4 text-sm text-gray-600">
                        ì´ <span id="notes-count" class="font-bold text-blue-600">0</span>ê°œì˜ ë©”ëª¨
                    </div>
                    
                    <!-- ë©”ëª¨ ê·¸ë¦¬ë“œ -->
                    <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- ë©”ëª¨ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <!-- ë¹ˆ ìƒíƒœ -->
                    <div id="notes-empty" class="hidden text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <button onclick="showNewNoteModal()" 
                                class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>ì²« ë©”ëª¨ ì‘ì„±í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
            </div>
            <!-- SSIRN ì„¹ì…˜ ë -->
            
            <!-- í”„ë¡œí•„ ì„¹ì…˜ -->
            <div id="section-profile" class="hidden">
            <!-- í”„ë¡œí•„ ì¹´ë“œ -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                <!-- í”„ë¡œí•„ í—¤ë” -->
                <div class="bg-gradient-to-r from-green-600 to-teal-600 p-8 text-white text-center">
                    <div class="inline-block relative">
                        <img id="student-photo" 
                             src="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect fill=%27%23e5e7eb%27 width=%27200%27 height=%27200%27/%3E%3Ctext fill=%27%239ca3af%27 font-family=%27Arial%27 font-size=%2714%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dominant-baseline=%27middle%27%3ENo Photo%3C/text%3E%3C/svg%3E" 
                             alt="í”„ë¡œí•„ ì‚¬ì§„" 
                             class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg mx-auto"
                             onerror="this.style.backgroundColor='#e5e7eb'">
                        <button onclick="document.getElementById('student-photo-input').click()" 
                                class="absolute bottom-0 right-0 bg-white text-green-600 rounded-full p-2 shadow-lg hover:bg-green-50">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <input type="file" id="student-photo-input" accept="image/*" class="hidden" onchange="uploadStudentPhoto(event)">
                    <p class="text-sm text-green-100 mt-3">í´ë¦­í•˜ì—¬ í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</p>
                    
                    <!-- í”„ë¡œê·¸ë˜ìŠ¤ë°” -->
                    <div id="student-upload-progress" class="hidden mt-4 max-w-md mx-auto">
                        <div class="w-full bg-green-200 rounded-full h-2.5">
                            <div id="student-progress-bar" class="bg-white h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="student-progress-text" class="text-sm text-white mt-2 text-center">ì—…ë¡œë“œ ì¤‘... 0%</p>
                    </div>
                </div>

                <!-- í”„ë¡œí•„ ì •ë³´ -->
                <div class="p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-id-card mr-3 text-green-600"></i>
                        ë‚´ ì •ë³´
                    </h2>
                    
                    <form id="student-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- ì´ë¦„ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-user mr-2 text-blue-500"></i>ì´ë¦„
                                </label>
                                <input type="text" id="student-name" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 bg-gray-50" readonly>
                            </div>
                            
                            <!-- ìƒë…„ì›”ì¼ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-birthday-cake mr-2 text-pink-500"></i>ìƒë…„ì›”ì¼
                                </label>
                                <input type="text" id="student-birth-date" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            
                            <!-- ì„±ë³„ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-venus-mars mr-2 text-purple-500"></i>ì„±ë³„
                                </label>
                                <select id="student-gender" 
                                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">ì„ íƒ</option>
                                    <option value="ë‚¨">ë‚¨</option>
                                    <option value="ì—¬">ì—¬</option>
                                </select>
                            </div>
                            
                            <!-- ì—°ë½ì²˜ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-phone mr-2 text-yellow-500"></i>ì—°ë½ì²˜
                                </label>
                                <input type="tel" id="student-phone" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        
                        <!-- ì´ë©”ì¼ -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-envelope mr-2 text-red-500"></i>ì´ë©”ì¼
                            </label>
                            <input type="email" id="student-email" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <!-- ì£¼ì†Œ -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-map-marker-alt mr-2 text-orange-500"></i>ì£¼ì†Œ
                            </label>
                            <input type="text" id="student-address" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <!-- ê´€ì‹¬ë¶„ì•¼ -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-heart mr-2 text-pink-500"></i>ê´€ì‹¬ë¶„ì•¼
                            </label>
                            <input type="text" id="student-interests" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                   placeholder="ê´€ì‹¬ ìˆëŠ” ë¶„ì•¼ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <!-- í•™ë ¥ -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-graduation-cap mr-2 text-indigo-500"></i>í•™ë ¥
                            </label>
                            <input type="text" id="student-education" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                   placeholder="ìµœì¢… í•™êµ/í•™ë…„(ì¡¸ì—…)">
                        </div>
                        
                        <!-- ìê¸°ì†Œê°œ -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-comment-dots mr-2 text-teal-500"></i>ìê¸°ì†Œê°œ
                            </label>
                            <textarea id="student-introduction" rows="4"
                                      class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                      placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš” (200ì ë‚´ì™¸)"></textarea>
                        </div>
                        
                        <!-- íŒŒì¼ ì²¨ë¶€ -->
                        <div class="border-t pt-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-paperclip mr-2 text-green-500"></i>ì‚¬ì§„ ë° íŒŒì¼ ì²¨ë¶€ (ê·¸ë¦¼íŒŒì¼, PDF, HWP, PPT, Excel, Word, TXT ë“±)
                            </h4>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <button type="button" onclick="document.getElementById('student-file-input').click()" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                        <i class="fas fa-folder-open mr-2"></i>íŒŒì¼ ì„ íƒ
                                    </button>
                                    <button type="button" onclick="document.getElementById('student-camera-input').click()" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">
                                        <i class="fas fa-camera mr-2"></i>ì‚¬ì§„ ì´¬ì˜
                                    </button>
                                </div>
                                <input type="file" id="student-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                                       onchange="uploadStudentFiles(event)" class="hidden">
                                <input type="file" id="student-camera-input" accept="image/*"  
                                       onchange="uploadStudentFiles(event)" class="hidden">
                                <div id="student-file-upload-progress" class="hidden mb-3">
                                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                        <p class="text-sm text-blue-800 mb-2">
                                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                                            ì„œë²„ì— ì—…ë¡œë“œ í›„ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”...
                                        </p>
                                        <div class="w-full bg-blue-200 rounded-full h-2">
                                            <div id="student-file-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="student-file-list" class="flex flex-col gap-2 mt-2"></div>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ì²¨ë¶€ íŒŒì¼: <span id="student-file-count">0</span>/20
                                </p>
                            </div>
                        </div>
                        
                        <!-- ì €ì¥ ë²„íŠ¼ -->
                        <div class="flex gap-3 pt-4">
                            <button type="button" onclick="saveStudentProfile()" 
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                                <i class="fas fa-save mr-2"></i>ì €ì¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- ê³¼ì • ì •ë³´ ì¹´ë“œ -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-book-open mr-3 text-green-600"></i>
                    ìˆ˜ê°• ê³¼ì • ì •ë³´
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-center gap-3 p-4 bg-green-50 rounded-lg">
                        <i class="fas fa-chalkboard-teacher text-2xl text-green-600"></i>
                        <div>
                            <p class="text-sm text-gray-600">ê³¼ì •ëª…</p>
                            <p class="font-semibold text-gray-800" id="course-name">-</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3 p-4 bg-blue-50 rounded-lg">
                        <i class="fas fa-calendar-alt text-2xl text-blue-600"></i>
                        <div>
                            <p class="text-sm text-gray-600">êµìœ¡ê¸°ê°„</p>
                            <p class="font-semibold text-gray-800" id="course-period">-</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- í”„ë¡œí•„ ì„¹ì…˜ ë -->
            
            <!-- ê³µì§€ì‚¬í•­ ì„¹ì…˜ -->
            <div id="section-notices" class="hidden">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-bullhorn mr-3"></i>
                            ê³µì§€ì‚¬í•­
                        </h2>
                        <p class="text-purple-100 mt-2 text-sm">ì¤‘ìš”í•œ ê³µì§€ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                    
                    <div class="p-6">
                        <div id="student-notices-list" class="space-y-4">
                            <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        <div id="student-notices-empty" class="hidden text-center py-12 text-gray-500">
                            <i class="fas fa-inbox text-6xl mb-4"></i>
                            <p>ê²Œì‹œëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ê³µì§€ì‚¬í•­ ì„¹ì…˜ ë -->

            <!-- ì˜¨ë¼ì¸ì‹œí—˜/ê³¼ì œ ì„¹ì…˜ -->
            <div id="section-exam" class="hidden">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-6 text-white">
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-laptop mr-3"></i>
                            ì˜¨ë¼ì¸ì‹œí—˜/ê³¼ì œ
                        </h2>
                        <p class="text-blue-100 mt-2 text-sm">ì§„í–‰ ì¤‘ì¸ ì‹œí—˜ê³¼ ê³¼ì œì— ì°¸ì—¬í•˜ì„¸ìš”</p>
                    </div>

                    <div class="p-6">
                        <div id="student-exam-list" class="space-y-4">
                            <!-- ì‹œí—˜/ê³¼ì œ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        <div id="student-exam-empty" class="hidden text-center py-12 text-gray-500">
                            <i class="fas fa-clipboard-list text-6xl mb-4"></i>
                            <p>ì°¸ì—¬ ê°€ëŠ¥í•œ ì‹œí—˜/ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ì˜¨ë¼ì¸ì‹œí—˜/ê³¼ì œ ì„¹ì…˜ ë -->
        </div>
    </main>

    <!-- SSIRN ì‘ì„±/í¸ì§‘ ëª¨ë‹¬ -->
    <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white rounded-t-2xl">
                <h3 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-pen-fancy mr-3"></i>
                    <span id="modal-title">ë¬´í˜•ì‹ì£¼ì˜ ë©”ëª¨ì‘ì„±</span>
                </h3>
            </div>
            
            <div class="p-6">
                <input type="hidden" id="edit-note-id">
                
                <!-- ë‚ ì§œ ë° ì‹œê°„ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-calendar mr-2 text-blue-500"></i>ë‚ ì§œ ë° ì‹œê°„
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="modal-note-date" 
                               class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <input type="time" id="modal-note-time" 
                               class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- ë‚´ìš© -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-gray-700 font-semibold">
                            <i class="fas fa-pen mr-2 text-green-500"></i>ë‚´ìš©
                        </label>
                        <button type="button" onclick="toggleModalPreview()" 
                                class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">
                            <i class="fas fa-eye mr-1"></i><span id="modal-preview-toggle-text">ë¯¸ë¦¬ë³´ê¸°</span>
                        </button>
                    </div>
                    
                    <!-- ì—ë””í„° -->
                    <div id="modal-editor-container">
                        <textarea id="modal-note-content" rows="12"
                                  class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                  placeholder="# ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©&#10;&#10;## ì£¼ìš” ê°œë…&#10;- ê°œë… 1&#10;- ê°œë… 2&#10;&#10;[ì°¸ê³  ìë£Œ](https://example.com)"></textarea>
                    </div>
                    
                    <!-- ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="modal-preview-container" class="hidden border rounded-lg p-4 bg-gray-50 max-h-96 overflow-y-auto">
                        <div id="modal-markdown-preview" class="prose max-w-none"></div>
                    </div>
                </div>
                
                <!-- íŒŒì¼ ì²¨ë¶€ -->
                <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <label class="block text-gray-700 font-semibold mb-3">
                        <i class="fas fa-paperclip mr-2 text-purple-500"></i>íŒŒì¼ ì²¨ë¶€
                    </label>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <!-- ì‚¬ì§„ ì´¬ì˜ ë²„íŠ¼ -->
                        <button type="button" onclick="document.getElementById('note-camera-input').click()"
                                class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-camera text-xl"></i>
                            <span class="font-medium">ì‚¬ì§„ ì´¬ì˜</span>
                        </button>
                        
                        <!-- íŒŒì¼ ì„ íƒ ë²„íŠ¼ -->
                        <button type="button" onclick="document.getElementById('note-file-input').click()"
                                class="flex items-center justify-center gap-2 px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-folder-open text-xl"></i>
                            <span class="font-medium">íŒŒì¼ ì„ íƒ</span>
                        </button>
                    </div>
                    
                    <!-- Hidden file inputs -->
                    <input type="file" id="note-camera-input" accept="image/*" capture="environment" 
                           multiple class="hidden" onchange="handleNoteFiles(this.files)">
                    <input type="file" id="note-file-input" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx" 
                           multiple class="hidden" onchange="handleNoteFiles(this.files)">
                    
                    <!-- ì²¨ë¶€ëœ íŒŒì¼ ëª©ë¡ -->
                    <div id="note-file-list" class="space-y-2">
                        <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                
                <!-- ìƒë‹´ ì‹ ì²­ -->
                <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label class="flex items-start cursor-pointer">
                        <input type="checkbox" id="request-counseling" 
                               class="mt-1 mr-3 w-5 h-5 text-yellow-600 rounded focus:ring-yellow-500"
                               onchange="toggleCounselingDetails(this.checked)">
                        <div class="flex-1">
                            <span class="font-semibold text-gray-800">
                                <i class="fas fa-hand-paper mr-2 text-yellow-600"></i>ìƒë‹´ ì‹ ì²­í•˜ê¸°
                            </span>
                            <p class="text-sm text-gray-600 mt-1">ì„ ìƒë‹˜ê³¼ ìƒë‹´ì´ í•„ìš”í•˜ì‹œë©´ ì²´í¬í•´ì£¼ì„¸ìš”</p>
                        </div>
                    </label>
                    
                    <!-- ìƒë‹´ ìƒì„¸ ì •ë³´ (ì„ íƒì‚¬í•­) -->
                    <div id="counseling-details" class="hidden mt-4 space-y-3 pl-8">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm text-gray-700 mb-1">í¬ë§ ë‚ ì§œ (ì„ íƒ)</label>
                                <input type="date" id="counseling-date" 
                                       class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-700 mb-1">í¬ë§ ì‹œê°„ (ì„ íƒ)</label>
                                <input type="time" id="counseling-time" 
                                       class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">í¬ë§ ì„ ìƒë‹˜ (ì„ íƒ)</label>
                            <select id="preferred-instructor" 
                                    class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="">ì„ íƒí•˜ì§€ ì•ŠìŒ</option>
                            </select>
                        </div>
                        
                        <!-- ìƒë‹´ ë‚´ìš© ì…ë ¥ (ìŒì„±ì¸ì‹ ì§€ì›) -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm text-gray-700">ìƒë‹´ ë‚´ìš© (ì„ íƒ)</label>
                                <button type="button" id="voice-recognition-btn" 
                                        onclick="toggleVoiceRecognition()"
                                        class="flex items-center gap-1 px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 text-xs transition-colors">
                                    <i class="fas fa-microphone"></i>
                                    <span id="voice-btn-text">ìŒì„± ì¸ì‹</span>
                                </button>
                            </div>
                            <textarea id="counseling-content" rows="4"
                                      class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-yellow-500"
                                      placeholder="ìƒë‹´í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ìŒì„±ìœ¼ë¡œ ë§ì”€í•˜ì„¸ìš”..."></textarea>
                            <p id="voice-status" class="text-xs text-gray-500 mt-1 hidden">
                                <i class="fas fa-circle animate-pulse text-red-500 mr-1"></i>
                                <span>ë“£ê³  ìˆìŠµë‹ˆë‹¤...</span>
                            </p>
                        </div>
                        
                        <!-- ì‚¬ì§„ ì²¨ë¶€ -->
                        <div>
                            <label class="block text-sm text-gray-700 mb-2">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="document.getElementById('counseling-camera-input').click()"
                                        class="flex items-center justify-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                                    <i class="fas fa-camera"></i>
                                    <span>ì‚¬ì§„ ì´¬ì˜</span>
                                </button>
                                <button type="button" onclick="document.getElementById('counseling-file-input').click()"
                                        class="flex items-center justify-center gap-2 px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
                                    <i class="fas fa-image"></i>
                                    <span>ê°¤ëŸ¬ë¦¬</span>
                                </button>
                            </div>
                            
                            <!-- Hidden file inputs -->
                            <input type="file" id="counseling-camera-input" accept="image/*" capture="environment" 
                                   multiple class="hidden" onchange="handleCounselingFiles(this.files)">
                            <input type="file" id="counseling-file-input" accept="image/*" 
                                   multiple class="hidden" onchange="handleCounselingFiles(this.files)">
                            
                            <!-- ì²¨ë¶€ëœ ì‚¬ì§„ ëª©ë¡ -->
                            <div id="counseling-file-list" class="mt-2 space-y-2">
                                <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                        
                        <p class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            ì •ë³´ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ë‹´ë‹¹ ì„ ìƒë‹˜ì´ ì ì ˆí•œ ì‹œê°„ì— ì—°ë½ë“œë¦½ë‹ˆë‹¤
                        </p>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì‚¬ìš© ê°€ëŠ¥ | ë§í¬ëŠ” ìƒˆ ì°½ì—ì„œ ì—´ë¦½ë‹ˆë‹¤
                    </p>
                </div>
                
                <!-- ë²„íŠ¼ -->
                <div class="flex gap-2">
                    <button type="button" onclick="saveNoteFromModal()" 
                            class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                    </button>
                    <button type="button" onclick="closeNoteModal()" 
                            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">
                        <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[60] hidden items-center justify-center p-4">
        <button onclick="closeImagePreview()" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 z-10">
            <i class="fas fa-times"></i>
        </button>
        <div class="max-w-7xl max-h-[90vh] w-full h-full flex items-center justify-center">
            <img id="preview-image" src="" alt="Preview" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
        </div>
        <p id="preview-filename" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white text-sm bg-black bg-opacity-50 px-4 py-2 rounded-lg"></p>
    </div>

    <!-- SSIRN ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="note-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white rounded-t-2xl">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-2xl font-bold flex items-center mb-2">
                            <i class="fas fa-book-open mr-3"></i>
                            SSIRN
                        </h3>
                        <p class="text-blue-100 text-sm" id="detail-note-date"></p>
                    </div>
                    <button onclick="closeDetailModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-8">
                <div class="prose max-w-none text-lg" id="detail-note-content" style="min-height: 300px;">
                    <!-- ë Œë”ë§ëœ ë§ˆí¬ë‹¤ìš´ ë‚´ìš© -->
                </div>
                
                <div class="flex justify-center border-t pt-6 mt-8">
                    <button type="button" onclick="closeDetailModal()" 
                            class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-lg">
                        <i class="fas fa-times mr-2"></i>ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ -->
    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="alert-box rounded-lg p-4 shadow-lg max-w-md">
            <div class="flex items-center gap-3">
                <div class="alert-icon flex-shrink-0">
                    <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                </div>
                <p id="alert-message" class="text-gray-800 font-medium"></p>
            </div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ -->
    <div id="custom-confirm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md mx-4">
            <div class="mb-4">
                <div class="flex items-start gap-3">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-3xl mt-1"></i>
                    <p id="confirm-message" class="text-gray-800 whitespace-pre-line"></p>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold">
                    <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                </button>
                <button id="confirm-ok" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                    <i class="fas fa-check mr-2"></i>í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <!-- í”„ë¡œê·¸ë ˆìŠ¤ë°” ëª¨ë‹¬ -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md mx-4 w-full">
            <div class="mb-4">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
                    <p id="progress-message" class="text-gray-800 font-semibold">ì €ì¥ ì¤‘...</p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-500 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-detail" class="text-xs text-gray-500 mt-2">ë©”ëª¨ë¥¼ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // ë²„ì „ ì •ë³´
        const APP_VERSION = 'v2.0.95';
        console.log(`%cğŸš€ Student Page ${APP_VERSION} ë¡œë“œë¨`, 'color: #10b981; font-weight: bold; font-size: 14px;');

        const API_BASE_URL = '';
        
        // ==================== Axios ì¸í„°ì…‰í„° (404 ì—ëŸ¬ ì¡°ìš©íˆ ì²˜ë¦¬) ====================
        axios.interceptors.response.use(
            response => response,
            error => {
                // 404 ì—ëŸ¬ë¥¼ ì½˜ì†”ì—ë§Œ ê²½ê³ ë¡œ í‘œì‹œí•˜ê³  ì¡°ìš©íˆ ì²˜ë¦¬
                if (error.response && error.response.status === 404) {
                    console.warn('âš ï¸ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error.config.url);
                    // ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ì§€ë§Œ ì•Œë¦¼ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    return Promise.reject(error);
                }
                return Promise.reject(error);
            }
        );
        
        // ==================== ì»¤ìŠ¤í…€ ì•Œë¦¼/í™•ì¸ ëª¨ë‹¬ ====================
        let alertTimer = null;
        
        window.showAlert = function(message, type = 'success') {
            const alertModal = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertIcon = alertModal.querySelector('.alert-icon');
            
            alertMessage.textContent = message;
            
            const alertBox = alertModal.querySelector('.alert-box');
            alertBox.className = 'alert-box rounded-lg p-4 shadow-lg max-w-md';
            
            if (type === 'success') {
                alertBox.classList.add('bg-green-50', 'border', 'border-green-200');
                alertMessage.classList.add('text-green-800');
                if (alertIcon) {
                    alertIcon.innerHTML = '<i class="fas fa-check-circle text-green-600 text-2xl"></i>';
                }
            } else if (type === 'error') {
                alertBox.classList.add('bg-red-50', 'border', 'border-red-200');
                alertMessage.classList.add('text-red-800');
                if (alertIcon) {
                    alertIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 text-2xl"></i>';
                }
            } else if (type === 'warning') {
                alertBox.classList.add('bg-yellow-50', 'border', 'border-yellow-200');
                alertMessage.classList.add('text-yellow-800');
                if (alertIcon) {
                    alertIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>';
                }
            } else if (type === 'info') {
                alertBox.classList.add('bg-blue-50', 'border', 'border-blue-200');
                alertMessage.classList.add('text-blue-800');
                if (alertIcon) {
                    alertIcon.innerHTML = '<i class="fas fa-info-circle text-blue-600 text-2xl"></i>';
                }
            }
            
            alertModal.classList.remove('hidden');
            
            if (alertTimer) clearTimeout(alertTimer);
            alertTimer = setTimeout(() => {
                alertModal.classList.add('hidden');
            }, 3000);
            
            alertModal.onclick = () => {
                alertModal.classList.add('hidden');
                if (alertTimer) clearTimeout(alertTimer);
            };
        };
        
        window.showConfirm = function(message) {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById('custom-confirm');
                const confirmMessage = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel');
                const okBtn = document.getElementById('confirm-ok');

                confirmMessage.innerHTML = message; // HTML íƒœê·¸ ë Œë”ë§ í—ˆìš©
                confirmModal.classList.remove('hidden');
                
                const cleanup = () => {
                    confirmModal.classList.add('hidden');
                    cancelBtn.onclick = null;
                    okBtn.onclick = null;
                };
                
                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                okBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
            });
        };
        
        // showConfirmModal ë³„ì¹­ ì¶”ê°€
        window.showConfirmModal = window.showConfirm;
        
        // showCustomAlert ë³„ì¹­ ì¶”ê°€  
        window.showCustomAlert = window.showAlert;
        
        // ==================== í”„ë¡œê·¸ë ˆìŠ¤ë°” ====================
        window.showProgress = function(message = 'ì €ì¥ ì¤‘...', detail = '', progress = 0) {
            const modal = document.getElementById('progress-modal');
            const messageEl = document.getElementById('progress-message');
            const detailEl = document.getElementById('progress-detail');
            const barEl = document.getElementById('progress-bar');
            
            messageEl.textContent = message;
            detailEl.textContent = detail;
            barEl.style.width = progress + '%';
            
            modal.classList.remove('hidden');
        };
        
        window.updateProgress = function(progress, detail = '') {
            const detailEl = document.getElementById('progress-detail');
            const barEl = document.getElementById('progress-bar');
            
            barEl.style.width = progress + '%';
            if (detail) {
                detailEl.textContent = detail;
            }
        };
        
        window.hideProgress = function() {
            const modal = document.getElementById('progress-modal');
            modal.classList.add('hidden');
            
            // ë¦¬ì…‹
            setTimeout(() => {
                document.getElementById('progress-bar').style.width = '0%';
            }, 300);
        };
        
        // ==================== ë¡œë”© ëª¨ë‹¬ ====================
        window.showLoading = function(message = 'ë¡œë”© ì¤‘...') {
            let loadingModal = document.getElementById('loading-modal');
            
            if (!loadingModal) {
                loadingModal = document.createElement('div');
                loadingModal.id = 'loading-modal';
                loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]';
                loadingModal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4">
                        <div class="flex flex-col items-center">
                            <div class="relative">
                                <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                            </div>
                            <p id="loading-message" class="mt-4 text-gray-700 font-semibold text-center"></p>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingModal);
            }
            
            document.getElementById('loading-message').textContent = message;
            loadingModal.classList.remove('hidden');
        };
        
        window.hideLoading = function() {
            const loadingModal = document.getElementById('loading-modal');
            if (loadingModal) {
                loadingModal.classList.add('hidden');
            }
        };
        
        // URLì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ (íƒ€ì„ìŠ¤íƒ¬í”„ íŒ¨í„´ ì œê±°)
        window.getFilenameFromUrl = function(url) {
            if (!url) return 'unknown';
            try {
                // 1. URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹ì—ì„œ ì›ë³¸ íŒŒì¼ëª… ì¶”ì¶œ
                if (url.includes('#')) {
                    const parts = url.split('#');
                    if (parts.length > 1 && parts[1]) {
                        return decodeURIComponent(parts[1]);
                    }
                }
                
                // 2. FTP URLì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ
                const parts = url.split('/');
                let filename = parts[parts.length - 1];
                
                // 3. ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°
                if (filename.includes('?')) {
                    filename = filename.split('?')[0];
                }
                
                // 4. ë””ì½”ë”©
                filename = decodeURIComponent(filename);
                
                // 5. íƒ€ì„ìŠ¤íƒ¬í”„_UUID_ íŒ¨í„´ ì œê±°
                const timestampPattern = /^\d{8}_\d{6}_[a-f0-9]{8}_(.+)$/;
                const match = filename.match(timestampPattern);
                if (match && match[1]) {
                    return match[1];
                }
                
                return filename;
            } catch (e) {
                return 'unknown';
            }
        };
        
        // URLì—ì„œ # ì´í›„ ì œê±° (ì‹¤ì œ íŒŒì¼URLë§Œ ì¶”ì¶œ)
        window.getCleanUrl = function(url) {
            if (!url) return '';
            return url.split('#')[0];
        };
        
        // ==================== SSIRN ê´€ë ¨ í•¨ìˆ˜ ====================
        
        // FTP URLì„ HTTP í”„ë¡ì‹œ URLë¡œ ë³€í™˜
        function convertFtpUrl(url) {
            if (!url || typeof url !== 'string') return url;
            if (url.startsWith('ftp://')) {
                return `${API_BASE_URL}/api/proxy-image?url=${encodeURIComponent(url)}`;
            }
            return url;
        }
        
        let allNotes = [];
        let currentNoteId = null;
        
        // ë§ˆí¬ë‹¤ìš´ ë Œë”ëŸ¬ ì„¤ì •
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        
        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë Œë”ë§ (ë§í¬ëŠ” ìƒˆ ì°½ì—ì„œ ì—´ê¸°)
        window.renderMarkdown = function(markdown) {
            const html = marked.parse(markdown || '');
            const clean = DOMPurify.sanitize(html);
            
            const div = document.createElement('div');
            div.innerHTML = clean;
            div.querySelectorAll('a').forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            });
            
            return div.innerHTML;
        };
        
        // ëª¨ë“  ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
        window.loadAllNotes = async function() {
            const student = JSON.parse(sessionStorage.getItem('student'));
            if (!student) {
                console.error('âŒ í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ğŸ“‹ í•™ìƒ ì •ë³´:', student);
            console.log('ğŸ” í•™ìƒ ID:', student.id);
            
            try {
                // í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ
                window.showLoading('SSIRN ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                
                // í•™ìƒ IDë¡œ í•„í„°ë§í•˜ì—¬ ì¡°íšŒ
                const url = `${API_BASE_URL}/api/class-notes?student_id=${student.id}`;
                console.log('ğŸŒ API ìš”ì²­:', url);
                const response = await axios.get(url);
                const fetchedNotes = response.data || [];
                console.log('ğŸ“¥ ì„œë²„ì—ì„œ ë°›ì€ ë©”ëª¨:', fetchedNotes);
                
                // ìœ íš¨í•œ ë©”ëª¨ë§Œ í•„í„°ë§ (idê°€ ìˆê³ , student_idê°€ í˜„ì¬ í•™ìƒê³¼ ì¼ì¹˜í•˜ëŠ” ê²ƒë§Œ)
                allNotes = fetchedNotes.filter(note => {
                    const isValid = note && note.id && note.student_id === student.id;
                    console.log(`ë©”ëª¨ ID ${note?.id}: student_id=${note?.student_id}, í˜„ì¬ í•™ìƒ=${student.id}, ìœ íš¨=${isValid}`);
                    return isValid;
                });
                
                console.log(`âœ… ì´ ${fetchedNotes.length}ê°œ ë©”ëª¨ ì¤‘ ${allNotes.length}ê°œ ìœ íš¨í•œ ë©”ëª¨ ë¡œë“œë¨`);
                console.log('ğŸ“ í•„í„°ë§ëœ ë©”ëª¨:', allNotes);
                
                renderNotesGrid(allNotes);
                
                // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¹€
                window.hideLoading();
            } catch (error) {
                console.error('ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                window.hideLoading();
                
                // 404 ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë©”ëª¨)
                if (error.response && error.response.status === 404) {
                    console.warn('âš ï¸ ì¼ë¶€ ë©”ëª¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.');
                    allNotes = [];
                    renderNotesGrid(allNotes);
                } else {
                    window.showAlert('ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
        };
        
        // ë©”ëª¨ ê·¸ë¦¬ë“œ ë Œë”ë§
        window.renderNotesGrid = function(notes) {
            console.log('ğŸ¨ renderNotesGrid í˜¸ì¶œë¨, ë©”ëª¨ ê°œìˆ˜:', notes.length);
            
            const grid = document.getElementById('notes-grid');
            const empty = document.getElementById('notes-empty');
            const countSpan = document.getElementById('notes-count');
            
            console.log('DOM ìš”ì†Œ:', { grid, empty, countSpan });
            
            if (!grid || !empty || !countSpan) {
                console.error('âŒ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            countSpan.textContent = notes.length;
            
            if (notes.length === 0) {
                console.log('âš ï¸ ë©”ëª¨ê°€ ì—†ìŒ - ë¹ˆ ìƒíƒœ í‘œì‹œ');
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            console.log('âœ… ë©”ëª¨ ìˆìŒ - ê·¸ë¦¬ë“œ ë Œë”ë§ ì‹œì‘');
            empty.classList.add('hidden');
            
            grid.innerHTML = notes.map(note => {
                const preview = note.content.substring(0, 100) + (note.content.length > 100 ? '...' : '');
                const dateObj = new Date(note.note_date);
                const dateStr = dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
                const timeStr = dateObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                
                // ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ (ê°œì„ ëœ íŒŒì‹±)
                let attachmentsHTML = '';
                if (note.photo_urls) {
                    try {
                        let fileUrls = [];
                        
                        // JSON ë°°ì—´ í˜•íƒœ íŒŒì‹± ì‹œë„
                        if (typeof note.photo_urls === 'string') {
                            // "[]" ê°™ì€ ë¹ˆ ë°°ì—´ ë¬¸ìì—´ ì œê±°
                            const cleanedUrls = note.photo_urls.replace(/\[\]/g, '').trim();
                            
                            if (cleanedUrls.startsWith('[') && cleanedUrls.endsWith(']')) {
                                // JSON ë°°ì—´ íŒŒì‹±
                                try {
                                    fileUrls = JSON.parse(cleanedUrls);
                                } catch (e) {
                                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì‰¼í‘œë¡œ ë¶„ë¦¬
                                    fileUrls = cleanedUrls.slice(1, -1).split(',').map(url => url.trim().replace(/^"|"$/g, ''));
                                }
                            } else {
                                // ì‰¼í‘œë¡œ ë¶„ë¦¬ëœ URL
                                fileUrls = cleanedUrls.split(',').map(url => url.trim());
                            }
                        } else if (Array.isArray(note.photo_urls)) {
                            fileUrls = note.photo_urls;
                        }
                        
                        // ìœ íš¨í•œ URLë§Œ í•„í„°ë§ (ë¹ˆ ë¬¸ìì—´, "[]", ë„ˆë¬´ ì§§ì€ URL ì œì™¸)
                        fileUrls = fileUrls.filter(url => {
                            if (!url || url === '[]' || url.length < 10) return false;
                            // ftp:// ë˜ëŠ” http:// ë¡œ ì‹œì‘í•˜ëŠ” URLë§Œ
                            return url.startsWith('ftp://') || url.startsWith('http://') || url.startsWith('https://');
                        });
                        
                        if (fileUrls.length > 0) {
                            let validFileCount = 0;
                            let filesHTML = '';
                            
                            fileUrls.forEach(url => {
                                const urlLower = url.toLowerCase();
                                const fileName = decodeURIComponent(url.split('/').pop());
                                const ext = fileName.split('.').pop().toUpperCase();
                                
                                // ì•Œë ¤ì§„ íŒŒì¼ í™•ì¥ìë§Œ í‘œì‹œ
                                const knownExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'hwp'];
                                if (!knownExtensions.includes(ext.toLowerCase())) {
                                    console.warn('ì•Œ ìˆ˜ ì—†ëŠ” íŒŒì¼ í˜•ì‹:', fileName);
                                    return; // ì•Œ ìˆ˜ ì—†ëŠ” íŒŒì¼ ê±´ë„ˆë›°ê¸°
                                }
                                
                                validFileCount++;
                                
                                // FTP URLì„ HTTPë¡œ ë³€í™˜
                                const convertedUrl = convertFtpUrl(url);
                                
                                // ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸
                                if (urlLower.match(/\.(jpg|jpeg|png|gif|webp|bmp)$/i)) {
                                    filesHTML += `
                                        <div class="flex flex-col items-center">
                                            <div class="relative group">
                                                <img src="${convertedUrl}" 
                                                     class="w-20 h-20 object-cover rounded-lg border-2 border-gray-200 cursor-pointer hover:opacity-80 hover:scale-105 hover:border-blue-400 transition-all"
                                                     onclick="showImagePreview('${convertedUrl}', '${fileName}')"
                                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2550%25%22 y=%2550%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2212%22%3Eì´ë¯¸ì§€%3C/text%3E%3C/svg%3E';"
                                                     title="${fileName} (í´ë¦­í•˜ì—¬ í¬ê²Œ ë³´ê¸°)">
                                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 rounded-lg transition-all flex items-center justify-center pointer-events-none">
                                                    <i class="fas fa-search-plus text-white text-3xl opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-lg"></i>
                                                </div>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1 max-w-[80px] truncate" title="${fileName}">${fileName}</p>
                                        </div>
                                    `;
                                } else {
                                    // ê¸°íƒ€ íŒŒì¼ - ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (íŒŒì¼ëª… + í™•ì¥ì í‘œì‹œ)
                                    const iconClass = 
                                        urlLower.endsWith('.pdf') ? 'fa-file-pdf text-red-500' :
                                        urlLower.match(/\.(doc|docx)$/i) ? 'fa-file-word text-blue-500' :
                                        urlLower.match(/\.(xls|xlsx)$/i) ? 'fa-file-excel text-green-500' :
                                        urlLower.match(/\.(ppt|pptx)$/i) ? 'fa-file-powerpoint text-orange-500' :
                                        urlLower.endsWith('.hwp') ? 'fa-file-alt text-blue-400' :
                                        'fa-file text-gray-500';
                                    
                                    filesHTML += `
                                        <a href="${convertedUrl}" 
                                           onclick="event.preventDefault(); event.stopPropagation(); downloadFile('${convertedUrl}', '${fileName}'); return false;"
                                           class="flex flex-col items-center gap-2 px-3 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 text-xs transition-colors min-w-[100px] max-w-[140px] cursor-pointer"
                                           title="${fileName}">
                                            <i class="fas ${iconClass} text-2xl"></i>
                                            <span class="text-center break-all line-clamp-2">${fileName}</span>
                                            <span class="px-2 py-1 bg-gray-200 rounded text-xs font-semibold">${ext}</span>
                                        </a>
                                    `;
                                }
                            });
                            
                            if (validFileCount > 0) {
                                attachmentsHTML = '<div class="mt-3 border-t pt-3">';
                                attachmentsHTML += '<p class="text-xs text-gray-600 mb-2 font-semibold"><i class="fas fa-paperclip mr-1"></i>ì²¨ë¶€íŒŒì¼ (' + validFileCount + 'ê°œ)</p>';
                                attachmentsHTML += '<div class="flex flex-wrap gap-3">';
                                attachmentsHTML += filesHTML;
                                attachmentsHTML += '</div></div>';
                            }
                        }
                    } catch (error) {
                        console.error('ì²¨ë¶€íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜:', error, note.photo_urls);
                    }
                }
                
                return `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow bg-white relative">
                        <div class="flex justify-between items-start mb-2">
                            <div class="cursor-pointer" onclick="showNoteDetail(${note.id})">
                                <h4 class="font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-calendar-day mr-2 text-blue-500"></i>
                                    ${dateStr}
                                </h4>
                                <p class="text-xs text-gray-500 mt-1 ml-6">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${timeStr}
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); editNote(${note.id})" 
                                        class="text-blue-500 hover:text-blue-700 transition-colors p-1"
                                        title="ìˆ˜ì •">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="event.stopPropagation(); deleteNote(${note.id})" 
                                        class="text-red-500 hover:text-red-700 transition-colors p-1"
                                        title="ì‚­ì œ">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm line-clamp-3 cursor-pointer" onclick="showNoteDetail(${note.id})">${preview}</p>
                        ${attachmentsHTML}
                        <div class="mt-2 text-xs text-gray-400">
                            <i class="fas fa-history mr-1"></i>
                            ì‘ì„±: ${new Date(note.created_at).toLocaleString('ko-KR')}
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('âœ… ê·¸ë¦¬ë“œ HTML ìƒì„± ì™„ë£Œ, ê¸¸ì´:', grid.innerHTML.length);
            console.log('ğŸ“Š ë Œë”ë§ëœ ë©”ëª¨:', notes.map(n => ({ id: n.id, date: n.note_date, preview: n.content.substring(0, 20) })));
        };
        
        // ë©”ëª¨ ê²€ìƒ‰
        window.searchNotes = function() {
            const searchText = document.getElementById('note-search').value.toLowerCase();
            const dateFilter = document.getElementById('note-date-filter').value;
            
            let filtered = allNotes;
            
            if (searchText) {
                filtered = filtered.filter(note => 
                    note.content.toLowerCase().includes(searchText)
                );
            }
            
            if (dateFilter) {
                filtered = filtered.filter(note => 
                    note.note_date === dateFilter
                );
            }
            
            renderNotesGrid(filtered);
        };
        
        // í•„í„° ì´ˆê¸°í™”
        window.clearNoteFilters = function() {
            document.getElementById('note-search').value = '';
            document.getElementById('note-date-filter').value = '';
            renderNotesGrid(allNotes);
        };
        
        // ìƒˆ ë©”ëª¨ ëª¨ë‹¬ ì—´ê¸°
        window.showNewNoteModal = function() {
            document.getElementById('modal-title').textContent = 'ë¬´í˜•ì‹ì£¼ì˜ ë©”ëª¨ì‘ì„±';
            document.getElementById('edit-note-id').value = '';
            const now = new Date();
            document.getElementById('modal-note-date').value = now.toISOString().split('T')[0];
            document.getElementById('modal-note-time').value = now.toTimeString().slice(0, 5); // HH:MM
            document.getElementById('modal-note-content').value = '';
            
            // ìƒë‹´ ì‹ ì²­ ì´ˆê¸°í™”
            document.getElementById('request-counseling').checked = false;
            document.getElementById('counseling-date').value = '';
            document.getElementById('counseling-time').value = '';
            document.getElementById('preferred-instructor').value = '';
            document.getElementById('counseling-details').classList.add('hidden');
            
            document.getElementById('note-modal').classList.remove('hidden');
        };
        
        // ë©”ëª¨ í¸ì§‘
        window.editNote = async function(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (!note) {
                window.showCustomAlert('ë©”ëª¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.', 'warning');
                loadAllNotes();
                return;
            }
            
            document.getElementById('modal-title').textContent = 'ìˆ˜ì—… ë©”ëª¨ ìˆ˜ì •';
            document.getElementById('edit-note-id').value = note.id;
            
            // ë‚ ì§œì™€ ì‹œê°„ í¬ë§· ë³€í™˜
            const noteDate = new Date(note.note_date);
            document.getElementById('modal-note-date').value = noteDate.toISOString().split('T')[0];
            document.getElementById('modal-note-time').value = noteDate.toTimeString().slice(0, 5); // HH:MM
            document.getElementById('modal-note-content').value = note.content || '';
            
            // ìƒë‹´ ì‹ ì²­ ì´ˆê¸°í™” (ìˆ˜ì • ì‹œì—ëŠ” ìƒë‹´ ì‹ ì²­ ë¶ˆê°€)
            document.getElementById('request-counseling').checked = false;
            document.getElementById('counseling-details').classList.add('hidden');
            
            document.getElementById('note-modal').classList.remove('hidden');
        };
        
        // íŒŒì¼ ì²¨ë¶€ ì²˜ë¦¬
        let noteAttachedFiles = [];
        
        window.handleNoteFiles = function(files) {
            const fileList = document.getElementById('note-file-list');
            
            Array.from(files).forEach((file, index) => {
                // íŒŒì¼ í¬ê¸° ì²´í¬ (100MB)
                if (file.size > 100 * 1024 * 1024) {
                    window.showAlert(`íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤: ${file.name} (ìµœëŒ€ 100MB)`, 'error');
                    return;
                }
                
                // íŒŒì¼ ëª©ë¡ì— ì¶”ê°€
                noteAttachedFiles.push(file);
                
                // UIì— íŒŒì¼ í‘œì‹œ
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-white border border-gray-300 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas ${file.type.startsWith('image/') ? 'fa-image text-blue-500' : 'fa-file text-gray-500'} text-xl"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${file.name}</p>
                            <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
                        </div>
                    </div>
                    <button onclick="removeNoteFile(${noteAttachedFiles.length - 1})" 
                            class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        };
        
        window.removeNoteFile = function(index) {
            noteAttachedFiles.splice(index, 1);
            const fileList = document.getElementById('note-file-list');
            fileList.innerHTML = '';
            
            // ë‚¨ì€ íŒŒì¼ë“¤ ë‹¤ì‹œ ë Œë”ë§
            noteAttachedFiles.forEach((file, idx) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-white border border-gray-300 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas ${file.type.startsWith('image/') ? 'fa-image text-blue-500' : 'fa-file text-gray-500'} text-xl"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${file.name}</p>
                            <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
                        </div>
                    </div>
                    <button onclick="removeNoteFile(${idx})" 
                            class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        };
        
        // íŒŒì¼ ì—…ë¡œë“œ
        async function uploadNoteFiles(noteId) {
            try {
                const totalFiles = noteAttachedFiles.length;
                for (let i = 0; i < totalFiles; i++) {
                    const file = noteAttachedFiles[i];
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('note_id', noteId);
                    
                    // ì§„í–‰ë¥  ê³„ì‚° (60% ~ 90% êµ¬ê°„)
                    const fileProgress = 60 + Math.floor((i / totalFiles) * 30);
                    window.updateProgress(fileProgress, `íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${i + 1}/${totalFiles}) ${file.name}`);
                    
                    await axios.post(`${API_BASE_URL}/api/upload-note-file`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    });
                }
                
                // ì—…ë¡œë“œ ì™„ë£Œ í›„ íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
                noteAttachedFiles = [];
                document.getElementById('note-file-list').innerHTML = '';
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                throw error; // ì—ëŸ¬ë¥¼ ìƒìœ„ë¡œ ì „ë‹¬
            }
        }
        
        // ëª¨ë‹¬ì—ì„œ ì €ì¥
        window.saveNoteFromModal = async function() {
            const student = JSON.parse(sessionStorage.getItem('student'));
            if (!student) return;
            
            const noteId = document.getElementById('edit-note-id').value;
            const noteDateValue = document.getElementById('modal-note-date').value;
            const noteTimeValue = document.getElementById('modal-note-time').value || '00:00';
            let content = document.getElementById('modal-note-content').value;
            
            if (!noteDateValue) {
                window.showAlert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            // ë‚ ì§œì™€ ì‹œê°„ì„ í•©ì³ì„œ ISO í˜•ì‹ìœ¼ë¡œ
            const noteDate = `${noteDateValue}T${noteTimeValue}:00`;
            
            // ìƒë‹´ ì‹ ì²­ ì²´í¬ ì—¬ë¶€ í™•ì¸
            const requestCounseling = document.getElementById('request-counseling').checked;
            
            // ë‚´ìš©ì´ ì—†ëŠ”ë° ìƒë‹´ ì‹ ì²­ì„ í•œ ê²½ìš°
            if (!content.trim() && requestCounseling) {
                content = 'ìƒë‹´ì‹ ì²­';
            }
            
            // ë‚´ìš©ì´ ì—†ê³  ìƒë‹´ ì‹ ì²­ë„ ì•ˆí•œ ê²½ìš°
            if (!content.trim()) {
                window.showAlert('ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ìƒë‹´ ì‹ ì²­ì„ ì²´í¬í•˜ì„¸ìš”', 'error');
                return;
            }
            
            try {
                // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì‹œì‘
                window.showProgress('ë©”ëª¨ ì €ì¥ ì¤‘...', 'ë©”ëª¨ë¥¼ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 20);
                
                const data = {
                    student_id: student.id,
                    note_date: noteDate,
                    content: content
                };
                
                // IDê°€ ìˆìœ¼ë©´ ìˆ˜ì •, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                if (noteId) {
                    data.id = parseInt(noteId);
                }
                
                const response = await axios.post(`${API_BASE_URL}/api/class-notes`, data);
                
                if (response.data.success) {
                    const savedNoteId = response.data.id || noteId;
                    
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    window.updateProgress(50, 'ë©”ëª¨ ì €ì¥ ì™„ë£Œ!');
                    
                    // íŒŒì¼ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œ
                    if (noteAttachedFiles.length > 0 && savedNoteId) {
                        window.updateProgress(60, `íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${noteAttachedFiles.length}ê°œ)`);
                        await uploadNoteFiles(savedNoteId);
                        window.updateProgress(90, 'íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!');
                    } else {
                        window.updateProgress(90, 'ë§ˆë¬´ë¦¬ ì¤‘...');
                    }
                    
                    if (requestCounseling) {
                        // ìƒë‹´ ì‹ ì²­ ë“±ë¡
                        await createCounselingRequest(student, noteDate, content);
                    }
                    
                    window.updateProgress(100, 'ëª¨ë“  ì‘ì—… ì™„ë£Œ!');
                    
                    // ì ê¹ 100% ë³´ì—¬ì£¼ê¸°
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    window.hideProgress();
                    window.showAlert('âœ… SSIRNë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    closeNoteModal();
                    loadAllNotes();
                }
            } catch (error) {
                console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);
                window.hideProgress();
                window.showAlert('âŒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };
        
        // ìƒë‹´ ì‹ ì²­ ë“±ë¡
        async function createCounselingRequest(student, noteDate, noteContent) {
            try {
                const counselingDate = document.getElementById('counseling-date').value || noteDate;
                const counselingTime = document.getElementById('counseling-time').value;
                const preferredInstructorCode = document.getElementById('preferred-instructor').value;
                const userCounselingContent = document.getElementById('counseling-content').value;
                
                // ìƒë‹´ ë‚´ìš© êµ¬ì„±
                let counselingContent = '';
                
                // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ìƒë‹´ ë‚´ìš© ìš°ì„ 
                if (userCounselingContent && userCounselingContent.trim()) {
                    counselingContent = userCounselingContent.trim();
                } else if (noteContent && noteContent.trim()) {
                    // ë©”ëª¨ ë‚´ìš©ì´ ìˆìœ¼ë©´ í¬í•¨
                    counselingContent = `[í•™ìƒ ë©”ëª¨ì—ì„œ ìƒë‹´ ì‹ ì²­]\n\n`;
                    counselingContent += `ë©”ëª¨ ë‚´ìš©:\n${noteContent.substring(0, 200)}${noteContent.length > 200 ? '...' : ''}\n\n`;
                } else {
                    counselingContent = `ìƒë‹´ì‹ ì²­\n\n`;
                }
                
                if (counselingTime) {
                    counselingContent += `\n\ní¬ë§ ì‹œê°„: ${counselingTime}`;
                }
                if (preferredInstructorCode) {
                    // ì„ ìƒë‹˜ ì´ë¦„ ì°¾ê¸°
                    const instructorSelect = document.getElementById('preferred-instructor');
                    const selectedOption = instructorSelect.options[instructorSelect.selectedIndex];
                    const instructorName = selectedOption.text;
                    counselingContent += `\ní¬ë§ ì„ ìƒë‹˜: ${instructorName}`;
                }
                
                // ë¨¼ì € ìƒë‹´ì¼ì§€ ìƒì„±
                const counselingData = {
                    student_id: student.id,
                    instructor_code: preferredInstructorCode || null,
                    consultation_date: counselingDate,
                    consultation_type: 'í•™ìƒìš”ì²­',
                    content: counselingContent,
                    status: 'ì˜ˆì •',
                    photo_urls: '[]'
                };
                
                const response = await axios.post(`${API_BASE_URL}/api/counselings`, counselingData);
                console.log('âœ… ìƒë‹´ ì‹ ì²­ ë“±ë¡ ì™„ë£Œ');
                
                // íŒŒì¼ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œ
                if (counselingAttachedFiles.length > 0 && response.data.id) {
                    await uploadCounselingFiles(response.data.id);
                }
                
                // íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
                counselingAttachedFiles = [];
                document.getElementById('counseling-file-list').innerHTML = '';
                
            } catch (error) {
                console.error('ìƒë‹´ ì‹ ì²­ ë“±ë¡ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ê°€ ë‚˜ë„ ë©”ëª¨ ì €ì¥ì€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ì§€ ì•ŠìŒ
            }
        }
        
        // ìƒë‹´ íŒŒì¼ ì—…ë¡œë“œ
        async function uploadCounselingFiles(counselingId) {
            try {
                for (const file of counselingAttachedFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('category', 'guidance'); // ìƒë‹´ì¼ì§€ ì¹´í…Œê³ ë¦¬
                    
                    const uploadResponse = await axios.post(`${API_BASE_URL}/api/upload-image`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    });
                    
                    if (uploadResponse.data.success) {
                        // ìƒë‹´ì¼ì§€ì— ì‚¬ì§„ URL ì¶”ê°€
                        await axios.post(`${API_BASE_URL}/api/counselings/${counselingId}/add-photo`, {
                            photo_url: uploadResponse.data.url
                        });
                    }
                }
            } catch (error) {
                console.error('ìƒë‹´ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ìƒë‹´ ìƒì„¸ ì •ë³´ í† ê¸€
        window.toggleCounselingDetails = function(show) {
            const detailsDiv = document.getElementById('counseling-details');
            if (show) {
                detailsDiv.classList.remove('hidden');
            } else {
                detailsDiv.classList.add('hidden');
            }
        };
        
        // ìƒë‹´ íŒŒì¼ ì²¨ë¶€ ì²˜ë¦¬
        let counselingAttachedFiles = [];
        
        window.handleCounselingFiles = function(files) {
            const fileList = document.getElementById('counseling-file-list');
            
            Array.from(files).forEach((file) => {
                // íŒŒì¼ í¬ê¸° ì²´í¬ (100MB)
                if (file.size > 100 * 1024 * 1024) {
                    window.showAlert(`íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤: ${file.name} (ìµœëŒ€ 100MB)`, 'error');
                    return;
                }
                
                // íŒŒì¼ ëª©ë¡ì— ì¶”ê°€
                counselingAttachedFiles.push(file);
                
                // UIì— íŒŒì¼ í‘œì‹œ
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-2 bg-white border border-gray-300 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-image text-blue-500"></i>
                        <div>
                            <p class="text-xs font-medium text-gray-800">${file.name}</p>
                            <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
                        </div>
                    </div>
                    <button onclick="removeCounselingFile(${counselingAttachedFiles.length - 1})" 
                            class="text-red-500 hover:text-red-700 transition-colors text-sm">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        };
        
        window.removeCounselingFile = function(index) {
            counselingAttachedFiles.splice(index, 1);
            const fileList = document.getElementById('counseling-file-list');
            fileList.innerHTML = '';
            
            // ë‚¨ì€ íŒŒì¼ë“¤ ë‹¤ì‹œ ë Œë”ë§
            counselingAttachedFiles.forEach((file, idx) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-2 bg-white border border-gray-300 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-image text-blue-500"></i>
                        <div>
                            <p class="text-xs font-medium text-gray-800">${file.name}</p>
                            <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
                        </div>
                    </div>
                    <button onclick="removeCounselingFile(${idx})" 
                            class="text-red-500 hover:text-red-700 transition-colors text-sm">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        };
        
        // ìŒì„± ì¸ì‹
        let recognition = null;
        let isRecognizing = false;
        
        window.toggleVoiceRecognition = function() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                window.showAlert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            if (isRecognizing) {
                stopVoiceRecognition();
            } else {
                startVoiceRecognition();
            }
        };
        
        function startVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.lang = 'ko-KR';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            const textarea = document.getElementById('counseling-content');
            const voiceBtn = document.getElementById('voice-recognition-btn');
            const voiceBtnText = document.getElementById('voice-btn-text');
            const voiceStatus = document.getElementById('voice-status');
            
            let finalTranscript = textarea.value;
            
            recognition.onstart = function() {
                isRecognizing = true;
                voiceBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                voiceBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                voiceBtnText.textContent = 'ì¤‘ì§€';
                voiceStatus.classList.remove('hidden');
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                textarea.value = finalTranscript + interimTranscript;
                textarea.scrollTop = textarea.scrollHeight;
            };
            
            recognition.onerror = function(event) {
                console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                if (event.error !== 'no-speech') {
                    window.showAlert('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error, 'error');
                }
                stopVoiceRecognition();
            };
            
            recognition.onend = function() {
                if (isRecognizing) {
                    // ìë™ìœ¼ë¡œ ì¬ì‹œì‘ (continuous íš¨ê³¼)
                    recognition.start();
                }
            };
            
            try {
                recognition.start();
            } catch (error) {
                console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:', error);
                window.showAlert('ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }
        
        function stopVoiceRecognition() {
            if (recognition) {
                isRecognizing = false;
                recognition.stop();
                
                const voiceBtn = document.getElementById('voice-recognition-btn');
                const voiceBtnText = document.getElementById('voice-btn-text');
                const voiceStatus = document.getElementById('voice-status');
                
                voiceBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                voiceBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                voiceBtnText.textContent = 'ìŒì„± ì¸ì‹';
                voiceStatus.classList.add('hidden');
            }
        }
        
        // ë©”ëª¨ ì‚­ì œ
        window.deleteNote = async function(noteId) {
            if (!noteId) {
                window.showCustomAlert('ì‚­ì œí•  ë©”ëª¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
            const confirmed = await window.showConfirmModal(
                'ë©”ëª¨ ì‚­ì œ',
                'ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                'ì‚­ì œ',
                'ì·¨ì†Œ'
            );
            
            if (!confirmed) return;
            
            try {
                const response = await axios.delete(`${API_BASE_URL}/api/class-notes/${noteId}`);
                
                if (response.data.success) {
                    window.showCustomAlert('âœ… ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    loadAllNotes();
                }
            } catch (error) {
                console.error('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨:', error);
                window.showCustomAlert('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };
        
        // ìƒì„¸ë³´ê¸° ëª¨ë‹¬
        window.showNoteDetail = function(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (!note) {
                window.showAlert('ë©”ëª¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.', 'warning');
                loadAllNotes();
                return;
            }
            
            currentNoteId = noteId;
            
            const dateObj = new Date(note.note_date);
            const dateStr = dateObj.toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            const timeStr = dateObj.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            document.getElementById('detail-note-date').textContent = `${dateStr} ${timeStr}`;
            document.getElementById('detail-note-content').innerHTML = renderMarkdown(note.content);
            document.getElementById('note-detail-modal').classList.remove('hidden');
        };
        
        // ìƒì„¸ë³´ê¸°ì—ì„œ ìˆ˜ì •
        window.editNoteFromDetail = function() {
            closeDetailModal();
            editNote(currentNoteId);
        };
        
        // ìƒì„¸ë³´ê¸°ì—ì„œ ì‚­ì œ
        window.deleteNoteFromDetail = async function() {
            closeDetailModal();
            await deleteNote(currentNoteId);
        };
        
        // ëª¨ë‹¬ ë‹«ê¸°
        window.closeNoteModal = function() {
            document.getElementById('note-modal').classList.add('hidden');
            document.getElementById('modal-editor-container').classList.remove('hidden');
            document.getElementById('modal-preview-container').classList.add('hidden');
            document.getElementById('modal-preview-toggle-text').textContent = 'ë¯¸ë¦¬ë³´ê¸°';
            
            // íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
            noteAttachedFiles = [];
            document.getElementById('note-file-list').innerHTML = '';
            document.getElementById('note-camera-input').value = '';
            document.getElementById('note-file-input').value = '';
            
            // ìƒë‹´ ê´€ë ¨ ì´ˆê¸°í™”
            counselingAttachedFiles = [];
            document.getElementById('counseling-file-list').innerHTML = '';
            document.getElementById('counseling-camera-input').value = '';
            document.getElementById('counseling-file-input').value = '';
            document.getElementById('counseling-content').value = '';
            
            // ìŒì„± ì¸ì‹ ì¤‘ì§€
            if (isRecognizing) {
                stopVoiceRecognition();
            }
        };
        
        window.closeDetailModal = function() {
            document.getElementById('note-detail-modal').classList.add('hidden');
            currentNoteId = null;
        };
        
        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬
        window.showImagePreview = async function(url, filename) {
            // í”„ë¡œê·¸ë˜ìŠ¤ë°” í‘œì‹œ
            window.showLoading('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            window.updateProgress(10, 'ì´ë¯¸ì§€ ë¡œë“œ ì¤‘...');
            
            try {
                const modal = document.getElementById('image-preview-modal');
                const img = document.getElementById('preview-image');
                const filenameEl = document.getElementById('preview-filename');
                
                // ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ
                await new Promise((resolve, reject) => {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        window.updateProgress(80, 'ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ');
                        img.src = url;
                        filenameEl.textContent = filename || '';
                        resolve();
                    };
                    tempImg.onerror = reject;
                    tempImg.src = url;
                });
                
                window.updateProgress(100, 'ì™„ë£Œ!');
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                setTimeout(() => window.hideLoading(), 300);
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                window.hideLoading();
                window.showAlert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };
        
        window.closeImagePreview = function() {
            const modal = document.getElementById('image-preview-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        window.downloadFile = async function(url, filename) {
            window.showLoading('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘...');
            window.updateProgress(10, 'ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘...');
            
            try {
                window.updateProgress(30, 'íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘...');
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
                
                window.updateProgress(70, 'íŒŒì¼ ì €ì¥ ì¤‘...');
                
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                
                window.updateProgress(90, 'ê±°ì˜ ì™„ë£Œ...');
                
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
                
                window.updateProgress(100, 'ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
                setTimeout(() => {
                    window.hideLoading();
                    window.showAlert('ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                }, 500);
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                window.hideLoading();
                window.showAlert('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };
        
        // ESC í‚¤ë¡œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('image-preview-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    closeImagePreview();
                }
            }
        });
        
        // ëª¨ë‹¬ ë¯¸ë¦¬ë³´ê¸° í† ê¸€
        window.toggleModalPreview = function() {
            const editorContainer = document.getElementById('modal-editor-container');
            const previewContainer = document.getElementById('modal-preview-container');
            const toggleText = document.getElementById('modal-preview-toggle-text');
            const textarea = document.getElementById('modal-note-content');
            const preview = document.getElementById('modal-markdown-preview');
            
            if (previewContainer.classList.contains('hidden')) {
                preview.innerHTML = renderMarkdown(textarea.value);
                editorContainer.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                toggleText.textContent = 'í¸ì§‘';
            } else {
                editorContainer.classList.remove('hidden');
                previewContainer.classList.add('hidden');
                toggleText.textContent = 'ë¯¸ë¦¬ë³´ê¸°';
            }
        };
        
        // ==================== íƒ­ ì „í™˜ ====================
        
        window.showTab = function(tabName) {
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('tab-profile').classList.remove('border-green-500', 'text-green-600');
            document.getElementById('tab-notes').classList.remove('border-green-500', 'text-green-600');
            document.getElementById('tab-notices').classList.remove('border-green-500', 'text-green-600');
            document.getElementById('tab-exam').classList.remove('border-green-500', 'text-green-600');

            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('section-profile').classList.add('hidden');
            document.getElementById('section-notes').classList.add('hidden');
            document.getElementById('section-notices').classList.add('hidden');
            document.getElementById('section-exam').classList.add('hidden');

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            if (tabName === 'profile') {
                document.getElementById('tab-profile').classList.add('border-green-500', 'text-green-600');
                document.getElementById('section-profile').classList.remove('hidden');
            } else if (tabName === 'notes') {
                document.getElementById('tab-notes').classList.add('border-green-500', 'text-green-600');
                document.getElementById('section-notes').classList.remove('hidden');
            } else if (tabName === 'notices') {
                document.getElementById('tab-notices').classList.add('border-green-500', 'text-green-600');
                document.getElementById('section-notices').classList.remove('hidden');
                loadStudentNotices();
            } else if (tabName === 'exam') {
                document.getElementById('tab-exam').classList.add('border-green-500', 'text-green-600');
                document.getElementById('section-exam').classList.remove('hidden');
                loadStudentExams();
            }
        };
        
        // í•™ìƒìš© ê³µì§€ì‚¬í•­ ë¡œë“œ
        window.loadStudentNotices = async function() {
            try {
                // í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ
                window.showLoading('ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

                const student = JSON.parse(sessionStorage.getItem('student'));
                if (!student) {
                    window.hideLoading();
                    return;
                }

                // í•™ìƒìš© ê³µì§€ì‚¬í•­ API ì‚¬ìš© (ì „ì²´ + í•´ë‹¹ ê³¼ì • + ìˆ˜ê°• êµê³¼ëª©)
                const response = await axios.get(`${API_BASE_URL}/api/notices/student/${student.id}`);
                const notices = response.data;

                // í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê¹€
                window.hideLoading();

                const listDiv = document.getElementById('student-notices-list');
                const emptyDiv = document.getElementById('student-notices-empty');

                if (!notices || notices.length === 0) {
                    listDiv.innerHTML = '';
                    emptyDiv.classList.remove('hidden');
                    return;
                }

                // ê³µì§€ ìœ í˜•ë³„ ìŠ¤íƒ€ì¼
                const typeStyles = {
                    'all': { border: 'border-blue-500', bg: 'bg-blue-50', icon: 'fa-globe', color: 'text-blue-600', label: 'ì „ì²´' },
                    'course': { border: 'border-green-500', bg: 'bg-green-50', icon: 'fa-users', color: 'text-green-600', label: 'ê³¼ì •' },
                    'subject': { border: 'border-purple-500', bg: 'bg-purple-50', icon: 'fa-book', color: 'text-purple-600', label: 'êµê³¼ëª©' }
                };

                emptyDiv.classList.add('hidden');
                listDiv.innerHTML = notices.map(notice => {
                    const rawHtml = marked.parse(notice.content);
                    const cleanHtml = DOMPurify.sanitize(rawHtml);
                    const finalHtml = cleanHtml.replace(/<a /g, '<a target="_blank" rel="noopener noreferrer" ');
                    const style = typeStyles[notice.notice_type || 'all'];

                    return `
                        <div class="border-l-4 ${style.border} ${style.bg} p-4 rounded-r-lg">
                            <div class="flex items-start gap-3">
                                <div class="${style.color} text-2xl">
                                    <i class="fas ${style.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${style.bg} ${style.color}">
                                            ${style.label}${notice.target_name ? `: ${notice.target_name}` : ''}
                                        </span>
                                        <h3 class="text-lg font-bold text-gray-800">${notice.title}</h3>
                                    </div>
                                    <div class="text-sm text-gray-600 mb-3">
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${notice.start_date} ~ ${notice.end_date}
                                    </div>
                                    <div class="prose max-w-none text-gray-700">
                                        ${finalHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', error);
                window.hideLoading();
                document.getElementById('student-notices-list').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p>ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
                    </div>
                `;
            }
        };
        
        // ê°•ì‚¬ ëª©ë¡ ë¡œë“œ
        let instructorsList = [];
        
        async function loadInstructors() {
            try {
                const response = await axios.get(`${API_BASE_URL}/api/instructors`);
                instructorsList = response.data;
                
                // ë“œë¡­ë‹¤ìš´ì— ê°•ì‚¬ ëª©ë¡ ì¶”ê°€
                const instructorSelect = document.getElementById('preferred-instructor');
                if (instructorSelect) {
                    instructorSelect.innerHTML = '<option value="">ì„ íƒí•˜ì§€ ì•ŠìŒ</option>';
                    
                    instructorsList.forEach(instructor => {
                        const option = document.createElement('option');
                        option.value = instructor.code;
                        option.textContent = `${instructor.name} - ${instructor.instructor_type_name || instructor.instructor_type}`;
                        instructorSelect.appendChild(option);
                    });
                }
                
                console.log('âœ… ê°•ì‚¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', instructorsList.length);
            } catch (error) {
                console.error('ê°•ì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ==================== ì˜¨ë¼ì¸ ì‹œí—˜ ====================
        let examPollingInterval = null;
        let examStatusCheckInterval = null;  // ì‹œí—˜ ê°•ì œì¢…ë£Œ ê°ì§€ìš©
        let currentExamId = null;
        let examAnswers = {};

        // ==================== ì‹œí—˜ ëŒ€ê¸°ì‹¤ ì•Œë¦¼ ====================
        let notifiedExamIds = new Set(); // ì´ë¯¸ ì•Œë¦¼í•œ ì‹œí—˜ ID ì €ì¥
        let examNotificationInterval = null;

        function startExamNotificationPolling() {
            // ì¦‰ì‹œ í•œë²ˆ ì²´í¬
            checkExamNotifications();

            // 30ì´ˆë§ˆë‹¤ í´ë§
            examNotificationInterval = setInterval(checkExamNotifications, 30000);
        }

        async function checkExamNotifications() {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));
                if (!student) return;

                const response = await axios.get(`${API_BASE_URL}/api/online-exams?course_code=${student.course_code}`);
                const exams = response.data.exams || [];

                // ëŒ€ê¸°ì¤‘ì¸ ì‹œí—˜ í•„í„°ë§
                const waitingExams = exams.filter(e => e.status === 'waiting');

                for (const exam of waitingExams) {
                    // ì•„ì§ ì•Œë¦¼í•˜ì§€ ì•Šì€ ì‹œí—˜ë§Œ ì•Œë¦¼
                    if (!notifiedExamIds.has(exam.id)) {
                        notifiedExamIds.add(exam.id);
                        showExamNotification(exam);
                    }
                }
            } catch (error) {
                console.error('ì‹œí—˜ ì•Œë¦¼ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        function showExamNotification(exam) {
            // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë° í‘œì‹œ
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ğŸ“ ì‹œí—˜ ëŒ€ê¸°ì‹¤ ì˜¤í”ˆ!', {
                    body: `${exam.title} ì‹œí—˜ ëŒ€ê¸°ì‹¤ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ì…ì¥í•´ì£¼ì„¸ìš”!`,
                    icon: '/favicon.ico',
                    tag: `exam-${exam.id}`
                });
            } else if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }

            // í™”ë©´ ì•Œë¦¼ (ì»¤ìŠ¤í…€ ëª¨ë‹¬)
            showExamAlertModal(exam);
        }

        function showExamAlertModal(exam) {
            // ê¸°ì¡´ ì•Œë¦¼ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
            const existingModal = document.getElementById('exam-notification-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'exam-notification-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden animate-bounce-in">
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 p-6 text-white text-center">
                        <i class="fas fa-bell text-5xl mb-3 animate-pulse"></i>
                        <h2 class="text-2xl font-bold">ì‹œí—˜ ëŒ€ê¸°ì‹¤ ì˜¤í”ˆ!</h2>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">${exam.title}</h3>
                        <div class="flex justify-center gap-6 text-gray-600 mb-4">
                            <span><i class="fas fa-clock mr-2 text-blue-500"></i>ì‹œí—˜ì‹œê°„: ${exam.duration}ë¶„</span>
                            <span><i class="fas fa-list mr-2 text-green-500"></i>${exam.total_questions || '?'}ë¬¸í•­</span>
                        </div>

                        <!-- ì‹œí—˜ ì•ˆë‚´ì‚¬í•­ -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>ì‹œí—˜ ì•ˆë‚´ì‚¬í•­</h4>
                            <div class="text-sm text-blue-700 space-y-1">
                                ${exam.description ? `<p class="whitespace-pre-line">${exam.description}</p>` : `
                                <ul class="list-disc list-inside space-y-1">
                                    <li>ì‹œí—˜ ì‹œê°„ ë‚´ì— ëª¨ë“  ë¬¸ì œë¥¼ í’€ì–´ì£¼ì„¸ìš”.</li>
                                    <li>ì œì¶œ í›„ì—ëŠ” ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                                    <li>ì‹œí—˜ ì¤‘ í˜ì´ì§€ë¥¼ ë²—ì–´ë‚˜ì§€ ë§ˆì„¸ìš”.</li>
                                    <li>ë¶€ì •í–‰ìœ„ ì ë°œ ì‹œ 0ì  ì²˜ë¦¬ë©ë‹ˆë‹¤.</li>
                                </ul>
                                `}
                            </div>
                        </div>

                        <p class="text-orange-600 font-medium mb-4 text-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>ì§€ê¸ˆ ë°”ë¡œ ëŒ€ê¸°ì‹¤ì— ì…ì¥í•´ì£¼ì„¸ìš”!
                        </p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="this.closest('#exam-notification-modal').remove()"
                                    class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium">
                                ë‚˜ì¤‘ì—
                            </button>
                            <button onclick="goToExamWaiting(${exam.id})"
                                    class="px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white rounded-lg font-medium">
                                <i class="fas fa-sign-in-alt mr-2"></i>ì…ì¥í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // ì•Œë¦¼ìŒ ì¬ìƒ (ì„ íƒì )
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleVsFN5/g7MVhBgA8oOjsv1kGBDyg6ey/WQYEPJ/o7L9ZBQQ8n+jrv1kFBDyf6Ou+WQYEPZ/n6r1ZBQQ9nufqvVkFBD2e5um8WAUEQJ7m6LtXBARAn+XnulYEBEOe5ea5VQQEQ57k5bhUBARDnuTluFQDBESe4+O3UwMERJ7j47dSAwREn+Pit1IDBEWf4eG2UQMERY/g4LZRAQVF');
                audio.volume = 0.5;
                audio.play().catch(() => {});
            } catch (e) {}
        }

        window.goToExamWaiting = function(examId) {
            // ì•Œë¦¼ ëª¨ë‹¬ ë‹«ê¸°
            const modal = document.getElementById('exam-notification-modal');
            if (modal) modal.remove();

            // ì‹œí—˜ íƒ­ìœ¼ë¡œ ì´ë™
            showTab('exam');

            // ëŒ€ê¸°ì‹¤ ì…ì¥
            setTimeout(() => enterExam(examId), 300);
        };

        // ì‹œí—˜ ì„¹ì…˜ ì›ë˜ êµ¬ì¡°ë¡œ ë³µì›
        window.restoreExamSection = function() {
            // ëª¨ë“  íƒ€ì´ë¨¸/í´ë§ ì •ë¦¬
            if (examPollingInterval) {
                clearInterval(examPollingInterval);
                examPollingInterval = null;
            }
            if (examStatusCheckInterval) {
                clearInterval(examStatusCheckInterval);
                examStatusCheckInterval = null;
            }

            const section = document.getElementById('section-exam');
            section.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-6 text-white">
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-laptop mr-3"></i>
                            ì˜¨ë¼ì¸ì‹œí—˜/ê³¼ì œ
                        </h2>
                        <p class="text-blue-100 mt-2 text-sm">ì§„í–‰ ì¤‘ì¸ ì‹œí—˜ê³¼ ê³¼ì œì— ì°¸ì—¬í•˜ì„¸ìš”</p>
                    </div>
                    <div class="p-6">
                        <div id="student-exam-list" class="space-y-4"></div>
                        <div id="student-exam-empty" class="hidden text-center py-12 text-gray-500">
                            <i class="fas fa-clipboard-list text-6xl mb-4"></i>
                            <p>ì°¸ì—¬ ê°€ëŠ¥í•œ ì‹œí—˜/ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>
            `;
            loadStudentExams();
        };

        window.loadStudentExams = async function() {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));
                if (!student) return;

                const response = await axios.get(`${API_BASE_URL}/api/online-exams?course_code=${student.course_code}`);
                const exams = response.data.exams || [];

                // ëŒ€ê¸°ì¤‘/ì§„í–‰ì¤‘ ì‹œí—˜ ë˜ëŠ” ì§„í–‰ì¤‘ ê³¼ì œ í•„í„°ë§
                const activeExams = exams.filter(e => {
                    if (e.exam_type === 'assignment') {
                        // ê³¼ì œ: ì§„í–‰ì¤‘ì¸ ê²ƒë§Œ (ë§ˆê° ì „)
                        return e.status === 'ongoing';
                    }
                    // ì‹œí—˜/í€´ì¦ˆ: ëŒ€ê¸°ì¤‘ ë˜ëŠ” ì§„í–‰ì¤‘
                    return ['waiting', 'ongoing'].includes(e.status);
                });

                const listDiv = document.getElementById('student-exam-list');
                const emptyDiv = document.getElementById('student-exam-empty');

                if (activeExams.length === 0) {
                    listDiv.innerHTML = '';
                    emptyDiv.classList.remove('hidden');
                    return;
                }

                emptyDiv.classList.add('hidden');

                // ê³¼ì œ ì œì¶œ ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ë¹„ë™ê¸° ì²˜ë¦¬
                const examCards = await Promise.all(activeExams.map(async (exam) => {
                    if (exam.exam_type === 'assignment') {
                        // ê³¼ì œ ì¹´ë“œ ë Œë”ë§
                        let submissionStatus = null;
                        try {
                            const statusRes = await axios.get(`${API_BASE_URL}/api/online-exams/${exam.id}/assignment-status?student_id=${student.id}`);
                            submissionStatus = statusRes.data;
                        } catch (e) {
                            // ì œì¶œ ì •ë³´ ì—†ìŒ
                        }

                        const deadline = exam.deadline ? new Date(exam.deadline) : null;
                        const now = new Date();
                        const isOverdue = deadline && deadline < now;
                        const deadlineStr = deadline ? deadline.toLocaleString('ko-KR', {
                            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        }) : 'ê¸°í•œ ì—†ìŒ';

                        let statusLabel, statusColor, buttonText, buttonColor, buttonAction;
                        if (isOverdue) {
                            statusLabel = 'ë§ˆê°ë¨';
                            statusColor = 'bg-gray-100 text-gray-600';
                            buttonText = submissionStatus?.submitted ? 'ì œì¶œì™„ë£Œ' : 'ë¯¸ì œì¶œ';
                            buttonColor = 'bg-gray-400 cursor-not-allowed';
                            buttonAction = '';
                        } else if (submissionStatus?.submitted) {
                            statusLabel = 'ì œì¶œì™„ë£Œ';
                            statusColor = 'bg-green-100 text-green-700';
                            buttonText = 'ìˆ˜ì •í•˜ê¸°';
                            buttonColor = 'bg-blue-500 hover:bg-blue-600';
                            buttonAction = `onclick="showAssignmentSubmit(${exam.id})"`;
                        } else {
                            statusLabel = 'ì§„í–‰ì¤‘';
                            statusColor = 'bg-orange-100 text-orange-700';
                            buttonText = 'ê³¼ì œ ì œì¶œ';
                            buttonColor = 'bg-orange-500 hover:bg-orange-600';
                            buttonAction = `onclick="showAssignmentSubmit(${exam.id})"`;
                        }

                        return `
                            <div class="border-2 border-orange-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-orange-50">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-2 py-0.5 bg-orange-500 text-white text-xs rounded font-medium">ê³¼ì œ</span>
                                            <h3 class="font-bold text-lg text-gray-800">${exam.title}</h3>
                                        </div>
                                        <p class="text-sm text-gray-500 mt-1">
                                            <i class="fas fa-calendar-alt mr-1"></i>ë§ˆê°: ${deadlineStr}
                                            ${submissionStatus?.submitted ? `<span class="mx-2">|</span><i class="fas fa-check-circle text-green-500 mr-1"></i>ì œì¶œ: ${new Date(submissionStatus.submitted_at).toLocaleString('ko-KR', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}` : ''}
                                        </p>
                                        ${exam.description ? `<p class="text-sm text-gray-600 mt-2">${exam.description}</p>` : ''}
                                    </div>
                                    <div class="text-right">
                                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">${statusLabel}</span>
                                        <button ${buttonAction} class="block mt-3 px-4 py-2 ${buttonColor} text-white rounded-lg font-medium" ${isOverdue && !submissionStatus?.submitted ? 'disabled' : ''}>
                                            <i class="fas ${submissionStatus?.submitted ? 'fa-edit' : 'fa-upload'} mr-1"></i>${buttonText}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // ì‹œí—˜/í€´ì¦ˆ ì¹´ë“œ ë Œë”ë§ (ê¸°ì¡´ ë¡œì§)
                        const typeLabel = exam.exam_type === 'quiz' ? 'í€´ì¦ˆ' : 'ì‹œí—˜';
                        const typeColor = exam.exam_type === 'quiz' ? 'bg-purple-500' : 'bg-blue-500';
                        const statusLabel = exam.status === 'waiting' ? 'ëŒ€ê¸°ì¤‘' : 'ì§„í–‰ì¤‘';
                        const statusColor = exam.status === 'waiting' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700';
                        const buttonText = exam.status === 'waiting' ? 'ëŒ€ê¸°ì‹¤ ì…ì¥' : 'ì‹œí—˜ ì‘ì‹œ';
                        const buttonColor = exam.status === 'waiting' ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600';

                        return `
                            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-2 py-0.5 ${typeColor} text-white text-xs rounded font-medium">${typeLabel}</span>
                                            <h3 class="font-bold text-lg text-gray-800">${exam.title}</h3>
                                        </div>
                                        <p class="text-sm text-gray-500 mt-1">
                                            <i class="fas fa-question-circle mr-1"></i>${exam.total_questions || 0}ë¬¸í•­
                                            <span class="mx-2">|</span>
                                            <i class="fas fa-clock mr-1"></i>${exam.duration}ë¶„
                                        </p>
                                        ${exam.description ? `<p class="text-sm text-gray-600 mt-2">${exam.description}</p>` : ''}
                                    </div>
                                    <div class="text-right">
                                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">${statusLabel}</span>
                                        <button onclick="enterExam(${exam.id})" class="block mt-3 px-4 py-2 ${buttonColor} text-white rounded-lg font-medium">
                                            <i class="fas fa-sign-in-alt mr-1"></i>${buttonText}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }));

                listDiv.innerHTML = examCards.join('');
            } catch (error) {
                console.error('ì‹œí—˜/ê³¼ì œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        };

        // ê³¼ì œ ì œì¶œ í™”ë©´ í‘œì‹œ
        window.showAssignmentSubmit = async function(examId) {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));
                if (!student) {
                    window.showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                // ê³¼ì œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const examRes = await axios.get(`${API_BASE_URL}/api/online-exams?course_code=${student.course_code}`);
                const exam = (examRes.data.exams || []).find(e => e.id === examId);

                if (!exam) {
                    window.showAlert('ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                // ê¸°ì¡´ ì œì¶œ ìƒíƒœ í™•ì¸
                let submissionStatus = null;
                try {
                    const statusRes = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}/assignment-status?student_id=${student.id}`);
                    submissionStatus = statusRes.data;
                } catch (e) {
                    // ì œì¶œ ì •ë³´ ì—†ìŒ
                }

                const deadline = exam.deadline ? new Date(exam.deadline) : null;
                const deadlineStr = deadline ? deadline.toLocaleString('ko-KR', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                }) : 'ê¸°í•œ ì—†ìŒ';

                const section = document.getElementById('section-exam');
                section.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <!-- ê³¼ì œ í—¤ë” -->
                        <div class="bg-gradient-to-r from-orange-500 to-amber-500 p-6 text-white">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 bg-white bg-opacity-20 rounded text-sm">ê³¼ì œ</span>
                                    </div>
                                    <h2 class="text-2xl font-bold">${exam.title}</h2>
                                    ${exam.description ? `<p class="text-orange-100 mt-2">${exam.description}</p>` : ''}
                                </div>
                                <button onclick="restoreExamSection()" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg">
                                    <i class="fas fa-arrow-left mr-2"></i>ëª©ë¡ìœ¼ë¡œ
                                </button>
                            </div>
                        </div>

                        <!-- ê³¼ì œ ì •ë³´ -->
                        <div class="p-6 border-b bg-orange-50">
                            <div class="flex flex-wrap gap-6 text-sm">
                                <div>
                                    <span class="text-gray-500"><i class="fas fa-calendar-alt mr-1"></i>ë§ˆê°ì¼</span>
                                    <p class="font-bold text-gray-800">${deadlineStr}</p>
                                </div>
                                ${submissionStatus?.submitted ? `
                                <div>
                                    <span class="text-gray-500"><i class="fas fa-check-circle mr-1 text-green-500"></i>ì œì¶œì¼ì‹œ</span>
                                    <p class="font-bold text-gray-800">${new Date(submissionStatus.submitted_at).toLocaleString('ko-KR')}</p>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- ì œì¶œ ì–‘ì‹ -->
                        <div class="p-6">
                            ${submissionStatus?.submitted ? `
                            <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h4 class="font-bold text-green-800 mb-2"><i class="fas fa-check-circle mr-2"></i>ê¸°ì¡´ ì œì¶œ ë‚´ì—­</h4>
                                ${submissionStatus.file_name ? `
                                <p class="text-sm text-gray-600 mb-2">
                                    <i class="fas fa-file mr-2"></i>ì²¨ë¶€íŒŒì¼:
                                    <a href="${API_BASE_URL}/api/assignments/download/${encodeURIComponent(submissionStatus.file_name)}"
                                       class="text-blue-600 hover:underline" target="_blank">${submissionStatus.file_name}</a>
                                </p>
                                ` : ''}
                                ${submissionStatus.answer_text ? `
                                <div class="mt-2">
                                    <p class="text-sm text-gray-600 mb-1"><i class="fas fa-comment mr-2"></i>ë‹µë³€ ë‚´ìš©:</p>
                                    <p class="text-gray-700 bg-white p-3 rounded border">${submissionStatus.answer_text}</p>
                                </div>
                                ` : ''}
                                <p class="text-sm text-orange-600 mt-3"><i class="fas fa-info-circle mr-1"></i>ë§ˆê° ì „ê¹Œì§€ ë‹¤ì‹œ ì œì¶œí•˜ì—¬ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                            ` : ''}

                            <form id="assignment-form" enctype="multipart/form-data">
                                <input type="hidden" id="assignment-exam-id" value="${examId}">

                                <!-- íŒŒì¼ ì²¨ë¶€ -->
                                <div class="mb-6">
                                    <label class="block font-bold text-gray-700 mb-2">
                                        <i class="fas fa-paperclip mr-2"></i>íŒŒì¼ ì²¨ë¶€
                                    </label>
                                    <div id="assignment-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-orange-400 transition-colors cursor-pointer"
                                         onclick="document.getElementById('assignment-file').click()">
                                        <input type="file" id="assignment-file" class="hidden" onchange="updateAssignmentFileName(this)">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3" id="assignment-upload-icon"></i>
                                        <p class="text-gray-600 font-medium" id="assignment-file-label">í´ë¦­ ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”</p>
                                        <p class="text-sm text-gray-400 mt-1">ìµœëŒ€ 50MB</p>
                                    </div>
                                </div>

                                <!-- í…ìŠ¤íŠ¸ ë‹µë³€ -->
                                <div class="mb-6">
                                    <label class="block font-bold text-gray-700 mb-2">
                                        <i class="fas fa-pen mr-2"></i>ë‹µë³€ ë‚´ìš© (ì„ íƒì‚¬í•­)
                                    </label>
                                    <textarea id="assignment-text" rows="6"
                                              class="w-full border-2 border-gray-200 rounded-lg p-4 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                              placeholder="ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ë‹µë³€ì„ ì‘ì„±í•˜ì„¸ìš”...">${submissionStatus?.answer_text || ''}</textarea>
                                </div>

                                <!-- ì œì¶œ ë²„íŠ¼ -->
                                <div class="text-center">
                                    <button type="button" onclick="submitAssignment(${examId})"
                                            class="px-8 py-3 bg-orange-500 hover:bg-orange-600 text-white text-lg font-bold rounded-lg shadow-lg">
                                        <i class="fas fa-paper-plane mr-2"></i>${submissionStatus?.submitted ? 'ë‹¤ì‹œ ì œì¶œ' : 'ê³¼ì œ ì œì¶œ'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;

                // ë“œë˜ê·¸ì•¤ë“œë¡­ ì„¤ì •
                setTimeout(() => window.setupAssignmentDropZone(), 100);
            } catch (error) {
                console.error('ê³¼ì œ í™”ë©´ ë¡œë“œ ì‹¤íŒ¨:', error);
                window.showAlert('ê³¼ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        };

        // íŒŒì¼ëª… í‘œì‹œ ì—…ë°ì´íŠ¸
        window.updateAssignmentFileName = function(input) {
            const label = document.getElementById('assignment-file-label');
            const icon = document.getElementById('assignment-upload-icon');
            const dropZone = document.getElementById('assignment-drop-zone');
            if (input.files && input.files[0]) {
                label.textContent = input.files[0].name;
                label.classList.add('text-orange-600', 'font-bold');
                if (icon) icon.className = 'fas fa-file-check text-4xl text-green-500 mb-3';
                if (dropZone) dropZone.classList.add('border-green-400', 'bg-green-50');
            } else {
                label.textContent = 'í´ë¦­ ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”';
                label.classList.remove('text-orange-600', 'font-bold');
                if (icon) icon.className = 'fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3';
                if (dropZone) dropZone.classList.remove('border-green-400', 'bg-green-50');
            }
        };

        // ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸ ì„¤ì •
        window.setupAssignmentDropZone = function() {
            const dropZone = document.getElementById('assignment-drop-zone');
            const fileInput = document.getElementById('assignment-file');
            if (!dropZone || !fileInput) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('border-orange-500', 'bg-orange-50');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('border-orange-500', 'bg-orange-50');
                });
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    updateAssignmentFileName(fileInput);
                }
            });
        };

        // ê³¼ì œ ì œì¶œ
        window.submitAssignment = async function(examId) {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));
                const fileInput = document.getElementById('assignment-file');
                const textInput = document.getElementById('assignment-text');

                const file = fileInput?.files?.[0];
                const answerText = textInput?.value?.trim();

                if (!file && !answerText) {
                    window.showAlert('íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜ ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                const formData = new FormData();
                formData.append('student_id', student.id);
                if (file) {
                    formData.append('file', file);
                }
                if (answerText) {
                    formData.append('answer_text', answerText);
                }

                const response = await axios.post(
                    `${API_BASE_URL}/api/online-exams/${examId}/submit-assignment`,
                    formData,
                    { headers: { 'Content-Type': 'multipart/form-data' } }
                );

                if (response.data.success) {
                    window.showAlert(response.data.message || 'ê³¼ì œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    setTimeout(() => {
                        restoreExamSection();
                    }, 1500);
                }
            } catch (error) {
                console.error('ê³¼ì œ ì œì¶œ ì‹¤íŒ¨:', error);
                const errorMsg = error.response?.data?.detail || 'ê³¼ì œ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                window.showAlert(errorMsg, 'error');
            }
        };

        window.enterExam = async function(examId) {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));
                if (!student) {
                    window.showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/enter`, {
                    student_id: student.id
                });

                if (response.data.success) {
                    currentExamId = examId;

                    // ê¸°ì¡´ ë‹µì•ˆì´ ìˆìœ¼ë©´ ë³µì›
                    if (response.data.previous_answers) {
                        examAnswers = response.data.previous_answers;
                        window.showAlert('ì´ì „ ë‹µì•ˆì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ ì œì¶œí•˜ì„¸ìš”.', 'info');
                    }

                    if (response.data.exam_status === 'ongoing') {
                        // ì‹œí—˜ ì§„í–‰ ì¤‘ - ë°”ë¡œ ì‹œí—˜ í™”ë©´ìœ¼ë¡œ
                        showExamScreen(examId, response.data.previous_answers);
                    } else {
                        // ëŒ€ê¸° ì¤‘ - ëŒ€ê¸°ì‹¤ í™”ë©´ìœ¼ë¡œ
                        showWaitingRoom(examId);
                    }
                }
            } catch (error) {
                console.error('ì‹œí—˜ ì…ì¥ ì‹¤íŒ¨:', error);
                window.showAlert(error.response?.data?.detail || 'ì‹œí—˜ ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        };

        function showWaitingRoom(examId) {
            const section = document.getElementById('section-exam');
            section.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 p-6 text-white text-center">
                        <i class="fas fa-hourglass-half text-6xl mb-4 animate-pulse"></i>
                        <h2 class="text-2xl font-bold">ì‹œí—˜ ëŒ€ê¸°ì‹¤</h2>
                        <p class="text-yellow-100 mt-2">ê°•ì‚¬ê°€ ì‹œí—˜ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                    </div>
                    <div class="p-8 text-center">
                        <div class="animate-spin inline-block w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full mb-4"></div>
                        <p class="text-gray-600 text-lg">ëŒ€ê¸° ì¤‘...</p>
                        <p class="text-gray-400 text-sm mt-2">ì‹œí—˜ì´ ì‹œì‘ë˜ë©´ ìë™ìœ¼ë¡œ ì‹œí—˜ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            `;

            // 3ì´ˆë§ˆë‹¤ ì‹œí—˜ ìƒíƒœ í™•ì¸
            if (examPollingInterval) clearInterval(examPollingInterval);
            examPollingInterval = setInterval(() => checkExamStatus(examId), 3000);
        }

        async function checkExamStatus(examId) {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));
                const response = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}/status?student_id=${student.id}`);

                if (response.data.exam_status === 'ongoing') {
                    // ì‹œí—˜ ì‹œì‘ë¨
                    if (examPollingInterval) {
                        clearInterval(examPollingInterval);
                        examPollingInterval = null;
                    }
                    showExamScreen(examId);
                } else if (response.data.exam_status === 'ended') {
                    // ì‹œí—˜ ì¢…ë£Œë¨
                    if (examPollingInterval) {
                        clearInterval(examPollingInterval);
                        examPollingInterval = null;
                    }
                    window.showAlert('ì‹œí—˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    showTab('exam');
                }
            } catch (error) {
                console.error('ì‹œí—˜ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        async function showExamScreen(examId, previousAnswers = null) {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));
                const response = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}/questions?student_id=${student.id}`);
                const { exam, questions } = response.data;

                // ê¸°ì¡´ ë‹µì•ˆì´ ìˆìœ¼ë©´ ë³µì›, ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                if (previousAnswers && Object.keys(previousAnswers).length > 0) {
                    examAnswers = previousAnswers;
                } else {
                    examAnswers = {};
                }

                const section = document.getElementById('section-exam');
                section.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <!-- ì‹œí—˜ í—¤ë” -->
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 text-white sticky top-0 z-10">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-xl font-bold">${exam.title}</h2>
                                    <p class="text-blue-100 text-sm">${questions.length}ë¬¸í•­ ${previousAnswers ? '(ì¬ì‘ì‹œ)' : ''}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-mono font-bold" id="exam-timer">--:--</div>
                                    <p class="text-blue-100 text-sm">ë‚¨ì€ ì‹œê°„</p>
                                </div>
                            </div>
                        </div>

                        <!-- ë¬¸ì œ ëª©ë¡ -->
                        <div class="p-6">
                            <div id="exam-questions" class="space-y-6">
                                ${questions.map((q, idx) => renderQuestion(q, idx)).join('')}
                            </div>

                            <!-- ì œì¶œ ë²„íŠ¼ -->
                            <div class="mt-8 text-center">
                                <button onclick="submitExam(${examId})" class="px-8 py-3 bg-green-500 hover:bg-green-600 text-white text-lg font-bold rounded-lg shadow-lg">
                                    <i class="fas fa-paper-plane mr-2"></i>ë‹µì•ˆ ì œì¶œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // ê¸°ì¡´ ë‹µì•ˆì´ ìˆìœ¼ë©´ ë¼ë””ì˜¤ ë²„íŠ¼ ì²´í¬
                if (previousAnswers && Object.keys(previousAnswers).length > 0) {
                    Object.entries(previousAnswers).forEach(([qid, answer]) => {
                        const radio = document.querySelector(`input[name="q_${qid}"][value="${answer}"]`);
                        if (radio) {
                            radio.checked = true;
                        }
                    });
                }

                // íƒ€ì´ë¨¸ ì‹œì‘
                startExamTimer(examId, exam.ended_at);

            } catch (error) {
                console.error('ì‹œí—˜ ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', error);
                window.showAlert(error.response?.data?.detail || 'ì‹œí—˜ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function renderQuestion(question, index) {
            let options = question.options || [];
            let questionText = question.question_text || '';

            // ì„œìˆ í˜• ë¬¸ì œì—ì„œ ëª¨ë²”ë‹µì•ˆ, ì±„ì ê¸°ì¤€, í•´ì„¤ ë¶€ë¶„ ì œê±° (í•™ìƒì—ê²Œ ë³´ì´ë©´ ì•ˆë¨)
            questionText = questionText.replace(/\s*(ëª¨ë²”ë‹µì•ˆ|ì±„ì ê¸°ì¤€|í•´ì„¤|ì •ë‹µ|ë‹µì•ˆ)[:ï¼š].*/gi, '').trim();

            // A), B), C), D) ë˜ëŠ” 1), 2), 3), 4) ì ‘ë‘ì–´ ì œê±°
            const cleanOption = (opt) => opt.replace(/^[A-D1-4]\)\s*/, '').trim();

            // optionsê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ question_textì—ì„œ ì¶”ì¶œ
            if ((!options || options.length === 0) && questionText) {
                const optionMatches = questionText.match(/[1-4A-D]\)\s*[^1-4A-D)]+/g);
                if (optionMatches && optionMatches.length >= 2) {
                    options = optionMatches.map(match => match.replace(/^[1-4A-D]\)\s*/, '').trim());
                    // question_textì—ì„œ ì„ íƒì§€ ë¶€ë¶„ ì œê±°
                    const qMatch = questionText.match(/^(.+?)\s*(?=[1-4A-D]\))/);
                    if (qMatch) {
                        questionText = qMatch[1].trim();
                    }
                }
            }

            if (question.question_type === 'multiple_choice' && options.length > 0) {
                return `
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm mb-6 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 border-b">
                            <div class="flex items-start gap-4">
                                <span class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 shadow">${index + 1}</span>
                                <p class="text-gray-800 font-medium text-lg leading-relaxed pt-1">${questionText}</p>
                            </div>
                        </div>
                        <div class="p-5 space-y-3">
                            ${options.map((opt, i) => `
                                <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl hover:bg-blue-50 hover:border-blue-400 cursor-pointer transition-all bg-white group">
                                    <input type="radio" name="q_${question.question_id}" value="${i + 1}"
                                           onchange="saveAnswer(${question.question_id}, '${i + 1}')"
                                           class="w-5 h-5 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-4 text-gray-700 group-hover:text-blue-700">
                                        <span class="inline-block w-7 h-7 bg-gray-100 group-hover:bg-blue-100 rounded-full text-center leading-7 font-medium mr-2">${i + 1}</span>
                                        ${cleanOption(opt)}
                                    </span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                // ì£¼ê´€ì‹
                return `
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm mb-6 overflow-hidden">
                        <div class="bg-gradient-to-r from-green-50 to-teal-50 p-5 border-b">
                            <div class="flex items-start gap-4">
                                <span class="bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 shadow">${index + 1}</span>
                                <p class="text-gray-800 font-medium text-lg leading-relaxed pt-1">${questionText}</p>
                            </div>
                        </div>
                        <div class="p-5">
                            <input type="text" id="answer_${question.question_id}"
                                   onchange="saveAnswer(${question.question_id}, this.value)"
                                   class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 text-lg"
                                   placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>
                `;
            }
        }

        window.saveAnswer = function(questionId, answer) {
            examAnswers[questionId] = answer;
            console.log('ë‹µì•ˆ ì €ì¥:', questionId, answer);
        };

        function startExamTimer(examId, endedAt) {
            const endTime = new Date(endedAt).getTime();

            function updateTimer() {
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((endTime - now) / 1000));

                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;

                const timerEl = document.getElementById('exam-timer');
                if (timerEl) {
                    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    // 1ë¶„ ì´í•˜ë©´ ë¹¨ê°„ìƒ‰
                    if (remaining <= 60) {
                        timerEl.classList.add('text-red-300', 'animate-pulse');
                    }
                }

                if (remaining <= 0) {
                    // ì‹œê°„ ì¢…ë£Œ - ìë™ ì œì¶œ
                    clearInterval(examPollingInterval);
                    autoSubmitExam(examId);
                }
            }

            updateTimer();
            if (examPollingInterval) clearInterval(examPollingInterval);
            examPollingInterval = setInterval(updateTimer, 1000);

            // ì‹œí—˜ ê°•ì œì¢…ë£Œ ê°ì§€: 5ì´ˆë§ˆë‹¤ ì‹œí—˜ ìƒíƒœ í™•ì¸
            if (examStatusCheckInterval) clearInterval(examStatusCheckInterval);
            examStatusCheckInterval = setInterval(() => checkExamForceEnded(examId), 5000);
        }

        // ì‹œí—˜ ê°•ì œì¢…ë£Œ ê°ì§€ í•¨ìˆ˜
        async function checkExamForceEnded(examId) {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));
                const response = await axios.get(`${API_BASE_URL}/api/online-exams/${examId}/status?student_id=${student.id}`);

                if (response.data.exam_status === 'ended') {
                    // ê°•ì‚¬ê°€ ì‹œí—˜ì„ ì¢…ë£Œí•¨
                    if (examPollingInterval) {
                        clearInterval(examPollingInterval);
                        examPollingInterval = null;
                    }
                    if (examStatusCheckInterval) {
                        clearInterval(examStatusCheckInterval);
                        examStatusCheckInterval = null;
                    }
                    window.showAlert('ê°•ì‚¬ê°€ ì‹œí—˜ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'info');
                    setTimeout(() => {
                        restoreExamSection();
                    }, 1500);
                }
            } catch (error) {
                console.error('ì‹œí—˜ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        async function autoSubmitExam(examId) {
            window.showAlert('ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì–´ ìë™ ì œì¶œë©ë‹ˆë‹¤.', 'info');
            await submitExamAnswers(examId);
        }

        window.submitExam = async function(examId) {
            const answeredCount = Object.keys(examAnswers).length;
            const confirmed = await window.showConfirm(`${answeredCount}ê°œì˜ ë‹µì•ˆì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì œì¶œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'ë‹µì•ˆ ì œì¶œ');
            if (confirmed) {
                await submitExamAnswers(examId);
            }
        };

        async function submitExamAnswers(examId) {
            try {
                const student = JSON.parse(sessionStorage.getItem('student'));

                const response = await axios.post(`${API_BASE_URL}/api/online-exams/${examId}/submit`, {
                    student_id: student.id,
                    answers: examAnswers
                });

                if (response.data.success) {
                    if (examPollingInterval) {
                        clearInterval(examPollingInterval);
                        examPollingInterval = null;
                    }
                    if (examStatusCheckInterval) {
                        clearInterval(examStatusCheckInterval);
                        examStatusCheckInterval = null;
                    }

                    // ì œì¶œ ì™„ë£Œ í™”ë©´
                    const section = document.getElementById('section-exam');
                    section.innerHTML = `
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <div class="bg-gradient-to-r from-green-500 to-teal-500 p-8 text-white text-center">
                                <i class="fas fa-check-circle text-8xl mb-4"></i>
                                <h2 class="text-3xl font-bold">ë‹µì•ˆ ì œì¶œ ì™„ë£Œ!</h2>
                                <p class="text-green-100 mt-2">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
                            </div>
                            <div class="p-8 text-center">
                                <p class="text-gray-600 text-lg mb-6">ì±„ì ì´ ì™„ë£Œë˜ë©´ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                <button onclick="restoreExamSection()" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">
                                    <i class="fas fa-list mr-2"></i>ì‹œí—˜ ëª©ë¡ìœ¼ë¡œ
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ë‹µì•ˆ ì œì¶œ ì‹¤íŒ¨:', error);
                const errorDetail = error.response?.data?.detail || '';

                // ì‹œí—˜ì´ ê°•ì œ ì¢…ë£Œëœ ê²½ìš° ëª©ë¡ìœ¼ë¡œ ì´ë™
                if (errorDetail.includes('ì¢…ë£Œ') || error.response?.status === 400) {
                    if (examPollingInterval) {
                        clearInterval(examPollingInterval);
                        examPollingInterval = null;
                    }
                    window.showAlert('ì‹œí—˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'info');
                    setTimeout(() => {
                        restoreExamSection();
                    }, 1500);
                } else {
                    window.showAlert(errorDetail || 'ë‹µì•ˆ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í•™ìƒ ì •ë³´ í‘œì‹œ
        window.addEventListener('DOMContentLoaded', async () => {
            // ê¸°ë³¸ì ìœ¼ë¡œ ìˆ˜ì—…ë©”ëª¨ íƒ­ í‘œì‹œ
            showTab('notes');
            // ë©”ëª¨ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            setTimeout(() => {
                loadAllNotes();
            }, 500);
            // ê°•ì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            loadInstructors();
            
            let student = JSON.parse(sessionStorage.getItem('student'));
            if (!student) {
                window.showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1000);
                return;
            }
            
            // ì„œë²„ì—ì„œ ìµœì‹  í•™ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            try {
                const response = await axios.get(`${API_BASE_URL}/api/students/${student.id}`);
                if (response.data) {
                    // ìµœì‹  ì •ë³´ë¡œ ì—…ë°ì´íŠ¸
                    student = response.data;
                    
                    // localStorageë„ ì—…ë°ì´íŠ¸ (ë¹„ë°€ë²ˆí˜¸ ì œì™¸)
                    const storedStudent = JSON.parse(sessionStorage.getItem('student'));
                    const updatedData = {
                        ...student,
                        password: storedStudent.password
                    };
                    sessionStorage.setItem('student', JSON.stringify(updatedData));
                }
            } catch (error) {
                console.error('ìµœì‹  í•™ìƒ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            
            // í—¤ë”ì— ì´ë¦„ í‘œì‹œ
            document.getElementById('studentName').textContent = student.name;
            
            // í¼ì— ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('student-name').value = student.name || '';
            document.getElementById('student-birth-date').value = student.birth_date || '';
            document.getElementById('student-gender').value = student.gender || '';
            document.getElementById('student-phone').value = student.phone || '';
            document.getElementById('student-email').value = student.email || '';
            document.getElementById('student-address').value = student.address || '';
            document.getElementById('student-interests').value = student.interests || '';
            document.getElementById('student-education').value = student.education || '';
            document.getElementById('student-introduction').value = student.introduction || '';
            
            // í”„ë¡œí•„ ì‚¬ì§„
            if (student.profile_photo) {
                document.getElementById('student-photo').src = API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(student.profile_photo);
            }
            
            // ì²¨ë¶€ íŒŒì¼ ëª©ë¡
            if (student.attachments) {
                try {
                    const attachments = JSON.parse(student.attachments);
                    if (attachments && attachments.length > 0) {
                        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                        updateStudentFilePreview(attachments);
                        // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                        const fileCountSpan = document.getElementById('student-file-count');
                        if (fileCountSpan) {
                            fileCountSpan.textContent = attachments.length;
                        }
                    }
                } catch (e) {
                    console.error('ì²¨ë¶€ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', e);
                }
            }
            
            // ê³¼ì • ì •ë³´
            document.getElementById('course-name').textContent = student.course_name || 'ë¯¸ë°°ì •';
            if (student.start_date && student.end_date) {
                document.getElementById('course-period').textContent = `${student.start_date} ~ ${student.end_date}`;
            } else if (student.start_date) {
                document.getElementById('course-period').textContent = `${student.start_date} ~`;
            } else {
                document.getElementById('course-period').textContent = 'ë¯¸ì •';
            }

            // ì‹œí—˜ ëŒ€ê¸°ì‹¤ ì•Œë¦¼ í´ë§ ì‹œì‘
            startExamNotificationPolling();
        });
        
        // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ
        window.uploadStudentPhoto = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            const progressContainer = document.getElementById('student-upload-progress');
            const progressBar = document.getElementById('student-progress-bar');
            const progressText = document.getElementById('student-progress-text');
            
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = 'ì—…ë¡œë“œ ì¤‘... 0%';
            
            try {
                const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=student`, formData, {
                    onUploadProgress: (progressEvent) => {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        progressBar.style.width = percentCompleted + '%';
                        progressText.textContent = `ì—…ë¡œë“œ ì¤‘... ${percentCompleted}%`;
                    }
                });
                
                const photoUrl = response.data.url;
                document.getElementById('student-photo').src = API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(photoUrl);
                
                progressBar.style.width = '100%';
                progressText.textContent = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ!';
                
                // ìë™ ì €ì¥
                const student = JSON.parse(sessionStorage.getItem('student'));
                if (student && student.id) {
                    await saveStudentProfileSilent(photoUrl);
                    window.showAlert('âœ… í”„ë¡œí•„ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    window.showAlert('âœ… í”„ë¡œí•„ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }
                
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                progressText.textContent = 'âŒ ì—…ë¡œë“œ ì‹¤íŒ¨';
                window.showAlert('âŒ ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 2000);
            }
        };
        
        // íŒŒì¼ ì•„ì´ì½˜ ë°˜í™˜
        function getFileIcon(extension) {
            const iconMap = {
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'docx': 'fas fa-file-word',
                'xls': 'fas fa-file-excel',
                'xlsx': 'fas fa-file-excel',
                'ppt': 'fas fa-file-powerpoint',
                'pptx': 'fas fa-file-powerpoint',
                'txt': 'fas fa-file-alt',
                'hwp': 'fas fa-file-alt',
                'zip': 'fas fa-file-archive',
                'rar': 'fas fa-file-archive'
            };
            return iconMap[extension] || 'fas fa-file';
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ (ì²¨ë¶€ íŒŒì¼ - ìµœëŒ€ 20ê°œ)
        window.uploadStudentFiles = async function(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const student = JSON.parse(sessionStorage.getItem('student'));
            const progressDiv = document.getElementById('student-file-upload-progress');
            const progressBar = document.getElementById('student-file-progress-bar');
            
            try {
                // ê¸°ì¡´ ì²¨ë¶€ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
                let attachments = [];
                if (student.attachments) {
                    try {
                        attachments = JSON.parse(student.attachments);
                    } catch (e) {
                        attachments = [];
                    }
                }
                
                // íŒŒì¼ ê°œìˆ˜ ì œí•œ ì²´í¬ (ìµœëŒ€ 20ê°œ)
                const remainingSlots = 20 - attachments.length;
                if (remainingSlots <= 0) {
                    window.showAlert('âš ï¸ ì²¨ë¶€ íŒŒì¼ì€ ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                    event.target.value = '';
                    return;
                }
                
                if (files.length > remainingSlots) {
                    window.showAlert(`âš ï¸ ${remainingSlots}ê°œì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${attachments.length}/20)`, 'warning');
                    event.target.value = '';
                    return;
                }
                
                progressDiv.classList.remove('hidden');
                progressBar.style.width = '0%';
                
                // íŒŒì¼ ì—…ë¡œë“œ
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=student`, formData, {
                        onUploadProgress: (progressEvent) => {
                            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            progressBar.style.width = percentCompleted + '%';
                        }
                    });
                    
                    // URLê³¼ ì›ë³¸ íŒŒì¼ëª…ì„ í•¨ê»˜ ì €ì¥ (URL#ì›ë³¸íŒŒì¼ëª… í˜•ì‹)
                    const urlWithOriginalName = response.data.original_filename 
                        ? `${response.data.url}#${encodeURIComponent(response.data.original_filename)}`
                        : response.data.url;
                    attachments.push(urlWithOriginalName);
                }
                
                // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                updateStudentFilePreview(attachments);
                
                // í”„ë¡œí•„ ì‚¬ì§„ URL ê°€ì ¸ì˜¤ê¸°
                const profilePhoto = document.getElementById('student-photo').src.includes('/api/thumbnail')
                    ? new URLSearchParams(document.getElementById('student-photo').src.split('?')[1]).get('url')
                    : student.profile_photo;
                
                // ìë™ ì €ì¥ - JSON ë°ì´í„° ì‚¬ìš©
                const updateData = {
                    name: student.name,
                    birth_date: document.getElementById('student-birth-date').value || '',
                    gender: document.getElementById('student-gender').value || '',
                    phone: document.getElementById('student-phone').value || '',
                    email: document.getElementById('student-email').value || '',
                    address: document.getElementById('student-address').value || '',
                    interests: document.getElementById('student-interests').value || '',
                    education: document.getElementById('student-education').value || '',
                    introduction: document.getElementById('student-introduction').value || '',
                    campus: student.campus || '',
                    course_code: student.course_code || '',
                    notes: student.notes || '',
                    career_path: student.career_path || '4. ë¯¸ì •',
                    profile_photo: profilePhoto,
                    attachments: JSON.stringify(attachments)
                };
                
                await axios.put(`${API_BASE_URL}/api/students/${student.id}`, updateData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                student.attachments = JSON.stringify(attachments);
                sessionStorage.setItem('student', JSON.stringify(student));
                
                // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                const fileCountSpan = document.getElementById('student-file-count');
                if (fileCountSpan) {
                    fileCountSpan.textContent = attachments.length;
                }
                
                progressBar.style.width = '100%';
                window.showAlert(`âœ… ${files.length}ê°œ íŒŒì¼ì´ ì—…ë¡œë“œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (${attachments.length}/20)`, 'success');
                
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                }, 2000);
                
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                progressDiv.classList.add('hidden');
                window.showAlert('âŒ íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
            
            // íŒŒì¼ input ì´ˆê¸°í™”
            event.target.value = '';
        };
        
        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateStudentFilePreview(photoUrls) {
            const previewDiv = document.getElementById('student-file-list');
            if (!previewDiv) return;
            
            previewDiv.innerHTML = '';
            
            photoUrls.forEach((url, index) => {
                const fileExt = url.split('.').pop().toLowerCase();
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt);
                
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center gap-3 p-3 bg-white rounded border hover:shadow-md transition';
                
                if (isImage) {
                    fileDiv.innerHTML = `
                        <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(url)}" 
                             alt="íŒŒì¼ ${index + 1}" 
                             class="w-16 h-16 object-cover rounded border cursor-pointer hover:opacity-80 transition"
                             onclick="window.showImagePreview('${url.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${window.getFilenameFromUrl(url).replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"
                             title="í´ë¦­í•˜ì—¬ í¬ê²Œ ë³´ê¸°"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2764%27 height=%2764%27%3E%3Crect fill=%27%23f0f0f0%27 width=%2764%27 height=%2764%27/%3E%3Ctext fill=%27%23999%27 font-family=%27sans-serif%27 font-size=%2712%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3EError%3C/text%3E%3C/svg%3E'">
                        <div class="flex-1">
                            <p class="text-sm text-gray-800 font-medium truncate" title="${window.getFilenameFromUrl(url)}">${window.getFilenameFromUrl(url)}</p>
                            <button type="button" 
                                    onclick="window.showImagePreview('${url.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${window.getFilenameFromUrl(url).replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"
                                    class="text-xs text-blue-500 hover:underline hover:text-blue-700">
                                <i class="fas fa-eye mr-1"></i>ë¯¸ë¦¬ë³´ê¸°
                            </button>
                            <span class="text-gray-300 mx-1">|</span>
                            <button type="button" 
                                    onclick="window.downloadFile('${url.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${window.getFilenameFromUrl(url).replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"
                                    class="text-xs text-green-500 hover:underline hover:text-green-700">
                                <i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <button type="button" 
                                onclick="removeStudentFile(${index})" 
                                class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times-circle text-xl"></i>
                        </button>
                    `;
                } else {
                    const icon = getFileIcon(fileExt);
                    fileDiv.innerHTML = `
                        <div class="w-16 h-16 flex items-center justify-center bg-gray-100 rounded border cursor-pointer hover:bg-gray-200 transition"
                             onclick="window.downloadFile('${url.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${window.getFilenameFromUrl(url).replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"
                             title="í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ">
                            <i class="${icon} text-3xl text-gray-500"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-800 font-medium truncate" title="${window.getFilenameFromUrl(url)}">${window.getFilenameFromUrl(url)}</p>
                            <button type="button" 
                                    onclick="window.downloadFile('${url.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${window.getFilenameFromUrl(url).replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"
                                    class="text-xs text-green-500 hover:underline hover:text-green-700">
                                <i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <button type="button" 
                                onclick="removeStudentFile(${index})" 
                                class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times-circle text-xl"></i>
                        </button>
                    `;
                }
                
                previewDiv.appendChild(fileDiv);
            });
        }
        
        // íŒŒì¼ ì‚­ì œ
        window.removeStudentFile = async function(index) {
            const confirmed = await window.showConfirm('âš ï¸ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ íŒŒì¼ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            if (!confirmed) return;
            
            const student = JSON.parse(sessionStorage.getItem('student'));
            
            // ê¸°ì¡´ attachments ê°€ì ¸ì˜¤ê¸°
            let attachments = [];
            if (student.attachments) {
                try {
                    attachments = JSON.parse(student.attachments);
                } catch (e) {
                    attachments = [];
                }
            }
            
            attachments.splice(index, 1);
            
            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updateStudentFilePreview(attachments);
            
            // ìë™ ì €ì¥ - JSON ë°ì´í„° ì‚¬ìš©
            try {
                // í”„ë¡œí•„ ì‚¬ì§„ URL ê°€ì ¸ì˜¤ê¸°
                const profilePhoto = document.getElementById('student-photo').src.includes('/api/thumbnail')
                    ? new URLSearchParams(document.getElementById('student-photo').src.split('?')[1]).get('url')
                    : student.profile_photo;
                
                const updateData = {
                    name: student.name,
                    birth_date: document.getElementById('student-birth-date').value || '',
                    gender: document.getElementById('student-gender').value || '',
                    phone: document.getElementById('student-phone').value || '',
                    email: document.getElementById('student-email').value || '',
                    address: document.getElementById('student-address').value || '',
                    interests: document.getElementById('student-interests').value || '',
                    education: document.getElementById('student-education').value || '',
                    introduction: document.getElementById('student-introduction').value || '',
                    campus: student.campus || '',
                    course_code: student.course_code || '',
                    notes: student.notes || '',
                    career_path: student.career_path || '4. ë¯¸ì •',
                    profile_photo: profilePhoto,
                    attachments: JSON.stringify(attachments)
                };
                
                await axios.put(`${API_BASE_URL}/api/students/${student.id}`, updateData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                student.attachments = JSON.stringify(attachments);
                sessionStorage.setItem('student', JSON.stringify(student));
                
                // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                const fileCountSpan = document.getElementById('student-file-count');
                if (fileCountSpan) {
                    fileCountSpan.textContent = attachments.length;
                }
                
                // ìºì‹œ ì‚­ì œ
                localStorage.removeItem('cache_students');
                
                window.showAlert(`âœ… íŒŒì¼ì´ ì‚­ì œë˜ê³  ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (${attachments.length}/20)`, 'success');
            } catch (error) {
                console.error('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', error);
                window.showAlert('âŒ íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        };
        
        // í”„ë¡œí•„ ì‚¬ì§„ ìë™ ì €ì¥ (Silent)
        async function saveStudentProfileSilent(profilePhotoUrl) {
            const student = JSON.parse(sessionStorage.getItem('student'));
            
            // ì²¨ë¶€ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
            let attachments = [];
            if (student.attachments) {
                try {
                    attachments = JSON.parse(student.attachments);
                } catch (e) {
                    attachments = [];
                }
            }
            
            // JSON ë°ì´í„° ì¤€ë¹„
            const updateData = {
                name: student.name,
                birth_date: document.getElementById('student-birth-date').value || '',
                gender: document.getElementById('student-gender').value || '',
                phone: document.getElementById('student-phone').value || '',
                email: document.getElementById('student-email').value || '',
                address: document.getElementById('student-address').value || '',
                interests: document.getElementById('student-interests').value || '',
                education: document.getElementById('student-education').value || '',
                introduction: document.getElementById('student-introduction').value || '',
                campus: student.campus || '',
                course_code: student.course_code || '',
                notes: student.notes || '',
                career_path: student.career_path || '4. ë¯¸ì •',
                profile_photo: profilePhotoUrl,
                attachments: JSON.stringify(attachments)
            };
            
            try {
                await axios.put(`${API_BASE_URL}/api/students/${student.id}`, updateData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                student.profile_photo = profilePhotoUrl;
                sessionStorage.setItem('student', JSON.stringify(student));
                
                // ìºì‹œ ì‚­ì œ
                localStorage.removeItem('cache_students');
            } catch (error) {
                console.error('ìë™ ì €ì¥ ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        
        // í•™ìƒ ì •ë³´ ì €ì¥
        window.saveStudentProfile = async function() {
            const student = JSON.parse(sessionStorage.getItem('student'));
            
            // í”„ë¡œí•„ ì‚¬ì§„ URL
            const photoImg = document.getElementById('student-photo');
            let profilePhoto = student.profile_photo;
            if (photoImg.src.includes('/api/thumbnail')) {
                const urlParam = new URLSearchParams(photoImg.src.split('?')[1]);
                const ftpUrl = urlParam.get('url');
                if (ftpUrl) {
                    profilePhoto = ftpUrl;
                }
            }
            
            // ì²¨ë¶€ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
            let attachments = [];
            if (student.attachments) {
                try {
                    attachments = JSON.parse(student.attachments);
                } catch (e) {
                    attachments = [];
                }
            }
            
            // JSON ë°ì´í„° ì¤€ë¹„
            const updateData = {
                name: document.getElementById('student-name').value,
                birth_date: document.getElementById('student-birth-date').value || '',
                gender: document.getElementById('student-gender').value || '',
                phone: document.getElementById('student-phone').value || '',
                email: document.getElementById('student-email').value || '',
                address: document.getElementById('student-address').value || '',
                interests: document.getElementById('student-interests').value || '',
                education: document.getElementById('student-education').value || '',
                introduction: document.getElementById('student-introduction').value || '',
                campus: student.campus || '',
                course_code: student.course_code || '',
                notes: student.notes || '',
                career_path: student.career_path || '4. ë¯¸ì •',
                profile_photo: profilePhoto,
                attachments: JSON.stringify(attachments)
            };
            
            try {
                await axios.put(`${API_BASE_URL}/api/students/${student.id}`, updateData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                student.birth_date = document.getElementById('student-birth-date').value;
                student.gender = document.getElementById('student-gender').value;
                student.phone = document.getElementById('student-phone').value;
                student.email = document.getElementById('student-email').value;
                student.address = document.getElementById('student-address').value;
                student.interests = document.getElementById('student-interests').value;
                student.education = document.getElementById('student-education').value;
                student.introduction = document.getElementById('student-introduction').value;
                sessionStorage.setItem('student', JSON.stringify(student));
                
                // ìºì‹œ ì‚­ì œ
                localStorage.removeItem('cache_students');
                
                window.showAlert('âœ… ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                window.showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.detail || error.message), 'error');
            }
        };

        // í™ˆ(ì´ˆê¸°í™”ë©´)ìœ¼ë¡œ ì´ë™
        window.goToHome = function() {
            // ëª¨ë“  íƒ€ì´ë¨¸/ì¸í„°ë²Œ ì •ë¦¬
            if (examPollingInterval) {
                clearInterval(examPollingInterval);
                examPollingInterval = null;
            }
            if (examStatusCheckInterval) {
                clearInterval(examStatusCheckInterval);
                examStatusCheckInterval = null;
            }
            // ê¸°ë³¸ íƒ­(SSIRN)ìœ¼ë¡œ ì´ë™
            showTab('notes');
        };

        // ë¡œê·¸ì•„ì›ƒ
        window.logout = function() {
            // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬
            const student = JSON.parse(sessionStorage.getItem('student') || '{}');
            const studentName = student.name || 'í•™ìƒ';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center">
                    <div class="mb-6">
                        <i class="fas fa-sign-out-alt text-6xl text-green-600 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">ë¡œê·¸ì•„ì›ƒ</h3>
                        <p class="text-gray-600 mb-1">${studentName}ë‹˜,</p>
                        <p class="text-gray-600">ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="logout-cancel" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                            <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                        </button>
                        <button id="logout-confirm" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                            <i class="fas fa-check mr-2"></i>í™•ì¸
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('logout-cancel').onclick = () => modal.remove();
            document.getElementById('logout-confirm').onclick = () => {
                sessionStorage.removeItem('student');
                sessionStorage.removeItem('user_type');
                sessionStorage.removeItem('logged_in');
                window.location.href = '/login.html';
            };
        };
    </script>
</body>
</html>
